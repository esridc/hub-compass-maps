import{c as e,kp as t,kl as n,u as i,v as s,kg as l}from"./p-3013819f.js";import{K as o,V as r,f as a}from"./p-a9376829.js";import{i as c}from"./p-3622b703.js";import"./p-3b51db5e.js";import"./p-3811f238.js";import"./p-e6812c2f.js";import"./p-94b15954.js";import"./p-f1aede5a.js";import"./p-30a1f911.js";import"./p-b362a32c.js";import"./p-a925664a.js";import"./p-a897fcf8.js";import"./p-c60ccdaa.js";const u=96/72;class m{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new c}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(n,i,s,l,r,a,c,u,m){if(!n)return null;const{data:y}=n;if(!y||"CIMSymbolReference"!==y.type||!y.symbol)return null;const{symbol:f}=y;a||(a=t(f));const h=await e.resolveSymbolOverrides(y,i,this._spatialReference,r,a,c,u),b=this._cimResourceManager,d=[];o.fetchResources(h,b,d),o.fetchFonts(h,b,d),d.length>0&&await Promise.all(d);const{width:w,height:g}=s,M=p(a,w,g,l),j=o.getEnvelope(h,M,b);if(!j)return null;let C=1,I=0,P=0;switch(f.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;j.width>w&&(e=w/j.width);let t=1;j.height>g&&(t=g/j.height),"preview"===l&&(j.width<w&&(e=w/j.width),j.height<g&&(t=g/j.height)),C=Math.min(e,t),I=j.x+j.width/2,P=j.y+j.height/2}break;case"CIMLineSymbol":{(m||j.height>g)&&(C=g/j.height),P=j.y+j.height/2;const e=j.x*C+w/2,t=(j.x+j.width)*C+w/2,{paths:n}=M;n[0][0][0]-=e/C,n[0][2][0]-=(t-w)/C}break;case"CIMPolygonSymbol":{I=j.x+j.width/2,P=j.y+j.height/2;const e=j.x*C+w/2,t=(j.x+j.width)*C+w/2,n=j.y*C+g/2,i=(j.y+j.height)*C+g/2,{rings:s}=M;e<0&&(s[0][0][0]-=e,s[0][3][0]-=e,s[0][4][0]-=e),n<0&&(s[0][0][1]+=n,s[0][1][1]+=n,s[0][4][1]+=n),t>w&&(s[0][1][0]-=t-w,s[0][2][0]-=t-w),i>g&&(s[0][2][1]+=i-g,s[0][3][1]+=i-g)}}const S={type:"cim",data:{type:"CIMSymbolReference",symbol:h}};return this.rasterize(S,w,g,I,P,C,a,1,M)}rasterize(e,n,i,s,l,o,c,m=0,y=null){const{data:f}=e;if(!f||"CIMSymbolReference"!==f.type||!f.symbol)return null;const{symbol:h}=f,b=this._canvas,d=(window.devicePixelRatio||1)*u;b.width=n*d,b.height=i*d,c||(c=t(h)),y||(y=p(c,n,i,"legend")),b.width+=2*m,b.height+=2*m;const w=b.getContext("2d",{willReadFrequently:!0}),g=r.createIdentity();g.translate(-s,-l),g.scale(o*d,-o*d),g.translate(n*d/2+m,i*d/2+m),w.clearRect(0,0,b.width,b.height);return new a(w,this._cimResourceManager,g,!0).drawSymbol(h,y),w.getImageData(0,0,b.width,b.height)}}function p(e,t,n,i){const s=1,l=-t/2+s,o=t/2-s,r=n/2-s,a=-n/2+s;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[l,0],[0,0],[o,0]]]};default:return"legend"===i?{rings:[[[l,r],[o,0],[o,a],[l,a],[l,r]]]}:{rings:[[[l,r],[o,r],[o,a],[l,a],[l,r]]]}}}const y=new m(null),f=s(l.size),h=s(l.maxSize),b=s(l.lineWidth),d=1;async function w(e,t,n){const i=t?.size;let s=null!=i&&"object"==typeof i&&"width"in i?i.width:i,l=null!=i&&"object"==typeof i&&"height"in i?i.height:i;if(null==s||null==l)if("esriGeometryPolygon"===n)s=f,l=f;else{const i=await g(e,t,n);i&&(s=i.width,l=i.height),"esriGeometryPolyline"===n&&(s=b),s=null!=s&&isFinite(s)?Math.min(s,h):f,l=null!=l&&isFinite(l)?Math.max(Math.min(l,h),d):f}return"legend"===t.style&&"esriGeometryPolyline"===n&&(s=b),{width:s,height:l}}async function g(t,n,i){const{feature:s,fieldMap:l,viewParams:r}=n.cimOptions||n,a=await e.resolveSymbolOverrides(t.data,s,null,l,i,null,r);if(!a)return null;(t=t.clone()).data={type:"CIMSymbolReference",symbol:a},t.data.primitiveOverrides=void 0;const c=[];return o.fetchResources(a,y.resourceManager,c),o.fetchFonts(a,y.resourceManager,c),c.length>0&&await Promise.all(c),o.getEnvelope(a,null,y.resourceManager)}async function M(e,s={}){const{node:l,opacity:o,symbolConfig:r}=s,a=null!=r&&"object"==typeof r&&"isSquareFill"in r&&r.isSquareFill,c=s.cimOptions||s,u=c.geometryType||t(e?.data?.symbol),m=await w(e,s,u),{feature:p,fieldMap:f}=c,h=a||"esriGeometryPolygon"!==u?"preview":"legend",b=await y.rasterizeCIMSymbolAsync(e,p,m,h,f,u,null,c.viewParams,c.allowScalingUp);if(!b)return null;const{width:d,height:g}=b,M=document.createElement("canvas");M.width=d,M.height=g;M.getContext("2d").putImageData(b,0,0);const j=i(m.width),C=i(m.height),I=new Image(j,C);I.src=M.toDataURL(),I.ariaLabel=s.ariaLabel??null,I.alt=s.ariaLabel??"",null!=o&&(I.style.opacity=`${o}`);let P=I;if(null!=s.effectView){const e={shape:{type:"image",x:0,y:0,width:j,height:C,src:I.src},fill:null,stroke:null,offset:[0,0]};P=n([[e]],[j,C],{effectView:s.effectView,ariaLabel:s.ariaLabel})}return l&&P&&l.appendChild(P),P}export{M as previewCIMSymbol};
//# sourceMappingURL=p-864ba106.js.map