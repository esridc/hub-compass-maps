import{iW as t,iX as i,iY as s,iZ as p,i_ as e,hc as r,j as h,di as a,eX as o,n as c,r as m,p as n,q as l}from"./p-aad64c9f.js";import"./p-2d2f231a.js";import"./p-b8a25c33.js";import"./p-559f4b2d.js";import"./p-de84037a.js";import"./p-3f2fef32.js";import"./p-682c165c.js";import"./p-1c4b55c0.js";import"./p-22458323.js";import"./p-204b6b8c.js";import"./p-d26004a3.js";import"./p-ae438250.js";import"./p-21ce5524.js";import"./p-591e796f.js";import"./p-01ae94a1.js";import"./p-dc92c2ea.js";import"./p-dddb66c6.js";import"./p-08681176.js";import{F as j}from"./p-4f2b7ad8.js";import"./p-c0b174ee.js";import"./p-717596a8.js";import{r as f,o as u,n as d}from"./p-260ceb60.js";import{j as b,y as w}from"./p-bbb18646.js";import{h as g}from"./p-f5662f64.js";import{i as y}from"./p-3e7cecc4.js";import{_ as v,R as T}from"./p-c88fe9df.js";import{r as q}from"./p-25b1687c.js";import"./p-2af77f97.js";import"./p-17d8c81f.js";import"./p-dc645a50.js";import"./p-7281a451.js";import"./p-b947b9d2.js";import"./p-aff89b86.js";import"./p-e7a66915.js";import"./p-a0004a96.js";import"./p-2ea4a2b9.js";import"./p-44881b12.js";import"./p-7ce0ff48.js";import"./p-e7002be3.js";import"./p-9ad0e060.js";import"./p-875cbb57.js";import"./p-da522976.js";import"./p-d492d39b.js";import"./p-008cf576.js";import"./p-fa2632fc.js";import"./p-4295487d.js";import"./p-1c285990.js";import"./p-e3657bc3.js";import"./p-bac7b09c.js";import"./p-deddb82e.js";import"./p-55f3e0f9.js";import"./p-2250105d.js";import"./p-2527295a.js";import"./p-d6556377.js";import"./p-31b7e91d.js";import"./p-23e8befe.js";import"./p-63562f76.js";import"./p-11492679.js";import"./p-7950bc60.js";import"./p-1bb606f6.js";import"./p-b323b506.js";const C=[0,0];let F=class extends(y(f(b(w)))){constructor(){super(...arguments),this._fetchQueue=null,this._highlightGraphics=new t,this._highlightView=null,this._popupHighlightHelper=null,this._tileStrategy=null,this.layer=null}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}get tilemapCache(){return"tilemapCache"in this.layer?this.layer.tilemapCache:null}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume(),this._highlightView?.processUpdate(t)}attach(){const t="tileServers"in this.layer?this.layer.tileServers:null,r=this.tilemapCache;if(this._tileInfoView=new i(this.layer.tileInfo,this.layer.fullExtent,r?.effectiveMinLOD,r?.effectiveMaxLOD),this._fetchQueue=new s({tileInfoView:this._tileInfoView,concurrency:t&&10*t.length||10,process:(t,i)=>this.fetchTile(t,i),scheduler:this.scheduler,priority:p.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new e({cachePolicy:"keep",resampling:this.resampling,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),v(this,this.layer)){const t=this._highlightView=new j({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new g(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new T({createFetchPopupFeaturesQueryGeometry:(t,i)=>q(t,i,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(i,s)=>{t.graphicUpdateHandler({graphic:i,property:s})},layerView:this,updatingHandles:this._updatingHandles})}this.requestUpdate(),this.addAttachHandles(this._updatingHandles.add((()=>this.resampling),(()=>{this.doRefresh()}))),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._popupHighlightHelper?.destroy(),this._highlightView?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=this._popupHighlightHelper=null}async fetchPopupFeaturesAtLocation(t,i){return this._popupHighlightHelper?this._popupHighlightHelper.fetchPopupFeaturesAtLocation(t,i):[]}highlight(t){return this._popupHighlightHelper?this._popupHighlightHelper.highlight(t):r()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return h(this.layer.tileInfo?.spatialReference,t)}async doRefresh(){if(this.attached){if(this.suspended)return this._tileStrategy.clear(),void this.requestUpdate();this._fetchQueue.reset(),this._tileStrategy.refresh((t=>this._updatingHandles.addPromise(this._enqueueTileFetch(t))))}}acquireTile(t){const i=this._bitmapView.createTile(t),s=i.bitmap;return[s.x,s.y]=this._tileInfoView.getTileCoords(C,i.key),s.resolution=this._tileInfoView.getTileResolution(i.key),[s.width,s.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(i)),this._bitmapView.addChild(i),this.requestUpdate(),i}releaseTile(t){this._fetchQueue.abort(t.key.id),this._bitmapView.removeChild(t),t.once("detach",(()=>t.destroy())),this.requestUpdate()}async fetchTile(t,i={}){const s=this.tilemapCache,{signal:p,resamplingLevel:e=0}=i;if(!s)try{return await this._fetchImage(t,p)}catch(s){if(!a(s)&&!this.resampling)return u(this._tileInfoView.tileInfo.size);if(e<3){const s=this._tileInfoView.getTileParentId(t.id);if(s){const p=new o(s),r=await this.fetchTile(p,{...i,resamplingLevel:e+1});return d(this._tileInfoView,r,p,t)}}throw s}const r=new o(0,0,0,0);let h;try{if(await s.fetchAvailabilityUpsample(t.level,t.row,t.col,r,{signal:p}),!this.resampling&&r.level!==t.level)return u(this._tileInfoView.tileInfo.size);h=await this._fetchImage(r,p)}catch(t){if(a(t))throw t;return u(this._tileInfoView.tileInfo.size)}return this.resampling?d(this._tileInfoView,h,r,t):h}async _enqueueTileFetch(t){if(!this._fetchQueue.has(t.key.id)){try{const i=await this._fetchQueue.push(t.key);t.bitmap.source=i,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.once("attach",(()=>this.requestUpdate()))}catch(t){a(t)||c.getLogger(this).error(t)}this.requestUpdate()}}async _fetchImage(t,i){return this.layer.fetchImageBitmapTile(t.level,t.row,t.col,{signal:i})}};m([n()],F.prototype,"resampling",null),m([n()],F.prototype,"tilemapCache",null),F=m([l("esri.views.2d.layers.TileLayerView2D")],F);const L=F;export default L;
//# sourceMappingURL=p-f02f48f0.js.map