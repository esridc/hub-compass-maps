import{cA as e,ll as t,lh as n,cL as s,cV as i,lc as l}from"./p-aad64c9f.js";import{e as o,$ as r,p as a}from"./p-559f4b2d.js";import{i as c}from"./p-d807bd93.js";import"./p-2af77f97.js";import"./p-7281a451.js";import"./p-b947b9d2.js";import"./p-aff89b86.js";import"./p-b8a25c33.js";import"./p-e7a66915.js";import"./p-a0004a96.js";const u=96/72;class y{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new c}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(n,s,i,l,r,a,c,u,y){if(!n)return null;const{data:f}=n;if(!f||"CIMSymbolReference"!==f.type||!f.symbol)return null;const{symbol:p}=f;a||(a=t(p));const h=await e.resolveSymbolOverrides(f,s,this._spatialReference,r,a,c,u),d=this._cimResourceManager,b=[];o.fetchResources(h,d,b),o.fetchFonts(h,d,b),b.length>0&&await Promise.all(b);const{width:w,height:g}=i,M=m(a,w,g,l),j=o.getEnvelope(h,M,d);if(!j)return null;j.x===1/0&&(j.x=w+2),j.y===1/0&&(j.y=-g/2),j.width===-1/0&&(j.width=w),j.height===-1/0&&(j.height=g);let C=1,I=0,P=0;switch(p.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;j.width>w&&(e=w/j.width);let t=1;j.height>g&&(t=g/j.height),"preview"===l&&(j.width<w&&(e=w/j.width),j.height<g&&(t=g/j.height)),C=Math.min(e,t),I=j.x+j.width/2,P=j.y+j.height/2}break;case"CIMLineSymbol":{(y||j.height>g)&&(C=g/j.height),P=j.y+j.height/2;const e=j.x*C+w/2,t=(j.x+j.width)*C+w/2,{paths:n}=M;n[0][0][0]-=e/C,n[0][2][0]-=(t-w)/C}break;case"CIMPolygonSymbol":{I=j.x+j.width/2,P=j.y+j.height/2;const e=j.x*C+w/2,t=(j.x+j.width)*C+w/2,n=j.y*C+g/2,s=(j.y+j.height)*C+g/2,{rings:i}=M;e<0&&(i[0][0][0]-=e,i[0][3][0]-=e,i[0][4][0]-=e),n<0&&(i[0][0][1]+=n,i[0][1][1]+=n,i[0][4][1]+=n),t>w&&(i[0][1][0]-=t-w,i[0][2][0]-=t-w),s>g&&(i[0][2][1]+=s-g,i[0][3][1]+=s-g)}}const S={type:"cim",data:{type:"CIMSymbolReference",symbol:h}};return this.rasterize(S,w,g,I,P,C,a,1,M)}rasterize(e,n,s,i,l,o,c,y=0,f=null){const{data:p}=e;if(!p||"CIMSymbolReference"!==p.type||!p.symbol)return null;const{symbol:h}=p,d=this._canvas,b=(window.devicePixelRatio||1)*u;d.width=n*b,d.height=s*b,c||(c=t(h)),f||(f=m(c,n,s,"legend")),d.width+=2*y,d.height+=2*y;const w=d.getContext("2d",{willReadFrequently:!0}),g=r.createIdentity();g.translate(-i,-l),g.scale(o*b,-o*b),g.translate(n*b/2+y,s*b/2+y),w.clearRect(0,0,d.width,d.height);return new a(w,this._cimResourceManager,g,!0).drawSymbol(h,f),w.getImageData(0,0,d.width,d.height)}}function m(e,t,n,s){const i=1,l=-t/2+i,o=t/2-i,r=n/2-i,a=-n/2+i;switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[l,0],[0,0],[o,0]]]};default:return"legend"===s?{rings:[[[l,r],[o,0],[o,a],[l,a],[l,r]]]}:{rings:[[[l,r],[o,r],[o,a],[l,a],[l,r]]]}}}const f=new y(null),p=i(l.size),h=i(l.maxSize),d=i(l.lineWidth),b=1;async function w(e,t,n){const s=t?.size;let i=null!=s&&"object"==typeof s&&"width"in s?s.width:s,l=null!=s&&"object"==typeof s&&"height"in s?s.height:s;if(null==i||null==l)if("esriGeometryPolygon"===n)i=p,l=p;else{const s=await g(e,t,n);s&&(i=s.width,l=s.height),"esriGeometryPolyline"===n&&(i=d),i=null!=i&&isFinite(i)?Math.min(i,h):p,l=null!=l&&isFinite(l)?Math.max(Math.min(l,h),b):p}return"legend"===t.style&&"esriGeometryPolyline"===n&&(i=d),{width:i,height:l}}async function g(t,n,s){const{feature:i,fieldMap:l,viewParams:r}=n.cimOptions||n,a=await e.resolveSymbolOverrides(t.data,i,null,l,s,null,r);if(!a)return null;(t=t.clone()).data={type:"CIMSymbolReference",symbol:a},t.data.primitiveOverrides=void 0;const c=[];return o.fetchResources(a,f.resourceManager,c),o.fetchFonts(a,f.resourceManager,c),c.length>0&&await Promise.all(c),o.getEnvelope(a,null,f.resourceManager)}async function M(e,i={}){const{node:l,opacity:o,symbolConfig:r}=i,a=null!=r&&"object"==typeof r&&"isSquareFill"in r&&r.isSquareFill,c=i.cimOptions||i,u=c.geometryType||t(e?.data?.symbol),y=await w(e,i,u),{feature:m,fieldMap:p}=c,h=a||"esriGeometryPolygon"!==u?"preview":"legend",d=await f.rasterizeCIMSymbolAsync(e,m,y,h,p,u,null,c.viewParams,c.allowScalingUp);if(!d)return null;const{width:b,height:g}=d,M=document.createElement("canvas");M.width=b,M.height=g;M.getContext("2d").putImageData(d,0,0);const j=s(y.width),C=s(y.height),I=new Image(j,C);I.src=M.toDataURL(),I.ariaLabel=i.ariaLabel??null,I.alt=i.ariaLabel??"",null!=o&&(I.style.opacity=`${o}`);let P=I;if(null!=i.effectView){const e={shape:{type:"image",x:0,y:0,width:j,height:C,src:I.src},fill:null,stroke:null,offset:[0,0]};P=n([[e]],[j,C],{effectView:i.effectView,ariaLabel:i.ariaLabel})}return l&&P&&l.appendChild(P),P}export{M as previewCIMSymbol};
//# sourceMappingURL=p-411ba250.js.map