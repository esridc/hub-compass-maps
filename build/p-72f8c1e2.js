import{r as e,p as t,q as s,e as i,ac as r,x as n,eV as a,hx as o,ae as l,T as u,cE as c,eX as h,eF as d,s as p,n as f,dZ as y,dC as m,a3 as b,av as g,eR as S,eS as w,f3 as v,jo as F,bC as I,bH as V,jp as x,dX as E,fv as R,cL as O,jq as z,je as C,iK as M,jg as j,jr as P,cQ as T,js as A,jt as _,g2 as q,ju as B,jv as D,a7 as L,H as k,jw as U,fu as $,jx as N,jy as H,w as G,j3 as J,bE as K,jn as Q,jz as X,X as W,jA as Y,ji as Z,jB as ee,jC as te,jD as se,jE as ie,jF as re,jh as ne,jG as ae,jH as oe,dc as le,aA as ue,d9 as ce,az as he,F as de,hc as pe,E as fe,eN as ye,bD as me,dN as be,jI as ge,jJ as Se,di as we,jK as ve}from"./p-aad64c9f.js";import{t as Fe}from"./p-875cbb57.js";import{i as Ie}from"./p-c2679c90.js";import{j as Ve,y as xe}from"./p-bbb18646.js";import{i as Ee,r as Re,n as Oe}from"./p-23e8befe.js";import{T as ze,i as Ce,e as Me,h as je,f as Pe,M as Te,g as Ae,x as _e,d as qe,k as Be,l as De,c as Le}from"./p-591e796f.js";import{e as ke}from"./p-2d2f231a.js";import{t as Ue}from"./p-008cf576.js";import{c as $e}from"./p-682c165c.js";import{e as Ne,o as He,m as Ge}from"./p-559f4b2d.js";import{a as Je}from"./p-be38a32f.js";import{e as Ke}from"./p-aa4c9855.js";import{p as Qe,n as Xe}from"./p-b323b506.js";import{i as We}from"./p-3e7cecc4.js";let Ye=class extends i{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer?.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};e([t({type:Boolean})],Ye.prototype,"isAggregate",void 0),Ye=e([s("esri.AggregateGraphic")],Ye);const Ze=Ye;let et=class extends r{constructor(e){super(e),this._filter=null,this.duration=n("mapview-transitions-duration"),this._excludedEffectView=new a(e),this._includedEffectView=new a(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}get transitioningToEmpty(){return!this._excludedEffectView.final&&!this._includedEffectView.final}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransition(){this._includedEffectView.endTransition(),this._excludedEffectView.endTransition(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),s=e,i=s?.includedEffect,r=s?.excludedEffect,n=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(r);this._includedEffectView.effect=i,this._excludedEffectView.effect=r,this._set("featureEffect",s),this._filter=s?.filter||t?.filter||null,n||this.endTransition()}};e([t()],et.prototype,"_filter",void 0),e([t()],et.prototype,"_excludedEffectView",void 0),e([t()],et.prototype,"_includedEffectView",void 0),e([t()],et.prototype,"duration",void 0),e([t()],et.prototype,"excludedEffects",null),e([t()],et.prototype,"featureEffect",null),e([t()],et.prototype,"filter",null),e([t()],et.prototype,"hasEffects",null),e([t()],et.prototype,"includedEffects",null),e([t({value:0})],et.prototype,"scale",null),e([t()],et.prototype,"transitioning",null),e([t()],et.prototype,"transitioningToEmpty",null),et=e([s("esri.layers.effects.FeatureEffectView")],et);const tt=et;let st=class extends l{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const s=u.fromJSON(t.spatialReference),i=[];for(let t=0;t<e.length;t++){const r=e[t],n=Ze.fromJSON(r),a=r.geometry?.spatialReference;null==n.geometry||a||(n.geometry.spatialReference=s);const o=r.aggregateGeometries,l=n.aggregateGeometries;if(o&&null!=l)for(const e in l){const t=l[e],i=o[e],r=i?.spatialReference;null==t||r||(t.spatialReference=s)}i.push(n)}return i}};e([t({type:[Ze],json:{write:!0}})],st.prototype,"features",void 0),e([o("features")],st.prototype,"readFeatures",null),st=e([s("esri.rest.support.AggregateFeatureSet")],st);const it=st;class rt{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}updateStart(){this._instanceByIdNext=new Map}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(const[e,t]of this._instanceByIdNext.entries()){const s=this._instanceById.get(e);s?s.setInput(t.getInput()):this._instanceById.set(e,t)}this._instanceByIdNext=null}values(){return this._instanceById.values()}ensureInstance(e,t){let s;if("object"==typeof t&&"optionalAttributes"in t&&"uniforms"in t){s=`${e.type}${JSON.stringify(t.optionalAttributes)}`;const i=t.uniforms;if("object"==typeof i)for(const e in i)s+=`${e}.${null!=i[e]}`}else s=`${e.type}.${JSON.stringify(t)}`;const i=c(s);if(this._instanceByIdNext){const s=new Ee(Re(i),e,t);return this._instanceByIdNext.set(i,s),s}if(!this._instanceById.has(i)){const s=new Ee(Re(i),e,t);this._instanceById.set(i,s)}return this._instanceById.get(i)}getInstance(e){return this._instanceById.get(e)}}const nt=1e3;class at{constructor(e,t,s){this.getStage=e,this.version=t,this._tileInfoView=s,this._pendingUpdates=new Ue(nt),this._locked=!1,this._tiles=new Map}destroy(){for(const e of this.tiles())e.destroy();this._pendingUpdates.clear(),this._tiles.clear()}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1,this.flush()}enqueueUpdate(e){this._pendingUpdates.enqueue(e)}update(e){if(!this._locked)for(;this._pendingUpdates.size;){const t=this._pendingUpdates.peek();if(null==t||t.inner.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue()}}removeTile(e){const t=this._tiles.get(e);n("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t?.destroy(),this._tiles.delete(e)}isTileDone(e){const t=this._tiles.get(e.id);return!!t&&t.isReady}flush(){for(;this._pendingUpdates.size;){const e=this._pendingUpdates.dequeue();null!=e&&this._updateTile(e)}for(const e of this._tiles.values())e.upload()}_updateTile(e){const{inner:t,objectIdMap:s}=e;if(n("esri-2d-update-debug")){const e=t.debugInfo?.chunkId??"<EnsureEnd>";console.debug(`Version[${t.version}] Tile[${t.id}] Chunk[${e}] RenderState.updateTile [${t.type}]`,t)}const i=this._ensureTile(t.id);if("update"===t.type){const[e,...r]=t.modify;i.onMessage({type:"update",modify:e,remove:t.remove,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:s});for(const e of r){const i=this._tiles.get(e.tileId);i&&i.onMessage({type:"update",modify:e,remove:t.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:s})}return}if(null==t.append)return void i.onMessage({type:"append",clear:t.clear,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:s});const[r,...a]=t.append;i.onMessage({type:"append",clear:t.clear,append:r,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:s});for(const e of a){const t=this._tiles.get(e.tileId);t&&t.onMessage({type:"update",modify:e,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:s})}}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){n("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const t=new h(e),s=this._tileInfoView.getTileBounds(d(),t),i=this._tileInfoView.getTileResolution(t.level),r=new $e(t,i,s[0],s[3],!0);if(r.stage=this.getStage(),!r.stage){const e=new p("featurelayerview:webgl","Cannot create tile with empty stage");f.getLogger("esri.views.2d.layers.features.RenderState").error(e)}return r}_copyPixelBufferedEntitiesInto(e){let t=7;const s=this._tileInfoView.getLODInfoAt(e.key);for(let i=-1;i<=1;i++)for(let r=-1;r<=1;r++){if(0===i&&0===r)continue;const n=e.key.getNormalizedNeighbor(r,i,s).id,a=this._tiles.get(n);if(null!=a){const s=1<<t;e.copyPixelBufferedEntitesFrom(a,s,r,i)}t--}}}class ot{constructor(e,t){this.id=e,this.version=t,this._resolver=g(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}}class lt extends Oe{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new y,this._hitTestsRequests=[],this._store=new rt,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e,this.addTransitionable(this._layerView.featureEffectView)}renderChildren(e){if(this._updateAttributeView(),this._renderState?.update(this.attributeView.currentEpoch),this._renderState){const e=Array.from(this._renderState.tiles()).filter((e=>e.needsUpload));if(e.length){e[Math.floor(Math.random()*e.length)].upload(),e.length>=2&&this.requestRender()}for(const e of this._renderState.tiles())e.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(e.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const t of this.children)t.setTransform(e.state);switch(super.renderChildren(e),e.drawPhase){case m.MAP:return this._renderMapPhase(e);case m.HIGHLIGHT:return this._renderHighlightPhase(e);case m.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getHeatmapInstance(e){if(null==this._instanceStore||!(e.drawPhase&ze.heatmap.drawPhase))return null;for(const e of this._instanceStore.values())if(ut(e))return e;return null}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter((e=>this._visibleTiles.has(e.key.id))):[]}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&this._layerView.view.labelManager.requestUpdate()}updateSubscriptions(e){for(const{tileId:t,version:s}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=s;else{const e=new ot(t,s);this._subscriptions.set(t,e),this.updatingHandles.addPromise(e.promise)}for(const t of e.unsubscribe){const e=this._subscriptions.get(t);e?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){n("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new at((()=>this._stage),e,this.tileInfoView)}getDisplayStatistics(e,t){const s=this._statisticsByLevel.get(e);return s?s.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let s=this._statisticsByLevel.get(e);s||(s=new Map,this._statisticsByLevel.set(e,s));for(const e of t)s.set(e.fieldName,{minValue:e.minValue,maxValue:e.maxValue})}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender()}swapRenderState(){this._renderStateNext&&(n("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState&&this._renderState.flush(),this.requestRender()}setVisibleTiles(e){this._visibleTiles=e}async onMessage(e,t){b(t);const s=e.inner;if(!this._subscriptions.has(s.id))return;const i=this._subscriptions.get(s.id);if(i.version!==s.subscriptionVesrion){if(n("esri-2d-update-debug")){const e=`${s.subscriptionVesrion} != ${i.version}`;console.debug(`Version[${e}] Tile[${s.id}] FeatureContainer - Dropping message, outdated version]`,s)}return}const r=this._renderStateNext??this._renderState;if(!r)throw new Error("InternalError: No renderState defined");r.version!==s.version&&console.error(`InternalError: Version mismatch. [renderState: ${r.version}, message: ${s.version}]`),r.enqueueUpdate(e),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find((({x:t,y:s})=>t===e.x&&s===e.y));const s=g();return t?t.resolvers.push(s):(t={x:e.x,y:e.y,resolvers:[s]},this._hitTestsRequests.push(t)),this.requestRender(),s.promise}getSortKeys(e){const t=new Set(e),s=new Map;for(const e of this.children)if(e.getSortKeys(t).forEach(((e,t)=>s.set(t,e))),s.size===t.size)break;return s}get hasAnimation(){return this.hasLabels}doRender(e){const{minScale:t,maxScale:s}=this._layer.effectiveScaleRange,i=e.state.scale;i<=(t||1/0)&&i>=s&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){if(null==this._getHeatmapInstance(e))super.setStencilReference(e);else for(const e of this.children)e.stencilRef=ze.heatmap.getStencilReference(e)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,S.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&w(e,!1,(e=>{this._renderFeatures(e,S.Highlight)}))}_renderLabelPhase(e){this._renderFeatures(e,S.All)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,S.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,S.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,s=e.painter.effects.hittest,i=t.getBoundFramebufferObject(),r=t.getViewport(),n=e.passOptions,a=e.drawPhase;s.bind(e),e.passOptions=s.createOptions(e,this._hitTestsRequests),e.drawPhase=m.HITTEST;const{distance:o,smallSymbolDistance:l}=e.passOptions,u=Math.max(o,l);for(const t of this.children)t.visible&&t.containsScreenPoint(e.state,e.passOptions.position,2*u)&&this._renderTile(t,e,S.All);s.draw(e),s.unbind(),t.bindFramebuffer(i),t.restoreViewport(r),e.passOptions=n,e.drawPhase=a}_renderFeatures(e,t){const s=this._getHeatmapInstance(e);null!=s?this._renderHeatmapFeatures(e,t,s):this._renderGeometryFeatures(e,t)}_renderGeometryFeatures(e,t){for(const s of this.children)s.visible&&this._renderTile(s,e,t)}_renderHeatmapFeatures(e,t,s){for(const s of this.children)s.visible&&this._renderTile(s,e,t,ke.Heatmap);s.techniqueRef.renderResolvePass(e,s)}_renderTile(e,t,s,i){const r=n("featurelayer-force-marker-text-draw-order")?v.STRICT_MARKERS_AND_TEXT:v.BATCHING,a=e.getDisplayList(this._instanceStore,r);t.selection=s,a?.render(t,i)}}function ut(e){return e.techniqueRef.type===ke.Heatmap}async function ct(e){const t=await F("FeaturePipelineWorker",{client:e,strategy:"dedicated"});return new ht(t)}class ht{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}}const dt=10;let pt=class extends r{constructor(){super(...arguments),this.events=new I,this._updatingStrategy=!0,this._tileToEvent=new V,this._fetchStatus={outstanding:0,done:0}}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(e){switch(e.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(e);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=e.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",e);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),e.done&&(this._fetchStatus={done:0,outstanding:0})}}_hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const e of this._tileToEvent.values()){const t=e.peekLast();if("loaded"!==t?.type)return!1}return!0}_handleTileEvent(e){switch(e.type){case"subscribe":{const t=new Ue(dt);t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"unsubscribe":this._tileToEvent.delete(e.tile);break;case"loaded":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"error":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t),this.events.emit("error",e);break}}}};e([t({readOnly:!0})],pt.prototype,"hasAllFeatures",null),e([t({readOnly:!0})],pt.prototype,"hasAllFeaturesInView",null),e([t({readOnly:!0})],pt.prototype,"hasFullGeometries",null),e([t()],pt.prototype,"_updatingStrategy",void 0),e([t()],pt.prototype,"_strategyInfo",void 0),e([t()],pt.prototype,"_tileToEvent",void 0),pt=e([s("esri.views.2d.layers.features.FeatureSourceEventLog")],pt);function ft(e){switch(e.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":return"esriGeometryPolygon";case"multipatch":return"esriGeometryMultiPatch";case"multipoint":return"esriGeometryMultipoint";default:return null}}const yt=Math.PI;function mt(e,t){switch(t.transformationType){case x.Additive:return gt(e,t);case x.Constant:return St(t,e);case x.ClampedLinear:return wt(e,t);case x.Proportional:return vt(e,t);case x.Stops:return Ft(e,t);case x.RealWorldSize:return It(e,t);case x.Identity:return e;case x.Unknown:return null}}function bt(e,t){return"number"==typeof e?e:mt(t,e)}function gt(e,t){return e+(bt(t.minSize,e)||t.minDataValue)}function St(e,t){const s=e.stops;let i=s?.length&&s[0].size;return null==i&&(i=e.minSize),bt(i,t)}function wt(e,t){const s=t.minDataValue,i=t.maxDataValue,r=(e-s)/(i-s),n=bt(t.minSize,e),a=bt(t.maxSize,e);return e<=s?n:e>=i?a:n+r*(a-n)}function vt(e,t){const s=e/t.minDataValue,i=bt(t.minSize,e),r=bt(t.maxSize,e);let n=null;return n=s*i,E(n,i,r)}function Ft(e,t){const[s,i,r]=Vt(e,t.cache.ipData);if(s===i)return bt(t.stops[s].size,e);{const n=bt(t.stops[s].size,e);return n+(bt(t.stops[i].size,e)-n)*r}}function It(e,t){const s=R[t.valueUnit],i=bt(t.minSize,e),r=bt(t.maxSize,e),{valueRepresentation:n}=t;let a=null;return a="area"===n?2*Math.sqrt(e/yt)/s:"radius"===n||"distance"===n?2*e/s:e/s,E(a,i,r)}function Vt(e,t){if(!t)return;let s=0,i=t.length-1;return t.some(((t,r)=>e<t?(i=r,!0):(s=r,!1))),[s,i,(e-t[s])/(t[i]-t[s])]}function xt(e){return(e.labelsVisible&&e.labelingInfo?.every((e=>"none"!==e.deconflictionStrategy)))??!1}function Et(e,t){const s=z(e,t);if(s?.labelsVisible&&s.labelingInfo?.length)return s.labelingInfo.every((e=>"none"!==e.deconflictionStrategy))}function Rt(e){return t=>O(mt(t,e))}function Ot(e){const t=null!=e&&"visualVariables"in e&&e.visualVariables;if(!t)return null;for(const e of t)if("size"===e.type)return Rt(e);return null}function zt(e,t,s,i){const r=null!=e.subtypeCode?`${e.subtypeField} = ${e.subtypeCode}`:null,n=C(e.definitionExpression,r),a=e.customParameters??{};return i&&(a.token=i),{type:"feature",mutable:{sourceRefreshVersion:s,availableFields:t.availableFields,dataFilter:{queryScaleRanges:e.queryScaleRanges??[],definitionExpression:n,gdbVersion:e.gdbVersion,historicMoment:e.historicMoment?.getTime(),timeExtent:e.timeExtent?.toJSON(),customParameters:a}}}}function Ct(e,t,s=0){if(null==t)return e[s]=0,e[s+1]=0,e[s+2]=0,void(e[s+3]=0);const{r:i,g:r,b:n,a}=t;e[s]=i*a/255,e[s+1]=r*a/255,e[s+2]=n*a/255,e[s+3]=a}async function Mt(e,t){if(!e)return[];switch(e.type){case"simple-fill":return Nt(e,t);case"picture-fill":return Ht(e,t);case"simple-marker":return _t(e,t);case"picture-marker":return qt(e,t);case"simple-line":return Gt(e,t,!1);case"text":return Dt(e,t);case"label":return Lt(e,t);case"cim":return Pe(e.data,t);case"web-style":{const s=await e.fetchCIMSymbol();return Pe(s.data,t)}case"line-3d":return f.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-line`),Gt(new P,t,!1);case"point-3d":return f.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-marker`),_t(new j,t);case"polygon-3d":return f.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-fill`),Nt(new M,t);case"mesh-3d":case"label-3d":return f.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Ignoring`),[];case"CIMSymbolReference":throw new Error("InternalError: CIMSymbolReference should already be resolved")}}async function jt(e,t){const{schemaOptions:s}=t,{store:i}=s,r=new Array(A),n=new Array(A/4);for(let t=0;t<A;t++){const s=t<e.attributes.length?e.attributes[t].color:null;r[t]=[0,0,0,0],Ct(r[t],s)}for(let t=0;t<A/4;t++)n[t]=[0,0,0,0],n[t][0]=4*t<e.attributes.length?1:0,n[t][1]=4*t+1<e.attributes.length?1:0,n[t][2]=4*t+2<e.attributes.length?1:0,n[t][3]=4*t+3<e.attributes.length?1:0;const a={uniforms:{isActive:n,colors:r,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},optionalAttributes:{}},o=i.ensureInstance(ze.dotDensity,a).createMeshInfo({effects:null}),l=[],u=new M({color:e.backgroundColor??[0,0,0,0],outline:null}),c=await Mt(u,t);if(l.push(...c),l.push(o),e.outline){const s=Gt(e.outline,t,!0);l.push(...s)}return l}async function Pt(e,t){const{store:s}=t,{radius:i,minDensity:r,maxDensity:n,referenceScale:a,field:o,valueExpression:l,colorStops:u}=e,c=_(u);return[s.ensureInstance(ze.heatmap,{uniforms:{radius:O(i),minDensity:r,maxDensity:n,referenceScale:a,isFieldActive:!(!o&&!l),gradient:c,gradientHash:c.join(",")},optionalAttributes:{}}).createMeshInfo({effects:null})]}async function Tt(e,t){const{store:s}=t,i=e.outline?.width||0,r=Te(e),n=s.ensureInstance(ze.pieChart,{uniforms:{shader:{outlineWidth:Math.round(O(i)),defaultColor:Ae(e.defaultColor),outlineColor:Ae(e.outline?.color),othersColor:Ae(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map((e=>Ae(e.color))),visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:e.attributes.length},optionalAttributes:{}}).createMeshInfo({size:e.size,outlineWidth:i,effects:null,scaleInfo:null,minPixelBuffer:je(r)});return[...e.backgroundFillSymbol?await Nt(e.backgroundFillSymbol,{schemaOptions:t,path:"",uniforms:_e}):[],n]}function At(e){if("path"===e.style){if(null==e.path)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const t=Ne.fromSimpleMarker(e);if("outline"in e&&e.outline&&"none"!==e.outline.style){if("solid"!==e.outline.style){if(!t||!t.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:t.symbolLayers[0],overrides:[]}}}return{type:"sprite-rasterization-param",resource:Je(t),overrides:[]}}async function _t(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i;if("path"===e.style||e.outline&&"solid"!==e.outline.style&&"none"!==e.outline.style){const i=Ne.fromSimpleMarker(e);if(!i||!i.symbolLayers)throw new Error("Error handling marker! ");if(s.visualVariableRotation&&(i.angleAlignment="Map"),"path"!==e.style){const e=i.symbolLayers[0];if(Me(t.uniforms)){const s=je(t.uniforms,0,1);if(s>e.size){const t=s/e.size;e.size=s;const i=e.markerGraphics?.[0].symbol;(i.symbolLayers&&i.symbolLayers[0]).width*=t}}}return Pe({type:"CIMSymbolReference",symbol:i},t)}const n=r.ensureInstance(ze.marker,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),a=At(e);let o=e.color?.toArray()??[0,0,0,0];"CIMVectorMarker"===a.resource.type&&(o=[255,255,255,255]);const l="triangle"===e.style?124/116:1,u=e.size,c=u*l,h=null!=s.visualVariableColor&&("cross"===e.style||"x"===e.style);return[n.createMeshInfo({type:"simple",color:o,height:u,width:c,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ce(s)?T.MAP:T.SCREEN,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:u,sprite:a,overrideOutlineColor:h,hasSizeVV:Me(s),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:je(s)})]}function qt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i,n=r.ensureInstance(ze.marker,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),a=Ne.createPictureMarkerRasterizationParam(e);if(!a)return[];return[n.createMeshInfo({type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ce(s)?T.MAP:T.SCREEN,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:a,overrideOutlineColor:!1,hasSizeVV:Me(s),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:je(s)})]}function Bt(e,t,s){const{uniforms:i,schemaOptions:r}=s,{store:n}=r,a=n.ensureInstance(ze.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),o=At(e),l=6,u=l*t.width,c=u,h=e.color?.toArray()??t.color?.toArray()??[0,0,0,0],d="cross"===e.style||"x"===e.style;let p;switch(e.placement){case"begin-end":p=q.Both;break;case"begin":p=q.JustBegin;break;case"end":p=q.JustEnd;break;default:p=q.None}const f={type:"cim-marker-placement-param",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:p,offsetAlongLine:0},overrides:[]};return[a.createMeshInfo({type:"simple",color:h,height:c,width:u,offsetX:0,offsetY:0,angle:0,alignment:Ce(i)?T.MAP:T.SCREEN,outlineColor:h,outlineSize:d?t.width:0,referenceSize:c/l,sprite:o,overrideOutlineColor:d&&null!=i.visualVariableColor,hasSizeVV:Me(i),placement:f,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:je(i)})]}function Dt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i;return[r.ensureInstance(ze.text,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}}).createMeshInfo({boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:[0,0,0,0],outlineSize:0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:Ne.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:je(s),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}function Lt(e,t){const{schemaOptions:s,uniforms:i}=t,{store:r}=s,n=e.symbol,{allowOverrun:a,repeatLabel:o,repeatLabelDistance:l}=e,u={maxScale:e.maxScale??0,minScale:e.minScale??0},c=r.ensureInstance(ze.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}}),h=e.labelPlacement,[d,p]=He(h);return[c.createMeshInfo({boxBackgroundColor:n.backgroundColor?.toArray(),boxBorderLineColor:n.borderLineColor?.toArray(),boxBorderLineSize:n.borderLineSize??0,color:n.color?.toArray()??[0,0,0,0],offsetX:n.xoffset,offsetY:n.yoffset,postAngle:n.angle,fontSize:n.font.size,decoration:n.font.decoration,outlineColor:[0,0,0,0],outlineSize:0,haloColor:n.haloColor?.toArray()??[0,0,0,0],haloSize:n.haloSize??0,lineWidth:n.lineWidth,lineHeightRatio:n.lineHeight,horizontalAlignment:d,verticalAlignment:p,repeatLabel:o,repeatLabelDistance:O(l),allowOverrun:a,labelPosition:e.labelPosition,scaleInfo:u,minPixelBuffer:je(i),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:n.font.toJSON(),textString:n.text,symbol:Ne.createCIMTextSymbolfromTextSymbol(n),primitiveName:"label-override"},useLegacyLabelEvaluationRules:null==e.labelExpressionInfo?.expression,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1})]}function kt(e,t){const s=e.width;return{outlineColor:e.color?.toArray()||[0,0,0,1],width:s,referenceWidth:s,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:t}}function Ut(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i,n=e.color?.toArray()??[0,0,0,0],a={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if("solid"===e.outline?.style){return[r.ensureInstance(ze.patternOutlineFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:n,...kt(e.outline,!!s.visualVariableSizeOutlineScaleStops),sprite:a,scaleInfo:null,effects:null})]}const o=[],l=r.ensureInstance(ze.patternFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:e.color?.toArray()??[0,0,0,0],sprite:a,scaleInfo:null,effects:null});return o.push(l),e.outline&&o.push(...Gt(e.outline,t,!0)),o}function $t(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i,n=e.color?.toArray()??[0,0,0,0];if("none"!==e.style&&"solid"===e.outline?.style){return[r.ensureInstance(ze.outlineFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:n,...kt(e.outline,!!s.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})]}const a=[];if("none"!==e.style){const e=r.ensureInstance(ze.fill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:n,scaleInfo:null,effects:null});a.push(e)}return e.outline&&a.push(...Gt(e.outline,t,!0)),a}async function Nt(e,t){if("cim"===e.type)return Pe(e.data,t);const{style:s}=e;return s&&"none"!==s&&"solid"!==s?Ut(e,t):$t(e,t)}function Ht(e,t){const{outline:s}=e,{uniforms:i,schemaOptions:r}=t,{store:n}=r,a=[],o=Ne.createPictureFillRasterizationParam(e);if(!o)return[];const{width:l,height:u,xoffset:c,yoffset:h,xscale:d,yscale:p}=e,f={color:[255,255,255,255],sprite:o,height:u,aspectRatio:l/u,offsetX:c,offsetY:h,scaleX:d,scaleY:p,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if("solid"===s?.style){return[n.ensureInstance(ze.complexOutlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...f,...kt(s,!!i.visualVariableSizeOutlineScaleStops)})]}const y=n.ensureInstance(ze.complexFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return a.push(y.createMeshInfo(f)),s&&a.push(...Gt(s,t,!0)),a}function Gt(e,t,s){const{color:i,style:r,width:n,cap:a,join:o}=e,{schemaOptions:l}=t,{store:u}=l,c=[],h=s?{..._e,visualVariableSizeScaleStops:t.uniforms.visualVariableSizeOutlineScaleStops}:t.uniforms,d={uniforms:{visualVariableColor:h.visualVariableColor,visualVariableOpacity:h.visualVariableOpacity,visualVariableSizeMinMaxValue:h.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:h.visualVariableSizeScaleStops,visualVariableSizeStops:h.visualVariableSizeStops,visualVariableSizeUnitValue:h.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},p={color:i?.toArray()??[0,0,0,0],width:n,referenceWidth:n,capType:a,joinType:o,miterLimit:e.miterLimit,hasSizeVV:Me(h),effects:null,scaleInfo:null};if(null==r||"solid"===r){const e=u.ensureInstance(ze.line,d).createMeshInfo(p);c.push(e)}else if("none"!==r){const e=u.ensureInstance(ze.texturedLine,d).createMeshInfo({...p,offsetAlongLine:0,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:Ge(r,a)},overrides:[]}});c.push(e)}return null!=e.marker&&c.push(...Bt(e.marker,e,t)),c}async function Jt(e,t,s){const i=t.labelsVisible&&t.labelingInfo||[],r=ft(t),n=B(i,r);return{type:"label",classes:await Promise.all(n.map(((t,i)=>Kt(e,t,i,s))))}}async function Kt(e,t,s,i){const r=await Mt(t,{path:`${s}`,schemaOptions:e,uniforms:i});return{maxScale:t.maxScale,minScale:t.minScale,expression:t.labelExpressionInfo?.expression??t.labelExpression,where:t.where,meshes:r}}async function Qt(e,t){if(!t)return{type:"simple",meshes:[]};switch(t.type){case"simple":return Xt(e,t);case"dot-density":return Wt(e,t);case"class-breaks":return Yt(e,t);case"unique-value":return Zt(e,t);case"dictionary":return es(t);case"heatmap":return ts(e,t);case"pie-chart":return ss(e,t)}}async function Xt(e,t){const s=t.getSymbols(),i=s.length?s[0]:null,r=Te(t),n="renderer.symbol";return{type:"simple",meshes:await Mt(i,{schemaOptions:e,uniforms:r,path:n})}}async function Wt(e,t){const s=Te(t),i="renderer.symbol";return{type:"dot-density",meshes:await jt(t,{schemaOptions:e,uniforms:s,path:i})}}async function Yt(e,t){const s=Te(t),i=t.backgroundFillSymbol,r=t.normalizationType,n="log"===r?"esriNormalizeByLog":"percent-of-total"===r?"esriNormalizeByPercentOfTotal":"field"===r?"esriNormalizeByField":null,a=t.classBreakInfos.map((async t=>({meshes:await Mt(t.symbol,{path:`renderer-stop-${t.minValue}-${t.maxValue}`,schemaOptions:e,uniforms:s}),min:t.minValue,max:t.maxValue}))),o=(await Promise.all(a)).sort(((e,t)=>e.min-t.min)),l=await Mt(i,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{..._e,visualVariableSizeOutlineScaleStops:s.visualVariableSizeOutlineScaleStops}}),u=await Mt(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:s});return{type:"interval",field:t.field,expression:t.valueExpression,backgroundFill:l,defaultSymbol:u,intervals:o,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,normalizationType:n,isMaxInclusive:t.isMaxInclusive}}async function Zt(e,t){const s=[],i=Te(t),r=await Mt(t.backgroundFillSymbol,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{..._e,visualVariableSizeOutlineScaleStops:i.visualVariableSizeOutlineScaleStops}}),n=await Mt(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:i});for(const r of t.uniqueValueInfos??[]){const t=await Mt(r.symbol,{path:`renderer-unique-value-${r.value}`,schemaOptions:e,uniforms:i});s.push({value:""+r.value,symbol:t})}return{type:"map",field:t.field,expression:t.valueExpression,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,backgroundFill:r,defaultSymbol:n,map:s}}function es(e){const t=Te(e),s=e.scaleExpression,i=null!=s&&"1"!==s?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0;return{type:"dictionary",fieldMap:e.fieldMap,scaleExpression:i,visualVariableUniforms:t}}async function ts(e,t){return{type:"heatmap",meshes:await Pt(t,e)}}async function ss(e,t){return{type:"pie-chart",meshes:await Tt(t,e)}}async function is(e,t){const s=t.renderer,i=Te(s);return{symbology:await Qt(e,s),labels:await Jt(e,t,i)}}async function rs(e,t,s,i){const r=s.featureReduction;if(r)switch(r.type){case"binning":return os(r,e,t,s,i);case"cluster":return ls(r,e,t,s,i)}const n=us(s.orderBy,s.renderer,s.objectIdField),a=qe(s.renderer,t.filters),o=await is(e,s),l=hs(o.symbology);return{storage:a,mesh:{properties:{sortKey:n,timeZone:t.timeZone,returnMeshObjectId:l,displayRefreshVersion:i},strategy:{type:"feature"},factory:o}}}function ns(e,t){return e.fields.map((e=>({...e.toJSON(),type:as(e,t)})))}function as(e,t){const{onStatisticExpression:s,onStatisticField:i,statisticType:r}=e;switch(r){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(s){const{returnType:e}=s;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=t.find((e=>e.name===i));return e?e.type:"esriFieldTypeString"}}}async function os(e,t,s,i,r){const n=ns(e,i.fields),a=e.renderer,o=await Qt(t,a),l=qe(a,[null,null]),u=Te(a),c=await Jt(t,{geometryType:"polygon",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},u),h=hs(o),d="geohash"===e.binType?{type:"geohash",fixBinLevel:e.fixedBinLevel??3}:{type:"grid",size:O(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:l,mesh:{properties:{sortKey:null,timeZone:s.timeZone,returnMeshObjectId:h,displayRefreshVersion:r},strategy:{type:"binning",fields:n,index:d,featureFilter:s.filters[0]},factory:{labels:c,symbology:o}}}}async function ls(e,t,s,i,r){const n=ns(e,i.fields),a={type:"cluster",feature:await Qt(t,e.effectiveFeatureRenderer),cluster:await Qt(t,e.effectiveClusterRenderer)},o=Te(e.effectiveFeatureRenderer),l={type:"cluster",feature:await Jt(t,i,o),cluster:await Jt(t,{geometryType:"point",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},o)},u=qe(e.effectiveFeatureRenderer,[null,null]),c=hs(a);return{storage:u,mesh:{properties:{sortKey:null,timeZone:s.timeZone,displayRefreshVersion:r,returnMeshObjectId:c},strategy:{type:"cluster",fields:n,featureFilter:s.filters[0],clusterRadius:O(e.clusterRadius/2)},factory:{labels:l,symbology:a}}}}function us(e,t,s){const i=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||i||(e=[new D({field:s,order:"descending"})]),"default"!==e&&e?.length){const t=e[0],s="ascending"===t.order?"asc":"desc";return t.field?{field:t.field,order:s}:t.valueExpression?{expression:t.valueExpression,order:s}:null}if(i){return{byRenderer:!0,order:"asc"}}return null}function cs(e){return e.techniqueType===ke.AnimatedMarker}function hs(e){if("simple"===e.type&&e.meshes.some(cs))return!0;if("interval"===e.type){if(e.intervals.some((e=>e.meshes.some(cs))))return!0;if(e.backgroundFill.some(cs))return!0}if("map"===e.type){if(e.map.some((e=>e.symbol.some(cs))))return!0;if(e.backgroundFill.some(cs))return!0}return!1}class ds{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,editingInfo:i,objectIdField:r,globalIdField:n,datesInUnknownTimezone:a,orderBy:o,parsedUrl:l}=t,u=t.fieldsIndex.toJSON(),c=ft(t),h=t.timeInfo?.toJSON(),d=t.spatialReference.toJSON(),p=L(l);let f=r;if(o?.length){const e=!o[0].valueExpression&&o[0].field;e&&(f=e)}return{type:"feature-service",source:p,isSourceHosted:k(p.path),orderByFields:f,outSpatialReference:e.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:a,globalIdField:n,fieldsIndex:u,geometryType:c,objectIdField:r,timeInfo:h,spatialReference:d,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:i?.lastEditDate?.getTime(),snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:s,customParameters:i,timeExtent:r,apiKey:n}=this.layer;return zt({definitionExpression:s,customParameters:i,timeExtent:r},e,t,n)}createProcessorSchema(e,t,s){const{fields:i,geometryType:r,orderBy:n,objectIdField:a,renderer:o,labelingInfo:l,labelsVisible:u}=this.layer,c={featureReduction:null,fields:i.map((e=>e.toJSON())),geometryType:r,labelingInfo:l,labelsVisible:u,objectIdField:a,orderBy:n??"default",renderer:o?.clone()};return rs(e,t,c,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,apiKey:i,renderer:r}=t,n=this.layer.labelsVisible?this.layer.labelingInfo:null,a=JSON.stringify(t.customParameters),o=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,apiKey:i,customParameters:a,definitionExpression:s,labelingInfo:n,orderBy:o,renderer:r}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}}function ps(e,t){const s=e.extent,i=t?.clone().intersection(s),r=null!=i?i.width*i.height:0,a=t?t.width*t.height:0,o=0===a?0:r/a,l=n("featurelayer-snapshot-point-coverage");return!isNaN(o)&&o>=l}function fs(e,t){return null!=e.floorInfo&&(e.floorInfo.viewAllLevelIds.length>0||t.floors.length>0)}function ys(e,t,s){const i=ms(e,t?.where,s);return i?(t??=new U,t.where=i,t):t}function ms(e,t,s){if(null==e.floorInfo||!s.floors?.length)return t;let i=s.floors;const{floorField:r,viewAllLevelIds:n}=e.floorInfo;n.length&&(i=n);const a=i.filter((e=>""!==e)).map((e=>"'"+e+"'"));if(a.push("''"),t?.includes(r)){let e=new RegExp("AND \\("+r+".*NULL\\)","g");t=t.replace(e,""),e=new RegExp("\\("+r+".*NULL\\)","g"),t=(t=t.replace(e,"")).replaceAll(/\s+/g," ").trim()}let o="("+r+" IN ({ids}) OR "+r+" IS NULL)";return o=o.replace("{ids}",a.join(", ")),C(t,o)}class bs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,editingInfo:i,objectIdField:r,typeIdField:a,globalIdField:o,datesInUnknownTimezone:l,orderBy:u,subtypeField:c,refreshInterval:h}=t,d=t.fieldsIndex.toJSON(),p=ft(t),f=t.timeInfo?.toJSON(),y=t.spatialReference.toJSON(),m=t.types?.map((e=>e.toJSON())),b=L(this.layer.parsedUrl);this.layer.dynamicDataSource&&(b.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let g=this.layer.objectIdField;if(u?.length){const e=!u[0].valueExpression&&u[0].field;e&&(g=e)}const S=!(null!=i?.lastEditDate)&&h>0,w=!!n("featurelayer-snapshot-enabled")&&"point"===t.geometryType&&s?.query.supportsPagination&&!s?.operations.supportsEditing&&!S,v=w&&ps(e,t.fullExtent);return{type:"feature-service",source:b,isSourceHosted:k(b.path),orderByFields:g,outSpatialReference:e.spatialReference.toJSON(),metadata:{typeIdField:a??void 0,types:m,timeReferenceUnknownClient:l,subtypeField:c,globalIdField:o,fieldsIndex:d,geometryType:p,objectIdField:r,timeInfo:f,spatialReference:y,subtypes:this.layer.subtypes?.map((e=>e.toJSON()))},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:i?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:w,supportsSnapshotMaxThreshold:v,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:s,customParameters:i,gdbVersion:r,historicMoment:n,subtypeCode:a,subtypeField:o,timeExtent:l,apiKey:u}=this.layer;return zt({definitionExpression:s,customParameters:i,gdbVersion:r,historicMoment:n,subtypeCode:a,subtypeField:o,timeExtent:l},e,t,u)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:z(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return rs(e,t,c,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return fs(this.layer,e)}addFilters(e,t){return ys(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i,gdbVersion:r,apiKey:n,subtypeCode:a}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=t.historicMoment?.getTime()??void 0,u=JSON.stringify(t.customParameters),c=z(t,e),h=JSON.stringify(t.orderBy),d=fs(this.layer,e)?e.floors:null;return{outFields:this.layer.outFields,apiKey:n,customParameters:u,definitionExpression:s,featureReduction:c,floors:d,gdbVersion:r,historicMoment:l,labelingInfo:o,orderBy:h,renderer:i,subtypeCode:a}}}function gs(e){if(!("openPorts"in e))throw new p("source-not-supported")}class Ss{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,objectIdField:i}=t,r=t.fieldsIndex.toJSON(),n=ft(t),a=t.timeInfo?.toJSON(),o=t.spatialReference.toJSON();gs(t.source);return{type:"memory",source:await t.source.openPorts(),orderByFields:i,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:r,geometryType:n,objectIdField:i,timeInfo:a,spatialReference:o,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:s,timeExtent:i}=this.layer;return zt({definitionExpression:s,timeExtent:i,customParameters:null},e,t,null)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:z(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return rs(e,t,c,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=z(t,e),a=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,orderBy:a,definitionExpression:s,renderer:i,labelingInfo:r,featureReduction:n}}}class ws{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,objectIdField:i}=t,r=t.fieldsIndex.toJSON(),n=ft(t),a=t.spatialReference.toJSON();return{type:"memory",source:await t.source.openPorts(),orderByFields:i,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:r,geometryType:n,objectIdField:i,spatialReference:a,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:t.timeInfo?.toJSON(),timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:s}=this.layer;return zt({definitionExpression:s,customParameters:null},e,t,null)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l}=this.layer,u={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:z(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l,orderBy:"default"};return rs(e,t,u,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t;return{definitionExpression:s,renderer:i,labelingInfo:this.layer.labelsVisible?this.layer.labelingInfo:null,featureReduction:z(t,e)}}}class vs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,objectIdField:i}=t,r=t.fieldsIndex.toJSON(),n=ft(t),a=t.timeInfo?.toJSON(),o=t.spatialReference.toJSON(),l=t.source.getSource(),u=this.layer.objectIdField,c=L(s);return c.query.maxRecordCount=l.maxRecordCount,{type:"ogc",source:l,orderByFields:u,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:r,geometryType:n,objectIdField:i,timeInfo:a,spatialReference:o,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:c.query.maxRecordCount,supportsCompactGeometry:c.query.supportsCompactGeometry,supportsDefaultSpatialReference:c.query.supportsDefaultSpatialReference,supportsFormatPBF:c.query.supportsFormatPBF,supportsMaxRecordCountFactor:c.query.supportsMaxRecordCountFactor,supportsQuantization:c.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{customParameters:s,timeExtent:i,apiKey:r}=this.layer;return zt({customParameters:s,timeExtent:i},e,t,r)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:z(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return rs(e,t,c,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{renderer:s,apiKey:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null;return{apiKey:i,customParameters:JSON.stringify(t.customParameters),featureReduction:z(t,e),labelingInfo:r,orderBy:JSON.stringify(t.orderBy),renderer:s}}}class Fs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,objectIdField:i,globalIdField:r,orderBy:a,refreshInterval:o}=t,l=t.fieldsIndex.toJSON(),u=ft(t),c=t.timeInfo?.toJSON(),h=t.spatialReference.toJSON(),d=L(this.layer.parsedUrl);let p=this.layer.objectIdField;if(a?.length){const e=!a[0].valueExpression&&a[0].field;e&&(p=e)}const f=o>0,y=!!n("featurelayer-snapshot-enabled")&&"point"===t.geometryType&&s?.query.supportsPagination&&!s?.operations.supportsEditing&&!f,m=y&&ps(e,t.fullExtent);return{type:"feature-service",source:d,isSourceHosted:k(d.path),orderByFields:p,outSpatialReference:e.spatialReference.toJSON(),metadata:{globalIdField:r,fieldsIndex:l,geometryType:u,objectIdField:i,timeInfo:c,spatialReference:h,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:y,supportsSnapshotMaxThreshold:m,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:s,customParameters:i,timeExtent:r}=this.layer;return zt({definitionExpression:s,customParameters:i,timeExtent:r},e,t,null)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:z(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return rs(e,t,c,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return fs(this.layer,e)}addFilters(e,t){return ys(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i,outFields:r}=t,n=this.layer.labelsVisible?this.layer.labelingInfo:null,a=JSON.stringify(t.customParameters),o=z(t,e);return{outFields:r,orderBy:JSON.stringify(t.orderBy),definitionExpression:s,renderer:i,labelingInfo:n,featureReduction:o,customParameters:a,floors:fs(this.layer,e)?e.floors:null}}}class Is{constructor(e){this.layer=e}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return null}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}getUpdateHashProperties(e){const t=this.layer,{renderer:s}=t,i=this.layer.labelsVisible?this.layer.labelingInfo:null,r=JSON.stringify(t.customParameters),n=z(t,e),a=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,labelingInfo:i,featureReduction:n,customParameters:r,orderBy:a,renderer:s}}async createServiceOptions(e){const t=ft(this.layer);return{type:"parquet",source:{urls:this.layer.urls.items},outSpatialReference:e.spatialReference.toJSON(),geometryInfo:this.layer.source.geometryInfo,metadata:{spatialReference:this.layer.spatialReference,fieldsIndex:this.layer.fieldsIndex.toJSON(),objectIdField:this.layer.objectIdField,geometryType:t,types:null,subtypes:null,timeInfo:null,typeIdField:null,subtypeField:null,globalIdField:null,timeReferenceUnknownClient:null}}}createSourceSchema(e,t){return{type:"parquet",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{customParameters:this.layer.customParameters??null}}}}createProcessorSchema(e,t,s){const i={fields:this.layer.fields.map((e=>e.toJSON())),renderer:this.layer.renderer?.clone(),featureReduction:z(this.layer,t),geometryType:this.layer.geometryType,labelingInfo:this.layer.labelingInfo,labelsVisible:this.layer.labelsVisible,objectIdField:this.layer.objectIdField,orderBy:this.layer.orderBy};return rs(e,t,i,s)}}class Vs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Et(t,e)??xt(t);return[{vvEvaluators:{0:Ot(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{objectIdField:s}=t,i=ft(t),r=t.timeInfo?.toJSON()||null,n=t.spatialReference?t.spatialReference.toJSON():null;return{type:"stream",source:this.layer.parsedUrl,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:i,objectIdField:s,timeInfo:r,timeReferenceUnknownClient:null,spatialReference:n,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}createSourceSchema(e,t){const{definitionExpression:s,geometryDefinition:i,customParameters:r}=this.layer;return{type:"stream",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{geometryDefinition:i?.toJSON(),definitionExpression:s,customParameters:r??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l}=this.layer,u={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:z(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l,orderBy:"default"};return rs(e,t,u,s)}get hasRequiredSupport(){return Be(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters);return{definitionExpression:s,renderer:i,labelingInfo:r,featureReduction:z(t,e),customParameters:n,geometryDefinition:t.geometryDefinition,definitionExpressoin:t.definitionExpression}}}async function xs(e,{subtypeField:t,sublayers:s}){const i=await Promise.all(s.map((({renderer:t})=>Qt(e,t))));return{type:"subtype",subtypeField:t,renderers:s.reduce(((e,{subtypeCode:t},s)=>({...e,[t]:i[s]})),{})}}function Es(e,t){const s=$();return{type:"subtype",filters:e.filters,capabilities:{maxTextureSize:s.maxTextureSize},subtypeField:t.subtypeField,target:"feature",bindings:t.sublayers.reduce(((e,{renderer:t,subtypeCode:s})=>{const i=De(t);return{...e,[s]:i}}),{})}}async function Rs(e,{subtypeField:t,sublayers:s}){const i=await Promise.all(s.map((t=>{const s=Te(t.renderer),i={...t,geometryType:t.geometryType??null};return Jt(e,i,s)})));return{type:"subtype",subtypeField:t,renderers:s.reduce(((e,{subtypeCode:t},s)=>({...e,[t]:i[s]})),{})}}async function Os(e,t,s,i){return{storage:Es(t,s),mesh:{properties:{timeZone:t.timeZone,displayRefreshVersion:i,returnMeshObjectId:!1,sortKey:null},strategy:{type:"feature"},factory:{symbology:await xs(e,s),labels:await Rs(e,s)}}}}class zs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every((e=>xt(e)))}]}async createServiceOptions(e){const t=this.layer,{capabilities:s,datesInUnknownTimezone:i,editingInfo:r,globalIdField:a,objectIdField:o,refreshInterval:l,subtypeField:u}=t,c=t.fieldsIndex.toJSON(),h=ft(t),d=t.timeInfo?.toJSON(),p=t.spatialReference.toJSON(),f=L(this.layer.parsedUrl),y=o,m=!(null!=r?.lastEditDate)&&l>0,b=!!n("featurelayer-snapshot-enabled")&&"point"===t.geometryType&&s?.query.supportsPagination&&!s?.operations.supportsEditing&&!m,g=b&&ps(e,t.fullExtent);return{type:"feature-service",source:f,isSourceHosted:k(f.path),orderByFields:y,outSpatialReference:e.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:i,subtypeField:u,globalIdField:a,fieldsIndex:c,geometryType:h,objectIdField:o,timeInfo:d,spatialReference:p,subtypes:this.layer.subtypes?.map((e=>e.toJSON())),typeIdField:null,types:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:r?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:b,supportsSnapshotMaxThreshold:g,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:s,customParameters:i,gdbVersion:r,historicMoment:n,subtypeField:a,timeExtent:o,apiKey:l}=this.layer,u={queryScaleRanges:this.layer.sublayers.items.map((e=>({subtypeCode:e.subtypeCode,minScale:e.minScale,maxScale:e.maxScale}))),definitionExpression:s,customParameters:i,gdbVersion:r,historicMoment:n,subtypeField:a,timeExtent:o};return zt(u,e,t,l)}createProcessorSchema(e,t,s){const i={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(e=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null})))};return Os(e,t,i,s)}hasFilters(e){return fs(this.layer,e)||Cs(this.layer,e)}addFilters(e,t){e=ys(this.layer,e,t);const s=this.layer.sublayers.filter((e=>!Ms(e,t))).map((e=>e.subtypeCode));if(!s.length)return e;e??=new U;const i=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=C(e.where,i),e}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,gdbVersion:i,apiKey:r}=t,n=t.historicMoment?.getTime()??void 0,a=JSON.stringify(t.customParameters),o=fs(this.layer,e)?e.floors:null,l=this.layer.sublayers.map((({renderer:e,labelsVisible:t,labelingInfo:s,visible:i})=>({renderer:e,labelsVisible:t,labelingInfo:s,visible:i})));return{outFields:this.layer.outFields,gdbVersion:i,definitionExpression:s,historicMoment:n,customParameters:a,apiKey:r,sublayers:l,floors:o}}setGraphicOrigin(e){const t=this.layer.fieldsIndex.get(this.layer.subtypeField),s=e.attributes[t.name],i=this.layer.sublayers.find((e=>e.subtypeCode===s));e.layer=e.sourceLayer=i}}function Cs(e,t){return e.sublayers.some((e=>!Ms(e,t)))}function Ms(e,t){return e.visible&&(0===e.minScale||N(t.scale,e.minScale)||t.scale<e.minScale)&&(0===e.maxScale||N(t.scale,e.maxScale)||t.scale>e.maxScale)}async function js(e,t){try{return await e}catch(e){if("no-queryEngine"!==e.name)throw e;return t}}function Ps(e,t){const s=new Set;for(const i of e instanceof Set?e.values():e.keys())t.has(i)||s.add(i);return s}class Ts{constructor(e,t,s){const i=s?e.getTileCoverage(s,0,!0,"closest"):null,r=e.getTileCoverage(t,0,!0,"closest");if(this._tileKeys=new Map,i)for(const e of i.keys())this._tileKeys.set(e.id,e);if(r)for(const e of r.keys())this._tileKeys.set(e.id,e)}get coverageSet(){return new Set(this._tileKeys.keys())}keys(){return this._tileKeys.values()}}class As{constructor(e){this.version=e}}class _s{constructor(e){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=e}destroy(){}get _coverageSet(){return this._coverage?.coverageSet??new Set}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){null==this._coverage&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions())}update(e,t){return this._version=(this._version+1)%Number.MAX_SAFE_INTEGER,this._updateCoverage(e,t),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(e,t){this._coverage=new Ts(this._config.tileInfoView,e,t)}_updateSubscriptions(){const e=this._coverageSet,t=this._updateVisibility(),s=Ps(t,e),i=Ps(this._subscriptions,t),r=Ps(e,this._subscriptions),n=Ps(i,e),a=Ps(s,n),o=Ps(a,this._paused);this._visible=t;for(const e of r.values())this._subscriptions.set(e,new As(this._version));for(const e of o.values())this._paused.add(e);for(const e of n.values())this._subscriptions.delete(e),this._paused.delete(e);(r.size||n.size||o.size)&&this._sendUpdateSubscriptions(r,n,o)}_sendUpdateSubscriptions(e,t,s){const i=Array.from(e.values()).map((e=>({tileId:e,version:this._subscriptions.get(e).version})));this._config.updateSubscriptions({subscribe:i,unsubscribe:Array.from(t.values()),pause:Array.from(s.values())})}_updateVisibility(){const e=new Set,t=new Set;if(!this._coverage)return e;for(const s of this._coverage.keys()){if(this._config.isDone(s)){e.add(s.id);continue}if(this._addVisibleParent(e,t,s))continue;this._addVisibleChildren(e,s)||e.add(s.id)}const s=new h(0,0,0,0),i=new h(0,0,0,0);for(const r of t){s.id=r;for(const t of e)i.id=t,s.containsChild(i)&&e.delete(t)}return e}_addVisibleParent(e,t,s){let i=!1;for(const r of this._visible.values()){new h(r).containsChild(s)&&(e.add(r),t.add(r),i=!0)}return i}_addVisibleChildren(e,t){let s=!1;for(const i of this._visible.values()){const r=new h(i);t.containsChild(r)&&(e.add(i),s=!0)}return s}}const qs=i=>{let r=class extends i{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([G((()=>{const e=this.layer;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),J),K((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),K((()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null}),"change",(()=>this._handleRequiredFieldsChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:s}=this;return"outFields"in e&&e.outFields?Q(t,[...X(t,e.outFields),...s]):Q(t,s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){f.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new W(e);if("floorInfo"in this.layer&&this.layer.floorInfo){const e=Y(this);null!=e&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new W(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){return this._validateFetchPopupFeatures(e,t),this._fetchPopupFeatures(e,t)}_loadArcadeModules(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?Z():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:s,objectIdField:i}}=this,r="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,a="featureReduction"in t?t.featureReduction:null,o=new Set,l=await Promise.allSettled([r?r.collectRequiredFields(o,s):null,ee(o,t),e&&"elevationInfo"in t?te(o,t):null,null!=this.filter?se(o,t,this.filter):null,e||null==this.featureEffect?null:se(o,t,this.featureEffect.filter),!e&&a?ie(o,t,a):null,!e&&n?re(o,t,n):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&ne(o,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"floorInfo"in t&&t.floorInfo&&ne(o,t.fieldsIndex,[t.floorInfo.floorField]),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&f.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),ne(o,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){ae(o,s,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(o,s),ee(o,e)])));await Promise.allSettled(e)}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;ne(o,s,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}for(const e of l)"rejected"===e.status&&f.getLogger(this).error(e.reason);ae(o,s,i),e&&"displayField"in t&&t.displayField&&ae(o,s,t.displayField);const u=Array.from(o).sort();this._set("requiredFields",u)}_validateFetchPopupFeatures(e,t){if(null!=t)for(const s of e){const e=s.origin&&"layer"in s.origin?s.origin.layer:s.layer;if("popupEnabled"in e&&!e.popupEnabled)throw new p("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e});if(s.isAggregate){const t="featureReduction"in e?e.featureReduction:null;if(!(t&&"popupTemplate"in t&&t.popupEnabled&&t.popupTemplate))throw new p("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e})}else if("popupTemplate"in e){if(!Qe(e,t))throw new p("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:e})}}}_popupFeatureHasRequiredFields(e,t){return oe(t,e)}async _fetchPopupFeatures(e,t){const s=new Array(e.length),i=new Map,r=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);for(let n=0;n<e.length;n++){const a=e[n];if(a.isAggregate){s[n]=a;continue}const o=a.origin?.layer??a.layer;if(!o||!("popupEnabled"in o))continue;const l=X(this.layer.fieldsIndex,r.outFields),u=Qe(o,t);if(null==u)continue;const c=await this._loadArcadeModules(u);b(t);c&&c.arcadeUtils.hasGeometryOperations(u)||!this._popupFeatureHasRequiredFields(a,l)?i.set(a.getObjectId(),{graphic:a,index:n}):s[n]=a}if("stream"===this.layer.type||"parquet"===this.layer.type||0===i.size)return s.filter(Boolean);r.objectIds=Array.from(i.keys());try{const e=await this.layer.queryFeatures(r,t);for(const t of e.features){const{graphic:{geometry:e,origin:r},index:n}=i.get(t.getObjectId());t.geometry||=e,t.origin=r,s[n]=t}}catch{}return s.filter(Boolean)}async _createPopupQuery(e,t){const s=this.layer.createQuery(),i=new Set;let r=!1;const n=e??[this.layer];for(const e of n){if(!("popupEnabled"in e))continue;const s=Qe(e,t);if(null==s)continue;const n=await this._loadArcadeModules(s);b(t);const a=n&&n.arcadeUtils.hasGeometryOperations(s);r=!("point"!==this.layer.geometryType&&!a);const o=await Xe(this.layer,s);b(t);for(const e of o)i.add(e)}if(s.returnGeometry=r,s.returnZ=r,s.returnM=r,s.outFields=Array.from(i),s.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const e=Y(this);null!=e&&(s.where=s.where?`(${s.where}) AND (${e})`:e)}return s}canResume(){return!!super.canResume()&&(null==this.timeExtent||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return e([t()],r.prototype,"_updatingRequiredFieldsPromise",void 0),e([t({readOnly:!0})],r.prototype,"availableFields",null),e([t({readOnly:!0})],r.prototype,"dataUpdating",void 0),e([t({type:H})],r.prototype,"featureEffect",null),e([t({type:U})],r.prototype,"filter",void 0),e([t()],r.prototype,"layer",void 0),e([t({type:Number})],r.prototype,"maximumNumberOfFeatures",null),e([t({readOnly:!0,type:Boolean})],r.prototype,"maximumNumberOfFeaturesExceeded",null),e([t({readOnly:!0})],r.prototype,"requiredFields",void 0),e([t()],r.prototype,"suspended",void 0),e([t()],r.prototype,"view",void 0),r=e([s("esri.views.layers.FeatureLayerView")],r),r};function Bs(e,t){const s=new Set;return e&&e.forEach((e=>s.add(e))),t&&t.forEach((e=>s.add(e))),s.has("*")?["*"]:Array.from(s)}const Ds=4294967294;let Ls=class extends(qs(We(Ve(xe)))){constructor(){super(...arguments),this._commandsQueue=new Le({process:e=>{switch(e.type){case"edit-by-feature":case"edit-by-id":return this._doEdit(e);case"update":return this._doUpdate();case"highlight":return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new Ke,this._lastAvailableFields=[],this._lastTargetState=null,this.eventLog=new pt,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new tt}destroy(){this._workerProxy?.destroy(),this._workerAttached.reject(le()),this._commandsQueue.destroy()}initialize(){this._workerAttached=g(),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransition()}async _initProxy(){const e=this.layer;if("isTable"in e&&e.isTable)throw new p("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if("mesh"===e.geometryType)throw new p("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if(("feature"===e.type||"subtype-group"===e.type)&&!1===ue(e)?.operations.supportsQuery)throw new p("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});this._workerProxy&&this._workerProxy.destroy();const t=this._createClientOptions();this._workerProxy=await ct(t)}async _attachProxy(){const e={service:await this.layerAdapter.createServiceOptions(this.view),tileInfoJSON:this.view?.featuresTilingScheme?.tileInfo?.toJSON()};let t=[];Array.isArray(e.service.source)&&(t=e.service.source);try{await this._workerProxy.pipeline.onAttach(e,{transferList:t}),this._workerAttached.resolve()}catch(e){this._workerAttached.reject(le()),ce(e)}}async _detachProxy(){return this._workerProxy.pipeline.onDetach()}async getWorker(){return await this._workerAttached.promise,this._workerProxy}get hasAllFeatures(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&!this.suspended&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,s=!this.suspended;return e.map((({vvEvaluators:e,deconflictionEnabled:i})=>({container:this.featureContainer,vvEvaluators:e,deconflictionEnabled:i,geometryType:t,visible:s})))}get layerAdapter(){switch(this.layer.type){case"feature":return"memory"===this.layer.source.type?new Ss(this.layer):new bs(this.layer);case"geojson":case"csv":case"wfs":return new Ss(this.layer);case"parquet":return new Is(this.layer);case"subtype-group":return new zs(this.layer);case"ogc-feature":return new vs(this.layer);case"stream":return new Vs(this.layer);case"oriented-imagery":return new Fs(this.layer);case"knowledge-graph-sublayer":return new ws(this.layer);case"catalog-footprint":return new ds(this.layer)}return null}get timeExtent(){return Ie(this.layerAdapter.timeOptions,this.view?.timeExtent,this._get("timeExtent"))}getDisplayStatistics(e,t){return this.featureContainer?.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return(await this.getWorker()).pipeline.queryHeatmapStatistics(e)}highlight(e,t="default"){let s;e instanceof i?s=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?s=[e]:he.isCollection(e)&&e.length>0?s=e.map((e=>e?.getObjectId())).toArray():Array.isArray(e)&&e.length>0&&(s="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((e=>e?.getObjectId())));const r=s?.filter(de);return r?.length?(this._addHighlights(r,t),pe((()=>this._removeHighlights(r,t)))):pe()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return!this._highlightCounter.empty}async hitTest(e,t){const s=await this.featureContainer.hitTest(t);if(0===s.length)return null;const r=await this.getWorker(),{features:n,aggregates:a}=await r.pipeline.getDisplayFeatures(s),o=this.featureContainer.getSortKeys(s),l=({displayId:e},{displayId:t})=>o.has(e)&&o.has(t)?o.get(e)-o.get(t):e-t;return n.sort(l).reverse(),a.sort(l).reverse(),[...a.map((t=>this._createGraphicHit(e,Ze.fromJSON(t)))),...n.map((t=>this._createGraphicHit(e,i.fromJSON(t))))]}async queryStatistics(){const e=await this.getWorker();return js(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}async querySummaryStatistics(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),r,s);return js(n,{})}async queryAggregateSummaryStatistics(e,t,s){const i={...t,scale:this.view.scale},r=(await this.getWorker()).aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),i,s);return js(r,{})}async queryUniqueValues(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.features.executeQueryForUniqueValues(this._cleanUpQuery(e),r,s);return js(n,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),r,s);return js(n,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.features.executeQueryForClassBreaks(this._cleanUpQuery(e),r,s);return js(n,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),r,s);return js(n,{classBreakInfos:[]})}async queryHistogram(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.features.executeQueryForHistogram(this._cleanUpQuery(e),r,s);return js(n,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,s){const i=await this.getWorker(),r={...t,scale:this.view.scale},n=i.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),r,s);return js(n,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then((e=>{const t=l.fromJSON(e);return t.features.forEach((e=>this._setLayersForFeature(e))),t}))}async queryVisibleFeatures(e,t){const s=(await this.getWorker()).pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),i=await js(s,{features:[]}),r=l.fromJSON(i);return r.features.forEach((e=>this._setLayersForFeature(e))),r}async queryAggregates(e,t){const s=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),i=await js(s,{features:[]}),r=it.fromJSON(i);return r.features.forEach((e=>this._setLayersForFeature(e))),r}async queryAggregateIds(e,t){const s=(await this.getWorker()).aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return js(s,[])}async queryAggregateCount(e,t){const s=(await this.getWorker()).aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return js(s,0)}async queryAggregateJSON(e,t){const s=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return js(s,{features:[]})}async queryFeaturesJSON(e,t){const s=(await this.getWorker()).features.executeQuery(this._cleanUpQuery(e),t);return js(s,{features:[]})}async queryObjectIds(e,t){const s=(await this.getWorker()).features.executeQueryForIds(this._cleanUpQuery(e),t);return js(s,[])}async queryFeatureCount(e,t){const s=(await this.getWorker()).features.executeQueryForCount(this._cleanUpQuery(e),t);return js(s,0)}async queryExtent(e,t){const s=(await this.getWorker()).features.executeQueryForExtent(this._cleanUpQuery(e),t),i=await js(s,{count:0,extent:null});return{count:i.count,extent:fe.fromJSON(i.extent)}}async getSampleFeatures(e){return(await this.getWorker()).pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._subscriptionManager)return;this.view.animation&&!this._lastTargetState&&(this._lastTargetState=e.state.clone()),!this.view.animation&&this._lastTargetState&&(this._lastTargetState=null);const t=this._subscriptionManager.update(e.targetState,this._lastTargetState);this.featureContainer.setVisibleTiles(t)}attach(){n("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),ye(this._updatingHandles.addPromise(this._workerAttached.promise)),ye(this._attachProxy()),this.featureContainer=new lt(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new _s({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),ye(this._updatingHandles.addPromise(this.getWorker().then((t=>t.pipeline.updateSubscriptions(e)))))},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([G((()=>JSON.stringify({displayRefreshVersion:this._displayRefreshVersion,timeExtent:this.timeExtent,clips:this.clips,filter:this.filter,featureEffect:this.featureEffect,sourceRefreshVersion:this._sourceRefreshVersion,timeZone:this.view.timeZone,effect:this.featureEffect,...this.layerAdapter.getUpdateHashProperties(this.view)})),(()=>this._update()),me),G((()=>this.updateSuspended),(e=>{e||(this._subscriptionManager.resume(),this.view.labelManager.requestUpdate())})),G((()=>this.visible),(e=>{this.view.labelManager.requestUpdate()}))]),"stream"!==this.layer.type&&"parquet"!==this.layer.type&&"catalog-footprint"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",(e=>this._edit(e))))}detach(){n("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._detachProxy(),this._fields=null,this.featureContainer.destroy(),this.featureContainer=null,this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=be(this._subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=g(),this._lastAvailableFields=[],this._lastSchema=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&null!=this.layer.renderer,t=this._commandsQueue.updateTracking.updating,s=null!=this._updatingRequiredFieldsPromise,i=this.featureContainer.updatingHandles.updating,r=this.updateRequested||e&&(t||s)||i||this._pipelineUpdating||this.dataUpdating;if(n("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${r}\n  -> updateRequested ${this.updateRequested}\n  -> hasRenderer ${e}\n  -> updatingRequiredFields ${s}\n  -> hasPendingCommand ${t}\n  -> dataUpdating ${this.dataUpdating}\n  -> processing ${this._pipelineUpdating}\n  -> updatingContainer ${i}\n`);for(const e of this.featureContainer.subscriptions())console.log(`    -> Tile[${e.id}] Done: ${e.done}`)}return r}_createClientOptions(){const e=this;return{get container(){return e.featureContainer},setUpdating:e=>{this._set("_pipelineUpdating",e.pipeline),this._set("dataUpdating",e.data)},emitEvent:e=>{this.emit(e.name,e.event)},get eventLog(){return e.eventLog},fetch:t=>Promise.all(t.map((t=>e.view.stage.painter.textureManager.rasterizeItem(t)))),fetchDictionary:e=>Promise.all(e.map((e=>this._fetchDictionaryRequest(e))))}}async _fetchDictionaryRequest(e){try{if("subtype-group"===this.layer.type)throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=this.layer.renderer;if(!t||"dictionary"!==t.type)throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const s=this._lastSchema.processor.mesh.factory.symbology;if("dictionary"!==s.type)throw new Error("InternalError: Expected schema to be of type 'dictionary'");const i={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:s.scaleExpression};this._fields||(this._fields=this.layer.fields.map((e=>e.toJSON())));const r=s.visualVariableUniforms,n=await t.getSymbolAsync(e.feature,{fields:this._fields});if(!n||!n.data)return{type:"dictionary-response",meshes:[]};return{type:"dictionary-response",meshes:await Pe(n.data,{uniforms:r,path:"renderer",schemaOptions:i})}}catch(e){return{type:"dictionary-response",meshes:[]}}}_cleanUpQuery(e){const t=W.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAggregateQuery(e){const t=W.from(e)||this.createAggregateQuery();t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference);const s=t.objectIds??[];for(const e of t.aggregateIds??[])s.push(e);return t.objectIds=s,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(e){if(this.updateSuspended)return void this._subscriptionManager.suspend();const t=this._getEffectiveEdit(e);return t?this._commandsQueue.push(t).catch(ce):void 0}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()))}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%Ds+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%Ds+1}_getEffectiveEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,s=e.deletedFeatures.some((e=>-1===e.objectId||!e.objectId)),i=t&&this.availableFields.includes(t);if(s&&!i)return f.getLogger(this).error(new p("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null;const r=this.layer,n=e.historicMoment?.getTime()??null,a="layerId"in r&&e.editedFeatures?.find((e=>e.layerId===r.layerId));if(a&&this._canEditByFeature(a)){const e=!1,s=!1,i=ge(this.layer.geometryType),{adds:r,deletes:o,updates:l}=a.editedFeatures,u=this.layer.objectIdField,c=r.map((t=>Fe(t,i,e,s))),h=l.map((t=>Fe(t.current,i,e,s)));return{type:"edit-by-feature",added:c,removed:o.map((e=>"attributes"in e?{globalId:t?e.attributes[t]:null,objectId:u?e.attributes[u]:null}:e)),updated:h,historicMoment:n}}return{type:"edit-by-id",added:e.addedFeatures,updated:e.updatedFeatures,removed:e.deletedFeatures,historicMoment:n}}_canEditByFeature(e){const{adds:t,updates:s}=e.editedFeatures;return t.every((e=>this.view.spatialReference.equals(e.geometry?.spatialReference)))&&s.every((e=>this.view.spatialReference.equals(e.current.geometry?.spatialReference)))}async _doUpdate(){"featureReduction"in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=this.layer.featureReduction?.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await this._updateRequiredFields(),this.destroyed||!this.layerAdapter?.hasRequiredSupport||!this._subscriptionManager)return;const e=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const t=this.featureEffect,s={store:e,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},i=this._createViewSchemaConfig(),r={source:this.layerAdapter.createSourceSchema(i,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(s,i,this._displayRefreshVersion)},a=ve(this._lastSchema?.source.mutable,r.source.mutable)||ve(this._lastSchema?.processor,r.processor);if(!a)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(this.featureEffectView.featureEffect=t);this._lastSchema=r,this._fields=null;const o=Math.round(performance.now());n("esri-2d-update-debug")&&console.debug(`Id[${this.layer.uid}] Version[${o}] FeatureLayerView2D._doUpdate`,{changes:a});const l=await this.getWorker();await l.pipeline.updateSchema(r,o),e.updateEnd(),this.featureEffectView.featureEffect=t,this.featureEffectView.endTransition(),this.featureContainer.restartAllAnimations(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.swapRenderState(),this.featureContainer.requestRender(),n("esri-2d-update-debug")&&console.debug(`Version[${o}] FeatureLayerView2D.updateEnd`),this.requestUpdate()}catch(e){n("esri-2d-update-debug")&&console.error("Encountered an error during update",e)}}async _doEdit(e){const t=await this.getWorker();try{this.featureContainer.editStart(),await t.pipeline.onEdits(e),this.featureContainer.editEnd()}catch(e){}}get hasFilter(){const e=this.layerAdapter.hasFilters?.(this.view)??!1;return null!=this.filter||null!=this.timeExtent||this._visibilityOverrides.size>0||e}_getEffectiveAvailableFields(e){const t=Bs(this._lastAvailableFields,e);return this._lastAvailableFields=t,Se(this.layer.fieldsIndex,t)}_createViewSchemaConfig(){const e=[ks(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:e,scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlights(e,t){this._highlightCounter.addGroup(e,t),this._commandsQueue.push({type:"highlight"})}_removeHighlights(e,t){this._highlightCounter.deleteGroup(e,t),this._commandsQueue.push({type:"highlight"})}async _updateHighlights(){const e=[];for(const t of this._highlightCounter.ids()){const s=this._highlightCounter.getHighlightGroups(t),i=this._getHighlightBits(s);e.push({objectId:t,highlightFlags:i})}const t=await this.getWorker();if(this.destroyed)return;const s=t.pipeline.updateHighlight({highlights:e}).catch((e=>{we(e)||f.getLogger(this).error(e)}));this._updatingHandles.addPromise(s)}_setLayersForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(e)}_createGraphicHit(e,t){return this._setLayersForFeature(t),null!=t.geometry&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};function ks(e,t,s,i,r){r&&(r=r.clone());const n=null!=r?r.timeExtent:null,a=null!=s&&null!=n?s.intersection(n):s||n;a&&(r??=new U,r.timeExtent=a),r=t.addFilters?.(r,e)??r;let o=r?.toJSON()??null;return i.size&&(o??=(new U).toJSON(),o.hiddenIds=Array.from(i)),o}e([t()],Ls.prototype,"_commandsQueue",void 0),e([t()],Ls.prototype,"_sourceRefreshVersion",void 0),e([t()],Ls.prototype,"_displayRefreshVersion",void 0),e([t({readOnly:!0})],Ls.prototype,"_pipelineUpdating",void 0),e([t({readOnly:!0})],Ls.prototype,"hasAllFeatures",null),e([t({readOnly:!0})],Ls.prototype,"hasAllFeaturesInView",null),e([t({readOnly:!0})],Ls.prototype,"hasFullGeometries",null),e([t()],Ls.prototype,"featureEffectView",void 0),e([t()],Ls.prototype,"labelingCollisionInfos",null),e([t()],Ls.prototype,"layerAdapter",null),e([t({readOnly:!0})],Ls.prototype,"timeExtent",null),e([t()],Ls.prototype,"updating",void 0),Ls=e([s("esri.views.2d.layers.FeatureLayerView2D")],Ls);const Us=Ls;const $s=Object.freeze({__proto__:null,default:Us});export{$s as F,js as n,Us as r};
//# sourceMappingURL=p-72f8c1e2.js.map