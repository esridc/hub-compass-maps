import{cB as t,dA as e,b_ as s,an as r,ao as i,dB as o,ap as n,am as a,c_ as u,h as c,dC as l,dD as p,a as h}from"./p-028496e2.js";import{u as d,i as f}from"./p-c2c5c63d.js";import{n as m,s as y}from"./p-3f094b9d.js";import{x}from"./p-c439e241.js";import{a as F}from"./p-0053e125.js";import{n as j}from"./p-cd329783.js";async function b(r,i,o){const n=e(r),a=await x(n,s.from(i),{...o}),u=a.data.extent;return!u||isNaN(u.xmin)||isNaN(u.ymin)||isNaN(u.xmax)||isNaN(u.ymax)?{count:a.data.count,extent:null}:{count:a.data.count,extent:t.fromJSON(u)}}let w=class extends a{constructor(t){super(t),this.dynamicDataSource=null,this.fieldsIndex=null,this.gdbVersion=null,this.infoFor3D=null,this.pbfSupported=!1,this.queryAttachmentsSupported=!1,this.sourceSpatialReference=null,this.url=null}get parsedUrl(){return u(this.url)}async execute(t,e){const s=await this.executeJSON(t,e);return this.featureSetFromJSON(t,s,e)}async executeJSON(t,e){const s=this._normalizeQuery(t),r=null!=t.outStatistics?.[0],i=c("featurelayer-pbf-statistics"),o=!r||i;let n;if(this.pbfSupported&&o)try{n=await j(this.url,s,e)}catch(t){if("query:parsing-pbf"!==t.name)throw t;this.pbfSupported=!1}return this.pbfSupported&&o||(n=await F(this.url,s,e)),this._normalizeFields(n.fields),n}async featureSetFromJSON(t,e,s){if(!this._queryIs3DObjectFormat(t)||null==this.infoFor3D||!e.features)return l.fromJSON(e);const{meshFeatureSetFromJSON:r}=await p(import("./p-ae0fe065.js"),s);return r(t,this.infoFor3D,e)}executeForCount(t,e){return m(this.url,this._normalizeQuery(t),e)}executeForExtent(t,e){return b(this.url,this._normalizeQuery(t),e)}executeForIds(t,e){return y(this.url,this._normalizeQuery(t),e)}async executeRelationshipQuery(t,e){const[{default:s},{executeRelationshipQuery:r}]=await p(Promise.all([import("./p-028496e2.js").then((function(t){return t.o5})),import("./p-f1426583.js")]),e);return t=s.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),r(this.url,t,e)}async executeRelationshipQueryForCount(t,e){const[{default:s},{executeRelationshipQueryForCount:r}]=await p(Promise.all([import("./p-028496e2.js").then((function(t){return t.o5})),import("./p-f1426583.js")]),e);return t=s.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),r(this.url,t,e)}async executeAttachmentQuery(t,s){const{executeAttachmentQuery:r,fetchAttachments:i,processAttachmentQueryResult:o}=await p(import("./p-cddd666d.js"),s),n=e(this.url);return o(n,await(this.queryAttachmentsSupported?r(n,t,s):i(n,t,s)))}async executeTopFeaturesQuery(t,e){const{executeTopFeaturesQuery:s}=await p(import("./p-25c7a891.js"),e);return s(this.parsedUrl,t,this.sourceSpatialReference,e)}async executeForTopIds(t,e){const{executeForTopIds:s}=await p(import("./p-36131abf.js"),e);return s(this.parsedUrl,t,e)}async executeForTopExtents(t,e){const{executeForTopExtents:s}=await p(import("./p-3b6b4174.js"),e);return s(this.parsedUrl,t,e)}async executeForTopCount(t,e){const{executeForTopCount:s}=await p(import("./p-4c6d85b8.js"),e);return s(this.parsedUrl,t,e)}_normalizeQuery(t){let e=s.from(t);e.sourceSpatialReference=e.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(e=e===t?e.clone():e,e.gdbVersion=t.gdbVersion||this.gdbVersion,e.dynamicDataSource=t.dynamicDataSource?o.from(t.dynamicDataSource):this.dynamicDataSource);const{infoFor3D:r}=this;if(null!=r&&this._queryIs3DObjectFormat(t)){e=e===t?e.clone():e,e.formatOf3DObjects=null;const{supportedFormats:s,queryFormats:i}=r,o=d("model/gltf-binary",s)??f("glb",s),n=d("model/gltf+json",s)??f("gltf",s);for(const t of i){if(t===o){e.formatOf3DObjects=t;break}t!==n||e.formatOf3DObjects||(e.formatOf3DObjects=t)}if(!e.formatOf3DObjects)throw new h("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==e.outFields||!e.outFields.includes("*")){e=e===t?e.clone():e,null==e.outFields&&(e.outFields=[]);const{originX:s,originY:i,originZ:o,translationX:n,translationY:a,translationZ:u,scaleX:c,scaleY:l,scaleZ:p,rotationX:h,rotationY:d,rotationZ:f,rotationDeg:m}=r.transformFieldRoles;e.outFields.push(s,i,o,n,a,u,c,l,p,h,d,f,m)}}return e}_normalizeFields(t){if(null!=this.fieldsIndex&&null!=t)for(const e of t){const t=this.fieldsIndex.get(e.name);t&&Object.assign(e,t.toJSON())}}_queryIs3DObjectFormat(t){return null!=this.infoFor3D&&!0===t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}};r([i({type:o})],w.prototype,"dynamicDataSource",void 0),r([i()],w.prototype,"fieldsIndex",void 0),r([i()],w.prototype,"gdbVersion",void 0),r([i()],w.prototype,"infoFor3D",void 0),r([i({readOnly:!0})],w.prototype,"parsedUrl",null),r([i()],w.prototype,"pbfSupported",void 0),r([i()],w.prototype,"queryAttachmentsSupported",void 0),r([i()],w.prototype,"sourceSpatialReference",void 0),r([i({type:String})],w.prototype,"url",void 0),w=r([n("esri.tasks.QueryTask")],w);const g=w;export{g as x};
//# sourceMappingURL=p-b2d5ab9c.js.map