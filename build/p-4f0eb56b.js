import{r as t,p as e,q as s,ac as i,bH as n,d$ as r,a3 as o,bC as a,ns as h,nt as c,eM as l,s as u,$ as d,jM as f,dA as p,kI as m,cn as g,nu as w,nv as v,lO as y,nw as x,lZ as b,ar as M,m9 as C,nc as A,mQ as O,lM as S,dv as _,aM as P,aT as T,aS as R,aJ as j,m0 as I,lJ as F,nx as z,ny as D,ag as E,eA as G,a2 as V,nz as U,nA as L,mT as H,mK as B,et as $,mN as k,eo as N,nB as q,mR as Y,aX as W,ep as X,aU as Q,aW as J,lL as Z,n as K,nC as tt,nD as et,mL as st,c6 as it,nE as nt,nF as rt,nG as ot,lS as at,f1 as ht,kg as ct,m2 as lt,lN as ut,ak as dt,F as ft,l3 as pt,nH as mt,nI as gt,nJ as wt,nK as vt,iZ as yt,nL as xt,lG as bt,dN as Mt,cs as Ct,nM as At,hO as Ot,x as St,d8 as _t,e8 as Pt,nN as Tt,my as Rt,nO as jt,ee as It,d3 as Ft,dr as zt,f2 as Dt,eb as Et,ah as Gt,eF as Vt,nP as Ut,ao as Lt,nQ as Ht,dX as Bt,hc as $t,kY as kt,nR as Nt,nS as qt,lT as Yt,nT as Wt,an as Xt,l5 as Qt,nU as Jt,mf as Zt,m1 as Kt,k8 as te,l6 as ee,ne as se,mY as ie,nV as ne,al as re,e0 as oe,V as ae,T as he,X as ce,w as le,bD as ue}from"./p-aad64c9f.js";import{V as de}from"./p-02236077.js";import{h as fe,E as pe}from"./p-5ae33da2.js";import{n as me}from"./p-1c285990.js";import{s as ge}from"./p-aff89b86.js";import{d as we}from"./p-1062e8df.js";import{n as ve}from"./p-21ce5524.js";import{b as ye,h as xe}from"./p-4e60756f.js";import{l as be,t as Me}from"./p-5b459e36.js";import{a as Ce,n as Ae,A as Oe,r as Se,O as _e,N as Pe,t as Te,o as Re,C as je,s as Ie,d as Fe,f as ze,e as De,b as Ee,c as Ge,p as Ve,w as Ue,g as Le,h as He,i as Be,j as $e,k as ke,P as Ne,l as qe,m as Ye,q as We,u as Xe,v as Qe,x as Je,y as Ze,z as Ke,B as ts,T as es,D as ss,E as is,F as ns,G as rs,H as os,I as as,J as hs,K as cs,L as ls,W as us,M as ds,Q as fs,R as ps,S as ms,U as gs,V as ws,X as vs,Y as ys,Z as xs,_ as bs,$ as Ms,a0 as Cs,a1 as As,a2 as Os,a3 as Ss,a4 as _s,a5 as Ps}from"./p-967c3f9e.js";import{t as Ts}from"./p-480f4fcd.js";import{n as Rs,a as js}from"./p-3b7ff27a.js";import{O as Is,e as Fs}from"./p-dc92c2ea.js";import{t as zs}from"./p-af33d18c.js";import{e as Ds,o as Es}from"./p-88dd7081.js";import{s as Gs}from"./p-dc645a50.js";import{e as Vs}from"./p-e91c4d32.js";import{H as Us}from"./p-06c101b5.js";import{H as Ls,N as Hs,L as Bs,Y as $s}from"./p-584320ce.js";import{b as ks,T as Ns,E as qs,U as Ys,v as Ws,V as Xs,f as Qs}from"./p-175d4a9b.js";import{b as Js,g as Zs,m as Ks,c as ti,u as ei,x as si}from"./p-a040372a.js";import{i as ii,e as ni}from"./p-d2c6038f.js";import{e as ri}from"./p-79c28fb7.js";import{i as oi,l as ai,c as hi,x as ci,b as li,T as ui,u as di,h as fi,d as pi}from"./p-fa12d64c.js";import{E as mi}from"./p-2ea4a2b9.js";import{J as gi,k as wi}from"./p-ed54582d.js";import{o as vi}from"./p-44881b12.js";import{t as yi,B as xi,o as bi,g as Mi,p as Ci}from"./p-790e1969.js";import{o as Ai}from"./p-de84037a.js";import{o as Oi,r as Si}from"./p-dddb66c6.js";import{a as _i}from"./p-17d8c81f.js";import{n as Pi}from"./p-3a58cb37.js";import{C as Ti}from"./p-e51694e6.js";import"./p-17b3a90f.js";import{r as Ri,n as ji}from"./p-717596a8.js";import{t as Ii}from"./p-436c45c7.js";import"./p-3408a06f.js";import{a as Fi}from"./p-1826fadd.js";import{c as zi}from"./p-66c1870a.js";function Di(t){t.code.add(Oi`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}`),t.code.add(Oi`const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`),t.code.add(Oi`const vec4 uninterpolatedRGBAToFloatFactors = vec4(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBAToFloat(vec4 rgba) {
return (dot(round(rgba * 255.0), uninterpolatedRGBAToFloatFactors) - 0.5) * 2.0;
}`)}class Ei extends Ce{constructor(t,e){super(t,"vec4",_i.Draw,((s,i,n)=>s.setUniform4fv(t,e(i,n))))}}let Gi=class extends i{constructor(t){super(t),this._removing=0,this._tiles=new n}destroy(){for(const t of this._tiles.values())t.remove();this._tiles.clear()}get updating(){if(this._removing>0)return!0;for(const t of this._tiles.values())if(!t.finished)return!0;return!1}async onTileTreeChange(t){const{added:e,removed:s}=t,i=this._tiles,n=[];for(const t of s){const e=i.get(t);null!=e&&(e.abort(),i.delete(t),n.push({tileId:t}))}for(const t of e)i.has(t.id)||i.set(t.id,r((e=>this._addTile(t,e))));await this._removeTiles(n)}async _addTile(t,e){const s=await this.addTile(t,e);return o(e),s}async _removeTiles(t){this._removing++,await this.removeTiles(t),this._removing--}};t([e()],Gi.prototype,"updating",null),t([e({constructOnly:!0})],Gi.prototype,"addTile",void 0),t([e({constructOnly:!0})],Gi.prototype,"removeTiles",void 0),t([e()],Gi.prototype,"_removing",void 0),Gi=t([s("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],Gi);class Vi{constructor(t,e){this._index=t,this._view=e}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(t){return this._view.getAttribute(this._index,t)}getAttributeAsTimestamp(t){return this._view.getAttributeAsTimestamp(this._index,t)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(t){return this._view.getCentroid(this._index,t)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(t){return new Ui(this._index,this._view,t)}}class Ui extends Vi{constructor(t,e,s){super(t,e),this._geometryOverride=s}getOptimizedGeometry(){return this._geometryOverride}getCentroid(t){return me(new ge,this._geometryOverride,t.hasZ,t.hasM)}}class Li{constructor(){this._storedTiles=new Map,this._pageBounds=new Map,this.events=new a,this.featureAdapter=Hi.shared}addTile(t){this._storedTiles.set(t.descriptor.id,t);for(const e of t.pages)this._addPage(e)}removeTile(t){const e=this._storedTiles,s=e.get(t);if(null!=s){e.delete(t);for(const t of s.pages)this._removePage(t)}}_addPage(t){const{featureCount:e}=t;if(0===e)return;const s=new fe(9,(e=>t.getBounds(e))),i=new Array;for(let t=0;t<e;++t)i[t]=t;s.load(i),this._pageBounds.set(t,s),this.events.emit("changed")}_removePage(t){this._pageBounds.delete(t),this.events.emit("changed")}clear(){this._storedTiles.clear(),this._pageBounds.clear(),this.events.emit("changed")}forEach(t){for(const[e,s]of this._pageBounds)s.all((s=>t(new Vi(s,e))))}forEachInBounds(t,e){Bi.minX=t[0],Bi.minY=t[1],Bi.maxX=t[2],Bi.maxY=t[3];for(const[t,s]of this._pageBounds)s.search(Bi,(s=>e(new Vi(s,t))))}forEachBounds(t,e){for(const s of t)e(s.getBoundingBox())}getFullExtent(t){let e=1/0,s=1/0,i=-1/0,n=-1/0;for(const t of this._pageBounds.values()){const{minX:r,minY:o,maxX:a,maxY:h}=t.toJSON();e=Math.min(e,r),s=Math.min(s,o),i=Math.min(i,a),n=Math.min(n,h)}return{xmin:e,ymin:s,xmax:i,ymax:n,spatialReference:t}}}class Hi{getObjectId(t){return t.getObjectId()}getAttribute(t,e){return t.getAttribute(e)}getAttributeAsTimestamp(t,e){return t.getAttributeAsTimestamp(e)}getAttributes(t){return t.getAttributes()}getGeometry(t){return t.getOptimizedGeometry()}getCentroid(t,e){return t.getCentroid(e)}cloneWithGeometry(t,e){return t.cloneWithGeometry(e)}}Hi.shared=new Hi;const Bi=new pe;class $i{constructor(t,e){this.descriptor=t,this.pages=e}}class ki{constructor(t){const e=new ve(new Uint8Array(t),new DataView(t));this._reader=e,this._index=Ni(e)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}getObjectId(t){return this.getAttribute(t,this._index.objectIdFieldName)}getAttribute(t,e){const{_index:{fieldsIndex:s,attributeIndices:i}}=this,n=s.get(e)?.index;if(null==n)return;const r=i[t*s.fields.length+n],o=this._reader;return o.move(r),Xi(o)}getAttributeAsTimestamp(t,e){const s=this.getAttribute(t,e);return"string"==typeof s?new Date(s).getTime():"number"==typeof s||null==s?s:null}getAttributes(t){const{_index:{fieldsIndex:e,attributeIndices:s}}=this,i=t*e.fields.length,n=this._reader,r={};for(const t of e.fields){const e=s[i+t.index];n.move(e),r[t.name]=Xi(n)}return r}getCoordinates(t,e,s=0){const i=this._reader,{transform:n,featureIndices:r}=this._index,{scale:o,translate:a}=n;i.move(r[t]),this._readCoordinates(o,a,e,s)}getOptimizedGeometry(t){const e=d();return this.getCoordinates(t,e),new ge([],e)}getCentroid(t,{hasZ:e,hasM:s}){this.getCoordinates(t,Qi);const[i,n,r]=Qi,o=[i,n];return e&&(o[3]=r),s&&(o[e?4:3]=0),new ge([],o)}getBounds(t){this.getCoordinates(t,Qi);const[e,s]=Qi,i=new pe;return i.minX=e,i.minY=s,i.maxX=e,i.maxY=s,i}getBoundingBox(t){this.getCoordinates(t,Qi);const[e,s,i]=Qi;return h(e,s,i,e,s,i)}readAllObjectIds(t,e=0){const s=this._reader,{_index:i,featureCount:n}=this,{objectIdFieldName:r,attributeIndices:o,fieldsIndex:a}=i,h=a.get(r).index,c=a.fields.length;for(let i=0;i<n;++i){const n=o[i*c+h];s.move(n),t[e++]=Xi(s)}return e}readAllCoordinates(t,e=0){const s=this._reader,{transform:i,featureIndices:n}=this._index,{scale:r,translate:o}=i;for(const i of n)s.move(i),e=this._readCoordinates(r,o,t,e);return e}_readCoordinates([t,e,s],[i,n,r],o,a){const h=2,c=3,l=this._reader,u=l.getLength(),d=l.pos()+u;for(;l.pos()<d&&l.next();)switch(l.tag()){case h:{const h=l.getLength(),u=l.pos()+h;for(;l.pos()<u&&l.next();)if(l.tag()===c)l.getUInt32(),o[a++]=i+t*l.getSInt64(),o[a++]=n+e*l.getSInt64(),o[a++]=r+s*l.getSInt64();else l.skip();break}default:l.skip()}return a}}function Ni(t){const e=2;for(;t.next();){if(t.tag()===e)return qi(t.getMessage());t.skip()}Wi()}function qi(t){const e=1;for(;t.next();){if(t.tag()===e)return Yi(t.getMessage());t.skip()}Wi()}function Yi(t){const e=9,s=12,i=13,n=15,r=7,o=0,a=10,h=1,u=1;let d,f,p=!1,m=!1,g=0;const w=new Array,v=new Array,y=new Array;for(;t.next();)switch(t.tag()){case u:f=t.getString();break;case r:t.getEnum()!==o&&Wi();break;case e:p=t.getBool()??!1;break;case s:d=c(t.processMessage(xe));break;case i:{const e=t.processMessage(ye);e.index=g++,w.push(e);break}case n:{v.push(t.pos());const e=t.getUInt32(),s=t.pos()+e;for(;t.pos()<s&&t.next();)if(t.tag()===h)y.push(t.pos()),t.skip();else t.skip();break}case a:m=t.getBool()??!1;break;default:t.skip()}const x=new l(w);return null!=d&&m&&null!=f&&x.has(f)||Wi(),{transform:d,exceededTransferLimit:p,fieldsIndex:x,objectIdFieldName:f,featureIndices:v,attributeIndices:y}}function Wi(){const t=new u("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(t),t}function Xi(t){const e=1,s=2,i=3,n=4,r=5,o=6,a=7,h=8,c=9,l=t.getLength(),u=t.pos()+l;for(;t.pos()<u&&t.next();)switch(t.tag()){case e:return t.getString();case s:return t.getFloat();case i:return t.getDouble();case n:return t.getSInt32();case r:return t.getUInt32();case o:return t.getInt64();case a:return t.getUInt64();case h:return t.getSInt64();case c:return t.getBool();default:return t.skip(),null}return null}const Qi=d();const Ji=8e3,Zi=4,Ki=4;class tn{constructor(t,e,s,i,n){this.spatialReference=t,this.url=s,this.objectIdField=i,this.capabilities=n;const{supportsMaxRecordCountFactor:r,maxRecordCount:o}=this.capabilities.query,a=r?Zi:1,h=(o??Ji)*a;this._pageSize=Math.min(Ji,h);const c=e.clone();c.cacheHint=!0,c.resultType="tile",c.outSpatialReference=t,c.returnGeometry=!0,c.returnZ=!0,c.maxRecordCountFactor=a,c.num=this._pageSize,c.outFields=[i],this._baseQuery=c}async fetch(t,e){const{spatialReference:s}=this,i=f(t.extent,s),n=this._baseQuery.clone();n.geometry=i;const r=new Array;let a=0,h=!1,c=1;for(;!h;){const t=[];for(let s=0;s<c;++s)t.push(this._fetchPage(n,a++,e));const s=await Promise.all(t);o(e);for(const t of s){const e=0!==t.featureCount;h||=!t.exceededTransferLimit||!e,e&&r.push(t)}c=Math.min(c+1,Ki)}return new $i(t,r)}async _fetchPage(t,e,s){const i=t.clone();i.start=e*this._pageSize;const n=(await we(this.url,i,{signal:s})).data;return o(s),new ki(n)}}var en;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(en||(en={}));Object.freeze({left:0,center:.5,right:1});const sn=Object.freeze({"bottom-left":p(0,0),bottom:p(.5,0),"bottom-right":p(1,0),left:p(0,.5),center:p(.5,.5),right:p(1,.5),"top-left":p(0,1),top:p(.5,1),"top-right":p(1,1)});const nn={required:[]};class rn extends i{precompile(t){const e=this.acquireTechniques(t);return hn(e),null!=e}consumes(){return nn}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(t){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(t){}queryRenderOccludedState(t){return!1}}class on extends rn{}class an extends rn{}function hn(t){Array.isArray(t)?t.forEach((t=>t?.release())):t?.release()}class cn{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}dispose(){this._map.forEach(((t,e)=>{null!=t&&this._repository.release(this._material,e)}))}load(t,e,s){const i=this._material.produces.get(e);if(!i?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,e,s));const n=this._map.get(s);if(null!=n){if(n.ensureResources(t)===Is.LOADED)return n;this._repository.requestRender()}return null}}class ln extends Ae{constructor(t=d()){super(),this.origin=t}get slicePlaneLocalOrigin(){return this.origin}}var un,dn;!function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"}(un||(un={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(dn||(dn={}));class fn{constructor(t=0,e=0){this.from=t,this.to=e}get numElements(){return this.to-this.from}}function pn(t){const e=new Map;t.forAll((t=>e.set(t.from,t)));let s=!0;for(;s;){s=!1;for(let i=0;i<t.length;++i){const n=t.data[i],r=e.get(n.to);if(!r)return;n.to=r.to,e.delete(r.from),t.removeUnordered(r),s=!0}}}class mn extends fn{constructor(t,e,s){super(e,s),this.geometry=t}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(t){this.isVisible&&this.geometry.foreachHighlightGroup(t)}get hasOccludees(){return null!=this.geometry.occludees}}class gn{constructor(){this.first=0,this.count=0}}class wn{constructor(){this._numElements=0,this._instances=new Map,this.holes=new m({allocator:t=>t||new fn,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=yn(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=yn(),this.drawCommandsShadowHighlightRest=yn()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const t of this.instances.values())this.updateDrawState(t);this.updateDrawCommands(t)}}addInstance(t,e){this.deleteInstance(t),this._instances.set(t,e),this._numElements+=e.numElements}deleteInstance(t){const e=this._instances.get(t);e&&(this._numElements-=e.numElements,this._instances.delete(t))}updateInstance(t,e,s){const i=this._instances.get(t);i&&(this._numElements-=i.numElements,i.from=e,i.to=s,this._numElements+=i.numElements)}updateDrawState(t){t.isVisible?(t.foreachHighlightGroup((t=>this.highlightGroups.add(t))),t.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(t){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const e=this.drawCommandsDefault.pushNew(),s=this.holes.front();return null!=this.vao&&1===this.holes.length&&s.to===Math.floor(this.vao.byteSize/t)?(e.first=0,void(e.count=s.from)):(e.first=1/0,e.count=0,this._instances.forEach((t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)})),void(e.count-=e.first))}const e=Array.from(this._instances.values()).sort(((t,e)=>t.from===e.from?t.to-e.to:t.from-e.from)),{drawCommandsHighlights:s}=this;for(const t of e)t.isVisible&&(xn(t.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,t),t.hasHighlights?t.foreachHighlightGroup((e=>{let i=s.get(e);i||(i=yn(),s.set(e,i)),xn(i,t)})):xn(this.drawCommandsShadowHighlightRest,t))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function vn(t){return null!=t.vao}function yn(){return new m({allocator:t=>t||new gn,deallocator:t=>t})}function xn(t,e){const s=t.back();if(null==s){const s=t.pushNew();return s.first=e.from,void(s.count=e.numElements)}if(bn(s,e)){const t=e.from-s.first+e.numElements;s.count=t}else{const s=t.pushNew();s.first=e.from,s.count=e.numElements}}function bn(t,e){return t.first+t.count>=e.from}class Mn{constructor(t){this.origin=t,this.buffers=new Array}dispose(){this.buffers.forEach((t=>t.vao.dispose())),this.buffers.length=0}findBuffer(t){return this.buffers.find((e=>e.instances.has(t)))}}let Cn=class extends on{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(t){super(t),this._dataByOrigin=new Map,this._drawParameters=new ln,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=g(this._glMaterials),this._dataByOrigin.forEach((t=>t.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach(((t,e)=>{this._produces.set(e,(e=>!(0===this._dataByOrigin.size||!(e!==Rs.Highlight&&e!==Rs.ShadowHighlight||this._hasAnyHighlight))&&t(e)))}))}initializeRenderContext(t,e){this._glMaterials=new cn(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,Ts(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get numGeometries(){let t=0;return this._dataByOrigin.forEach((e=>t+=e.buffers.reduce(((t,e)=>t+e.instances.size),0))),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach((e=>t+=e.buffers.reduce(((t,e)=>t+e.vao.usedMemory),0))),t}forEachGeometry(t){this._dataByOrigin.forEach((e=>e.buffers.forEach((e=>e.instances.forEach((({geometry:e})=>t(e)))))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){const e=this._bufferWriter;if(null==e)return;const s=e.vertexBufferLayout.stride/4;for(const i of t){const t=i.renderGeometry,n=this._dataByOrigin.get(t.localOrigin.id),r=n?.findBuffer(t.id);if(null==r)return;const o=r.instances.get(t.id);if(i.updateType&(dn.GEOMETRY|dn.TRANSFORMATION)){const i=Dn(e.elementCount(o.geometry.geometry.attributes)*s),n=e.vertexBufferLayout.createView(i.buffer);this._writeGeometry(t,n,0),r.vao.vertexBuffers.get("geometry").setSubData(i,o.from*s,0,o.numElements*s)}i.updateType&(dn.HIGHLIGHT|dn.OCCLUDEE|dn.VISIBILITY)&&(r.drawCommandsDirty=!0)}}_computeDeltas(t,e){const s=new zs;for(const e of t){const t=e.localOrigin;if(null==t)continue;let i=s.get(t.id,null);null==i&&(i=new An(t.vec3),s.set(t.id,null,i)),i.changes.push(e)}for(const t of e){const e=t.localOrigin;if(null==e)continue;const i=this._dataByOrigin.get(e.id),n=i?.findBuffer(t.id);if(null==n)continue;let r=s.get(e.id,n);null==r&&(r=new An(e.vec3),s.set(e.id,n,r)),r.changes.push(t)}return s}_addAndRemoveGeometries(t,e){if(null==this._bufferWriter||null==this._vaoCache)return;const{_bufferWriter:s,_dataByOrigin:i}=this,n=s.vertexBufferLayout.stride/4,r=this._computeDeltas(t,e);r.forEach(((t,e)=>{const o=t.get(null),a=o?.changes??[];r.delete(e,null);let h=i.get(e);if(t.forEach(((t,o)=>{if(r.delete(e,o),null==o)return void Gs(!1,"No VAO for removed geometries");if(o.instances.size===t.changes.length)return this._vaoCache.deleteVao(o.vao),w(h.buffers,o),void(0===h.buffers.length&&0===a.length&&i.delete(e));const c=o.numElements,l=o.vao.byteSize/4,u=a.reduce(((t,e)=>t+s.elementCount(e.geometry.attributes)),0),d=t.changes.reduce(((t,e)=>t+s.elementCount(e.geometry.attributes)),0),f=Math.min((c+u-d)*n,Fn),p=f>l;f>Tn&&f<l/2?(t.changes.forEach((({id:t})=>o.deleteInstance(t))),o.instances.forEach((({geometry:t})=>a.push(t))),this._vaoCache.deleteVao(o.vao),w(h.buffers,o)):p?this._applyAndRebuild(o,a,t):this._applyRemoves(o,t)})),a.length>0)for(null==h&&(h=new Mn(o.origin),i.set(e,h)),h.buffers.forEach((t=>this._applyAdds(t,a)));a.length>0;)h.buffers.push(this._applyAndRebuild(new wn,a,null))}))}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),t.hasHighlights&&v(this._highlightGroups,t.highlightGroups),this._hasOccludees=this._hasOccludees||t.hasOccludees}))}))}_applyAndRebuild(t,e,s){if(s)for(const e of s.changes)t.deleteInstance(e.id);const i=this._bufferWriter,n=i.vertexBufferLayout.stride,r=n/4,o=Math.floor(Fn/r);let a=t.numElements;for(;e.length>0;){const s=e.pop(),n=i.elementCount(s.geometry.attributes);if(a+n>o&&a>0){e.push(s);break}a+=n;const r=new mn(s,0,0);Gs(null==t.instances.get(s.id)),t.addInstance(s.id,r)}const h=a*r,c=Dn(h),l=i.vertexBufferLayout.createView(c.buffer);let u=0;t.resetInstanceSummary(),t.instances.forEach(((e,s)=>{this._writeGeometry(e.geometry,l,u);const n=u;u+=i.elementCount(e.geometry.geometry.attributes),t.updateInstance(s,n,u),t.updateDrawState(e)})),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(En(h)),t.vao.vertexBuffers.get("geometry").setSubData(c,0,0,u*r),t.holes.clear();const d=t.holes.pushNew();return d.from=u,d.to=Math.floor(t.vao.byteSize/n),t.updateDrawCommands(n),t}_applyRemoves(t,e){if(0===e.changes.length||null==this._bufferWriter)return;for(const s of e.changes){const e=s.id,i=t.instances.get(e);if(!i)continue;t.deleteInstance(e);const n=Pn.back();if(n){if(n.to===i.from){n.to=i.to;continue}if(n.from===i.to){n.from=i.from;continue}}const r=Pn.pushNew();r.from=i.from,r.to=i.to}pn(Pn);const s=this._bufferWriter.vertexBufferLayout.stride/4,i=Pn.reduce(((t,e)=>Math.max(t,e.numElements)),0)*s,n=Dn(i);n.fill(0,0,i);const r=t.vao.vertexBuffers.get("geometry");Pn.forAll((t=>r.setSubData(n,t.from*s,0,t.numElements*s))),t.holes.pushArray(Pn.data,Pn.length),Pn.forAll(((t,e)=>Pn.data[e]=null)),Pn.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(0===e.length||null==this._bufferWriter)return;if(!vn(t))return void this._applyAndRebuild(t,e,null);const s=this._bufferWriter,i=s.vertexBufferLayout.stride/4,n=t.numElements,r=e.reduce(((t,e)=>t+s.elementCount(e.geometry.attributes)),0),o=Math.min((n+r)*i,Fn),a=4*o;if(t.vao.byteSize<En(Fn-Tn)&&a>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);pn(t.holes);const h=new Array;for(const i of e){const e=s.elementCount(i.geometry.attributes),n=On(t.holes,e);h.push(n)}const c=t.vao.vertexBuffers.get("geometry");let l=0,u=0,d=0;const f=Dn(o),p=s.vertexBufferLayout.createView(f.buffer);e.forEach(((e,n)=>{const r=h[n];if(null==r)return;if(!(d===r)){const t=d-u;t>0&&c.setSubData(f,u*i,0,t*i),u=r,l=0}const o=s.elementCount(e.geometry.attributes);this._writeGeometry(e,p,l),l+=o,d=r+o;const a=new mn(e,r,r+o);Gs(null==t.instances.get(e.id)),t.addInstance(e.id,a),t.drawCommandsDirty=!0}));const m=d-u;m>0&&c.setSubData(f,u*i,0,m*i),x(e,((t,e)=>null==h[e]))}_writeGeometry(t,e,s){null!=this._bufferWriter&&(b(Sn,t.transformation),Sn[12]-=t.localOrigin.vec3[0],Sn[13]-=t.localOrigin.vec3[1],Sn[14]-=t.localOrigin.vec3[2],M(_n,Sn),C(_n,_n),this._bufferWriter.write(Sn,_n,t.geometry.attributes,t.geometry.objectAndLayerIdColor,e,s))}updateAnimation(t){return this.material.update(t)}acquireTechniques(t){if(!this.material.shouldRender(t))return null;const{output:e,bind:s}=t,i=this.material.produces.get(s.slot);if(!i?.(e))return null;const{highlightGroupName:n,slot:r}=s,o=e===Rs.ShadowHighlight,a=e===Rs.Highlight,h=a||o,c=t=>h&&(0===this._highlightGroups.size||a&&!!n&&!t.has(n));if(c(this._highlightGroups))return null;const l=e===Rs.ShadowExcludeHighlight,u=!(h||l);for(const{buffers:i}of this._dataByOrigin.values())for(const a of i){if(c(a.highlightGroups))continue;const i=o?a.drawCommandsHighlights.size>0:h?n?a.drawCommandsHighlights.get(n):a.drawCommandsHighlights.size>0:((l&&a.needsMultipleCommands()?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault)||null)?.length??!1,d=u&&a.drawCommandsOccludees||null;if(i||d?.length){const i=this._glMaterials.load(t.rctx,r,e),n=i?.beginSlot(s);if(n)return n}}return null}render(t,e){const{output:s,bind:i}=t,{slot:n,highlightGroupName:r}=i,o=s===Rs.Highlight;if(o&&!r)return;const a=s===Rs.ShadowHighlight,h=o||a,c=s===Rs.ShadowExcludeHighlight,l=!(h||c),u=n===Oe.OCCLUDER_MATERIAL||n===Oe.TRANSPARENT_OCCLUDER_MATERIAL?n:null,{rctx:d}=t;d.runAppleAmdDriverHelper();const f=d.bindTechnique(e,i,this.material.parameters);for(const t of this._dataByOrigin.values())for(const s of t.buffers){if(o&&(!s.hasHighlights||!s.drawCommandsHighlights.has(r)))continue;if(a&&!s.hasHighlights)continue;const n=()=>{const t=[];for(const e of s.drawCommandsHighlights.values())t.push(e);return t},p=h&&!a?s.drawCommandsHighlights.get(r)??null:null,m=a?n():h?p?[p]:Gn:(c&&s.needsMultipleCommands()?[s.drawCommandsShadowHighlightRest]:[s.drawCommandsDefault])||Gn,g=m.some((t=>t.length>0)),w=l&&s.drawCommandsOccludees||null;if(g||w?.length){if(this._drawParameters.origin=t.origin,f.bindDraw(i,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(s.vao),d.bindVAO(s.vao),g)for(const t of m)d.setPipelineState(e.getPipeline(!1,u)),t.forAll((t=>d.drawArrays(e.primitiveType,t.first,t.count)));w?.length&&(d.setPipelineState(e.getPipeline(!0,u)),w.forAll((t=>d.drawArrays(e.primitiveType,t.first,t.count))))}}}get test(){}};t([e({constructOnly:!0})],Cn.prototype,"material",void 0),Cn=t([s("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Cn);class An{constructor(t){this.origin=t,this.changes=new Array}}function On(t,e){const s=t.find((t=>t.numElements>=e));if(null==s)return null;const i=s.from;return s.from+=e,s.from>=s.to&&t.removeUnordered(s),i}const Sn=Ds(),_n=Ds(),Pn=new m({allocator:t=>t||new fn,deallocator:null}),Tn=65536,Rn=4*Tn,jn=1024,In=16777216,Fn=In/4;let zn=new Float32Array(Tn);function Dn(t){return zn.length<t&&(zn=new Float32Array(t)),zn}function En(t){const e=4*t;return e<=jn?jn:e<Rn?y(e):Math.max(Math.min(Math.ceil(1.5*e/Rn)*Rn,In),e)}const Gn=[];let Vn=class extends on{constructor(t){super(t),this._hasHighlights=!1,this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new ln,this._bufferWriter=null}get produces(){return this._produces}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach(((t,e)=>{this._produces.set(e,(e=>!!(e!==Rs.Highlight&&e!==Rs.ShadowHighlight||this._hasHighlights)&&t(e)))}))}destroy(){this._glMaterials.dispose();const t=this._renderGeometries.keys();for(const e of t)this.removeRenderGeometry(e)}acquireTechniques(t){const e=this.material;if(!e.shouldRender(t))return null;const{output:s,bind:i}=t,n=e.produces.get(i.slot);if(!n?.(s))return null;if((s===Rs.Highlight||s===Rs.ShadowHighlight)&&!this._hasHighlights)return null;const r=this._glMaterials.load(t.rctx,i.slot,s);return r?.beginSlot(i)}render(t,e){const s=this._renderGeometries;if(0===s.size)return;const{bind:i}=t,n=i.slot===Oe.OCCLUDER_MATERIAL||i.slot===Oe.TRANSPARENT_OCCLUDER_MATERIAL?i.slot:null,r=t.rctx;r.runAppleAmdDriverHelper(),r.bindTechnique(e,i,this.material.parameters);const o=e.program;for(const[t,a]of s)this._drawParameters.origin=a.localOrigin,o.bindDraw(i,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(a.vao),r.bindVAO(a.vao),r.setPipelineState(e.getPipeline(!1,n)),r.drawArrays(e.primitiveType,0,a.numElements)}initializeRenderContext(t,e){this._glMaterials=new cn(this.material,t.materials);const s=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,Ts(this._bufferWriter.vertexBufferLayout));this._vaoCache=s}uninitializeRenderContext(){}addRenderGeometry(t,e,s){this.removeRenderGeometry(t);const i=this._bufferWriter.vertexBufferLayout.stride,n=this._vaoCache.newVao(En(e.data.byteLength));n.vertexBuffers.get("geometry").setSubData(new Uint8Array(e.data),0,0,e.elementCount*i);const r={localOrigin:s,vao:n,numElements:e.elementCount};return this._renderGeometries.set(t,r),r}removeRenderGeometry(t){const e=this._renderGeometries.get(t);null!=e&&(this._vaoCache.deleteVao(e.vao),this._renderGeometries.delete(t))}};t([e({constructOnly:!0})],Vn.prototype,"material",void 0),Vn=t([s("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],Vn);function Un(t,e,s){return 2*Math.atan(Math.sqrt(e*e+s*s)*Math.tan(.5*t)/e)}function Ln(t,e,s){return 2*Math.atan(Math.sqrt(e*e+s*s)*Math.tan(.5*t)/s)}function Hn(t,e,s){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+s*s))}function Bn(t,e,s){return 2*Math.atan(s*Math.tan(.5*t)/Math.sqrt(e*e+s*s))}var $n,kn;!function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"}($n||($n={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(kn||(kn={}));var Nn;let qn=Nn=class extends i{constructor(t){super(t),this._ray=ks(),this._viewport=A(0,0,1,1),this._padding=A(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=p(1,1e3),this._viewDirty=!0,this._viewMatrix=Ds(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Ds(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Ds(),this._frustumDirty=!0,this._frustum=Ls(),this._fullViewport=O(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=d(),this._up=d(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return S(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){b(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),_(d(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),_(d(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),_(d(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const t=P(O(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&T(t,e)?e:t}get screenPadding(){if(1===this.pixelRatio)return this._padding;const t=P(O(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&T(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[kn.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[kn.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[kn.RIGHT]+this._padding[kn.LEFT]}set fullWidth(t){this.width=t-(this._padding[kn.RIGHT]+this._padding[kn.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[kn.TOP]+this._padding[kn.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[kn.TOP]+this._padding[kn.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[kn.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[kn.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){R(this._padding,t)||(this._viewport[0]+=t[kn.LEFT]-this._padding[kn.LEFT],this._viewport[1]+=t[kn.BOTTOM]-this._padding[kn.BOTTOM],this._viewport[2]-=t[kn.RIGHT]+t[kn.LEFT]-(this._padding[kn.RIGHT]+this._padding[kn.LEFT]),this._viewport[3]-=t[kn.TOP]+t[kn.BOTTOM]-(this._padding[kn.TOP]+this._padding[kn.BOTTOM]),j(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(I(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return M(Ds(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||Ds()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Hn(this._fov,this.width,this.height)}set fovX(t){this._fov=Un(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Bn(this._fov,this.width,this.height)}set fovY(t){this._fov=Ln(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return F(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(M(this._viewInverseTransposeMatrix,this.viewMatrix),C(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,s=this.near*Math.tan(this.fovY/2)*2,i=s*this._aspect,n=s/this.rows,r=i/this.columns,o=-i/2+this.column*r,a=o+r,h=-s/2+this.row*n,c=h+n,l=z(Ds(),o*(1+2*this._padding[kn.LEFT]/t),a*(1+2*this._padding[kn.RIGHT]/t),h*(1+2*this._padding[kn.BOTTOM]/e),c*(1+2*this._padding[kn.TOP]/e),this.near,this.far),u=this._get("projectionMatrix");return u&&D(u,l)?u:l}copyFrom(t){E(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,j(this._viewport,t.viewport),this.notifyChange("_viewport"),j(this._padding,t.padding),this.notifyChange("_padding"),G(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(b(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(Hs(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(b(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),j(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up,this.fov=t.fov}clone(){return(new Nn).copyFrom(this)}equals(t){return V(this.eye,t.eye)&&V(this.center,t.center)&&V(this.up,t.up)&&R(this._viewport,t.viewport)&&R(this._padding,t.padding)&&U(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||L(t.screenPadding,this.screenPadding)>=e||L(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;H(Qn,t.eye,t.center),H(Jn,this.eye,this.center);const s=W(Qn,Jn),i=st(Qn),n=st(Jn),r=5e-4;return s*s>=(1-1e-10)*i*n&&B(t.eye,this.eye)<Math.max(i,n)*r*r}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(Js(this.viewForward,S(Qn,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=$()){return t[0]=(this.padding[kn.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[kn.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,s=.5){return t[0]=this.padding[kn.LEFT]+this.width*e,t[1]=this.padding[kn.BOTTOM]+this.height*s,t[2]=.5,t}setGLViewport(t){const e=this.viewport,s=this.padding;t.setViewport(e[0]-s[3],e[1]-s[2],e[2]+s[1]+s[3],e[3]+s[0]+s[2])}applyProjection(t,e){t!==Wn&&E(Wn,t),Wn[3]=1,k(Wn,Wn,this.projectionMatrix);const s=Math.abs(Wn[3]);N(Wn,Wn,1/s);const i=this.fullViewport;e[0]=q(0,i[0]+i[2],.5+.5*Wn[0]),e[1]=q(0,i[1]+i[3],.5+.5*Wn[1]),e[2]=.5*(Wn[2]+1),e[3]=s}unapplyProjection(t,e){const s=this.fullViewport;Wn[0]=(t[0]/(s[0]+s[2])*2-1)*t[3],Wn[1]=(t[1]/(s[1]+s[3])*2-1)*t[3],Wn[2]=(2*t[2]-1)*t[3],Wn[3]=t[3],null!=this.inverseProjectionMatrix&&(k(Wn,Wn,this.inverseProjectionMatrix),e[0]=Wn[0],e[1]=Wn[1],e[2]=Wn[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,Zn),this.renderToScreen(Zn,e),e}projectToRenderScreen(t,e){if(Wn[0]=t[0],Wn[1]=t[1],Wn[2]=t[2],Wn[3]=1,k(Wn,Wn,this.viewProjectionMatrix),0===Wn[3])return null;const s=Wn;N(s,s,1/Math.abs(Wn[3]));const i=this.fullViewport,n=q(0,i[0]+i[2],.5+.5*s[0]),r=q(0,i[1]+i[3],.5+.5*s[1]);return"x"in e?(e.x=n,e.y=r):(e[0]=n,e[1]=r,e.length>2&&(e[2]=.5*(s[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,Zn),e)}unprojectFromRenderScreen(t,e){if(I(Xn,this.projectionMatrix,this.viewMatrix),!M(Xn,Xn))return null;const s=this.fullViewport;return Wn[0]=2*(t[0]-s[0])/s[2]-1,Wn[1]=2*(t[1]-s[1])/s[3]-1,Wn[2]=2*t[2]-1,Wn[3]=1,k(Wn,Wn,Xn),0===Wn[3]?null:(e[0]=Wn[0]/Wn[3],e[1]=Wn[1]/Wn[3],e[2]=Wn[2]/Wn[3],e)}constrainWindowSize(t,e,s,i){const n=t*this.pixelRatio,r=e*this.pixelRatio,o=Math.max(n-s/2,0),a=Math.max(this.fullHeight-r-i/2,0),h=-Math.min(n-s/2,0),c=-Math.min(this.fullHeight-r-i/2,0),l=s-h- -Math.min(this.fullWidth-n-s/2,0),u=i-c- -Math.min(r-i/2,0);return[Math.round(o),Math.round(a),Math.round(l),Math.round(u)]}computeUp(t){t===Y.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const s=t[0]*this.pixelRatio,i=this.fullHeight-t[1]*this.pixelRatio;return e[0]=s,e[1]=i,e}renderToScreen(t,e){const s=t[0]/this.pixelRatio,i=(this.fullHeight-t[1])/this.pixelRatio;e[0]=s,e[1]=i}_computeUpGlobal(){S(Qn,this.center,this.eye);const t=X(this.center);t<1?(_(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(W(Qn,this.center))>.9999*X(Qn)*t||(Q(this._up,Qn,this.center),Q(this._up,this._up,Qn),J(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){Z(Qn,this.eye,this.center),Math.abs(Qn[2])<=.9999&&(N(Qn,Qn,Qn[2]),_(this._up,-Qn[0],-Qn[1],1-Qn[2]),J(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,s=""){"number"==typeof t[0]&&isFinite(t[0])&&"number"==typeof t[1]&&isFinite(t[1])&&"number"==typeof t[2]&&isFinite(t[2])?V(t,e)||(E(e,t),this._markViewDirty(),s.length&&this.notifyChange(s)):K.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Bs(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(tt(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};t([e()],qn.prototype,"_viewport",void 0),t([e()],qn.prototype,"_padding",void 0),t([e()],qn.prototype,"_fov",void 0),t([e()],qn.prototype,"_nearFar",void 0),t([e()],qn.prototype,"_viewDirty",void 0),t([e()],qn.prototype,"_viewMatrix",void 0),t([e()],qn.prototype,"_pixelRatio",void 0),t([e()],qn.prototype,"pixelRatio",null),t([e()],qn.prototype,"row",void 0),t([e()],qn.prototype,"column",void 0),t([e()],qn.prototype,"_rows",void 0),t([e()],qn.prototype,"rows",null),t([e()],qn.prototype,"_columns",void 0),t([e()],qn.prototype,"columns",null),t([e()],qn.prototype,"eye",null),t([e()],qn.prototype,"center",null),t([e()],qn.prototype,"_center",void 0),t([e()],qn.prototype,"up",null),t([e()],qn.prototype,"_up",void 0),t([e()],qn.prototype,"viewMatrix",null),t([e({readOnly:!0})],qn.prototype,"viewForward",null),t([e({readOnly:!0})],qn.prototype,"viewUp",null),t([e({readOnly:!0})],qn.prototype,"viewRight",null),t([e({readOnly:!0})],qn.prototype,"nearFar",null),t([e()],qn.prototype,"near",null),t([e()],qn.prototype,"far",null),t([e()],qn.prototype,"viewport",null),t([e({readOnly:!0})],qn.prototype,"screenViewport",null),t([e({readOnly:!0})],qn.prototype,"screenPadding",null),t([e()],qn.prototype,"x",null),t([e()],qn.prototype,"y",null),t([e()],qn.prototype,"width",null),t([e()],qn.prototype,"height",null),t([e()],qn.prototype,"fullWidth",null),t([e()],qn.prototype,"fullHeight",null),t([e({readOnly:!0})],qn.prototype,"_aspect",null),t([e()],qn.prototype,"padding",null),t([e({readOnly:!0})],qn.prototype,"projectionMatrix",null),t([e({readOnly:!0})],qn.prototype,"inverseProjectionMatrix",null),t([e()],qn.prototype,"fov",null),t([e()],qn.prototype,"fovX",null),t([e()],qn.prototype,"fovY",null),t([e()],qn.prototype,"viewInverseTransposeMatrix",null),t([e({readOnly:!0})],qn.prototype,"_projectionMatrixInternal",null),t([e()],qn.prototype,"relativeElevation",void 0),qn=Nn=t([s("esri.views.3d.webgl.RenderCamera")],qn);const Yn=qn,Wn=O(),Xn=Ds(),Qn=d(),Jn=d(),Zn=et();class Kn{constructor(t,e,s){this._elementSize=e,this._buffer=mi.createVertex(t,it.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(t,e,s,i=0){const n=new Uint8Array(this.array,t*this.elementSize,(e-t)*this.elementSize);new Uint8Array(s.array,i*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(t,e){const s=t*this._elementSize,i=e*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),s,s,i)}resize(t){const e=t*this._elementSize,s=new ArrayBuffer(e);this._array&&(t>=this._capacity?new Uint8Array(s).set(new Uint8Array(this._array)):new Uint8Array(s).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=s,this._buffer.setSize(e),this._capacity=t}}class tr{constructor(t){this.modelOriginHi=t.getField(Vs.INSTANCEMODELORIGINHI,oi),this.modelOriginLo=t.getField(Vs.INSTANCEMODELORIGINLO,oi),this.model=t.getField(Vs.INSTANCEMODEL,ai),this.modelNormal=t.getField(Vs.INSTANCEMODELNORMAL,ai),this.featureAttribute=t.getField(Vs.INSTANCEFEATUREATTRIBUTE,hi),this.color=t.getField(Vs.INSTANCECOLOR,ci),this.objectAndLayerIdColor=t.getField(Vs.INSTANCEOBJECTANDLAYERIDCOLOR,ci)}}class er{constructor(t,e){this._rctx=t,this._instanceBufferLayout=e,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,e=this._tailIndex;return t>=e?t-e:t+this._capacity-e}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){Gs(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Gs(this._updating,"not updating"),this.size<nt*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Gs(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),Gs(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){Gs(this._updating,"not updating"),Gs(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(sr,Math.floor(this._capacity*rt));this._resize(t)}_shrink(){const t=Math.max(sr,Math.floor(this._capacity*ot));this._resize(t)}_resize(t){if(Gs(this._updating,"not updating"),t===this._capacity)return;const e=new Kn(this._rctx,this._instanceBufferLayout.stride,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,s=this._compactInstances(e);Gs(s===t,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=e,this._view=new tr(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const e=this._headIndex,s=this._tailIndex;return s<e?(this._buffer.copyRange(s,e,t),e-s):s>e?(this._buffer.copyRange(s,this._capacity,t),e>0&&this._buffer.copyRange(0,e,t,this._capacity-s),e+(this._capacity-s)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,e){t<e?this._buffer.transferRange(t,e):t>e&&(e>0&&this._buffer.transferRange(0,e),this._buffer.transferRange(t,this._capacity))}}const sr=64;var ir;function nr(t){let e=Us().mat4f64(Vs.LOCALTRANSFORM).mat4f64(Vs.GLOBALTRANSFORM).vec4f64(Vs.BOUNDINGSPHERE).vec3f64(Vs.MODELORIGIN).mat3f(Vs.INSTANCEMODEL).mat3f(Vs.INSTANCEMODELNORMAL).vec2f(Vs.MODELSCALEFACTORS);return t.includes(Vs.FEATUREATTRIBUTE)&&(e=e.vec4f(Vs.FEATUREATTRIBUTE)),t.includes(Vs.COLOR)&&(e=e.vec4u8(Vs.COLOR)),t.includes(Vs.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(Vs.OBJECTANDLAYERIDCOLOR)),e=e.u8(Vs.STATE).u8(Vs.LODLEVEL),e}!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"}(ir||(ir={}));class rr{constructor(t){this.localTransform=t.getField(Vs.LOCALTRANSFORM,li),this.globalTransform=t.getField(Vs.GLOBALTRANSFORM,li),this.modelOrigin=t.getField(Vs.MODELORIGIN,ui),this.model=t.getField(Vs.INSTANCEMODEL,ai),this.modelNormal=t.getField(Vs.INSTANCEMODELNORMAL,ai),this.modelScaleFactors=t.getField(Vs.MODELSCALEFACTORS,di),this.boundingSphere=t.getField(Vs.BOUNDINGSPHERE,fi),this.featureAttribute=t.getField(Vs.FEATUREATTRIBUTE,hi),this.color=t.getField(Vs.COLOR,ci),this.objectAndLayerIdColor=t.getField(Vs.OBJECTANDLAYERIDCOLOR,ci),this.state=t.getField(Vs.STATE,pi),this.lodLevel=t.getField(Vs.LODLEVEL,pi)}}let or=class extends i{constructor(t,e){super(t),this.events=new a,this._capacity=0,this._size=0,this._next=0,this._highlightGroupMap=new Map,this._highlightGroupMapPrev=new Map,this._layout=nr(e),this._capacity=sr,this._buffer=this._layout.createBuffer(this._capacity),this._view=new rr(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,ir.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){const e=this._view.state;Gs(t>=0&&t<this._capacity&&!!(e.get(t)&ir.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,ir.ACTIVE)?this._setStateFlags(t,ir.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){const e=this._view.state;Gs(t>=0&&t<this._capacity&&!!(e.get(t)&ir.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,s=hr,i=cr;e.localTransform.getMat(t,lr),e.globalTransform.getMat(t,ur);const n=I(ur,ur,lr);_(s,n[12],n[13],n[14]),e.modelOrigin.setVec(t,s),at(i,n),e.model.setMat(t,i);const r=Zs(hr,n);r.sort(),e.modelScaleFactors.set(t,0,r[1]),e.modelScaleFactors.set(t,1,r[2]),ht(i,i),ct(i,i),e.modelNormal.setMat(t,i),this._setStateFlags(t,ir.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const s=this._view;s.model.getMat(t,cr),s.modelOrigin.getVec(t,hr),e[0]=cr[0],e[1]=cr[1],e[2]=cr[2],e[3]=0,e[4]=cr[3],e[5]=cr[4],e[6]=cr[5],e[7]=0,e[8]=cr[6],e[9]=cr[7],e[10]=cr[8],e[11]=0,e[12]=hr[0],e[13]=hr[1],e[14]=hr[2],e[15]=1}applyShaderTransformation(t,e){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(hr,this,t),e*=Math.max(hr[0],hr[1],hr[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(hr,this,t),e*=ar(hr[0],hr[1],hr[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,ir.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,ir.VISIBLE)}setHighlight(t,e,s){let i=this._highlightGroupMap.get(t);e?(i||(i=new Set,this._highlightGroupMap.set(t,i)),i.add(s)&&(this._setStateFlag(t,ir.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed"))):i?.delete(s)&&(0===i.size&&(this._highlightGroupMap.delete(t),this._setStateFlag(t,ir.HIGHLIGHT,!1)),this.events.emit("instance-highlight-changed"))}getHighlight(t){return this._getStateFlag(t,ir.HIGHLIGHT)}foreachHighlightGroupPrev(t,e){this._highlightGroupMapPrev.get(t)?.forEach(e),this._highlightGroupMapPrev.delete(t)}foreachHighlightGroup(t,e){const s=this._highlightGroupMap.get(t);s?.forEach(e),s?this._highlightGroupMapPrev.set(t,new Set(s)):this._highlightGroupMapPrev.delete(t)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s){this.getState(s)&t&&++e}return e}_setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e)}_clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e)}_setStateFlag(t,e,s){s?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(sr,Math.floor(this._capacity*rt)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new rr(this._buffer)}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&ir.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function ar(t,e,s){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),s))}t([e({constructOnly:!0})],or.prototype,"shaderTransformation",void 0),t([e()],or.prototype,"_size",void 0),t([e({readOnly:!0})],or.prototype,"size",null),or=t([s("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],or);const hr=d(),cr=ri(),lr=Ds(),ur=Ds();class dr extends $s{constructor(t,e){super((t=>Ns(this._instanceData.view.boundingSphere.getVec(t,this._tmpSphere))),{maximumDepth:25}),this._instanceData=t,this._boundingSphere=e,this._tmpSphere=qs(),this._tmpMat4=Ds()}addInstance(t){const e=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);lt(Ys(this._tmpSphere),this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*Ks(s),e.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class fr{constructor(t,e){this._worldSpaceRadius=t,this._minScreenSpaceRadii=e}selectLevel(t,e,s){const i=s.computeScreenPixelSizeAt(t),n=this._worldSpaceRadius*e/i;let r=0;for(let t=1;t<this._minScreenSpaceRadii.length;++t)n>=this._minScreenSpaceRadii[t]&&(r=t);return r}}class pr{constructor(t){this.layerUid=t}}class mr extends pr{constructor(t,e){super(t),this.graphicUid=e}}function gr(t){return null!=t?.dist}class wr{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?(N(yr,this.ray.direction,this.dist),X(yr)):null}getIntersectionPoint(t){return!!gr(this)&&(N(yr,this.ray.direction,this.dist),ut(t,this.ray.origin,yr),!0)}getTransformedNormal(t){return E(xr,this.normal),xr[3]=0,k(xr,xr,this.transformation),E(t,xr),J(t,t)}constructor(t){this.intersector=ii.OBJECT,this.normal=d(),this.transformation=Ds(),this._ray=ks(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=ii.OBJECT,Ws(t,this._ray)}set(t,e,s,i,n,r,o){this.intersector=t,this.dist=s,E(this.normal,i??dt),b(this.transformation,n??Es),this.target=e,this.drapedLayerOrder=r,this.drapedLayerGraphicOrder=o}copy(t){Ws(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,E(this.normal,t.normal),b(this.transformation,t.transformation)}}function vr(t){return new wr(t)}const yr=d(),xr=O();class br extends vi{}class Mr extends mr{constructor(t,e,s,i,n,r){super(t,e),this.layerUid=t,this.graphicUid=e,this.geometryId=s,this.triangleNr=i,this.baseBoundingSphere=n,this.numLodLevels=r}}function Cr(t,e,s,i=null){const n=t.createBufferWriter(),r=n.vertexBufferLayout,o=n.elementCount(e),a=r.createBuffer(o);return n.write(null,null,e,i,a,0),{material:t,vertexBufferLayout:r,buffer:a.buffer,elementCount:o,boundingInfo:s}}class Ar{constructor(t,e){const s=t.renderContext.rctx,i=e.geometry;let n=null;n=i instanceof Se?Cr(i.material,i.attributes,i.boundingInfo):i;const r=n.material;this._materials=t.materials,r.setParameters({instancedDoublePrecision:!0}),this.geometry=i,this.material=r,this.glMaterials=new cn(r,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=mi.createVertex(s,it.STATIC_DRAW,n.buffer),this.vao=new br(s,_e,new Map([["geometry",Ts(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(t,e,s,i,n,r,o,a){if(!(this.geometry instanceof Se))return;const h=this.geometry.id;this.material.intersect(this.geometry,t.transform.transform,t,s,i,((s,i,c,l,u)=>{if(s>=0){if(null!=e&&!e(t.rayBegin,t.rayEnd,s))return;const l=new Mr(r.layerUid,r.graphicUid(n),h,c,o,a);if((null==t.results.min.drapedLayerOrder||u>=t.results.min.drapedLayerOrder)&&(null==t.results.min.dist||s<t.results.min.dist)&&t.results.min.set(ii.LOD,l,s,i,t.transform.transform,u),t.options.store!==ni.MIN&&(null==t.results.max.drapedLayerOrder||u>=t.results.max.drapedLayerOrder)&&(null==t.results.max.dist||s>t.results.max.dist)&&t.results.max.set(ii.LOD,l,s,i,t.transform.transform,u),t.options.store===ni.ALL){const e=vr(t.results.min.ray);e.set(ii.LOD,l,s,i,t.transform.transform,u),t.results.all.push(e)}}}))}}class Or{static async create(t,e,s){const i=await Promise.allSettled(e.components.map((e=>t.controller.schedule((()=>new Ar(t,e)),s)))),n=i.map((t=>"fulfilled"===t.status?t.value:null)).filter(ft);if(pt(s)||n.length!==i.length){n.forEach((t=>t.destroy())),o(s);for(const t of i)if("rejected"===t.status)throw t.reason}return new Or(e.minScreenSpaceRadius,n)}constructor(t,e){this.minScreenSpaceRadius=t,this.components=e}destroy(){this.components.forEach((t=>t.destroy()))}intersect(t,e,s,i,n,r,o){this.components.forEach((a=>a.intersect(t,e,s,i,n,r,this.boundingSphere,o)))}get boundingBox(){if(null==this._boundingBox){const t=mt();this.components.forEach((e=>{null!=e.boundingInfo&&(gt(t,e.boundingInfo.bbMin),gt(t,e.boundingInfo.bbMax))})),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const t=this.boundingBox,e=d();wt(t,e),this._boundingSphere={center:e,radius:.5*vt(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((t,e)=>t+e.triangleCount),0)}}function Sr(t,e,s,i,n){_r[0]=t.get(e,0),_r[1]=t.get(e,1),_r[2]=t.get(e,2),yi(_r,Pr,3),s.set(n,0,Pr[0]),i.set(n,0,Pr[1]),s.set(n,1,Pr[2]),i.set(n,1,Pr[3]),s.set(n,2,Pr[4]),i.set(n,2,Pr[5])}const _r=d(),Pr=new Float32Array(6);const Tr=t=>{const e=t.baseBoundingSphere.radius,s=t.levels.map((t=>t.minScreenSpaceRadius));return new fr(e,s)};let Rr=class extends an{constructor(t,e){super(t),this.type=ii.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Yn,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[Oe.OPAQUE_MATERIAL,t=>this._produces(t)],[Oe.TRANSPARENT_MATERIAL,t=>!!this._hasTransparentLevels()&&this._produces(t)]]),this._instanceData=new or({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(yt.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=Fr(this.optionalFields),this._glInstanceBufferLayout=Ts(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)})),this._instanceData.events.on("instance-visibility-changed",(({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this.baseMaterial.hasEmissions}get usedMemory(){return this._allRenderInstanceData.reduce(((t,e)=>e.reduce(((t,e)=>t+e.usedMemory),t)),0)}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach(((t,s)=>{const i=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,n=t.triangleCount;e.push({renderedInstances:i,renderedTriangles:i*n,trianglesPerInstance:n})})),{totalInstances:t,renderedInstances:e.reduce(((t,e)=>t+e.renderedInstances),0),renderedTriangles:e.reduce(((t,e)=>t+e.renderedTriangles),0),levels:e}}_createRenderInstanceDataArray(t=[]){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map((s=>{t.push(new er(e,this._instanceBufferLayout))})),t}async initializeRenderContext(t,e){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const s=await Promise.allSettled(this.symbol.levels.map((s=>Or.create(t,s,e)))),i=s.map((t=>"fulfilled"===t.status?t.value:null)).filter(ft);if(pt(e)||i.length!==s.length){i.forEach((t=>t.destroy())),o(e);for(const t of s)if("rejected"===t.status)throw t.reason}this._levels=i,this._levelSelector=Tr(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((t=>t.destroy())),this._defaultRenderInstanceData.forEach((t=>t.destroy())),this._highlightRenderInstanceDataMap.forEach((t=>t.forEach((t=>t.destroy()))))}_hasTransparentLevels(){return this._levels.some((t=>t.components.some((t=>{const e=t.material.produces.get(Oe.TRANSPARENT_MATERIAL);return e?.(Rs.Color)}))))}hasHighlights(){return xt(this._highlightRenderInstanceDataMap,(t=>t.some((t=>t.size>0))))}_produces(t){return t!==Rs.Highlight&&t!==Rs.ShadowHighlight||this.hasHighlights()}prepareRender(t){if(!Te.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(bt),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const s=new Array,i=this.levels;return e.forEach((e=>i.forEach((({components:i},n)=>i.forEach((i=>s.push(this._beginComponent(t,e[n],i)))))))),s}render(t,e){const s=this._getInstanceDatas(t);if(!s||null==e)return;let i=0;t.rctx.bindVAO();const n=this.levels;s.forEach((s=>n.forEach((({components:n},r)=>n.forEach((n=>this._renderComponent(t,e[i++],s[r],n,r)))))))}_getInstanceDatas(t){const{output:e,bind:s}=t,i=e===Rs.Highlight,n=!i&&e!==Rs.ShadowHighlight,r=e!==Rs.ShadowExcludeHighlight;if(n)return r?this._allRenderInstanceData:[this._defaultRenderInstanceData];if(r){if(i){const{highlightGroupName:t}=s;if(!t)return null;const e=this._highlightRenderInstanceDataMap.get(t);return e?[e]:null}const t=[];for(const e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}return null}intersect(t,e,s,i){if(!this.baseMaterial.visible||null==this._octree)return;const n=d();S(n,i,s);const r=n=>{this._instanceData.getCombinedModelTransform(n,Er),t.transform.set(Er),lt(Gr,s,t.transform.inverse),lt(Vr,i,t.transform.inverse);const r=this._instanceData.getState(n),o=this._instanceData.getLodLevel(n),a=this._levels.length;Gs(!!(r&ir.ACTIVE),"invalid instance state"),Gs(o>=0&&o<a,"invaid lod level"),this._levels[o].intersect(t,e,Gr,Vr,n,this.metadata,a)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(r):this._octree.forEachAlongRay(s,n,r)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new dr(t,this.baseBoundingSphere);for(let s=0;s<t.capacity;++s)e.get(s)&ir.ACTIVE&&this._octreeCached.addInstance(s)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Mt(this._octreeCached)}queryDepthRange(t){if(null==this._octree)return{near:1/0,far:-1/0};const e=t.viewForward,s=this._octree.findClosest(e,$s.DepthOrder.FRONT_TO_BACK,t.frustum),i=this._octree.findClosest(e,$s.DepthOrder.BACK_TO_FRONT,t.frustum);if(null==s||null==i)return{near:1/0,far:-1/0};const n=t.eye,r=this._instanceData.view;r.boundingSphere.getVec(s,Dr),S(Dr,Dr,n);const o=W(Dr,e)-Dr[3];r.boundingSphere.getVec(i,Dr),S(Dr,Dr,n);const a=W(Dr,e)+Dr[3];return{near:Math.max(t.near,o),far:Math.min(t.far,a)}}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((t=>t.forEach((t=>t.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:s,_levelSelector:i}=this;this._allRenderInstanceData.forEach((t=>t.forEach((t=>t.beginUpdate()))));const n=this._instanceData,r=n.view;let o=n.size;const a=n.capacity;let h=this._instanceIndex;const c=Math.ceil(a/500);for(let l=0;l<o&&!t.done;++l){h===this._cycleStartIndex&&this._startUpdateCycle();const l=r.state.get(h);let d=0;if(!(l&ir.ALLOCATED)){h=h+1===a?0:h+1,o++;continue}const f=r.lodLevel.get(h);if(l&ir.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[f].freeTail(),l&ir.HIGHLIGHT_ACTIVE&&n.foreachHighlightGroupPrev(h,(t=>{const e=this._highlightRenderInstanceDataMap.get(t);if(!e)throw new u("Internal error in lodRenderer");e[f].freeTail()})),l&ir.REMOVE)n.freeInstance(h);else if(l&ir.VISIBLE){let t=0;e&&(r.modelOrigin.getVec(h,zr),t=i.selectLevel(zr,n.getCombinedMedianScaleFactor(h),s)),d=l&~(ir.ACTIVE|ir.TRANSFORM_CHANGED),t>=0&&(l&ir.HIGHLIGHT?(n.foreachHighlightGroup(h,(e=>{let s=this._highlightRenderInstanceDataMap.get(e);if(s||(s=this._createRenderInstanceDataArray(),s.forEach((t=>t.beginUpdate())),this._highlightRenderInstanceDataMap.set(e,s)),t>=s.length)throw new u(`LodRenderer internal error - missing lodLevel ${t}`);jr(s[t],r,h)})),d|=ir.HIGHLIGHT_ACTIVE):(jr(this._defaultRenderInstanceData[t],r,h),d|=ir.DEFAULT_ACTIVE)),r.state.set(h,d),r.lodLevel.set(h,t)}else d=l&~(ir.ACTIVE|ir.TRANSFORM_CHANGED),r.state.set(h,d);if(null!=this._octreeCached){const t=!!(l&ir.ACTIVE),e=!!(d&ir.ACTIVE);!t&&e?this._octreeCached.addInstance(h):t&&!e?this._octreeCached.removeInstance(h):t&&e&&l&ir.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===a?0:h+1,h%c==0&&t.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach((t=>t.forEach((t=>t.endUpdate())))),this._context.requestRender()}_beginComponent(t,e,s){if(0===e.size)return null;const i=s.glMaterials.load(t.rctx,t.bind.slot,t.output);return i?.beginSlot(t.bind)}_renderComponent(t,e,s,i,n){if(!e)return;const{bind:r,rctx:o}=t;o.runAppleAmdDriverHelper();const a=o.bindTechnique(e,r,i.material.parameters,Lr);o.bindVAO(i.vao),e.ensureAttributeLocations(i.vao),Te.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===Rs.Color&&(a.setUniform4fv("externalColor",Ur[Math.min(n,Ur.length-1)]),a.setUniform1i("colorMixMode",Re.replace));const h=s.capacity,c=s.headIndex,l=s.tailIndex,u=s.firstIndex,d=this._glInstanceBufferLayout,f=(t,n)=>{Ct(o,_e,s.buffer,d,t),o.drawArraysInstanced(e.primitiveType,0,i.vertexCount,n-t),At(o,_e,s.buffer,d)};i.material.parameters.transparent&&null!=u?c>l?(Gs(u>=l&&u<=c,"invalid firstIndex"),f(u,c),f(l,u)):c<l&&(u<=c?(Gs(u>=0&&u<=c,"invalid firstIndex"),f(u,c),f(l,h),f(0,u)):(Gs(u>=l&&u<=h,"invalid firstIndex"),f(u,h),f(0,c),f(l,u))):c>l?f(l,c):c<l&&(f(0,c),f(l,h)),o.bindVAO(null)}};function jr(t,e,s){const i=t.allocateHead();Ir(e,s,t.view,i)}function Ir(t,e,s,i){Sr(t.modelOrigin,e,s.modelOriginHi,s.modelOriginLo,i),s.model.copyFrom(i,t.model,e),s.modelNormal.copyFrom(i,t.modelNormal,e),t.color&&s.color&&s.color.copyFrom(i,t.color,e),t.objectAndLayerIdColor&&s.objectAndLayerIdColor&&s.objectAndLayerIdColor.copyFrom(i,t.objectAndLayerIdColor,e),t.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(i,t.featureAttribute,e)}function Fr(t){let e=Us().vec3f(Vs.INSTANCEMODELORIGINHI).vec3f(Vs.INSTANCEMODELORIGINLO).mat3f(Vs.INSTANCEMODEL).mat3f(Vs.INSTANCEMODELNORMAL);return null!=t&&t.includes("featureAttribute")&&(e=e.vec4f(Vs.INSTANCEFEATUREATTRIBUTE)),null!=t&&t.includes("color")&&(e=e.vec4u8(Vs.INSTANCECOLOR)),null!=t&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(Vs.INSTANCEOBJECTANDLAYERIDCOLOR)),e}t([e({constructOnly:!0})],Rr.prototype,"symbol",void 0),t([e({constructOnly:!0})],Rr.prototype,"optionalFields",void 0),t([e({constructOnly:!0})],Rr.prototype,"metadata",void 0),t([e({constructOnly:!0})],Rr.prototype,"shaderTransformation",void 0),t([e()],Rr.prototype,"_instanceData",void 0),t([e()],Rr.prototype,"_cycleStartIndex",void 0),t([e({readOnly:!0})],Rr.prototype,"_enableLevelSelection",null),t([e()],Rr.prototype,"_updateCyclesWithStaticCamera",void 0),t([e({readOnly:!0})],Rr.prototype,"running",null),Rr=t([s("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],Rr);const zr=d(),Dr=O(),Er=Ds(),Gr=d(),Vr=d(),Ur=[A(1,0,1,1),A(0,0,1,1),A(0,1,0,1),A(1,1,0,1),A(1,0,0,1)],Lr=new Pe;class Hr{constructor(t,e=null){this.geometry=t,this.textures=e}get material(){return this.geometry.material}get numTriangles(){return this.geometry instanceof Se?this.geometry.indexCount/3:this.geometry.elementCount/3}}function Br(t){return t instanceof Se?t.attributes.get(Vs.POSITION).indices.length:t.elementCount}class $r{constructor(t,e,s){this.components=t,this.minScreenSpaceRadius=e,this.pivotOffset=s;const i=Ot(this.components.map((t=>t.geometry)));this.numVertices=i.reduce(((t,e)=>t+Br(e)),0)}}class kr{constructor(t){this.levels=t,this.levels.sort(((t,e)=>t.minScreenSpaceRadius===e.minScreenSpaceRadius?t.numVertices-e.numVertices:t.minScreenSpaceRadius-e.minScreenSpaceRadius))}}function Nr(t){const e=[];return t.levels.forEach((t=>t.components.forEach((t=>e.push(t.geometry.material))))),Ot(e)}function qr(t){const e=new Array;return t.levels.forEach((t=>t.components.forEach((t=>{null!=t.textures&&e.push(...t.textures)})))),Ot(e)}let Yr=class{constructor(t){this._optionalFields=new Array,this._instanceIndexToFeatureId=new Map,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=t.layerUid,this.view=t.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}async doLoad(t,e,s){St("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(Vs.OBJECTANDLAYERIDCOLOR);const i=Wr((t=>e(t)),t),n=this.view._stage,r=Nr(i);n.addMany(r),this._addDisposeResource((()=>n.removeMany(r)));const a=qr(i);n.addMany(a),this._addDisposeResource((()=>{a.forEach((t=>t.unload())),n.removeMany(a)})),await Promise.all(a.map((t=>this.view._stage.schedule((()=>t.load(n.renderView.renderingContext)),s)))),o(s);const h=await this._createLodRenderer(i,s);this._lodRendererResources={lodRenderer:h,materials:r,textures:a}}addInstances(t){const e=this._lodRendererResources;if(null==e)return;const{featureIds:s,localTransforms:i,globalTransforms:n}=t,r=e.lodRenderer;if(null==r)return;const o=r.instanceData,a=s.length;for(let t=0;t<a;++t){const e=s[t],r=o.addInstance(),a=o.view,h=16*t;a.localTransform.copyFromTypedBuffer(r,i,h),a.globalTransform.copyFromTypedBuffer(r,n,h),o.updateModelTransform(r),o.setVisible(r,!0),this._instanceIndexToFeatureId.set(r,e),this._featureIdToInstanceIndex.set(e,r)}}removeInstances(t){const e=this._lodRendererResources;if(null==e)return;const s=e?.lodRenderer,i=s.instanceData,n=this._instanceIndexToFeatureId,r=this._featureIdToInstanceIndex,o=t.length;for(let e=0;e<o;++e){const s=t[e],o=r.get(s);null!=o&&(i.removeInstance(o),n.delete(o),r.delete(s))}}_addDisposeResource(t){this._disposeResourceHandles.push(t)}async _createLodRenderer(t,e){const s=this.view._stage,i={layerUid:this.layerUid,graphicUid:t=>1,notifyGraphicGeometryChanged:t=>1,notifyGraphicVisibilityChanged:t=>1},n=new Rr({symbol:t,optionalFields:this._optionalFields,metadata:i,shaderTransformation:null},this.scheduler);return n.slicePlaneEnabled=!1,this._addDisposeResource((()=>{s.removeRenderPlugin(n),n.destroy()})),await s.addRenderPlugin(n,e),n}};function Wr(t,e){const s=e.levels.map((e=>{const s=e.components.map((e=>{const s=t(e.materialId);if(!Xr(s))throw new Error("LodRenderer only supports DefaultMaterial");const i=s.createBufferWriter(),n={material:s,vertexBufferLayout:i.vertexBufferLayout,buffer:e.renderGeometryBuffer.data,elementCount:e.renderGeometryBuffer.elementCount,boundingInfo:e.boundingInfo};return new Hr(n)}));return new $r(s,e.minScreenSpaceRadius)}));return new kr(s)}function Xr(t){return null!=t&&"materialType"in t&&"default"===t.materialType}Yr=t([s("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],Yr);const Qr=128,Jr=.5;function Zr(t){return"cross"===t||"x"===t}function Kr(t,e=Qr,s=e*Jr,i=0){const n=to(t,e,s,i);return new je(n,{mipmap:!1,wrap:{s:_t.CLAMP_TO_EDGE,t:_t.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0,reloadable:!0})}function to(t,e=Qr,s=e*Jr,i=0){switch(t){case"circle":default:return eo(e,s);case"square":return so(e,s);case"cross":return no(e,s,i);case"x":return ro(e,s,i);case"kite":return io(e,s);case"triangle":return oo(e,s);case"arrow":return ao(e,s)}}function eo(t,e){const s=t/2-.5;return fo(t,lo(s,s,e/2))}function so(t,e){return ho(t,e,!1)}function io(t,e){return ho(t,e,!0)}function no(t,e,s=0){return co(t,e,!1,s)}function ro(t,e,s=0){return co(t,e,!0,s)}function oo(t,e){return fo(t,uo(t/2,e,e/2))}function ao(t,e){const s=e,i=e/2,n=t/2,r=.8*s,o=lo(n,(t-e)/2-r,Math.sqrt(r*r+i*i)),a=uo(n,s,i);return fo(t,((t,e)=>Math.max(a(t,e),-o(t,e))))}function ho(t,e,s){return s&&(e/=Math.SQRT2),fo(t,((i,n)=>{let r=i-.5*t+.25,o=.5*t-n-.75;if(s){const t=(r+o)/Math.SQRT2;o=(o-r)/Math.SQRT2,r=t}return Math.max(Math.abs(r),Math.abs(o))-.5*e}))}function co(t,e,s,i=0){e-=i,s&&(e*=Math.SQRT2);const n=.5*e;return fo(t,((e,r)=>{let o,a=e-.5*t,h=.5*t-r-1;if(s){const t=(a+h)/Math.SQRT2;h=(h-a)/Math.SQRT2,a=t}return a=Math.abs(a),h=Math.abs(h),o=a>h?a>n?Math.sqrt((a-n)*(a-n)+h*h):h:h>n?Math.sqrt(a*a+(h-n)*(h-n)):a,o-=i/2,o}))}function lo(t,e,s){return(i,n)=>{const r=i-t,o=n-e;return Math.sqrt(r*r+o*o)-s}}function uo(t,e,s){const i=Math.sqrt(e*e+s*s);return(n,r)=>{const o=Math.abs(n-t)-s,a=r-t+e/2+.75,h=(e*o+s*a)/i,c=-a;return Math.max(h,c)}}function fo(t,e){const s=new Uint8Array(4*t*t);for(let i=0;i<t;i++)for(let n=0;n<t;n++){const r=n+t*i;let o=e(n,i);o=o/t+.5,Ai(o,s,4*r)}return s}function po(t){return t instanceof Float32Array&&t.length>=16}function mo(t){return Array.isArray(t)&&t.length>=16}function go(t){return po(t)||mo(t)}const wo=.5;function vo(t,e){t.include(Ie),t.attributes.add(Vs.POSITION,"vec3"),t.attributes.add(Vs.NORMAL,"vec3"),t.attributes.add(Vs.CENTEROFFSETANDDISTANCE,"vec4");const s=t.vertex;Fe(s,e),ze(s,e),s.uniforms.add(new De("viewport",((t,e)=>e.camera.fullViewport)),new Ee("polygonOffset",(t=>t.shaderPolygonOffset)),new Ee("cameraGroundRelative",((t,e)=>e.camera.aboveGround?1:-1))),e.hasVerticalOffset&&Ge(s),s.constants.add("smallOffsetAngle","float",.984807753012208),s.code.add(Oi`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),s.code.add(Oi`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${e.terrainDepthTest?Oi.float(0):Oi`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),e.draped&&!e.hasVerticalOffset||Ve(s),e.draped||(s.uniforms.add(new Ee("perDistancePixelRatio",((t,e)=>Math.tan(e.camera.fovY/2)/(e.camera.fullViewport[2]/2)))),s.code.add(Oi`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${Oi.float(wo)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),e.screenCenterOffsetUnitsEnabled&&Ue(s),e.hasScreenSizePerspective&&Le(s),s.code.add(Oi`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      vec3 centerOffset = centerOffsetAndDistance.xyz;
      float pointGroundDistance = centerOffsetAndDistance.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${e.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${e.hasScreenSizePerspective&&(e.hasVerticalOffset||e.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${e.hasVerticalOffset?e.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${e.hasVerticalOffset?Oi`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${e.screenCenterOffsetUnitsEnabled?"":Oi`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${e.screenCenterOffsetUnitsEnabled?e.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${e.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)}class yo{constructor(){this.factor=new xo,this.factorAlignment=new xo}}class xo{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}function bo(t){t.uniforms.add(new He("alignPixelEnabled",((t,e)=>e.alignPixelEnabled))),t.code.add(Oi`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),t.code.add(Oi`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)}function Mo(t,e){const{vertex:s,fragment:i}=t;t.include(Be,e),s.include(bo),e.terrainDepthTest&&t.varyings.add("depth","float"),s.main.add(Oi`
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.terrainDepthTest?Oi`depth = projectAux.posView.z;`:""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  `),i.main.add(Oi`fragColor = vec4(1);
if(terrainDepthTest(depth)) {
fragColor.g = 0.5;
}`)}var Co;!function(t){t[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT"}(Co||(Co={}));function Ao(t){t.vertex.uniforms.add(new Ee("renderTransparentlyOccludedHUD",((t,e)=>e.hudRenderStyle===Co.Occluded?1:e.hudRenderStyle===Co.NotOccluded?0:.75)),new De("viewport",((t,e)=>e.camera.fullViewport)),new $e("hudVisibilityTexture",((t,e)=>e.hudVisibility?.getTexture()))),t.vertex.include(bo),t.vertex.code.add(Oi`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}const Oo={occludedFadeFactor:.6};function So(t){const e=new ke,s=t.signedDistanceFieldEnabled;if(e.include(vo,t),e.include(Ne,t),t.occlusionPass)return e.include(Mo,t),e;const{vertex:i,fragment:n}=e;e.include(Ie),e.include(qe,t),e.include(Ye,t),e.include(Ao),n.include(Di),n.include(We),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),e.varyings.add("voccluded","float"),i.uniforms.add(new De("viewport",((t,e)=>e.camera.fullViewport)),new Xe("screenOffset",((t,e)=>Pt(Ro,2*t.screenOffset[0]*e.camera.pixelRatio,2*t.screenOffset[1]*e.camera.pixelRatio))),new Xe("anchorPosition",(t=>Po(t))),new De("materialColor",(t=>t.color)),new Ee("materialRotation",(t=>t.rotation))),Ue(i),s&&(i.uniforms.add(new De("outlineColor",(t=>t.outlineColor))),n.uniforms.add(new De("outlineColor",(t=>_o(t)?t.outlineColor:Tt)),new Ee("outlineSize",(t=>_o(t)?t.outlineSize:0)))),t.horizonCullingEnabled&&i.uniforms.add(new Ei("pointDistanceSphere",((t,e)=>{const s=e.camera.eye,i=t.origin;return A(i[0]-s[0],i[1]-s[1],i[2]-s[2],Rt.radius)}))),t.pixelSnappingEnabled&&i.include(bo),t.hasScreenSizePerspective&&(Qe(i),Le(i)),t.debugDrawLabelBorder&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(Vs.UV0,"vec2"),e.attributes.add(Vs.COLOR,"vec4"),e.attributes.add(Vs.SIZE,"vec2"),e.attributes.add(Vs.ROTATION,"float"),e.attributes.add(Vs.FEATUREATTRIBUTE,"vec4"),i.code.add(t.horizonCullingEnabled?Oi`bool behindHorizon(vec3 posModel) {
vec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;
vec3 camToPos = pointDistanceSphere.xyz + posModel;
float earthRadius = pointDistanceSphere.w;
float a = dot(camToPos, camToPos);
float b = dot(camToPos, camToEarthCenter);
float c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;
return  b > 0.0 && b < a && b * b  > a * c;
}`:Oi`bool behindHorizon(vec3 posModel) { return false; }`),i.main.add(Oi`
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      if (behindHorizon(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      vec2 inputSize;
      ${Si(t.hasScreenSizePerspective,Oi`
          inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
          vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);`,Oi`
          inputSize = size;
          vec2 screenOffsetScaled = screenOffset;`)}
      ${Si(t.vvSize,Oi`inputSize *= vvScale(featureAttribute).xx;`)}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);
      bool visible = testHUDVisibility(posProj);
      voccluded = visible ? 0.0 : 1.0;
    `);const r=Oi`
      vec2 uv01 = floor(uv0);
      vec2 uv = uv0 - uv01;
      quadOffset.xy = (uv01 - anchorPosition) * 2.0 * combinedSize;

      ${Si(t.hasRotation,Oi`
          float angle = radians(materialRotation + rotation);
          float cosAngle = cos(angle);
          float sinAngle = sin(angle);
          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);

          quadOffset.xy = rotate * quadOffset.xy;
        `)}

      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;
  `,o=t.pixelSnappingEnabled?s?Oi`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:Oi`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:Oi`posProj += quadOffset;`;i.main.add(Oi`
    ${Si(t.occlusionTestEnabled,Oi`
      if (!visible) {
        vtc = vec2(0.0);
        ${Si(t.debugDrawLabelBorder,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);")}
        return;
      }`)}
    ${r}
    ${t.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${Si(t.output===Rs.ObjectAndLayerIdColor,Oi`vcolor.a = 1.0;`)}

    bool alphaDiscard = vcolor.a < ${Oi.float(jt)};
    ${Si(s,`alphaDiscard = alphaDiscard && outlineColor.a < ${Oi.float(jt)};`)}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${o}
      gl_Position = posProj;
    }

    vtc = uv;

    ${Si(t.debugDrawLabelBorder,Oi`debugBorderCoords = vec4(uv01, 1.5 / combinedSize);`)}
    vsize = inputSize;
  `),n.uniforms.add(new $e("tex",(t=>t.texture))),t.occludedFragmentFade&&(n.uniforms.add(new $e("depthMap",((t,e)=>e.mainDepth))),n.uniforms.add(new Ee("fadeFactor",(()=>Oo.occludedFadeFactor))));const a=t.debugDrawLabelBorder?Oi`(isBorder > 0.0 ? 0.0 : ${Oi.float(jt)})`:Oi.float(jt),h=t.output===Rs.Highlight,c=Oi`
    ${Si(t.debugDrawLabelBorder,Oi`float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`)}

    ${Si(t.sampleSignedDistanceFieldTexelCenter,Oi`
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;`,Oi`vec2 samplePos = vtc;`)}

    ${s?Oi`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${a} ||
          fillPixelColor.a + outlinePixelColor.a < ${Oi.float(jt)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        ${Si(!h,Oi`fragColor = vec4(compositeColor, compositeAlpha);`)}
      } else {
        if (fillAlphaFactor < ${a}) {
          discard;
        }

        ${Si(!h,Oi`fragColor = premultiplyAlpha(fillPixelColor);`)}
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:Oi`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${a}) {
            discard;
          }
          ${Si(!h,Oi`fragColor = texColor * premultiplyAlpha(vcolor);`)}
          `}

    ${Si(t.occludedFragmentFade&&!h,Oi`
        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;
        if (zSample < gl_FragCoord.z) {
          fragColor *= fadeFactor;
        }
        `)}

    ${Si(!h&&t.debugDrawLabelBorder,Oi`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`)}
  `;switch(t.output){case Rs.Color:t.oitPass===Ze.ColorAlpha&&(e.outputs.add("fragColor","vec4",0),e.outputs.add("fragAlpha","float",1)),n.main.add(Oi`
        ${c}
        ${Si(t.oitPass===Ze.FrontFace,Oi`fragColor.rgb /= fragColor.a;`)}
        ${Si(t.oitPass===Ze.ColorAlpha,Oi`fragAlpha = fragColor.a;`)}`);break;case Rs.ObjectAndLayerIdColor:n.main.add(Oi`
        ${c}
        outputObjectAndLayerIdColor();`);break;case Rs.Highlight:e.include(Je,t),n.main.add(Oi`
        ${c}
        outputHighlight(voccluded == 1.0);`)}return e}function _o(t){return t.outlineColor[3]>0&&t.outlineSize>0}function Po(t,e=Ro){return t.textureIsSignedDistanceField?To(t.anchorPosition,t.distanceFieldBoundingBox,e):G(e,t.anchorPosition),e}function To(t,e,s){null!=e?Pt(s,t[0]*(e[2]-e[0])+e[0],t[1]*(e[3]-e[1])+e[1]):Pt(s,0,0)}const Ro=It(),jo=Object.freeze(Object.defineProperty({__proto__:null,build:So,calculateAnchorPosForRendering:Po,shaderSettings:Oo},Symbol.toStringTag,{value:"Module"}));class Io extends Ke{constructor(t,e,s){super(t,e,new ts(jo,(()=>import("./p-083b8834.js"))),s),this.primitiveType=e.occlusionPass?Ft.POINTS:Ft.TRIANGLES}initializePipeline(t){const{oitPass:e,hasPolygonOffset:s,draped:i,output:n,depthTestEnabled:r}=t,o=e===Ze.NONE,a=s?Fo:null,h=e===Ze.ColorAlpha,c=i||!r||h||n===Rs.Highlight?null:Ci;return xi({blending:n===Rs.Color?o?bi:es(e):null,depthTest:r&&!i?{func:zt.LEQUAL}:null,depthWrite:c,drawBuffers:ss(e,n),colorWrite:Mi,polygonOffset:a})}}const Fo={factor:0,units:-4};class zo extends ns{constructor(t){super(),this.spherical=t,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.textureCoordinateType=rs.None,this.emissionSource=os.None,this.discardInvisibleFragments=!0,this.hasSliceInVertexProgram=!0,this.hasVvInstancing=!1}}t([is()],zo.prototype,"screenCenterOffsetUnitsEnabled",void 0),t([is()],zo.prototype,"occlusionTestEnabled",void 0),t([is()],zo.prototype,"signedDistanceFieldEnabled",void 0),t([is()],zo.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),t([is()],zo.prototype,"vvSize",void 0),t([is()],zo.prototype,"vvColor",void 0),t([is()],zo.prototype,"hasVerticalOffset",void 0),t([is()],zo.prototype,"hasScreenSizePerspective",void 0),t([is()],zo.prototype,"hasRotation",void 0),t([is()],zo.prototype,"debugDrawLabelBorder",void 0),t([is()],zo.prototype,"hasSlicePlane",void 0),t([is()],zo.prototype,"hasPolygonOffset",void 0),t([is()],zo.prototype,"depthTestEnabled",void 0),t([is()],zo.prototype,"pixelSnappingEnabled",void 0),t([is()],zo.prototype,"draped",void 0),t([is()],zo.prototype,"terrainDepthTest",void 0),t([is()],zo.prototype,"cullAboveTerrain",void 0),t([is()],zo.prototype,"occlusionPass",void 0),t([is()],zo.prototype,"occludedFragmentFade",void 0),t([is()],zo.prototype,"objectAndLayerIdColorInstanced",void 0),t([is()],zo.prototype,"horizonCullingEnabled",void 0);class Do extends as{constructor(t,e){super(t,oa),this.produces=new Map([[Oe.HUD_MATERIAL,t=>js(t)&&!this.parameters.drawInSecondSlot],[Oe.LABEL_MATERIAL,t=>js(t)&&this.parameters.drawInSecondSlot],[Oe.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[Oe.DRAPED_MATERIAL,t=>this.parameters.draped&&js(t)]]),this._visible=!0,this._configuration=new zo(e)}getConfiguration(t,e){return this._configuration.output=t,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=e.slot===Oe.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.depthTestEnabled=this.parameters.depthEnabled||e.slot===Oe.OCCLUSION_PIXELS,t===Rs.Color&&(this._configuration.debugDrawLabelBorder=!!Te.LABELS_SHOW_BORDER),this._configuration.oitPass=e.oitPass,this._configuration.terrainDepthTest=e.terrainDepthTest,this._configuration.cullAboveTerrain=e.cullAboveTerrain,this._configuration}intersect(t,e,s,i,n,r){const{options:{selectionMode:o,hud:a,excludeLabels:h},point:c,camera:l}=s,{parameters:u}=this;if(!o||!a||h&&u.isLabel||!t.visible||!c)return;const{scaleX:f,scaleY:p}=this._getScreenScale(t,l.pixelRatio);at(Xo,e),t.attributes.has(Vs.FEATUREATTRIBUTE)&&Uo(Xo);const m=t.attributes.get(Vs.POSITION),g=t.attributes.get(Vs.SIZE),w=t.attributes.get(Vs.NORMAL),v=t.attributes.get(Vs.ROTATION),y=t.attributes.get(Vs.CENTEROFFSETANDDISTANCE);Gs(m.size>=3);const x=Po(u),b="screen"===this.parameters.centerOffsetUnits;for(let t=0;t<m.data.length/m.size;t++){const i=t*m.size;_(Bo,m.data[i],m.data[i+1],m.data[i+2]),lt(Bo,Bo,e),lt(Bo,Bo,l.viewMatrix);const n=t*y.size;if(_(Zo,y.data[n],y.data[n+1],y.data[n+2]),!b&&(Bo[0]+=Zo[0],Bo[1]+=Zo[1],0!==Zo[2])){const t=Zo[2];J(Zo,Bo),S(Bo,Bo,N(Zo,Zo,t))}const o=t*w.size;if(_($o,w.data[o],w.data[o+1],w.data[o+2]),Vo($o,Xo,l,ea),this._applyVerticalOffsetTransformationView(Bo,ea,l,Ho),l.applyProjection(Bo,ko),ko[0]>-1){b&&(Zo[0]||Zo[1])&&(ko[0]+=Zo[0]*l.pixelRatio,0!==Zo[1]&&(ko[1]+=hs(Zo[1],Ho.factorAlignment)*l.pixelRatio),l.unapplyProjection(ko,Bo)),ko[0]+=this.parameters.screenOffset[0]*l.pixelRatio,ko[1]+=this.parameters.screenOffset[1]*l.pixelRatio,ko[0]=Math.floor(ko[0]),ko[1]=Math.floor(ko[1]);const e=t*g.size;na[0]=g.data[e],na[1]=g.data[e+1],cs(na,Ho.factor,na);const i=sa*l.pixelRatio;let n=0;if(u.textureIsSignedDistanceField){n=Math.min(u.outlineSize,.5*na[0])*l.pixelRatio/2}na[0]*=f,na[1]*=p;const o=t*v.size,a=u.rotation+v.data[o];if(Lo(c,ko[0],ko[1],na,i,n,a,u,x)){const t=s.ray;if(lt(qo,Bo,M(Jo,l.viewMatrix)),ko[0]=c[0],ko[1]=c[1],l.unprojectFromRenderScreen(ko,Bo)){const e=d();E(e,t.direction);const s=1/X(e);N(e,e,s);r(F(t.origin,Bo)*s,e,-1,!0,1,qo)}}}}}intersectDraped(t,e,s,i,n,r){const o=t.attributes.get(Vs.POSITION),a=t.attributes.get(Vs.SIZE),h=t.attributes.get(Vs.ROTATION),c=this.parameters,l=Po(c),{scaleX:u,scaleY:d}=this._getScreenScale(t,t.screenToWorldRatio),f=ia*t.screenToWorldRatio;for(let e=0;e<o.data.length/o.size;e++){const s=e*o.size,p=o.data[s],m=o.data[s+1],g=e*a.size;na[0]=a.data[g],na[1]=a.data[g+1];let w=0;if(c.textureIsSignedDistanceField){w=Math.min(c.outlineSize,.5*na[0])*t.screenToWorldRatio/2}na[0]*=u,na[1]*=d;const v=e*h.size,y=c.rotation+h.data[v];Lo(i,p,m,na,f,w,y,c,l)&&n(r.dist,r.normal,-1,!1)}}createBufferWriter(){return new ca}_updateScaleInfo(t,e,s){const i=this.parameters;null!=i.screenSizePerspective?ls(s,e,i.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minScaleFactor=0),null!=i.screenSizePerspectiveAlignment?ls(s,e,i.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minScaleFactor=t.factor.minScaleFactor)}applyShaderOffsetsView(t,e,s,i,n,r,o){const a=Vo(e,s,n,ea);return this._applyVerticalGroundOffsetView(t,a,n,o),this._applyVerticalOffsetTransformationView(o,a,n,r),this._applyPolygonOffsetView(o,a,i[3],n,o),this._applyCenterOffsetView(o,i,o),o}applyShaderOffsetsNDC(t,e,s,i,n){return this._applyCenterOffsetNDC(t,e,s,i),null!=n&&E(n,i),this._applyPolygonOffsetNDC(i,e,s,i),i}_applyPolygonOffsetView(t,e,s,i,n){const r=i.aboveGround?1:-1;let o=Math.sign(s);0===o&&(o=r);const a=r*o;if(this.parameters.shaderPolygonOffset<=0)return E(n,t);const h=Bt(Math.abs(e.cosAngle),.01,1),c=1-Math.sqrt(1-h*h)/h/i.viewport[2];return N(n,t,a>0?c:1/c),n}_applyVerticalGroundOffsetView(t,e,s,i){const n=X(t),r=s.aboveGround?1:-1,o=s.computeRenderPixelSizeAtDist(n)*wo,a=N(Bo,e.normal,r*o);return ut(i,t,a),i}_applyVerticalOffsetTransformationView(t,e,s,i){const n=this.parameters;if(!n.verticalOffset?.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const s=X(t);this._updateScaleInfo(i,s,e.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return t}const r=X(t),o=n.screenSizePerspectiveAlignment??n.screenSizePerspective,a=Cs(s,r,n.verticalOffset,e.cosAngle,o);return this._updateScaleInfo(i,r,e.cosAngle),N(e.normal,e.normal,a),ut(t,t,e.normal)}_applyCenterOffsetView(t,e,s){const i="screen"!==this.parameters.centerOffsetUnits;return s!==t&&E(s,t),i&&(s[0]+=e[0],s[1]+=e[1],e[2]&&(J($o,s),ut(s,s,N($o,$o,e[2])))),s}_applyCenterOffsetNDC(t,e,s,i){const n="screen"!==this.parameters.centerOffsetUnits;return i!==t&&E(i,t),n||(i[0]+=e[0]/s.fullWidth*2,i[1]+=e[1]/s.fullHeight*2),i}_applyPolygonOffsetNDC(t,e,s,i){const n=this.parameters.shaderPolygonOffset;if(t!==i&&E(i,t),n){const t=s.aboveGround?1:-1,r=t*Math.sign(e[3]);i[2]-=(r||t)*n}return i}set visible(t){this._visible=t}get visible(){const{color:t,outlineSize:e,outlineColor:s}=this.parameters,i=t[3]>=jt||e>=jt&&s[3]>=jt;return this._visible&&i}createGLMaterial(t){return new Eo(t)}calculateRelativeScreenBounds(t,e,s=Vt()){return Go(this.parameters,t,e,s),s[2]=s[0]+t[0],s[3]=s[1]+t[1],s}_getScreenScale(t,e){const s=t.attributes.get(Vs.FEATUREATTRIBUTE);if(null==s)return{scaleX:e,scaleY:e};const i=Ut(s.data,ta);return us(Ko,this.parameters,i),{scaleX:Ko[0]*e,scaleY:Ko[1]*e}}}class Eo extends ds{constructor(t){super({...t,...t.material.parameters})}beginSlot(t){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.acquireTechnique(Io,t)}}function Go(t,e,s,i){i[0]=t.anchorPosition[0]*-e[0]+t.screenOffset[0]*s,i[1]=t.anchorPosition[1]*-e[1]+t.screenOffset[1]*s}function Vo(t,e,s,i){return go(e)&&(e=at(Qo,e)),Dt(i.normal,t,e),lt(i.normal,i.normal,s.viewInverseTransposeMatrix),i.cosAngle=W(No,ra),i}function Uo(t){const e=t[0],s=t[1],i=t[2],n=t[3],r=t[4],o=t[5],a=t[6],h=t[7],c=t[8],l=1/Math.sqrt(e*e+s*s+i*i),u=1/Math.sqrt(n*n+r*r+o*o),d=1/Math.sqrt(a*a+h*h+c*c);return t[0]=e*l,t[1]=s*l,t[2]=i*l,t[3]=n*u,t[4]=r*u,t[5]=o*u,t[6]=a*d,t[7]=h*d,t[8]=c*d,t}function Lo(t,e,s,i,n,r,o,a,h){let c=e-n-i[0]*h[0],l=c+i[0]+2*n,u=s-n-i[1]*h[1],d=u+i[1]+2*n;const f=a.distanceFieldBoundingBox;return a.textureIsSignedDistanceField&&null!=f&&(c+=i[0]*f[0],u+=i[1]*f[1],l-=i[0]*(1-f[2]),d-=i[1]*(1-f[3]),c-=r,l+=r,u-=r,d+=r),Pt(Wo,e,s),Et(Yo,t,Wo,Gt(o)),Yo[0]>c&&Yo[0]<l&&Yo[1]>u&&Yo[1]<d}const Ho=new yo,Bo=d(),$o=d(),ko=O(),No=d(),qo=d(),Yo=It(),Wo=It(),Xo=ri(),Qo=ri(),Jo=Ds(),Zo=d(),Ko=d(),ta=O(),ea={normal:No,cosAngle:0},sa=1,ia=2,na=[0,0],ra=Lt(0,0,1);class oa extends fs{constructor(){super(...arguments),this.renderOccluded=ps.Occlude,this.isDecoration=!1,this.color=Ht(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=p(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=Ht(1,1,1,1),this.outlineSize=0,this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1,this.isLabel=!1}}const aa=Us().vec3f(Vs.POSITION).vec3f(Vs.NORMAL).vec2f(Vs.UV0).vec4u8(Vs.COLOR).vec2f(Vs.SIZE).f32(Vs.ROTATION).vec4f(Vs.CENTEROFFSETANDDISTANCE).vec4f(Vs.FEATUREATTRIBUTE),ha=aa.clone().vec4u8(Vs.OBJECTANDLAYERIDCOLOR);class ca{constructor(){this.vertexBufferLayout=ms()?ha:aa}elementCount(t){return 6*t.get(Vs.POSITION).indices.length}write(t,e,s,i,n,r){gs(s.get(Vs.POSITION),t,n.position,r,6),ws(s.get(Vs.NORMAL),e,n.normal,r,6);const o=s.get(Vs.UV0)?.data;let a=0,h=0,c=1,l=1;o&&o.length>=4&&(a=o[0],h=o[1],c=o[2],l=o[3]),c=Math.min(1.99999,c+1),l=Math.min(1.99999,l+1);let u=s.get(Vs.POSITION).indices.length,d=r;const f=n.uv0;for(let t=0;t<u;++t)f.set(d,0,a),f.set(d,1,h),d++,f.set(d,0,c),f.set(d,1,h),d++,f.set(d,0,c),f.set(d,1,l),d++,f.set(d,0,c),f.set(d,1,l),d++,f.set(d,0,a),f.set(d,1,l),d++,f.set(d,0,a),f.set(d,1,h),d++;vs(s.get(Vs.COLOR),4,n.color,r,6);const{data:p,indices:m}=s.get(Vs.SIZE);u=m.length;const g=n.size;d=r;for(let t=0;t<u;++t){const e=p[2*m[t]],s=p[2*m[t]+1];for(let t=0;t<6;++t)g.set(d,0,e),g.set(d,1,s),d++}if(ys(s.get(Vs.ROTATION),n.rotation,r,6),s.get(Vs.CENTEROFFSETANDDISTANCE)?xs(s.get(Vs.CENTEROFFSETANDDISTANCE),n.centerOffsetAndDistance,r,6):bs(n.centerOffsetAndDistance,r,6*u),s.get(Vs.FEATUREATTRIBUTE)?xs(s.get(Vs.FEATUREATTRIBUTE),n.featureAttribute,r,6):bs(n.featureAttribute,r,6*u),null!=i){const t=s.get(Vs.POSITION)?.indices;if(t){const e=t.length,s=n.getField(Vs.OBJECTANDLAYERIDCOLOR,ci);Ms(i,s,e,r,6)}}}}let la=class extends i{constructor(t){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.view=t.view,this.layerUid=t.layerUid}initialize(){}destroy(){}async executeRenderCommands(t){for(const e of t)switch(e.id){case"create-material":await this._createMaterial(e);break;case"create-direct-renderer":await this._createDirectRenderer(e);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(e);break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(e);break;case"create-lod-renderer":await this._createLodRenderer(e);break;case"add-lod-instances":await this._addLodInstances(e);break;case"remove-lod-instances":await this._removeLodInstances(e)}}async _createMaterial(t){const{view:e}=this,{sharedSymbolResources:s}=e;if(null==s)throw new Error("No shared symbol resources found!");const{textures:i}=s,n=e.state.viewingMode===Y.Global;let r=null;switch(t.type){case"default":r=da(s,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:e._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},n);break;case"hud":{const[t,e]=ua(i,n);this.addHandles([$t((()=>kt(e)))]),r=t}break;default:throw new Error(`unable to create unknown material type ${t.type}`)}this._materials.set(t.materialId,r)}_getMaterial(t){return this._materials.get(t)}async _createDirectRenderer(t){const e=t.materialId,s=this._getMaterial(e);if(null==s)throw new Error(`material not found ${e}`);const{view:i}=this,n=new Vn({material:s});this._directRenderers.set(e,n),i._stage.addRenderPlugin(n),i._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(t){const e=t.renderGeometryId,s=t.materialId;null!=this._renderGeometries.get(e)&&await this._removeDirectRendererGeometry({renderGeometryId:e});const i=this._directRenderers.get(s);if(null==i)return void console.error("no renderer assigned to provided material");const n=i.addRenderGeometry(e,t.renderGeometryBuffer,t.localOrigin);this._renderGeometries.set(e,{renderGeometry:n,materialId:s}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(t){const e=t.renderGeometryId,s=this._renderGeometries.get(e);if(null==s)return;const i=s.materialId,n=this._directRenderers.get(i);null!=n?n.removeRenderGeometry(t.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(t){const e=new Yr({view:this.view,layerUid:this.layerUid}),s=new AbortController,i=t=>this._getMaterial(t);await e.doLoad(t.lodRenderGeometry,i,s.signal),this._lodRenderers.set(t.lodRendererId,e)}async _addLodInstances(t){const e=this._lodRenderers.get(t.lodRendererId);if(null==e)throw new Error("no lod renderer assigned to provided lod renderer Id");e.addInstances(t.data)}async _removeLodInstances(t){const e=this._lodRenderers.get(t.lodRendererId);if(null==e)throw new Error("no lod renderer assigned to provided lod renderer Id");e.removeInstances(t.featureIds)}};function ua(t,e){const s={anchorPosition:sn.center,occlusionTest:!0,hasSlicePlane:!1},i=s,n=1;i.color=[1,0,0,1],i.outlineColor=[0,0,0,1],i.outlineSize=n;const r=null;if(null!=t){const e=t.fromData("circle-icon",(()=>Kr("circle")));i.textureId=e.texture.id,i.textureIsSignedDistanceField=!0,i.sampleSignedDistanceFieldTexelCenter=Zr("circle")}return i.distanceFieldBoundingBox=pa,[new Do(s,e),r]}function da(t,e,s){const i={usePBR:e.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:Os,ambient:Nt,diffuse:Nt,hasSlicePlane:e.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:e.castShadows,offsetTransparentBackfaces:!e.isPrimitive};return fa(i),e.screenSizePerspectiveEnabled&&(i.screenSizePerspective=t.screenSizePerspectiveSettings),i.externalColor=qt,i.isInstanced=!0,new As(i,{spherical:s,doublePrecisionRequiresObfuscation:!0})}function fa(t){const e=t.opacity??1,s=e<1;return t.transparent=s,t.opacity=e,t.cullFace=s?Fs.None:Fs.Back,t}la=t([s("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],la);const pa=[Jr/2,Jr/2,1-Jr/2,1-Jr/2];class ma{constructor(t){this._bufferWriter=null,this._bufferWriter=t.createBufferWriter()}createBuffer(t,e){const s=this._bufferWriter;let i=null;if(t.transformation&&e)b(ga,t.transformation),ga[12]-=e[0],ga[13]-=e[1],ga[14]-=e[2],i=ga;else{if(e)throw new Error("not implemented");t.transformation&&(i=t.transformation)}let n=null;i&&(M(wa,ga),C(wa,wa),n=wa);const r=t.attributes,o=s.elementCount(r),a=s.vertexBufferLayout.stride/4;o>Math.floor(va/a)&&console.warn("geometry with very large number of elements encountered");const h=s.vertexBufferLayout.createBuffer(o),c=0;return s.write(i,n,r,t.objectAndLayerIdColor,h,c),{data:h.buffer,elementCount:o}}}const ga=Ds(),wa=Ds(),va=16777216/4;class ya{constructor(t){this._context=t,this._commands=[],this._transferables=new Set}createMaterial(t){const e=this._context,s=e.generateId("material");switch(t){case"default":{const t=new As({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),i=new ma(t);e.registerRenderGeometryBufferWriter(s,i)}break;case"hud":{const t=ua(null,this._context.globalViewingMode)[0],i=new ma(t);e.registerRenderGeometryBufferWriter(s,i)}}return this._commands.push({id:"create-material",type:t,materialId:s}),s}createDirectRenderer(t){const e=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:e,materialId:t}),e}addDirectRendererGeometry(t,e,s){const i=e.materialId,n=this._context.getRenderGeometryBufferWriter(i);if(null==n)throw new Error(`no bufferwriter found for material ${i}`);const r=n.createBuffer(e,s);this._transferables.add(r.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:t,materialId:i,renderGeometryBuffer:r,localOrigin:s})}removeDirectRendererGeometry(t){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:t})}createLodRenderer(t){const e=this._context.generateId("lod-renderer"),s={levels:t.levels.map((t=>({components:t.components.map((t=>{const e=t.attributes.get(Vs.POSITION);if(!e||0===e.indices.length)throw new Error("positions attribute expected");const s=3,i=be(e.indices.length/s),n=new Ss(i,s,e),r=this._context.getRenderGeometryBufferWriter(t.materialId);if(null==r)throw new Error("writer not found");const o=r.createBuffer(t,null);this._transferables.add(o.data);return{materialId:t.materialId,renderGeometryBuffer:o,boundingInfo:{bbMax:n.bbMax,bbMin:n.bbMin}}})),minScreenSpaceRadius:t.minScreenSpaceRadius})))};return this._commands.push({id:"create-lod-renderer",lodRendererId:e,lodRenderGeometry:s}),e}addLodInstances(t,e){this._commands.push({id:"add-lod-instances",lodRendererId:t,data:e}),this._transferables.add(e.featureIds.buffer),this._transferables.add(e.globalTransforms.buffer),this._transferables.add(e.localTransforms.buffer)}removeLodInstances(t,e){this._commands.push({id:"remove-lod-instances",lodRendererId:t,featureIds:e}),this._transferables.add(e.buffer)}async dispatch(){const t=this._commands,e=Array.from(this._transferables);this._clearCommandBuffer(),this._context.dispatchRenderCommands(t,e)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}}class xa{constructor(t){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=t.viewingMode===Y.Global,this._dispatchRenderCommandsCallback=t.dispatchRenderCommandsCallback}generateId(t=""){return`${t}${this._idCounter++}`}createEncoder(){return new ya(this)}async dispatchRenderCommands(t,e){this._dispatchRenderCommandsCallback(t,e)}registerRenderGeometryBufferWriter(t,e){this._bufferWriters.set(t,e)}getRenderGeometryBufferWriter(t){return this._bufferWriters.get(t)}}var ba;!function(t){t[t.OBJECT_ID=0]="OBJECT_ID",t[t.PARTITION_ID=1]="PARTITION_ID",t[t.GEOMETRY_MAP_COORDINATES=2]="GEOMETRY_MAP_COORDINATES",t[t.GEOMETRY_RENDER_COORDINATES=3]="GEOMETRY_RENDER_COORDINATES",t[t.TILE_CENTER_RENDER_COORDINATES=4]="TILE_CENTER_RENDER_COORDINATES"}(ba||(ba={}));async function Ma(t,e){const{numFeatures:s,tile:i,partitionInfo:n}=t,{pages:r}=i;if(0===r.length||0===s)return new Uint32Array;const o=new Uint32Array(s);if(n){const t=r.reduce(((t,{featureCount:e})=>t+e),0),e=new Uint32Array(t);let i=0;for(const t of r)i=t.readAllObjectIds(e,i);const a=n.tileIndices;for(let t=0;t<s;++t){const s=e[a[t]];o[t]=s}}else{let t=0;for(const e of r)t=e.readAllObjectIds(o,t)}return o}async function Ca(t,e){const{numFeatures:s,tile:i,partitionInfo:n}=t,{pages:r}=i;if(0===r.length||0===s)return new Float64Array;const o=new Float64Array(3*s);if(n){const t=r.reduce(((t,{featureCount:e})=>t+e),0),e=new Float64Array(3*t);let i=0;for(const t of r)i=t.readAllCoordinates(e,i);const a=n.tileIndices;for(let t=0;t<s;++t){const s=a[t],i=e[3*s+0],n=e[3*s+1],r=e[3*s+2];o[3*t+0]=i,o[3*t+1]=n,o[3*t+2]=r}}else{let t=0;for(const e of r)t=e.readAllCoordinates(o,t)}return o}async function Aa(t,e){await t.provision([ba.GEOMETRY_MAP_COORDINATES],e);const{numFeatures:s,tile:i,mapCoordinates:n}=t,{pages:r}=i;if(0===r.length||0===s)return new Float64Array;const o=e.viewSpatialReference,a=e.renderSpatialReference,h=new Float64Array(3*s);if(!Yt(n,o,0,h,a,0,s))throw new Error("Failed to project coordinates");return h}async function Oa(t,e){const s=e.viewSpatialReference,i=e.renderSpatialReference,n=t.tile.descriptor.extent,r=Wt(n),o=d();return Pi([r[0],r[1],0],s,o,i),o}class Sa{constructor(t,e,s=null){this._tile=t,this._numFeatures=e,this._partitionInfo=s}get partitionInfo(){return this._partitionInfo}get tile(){return this._tile}get numFeatures(){return this._numFeatures}get tileId(){return this._tile.descriptor.id}get objectIds(){if(null==this._objectIds)throw new Error("objectIds haven't been provisioned yet");return this._objectIds}get partitionIds(){if(null==this._partitionIds)throw new Error("partitionIds haven't been provisioned yet");return this._partitionIds}get mapCoordinates(){if(null==this._mapCoordinates)throw new Error("mapCoordinates haven't been provisioned yet");return this._mapCoordinates}get renderCoordinates(){if(null==this._renderCoordinates)throw new Error("renderCoordinates haven't been provisioned yet");return this._renderCoordinates}get tileCenterRenderCoordinates(){if(null==this._tileCenterRenderCoordinates)throw new Error("tileCenterRenderCoordinates hasn't been provisioned yet");return this._tileCenterRenderCoordinates}async provision(t,e){for(const s of t)switch(s){case ba.OBJECT_ID:if(this._objectIds)return;this._objectIds=await Ma(this);break;case ba.PARTITION_ID:if(this._partitionIds)return;this._partitionIds=new Uint32Array(this._numFeatures);break;case ba.GEOMETRY_MAP_COORDINATES:if(this._mapCoordinates)return;this._mapCoordinates=await Ca(this);break;case ba.GEOMETRY_RENDER_COORDINATES:if(this._renderCoordinates)return;this._renderCoordinates=await Aa(this,e);break;case ba.TILE_CENTER_RENDER_COORDINATES:if(this._tileCenterRenderCoordinates)return;this._tileCenterRenderCoordinates=await Oa(this,e);break;default:throw new Error("not implemented")}}dispose(){if(this.partitions){for(const t of this.partitions)t.dispose();this.partitions=void 0}}}function _a(t=Nt,e,s,i=1){const n=new Array(3);if(null==e||null==s)n[0]=1,n[1]=1,n[2]=1;else{let i,r=0;for(let o=2;o>=0;o--){const a=t[o];let h;const c=null!=a,l=0===o&&!i&&!c,u=s[o];"symbol-value"===a||l?h=0!==u?e[o]/u:1:c&&"proportional"!==a&&isFinite(a)&&(h=0!==u?a/u:1),null!=h&&(n[o]=h,i=h,r=Math.max(r,Math.abs(h)))}for(let t=2;t>=0;t--)null==n[t]?n[t]=i:0===n[t]&&(n[t]=.001*r)}for(let t=2;t>=0;t--)n[t]/=i;return Xt(n)}function Pa(t){const e=new Map;for(const[s,i]of t)e.set(s,{...i,indices:Me(i.indices)});return e}var Ta;!function(t){function e(t,e){const s=t[e],i=t[e+1],n=t[e+2];return Math.sqrt(s*s+i*i+n*n)}function s(t,e){const s=t[e],i=t[e+1],n=t[e+2],r=1/Math.sqrt(s*s+i*i+n*n);t[e]*=r,t[e+1]*=r,t[e+2]*=r}function i(t,e,s){t[e]*=s,t[e+1]*=s,t[e+2]*=s}function n(t,e,s,i,n,r=e){(n=n||t)[r]=t[e]+s[i],n[r+1]=t[e+1]+s[i+1],n[r+2]=t[e+2]+s[i+2]}function r(t,e,s,i,n,r=e){(n=n||t)[r]=t[e]-s[i],n[r+1]=t[e+1]-s[i+1],n[r+2]=t[e+2]-s[i+2]}t.length=e,t.normalize=s,t.scale=i,t.add=n,t.subtract=r}(Ta||(Ta={}));const Ra=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)Ra[6*t+e]=t;const ja=new Array(36);for(let t=0;t<6;t++)ja[6*t]=0,ja[6*t+1]=1,ja[6*t+2]=2,ja[6*t+3]=2,ja[6*t+4]=3,ja[6*t+5]=0;const Ia=Ri(-.5,0,-.5),Fa=Ri(.5,0,-.5),za=Ri(0,0,.5),Da=Ri(0,.5,0),Ea=ji(),Ga=ji(),Va=ji(),Ua=ji(),La=ji();S(Ea,Ia,Da),S(Ga,Ia,Fa),Q(Va,Ea,Ga),J(Va,Va),S(Ea,Fa,Da),S(Ga,Fa,za),Q(Ua,Ea,Ga),J(Ua,Ua),S(Ea,za,Da),S(Ga,za,Ia),Q(La,Ea,Ga),J(La,La);function Ha(t,e,s,i,n=!0,r=!0){let o=0;const a=e,h=t;let c=Ri(0,o,0),l=Ri(0,o+h,0),u=Ri(0,-1,0),d=Ri(0,1,0);i&&(o=h,l=Ri(0,0,0),c=Ri(0,o,0),u=Ri(0,1,0),d=Ri(0,-1,0));const f=[l,c],p=[u,d],m=s+2,g=Math.sqrt(h*h+a*a);if(i)for(let t=s-1;t>=0;t--){const e=t*(2*Math.PI/s),i=Ri(Math.cos(e)*a,o,Math.sin(e)*a);f.push(i);const n=Ri(h*Math.cos(e)/g,-a/g,h*Math.sin(e)/g);p.push(n)}else for(let t=0;t<s;t++){const e=t*(2*Math.PI/s),i=Ri(Math.cos(e)*a,o,Math.sin(e)*a);f.push(i);const n=Ri(h*Math.cos(e)/g,a/g,h*Math.sin(e)/g);p.push(n)}const w=new Array,v=new Array;if(n){for(let t=3;t<f.length;t++)w.push(1),w.push(t-1),w.push(t),v.push(0),v.push(0),v.push(0);w.push(f.length-1),w.push(2),w.push(1),v.push(0),v.push(0),v.push(0)}if(r){for(let t=3;t<f.length;t++)w.push(t),w.push(t-1),w.push(0),v.push(t),v.push(t-1),v.push(1);w.push(0),w.push(2),w.push(f.length-1),v.push(1),v.push(2),v.push(p.length-1)}const y=_s(3*m);for(let t=0;t<m;t++)y[3*t]=f[t][0],y[3*t+1]=f[t][1],y[3*t+2]=f[t][2];const x=_s(3*m);for(let t=0;t<m;t++)x[3*t]=p[t][0],x[3*t+1]=p[t][1],x[3*t+2]=p[t][2];return[[Vs.POSITION,new Ii(y,w,3,!0)],[Vs.NORMAL,new Ii(x,v,3,!0)]]}function Ba(t,e){const s=(t,s,i=!1)=>({levels:t.map((t=>{const n=Pa(s(t.tesselation));i&&$a(n);return{components:[{attributes:n,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:t.minScreenSpaceRadius}}))});switch(t){case"cone":return s(Na,(t=>Ha(1,.5,t,!1)),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function $a(t){const e=t,s=e.get(Vs.POSITION).data,i=e.get(Vs.NORMAL).data;if(i){const e=ka(t,Vs.NORMAL).data;for(let t=0;t<i.length;t+=3){const s=i[t+1];e[t+1]=-i[t+2],e[t+2]=s}}if(s){const e=ka(t,Vs.POSITION).data;for(let t=0;t<s.length;t+=3){const i=s[t+1];e[t+1]=-s[t+2],e[t+2]=i}}}function ka(t,e){let s=t.get(e);return s&&!s.exclusive&&(s={...s,exclusive:!0,data:Ps(s.data)},t.set(e,s)),s}const Na=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];let qa=class extends i{constructor(t){super(),this._context=t,this.lodRendererId=null,this._loaded=!1}get loaded(){return this._loaded}async load(t){const e=t.createMaterial("default"),s=Ba("cone",e);this.lodRendererId=t.createLodRenderer(s),this._loaded=!0}async add(t,e){if(null==this.lodRendererId)throw new Error("expected lod renderer id to not be null");await this._provisionFeatureData(t);const s=t.numFeatures,i=!0,n=te(ee("cone")),r=Xt(Qt(n)),o=Xt(Jt(r,{isPrimitive:i,width:100,depth:null,height:null})),a=new Float64Array(16*s),h=new Float64Array(16*s),c=t.mapCoordinates;for(let t=0;t<s;++t){const e=t,s=c[3*t+0],i=c[3*t+1],n=c[3*t+2],l=this._computeGlobalTransform(s,i,n,this._context.viewSpatialReference,Xa),u=this._computeLocalTransform(o,r,Wa);this._writeMatrixToTypedBuffer(a,e,u),this._writeMatrixToTypedBuffer(h,e,l)}const l={featureIds:new Uint32Array(t.objectIds),localTransforms:a,globalTransforms:h};e.addLodInstances(this.lodRendererId,l)}async remove(t,e){if(null==this.lodRendererId)return;const s=new Uint32Array(t.objectIds);e.removeLodInstances(this.lodRendererId,s)}async _provisionFeatureData(t){await t.provision([ba.GEOMETRY_MAP_COORDINATES,ba.OBJECT_ID],this._context)}_writeMatrixToTypedBuffer(t,e,s){let i=16*e;for(let e=0;e<16;e++)t[i++]=s[e]}_computeGlobalTransform(t,e,s,i,n){return Ya[0]=t,Ya[1]=e,Ya[2]=s,Ti(i,Ya,n,this._context.renderSpatialReference),n}_computeLocalTransform(t,e,s){return Zt(s),this._applyObjectScale(t,e,s),s}_applyObjectScale(t,e,s){const i=_a(t,t,e,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||Kt(s,s,i)}};qa=t([s("esri.views.3d.layers.graphics.pipeline.symbolization.TestObjectSymbol")],qa);const Ya=d(),Wa=Ds(),Xa=Ds();let Qa=class extends i{constructor(t){super(),this._context=t,this.materialId=null,this._loaded=!1}get loaded(){return this._loaded}async load(t){this.materialId=t.createMaterial("hud"),t.createDirectRenderer(this.materialId),this._loaded=!0}async add(t,e){if(null==this.materialId)throw new Error("expected material not to be null");await this._provisionFeatureData(t);const{numFeatures:s,tileId:i,renderCoordinates:n,tileCenterRenderCoordinates:r}=t,o=new Float64Array([0,0,1]),a=new Float64Array([255,255,255,255]),h=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),l=new Float64Array([0,0]),u=new Float64Array([0]),d=new Uint32Array(s);for(let t=0;t<s;++t)d[t]=t;const f=new Uint32Array(s);for(let t=0;t<s;++t)f[t]=0;const p=new Ii(n,d,3,!0),m=new Ii(o,f,3,!0),g=new Ii(l,f,2,!0),w=new Ii(a,f,4,!0),v=new Ii(u,f,1,!0),y=new Ii(h,f,2,!0),x=new Ii(c,f,4,!0),b=[[Vs.POSITION,p],[Vs.NORMAL,m],[Vs.UV0,g],[Vs.COLOR,w],[Vs.ROTATION,v],[Vs.SIZE,y],[Vs.CENTEROFFSETANDDISTANCE,x]],M={attributes:Pa(b),objectAndLayerIdColor:void 0,transformation:Ds(),materialId:this.materialId};e.addDirectRendererGeometry(i,M,r)}async remove(t,e){e.removeDirectRendererGeometry(t.tileId)}async _provisionFeatureData(t){await t.provision([ba.GEOMETRY_RENDER_COORDINATES,ba.TILE_CENTER_RENDER_COORDINATES],this._context)}};Qa=t([s("esri.views.3d.layers.graphics.pipeline.symbolization.TestSymbol")],Qa);class Ja{constructor(t){this._symbols=new Map,this._context=t}async load(){this._symbols.set(0,new Qa(this._context)),this._symbols.set(1,new qa(this._context))}async add(t,e){await this._provisionFeatureData(t,this._context);const s=this._partition(t);await Promise.all(s.map((async t=>{const s=await this._provisionSymbol(t.partitionInfo?.index,e);s&&await s.add(t,e)})))}async remove(t,e){const s=t.partitions;if(!s)throw new Error("partitioned featureset expected");await Promise.all(s.map((async t=>{const s=await this._provisionSymbol(t.partitionInfo?.index,e);s&&await s.remove(t,e)})))}async _provisionFeatureData(t,e){await t.provision([ba.PARTITION_ID,ba.OBJECT_ID],e)}async _provisionSymbol(t,e){if(null==t)return null;const s=this._symbols.get(t);return s?(s.loaded||await s.load(e),s):null}_partition(t){const{numFeatures:e,objectIds:s,partitionIds:i}=t,n=[[],[]];for(let t=0;t<e;++t){const e=s[t]%2;n[e].push(t),i[t]=e}return t.partitions=n.filter((t=>t.length>0)).map(((e,s)=>{const i=e.length,n={index:s,tileIndices:new Uint32Array(e)};return new Sa(t.tile,i,n)})),t.partitions}}function Za(t,e,s){return!!Pi(t,e,Ka,s.spatialReference)&&(s.x=Ka[0],s.y=Ka[1],s.z=Ka[2],!0)}const Ka=d();function th(t){const{value:e,operations:s}=t;return{operations:s,value:s.create(e)}}function eh(t,e,s){return t.operations.setExtent(t.value,e,s.value),s}function sh(t,e){return t.operations.getExtent(t.value,e),e}function ih(t){return{operations:t,value:t.create()}}function nh(t,e,s=ih(t)){return s.operations=t,t.copy(e,s.value),s}function rh(t){return nh(Qs,Xs(0,0,0,ie(t).radius))}const oh=2**50;function ah(){return nh(wi,gi([0,0,0],[oh,0,0],[0,oh,0]))}function hh(t,e,s){return t.operations.axisAt(t.value,e,se.Z,s)}function ch(t,e,s,i){return t.operations.axisAt(t.value,e,s,i)}function lh(t,e,s){return t.operations.intersectRay(t.value,e,s)}function uh(t,e,s){return t.operations.intersectRayClosestSilhouette(t.value,e,s)}function dh(t,e){return t.operations.altitudeAt(t.value,e)}function fh(t,e,s,i){return t.operations.setAltitudeAt(t.value,e,s,i)}function ph(t,e,s,i){return e!==i&&b(i,e),_(gh,i[12],i[13],i[14]),fh(t,gh,s,gh),i[12]=gh[0],i[13]=gh[1],i[14]=gh[2],i}function mh(t,e,s){return t.operations.elevate(t.value,e,s.value)}const gh=d();function wh(t){return"point"===t.type}class vh{constructor(t,e,s,i){this.viewingMode=t,this.spatialReference=e,this.unitInMeters=s,this._coordinateSystem=i,this._tmpCoordinateSystem=th(i),this.referenceEllipsoid=ie(e),this.sphericalPCPF=Fi(e)}set extent(t){t&&eh(this._coordinateSystem,t,this._coordinateSystem)}get extent(){return sh(this._coordinateSystem,Vt())}getAltitude(t){return dh(this._coordinateSystem,t)}setAltitude(t,e,s=t){return fh(this._coordinateSystem,s,e,t)}setAltitudeOfTransformation(t,e){ph(this._coordinateSystem,e,t,e)}worldUpAtPosition(t,e){return hh(this._coordinateSystem,t,e)}worldBasisAtPosition(t,e,s){return ch(this._coordinateSystem,t,e,s)}basisMatrixAtPosition(t,e){const s=this.worldBasisAtPosition(t,se.X,ti.get()),i=this.worldBasisAtPosition(t,se.Y,ti.get()),n=this.worldBasisAtPosition(t,se.Z,ti.get());return ne(e,s[0],s[1],s[2],0,i[0],i[1],i[2],0,n[0],n[1],n[2],0,0,0,0,1),e}headingAtPosition(t,e){const s=this.worldUpAtPosition(t,ti.get()),i=this.worldBasisAtPosition(t,se.Y,ti.get()),n=ei(e,i,s);return re(n)}intersectManifoldClosestSilhouette(t,e,s){return mh(this._coordinateSystem,e,this._tmpCoordinateSystem),uh(this._tmpCoordinateSystem,t,s),s}intersectManifold(t,e,s){mh(this._coordinateSystem,e,this._tmpCoordinateSystem);const i=ti.get();return lh(this._tmpCoordinateSystem,t,i)?E(s,i):null}intersectInfiniteManifold(t,e,s){if(this.viewingMode===Y.Global)return this.intersectManifold(t,e,s);mh(this._coordinateSystem,e,this._tmpCoordinateSystem);const i=this._tmpCoordinateSystem.value,n=ti.get();return si(i.plane,t,n)?E(s,n):null}toRenderCoords(t,e,s){return wh(t)?zi(t,e,this.spatialReference):Pi(t,e,s,this.spatialReference)}fromRenderCoords(t,e,s=null){return wh(e)?(null!=s&&(e.spatialReference=s),Za(t,this.spatialReference,e)?e:null):Pi(t,this.spatialReference,e,s)?e:null}static create(t,e){switch(t){case Y.Local:return new vh(Y.Local,e,oe(e),ah());case Y.Global:return new vh(Y.Global,e,1,rh(e))}}static renderUnitScaleFactor(t,e){return ae(t)/ae(e)}}class yh{constructor(t){this._tileFeatureData=new Map,this._context={viewSpatialReference:t.viewSpatialReference,renderSpatialReference:t.renderSpatialReference,renderCoordsHelper:vh.create(t.viewingMode,t.renderSpatialReference)}}async add(t,e){this._featureRenderer||(this._featureRenderer=new Ja(this._context),await this._featureRenderer.load());const s=this._addTileFeatureData(t);await this._featureRenderer.add(s,e)}async remove(t,e){const s=this._getFeatureSetFromTileId(t);s&&(this._featureRenderer&&this._featureRenderer.remove(s,e),this._removeTileFeatureData(t))}_getFeatureSetFromTileId(t){return this._tileFeatureData.get(t)}_addTileFeatureData(t){const e=t.descriptor.id,s=t.pages.reduce(((t,{featureCount:e})=>t+e),0),i=new Sa(t,s);return this._tileFeatureData.set(e,i),i}_removeTileFeatureData(t){const e=this._tileFeatureData.get(t);e&&(e.dispose(),this._tileFeatureData.delete(t))}}let xh=class extends a.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new Li,this._tileManager=new Gi({addTile:(t,e)=>this._addTile(t,e),removeTiles:t=>this._removeTiles(t)}),this._renderCommandContext=null,this._fetcher=null,this._symbolizer=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager.destroy()}async setup({viewSpatialReference:t,renderSpatialReference:e,viewingMode:s,baseQuery:i,url:n,objectIdField:r,capabilities:o,fieldsIndex:a,timeInfo:h}){this._renderCommandContext=new xa({viewingMode:s,dispatchRenderCommandsCallback:(t,e)=>this.remoteClient.invoke("dispatchRenderCommands",t,{transferList:e})});const c=he.fromJSON(t),l=he.fromJSON(e);return this._fetcher=new tn(c,ce.fromJSON(i),n,r,o),this._symbolizer=new yh({viewSpatialReference:c,renderSpatialReference:l,viewingMode:s}),this._queryEngine=new de({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:r,fieldsIndex:a,availableFields:[r],spatialReference:t,featureStore:this._featureStore,timeInfo:h}),this._defaultQueryJSON=new ce({outSpatialReference:c}).toJSON(),this.addHandles(le((()=>this.updating),(async t=>{this.emit("notify-updating",{updating:t})})),ue),Mh}async executeQuery(t,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(t),e)}}async executeQueryForIds(t,e){const s=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(t),e);return{result:Array.from(s)}}async executeQueryForCount(t,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(t),e)}}async executeQueryForExtent(t,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(t),e)}}async executeQueryForLatestObservations(t,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(t),e)}}async onTileTreeChange(t){return await this._tileManager.onTileTreeChange(t),Mh}async _addTile(t,e){const s=await this._fetcher.fetch(t,e);o(e),this._featureStore.addTile(s);const i=this._renderCommandContext.createEncoder();return await this._symbolizer.add(s,i),await i.dispatch(),s}async _removeTiles(t){const e=this._renderCommandContext.createEncoder(),s=this._featureStore,i=this._symbolizer;for(const n of t)s.removeTile(n.tileId),await i.remove(n.tileId,e);await e.dispatch()}_ensureQuery(t){return t??this._defaultQueryJSON}};t([e()],xh.prototype,"updating",null),xh=t([s("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],xh);const bh=xh,Mh={result:void 0};const Ch=Object.freeze({__proto__:null,default:bh});export{Po as E,Ch as F,Oo as L,So as T};
//# sourceMappingURL=p-4f0eb56b.js.map