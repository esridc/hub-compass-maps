{"version":3,"names":["async","s","e","r","n","a","t","o","sceneServerUrl","url","path","layerId","sublayer","sceneLayerItem","l","f","replace","i","y","featureServiceItem","portalItem","c","serviceItemId","id","apiKey","u","portal","load","signal","rootDocument","query","customParameters","token","responseType","data","findServerInfo","owningSystemUrl","serverUrl","fetchData","layers","tables","authMode","m","catch","p","d","Promise","all","v","w","Array","isArray","Error","Math","min","length","fetchRelatedItems","relationshipType","direction","find","type"],"sources":["./node_modules/@arcgis/core/layers/support/associatedFeatureServiceUtils.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nimport{id as e}from\"../../kernel.js\";import r from\"../../request.js\";import t from\"../../core/Error.js\";import{throwIfAbortError as n}from\"../../core/promiseUtils.js\";import{parse as a}from\"./arcgisLayerUrl.js\";import o from\"../../portal/Portal.js\";import i from\"../../portal/PortalItem.js\";async function s(e,r){const n=a(e);if(!n)throw new t(\"invalid-url\",\"Invalid scene service url\");const o={...r,sceneServerUrl:n.url.path,layerId:n.sublayer??void 0};if(o.sceneLayerItem??=await l(o),null==o.sceneLayerItem)return f(o.sceneServerUrl.replace(\"/SceneServer\",\"/FeatureServer\"),o);const i=await y(o);if(!i?.url)throw new t(\"related-service-not-found\",\"Could not find feature service through portal item relationship\");o.featureServiceItem=i;const s=await f(i.url,o);return s.portalItem=i,s}async function l(e){const r=(await c(e)).serviceItemId;if(!r)return null;const t=new i({id:r,apiKey:e.apiKey}),a=await u(e);null!=a&&(t.portal=new o({url:a}));try{return t.load({signal:e.signal})}catch(s){return n(s),null}}async function c(e){if(e.rootDocument)return e.rootDocument;const t={query:{f:\"json\",...e.customParameters,token:e.apiKey},responseType:\"json\",signal:e.signal};try{const n=await r(e.sceneServerUrl,t);e.rootDocument=n.data}catch{e.rootDocument={}}return e.rootDocument}async function u(t){const a=e?.findServerInfo(t.sceneServerUrl);if(a?.owningSystemUrl)return a.owningSystemUrl;const o=t.sceneServerUrl.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const e=(await r(o,{query:{f:\"json\"},responseType:\"json\",signal:t.signal})).data.owningSystemUrl;if(e)return e}catch(i){n(i)}return null}async function f(e,n){const o=a(e);if(!o)throw new t(\"invalid-feature-service-url\",\"Invalid feature service url\");const i=o.url.path,s=n.layerId;if(null==s)return{serverUrl:i};const l=c(n),u=n.featureServiceItem?await n.featureServiceItem.fetchData(\"json\"):null,f=(u?.layers?.[0]||u?.tables?.[0])?.customParameters,y=e=>{const t={query:{f:\"json\",...f},responseType:\"json\",authMode:e,signal:n.signal};return r(i,t)},m=y(\"anonymous\").catch((()=>y(\"no-prompt\"))),[p,d]=await Promise.all([m,l]),v=d?.layers,w=p.data&&p.data.layers;if(!Array.isArray(w))throw new Error(\"expected layers array\");if(Array.isArray(v))for(let r=0;r<Math.min(v.length,w.length);r++){if(v[r].id===s)return{serverUrl:i,layerId:w[r].id}}else if(null!=s&&s<w.length)return{serverUrl:i,layerId:w[s].id};throw new Error(\"could not find matching associated sublayer\")}async function y({sceneLayerItem:e,signal:r}){if(!e)return null;try{const t=(await e.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:r})).find((e=>\"Feature Service\"===e.type))||null;if(!t)return null;const n=new i({portal:t.portal,id:t.id});return await n.load(),n}catch(t){return n(t),null}}export{s as findAssociatedFeatureService};\n"],"mappings":"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"}