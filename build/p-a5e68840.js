import{T as t,aa as e,e as s,eM as i,iU as n,px as r,rx as l,X as a,je as h,bb as u,ik as o,hQ as c,aG as f,U as d,g as w,hI as y,oM as g,i$ as p,i5 as m,iP as S,S as I,t as F}from"./p-aad64c9f.js";import{ad as _,K as T,ae as b}from"./p-63562f76.js";import{C as R,t as A,g as E,s as O,a as v,p as N,f as D,T as x,h as k,L as C,I as G,A as P,S as U,E as M,F as L,D as B,m as j,O as V,w as q,b as W,c as Z,d as Q}from"./p-cf77d7c5.js";import{N as K,s as J,y as $,l as X,f as z,d as H,F as Y,g as tt,T as et,D as st,J as it,k as nt,M as rt,j as lt}from"./p-7950bc60.js";import{Z as at,n as ht,a as ut,r as ot,u as ct}from"./p-cea3971b.js";import{c as ft,a as dt,n as wt}from"./p-4295487d.js";import{N as yt,h as gt}from"./p-448d8eb2.js";class pt{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(t,e,s){this._layerById[e]=s,this._layerByName[t]=s}async featureSetByName(t,e=!0,s=["*"]){return void 0===this._layerByName[t]?null:this._layerByName[t]}async featureSetById(t,e=!0,s=["*"]){return void 0===this._layerById[t]?null:this._layerById[t]}castToText(t=!1){return"object, FeatureSetCollection"}}class mt extends R{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=t.parentfeatureset,t.whereclause instanceof at?(this._whereclause=t.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=t.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new t({wkid:4326}),this.geometryType=K.point)}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._parent._getFilteredSet("",null,this._whereclause,null,t);return this._checkCancelled(t),null!==this._whereClauseFunction?this._wset=new A(e._candidates.slice().concat(e._known.slice()),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):this._wset=new A(e._candidates.slice(),e._known.slice(),e._ordered,this._clonePageDefinition(e.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(t){let e=this._parent?._isInFeatureSet(t);return e===J.NotInFeatureSet?e:(e=this._idstates[t],void 0===e?J.Unknown:e)}_getFeature(t,e,s){return this._parent._getFeature(t,e,s)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){return this._parent._featureFromCache(t)}executeWhereClause(t){return this._whereclause?.testFeature(t)??!1}async executeWhereClauseDeferred(t){if(null!==this._whereClauseFunction){const e=this._whereClauseFunction(t);return e}return this.executeWhereClause(t)}async _fetchAndRefineFeatures(t,e,s){const i=new A([],t,!1,null),n=Math.min(e,t.length);if(await(this._parent?._getFeatures(i,-1,n,s)),this._checkCancelled(s),null==this._whereClauseFunction){for(let e=0;e<n;e++){const s=this._parent?._featureFromCache(t[e]);!0===this.executeWhereClause(s)?this._idstates[t[e]]=J.InFeatureSet:this._idstates[t[e]]=J.NotInFeatureSet}return"success"}const r=[];for(let e=0;e<n;e++){const s=this._parent?._featureFromCache(t[e]);r.push(await this.executeWhereClauseDeferred(s))}for(let s=0;s<e;s++)!0===r[s]?this._idstates[t[s]]=J.InFeatureSet:this._idstates[t[s]]=J.NotInFeatureSet;return"success"}async _getFilteredSet(t,e,s,i,n){null!==this._whereClauseFunction||(null!==s?null!==this._whereclause&&(s=E(this._whereclause,s)):s=this._whereclause),await this._ensureLoaded();const r=await this._parent._getFilteredSet(t,e,s,i,n);let l;return this._checkCancelled(n),l=null!==this._whereClauseFunction?new A(r._candidates.slice().concat(r._known.slice()),[],r._ordered,this._clonePageDefinition(r.pagesDefinition)):new A(r._candidates.slice(),r._known.slice(),r._ordered,this._clonePageDefinition(r.pagesDefinition)),l}async _stat(t,e,s,i,n,r,l){if(null!==this._whereClauseFunction)return null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1};let a=this._whereclause;null!==n&&null!==this._whereclause&&(a=E(this._whereclause,n));const h=await this._parent._stat(t,e,s,i,a,r,l);return!1===h.calculated?null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1}:h}async _canDoAggregates(t,e,s,i,n){return null===this._whereClauseFunction&&(null!==n?null!==this._whereclause&&(n=E(this._whereclause,n)):n=this._whereclause,null!==this._parent&&this._parent._canDoAggregates(t,e,s,i,n))}async _getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l){if(null===this._parent)throw new O(v.NeverReach);return null!==n?null!==this._whereclause&&(n=E(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l)}static registerAction(){R._featuresetFunctions.filter=function(t){if("function"==typeof t)return new mt({parentfeatureset:this,whereclause:t});let e=null;return t instanceof at&&(e=t),new mt({parentfeatureset:this,whereclause:e})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}class St{constructor(t){this.field=t,this.sqlRewritable=!1}postInitialization(t,e){}}class It extends St{constructor(t){super(t),this.sqlRewritable=!0}extractValue(t){return t.attributes[this.field.name]}rewriteSql(t){return{rewritten:this.sqlRewritable,where:t}}}class Ft extends St{constructor(t,e,s){super($(t)),this.originalField=t,this.sqlRewritable=!0,this.field.name=e,this.field.alias=s}rewriteSql(t,e){return{rewritten:this.sqlRewritable,where:N(t,this.field.name,this.originalField.name,e.getFieldsIndex())}}extractValue(t){return t.attributes[this.originalField.name]}}class _t extends St{constructor(t,e,s){super(t),this.codefield=e,this.lkp=s,this.reverseLkp={};for(const t in s)this.reverseLkp[s[t]]=t;this.sqlRewritable=!0}rewriteSql(t,e){const s=this.evaluateNodeToWhereClause(t.parseTree,X.Standardised,this.field.name,this.codefield instanceof at?D(this.codefield,X.Standardised):this.codefield,t.parameters);return s.includes(_t.BADNESS)?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:at.create(s,{fieldsIndex:e._parent.getFieldsIndex(),timeZone:e.dateFieldsTimeZoneDefaultUTC})}}evaluateNodeToWhereClause(t,e,s=null,i=null,n){let r,l,a,h;switch(t.type){case"interval":return L(this.evaluateNodeToWhereClause(t.value,e,s,i,n),t.qualifier,t.op);case"case-expression":{let i=" CASE ";"simple"===t.format&&(i+=this.evaluateNodeToWhereClause(t.operand,e,s,_t.BADNESS,n));for(let r=0;r<t.clauses.length;r++)i+=" WHEN "+this.evaluateNodeToWhereClause(t.clauses[r].operand,e,s,_t.BADNESS,n)+" THEN "+this.evaluateNodeToWhereClause(t.clauses[r].value,e,s,_t.BADNESS,n);return null!==t.else&&(i+=" ELSE "+this.evaluateNodeToWhereClause(t.else,e,s,_t.BADNESS,n)),i+=" END ",i}case"parameter":{const s=n[t.value.toLowerCase()];if("string"==typeof s)return"'"+s.toString().replaceAll("'","''")+"'";if(z(s))return G(s,e);if(H(s))return G(s,e);if(Y(s))return P(s,e);if(tt(s))return U(s,e);if(et(s))return M(s,e);if(Array.isArray(s)){const t=[];for(let i=0;i<s.length;i++)"string"==typeof s[i]?t.push("'"+s[i].toString().replaceAll("'","''")+"'"):z(s[i])||H(s[i])?t.push(G(s[i],e)):Y(s[i])?t.push(P(s[i],e)):tt(s[i])?t.push(U(s[i],e)):et(s[i])?t.push(M(s[i],e)):t.push(s[i].toString());return t}return s.toString()}case"expression-list":l=[];for(const r of t.value)l.push(this.evaluateNodeToWhereClause(r,e,s,i,n));return l;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(t.expr,e,s,_t.BADNESS,n)+" ) ";case"binary-expression":switch(t.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" AND "+this.evaluateNodeToWhereClause(t.right,e,s,i,n)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" OR "+this.evaluateNodeToWhereClause(t.right,e,s,i,n)+") ";case"IS":if("null"!==t.right.type)throw new ht(ut.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IS NULL )";case"ISNOT":if("null"!==t.right.type)throw new ht(ut.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IS NOT NULL )";case"IN":if(r=[],"expression-list"===t.right.type){if("column-reference"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}r.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+r.join(",")+")) "}return r=this.evaluateNodeToWhereClause(t.right,e,s,i,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+r.join(",")+")) "}return h=this.evaluateNodeToWhereClause(t.right,e,s,i,n),Array.isArray(h)?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+h+")) ";case"NOT IN":if(r=[],"expression-list"===t.right.type){if("column-reference"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}r.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+r.join(",")+")) "}return r=this.evaluateNodeToWhereClause(t.right,e,s,i,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+r.join(",")+")) "}return h=this.evaluateNodeToWhereClause(t.right,e,s,i,n),Array.isArray(h)?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+h+")) ";case"BETWEEN":return a=this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" BETWEEN "+a[0]+" AND "+a[1]+" ) ";case"NOTBETWEEN":return a=this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" NOT BETWEEN "+a[0]+" AND "+a[1]+" ) ";case"LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)+") ";case"NOT LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)+") ";case"<>":case"=":if("column-reference"===t.left.type&&"string"===t.right.type){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[t.right.value.toString()])return" ("+i+" "+t.operator+" "+this.lkp[t.right.value.toString()].toString()+") "}else if("column-reference"===t.right.type&&"string"===t.left.type&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[t.right.value.toString()].toString()+" "+t.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,_t.BADNESS,n)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,_t.BADNESS,n)+") "}case"null":return"null";case"boolean":return!0===t.value?"1":"0";case"string":return"'"+t.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${t.value}'`;case"date":return`date '${t.value}'`;case"time":return`time '${t.value}'`;case"number":return t.value.toString();case"current-time":return C(t.mode,e);case"current-user":return"CURRENT_USER";case"column-reference":return s&&s.toLowerCase()===t.column.toLowerCase()?"("+i+")":k(t.column);case"data-type":return t.value;case"function":{const i=this.evaluateNodeToWhereClause(t.args,e,s,_t.BADNESS,n);return x(t.name,i,e)}}throw new ht(ut.UnsupportedSyntax,{node:t.type})}extractValue(t){return this.codefield instanceof at?this.reverseLkp[at.convertValueToStorageFormat(this.codefield.calculateValueCompiled(t))]:this.reverseLkp[t.attributes[this.codefield]]}}_t.BADNESS="_!!!_BAD_LKP_!!!!";class Tt extends St{constructor(t,e){super(t),this._sql=e}rewriteSql(t,e){return{rewritten:!0,where:N(t,this.field.name,D(this._sql,X.Standardised),e.getFieldsIndex())}}extractValue(t){return at.convertValueToStorageFormat(this._sql.calculateValueCompiled(t),this.field.type)}}class bt extends R{static findField(t,e){for(const s of t)if(s.name.toLowerCase()===e.toString().toLowerCase())return s;return null}constructor(t){super(t),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=t.extraFilter,this._parent=t.parentfeatureset,this._maxProcessing=30,this.adaptedFields=t.adaptedFields}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new t({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=K.point,this.typeIdField="",this.types=null,this.subtypeField=null,this.subtypes=null),this.fields=[];for(const t of this.adaptedFields)t.postInitialization(this,this._parent),this.fields.push(t.field)}async _getSet(t){if(null===this._wset){await this._ensureLoaded();let s=null;return s=this._extraFilter?await this._getFilteredSet("",null,null,null,t):await(this._parent?._getSet(t)),this._checkCancelled(t),e(s),this._wset=new A(s._candidates.slice(),s._known.slice(),s._ordered,this._clonePageDefinition(s.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}async _getFeatures(t,e,i,n){const r=[];-1!==e&&void 0===this._featureCache[e]&&r.push(e);const l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,l))return await this._expandPagedSet(t,l,0,0,n),this._getFeatures(t,e,i,n);let a=0;for(let s=t._lastFetchedIndex;s<t._known.length&&(a++,a<=i&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[s]]&&(t._known[s]!==e&&r.push(t._known[s]),r.length>=l)));s++);if(0===r.length)return"success";t=new A([],r,t._ordered,null);const h=Math.min(r.length,i);await(this._parent?._getFeatures(t,-1,h,n)),this._checkCancelled(n);const u=[];for(let t=0;t<h;t++){const e=this._parent?._featureFromCache(r[t]);void 0!==e&&u.push({geometry:e.geometry,attributes:e.attributes,id:r[t]})}for(const t of u){const e=[];for(const s of this.adaptedFields)e[s.field.name]=s.extractValue(t);this._featureCache[t.id]=new s({attributes:e,geometry:ft(t.geometry)})}return"success"}async _fetchAndRefineFeatures(){throw new O(v.NeverReach)}async _getFilteredSet(t,e,s,i,n){let r=!1;const l=this._reformulateWithoutAdaptions(s);r=l.cannot,s=l.where;let a=!1;if(null!==i){a=!0;const t=[];for(const e of this.adaptedFields)if(!(e instanceof It)&&!0===i.scanForField(e.field.name)){if(!(e instanceof Ft)){i=null,a=!1;break}t.push({field:e.field.name,newfield:e.originalField.name})}i&&t.length>0&&(i=i.replaceFields(t))}null!==s?null!==this._extraFilter&&(s=E(this._extraFilter,s)):s=this._extraFilter,await this._ensureLoaded();const h=await this._parent._getFilteredSet(t,e,s,i,n);let u;return this._checkCancelled(n),u=!0===r?new A(h._candidates.slice().concat(h._known.slice()),[],!0===a&&h._ordered,this._clonePageDefinition(h.pagesDefinition)):new A(h._candidates.slice(),h._known.slice(),!0===a&&h._ordered,this._clonePageDefinition(h.pagesDefinition)),u}_reformulateWithoutAdaptions(t){const e={cannot:!1,where:t};if(null!==t)for(const s of this.adaptedFields)if(!0===B(t,s.field.name)){const i=s.rewriteSql(t,this);if(!0!==i.rewritten){e.cannot=!0,e.where=null;break}e.where=i.where}return e}async _stat(t,e,s,i,n,r,l){let a=!1,h=this._reformulateWithoutAdaptions(e);if(a=h.cannot,e=h.where,h=this._reformulateWithoutAdaptions(n),a=a||h.cannot,null!==(n=h.where)?null!==this._extraFilter&&(n=E(this._extraFilter,n)):n=this._extraFilter,!0===a)return null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1};const u=await this._parent._stat(t,e,s,i,n,r,l);return!1===u.calculated?null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1}:u}async _canDoAggregates(t,e,s,i,n){if(null===this._parent)return!1;for(let e=0;e<t.length;e++)for(const s of this.adaptedFields)if(t[e].toLowerCase()===s.field.name.toLowerCase()&&!(s instanceof It))return!1;const r=[];for(let t=0;t<e.length;t++){const s=e[t];if(null!==s.workingexpr){const t=this._reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)return!1;const e=s.clone();e.workingexpr=t.where,r.push(e)}else r.push(s)}const l=this._reformulateWithoutAdaptions(n);return!l.cannot&&(null!==(n=l.where)?null!==this._extraFilter&&(n=E(this._extraFilter,n)):n=this._extraFilter,this._parent._canDoAggregates(t,r,s,i,n))}async _getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l){if(null===this._parent)throw new O(v.NeverReach);const a=[];for(let t=0;t<e.length;t++){const s=e[t];if(null!==s.workingexpr){const t=this._reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)throw new O(v.NeverReach);const e=s.clone();e.workingexpr=t.where,a.push(e)}else a.push(s)}const h=this._reformulateWithoutAdaptions(n);if(h.cannot)throw new O(v.NeverReach);return null!==(n=h.where)?null!==this._extraFilter&&(n=E(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(t,a,s,i,n,r,l)}}function Rt(t,e){return t===e?0:null===t?-1:null===e?1:t<e?-1:1}class At{constructor(t){const e=t.split(",");this._fields=[],this._directions=[];for(let t=0;t<e.length;t++){const s=e[t].match(/\S+/g);this._fields.push(s[0]),2===s.length?"asc"===s[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let t="";for(let e=0;e<this._fields.length;e++)0!==e&&(t+=","),t+=this._fields[e],1===this._directions[e]?t+=" ASC":t+=" DESC";return t}order(t){t.sort(((t,e)=>{for(let s=0;s<this._fields.length;s++){const i=this.featureValue(t.feature,this._fields[s],s),n=this.featureValue(e.feature,this._fields[s],s);let r=0;if(r=1===this._directions[s]?Rt(i,n):-1*Rt(i,n),0!==r)return r}return 0}))}scanForField(t){for(let e=0;e<this._fields.length;e++)if(this._fields[e].toLowerCase().trim()===t.toLowerCase().trim())return!0;return!1}replaceFields(t){let e="";for(let s=0;s<this._fields.length;s++){0!==s&&(e+=",");let i=this._fields[s];for(const e of t)if(i.toLowerCase()===e.field.toLowerCase()){i=e.newfield;break}e+=i,1===this._directions[s]?e+=" ASC":e+=" DESC"}return new At(e)}featureValue(t,e,s){const i=t.attributes[e];if(void 0!==i)return i;for(const i in t.attributes)if(e.toLowerCase()===i.toLowerCase())return this._fields[s]=i,t.attributes[i];return null}}class Et extends R{constructor(t){super(t),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=t.orderbyclause,this._parent=t.parentfeatureset}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,this._orderbyclause,t);return this._checkCancelled(t),this._wset=e,this._wset}return this._wset}async manualOrderSet(t,e){const s=await this.getIdColumnDictionary(t,[],-1,e);this._orderbyclause?.order(s);const i=new A([],[],!0,null);for(let t=0;t<s.length;t++)i._known.push(s[t].id);return i}async getIdColumnDictionary(t,e,s,i){if(s<t._known.length-1){const n=this._maxQueryRate();if("GETPAGES"===t._known[s+1])return await _(this._parent._expandPagedSet(t,n,0,0,i)),this.getIdColumnDictionary(t,e,s,i);let r=s+1;const l=[];for(;r<t._known.length&&"GETPAGES"!==t._known[r];)l.push(t._known[r]),r++;s+=l.length;const a=await _(this._parent._getFeatureBatch(l,i));this._checkCancelled(i);for(const t of a)e.push({id:t.attributes[this.objectIdField],feature:t});return this.getIdColumnDictionary(t,e,s,i)}return t._candidates.length>0?(await _(this._refineSetBlock(t,this._maxProcessingRate(),i)),this._checkCancelled(i),this.getIdColumnDictionary(t,e,s,i)):e}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){if(void 0===this._featureCache[t]){const e=this._parent._featureFromCache(t);if(void 0===e)return;return null===e?null:(this._featureCache[t]=e,e)}return this._featureCache[t]}async _fetchAndRefineFeatures(){throw new O(v.NeverReach)}async _getFilteredSet(t,e,s,i,n){await this._ensureLoaded();const r=await this._parent._getFilteredSet(t,e,s,null===i?this._orderbyclause:i,n);this._checkCancelled(n);const l=new A(r._candidates.slice(),r._known.slice(),r._ordered,this._clonePageDefinition(r.pagesDefinition));let a=!0;if(r._candidates.length>0&&(a=!1),!1===l._ordered){let t=await this.manualOrderSet(l,n);return!1===a&&(null===e&&null===s||(t=new A(t._candidates.slice().concat(t._known.slice()),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)))),t}return l}static registerAction(){R._featuresetFunctions.orderBy=function(t){return""===t?this:new Et({parentfeatureset:this,orderbyclause:new At(t)})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}function Ot(t){if("function"===t.parseTree.type){if(0===t.parseTree.args.value.length)return{name:t.parseTree.name,expr:null};if(t.parseTree.args.value.length>1)throw new ht(ut.MissingStatisticParameters);const e=at.create(j(t.parseTree.args.value[0],X.Standardised,t.parameters),{fieldsIndex:t.fieldsIndex,timeZone:t.timeZone,currentUser:t.currentUser});return{name:t.parseTree.name,expr:e}}return null}class vt{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const t=new vt;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,e,s,i){const n=new vt;n.field=t;const r=at.create(e,{fieldsIndex:s,timeZone:i}),l=Ot(r);if(null===l)throw new ht(ut.UnsupportedSqlFunction,{function:""});const a=l.name.toUpperCase().trim();if("MIN"===a){if(n.typeofstat="MIN",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:"min"})}else if("MAX"===a){if(n.typeofstat="MAX",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===a)n.typeofstat="COUNT",n.workingexpr=l.expr;else if("STDEV"===a){if(n.typeofstat="STDDEV",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===a){if(n.typeofstat="SUM",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===a){if(n.typeofstat="AVG",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:a})}else if("AVG"===a){if(n.typeofstat="AVG",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==a)throw new ht(ut.UnsupportedSqlFunction,{function:a});if(n.typeofstat="VAR",n.workingexpr=l.expr,null===r)throw new ht(ut.InvalidFunctionParameters,{function:"var"})}return n}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}function Nt(t){if(!t)return"COUNT";switch(t.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class Dt extends R{constructor(t){super(t),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=t.parentfeatureset,this._config=t}isTable(){return!0}async _getSet(t){if(null===this._wset){const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,this._wset}return this._wset}_isInFeatureSet(){return J.InFeatureSet}_nextUniqueName(t){for(;1===t["T"+this._uniqueIds.toString()];)this._uniqueIds++;const e="T"+this._uniqueIds.toString();return t[e]=1,e}_convertToEsriFieldType(t){return t}_initialiseFeatureSet(){const e={};let s=!1,r=1;const l=this._parent?this._parent.getFieldsIndex():new i([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===s;){let t=!1;for(let e=0;e<this._config.groupbyfields.length;e++)if(this._config.groupbyfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}if(!1===t)for(let e=0;e<this._config.statsfields.length;e++)if(this._config.statsfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}!1===t?s=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}for(const t of this._config.statsfields){const e=new vt;e.field=t.name,e.tofieldname=t.name,e.workingexpr=t.expression instanceof at?t.expression:at.create(t.expression,{fieldsIndex:l,timeZone:this.dateFieldsTimeZoneDefaultUTC}),e.typeofstat=Nt(t.statistic),this._decodedStatsfield.push(e)}this._decodedGroupbyfield=[];for(const t of this._config.groupbyfields){const e={name:t.name,singlefield:null,tofieldname:t.name,expression:t.expression instanceof at?t.expression:at.create(t.expression,{fieldsIndex:l,timeZone:this.dateFieldsTimeZoneDefaultUTC}),sqlType:null};this._decodedGroupbyfield.push(e)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const t of this._parent.fields)e[t.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=""}else this.geometryType=K.point,this.typeIdField="",this.types=null,this.subtypes=null,this.subtypeField="",this.spatialReference=new t({wkid:4326});this.fields=[];const a=new vt;a.field=this._nextUniqueName(e),a.tofieldname=this.objectIdField,a.workingexpr=at.create(this._parent.objectIdField,{fieldsIndex:this._parent.getFieldsIndex(),timeZone:this.dateFieldsTimeZoneDefaultUTC}),a.typeofstat="MIN",this._decodedStatsfield.push(a);for(const t of this._decodedGroupbyfield){const s=new n;if(t.name=this._nextUniqueName(e),s.name=t.tofieldname,s.alias=s.name,V(t.expression)){const e=this._parent.getField(D(t.expression,X.Standardised));if(!e)throw new O(v.AggregationFieldNotFound);t.name=e.name,t.singlefield=e.name,this.phsyicalgroupbyfields.push(e.name),s.type=e.type,t.sqlType=e.type}else{s.type=this._convertToEsriFieldType(q(t.expression,this._parent.fields));const e=new n;e.name=t.name,e.alias=e.name,this.phsyicalgroupbyfields.push(t.name),this._adaptedFields.push(new Tt(e,t.expression)),this._candosimplegroupby=!1,t.sqlType=s.type}this.fields.push(s)}if(this._adaptedFields.length>0)for(const t of this._parent.fields)this._adaptedFields.push(new It(t));for(let t=0;t<this._decodedStatsfield.length;t++){const s=new n;let i=null;const r=this._decodedStatsfield[t];r.field=this._nextUniqueName(e),r.tofieldname===this.objectIdField&&(this._internalObjectIdField=r.field),s.name=r.tofieldname,s.alias=s.name;const l=null!==r.workingexpr&&V(r.workingexpr)?D(r.workingexpr,X.Standardised):"";switch(this._decodedStatsfield[t].typeofstat){case"SUM":if(""!==l){if(i=this._parent.getField(l),!i)throw new O(v.AggregationFieldNotFound);s.type=i.type}else s.type="double";break;case"MIN":case"MAX":if(""!==l){if(i=this._parent.getField(l),!i)throw new O(v.AggregationFieldNotFound);s.type=i.type}else s.type="double";break;case"COUNT":s.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==l&&(i=this._parent.getField(l),!i))throw new O(v.AggregationFieldNotFound);s.type="double"}this.fields.push(s)}}async _canDoAggregates(){return!1}async _getFeatures(t,e,s,i){const n=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(t,n)?(await this._expandPagedSet(t,n,0,0,i),this._getFeatures(t,e,s,i)):"success"}async _getFilteredSet(t,e,s,i,n){if(""!==t)return new A([],[],!0,null);let r=null;const l={ordered:!1,nowhereclause:!1};if(await this._ensureLoaded(),null!==s)for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===B(s,this._decodedStatsfield[t].tofieldname)){l.nowhereclause=!0,s=null;break}if(null!==i){l.ordered=!0;for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===i.scanForField(this._decodedStatsfield[t].tofieldname)){i=null,l.ordered=!1;break}if(null!==i)for(const t of this._decodedGroupbyfield)if(null===t.singlefield&&!0===i.scanForField(t.tofieldname)){i=null,l.ordered=!1;break}}if(!1!==this._candosimplegroupby&&await this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)){let t=null;s&&(t=this._reformulateWhereClauseWithoutGroupByFields(s));let e=null;i&&(e=this._reformulateOrderClauseWithoutGroupByFields(i));const a=await this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,t,e,this._internalObjectIdField);return this._checkCancelled(n),r=!0===l.nowhereclause?new A(a._candidates.slice().concat(a._known.slice()),[],!0===l.ordered&&a._ordered,this._clonePageDefinition(a.pagesDefinition)):new A(a._candidates.slice(),a._known.slice(),!0===l.ordered&&a._ordered,this._clonePageDefinition(a.pagesDefinition)),r}let a=this._parent;if(this._adaptedFields.length>0&&(a=new bt({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===l.nowhereclause)r=new A(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new Et({parentfeatureset:a,orderbyclause:new At(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let t=a;if(null!==s){let e=null;s&&(e=this._reformulateWhereClauseWithoutGroupByFields(s)),t=new mt({parentfeatureset:t,whereclause:e})}r=new A(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new Et({parentfeatureset:t,orderbyclause:new At(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return r}_reformulateWhereClauseWithoutStatsFields(t){for(const e of this._decodedStatsfield)t=N(t,e.tofieldname,D(e.workingexpr,X.Standardised),this._parent.getFieldsIndex());return t}_reformulateWhereClauseWithoutGroupByFields(t){for(const e of this._decodedGroupbyfield)e.tofieldname!==e.name&&(t=N(t,e.tofieldname,D(e.expression,X.Standardised),this._parent.getFieldsIndex()));return t}_reformulateOrderClauseWithoutGroupByFields(t){const e=[];for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&e.push({field:t.tofieldname,newfield:t.name});return e.length>0?t.replaceFields(e):t}_clonePageDefinition(t){return null===t?null:!0===t.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,internal:t.internal}:this._parent._clonePageDefinition(t)}async _refineSetBlock(t,e,s){if(!0===this._checkIfNeedToExpandCandidatePage(t,this._maxQuery))return await this._expandPagedSet(t,this._maxQuery,0,0,s),this._refineSetBlock(t,e,s);this._checkCancelled(s);this._refineKnowns(t,e);return t}_expandPagedSet(t,e,s,i,n){return this._expandPagedSetFeatureSet(t,e,s,i,n)}async _getPhysicalPage(t,e,i){if(!0===t.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(t,t.pagesDefinition.resultRecordCount,i,[]);const n=await this._getAgregagtePhysicalPage(t,e,i);for(const t of n){const e={geometry:t.geometry,attributes:{}},i={};for(const e in t.attributes)i[e.toLowerCase()]=t.attributes[e];for(const t of this._decodedGroupbyfield)e.attributes[t.tofieldname]=i[t.name.toLowerCase()];for(const t of this._decodedStatsfield)e.attributes[t.tofieldname]=i[t.field.toLowerCase()];this._featureCache[e.attributes[this.objectIdField]]=new s(e)}return n.length}_sequentialGetPhysicalItem(t,e,s,i){return new Promise(((n,r)=>{null===t.pagesDefinition.internal.iterator&&(t.pagesDefinition.internal.iterator=t.pagesDefinition.internal.subfeatureset.iterator(s)),!0===t.pagesDefinition.internal.fullyResolved||0===e?n(i.length):this._nextAggregateItem(t,e,s,i,(r=>{null===r?n(i.length):(e-=1,n(this._sequentialGetPhysicalItem(t,e,s,i)))}),r)}))}_nextAggregateItem(t,e,s,i,n,r){try{_(t.pagesDefinition.internal.iterator.next()).then((l=>{if(null===l)if(null!==t.pagesDefinition.internal.workingItem){const e=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);i.push(e),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(e.attributes[this.objectIdField]),t.pagesDefinition.internal.fullyResolved=!0,n(null)}else t.pagesDefinition.internal.fullyResolved=!0,n(null);else{const a=this._generateAggregateHash(l);if(null===t.pagesDefinition.internal.workingItem)t.pagesDefinition.internal.workingItem={features:[l],id:a};else{if(a!==t.pagesDefinition.internal.workingItem.id){const s=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);return i.push(s),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(s.attributes[this.objectIdField]),e-=1,t.pagesDefinition.internal.workingItem={features:[l],id:a},void n(s)}t.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(t,e,s,i,n,r)}}),r)}catch(t){r(t)}}_calculateFieldStat(t,e,s){const i=[];for(const s of t.features)if(null!==e.workingexpr){const t=e.workingexpr.calculateValue(s);null!==t&&(t instanceof dt||t instanceof wt?i.push(t.toNumber()):t instanceof ot?i.push(t.toMilliseconds()):i.push(t))}else i.push(null);s.attributes[e.tofieldname]=ct(e.typeofstat,[i])}_calculateAndAppendAggregateItem(t){const e={attributes:{},geometry:null};for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.features[0].attributes[s.singlefield]:at.convertValueToStorageFormat(s.expression.calculateValue(t.features[0]),s.sqlType);e.attributes[s.tofieldname]=i}for(const s of this._decodedStatsfield)this._calculateFieldStat(t,s,e);const i=[];for(let s=0;s<this._decodedStatsfield.length;s++)i.push(this._calculateFieldStat(t,this._decodedStatsfield[s],e));return this._featureCache[e.attributes[this.objectIdField]]=new s({attributes:e.attributes,geometry:e.geometry}),e}_generateAggregateHash(t){let e="";for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.attributes[s.singlefield]:s.expression.calculateValue(t);e+=null==i?":":":"+i.toString()}return r(e,l.String)}async _stat(){return{calculated:!1}}async getFeatureByObjectId(){return null}static registerAction(){R._featuresetFunctions.groupby=function(t,e){return new Dt({parentfeatureset:this,groupbyfields:t,statsfields:e})}}}class xt extends R{constructor(t){super(t),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._parent._getSet(t);return this._wset=new A(e._candidates.slice(),e._known.slice(),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===J.NotInFeatureSet)return e;const s=this._idstates[t];return s===J.InFeatureSet||s===J.NotInFeatureSet?s:e===J.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=J.InFeatureSet,this._countedin++,J.InFeatureSet):(this._idstates[t]=J.NotInFeatureSet,J.NotInFeatureSet):J.Unknown}async _expandPagedSet(t,e,s,i,n){if(null===this._parent)throw new O(v.NotImplemented);if(e>this._topnum&&(e=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset){let e=t._known.length;return e>0&&"GETPAGES"===t._known[e-1]&&(t._known.length=e-1),e=t._candidates.length,e>0&&"GETPAGES"===t._candidates[e-1]&&(t._candidates.length=e-1),"success"}const r=await this._parent._expandPagedSet(t,e,s,i,n);return this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),r}async _getFeatures(t,e,s,i){const n=[],r=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,r))return await this._expandPagedSet(t,r,0,0,i),this._getFeatures(t,e,s,i);-1!==e&&void 0===this._featureCache[e]&&n.push(e);let l=0;for(let i=t._lastFetchedIndex;i<t._known.length&&(l++,l<=s&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[i]]&&(t._known[i]!==e&&n.push(t._known[i]),n.length>r)));i++);if(0===n.length)return"success";const a=new A([],n,!1,null),h=Math.min(n.length,s);await this._parent._getFeatures(a,-1,h,i);for(let t=0;t<h;t++){const e=this._parent._featureFromCache(n[t]);void 0!==e&&(this._featureCache[n[t]]=e)}return"success"}async _getFilteredSet(t,e,s,i,n){await this._ensureLoaded();const r=await this._getSet(n);return new A(r._candidates.slice().concat(r._known.slice()),[],!1,this._clonePageDefinition(r.pagesDefinition))}_refineKnowns(t,e){let s=0,i=null;const n=[];for(let r=0;r<t._candidates.length;r++){const l=this._isInFeatureSet(t._candidates[r]);if(l===J.InFeatureSet){if(t._known.push(t._candidates[r]),s+=1,null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(n.push(i),i={start:r,end:r}),t._known.length>=this._topnum)break}else if(l===J.NotInFeatureSet)null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(n.push(i),i={start:r,end:r}),s+=1;else if(l===J.Unknown)break;if(s>=e)break}null!==i&&n.push(i);for(let e=n.length-1;e>=0;e--)t._candidates.splice(n[e].start,n[e].end-n[e].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){R._featuresetFunctions.top=function(t){return new xt({parentfeatureset:this,topnum:t})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}class kt extends R{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return st}end(){return this._layer}optimisePagingFeatureQueries(t){this._pageJustIds=t}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(t){const e=this.urlQueryPath+","+it(t.toJSON());return r(e,l.String)}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType??"",this.fields=this._layer.fields.slice(),this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ,this.hasM=!0===this._layer?.capabilities?.data?.supportsM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}if(this._layer.source&&this._layer.source.sourceJSON){const t=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=X.StandardisedNoInterval,null!=t&&t>=10.61&&(this._databaseType=X.Standardised)):null!=t&&(t>=10.5&&(this._databaseType=X.StandardisedNoInterval,this._requestStandardised=!0),t>=10.61&&(this._databaseType=X.Standardised))}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,this.typeIdField=("typeIdField"in this._layer?this._layer.typeIdField:null)??"",this.types="types"in this._layer?this._layer.types:null}_isInFeatureSet(){return J.InFeatureSet}async _refineSetBlock(t){return t}_candidateIdTransform(t){return t}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,e}return this._wset}async _runDatabaseProbe(t){await this._ensureLoaded();const e=new a;this.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),e.where=t.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(e),!0}catch(t){return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}_createQuery(){const t=this._layer.createQuery();return t.returnZ=this.hasZ,t.returnM=this.hasM,this.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),this._requestStandardised&&(t.sqlFormat="standard"),this._useDefinitionExpression?"subtype-group"===this._layer.type&&(t.where=this._layer.definitionExpression):t.where=null,t}executeQuery(t,e){const s="execute"===e?this._layer.queryFeatures.bind(this._layer):"executeForCount"===e?this._layer.queryFeatureCount.bind(this._layer):this._layer.queryObjectIds.bind(this._layer);let i=null;if(this.recentlyUsedQueries){const e=this.convertQueryToLruCacheKey(t);i=this.recentlyUsedQueries.getFromCache(e),null===i&&(i=s(t),this.recentlyUsedQueries.addToCache(e,i),i=i.catch((t=>{throw this.recentlyUsedQueries?.removeFromCache(e),t})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:t,method:e}),null===i&&(i=s(t)),i}async _getFilteredSet(t,e,s,i,n){const r=await this.databaseType();if(this.isTable()&&e&&null!==t&&""!==t){return new A([],[],!0,null)}if(this._canUsePagination())return this._getFilteredSetUsingPaging(t,e,s,i,n);let l="",a=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=i.constructClause(),a=!0);const u=this._createQuery();u.where=h(u.where,null===s?null===e?"1=1":"":D(s,r)),u.spatialRelationship=this._makeRelationshipEnum(t),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===e?null:e,u.relationParameter=this._makeRelationshipParam(t);let o=await this.executeQuery(u,"executeForIds");null===o&&(o=[]),this._checkCancelled(n);return new A([],o,a,null)}_expandPagedSet(t,e,s,i,n){return this._expandPagedSetFeatureSet(t,e,s,i,n)}async _getFilteredSetUsingPaging(t,e,s,i,n){let r="",l=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(r=i.constructClause(),l=!0);const a=await this.databaseType(),h=null===s?null===e?"1=1":"":D(s,a);let u=this._maxQueryRate();const o=this._layer.capabilities?.query.maxRecordCount;null!=o&&o<u&&(u=o);let c=null;if(!0===this._pageJustIds)c=new A([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:this._layer.objectIdField,resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:r,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let s=!0;!0===this._removeGeometry&&(s=!1);const i=this._overrideFields??this._fieldsIncludingObjectId(["*"]);c=new A([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:i.join(","),resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:r,returnGeometry:s,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return await this._expandPagedSet(c,u,0,1,n),c}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}async _getPhysicalPage(t,e,s){const i=t.pagesDefinition.internal.lastRetrieved,n=i,r=t.pagesDefinition.internal.lastPage,l=this._createQuery();l.spatialRelationship=t.pagesDefinition.spatialRel,l.relationParameter=t.pagesDefinition.relationParam,l.outFields=t.pagesDefinition.outFields.split(","),l.num=t.pagesDefinition.resultRecordCount,l.start=t.pagesDefinition.internal.lastPage,l.geometry=t.pagesDefinition.geometry,l.where=h(l.where,t.pagesDefinition.where),l.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=t.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference;const a=await this.executeQuery(l,"execute");if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return"done";const u=this._layer.objectIdField;for(let e=0;e<a.features.length;e++)t.pagesDefinition.internal.set[n+e]=a.features[e].attributes[u];if(!1===this._pageJustIds)for(let t=0;t<a.features.length;t++)this._featureCache[a.features[t].attributes[u]]=a.features[t];return(void 0===a.exceededTransferLimit&&a.features.length!==t.pagesDefinition.resultRecordCount||!1===a.exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=i+a.features.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,"done"}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice();if(e.includes("*"))return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}async _getFeatures(t,e,s,i){const n=[];if(-1!==e&&void 0===this._featureCache[e]&&n.push(e),!0===this._checkIfNeedToExpandKnownPage(t,this._maxProcessingRate()))return await this._expandPagedSet(t,this._maxProcessingRate(),0,0,i),this._getFeatures(t,e,s,i);let r=0;for(let i=t._lastFetchedIndex;i<t._known.length;i++){if(t._lastFetchedIndex+=1,r++,void 0===this._featureCache[t._known[i]]){let s=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const e=this._layer._mode;if(void 0!==e._featureMap[t._known[i]]){const n=e._featureMap[t._known[i]];null!==n&&(s=!0,this._featureCache[t._known[i]]=n)}}if(!1===s&&(t._known[i]!==e&&n.push(t._known[i]),n.length>=this._maxProcessingRate()-1))break}if(r>=s&&0===n.length)break}if(0===n.length)return"success";const l=this._createQuery();l.objectIds=n,l.outFields=this._overrideFields??this._fieldsIncludingObjectId(["*"]),l.returnGeometry=!0,!0===this._removeGeometry&&(l.returnGeometry=!1),l.outSpatialReference=this.spatialReference;const a=await this.executeQuery(l,"execute");if(this._checkCancelled(i),void 0!==a.error)throw new O(v.RequestFailed,{reason:a.error});const h=this._layer.objectIdField;for(let t=0;t<a.features.length;t++)this._featureCache[a.features[t].attributes[h]]=a.features[t];return"success"}async _getDistinctPages(t,e,s,i,n,r,l,a,u){await this._ensureLoaded();const o=await this.databaseType();let c=s.parseTree.column;const f=this._layer.fields??[];for(let t=0;t<f.length;t++)if(f[t].name.toLowerCase()===c.toLowerCase()){c=f[t].name;break}const d=this._createQuery();d.where=h(d.where,null===r?null===n?"1=1":"":D(r,o)),d.spatialRelationship=this._makeRelationshipEnum(i),d.relationParameter=this._makeRelationshipParam(i),d.geometry=null===n?null:n,d.returnDistinctValues=!0,d.returnGeometry=!1,d.outFields=[c];const w=await this.executeQuery(d,"execute");if(this._checkCancelled(u),!w.hasOwnProperty("features"))throw new O(v.InvalidStatResponse);let y=!1;for(let t=0;t<f.length;t++)if(f[t].name===c){"date"===f[t].type&&(y=!0);break}for(let t=0;t<w.features.length;t++){if(y){const e=w.features[t].attributes[c];null!==e?a.push(new Date(e)):a.push(e)}else a.push(w.features[t].attributes[c]);if(a.length>=l)break}if(0===w.features.length)return a;if(w.features.length===this._layer.capabilities?.query.maxRecordCount&&a.length<l){return{calculated:!0,result:await this._getDistinctPages(t+w.features.length,e,s,i,n,r,l,a,u)}}return a}async _distinctStat(t,e,s,i,n,r,l){return{calculated:!0,result:await this._getDistinctPages(0,t,e,s,i,n,r,[],l)}}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}async _countstat(t,e,s,i){const n=await this.databaseType();if(this.isTable()&&s&&null!==e&&""!==e)return{calculated:!0,result:0};const r=this._createQuery();r.where=h(r.where,null===i?null===s?"1=1":"":D(i,n)),r.spatialRelationship=this._makeRelationshipEnum(e),r.relationParameter=this._makeRelationshipParam(e),r.geometry=null===s?null:s,r.returnGeometry=!1;return{calculated:!0,result:await this.executeQuery(r,"executeForCount")}}async _stats(t,e,s,i,n,r,l){await this._ensureLoaded();const a=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,o=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,c=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===t)return c?this._countstat(t,s,i,n):{calculated:!1};if(!1===o||!1===V(e)&&!1===a||!1===e.isStandardized)return""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,r,l);if("distinct"===t)return!1===c?""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,r,l):this._distinctStat(t,e,s,i,n,r,l);const f=await this.databaseType();if(this.isTable()&&i&&null!==s&&""!==s)return{calculated:!0,result:null};const d=this._createQuery();d.where=h(d.where,null===n?null===i?"1=1":"":D(n,f)),d.spatialRelationship=this._makeRelationshipEnum(s),d.relationParameter=this._makeRelationshipParam(s),d.geometry=null===i?null:i;const w=new u;w.statisticType=W(t),w.onStatisticField=D(e,f),w.outStatisticFieldName="ARCADE_STAT_RESULT",d.returnGeometry=!1;let y="ARCADE_STAT_RESULT";d.outStatistics=[w];const g=await this.executeQuery(d,"execute");if(!g.hasOwnProperty("features")||0===g.features.length)throw new O(v.InvalidStatResponse);let p=!1;const m=g.fields??[];for(let t=0;t<m.length;t++)if("ARCADE_STAT_RESULT"===m[t].name.toUpperCase()){y=m[t].name,"date"===m[t].type&&(p=!0);break}if(p){let t=g.features[0].attributes[y];return null!==t&&(t=new Date(g.features[0].attributes[y])),{calculated:!0,result:t}}return{calculated:!0,result:g.features[0].attributes[y]}}_stat(t,e,s,i,n,r,l){return this._stats(t,e,s,i,n,r,l)}async _canDoAggregates(t,e){await this._ensureLoaded();let s=!1;const i=this._layer.capabilities?.query,n=!0===i?.supportsSqlExpression;if(null!=i&&!0===i.supportsStatistics&&!0===i.supportsOrderBy&&(s=!0),s)for(let t=0;t<e.length-1;t++)(!1===e[t].workingexpr?.isStandardized||!1===V(e[t].workingexpr)&&!1===n)&&(s=!1);return!1!==s}_makeRelationshipEnum(t){if(t.includes("esriSpatialRelRelation"))return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.includes("esriSpatialRelRelation")?t.split(":")[1]:""}async _getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l){await this._ensureLoaded();const a=await this.databaseType();let h="",o=!1,c=!1;null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(h=r.constructClause(),c=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(c=!1,o=!0,h=this._layer.objectIdField);const f=[];for(let t=0;t<e.length;t++){const s=new u;s.onStatisticField=null!==e[t].workingexpr?D(e[t].workingexpr,a):"",s.outStatisticFieldName=e[t].field,s.statisticType=e[t].toStatisticsName(),f.push(s)}""===h&&(h=t.join(","));let d=this._maxQueryRate();const w=this._layer.capabilities?.query.maxRecordCount;null!=w&&w<d&&(d=w);const y=null===n?null===i?"1=1":"":D(n,a);return new A([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:o,generatedOid:l,resultRecordCount:d,resultOffset:0,groupByFieldsForStatistics:t,outStatistics:f,geometry:null===i?null:i,where:y,orderByFields:h,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}async _getAgregagtePhysicalPage(t,e,i){let n=t.pagesDefinition.where;!0===t.pagesDefinition.useOIDpagination&&(n=h(n,t.pagesDefinition.generatedOid+">"+t.pagesDefinition.internal.lastMaxId.toString()));const r=t.pagesDefinition.internal.lastRetrieved,l=r,a=t.pagesDefinition.internal.lastPage,u=this._createQuery();if(u.where=h(u.where,n),u.spatialRelationship=t.pagesDefinition.spatialRel,u.relationParameter=t.pagesDefinition.relationParam,u.outFields=t.pagesDefinition.outFields,u.outStatistics=t.pagesDefinition.outStatistics,u.geometry=t.pagesDefinition.geometry,u.groupByFieldsForStatistics=t.pagesDefinition.groupByFieldsForStatistics,u.num=t.pagesDefinition.resultRecordCount,u.start=t.pagesDefinition.internal.lastPage,u.returnGeometry=t.pagesDefinition.returnGeometry,u.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship)return[];const o=await this.executeQuery(u,"execute");if(this._checkCancelled(i),!o.hasOwnProperty("features"))throw new O(v.InvalidStatResponse);const c=[];if(t.pagesDefinition.internal.lastPage!==a)return[];o.features.length>0&&void 0===o.features[0].attributes[t.pagesDefinition.generatedOid]&&(t.pagesDefinition.generatedOid=t.pagesDefinition.generatedOid.toLowerCase());for(let e=0;e<o.features.length;e++)t.pagesDefinition.internal.set[l+e]=o.features[e].attributes[t.pagesDefinition.generatedOid];for(let t=0;t<o.features.length;t++)c.push(new s({attributes:o.features[t].attributes,geometry:null}));return!0===t.pagesDefinition.useOIDpagination?0===o.features.length?t.pagesDefinition.internal.fullyResolved=!0:t.pagesDefinition.internal.lastMaxId=o.features[o.features.length-1].attributes[t.pagesDefinition.generatedOid]:(void 0===o.exceededTransferLimit&&o.features.length!==t.pagesDefinition.resultRecordCount||!1===o.exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=r+o.features.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,c}static create(t,e,s,i,n){const r=new o({url:t,outFields:null===e?["*"]:e});return new kt({layer:r,spatialReference:s,lrucache:i,interceptor:n})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON?.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return nt(this._layer.parsedUrl.path)}async queryAttachments(t,e,s,i,n){function r(t){const e=t.capabilities;return e?.data.supportsAttachment&&e?.operations.supportsQueryAttachments}const l=this._layer;if(r(l)){const r={objectIds:[t],returnMetadata:n};(e&&e>0||s&&s>0)&&(r.size=[e&&e>0?e:0,s&&s>0?s:e+1]),i&&i.length>0&&(r.attachmentTypes=i),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:l,query:r,method:"attachments"});const a=await l.queryAttachments(new c(r)),h=[];return a&&a[t]&&a[t].forEach((e=>{const s=this._layer.parsedUrl.path+"/"+t.toString()+"/attachments/"+e.id.toString();let i=null;n&&e.exifInfo&&(i=yt.convertJsonToArcade(e.exifInfo,"system",!0)),h.push(new gt(e.id,e.name,e.contentType,e.size,s,i,e.keywords??null))})),h}return[]}async queryRelatedFeatures(t){const e={f:"json",relationshipId:t.relationshipId.toString(),definitionExpression:t.where,outFields:t.outFields?.join(","),returnGeometry:t.returnGeometry.toString()};void 0!==t.resultOffset&&null!==t.resultOffset&&(e.resultOffset=t.resultOffset.toString()),void 0!==t.resultRecordCount&&null!==t.resultRecordCount&&(e.resultRecordCount=t.resultRecordCount.toString()),t.orderByFields&&(e.orderByFields=t.orderByFields.join(",")),t.objectIds&&t.objectIds.length>0&&(e.objectIds=t.objectIds.join(",")),t.outSpatialReference&&(e.outSR=f(t.outSpatialReference)),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:e,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});const i=await d(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:e});if(i.data){const t={},e=i.data;if(e?.relatedRecordGroups){const i=e.spatialReference;for(const n of e.relatedRecordGroups){const r=n.objectId,l=[];for(const t of n.relatedRecords){t.geometry&&(t.geometry.spatialReference=i);const e=new s({geometry:t.geometry?w(t.geometry):null,attributes:t.attributes});l.push(e)}t[r]={features:l,exceededTransferLimit:!0===e.exceededTransferLimit}}}return t}throw new O(v.InvalidRequest)}async getFeatureByObjectId(t,e){const s=this._createQuery();s.outFields=e,s.returnGeometry=!1,s.outSpatialReference=this.spatialReference,s.where=h(s.where,this.objectIdField+"="+t.toString()),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:s,method:"execute"});const i=await this._layer.queryFeatures(s);return 1===i.features.length?i.features[0]:null}async getIdentityUser(){await this.load();const t=y?.findCredential(this._layer.url);return t?t.userId:null}async getOwningSystemUrl(){await this.load();const t=y?.findServerInfo(this._layer.url);if(t)return t.owningSystemUrl;let e=this._layer.url;const s=e.toLowerCase().indexOf("/rest/services");if(e=s>-1?e.slice(0,s):e,e){e+="/rest/info";try{const t=await d(e,{query:{f:"json"}});let s="";return t.data?.owningSystemUrl&&(s=t.data.owningSystemUrl),s}catch(t){return""}}return""}getDataSourceFeatureSet(){const t=new kt({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return t._useDefinitionExpression=!1,t}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo??null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){if(this.fsetInfo)return this.fsetInfo;let t=null,e="serviceItemId"in this._layer?this._layer.serviceItemId:null;const s=this._layer.parsedUrl.path;if(s){const i=await d(s,{responseType:"json",query:{f:"json"}});t=i?.data?.name??null,e=i?.data?.serviceItemId??null}const i=this._layer.title&&null!==(this._layer.parent??null);return this.featureSetInfo={layerId:this._layer.layerId,layerName:""===t?null:t,itemId:""===e?null:e,serviceLayerUrl:""===s?null:s,webMapLayerId:i?this._layer.id??null:null,webMapLayerTitle:i?this._layer.title??null:null,className:null,objectClassId:null},this.fsetInfo}}class Ct extends R{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,!0===t.isTable&&(this._forceIsTable=!0),void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return st}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType??"",this.fields=this._layer.fields.slice(),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this._databaseType=X.Standardised,this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ,this.hasM=!0===this._layer?.capabilities?.data?.supportsM,this.subtypeField=("subtypeField"in this._layer?this._layer.subtypeField:null)??"",this.subtypes="subtypes"in this._layer?this._layer.subtypes:null,this.typeIdField=("typeIdField"in this._layer?this._layer.typeIdField:null)??"",this.types="types"in this._layer?this._layer.types:null}isTable(){return this._forceIsTable||"isTable"in this._layer&&this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return J.InFeatureSet}_candidateIdTransform(t){return t}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,e}return this._wset}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new s({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}async _getFilteredSet(t,e,s,i,n){let r="",l=!1;if(null!==i&&(r=i.constructClause(),l=!0),this.isTable()&&e&&null!==t&&""!==t){return new A([],[],!0,null)}const a=this._layer.createQuery();a.returnZ=this.hasZ,a.returnM=this.hasM,a.where=h(a.where,null===s?null===e?"1=1":"":D(s,X.Standardised)),a.spatialRelationship=this._makeRelationshipEnum(t),a.outSpatialReference=this.spatialReference,a.orderByFields=""!==r?r.split(","):null,a.geometry=null===e?null:e,a.returnGeometry=!0,a.relationParameter=this._makeRelationshipParam(t);const u=await this._layer.queryFeatures(a);if(null===u)return new A([],[],l,null);this._checkCancelled(n);const o=[];u.features.forEach((t=>{const e=t.attributes[this._layer.objectIdField];o.push(e),this._featureCache[e]=this._changeFeature(t)}));return new A([],o,l,null)}_makeRelationshipEnum(t){if(t.includes("esriSpatialRelRelation"))return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.includes("esriSpatialRelRelation")?t.split(":")[1]:""}async _queryAllFeatures(){if(this._wset)return this._wset;const t=new a;if(t.where="1=1",await this._ensureLoaded(),this._layer.source&&this._layer.source.items){const t=[];return this._layer.source.items.forEach((e=>{const s=e.attributes[this._layer.objectIdField];t.push(s),this._featureCache[s]=this._changeFeature(e)})),this._wset=new A([],t,!1,null),this._wset}t.returnZ=this.hasZ,t.returnM=this.hasM;const e=await this._layer.queryFeatures(t),s=[];return e.features.forEach((t=>{const e=t.attributes[this._layer.objectIdField];s.push(e),this._featureCache[e]=this._changeFeature(t)})),this._wset=new A([],s,!1,null),this._wset}async _getFeatures(t,e,s){const i=[];-1!==e&&void 0===this._featureCache[e]&&i.push(e);for(let n=t._lastFetchedIndex;n<t._known.length&&(t._lastFetchedIndex+=1,!(void 0===this._featureCache[t._known[n]]&&(t._known[n]!==e&&i.push(t._known[n]),i.length>s)));n++);if(0===i.length)return"success";throw new O(v.MissingFeatures)}async _refineSetBlock(t){return t}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(t){const e={};for(const s in t)e[s]=t[s];return e}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(t,e){let s=t.layerDefinition.objectIdField;const i=t.layerDefinition.typeIdField??"",r=[];if(t.layerDefinition.types)for(const e of t.layerDefinition.types)r.push(g.fromJSON(e));let l=t.layerDefinition.geometryType;void 0===l&&(l=t.featureSet.geometryType||"");let a=t.featureSet.features;const h=e.toJSON();if(!s){let e=!1;for(const i of t.layerDefinition.fields)if("oid"===i.type||"esriFieldTypeOID"===i.type){s=i.name,e=!0;break}if(!1===e){let e="FID",i=!0,n=0;for(;i;){let s=!0;for(const i of t.layerDefinition.fields)if(i.name===e){s=!1;break}!0===s?i=!1:(n++,e="FID"+n.toString())}t.layerDefinition.fields.push({type:"esriFieldTypeOID",name:e,alias:e});const r=[];for(let s=0;s<a.length;s++)r.push({geometry:t.featureSet.features[s].geometry,attributes:t.featureSet.features[s].attributes?this._cloneAttr(t.featureSet.features[s].attributes):{}}),r[s].attributes[e]=s;a=r,s=e}}const u=[];for(const e of t.layerDefinition.fields)e instanceof n?u.push(e):u.push(n.fromJSON(e));let c=l;switch(c||(c=""),c){case"esriGeometryPoint":c="point";break;case"esriGeometryPolyline":c="polyline";break;case"esriGeometryPolygon":c="polygon";break;case"esriGeometryEnvelope":c="extent";break;case"esriGeometryMultipoint":c="multipoint";break;case"":case"esriGeometryNull":c="esriGeometryNull"}if("esriGeometryNull"!==c)for(const t of a)t.geometry&&t.geometry instanceof p==!1&&(t.geometry.type=c,void 0===t.geometry.spatialReference&&(t.geometry.spatialReference=h));else for(const t of a)t.geometry&&(t.geometry=null);const f={outFields:["*"],source:a,fields:u,hasZ:!0===t?.layerDefinition?.hasZ||!0===t?.featureSet?.hasZ,hasM:!0===t?.layerDefinition?.hasM||!0===t?.featureSet?.hasM,types:r,typeIdField:i,objectIdField:s,spatialReference:e},d="esriGeometryNull"===c||null===c;d||(f.geometryType=c);const w=new o(f);t?.layerDefinition?.subtypeField&&t?.layerDefinition?.subtypes&&w.read({subtypes:t.layerDefinition.subtypes,subtypeField:t.layerDefinition.subtypeField});return new Ct({layer:w,spatialReference:e,isTable:d})}async queryAttachments(){return[]}async getFeatureByObjectId(t){const e=new a;e.where=this.objectIdField+"="+t.toString(),e.returnZ=this.hasZ,e.returnM=this.hasM;const s=await this._layer.queryFeatures(e);return 1===s.features.length?s.features[0]:null}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return"preferredTimeZone"in this._layer?this._layer.preferredTimeZone:null}get dateFieldsTimeZone(){return"dateFieldsTimeZone"in this._layer?this._layer.dateFieldsTimeZone:null}get datesInUnknownTimezone(){return"datesInUnknownTimezone"in this._layer&&this._layer.datesInUnknownTimezone}get editFieldsInfo(){return"editFieldsInfo"in this._layer?this._layer.editFieldsInfo:null}get timeInfo(){return this._layer?.timeInfo}async getFeatureSetInfo(){const t=this._layer.title&&this._layer.parent;return this.fsetInfo??{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:t?this._layer.id??null:null,webMapLayerTitle:t?this._layer.title??null:null,className:null,objectClassId:null}}}class Gt extends R{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,this._findObjectId=t.objectId,this.featureObjectId=t.objectId,this.relationship=t.relationship,this._relatedLayer=t.relatedLayer,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return st}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return await Promise.all([this._layer.load(),this._relatedLayer?.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}const t=this._layer.nativeCapabilities();t&&(this._databaseType=t.databaseType,this._requestStandardised=t.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return await this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return J.InFeatureSet}_candidateIdTransform(t){return t}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,e}return this._wset}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new s({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}async _getFilteredSet(t,e,s,i,n){if(await this.databaseType(),this.isTable()&&e&&null!==t&&""!==t){return new A([],[],!0,null)}const r=this._layer.nativeCapabilities();if(!1===r.canQueryRelated){return new A([],[],!0,null)}if(r.capabilities?.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(t,e,s,i,n);let l="",a=!1;null!==i&&!0===r.capabilities?.queryRelated.supportsOrderBy&&(l=i.constructClause(),a=!0);const h=new m;h.objectIds=[this._findObjectId];const u=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((t=>t.name)):["*"]);h.outFields=u,h.relationshipId=this.relationship.id,h.where="1=1";let o=!0;!0===this._removeGeometry&&(o=!1),h.returnGeometry=o,this._requestStandardised&&(h.sqlFormat="standard"),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==l?l.split(","):null;const c=await r.source.queryRelatedFeatures(h);this._checkCancelled(n);const f=c[this._findObjectId]?c[this._findObjectId].features:[],d=[];for(let t=0;t<f.length;t++)this._featureCache[f[t].attributes[this._relatedLayer.objectIdField]]=f[t],d.push(f[t].attributes[this._relatedLayer.objectIdField]);const w=e&&null!==t&&""!==t,y=null!=s;return new A(w||y?d:[],w||y?[]:d,a,null)}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice();if(e.includes("*"))return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}async _getFilteredSetUsingPaging(t,e,s,i,n){let r="",l=!1;const a=this._layer.nativeCapabilities();null!==i&&!0===a.capabilities?.queryRelated.supportsOrderBy&&(r=i.constructClause(),l=!0),await this.databaseType();const h="1=1";let u=this._maxQueryRate();const o=a.capabilities?.query.maxRecordCount;null!=o&&o<u&&(u=o);const c=e&&null!==t&&""!==t,f=null!=s;let d=null,w=!0;!0===this._removeGeometry&&(w=!1);const y=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((t=>t.name)):["*"]);return d=new A(c||f?["GETPAGES"]:[],c||f?[]:["GETPAGES"],l,{outFields:y.join(","),resultRecordCount:u,resultOffset:0,objectIds:[this._findObjectId],where:h,orderByFields:r,returnGeometry:w,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),await this._expandPagedSet(d,u,0,0,n),d}_expandPagedSet(t,e,s,i,n){return this._expandPagedSetFeatureSet(t,e,s,i,n)}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}async _getPhysicalPage(t,e,s){const i=t.pagesDefinition.internal.lastRetrieved,n=i,r=t.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),a=new m;!0===this._requestStandardised&&(a.sqlFormat="standard"),a.relationshipId=this.relationship.id,a.objectIds=t.pagesDefinition.objectIds,a.resultOffset=t.pagesDefinition.internal.lastPage,a.resultRecordCount=t.pagesDefinition.resultRecordCount,a.outFields=t.pagesDefinition.outFields.split(","),a.where=t.pagesDefinition.where,a.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=t.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference;const h=await l.source.queryRelatedFeatures(a);if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return 0;const u=h[this._findObjectId]?h[this._findObjectId].features:[];for(let e=0;e<u.length;e++)t.pagesDefinition.internal.set[n+e]=u[e].attributes[this._relatedLayer.objectIdField];for(let t=0;t<u.length;t++)this._featureCache[u[t].attributes[this._relatedLayer.objectIdField]]=u[t];const o=!h[this._findObjectId]||!1===h[this._findObjectId].exceededTransferLimit;return u.length!==t.pagesDefinition.resultRecordCount&&o&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=i+u.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,u.length}async _getFeatures(t,e,s,i){const n=[];-1!==e&&void 0===this._featureCache[e]&&n.push(e);const r=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,r))return await this._expandPagedSet(t,r,0,0,i),this._getFeatures(t,e,s,i);let l=0;for(let i=t._lastFetchedIndex;i<t._known.length&&(l++,l<=s&&(t._lastFetchedIndex+=1),!("GETPAGES"!==t._known[i]&&void 0===this._featureCache[t._known[i]]&&(t._known[i]!==e&&n.push(t._known[i]),n.length>s)))&&!(l>=s&&0===n.length);i++);if(0===n.length)return"success";throw new O(v.MissingFeatures)}async _refineSetBlock(t,e,s){return t}async _stat(t,e,s,i,n,r,l){return{calculated:!1}}get gdbVersion(){return this._relatedLayer.gdbVersion}async _canDoAggregates(t,e,s,i,n){return!1}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(t,e,s,i,n){return this._relatedLayer.queryAttachments(t,e,s,i,n)}getFeatureByObjectId(t,e){return this._relatedLayer.getFeatureByObjectId(t,e)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){return this._relatedLayer?.preferredTimeZone??null}get dateFieldsTimeZone(){return this._relatedLayer?.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._relatedLayer?.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer?.editFieldsInfo??null}get timeInfo(){return this._relatedLayer?.timeInfo??null}async getFeatureSetInfo(){return this.fsetInfo??this._layer.featureSetInfo}}function Pt(){null===Q.applicationCache&&(Q.applicationCache=new Q)}async function Ut(t,e,s){if(Q.applicationCache){const s=Q.applicationCache.getLayerInfo(t);if(s){const i=await s;return new o({url:t,outFields:e,sourceJSON:i})}const i=new o({url:t,outFields:e}),n=(async()=>(await i.load(),i.sourceJSON))();if(Q.applicationCache){Q.applicationCache.setLayerInfo(t,n);try{return await n,i}catch(e){throw Q.applicationCache.clearLayerInfo(t),e}}return await n,i}if(null!=s){const i=s.getCachedLayerMetadata(t);if(i){const s=await i;return new o({url:t,outFields:e,sourceJSON:s})}const n=new o({url:t,outFields:e}),r=(async()=>(await n.load(),n.sourceJSON))();s.setCachedLayerMetadata(t,r);try{return await r,n}catch(e){throw s.removeCachedLayerMetadata(t,r),e}}return new o({url:t,outFields:e})}async function Mt(t,e,s,i,n,r=null){return Lt(await Ut(t,["*"],n),e,s,i,n,r)}function Lt(t,e=null,s=null,i=!0,n=null,r=null){switch(t.type){case"catalog-footprint":return Lt(t.parent,e,s,i,n,r);case"subtype-sublayer":{const l=Lt(t.parent,e,s,i,n,r);return l.filter(at.create(t.parent.subtypeField+"="+t.subtypeCode.toString(),{fieldsIndex:t.parent.fieldsIndex,timeZone:l.dateFieldsTimeZoneDefaultUTC}))}case"csv":case"geojson":case"wfs":return new Ct({layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:n,interceptor:r});case"catalog":case"feature":case"oriented-imagery":case"subtype-group":{const l={layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:n,interceptor:r};return!t.url&&t.source?new Ct(l):new kt(l)}default:throw new Error(`Unsupported layer type: ${t.type}`)}}async function Bt(t){if(null!==Q.applicationCache){const e=Q.applicationCache.getLayerInfo(t);if(null!==e)return e}const e=(async()=>{const e=await d(t,{responseType:"json",query:{f:"json"}});return e.data?e.data:null})();if(null!==Q.applicationCache){Q.applicationCache.setLayerInfo(t,e);try{return await e}catch(e){throw Q.applicationCache.clearLayerInfo(t),e}}return e}async function jt(t,e){const s="QUERYDATAELEMTS:"+e.toString()+":"+t;if(null!==Q.applicationCache){const t=Q.applicationCache.getLayerInfo(s);if(null!==t)return t}const i=(async()=>{const s=await d(t+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(s.data){const t=s.data;if(t.layerDataElements?.[0])return t.layerDataElements[0]}throw new O(v.DataElementsNotFound)})();if(null!==Q.applicationCache){Q.applicationCache.setLayerInfo(s,i);try{return await i}catch(t){throw Q.applicationCache.clearLayerInfo(s),t}}return i}async function Vt(t,e){if(null!==Q.applicationCache){const e=Q.applicationCache.getLayerInfo(t);if(null!==e)return e}if(null!=e){const s=e.getCachedServiceMetadata(t);if(null!=s)return s}const s=(async()=>{const e=await d(t,{responseType:"json",query:{f:"json"}});if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),t}return{layers:[],tables:[]}})();if(null!==Q.applicationCache){Q.applicationCache.setLayerInfo(t,s);try{return await s}catch(e){throw Q.applicationCache.clearLayerInfo(t),e}}if(null!=e){e.setCachedServiceMetadata(t,s);try{return await s}catch(i){throw e.removeCachedServiceMetadata(t,s),i}}return s}async function qt(t,e){const s={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},i=await Vt(t,null);if(s.metadata=i,void 0!==i.controllerDatasetLayers?.utilityNetworkLayerId&&null!==i.controllerDatasetLayers.utilityNetworkLayerId){if(i.layers)for(const t of i.layers)s.layerNameLkp[t.id]=t.name;if(i.tables)for(const t of i.tables)s.layerNameLkp[t.id]=t.name;const n=i.controllerDatasetLayers.utilityNetworkLayerId;s.networkId=n;const r=await jt(t,n);if(r){s.queryelem=r,s.queryelem?.dataElement&&void 0!==s.queryelem.dataElement.schemaGeneration&&(s.unVersion=s.queryelem.dataElement.schemaGeneration),s.lkp={},s.queryelem.dataElement.domainNetworks||(s.queryelem.dataElement.domainNetworks=[]);for(const t of s.queryelem.dataElement.domainNetworks){for(const e of t.edgeSources??[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:s.layerNameLkp[e.layerId]??null};t.className&&(s.lkp[t.className]=t)}for(const e of t.junctionSources??[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:s.layerNameLkp[e.layerId]??null};t.className&&(s.lkp[t.className]=t)}}if(s.queryelem.dataElement.terminalConfigurations)for(const t of s.queryelem.dataElement.terminalConfigurations)for(const e of t.terminals)s.terminals.push({terminalId:e.terminalId,terminalName:e.terminalName});const i=await Bt(t+"/"+n);if(void 0!==i.systemLayers?.associationsTableId&&null!==i.systemLayers.associationsTableId){const n=[];s.unVersion>=4&&(n.push("STATUS"),n.push("PERCENTALONG"));let r=await Mt(t+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...n],!1,null,null);return await r.load(),s.unVersion>=4&&(r=r.filter(at.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),await r.load()),{lkp:s.lkp,associations:r,unVersion:s.unVersion,terminals:s.terminals}}return{associations:null,unVersion:s.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:s.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:s.unVersion,lkp:null,terminals:[]}}async function Wt(t,e,s,i=null,n=null,r=!0,l=null,a=null){let h=t.serviceUrl();if(!h)return null;h="/"===h.charAt(h.length-1)?h+e.relatedTableId.toString():h+"/"+e.relatedTableId.toString();const u=await Mt(h,i,n,r,l,a);return new Gt({layer:t,relatedLayer:u,relationship:e,objectId:s,spatialReference:i,outFields:n,includeGeometry:r,lrucache:l,interceptor:a})}mt.registerAction(),Dt.registerAction(),Et.registerAction(),Z.registerAction(),xt.registerAction();class Zt extends pt{constructor(t,e=null,s=null,i=null){super(),this._map=t,this._overrideSpatialReference=e,this._lrucache=s,this._interceptor=i,this._instantLayers=[]}_makeAndAddFeatureSet(t,e=!0,s=null){const i=Lt(t,this._overrideSpatialReference,null===s?["*"]:s,e,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}async featureSetByName(t,e=!0,s=null){if(F.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(t,e,s);null===s&&(s=["*"]),s=(s=s.slice()).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.title===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=this._map.allLayers.find((e=>lt(e)&&e.title===t));if(null!=n)return this._makeAndAddFeatureSet(n,e,s);if(this._map.tables){const i=this._map.tables.find((e=>e.title===t));if(null!=i){if(i instanceof o)return this._makeAndAddFeatureSet(i,e,s);if(null==i._materializedTable){const t=i.outFields?i:{...i,outFields:["*"]};i._materializedTable=new o(t)}return await i._materializedTable.load(),this._makeAndAddFeatureSet(i._materializedTable,e,s)}}return null}async featureSetById(t,e=!0,s=["*"]){if(F.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetById(t,e,s);null===s&&(s=["*"]),s=(s=s.slice()).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.id===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=this._map.allLayers.find((e=>lt(e)&&e.id===t));if(n)return this._makeAndAddFeatureSet(n,e,s);if(this._map.tables){const i=this._map.tables.find((e=>e.id===t));if(null!=i){if(i instanceof o)return this._makeAndAddFeatureSet(i,e,s);if(null==i._materializedTable){const t={...i,outFields:["*"]};i._materializedTable=new o(t)}return await i._materializedTable.load(),this._makeAndAddFeatureSet(i._materializedTable,e,s)}}return null}}class Qt extends pt{constructor(t,e=null,s=null,i=null){super(),this._url=t,this._overrideSpatialReference=e,this._lrucache=s,this._interceptor=i,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(t,e=!0,s=null){const i=Lt(t,this._overrideSpatialReference,null===s?["*"]:s,e,this._lrucache);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}async _loadMetaData(){const t=await Vt(this._url,this._lrucache);return this.metadata=t,t}load(){return this._loadMetaData()}clone(){return new Qt(this._url,this._overrideSpatialReference,this._lrucache,this._interceptor)}async featureSetByName(t,e=!0,s=null){null===s&&(s=["*"]),s=(s=s.slice()).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.title===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=await this._loadMetaData();let r=null;for(const e of n.layers??[])e.name===t&&(r=e);if(!r)for(const e of n.tables??[])e.name===t&&(r=e);if(r){const t=await Ut(this._url+"/"+r.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(t,e,s)}return null}async featureSetById(t,e=!0,s=["*"]){null===s&&(s=["*"]),s=(s=s.slice()).sort();const i=JSON.stringify(s);t=null!=t?t.toString():"";for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.id===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=await this._loadMetaData();let r=null;for(const e of n.layers??[])null!==e.id&&void 0!==e.id&&e.id.toString()===t&&(r=e);if(!r)for(const e of n.tables??[])null!==e.id&&void 0!==e.id&&e.id.toString()===t&&(r=e);if(r){const t=await Ut(this._url+"/"+r.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(t,e,s)}return null}}function Kt(t,e,s=null,i=null){return new Zt(t,e,s,i)}function Jt(t,e,s=null,i=null){return new Qt(t,e,s,i)}function $t(t,e,s,i,n){if(null===t)return null;if(T(t)){switch(e){case"datasource":return t.getDataSourceFeatureSet();case"parent":return t;case"root":return t.getRootFeatureSet()}return null}if(t instanceof S&&rt(t)){const r=t;switch(e){case"datasource":return Lt(r,n,r.outFields,!0,s,i).getDataSourceFeatureSet();case"parent":case"root":return Lt(r,n,r.outFields,!0,s,i)}return null}if(b(t)){switch(e){case"datasource":return Lt(t.parent,n,t.parent.outFields,!0,s,i).getDataSourceFeatureSet();case"parent":case"root":return Lt(t,n,t.parent.outFields,!0,s,i)}return null}return null}async function Xt(t,e,s,i,n,r,l,a=null){if(Q.applicationCache){const h=Q.applicationCache.getLayerInfo(t+":"+r.url);if(h)return zt(await h,e,s,i,n,l,a)}if(null!=l){const h=l.getCachedPortalItem(r.url,t);if(null!=h)return await zt(await h,e,s,i,n,l,a)}const h=new I({id:t,portal:r}).load();Q.applicationCache?Q.applicationCache.setLayerInfo(t+":"+r.url,h):null!=l&&l.setCachedPortalItem(r.url,t,h);try{return await zt(await h,e,s,i,n,l,a)}catch(e){throw Q.applicationCache&&Q.applicationCache.clearLayerInfo(t+":"+r.url),null!=l&&l.removeCachedPortalItem(r.url,t,h),e}}async function zt(t,e,s,i,n,r,l){let a;if("Feature Service"===t.type)a=await Ut(nt(t.url??"")+"/"+e,["*"],r);else{if(e)throw new Error(`layerId=${e} provided for ${t.type} item`);if(null!=r){const e=r.getCachedPortalItemLayer(t.portal.url,t.id);if(null!=e)a=await e;else{const e=S.fromPortalItem(t);r.setCachedPortalItemLayer(t.portal.url,t.id,e);try{a=await e}catch(s){throw r.removeCachedPortalItemLayer(t.portal.url,t.id,e),s}}}else a=await S.fromPortalItem(t)}return Lt(a,s,i,n,r,l)}const Ht=Object.freeze({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:qt,constructFeatureSet:Lt,constructFeatureSetFromPortalItem:Xt,constructFeatureSetFromRelationship:Wt,constructFeatureSetFromUrl:Mt,convertToFeatureSet:$t,createFeatureSetCollectionFromMap:Kt,createFeatureSetCollectionFromService:Jt,initialiseMetaDataCache:Pt});export{_t as B,Wt as E,Tt as L,$t as M,Mt as N,qt as O,bt as R,Lt as T,Et as a,xt as b,mt as c,Ft as d,At as e,Ct as f,Ht as g,It as k,Xt as q};
//# sourceMappingURL=p-a5e68840.js.map