{"version":3,"names":["w","R","constructor","this","_customParameters","_queryEngine","_supportsPagination","destroy","async","e","r","getFeatureUrl","s","getFeatureOutputFormat","o","fields","n","geometryType","i","featureType","u","maxRecordCount","c","maxTotalRecordCount","p","maxPageCount","d","objectIdField","g","customParameters","y","spatialReference","_","getFeatureSpatialReference","f","h","t","inSpatialReference","outSpatialReference","a","_featureType","_fieldsIndex","x","fromLayerJSON","dateFieldsTimeReference","some","type","timeZoneIANA","C","_geometryType","_getFeatureUrl","_getFeatureOutputFormat","_getFeatureSpatialReference","_maxRecordCount","_maxTotalRecordCount","_maxPageCount","_objectIdField","_spatialReference","_snapshotFeatures","errors","length","m","fieldsIndex","hasM","hasZ","timeInfo","featureStore","l","addMany","features","warnings","T","extent","fetchRecomputedExtents","fullExtent","_waitSnapshotComplete","executeQuery","signal","executeQueryForCount","executeQueryForIds","executeQueryForExtent","executeQueryForSnapping","_snapshotTask","abort","promise","then","clear","getLogger","warn","message","details","finished","typeName","_singleQuery","push","Math","min","F","max","ceil","Promise","allSettled","Array","from","map","S","totalRecordCount","_processGeoJSON","startIndex","count","wkid","geometry","attributes","objectId","_pageQuery","next","done","value","name","recordCount"],"sources":["./node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nimport{createTask as e}from\"../../../core/asyncUtils.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{throwIfAborted as a,isAbortError as s}from\"../../../core/promiseUtils.js\";import o from\"../../../core/Warning.js\";import{equals as n}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as i,convertToGeometry as u}from\"../featureConversionUtils.js\";import l from\"../data/FeatureStore.js\";import{checkProjectionSupport as h,project as c}from\"../data/projectionSupport.js\";import{QueryEngine as m}from\"../data/QueryEngine.js\";import{validateGeoJSON as p,createOptimizedFeatures as d}from\"./geojson/geojson.js\";import{mixAttributes as g}from\"./support/sourceUtils.js\";import{getGetFeatureSpatialReference as f,getFeatureCount as y,getFeature as _}from\"../../ogc/wfsUtils.js\";import x from\"../../support/FieldsIndex.js\";import{utc as C}from\"../../../time/timeZoneUtils.js\";const w=\"esri.layers.WFSLayer\";class R{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,r={}){const{getFeatureUrl:s,getFeatureOutputFormat:o,fields:n,geometryType:i,featureType:u,maxRecordCount:c,maxTotalRecordCount:p,maxPageCount:d,objectIdField:g,customParameters:y}=e,{spatialReference:_,getFeatureSpatialReference:w}=f(s,u,e.spatialReference);try{await h(w,_)}catch{throw new t(\"unsupported-projection\",\"Projection not supported\",{inSpatialReference:w,outSpatialReference:_})}a(r),this._customParameters=y,this._featureType=u,this._fieldsIndex=x.fromLayerJSON({fields:n,dateFieldsTimeReference:n.some((e=>\"esriFieldTypeDate\"===e.type))?{timeZoneIANA:C}:null}),this._geometryType=i,this._getFeatureUrl=s,this._getFeatureOutputFormat=o,this._getFeatureSpatialReference=w,this._maxRecordCount=c,this._maxTotalRecordCount=p,this._maxPageCount=d,this._objectIdField=g,this._spatialReference=_;let R=await this._snapshotFeatures(r);if(R.errors.length>0&&(this._supportsPagination=!1,R=await this._snapshotFeatures(r),R.errors.length>0))throw R.errors[0];return this._queryEngine=new m({fieldsIndex:this._fieldsIndex,geometryType:i,hasM:!1,hasZ:!1,objectIdField:g,spatialReference:_,timeInfo:null,featureStore:new l({geometryType:i,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(R.features),{warnings:T(R),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(t){return this._customParameters=t.customParameters,this._maxRecordCount=t.maxRecordCount,this._maxTotalRecordCount=t.maxTotalRecordCount,this._maxPageCount=t.maxPageCount,this._snapshotTask?.abort(),this._snapshotTask=e((e=>this._snapshotFeatures({signal:e}))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(const t of T(e))r.getLogger(w).warn(new o(\"wfs-layer:refresh-warning\",t.message,t.details));e.errors?.length&&r.getLogger(w).warn(new o(\"wfs-layer:refresh-error\",\"Refresh completed with errors\",{errors:e.errors}))}),(()=>{this._queryEngine.featureStore.clear()})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){const t=e?.signal,r=this._maxTotalRecordCount,o=this._maxPageCount,n=this._supportsPagination?await y(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:t}):void 0;let i=[];const u=[];if(null==n)try{i=await this._singleQuery(t)}catch(l){s(l)||u.push(l)}else{const e=Math.min(n,r),a=F(this,Math.max(1,Math.min(Math.ceil(e/this._maxRecordCount),o)),t);await Promise.allSettled(Array.from({length:10}).map((()=>S(a,i,u))))}return a(t),{features:i,totalRecordCount:n,maxTotalRecordCount:r,maxPageCount:o,errors:u}}async _singleQuery(e){const t=await _(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:e});return this._processGeoJSON(t,{signal:e})}async _pageQuery(e,t){const r=e*this._maxRecordCount,a=await _(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:r,count:this._maxRecordCount,signal:t});return this._processGeoJSON(a,{startIndex:r,signal:t})}_processGeoJSON(e,t){p(e,this._getFeatureSpatialReference.wkid);const{startIndex:r,signal:s}=t;a(s);const o=d(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!n(this._spatialReference,this._getFeatureSpatialReference))for(const a of o)null!=a.geometry&&(a.geometry=i(c(u(a.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let l=r??1;for(const a of o){const e={};g(this._fieldsIndex,e,a.attributes,!0),a.attributes=e,null==e[this._objectIdField]&&(a.objectId=e[this._objectIdField]=l++)}return o}}function*F(e,t,r){for(let a=0;a<t;a++)yield e._pageQuery(a,r)}async function S(e,t,r){let a=e.next();for(;!a.done;){try{const e=await a.value;t.push(...e)}catch(o){s(o)||r.push(o)}a=e.next()}}function T(e){const t=[];return null!=e.totalRecordCount&&(e.features.length<e.totalRecordCount&&t.push({name:\"wfs-layer:maxRecordCount-too-low\",message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:\"wfs-layer:large-dataset\",message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}export{R as default};\n"],"mappings":"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"}