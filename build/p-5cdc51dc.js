import{dv as t,lN as e,eo as n,$ as s,ry as r,mw as i,m2 as o,eZ as a,ec as c,rz as u,rA as l,nI as f,l9 as d,U as p,P as h,s as m,pN as g,an as w,nH as y,n as x,d8 as b,rB as j,lQ as A,lR as T,lS as v,ar as M,lM as B,rl as I,aW as R,nf as S,nX as U,ep as F}from"./p-aad64c9f.js";import{t as P,e as C}from"./p-79c28fb7.js";import{o as O,r as G,e as $}from"./p-88dd7081.js";import{r as _,a6 as k,a5 as E,a3 as z,C as H,a1 as L,a2 as N,a4 as D,a7 as V,a8 as W,a9 as q}from"./p-967c3f9e.js";import{c as Q,x as K,L as X,i as Z,O as J,E as Y}from"./p-fa12d64c.js";import{e as tt,f as et,l as nt,o as st}from"./p-dcc79702.js";import{n as rt,s as it}from"./p-a0f1b2e3.js";import{n as ot,o as at,a as ct,t as ut,b as lt,c as ft}from"./p-36879113.js";import{r as dt}from"./p-c2c2e8b2.js";import{t as pt}from"./p-af33d18c.js";import{t as ht,l as mt}from"./p-5b459e36.js";import{t as gt}from"./p-c65f105a.js";import{t as wt}from"./p-436c45c7.js";import{t as yt,e as xt,i as bt,n as jt}from"./p-dc92c2ea.js";import{S as At}from"./p-3408a06f.js";import{s as Tt}from"./p-dc645a50.js";import{e as vt}from"./p-e91c4d32.js";import{c as Mt}from"./p-3b7ff27a.js";import"./p-2af77f97.js";import"./p-06c101b5.js";import"./p-74edd46a.js";import"./p-dddb66c6.js";import"./p-17d8c81f.js";import"./p-ed54582d.js";import"./p-175d4a9b.js";import"./p-a040372a.js";import"./p-93091a88.js";import"./p-e974c449.js";import"./p-790e1969.js";import"./p-dfaba342.js";import"./p-1826fadd.js";import"./p-e51694e6.js";function Bt(s,r){if(!s)return!1;const{size:i,data:o,indices:a}=s;t(r,0,0,0),t(Pt,0,0,0);let c=0,u=0;for(let s=0;s<a.length-2;s+=3){const l=a[s]*i,f=a[s+1]*i,d=a[s+2]*i;t(St,o[l],o[l+1],o[l+2]),t(Ut,o[f],o[f+1],o[f+2]),t(Ft,o[d],o[d+1],o[d+2]);const p=At(St,Ut,Ft);p?(e(St,St,Ut),e(St,St,Ft),n(St,St,1/3*p),e(r,r,St),c+=p):(e(Pt,Pt,St),e(Pt,Pt,Ut),e(Pt,Pt,Ft),u+=3)}return(0!==u||0!==c)&&(0!==c?(n(r,r,1/c),!0):0!==u&&(n(r,Pt,1/u),!0))}function It(e,s){if(!e)return!1;const{size:r,data:i,indices:o}=e;t(s,0,0,0);let a=-1,c=0;for(let t=0;t<o.length;t++){const e=o[t]*r;a!==e&&(s[0]+=i[e],s[1]+=i[e+1],s[2]+=i[e+2],c++),a=e}return c>1&&n(s,s,1/c),c>0}function Rt(s,i,o){if(!s)return!1;t(o,0,0,0),t(Pt,0,0,0);let a=0,c=0;const{size:u,data:l,indices:f}=s,d=f.length-1,p=d+(i?2:0);for(let t=0;t<p;t+=2){const s=t<d?t+1:0,i=f[t<d?t:d]*u,p=f[s]*u;St[0]=l[i],St[1]=l[i+1],St[2]=l[i+2],Ut[0]=l[p],Ut[1]=l[p+1],Ut[2]=l[p+2],n(St,e(St,St,Ut),.5);const h=r(St,Ut);h>0?(e(o,o,n(St,St,h)),a+=h):0===a&&(e(Pt,Pt,St),c++)}return 0!==a?(n(o,o,1/a),!0):0!==c&&(n(o,Pt,1/c),!0)}const St=s(),Ut=s(),Ft=s(),Pt=s();class Ct{constructor(){this.uid=i()}}class Ot extends Ct{constructor(t){super(),this.highlightGroupName=t,this.channel=yt.Highlight}}class Gt extends _{constructor(t,e,n=null,s=k.Mesh,r=null,i=-1){super(),this.material=t,this.mapPositions=n,this.type=s,this.objectAndLayerIdColor=r,this.edgeIndicesLength=i,this.highlights=new Set,this._highlightGroupCounts=new Map,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[t,n]of e)this._attributes.set(t,{...n,indices:ht(n.indices)}),t===vt.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(t).indices.length:this.edgeIndicesLength)}instantiate(t={}){const e=new Gt(t.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach(((t,n)=>{t.exclusive=!1,e._attributes.set(n,t)})),e._boundingInfo=this._boundingInfo,e.transformation=t.transformation||this.transformation,e}get attributes(){return this._attributes}getMutableAttribute(t){let e=this._attributes.get(t);return e&&!e.exclusive&&(e={...e,exclusive:!0,data:E(e.data)},this._attributes.set(t,e)),e}setAttributeData(t,e){const n=this._attributes.get(t);n&&this._attributes.set(t,{...n,exclusive:!0,data:e})}get indexCount(){const t=this._attributes.values().next().value.indices;return t?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return null==this._boundingInfo&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===k.Mesh?this._computeAttachmentOriginTriangles(t):this.type===k.Line?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(null!=this._transformation&&o(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const e=this.attributes.get(vt.POSITION);return Bt(e,t)}_computeAttachmentOriginLines(t){const e=this.attributes.get(vt.POSITION);return Rt(e,$t(this.material.parameters,e),t)}_computeAttachmentOriginPoints(t){const e=this.attributes.get(vt.POSITION);return It(e,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.attributes.get(vt.POSITION);if(!t||0===t.indices.length)return null;const e=this.type===k.Mesh?3:1;Tt(t.indices.length%e==0,"Indexing error: "+t.indices.length+" not divisible by "+e);const n=mt(t.indices.length/e);return new z(n,e,t)}get transformation(){return this._transformation??O}set transformation(t){this._transformation=t&&t!==O?G(t):null}get highlightGroups(){return this._highlightGroupCounts}get hasHighlights(){return this._highlightGroupCounts.size>0}foreachHighlightGroup(t){this._highlightGroupCounts.forEach(((e,n)=>t(n)))}allocateIdAndHighlight(t){const e=new Ot(t);return this.addHighlight(e)}addHighlight(t){this.highlights.add(t);const{highlightGroupName:e}=t,n=(this._highlightGroupCounts.get(e)??0)+1;return this._highlightGroupCounts.set(e,n),t}removeHighlight(t){if(this.highlights.delete(t)){const{highlightGroupName:e}=t,n=this._highlightGroupCounts.get(e)??0;n<=1?this._highlightGroupCounts.delete(e):this._highlightGroupCounts.set(e,n-1)}}}function $t(t,e){return!(!("isClosed"in t)||!t.isClosed)&&e.indices.length>2}function _t(t){if(null==t)return null;const e=null!=t.offset?t.offset:c,n=null!=t.rotation?t.rotation:0,s=null!=t.scale?t.scale:u,r=P(1,0,0,0,1,0,e[0],e[1],1),i=P(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=P(s[0],0,0,0,s[1],0,0,0,1),l=C();return a(l,i,o),a(l,r,l),l}class kt{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Et{constructor(t,e,n){this.name=t,this.lodThreshold=e,this.pivotOffset=n,this.stageResources=new kt,this.numberOfVertices=0}}const zt=()=>x.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function Ht(t,e){const n=await Lt(t,e),s=await Qt(n.textureDefinitions??{},e);let r=0;for(const t in s)if(s.hasOwnProperty(t)){const e=s[t];r+=e?.image?e.image.width*e.image.height*4:0}return{resource:n,textures:s,size:r+l(n)}}async function Lt(t,e){const n=e?.streamDataRequester;if(n)return Nt(t,n,e);const s=await d(p(t,e));if(!0===s.ok)return s.value.data;h(s.error),Dt(s.error)}async function Nt(t,e,n){const s=await d(e.request(t,"json",n));if(!0===s.ok)return s.value;h(s.error),Dt(s.error.details.url)}function Dt(t){throw new m("",`Request for object resource failed: ${t}`)}function Vt(t){const e=t.params,n=e.topology;let s=!0;switch(e.vertexAttributes||(zt().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const t=e.faces;if(t){if(e.vertexAttributes)for(const n in e.vertexAttributes){const e=t[n];e?.values?(null!=e.valueType&&"UInt32"!==e.valueType&&(zt().warn(`Unsupported indexed geometry indices type '${e.valueType}', only UInt32 is currently supported`),s=!1),null!=e.valuesPerElement&&1!==e.valuesPerElement&&(zt().warn(`Unsupported indexed geometry values per element '${e.valuesPerElement}', only 1 is currently supported`),s=!1)):(zt().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),s=!1)}}else zt().warn("Indexed geometries must specify faces"),s=!1;break}default:zt().warn(`Unsupported topology '${n}'`),s=!1}t.params.material||(zt().warn("Geometry requires material"),s=!1);const r=t.params.vertexAttributes;for(const t in r){r[t].values||(zt().warn("Geometries with externally defined attributes are not yet supported"),s=!1)}return s}function Wt(t,e){const n=new Array,s=new Array,r=new Array,i=new pt,o=t.resource,a=g.parse(o.version||"1.0","wosr");Zt.validate(a);const c=o.model.name,u=o.model.geometries,l=o.materialDefinitions??{},f=t.textures;let d=0;const p=new Map;for(let t=0;t<u.length;t++){const o=u[t];if(!Vt(o))continue;const a=Xt(o),c=o.params.vertexAttributes,h=[],m=t=>{if("PerAttributeArray"===o.params.topology)return null;const e=o.params.faces;for(const n in e)if(n===t)return e[n].values;return null},g=c[vt.POSITION],y=g.values.length/g.valuesPerElement;for(const t in c){const e=c[t],n=e.values,s=m(t)??mt(y);h.push([t,new wt(n,s,e.valuesPerElement,!0)])}const x=a.texture,b=f&&f[x];if(b&&!p.has(x)){const{image:t,parameters:e}=b,n=new H(t,e);s.push(n),p.set(x,n)}const j=p.get(x),A=j?j.id:void 0,T=a.material;let v=i.get(T,x);if(null==v){const t=l[T.slice(T.lastIndexOf("/")+1)].params;1===t.transparency&&(t.transparency=0);const n=b&&b.alphaChannelUsage,s=t.transparency>0||"transparency"===n||"maskAndTransparency"===n,r=b?Kt(b.alphaChannelUsage):void 0,o={ambient:w(t.diffuse),diffuse:w(t.diffuse),opacity:1-(t.transparency||0),transparent:s,textureAlphaMode:r,textureAlphaCutoff:.33,textureId:A,initTextureTransparent:!0,doubleSided:!0,cullFace:xt.None,colorMixMode:t.externalColorMixMode||"tint",textureAlphaPremultiplied:b?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(o,e.materialParameters),v=new L(o,e),i.set(T,x,v)}r.push(v);const M=new Gt(v,h);d+=h.find((t=>t[0]===vt.POSITION))?.[1]?.indices.length??0,n.push(M)}return{engineResources:[{name:c,stageResources:{textures:s,materials:r,geometries:n},pivotOffset:o.model.pivotOffset,numberOfVertices:d,lodThreshold:null}],referenceBoundingBox:qt(n)}}function qt(t){const e=y();return t.forEach((t=>{const n=t.boundingInfo;null!=n&&(f(e,n.bbMin),f(e,n.bbMax))})),e}async function Qt(t,e){const n=new Array;for(const s in t){const r=t[s],i=r.images[0].data;if(!i){zt().warn("Externally referenced texture data is not yet supported");continue}const o=r.encoding+";base64,"+i,a="/textureDefinitions/"+s,c="rgba"===r.channels?r.alphaChannelUsage||"transparency":"none",u={noUnpackFlip:!0,wrap:{s:b.REPEAT,t:b.REPEAT},preMultiplyAlpha:Kt(c)!==bt.Opaque},l=e?.disableTextures?Promise.resolve(null):gt(o,e);n.push(l.then((t=>({refId:a,image:t,parameters:u,alphaChannelUsage:c}))))}const s=await Promise.all(n),r={};for(const t of s)r[t.refId]=t;return r}function Kt(t){switch(t){case"mask":return bt.Mask;case"maskAndTransparency":return bt.MaskBlend;case"none":return bt.Opaque;default:return bt.Blend}}function Xt(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const Zt=new g(1,2,"wosr");async function Jt(t,e){const n=Yt(j(t));if("wosr"===n.fileType){const t=await(e.cache?e.cache.loadWOSR(n.url,e):Ht(n.url,e)),{engineResources:s,referenceBoundingBox:r}=Wt(t,e);return{lods:s,referenceBoundingBox:r,isEsriSymbolResource:!1,isWosr:!0}}let s;if(e.cache)s=await e.cache.loadGLTF(n.url,e,!!e.usePBR);else{const{loadGLTF:t}=await import("./p-fdeec28b.js");s=await t(new ot(e.streamDataRequester),n.url,e,e.usePBR)}const r=s.model.meta?.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&null!=r&&"EsriRealisticTreesStyle"===s.meta.ESRI_webstyle;i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ie(s,r));const o=!!e.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:W}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:q},c={...e.materialParameters,treeRendering:i},{engineResources:u,referenceBoundingBox:l}=te(s,a,c,e,n.specifiedLodIndex);return{lods:u,referenceBoundingBox:l,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function Yt(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(e)return{fileType:"gltf",url:e[1],specifiedLodIndex:null!=e[4]?Number(e[4]):null};return t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function te(t,e,n,s,r){const i=t.model,o=new Array,a=new Map,c=new Map,u=i.lods.length,l=y();return i.lods.forEach(((t,d)=>{const p=!0===s.skipHighLods&&(u>1&&0===d||u>3&&1===d)||!1===s.skipHighLods&&null!=r&&d!==r;if(p&&0!==d)return;const h=new Et(t.name,t.lodThreshold,[0,0,0]);t.parts.forEach((t=>{const r=p?new L({},s):ee(i,t,h,e,n,a,c,s),{geometry:o,vertexCount:u}=ne(t,r??new L({},s)),m=o.boundingInfo;null!=m&&0===d&&(f(l,m.bbMin),f(l,m.bbMax)),null!=r&&(h.stageResources.geometries.push(o),h.numberOfVertices+=u)})),p||o.push(h)})),{engineResources:o,referenceBoundingBox:l}}function ee(t,e,n,s,r,i,o,a){const c=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),u=t.materials.get(e.material),l=null!=e.attributes.texCoord0,f=null!=e.attributes.normal;if(null==u)return null;const d=re(u.alphaMode);if(!i.has(c)){if(l){const e=(e,n=!1)=>{if(null!=e&&!o.has(e)){const s=t.textures.get(e);if(null!=s){const t=s.data;o.set(e,new H(dt(t)?t.data:t,{...s.parameters,preMultiplyAlpha:!dt(t)&&n,encoding:dt(t)&&null!=t.encoding?t.encoding:void 0}))}}};e(u.textureColor,d!==bt.Opaque),e(u.textureNormal),e(u.textureOcclusion),e(u.textureEmissive),e(u.textureMetallicRoughness)}const n=u.color[0]**(1/ft),p=u.color[1]**(1/ft),h=u.color[2]**(1/ft),m=u.emissiveFactor[0]**(1/ft),g=u.emissiveFactor[1]**(1/ft),w=u.emissiveFactor[2]**(1/ft),y=null!=u.textureColor&&l?o.get(u.textureColor):null,x=V({normalTexture:u.textureNormal,metallicRoughnessTexture:u.textureMetallicRoughness,metallicFactor:u.metallicFactor,roughnessFactor:u.roughnessFactor,emissiveTexture:u.textureEmissive,emissiveFactor:u.emissiveFactor,occlusionTexture:u.textureOcclusion}),b=null!=u.normalTextureTransform?.scale?u.normalTextureTransform?.scale:U;i.set(c,new L({...s,transparent:d===bt.Blend,customDepthTest:jt.Lequal,textureAlphaMode:d,textureAlphaCutoff:u.alphaCutoff,diffuse:[n,p,h],ambient:[n,p,h],opacity:u.opacity,doubleSided:u.doubleSided,doubleSidedType:"winding-order",cullFace:u.doubleSided?xt.None:xt.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:f?Mt.Attribute:Mt.ScreenDerivative,castShadows:!0,receiveShadows:u.receiveShadows,receiveAmbientOcclusion:u.receiveAmbientOcclustion,textureId:null!=y?y.id:void 0,colorMixMode:u.colorMixMode,normalTextureId:null!=u.textureNormal&&l?o.get(u.textureNormal).id:void 0,textureAlphaPremultiplied:null!=y&&!!y.parameters.preMultiplyAlpha,occlusionTextureId:null!=u.textureOcclusion&&l?o.get(u.textureOcclusion).id:void 0,emissiveTextureId:null!=u.textureEmissive&&l?o.get(u.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=u.textureMetallicRoughness&&l?o.get(u.textureMetallicRoughness).id:void 0,emissiveFactor:[m,g,w],mrrFactors:x?N:[u.metallicFactor,u.roughnessFactor,s.mrrFactors[2]],isSchematic:x,colorTextureTransformMatrix:_t(u.colorTextureTransform),normalTextureTransformMatrix:_t(u.normalTextureTransform),scale:[b[0],b[1]],occlusionTextureTransformMatrix:_t(u.occlusionTextureTransform),emissiveTextureTransformMatrix:_t(u.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:_t(u.metallicRoughnessTextureTransform),...r},a))}const p=i.get(c);if(n.stageResources.materials.push(p),l){const t=t=>{null!=t&&n.stageResources.textures.push(o.get(t))};t(u.textureColor),t(u.textureNormal),t(u.textureOcclusion),t(u.textureEmissive),t(u.textureMetallicRoughness)}return p}function ne(t,e){const n=t.attributes.position.count,s=at(t.indices||n,t.primitiveType),r=D(3*n),{typedBuffer:i,typedBufferStride:o}=t.attributes.position;tt(r,i,t.transform,3,o);const a=[[vt.POSITION,new wt(r,s,3,!0)]];if(null!=t.attributes.normal){const e=D(3*n),{typedBuffer:r,typedBufferStride:i}=t.attributes.normal;A(se,t.transform),et(e,r,se,3,i),T(se)&&nt(e,e),a.push([vt.NORMAL,new wt(e,s,3,!0)])}if(null!=t.attributes.tangent){const e=D(4*n),{typedBuffer:r,typedBufferStride:i}=t.attributes.tangent;v(se,t.transform),rt(e,r,se,4,i),T(se)&&nt(e,e,4),a.push([vt.TANGENT,new wt(e,s,4,!0)])}if(null!=t.attributes.texCoord0){const e=D(2*n),{typedBuffer:r,typedBufferStride:i}=t.attributes.texCoord0;ct(e,r,2,i),a.push([vt.UV0,new wt(e,s,2,!0)])}const c=t.attributes.color;if(null!=c){const e=new Uint8Array(4*n);4===c.elementCount?c instanceof Q?it(e,c,255):c instanceof K?ut(e,c):c instanceof X&&it(e,c,1/256):(e.fill(255),c instanceof Z?st(e,c.typedBuffer,255,4,c.typedBufferStride):t.attributes.color instanceof J?lt(e,c.typedBuffer,4,t.attributes.color.typedBufferStride):t.attributes.color instanceof Y&&st(e,c.typedBuffer,1/256,4,c.typedBufferStride)),a.push([vt.COLOR,new wt(e,s,4,!0)])}return{geometry:new Gt(e,a),vertexCount:n}}const se=C();function re(t){switch(t){case"BLEND":return bt.Blend;case"MASK":return bt.Mask;case"OPAQUE":case null:case void 0:return bt.Opaque}}function ie(t,e){for(let n=0;n<t.model.lods.length;++n){const r=t.model.lods[n];for(const i of r.parts){const r=i.attributes.normal;if(null==r)return;const a=i.attributes.position,c=a.count,u=s(),l=s(),f=s(),d=new Uint8Array(4*c),p=new Float64Array(3*c),h=M($(),i.transform);let m=0,g=0;for(let s=0;s<c;s++){a.getVec(s,l),r.getVec(s,u),o(l,l,i.transform),B(f,l,e.center),I(f,f,e.radius);const c=f[2],w=F(f),y=Math.min(.45+.55*w*w,1);I(f,f,e.radius),null!==h&&o(f,f,h),R(f,f),n+1!==t.model.lods.length&&t.model.lods.length>1&&S(f,f,u,c>-1?.2:Math.min(-4*c-3.8,1)),p[m]=f[0],p[m+1]=f[1],p[m+2]=f[2],m+=3,d[g]=255*y,d[g+1]=255*y,d[g+2]=255*y,d[g+3]=255,g+=4}i.attributes.normal=new Z(p),i.attributes.color=new K(d)}}}export{Jt as fetch,Yt as parseUrl};
//# sourceMappingURL=p-5cdc51dc.js.map