{"version":3,"names":["t","Math","PI","n","o","a","rotation","r","abs","cos","s","sin","u","c","size","round","h","y","p","x","S","f","w","container","fetchSource","requestUpdate","imageMaxWidth","imageMaxHeight","imageRotationSupported","imageNormalizationSupported","hidpi","M","e","constructor","super","this","_imagePromise","bitmaps","update","i","stationary","destroyed","state","spatialReference","pixelRatio","worldScreenWidth","m","l","d","floor","extent","xmin","valid","xmax","g","children","slice","paddedViewState","center","_singleExport","resolution","min","ceil","_tiledExport","includes","push","fadeOut","then","remove","destroy","fadeIn","Promise","all","updateExports","async","visible","stage","invalidateTexture","requestRender","forEach","updating","signal","ymax","width","opacity","addChild","setSourceAsync","_export","create","scales","scale","getTileCoverage","set","getTileBounds","prototype","_"],"sources":["./node_modules/@arcgis/core/views/2d/viewStateUtils.js","./node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nconst t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}function a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}export{a as getBBox,o as getOuterSize};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Accessor.js\";import\"../../../../core/has.js\";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from\"../../../../core/promiseUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/Logger.js\";import\"../../../../core/RandomLCG.js\";import{subclass as n}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{create as p,toExtent as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as h}from\"../../../../geometry/support/spatialReferenceUtils.js\";import l from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as d,getBBox as c}from\"../../viewStateUtils.js\";import{Bitmap as u}from\"../../engine/Bitmap.js\";import g from\"../../tiling/TileInfoView.js\";import f from\"../../tiling/TileKey.js\";const y=p(),x=[0,0],S=new f(0,0,0,0),w={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let M=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=w.hidpi,this.imageMaxWidth=w.imageMaxWidth,this.imageMaxHeight=w.imageMaxHeight,this.imageRotationSupported=w.imageRotationSupported,this.imageNormalizationSupported=w.imageNormalizationSupported,this.update=i((async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=h(i.spatialReference),a=this.hidpi?t.pixelRatio:1,n=i.worldScreenWidth>0,p=n&&this.imageNormalizationSupported&&i.worldScreenWidth<i.size[0],m=Math.round((this.imageMaxWidth??0)/a),l=Math.round((this.imageMaxHeight??0)/a);p?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):d(x,i);const c=Math.floor(x[0])>m||Math.floor(x[1])>l,u=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),g=!this.imageNormalizationSupported&&u,f=!c&&!g,y=this.imageRotationSupported?i.rotation:0,S=this.container.children.slice();if(f){const t=p?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,x,t,i.resolution,y,a,e)}else{let t=Math.min(m,l);n&&(t=Math.min(i.worldScreenWidth,t),t=Math.round(i.worldScreenWidth/Math.ceil(i.worldScreenWidth/t))),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of S)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(w){this._imagePromise=null,r(w)}}),5e3),this.updateExports=i((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=s(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const n=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const p=new u(null,!0);return p.x=t.xmin,p.y=t.ymax,p.resolution=t.width/e,p.rotation=r,p.pixelRatio=s,p.opacity=0,this.container.addChild(p),await p.setSourceAsync(n,a),o(a),p}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const n=m(y,t.spatialReference);return[await this._export(n,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=l.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const n=[];return a.forEach(((r,a,p,h)=>{S.set(r,a,p,0),s.getTileBounds(y,S);const l=m(y,t.spatialReference);n.push(this._export(l,e,e,0,i,o).then((t=>(0!==h&&(S.set(r,a,p,h),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t))))})),Promise.all(n)}};t([a()],M.prototype,\"_imagePromise\",void 0),t([a()],M.prototype,\"bitmaps\",void 0),t([a()],M.prototype,\"container\",void 0),t([a()],M.prototype,\"fetchSource\",void 0),t([a()],M.prototype,\"hidpi\",void 0),t([a()],M.prototype,\"imageMaxWidth\",void 0),t([a()],M.prototype,\"imageMaxHeight\",void 0),t([a()],M.prototype,\"imageRotationSupported\",void 0),t([a()],M.prototype,\"imageNormalizationSupported\",void 0),t([a()],M.prototype,\"requestUpdate\",void 0),t([a()],M.prototype,\"updating\",null),M=t([n(\"esri.views.2d.layers.support.ExportStrategy\")],M);const _=M;export{_ as default};\n"],"mappings":"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"}