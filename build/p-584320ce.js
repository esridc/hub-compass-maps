import{m0 as t,ar as s,mN as n,dv as i,nc as r,$ as e,b5 as h,kI as o,ag as u,nf as c,eo as a,lN as l,ng as f,ao as m}from"./p-aad64c9f.js";import{s as d,b as _,w as T,k as M,H as O,U as N,E as R,N as b}from"./p-175d4a9b.js";import{M as p,h as E,f as g,r as x,p as A}from"./p-a040372a.js";import{i as F}from"./p-dc645a50.js";function j(t){return t?{ray:_(t.ray),c0:t.c0,c1:t.c1}:{ray:_(),c0:0,c1:Number.MAX_VALUE}}new d((()=>j()));function w(t){return t?[p(t[0]),p(t[1]),p(t[2]),p(t[3]),p(t[4]),p(t[5])]:[p(),p(),p(),p(),p(),p()]}function S(){return[e(),e(),e(),e(),e(),e(),e(),e()]}function I(t,s){for(let n=0;n<D;n++)E(t[n],s[n]);return t}function P(r,e,h,o=C){const u=t(g.get(),e,r);s(u,u);for(let t=0;t<L;++t){const s=n(x.get(),y[t],u);i(o[t],s[0]/s[3],s[1]/s[3],s[2]/s[3])}k(h,o)}function k(t,s){A(s[v.FAR_BOTTOM_LEFT],s[v.NEAR_BOTTOM_LEFT],s[v.NEAR_TOP_LEFT],t[H.LEFT]),A(s[v.NEAR_BOTTOM_RIGHT],s[v.FAR_BOTTOM_RIGHT],s[v.FAR_TOP_RIGHT],t[H.RIGHT]),A(s[v.FAR_BOTTOM_LEFT],s[v.FAR_BOTTOM_RIGHT],s[v.NEAR_BOTTOM_RIGHT],t[H.BOTTOM]),A(s[v.NEAR_TOP_LEFT],s[v.NEAR_TOP_RIGHT],s[v.FAR_TOP_RIGHT],t[H.TOP]),A(s[v.NEAR_BOTTOM_LEFT],s[v.NEAR_BOTTOM_RIGHT],s[v.NEAR_TOP_RIGHT],t[H.NEAR]),A(s[v.FAR_BOTTOM_RIGHT],s[v.FAR_BOTTOM_LEFT],s[v.FAR_TOP_LEFT],t[H.FAR])}function B(t,s){for(let n=0;n<D;n++){const i=t[n];if(i[0]*s[0]+i[1]*s[1]+i[2]*s[2]+i[3]>=s[3])return!1}return!0}var H,v;!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.NEAR=4]="NEAR",t[t.FAR=5]="FAR"}(H||(H={})),function(t){t[t.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",t[t.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",t[t.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",t[t.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",t[t.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",t[t.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",t[t.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",t[t.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(v||(v={}));const D=6,L=8,y=[r(-1,-1,-1,1),r(1,-1,-1,1),r(1,1,-1,1),r(-1,1,-1,1),r(-1,-1,1,1),r(1,-1,1,1),r(1,1,1,1),r(-1,1,1,1)];new d(j);const C=S();class G{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,s){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new z,this._objectCount=0,s&&(void 0!==s.maximumObjectsPerNode&&(this._maximumObjectsPerNode=s.maximumObjectsPerNode),void 0!==s.maximumDepth&&(this._maximumDepth=s.maximumDepth))}destroy(){this._degenerateObjects.clear(),z.clearPool(),ot[0]=null,mt.prune(),Nt.prune()}add(t,s=t.length){this._objectCount+=s,this._grow(t,s);const n=z.acquire();for(let i=0;i<s;i++){const s=t[i];this._isDegenerate(s)?this._degenerateObjects.add(s):(n.init(this._root),this._add(s,n))}z.release(n)}remove(t,s=null){this._objectCount-=t.length;const n=z.acquire();for(const i of t){const t=s??T(this.objectToBoundingSphere(i),dt);it(t[3])?(n.init(this._root),V(i,t,n)):this._degenerateObjects.delete(i)}z.release(n),this._shrink()}update(t,s){if(!it(s[3])&&this._isDegenerate(t))return;const n=ut(t);this.remove(n,s),this.add(n)}forEachAlongRay(t,s,n){const i=M(t,s);J(this._root,(t=>{if(!q(i,t))return!1;const s=t.node;return s.terminals.forAll((t=>{this._intersectsObject(i,t)&&n(t)})),null!==s.residents&&s.residents.forAll((t=>{this._intersectsObject(i,t)&&n(t)})),!0}))}forEachAlongRayWithVerticalOffset(t,s,n,i){const r=M(t,s);J(this._root,(t=>{if(!U(r,t,i))return!1;const s=t.node;return s.terminals.forAll((t=>{this._intersectsObjectWithOffset(r,t,i)&&n(t)})),null!==s.residents&&s.residents.forAll((t=>{this._intersectsObjectWithOffset(r,t,i)&&n(t)})),!0}))}forEach(t){J(this._root,(s=>{const n=s.node;return n.terminals.forAll(t),null!==n.residents&&n.residents.forAll(t),!0})),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,s,n,i=(()=>!0),r=1/0){let e=1/0,h=1/0,o=null;const u=st(t,s),c=u=>{if(--r,!i(u))return;const c=this.objectToBoundingSphere(u);if(!B(n,c))return;const a=nt(t,s,N(c)),l=a-c[3],f=a+c[3];l<e&&(e=l,h=f,o=u)};return K(this._root,(i=>{if(r<=0||!B(n,i.bounds))return!1;a(at,u,i.halfSize),l(at,at,N(i.bounds));if(nt(t,s,at)>h)return!1;const e=i.node;return e.terminals.forAll((t=>c(t))),null!==e.residents&&e.residents.forAll((t=>c(t))),!0}),t,s),o}forEachInDepthRange(t,s,n,i,r,e,h){let o=-1/0,u=1/0;const c={setRange:t=>{n===G.DepthOrder.FRONT_TO_BACK?(o=Math.max(o,t.near),u=Math.min(u,t.far)):(o=Math.max(o,-t.far),u=Math.min(u,-t.near))}};c.setRange(i);const f=nt(s,n,t),m=st(s,n),d=st(s,-n),_=t=>{if(!h(t))return;const i=this.objectToBoundingSphere(t),a=N(i),l=nt(s,n,a)-f,m=l-i[3],d=l+i[3];m>u||d<o||!B(e,i)||r(t,c)};K(this._root,(t=>{if(!B(e,t.bounds))return!1;a(at,m,t.halfSize),l(at,at,N(t.bounds));if(nt(s,n,at)-f>u)return!1;a(at,d,t.halfSize),l(at,at,N(t.bounds));if(nt(s,n,at)-f<o)return!1;const i=t.node;return i.terminals.forAll((t=>_(t))),null!==i.residents&&i.residents.forAll((t=>_(t))),!0}),s,n)}forEachNode(t){J(this._root,(s=>t(s.node,s.bounds,s.halfSize,s.depth)))}forEachNeighbor(t,s){const n=b(s),i=N(s),r=s=>{const r=this.objectToBoundingSphere(s),e=b(r),h=n+e;return!(f(N(r),i)-h*h<=0)||t(s)};let e=!0;const h=t=>{e&&(e=r(t))};J(this._root,(t=>{const s=b(t.bounds),r=n+s;if(f(N(t.bounds),i)-r*r>0)return!1;const o=t.node;return o.terminals.forAll(h),e&&null!==o.residents&&o.residents.forAll(h),e})),e&&this.forEachDegenerateObject(h)}_intersectsObject(t,s){const n=this.objectToBoundingSphere(s);return!(n[3]>0)||O(n,t)}_intersectsObjectWithOffset(t,s,n){const i=this.objectToBoundingSphere(s);return!(i[3]>0)||O(n.applyToBoundingSphere(i),t)}_add(t,s){s.advanceTo(this.objectToBoundingSphere(t))?s.node.terminals.push(t):(s.node.residents.push(t),s.node.residents.length>this._maximumObjectsPerNode&&s.depth<this._maximumDepth&&this._split(s))}_split(t){const s=t.node.residents;t.node.residents=null;for(let n=0;n<s.length;n++){const i=z.acquire().init(t);this._add(s.at(n),i),z.release(i)}}_grow(t,s){if(0!==s&&(Z(t,s,(t=>this.objectToBoundingSphere(t)),_t),it(_t[3])&&!this._fitsInsideTree(_t)))if($(this._root.node))T(_t,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const t=this._rootBoundsForRootAsSubNode(_t);this._placingRootViolatesMaxDepth(t)?this._rebuildTree(_t,t):this._growRootAsSubNode(t),z.release(t)}}_rebuildTree(t,s){u(N(Tt),N(s.bounds)),Tt[3]=s.halfSize,Z([t,Tt],2,(t=>t),Mt);const n=z.acquire().init(this._root);this._root.initFrom(null,Mt,Mt[3]),this._root.increaseHalfSize(1.25),J(n,(t=>(this.add(t.node.terminals.data,t.node.terminals.length),null!==t.node.residents&&this.add(t.node.residents.data,t.node.residents.length),!0))),z.release(n)}_placingRootViolatesMaxDepth(t){const s=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return J(this._root,(t=>(n=Math.max(n,t.depth),n+s<=this._maximumDepth))),n+s>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const s=t[3],n=t;let i=-1/0;const r=this._root.bounds,e=this._root.halfSize;for(let t=0;t<3;t++){const h=r[t]-e-(n[t]-s),o=n[t]+s-(r[t]+e),u=Math.max(0,Math.ceil(h/(2*e))),c=Math.max(0,Math.ceil(o/(2*e)))+1,a=2**Math.ceil(Math.log(u+c)*Math.LOG2E);i=Math.max(i,a),Ot[t].min=u,Ot[t].max=c}for(let t=0;t<3;t++){let s=Ot[t].min,n=Ot[t].max;const h=(i-(s+n))/2;s+=Math.ceil(h),n+=Math.floor(h);const o=r[t]-e-s*e*2;ct[t]=o+(n+s)*e}const h=i*e;return ct[3]=h*ht,z.acquire().initFrom(null,ct,h,0)}_growRootAsSubNode(t){const s=this._root.node;u(N(_t),N(this._root.bounds)),_t[3]=this._root.halfSize,this._root.init(t),t.advanceTo(_t,null,!0),t.node.children=s.children,t.node.residents=s.residents,t.node.terminals=s.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(-1===t)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let t=null;const s=this._root.node.children;let n=0,i=0;for(;i<s.length&&null==t;)n=i++,t=s[n];for(;i<s.length;)if(s[i++])return-1;return n}_isDegenerate(t){return!it(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const s=this._root.bounds,n=this._root.halfSize;return t[3]<=n&&t[0]>=s[0]-n&&t[0]<=s[0]+n&&t[1]>=s[1]-n&&t[1]<=s[1]+n&&t[2]>=s[2]-n&&t[2]<=s[2]+n}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:s,_objectCount:n}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:s,objectCount:n,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(t){const s=t.children.map((t=>t?this._nodeToJSON(t):null)),n=t.residents?.map((t=>this.objectToBoundingSphere(t))),i=t.terminals?.map((t=>this.objectToBoundingSphere(t)));return{children:s,residents:n,terminals:i}}static fromJSON(t){const s=new G((t=>t),{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return s._objectCount=t.objectCount,s._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),s}}class z{constructor(){this.bounds=R(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,s,n,i=this.depth){return this.node=null!=t?t:z.createEmptyNode(),s&&T(s,this.bounds),this.halfSize=n,this.depth=i,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*ht}advance(t){let s=this.node.children[t];s||(s=z.createEmptyNode(),this.node.children[t]=s),this.node=s,this.halfSize/=2,this.depth++;const n=rt[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,s,n=!1){for(;;){if(this.isTerminalFor(t))return s&&s(this,-1),!0;if(this.isLeaf()){if(!n)return s&&s(this,-1),!1;this.node.residents=null}const i=this._childIndex(t);s&&s(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const s=this.bounds;return(s[0]<t[0]?1:0)+(s[1]<t[1]?2:0)+(s[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new o({shrink:!0}),residents:new o({shrink:!0})}}static acquire(){return z._pool.acquire()}static release(t){z._pool.release(t)}static clearPool(){z._pool.prune()}}function J(t,s){let n=z.acquire().init(t);const i=[n];for(;0!==i.length;){if(n=i.pop(),s(n)&&!n.isLeaf())for(let t=0;t<n.node.children.length;t++){n.node.children[t]&&i.push(z.acquire().init(n).advance(t))}z.release(n)}}function K(t,s,n,i=G.DepthOrder.FRONT_TO_BACK){let r=z.acquire().init(t);const e=[r];for(tt(n,i,Rt);0!==e.length;){if(r=e.pop(),s(r)&&!r.isLeaf())for(let t=7;t>=0;--t){const s=Rt[t];r.node.children[s]&&e.push(z.acquire().init(r).advance(s))}z.release(r)}}function V(t,s,n){mt.clear();const i=n.advanceTo(s,((t,s)=>{mt.push(t.node),mt.push(s)}))?n.node.terminals:n.node.residents;if(i.removeUnordered(t),0===i.length)for(let t=mt.length-2;t>=0;t-=2){if(!W(mt.data[t],mt.data[t+1]))break}}function W(t,s){return s>=0&&(t.children[s]=null),!!$(t)&&(null===t.residents&&(t.residents=new o({shrink:!0})),!0)}function q(t,s){return Y(N(s.bounds),2*-s.halfSize,lt),Y(N(s.bounds),2*s.halfSize,ft),F(t.origin,t.direction,lt,ft)}function U(t,s,n){return Y(N(s.bounds),2*-s.halfSize,lt),Y(N(s.bounds),2*s.halfSize,ft),n.applyToMinMax(lt,ft),F(t.origin,t.direction,lt,ft)}function $(t){if(0!==t.terminals.length)return!1;if(null!==t.residents)return 0===t.residents.length;for(let s=0;s<t.children.length;s++)if(t.children[s])return!1;return!0}function Q(t,s){t[0]=Math.min(t[0],s[0]-s[3]),t[1]=Math.min(t[1],s[1]-s[3]),t[2]=Math.min(t[2],s[2]-s[3])}function X(t,s){t[0]=Math.max(t[0],s[0]+s[3]),t[1]=Math.max(t[1],s[1]+s[3]),t[2]=Math.max(t[2],s[2]+s[3])}function Y(t,s,n){n[0]=t[0]+s,n[1]=t[1]+s,n[2]=t[2]+s}function Z(t,s,n,i){if(1===s){const s=n(t[0]);T(s,i)}else{lt[0]=1/0,lt[1]=1/0,lt[2]=1/0,ft[0]=-1/0,ft[1]=-1/0,ft[2]=-1/0;for(let i=0;i<s;i++){const s=n(t[i]);it(s[3])&&(Q(lt,s),X(ft,s))}c(N(i),lt,ft,.5),i[3]=Math.max(ft[0]-lt[0],ft[1]-lt[1],ft[2]-lt[2])/2}}function tt(t,s,n){if(!Nt.length)for(let t=0;t<8;++t)Nt.push({index:0,distance:0});for(let n=0;n<8;++n){const i=rt[n];Nt.data[n].index=n,Nt.data[n].distance=nt(t,s,i)}Nt.sort(((t,s)=>t.distance-s.distance));for(let t=0;t<8;++t)n[t]=Nt.data[t].index}function st(t,s){let n,i=1/0;for(let r=0;r<8;++r){const e=nt(t,s,et[r]);e<i&&(i=e,n=et[r])}return n}function nt(t,s,n){return s*(t[0]*n[0]+t[1]*n[1]+t[2]*n[2])}function it(t){return!isNaN(t)&&t!==-1/0&&t!==1/0&&t>0}z._pool=new h(z),function(t){var s;(s=t.DepthOrder||(t.DepthOrder={}))[s.FRONT_TO_BACK=1]="FRONT_TO_BACK",s[s.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(G||(G={}));const rt=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],et=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],ht=Math.sqrt(3),ot=[null];function ut(t){return ot[0]=t,ot}const ct=R(),at=e(),lt=e(),ft=e(),mt=new o,dt=R(),_t=R(),Tt=R(),Mt=R(),Ot=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],Nt=new o,Rt=[0,0,0,0,0,0,0,0],bt=G;export{w as H,P as L,I as N,bt as Y};
//# sourceMappingURL=p-584320ce.js.map