import{he as a,o as t,b as e,s as o,j as n,S as r,a as i,i as s,hf as c,L as l,hg as f,hh as u,hi as p,hj as w,e1 as d,hk as m,T as h,hl as y,hm as _,hn as v,ad as W,ho as j,f as b}from"./p-aad64c9f.js";import{i as R}from"./p-f3c2956c.js";import{p as g}from"./p-9fbfb741.js";import{r as O,t as A}from"./p-cc72a972.js";import"./p-2af77f97.js";import"./p-7523d580.js";import"./p-11802a1b.js";const C=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((a=>a.toLowerCase()));async function P(t,e,o){o??={},M(t,e),await a((()=>!e.updatingFromView)),await e.load(),await N(e),await O(e),await B(t,e);const n=e.portalItem,{json:r,jsonContext:i}=await k(e,n);return A(i,{errorName:`${t.name}:save`},o),await S(e,n),await ha(t,e,n,r,i),await Promise.all([e.updateItemThumbnail(),g(e.resourceReferences,i)]),n}async function k(a,e){const o=t(e,"web-map",!0),n=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:n,jsonContext:o}}async function D(t,e,o,n){n??={};const r=G(t,o);await a((()=>!e.updatingFromView)),await e.load(),await N(e),await O(e),await B(t,e);const{json:i,jsonContext:s}=await k(e,r);A(s,{errorName:`${t.name}:save`},n),await X(e,r);const c=e.getThumbnailState();return await ya(t,e,r,i,s,n)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(c),await Promise.all([e.updateItemThumbnail(),g(e.resourceReferences,s)]),r}function M(a,t){if(!t.portalItem)throw new o(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");$(a,t.portalItem)}function $(a,t){if(t.type!==a.itemType)throw new o(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function B(t,e){if(!e.basemap?.baseLayers.length)throw new o(`${t.name}:save`,"Map does not have a valid basemap with a base layer.");let r=null;if(await a((()=>{const a=j(e.initialViewProperties,e.basemap);return r=a.spatialReference,!a.updating})),!n(r,e.initialViewProperties.spatialReference))throw new o(`${t.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:r})}function G(a,t){let o=r.from(t);return o.id&&(o=o.clone(),o.id=null),o.type||(o.type=a.itemType),o.portal||(o.portal=e.getDefault()),$(a,o),o}function N(a){const t=[];return a.basemap&&t.push(a.basemap.load()),a.ground&&t.push(a.ground.load()),Promise.allSettled(t).then((()=>{}))}async function S(a,t){t.extent=await la(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await Y(a,t)}const T=b.JSAPI,x="CollectorDisabled",I="Collector",L="Data Editing",U="OfflineDisabled",z="Offline",E="Workforce Project",F="Workforce Worker",H="Workforce Dispatcher",J="Offline Map Areas",V="FieldMapsDisabled",q=b.DEVELOPER_BASEMAP,K="UtilityNetwork",Q="IPS";async function X(a,t){i(t,x),i(t,V),i(t,b.METADATA),i(t,U),i(t,J),i(t,H),i(t,E),i(t,F),await S(a,t)}async function Y(a,t){s(t,T),await Z(a),oa(a,t),na(a,t),ra(a,t),ia(a,t),sa(a,t),ca(a,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((a,t,e)=>e.indexOf(a)===t)))}function Z(a){const t=aa(a).map((a=>a.load())).toArray();return Promise.allSettled(t).then((()=>{}))}function aa(a){return a.allLayers.concat(a.allTables)}function ta(a){return aa(a).some((a=>a.loaded&&l(a)&&a.capabilities.operations.supportsEditing&&a.editingEnabled&&("subtype-group"!==a.type||a.sublayers.some((a=>a.editingEnabled)))))}function ea(a){return aa(a).filter((a=>"group"!==a.type)).every((t=>t.loaded&&pa(a,t)))}function oa(a,t){c(t,x)||c(t,E)||c(t,F)||c(t,H)||!ta(a)?i(t,I):s(t,I)}function na(a,t){ta(a)?s(t,L):i(t,L)}function ra(a,t){!c(t,U)&&ea(a)?s(t,z):i(t,z)}function ia(a,t){w(a.basemap)?s(t,q):i(t,q)}function sa(a,t){a.utilityNetworks?.length?s(t,K):i(t,K)}function ca(a,t){a.ipsInfo?s(t,Q):i(t,Q)}async function la(a,t){const e=t.clone().normalize();let o;if(e.length>1)for(const a of e)o?a.width>o.width&&(o=a):o=a;else o=e[0];return fa(a,o)}async function fa(a,t){const e=t.spatialReference;if(e.isWGS84)return t.clone();if(e.isWebMercator)return d(t);const{getGeometryServiceURL:o}=await import("./p-708584c5.js"),n=await o(a),r=new m({geometries:[t],outSpatialReference:h.WGS84});return(await y(n,r))[0]}function ua(a){return f(a)||"map-notes"===a.type||"route"===a.type}function pa(a,t){return l(t)&&t.capabilities.operations.supportsSync||ua(t)&&!t.portalItem||wa(t)&&!da(t)&&t.spatialReference.equals(a.initialViewProperties.spatialReference)}function wa(a){return("tile"===a.type||"vector-tile"===a.type)&&(a.capabilities.operations.supportsExportTiles||ma(a)||p(a))}function da(a){return"vector-tile"===a.type&&Object.keys(a.sourceNameToSource).length>1}function ma(a){return"tile"===a.type&&(u(a.url)&&C.some((t=>a.url?.toLowerCase().includes("/"+t+"/"))))}async function ha(a,t,e,o,n){await e.update({data:o}),Wa(a,t,e,o,n)}async function ya(a,t,e,n,r,i){const s=t.portalItem,c={item:s,authenticated:!(!s?.id||!s.portal.user)},l=e.portal;await l.signIn();const{copyAllowed:f,itemReloaded:u}=await _a(c,l);if(c.authenticated||=u,!f)throw new o(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const p=await va(e,c,n,i);return t.portalItem=e,Wa(a,t,e,n,r),p}async function _a(a,t){const{item:e,authenticated:o}=a;return e?.id&&e.typeKeywords?.includes("useOnly")?e.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await e.reload(),{copyAllowed:"admin"===e.itemControl||"update"===e.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function va(a,t,e,o){const n=a.portal,{item:r}=t,{folder:i,copyAllResources:s}=o;let c=!1;if(s&&r?.id&&_(r.portal.url,n.url)&&parseInt(r.portal.currentVersion,10)>=2023){const{total:a}=await r.fetchResources();c=!!a}if(c){const t=await r.copy({copyResources:"all",folder:i});a.id=t.id,a.portal=t.portal;const o=a.toJSON();await a.load(),a.read(o),await a.update({data:e})}else await n.user.addItem({item:a,folder:i,data:e});return c}function Wa(a,t,e,o,n){v.prototype.read.call(t,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:e.itemUrl?W(e.itemUrl):void 0}),R(n),t.resourceInfo=o}export{k as createJSON,va as initializeNewItem,_a as isCopyAllowed,P as save,D as saveAs};
//# sourceMappingURL=p-4bb33509.js.map