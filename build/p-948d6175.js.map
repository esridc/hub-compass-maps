{"version":3,"names":["async","g","e","t","r","instance","portalItem","id","load","b","validateItem","L","type","supportedTypes","includes","expectedType","join","o","url","n","title","s","l","i","S","read","c","a","u","M","resourceReferences","paths","readResourcePaths","h","sourceIsPortalItem","w","T","v","fetchData","context","layerModuleTypeMap","FeatureLayer","StreamLayer","SceneLayer","y","f","m","Promise","all","d","customParameters","E","k","loadContext","F","p","j","I","layers","map","tables","forEach","layerDefinition","push","filter","reverse","P","add","length","clone","layerId","sourceJSON","sublayerTitleMode","origin","portal","getDefault","showLegend","supportsData","D","x","C","layerType","supportedSourceTypes","fetchServiceMetadata","path","catch","find","G","layersJSON","Set","has","Map","Array","from","set","get"],"sources":["./node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as o}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as n}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as i}from\"./jsonContext.js\";import{getFirstLayerOrTable as l,preprocessFSItemData as c,populateSceneServiceItemData as u,getNumLayersAndTables as p,createSublayerData as y,instanceTypeToLayerType as f,getSublayersByLayerType as m,layerTypeToLayerModuleType as d}from\"./loadUtils.js\";import{hasTypeKeyword as w}from\"./portalItemUtils.js\";import{loadStyleRenderer as h}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as I}from\"../../support/requestPresets.js\";async function g(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),b(e),e.validateItem&&e.validateItem(r),L(e,t)}function b(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function L(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:n,title:s}=o,l=i(o,\"portal-item\");if(\"group\"===r.type)return S(r,l,e);n&&\"media\"!==r.type&&r.read({url:n},l);const c=new a,u=await M(e,c,t);return u&&r.read(u,l),r.resourceReferences={portalItem:o,paths:l.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},l),h(r,l)}async function S(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!w(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return T(t)}return t.read({title:n},r),v(t,a)}async function T(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=i(t,\"web-map\");e.read(r,a),await o(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function v(t,r){let o;const{portalItem:n}=t;if(!n)return;const s=n.type,i=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":o=i.FeatureLayer;break;case\"Stream Service\":o=i.StreamLayer;break;case\"Scene Service\":o=i.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const y=new a;let[f,m]=await Promise.all([o(),M(r,y)]),d=()=>f;if(\"Feature Service\"===s){const e=l(m)?.customParameters;m=n.url?await c(m,n.url,y):{},d=await E(m,i)||d;const r=await k(n.url,{customParameters:e,loadContext:y});return await F(t,d,m,r)}return\"Scene Service\"===s&&n.url&&(m=await u(n,m,y)),p(m)>0?await F(t,d,m):await j(t,d)}async function j(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await I(r.url);a&&F(e,t,{layers:a.layers?.map(y),tables:a.tables?.map(y)})}async function F(e,t,r,a){let o=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),o=o.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(o.reverse(),s.reverse()),o.forEach((o=>{const n=a?.(o);if(n||!a){const a=P(e,t(o),r,o,n);e.add(a)}})),s.length){const t=await n.FeatureLayer();s.forEach((o=>{const n=a?.(o);if(n||!a){const a=P(e,t,r,o,n);e.tables.add(a)}}))}}function P(e,t,r,a,o){const n=e.portalItem,i={portalItem:n.clone(),layerId:a.id};null!=a.url&&(i.url=a.url);const l=new t(i);if(\"sourceJSON\"in l&&(l.sourceJSON=o),\"subtype-group\"!==l.type&&\"catalog\"!==l.type&&(l.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===n.type){const e={origin:\"portal-item\",portal:n.portal||s.getDefault()};l.read(a,e);const t=r.showLegend;null!=t&&l.read({showLegend:t},e)}return l}async function M(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(s){}if(D(a)){let e=null;const r=await x(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=f(a.type),t=e?m(n,e)[0]:l(n);t&&(a.layerId=t.id)}e=C(n,a),\"OrientedImageryLayer\"===e?.layerType&&\"oriented-imagery\"===a.type&&a.supportedSourceTypes.add(\"Feature Layer\"),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function x(e,r,a){if(r?.layers&&r?.tables)return p(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:l(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function C(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&G(a,t)?a:null}function D(e){return\"stream\"!==e.type&&\"layerId\"in e}function G(e,t){const r=\"layerType\"in e&&e.layerType,{type:a}=t;return!(\"feature\"===a&&r&&\"ArcGISFeatureLayer\"!==e.layerType||\"catalog\"===a&&!r||\"oriented-imagery\"===a&&!r||\"subtype-group\"===a&&!r)}async function k(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}async function E(e,t){const{layers:r}=e;if(!r?.length)return;const a=new Set,o=[];for(const{layerType:i}of r){const e=i??\"ArcGISFeatureLayer\";if(a.has(e))continue;a.add(e);const r=t[d(e)];o.push(r())}const n=await Promise.all(o),s=new Map;return Array.from(a).forEach(((e,t)=>{s.set(e,n[t])})),({layerType:e})=>{const t=e??\"ArcGISFeatureLayer\";return s.get(t)}}export{g as load};\n"],"mappings":"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"}