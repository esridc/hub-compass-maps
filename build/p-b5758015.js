import{a1 as t,aO as e,an as s,ap as r}from"./p-028496e2.js";import{b as i}from"./p-f3b54403.js";import{r as n,a}from"./p-b0afd947.js";import{E as h}from"./p-d1d0c06b.js";import{i as c}from"./p-af8cc455.js";class o extends n{constructor(t,e,s,r,n,a,h=null){super(t,e,s,r,n,a),this.bitmap=new i(h),this.bitmap.coordScale=[n,a],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(t){this.bitmap.beforeRender(t),super.beforeRender(t)}afterRender(t){this.bitmap.afterRender(t),super.afterRender(t)}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}_createTransforms(){return{displayViewScreenMat3:t(),tileMat3:t()}}setTransform(t){super.setTransform(t),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}}class u extends c{get requiresDedicatedFBO(){return this.children.some((t=>"additive"===t.bitmap.blendFunction))}createTile(t){const s=this._tileInfoView.getTileBounds(e(),t),r=this._tileInfoView.getTileResolution(t.level),[i,n]=this._tileInfoView.tileInfo.size;return new o(t,r,s[0],s[3],i,n)}prepareRenderPasses(t){const e=t.registerRenderPass({name:"bitmap (tile)",brushes:[a.bitmap],target:()=>this.children.map((t=>t.bitmap)),drawPhase:h.MAP});return[...super.prepareRenderPasses(t),e]}doRender(t){this.visible&&t.drawPhase===h.MAP&&super.doRender(t)}}const p=t=>{let e=class extends t{attach(){this.view.timeline.record(`${this.layer.title} (BitmapTileLayer) Attach`),this._bitmapView=new u(this._tileInfoView),this.container.addChild(this._bitmapView)}detach(){this.container.removeChild(this._bitmapView),this._bitmapView?.removeAllChildren(),this._bitmapView=null}};return e=s([r("esri.views.2d.layers.BitmapTileLayerView2D")],e),e};function d(t){return t instanceof HTMLImageElement?t.naturalWidth:t.width}function l(t){return t instanceof HTMLImageElement?t.naturalHeight:t.height}function f(t,e,s,r){if(s.level===r.level)return e;const i=t.tileInfo.size,n=t.getTileResolution(s.level),a=t.getTileResolution(r.level);let h=t.getLODInfoAt(r.level);const c=h.getXForColumn(r.col),o=h.getYForRow(r.row);h=t.getLODInfoAt(s.level);const u=h.getXForColumn(s.col),p=h.getYForRow(s.row),f=d(e)/i[0],M=l(e)/i[1],w=Math.round(f*((c-u)/n)),R=Math.round(M*(-(o-p)/n)),T=Math.round(f*i[0]*(a/n)),b=Math.round(M*i[1]*(a/n)),y=m(i);return y.getContext("2d").drawImage(e,w,R,T,b,0,0,i[0],i[1]),y}function m(t){const e=document.createElement("canvas");return[e.width,e.height]=t,e}export{f as n,m as o,p as r};
//# sourceMappingURL=p-b5758015.js.map