import{ac as t,dZ as s,v as i,hc as e,rv as n,bD as h,el as o,rw as r,r as a,p as l,q as c}from"./p-aad64c9f.js";import"./p-2af77f97.js";const d={redo:"r",undo:"z"},u=Symbol(),m=Symbol(),p=Symbol();let w=class extends t{constructor(t){super(t),this._tool=null,this._updatingHandles=new s,this.enabled=!1,this._onPointerMove=i((async t=>{const s=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(t));this.destroyed||(this.removeHandles(m),s&&s!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles(e((()=>this.view.cursor=null)),m)))}))}initialize(){this.addHandles(n(this._updatingHandles)),this._updatingHandles.add((()=>this.enabled),(t=>this._setEnabled(t)),h),this._updatingHandles.add((()=>this._preferredInteractionTool),(()=>this._preferredInteractionToolChanged()))}get _validatedSelectedElement(){const t=this.selectedElement;if(!t)return null;const{layer:{source:s}}=this;return s?"hasElement"in s?s.hasElement(t)?t:null:s===t?t:null:null}get _preferredInteractionTool(){return this.options?.tool??"transform"}get updating(){return this._updatingHandles.updating}_setEnabled(t){if(this.removeHandles(u),!t)return;const{view:s}=this;this.addHandles([s.on("immediate-click",(t=>this._onClick(t)),o.TOOL),s.on("pointer-move",(t=>this._onPointerMove(t).catch((()=>{}))),o.TOOL),s.on("key-down",(t=>{t.key===d.undo&&this._tool?.canUndo()&&(this._tool.undo(),t.stopPropagation()),t.key===d.redo&&this._tool?.canRedo()&&(this._tool.redo(),t.stopPropagation())})),this._updatingHandles.add((()=>this._validatedSelectedElement),(t=>this._selectedElementChanged(t)),h),e((()=>{s.cursor=null,this._removeTool()}))],u)}async _findElementAtScreenPoint(t){const s=(await this.view.hitTest(t,{include:[this.layer]})).results[0];return"media"===s?.type?s.element:null}async _onClick(t){await this._updatingHandles.addPromise(t.async((async()=>{const s=await this._findElementAtScreenPoint(t);this.destroyed||(s&&t.stopPropagation(),this.selectedElement=s,this.selectedElement&&(this.view.cursor=null))})))}_preferredInteractionToolChanged(){const{_tool:t}=this;t&&(this._preferredInteractionTool===t.type||this._updatingHandles.addPromise(this._recreateTool()))}async _recreateTool(){this.removeHandles(p),this._removeTool();const t=this._validatedSelectedElement;if(!t)return;const s=new AbortController;this.addHandles(r(s),p);const{TransformTool:i,ControlPointsTransformTool:n}=await import("./p-cc53ee5a.js");if(s.signal.aborted)return;const{view:h}=this;switch(this._preferredInteractionTool){case"transform":this._tool=new i({target:t,view:h});break;case"reshape":this._tool=new n({mediaElement:t,view:h})}this.addHandles([e((()=>{this._tool&&(h.tools.remove(this._tool),this._tool=null)}))],this._tool),h.addAndActivateTool(this._tool)}_removeTool(){this._tool&&this.removeHandles(this._tool)}async _selectedElementChanged(t){t?.georeference?await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}};a([l()],w.prototype,"_validatedSelectedElement",null),a([l()],w.prototype,"_preferredInteractionTool",null),a([l({constructOnly:!0})],w.prototype,"view",void 0),a([l({constructOnly:!0})],w.prototype,"layer",void 0),a([l()],w.prototype,"selectedElement",void 0),a([l()],w.prototype,"enabled",void 0),a([l()],w.prototype,"options",void 0),a([l()],w.prototype,"updating",null),w=a([c("esri.views.2d.layers.support.MediaLayerInteraction")],w);export{w as MediaLayerInteraction};
//# sourceMappingURL=p-c2e4891b.js.map