import{fh as t,fi as i,fj as s,fk as e,cH as p,ch as h,X as r,b7 as a,s as o,an as c,ao as m,ap as n}from"./p-3013819f.js";import"./p-f1aede5a.js";import"./p-a9376829.js";import"./p-30a1f911.js";import"./p-b362a32c.js";import"./p-44a36259.js";import"./p-0d83e514.js";import"./p-c268fbe3.js";import"./p-8567e6fe.js";import"./p-d97e7de8.js";import"./p-201cec5f.js";import"./p-c7810a6f.js";import"./p-10e5b6ea.js";import"./p-89423226.js";import"./p-b3d3ca01.js";import"./p-ad726e47.js";import"./p-72db18d5.js";import"./p-894e6a6a.js";import"./p-54d1d89d.js";import"./p-59429ce9.js";import{$ as l}from"./p-6d5c327b.js";import"./p-508fdb0a.js";import"./p-325c6878.js";import{r as f,o as j,n as u}from"./p-c3085a45.js";import{m as d,u as b}from"./p-4e55d8f0.js";import{h as w}from"./p-6078e8e3.js";import{i as g}from"./p-0482b904.js";import{S as y,U as v,r as T}from"./p-53d117d0.js";import"./p-3b51db5e.js";import"./p-3811f238.js";import"./p-e6812c2f.js";import"./p-94b15954.js";import"./p-a925664a.js";import"./p-a897fcf8.js";import"./p-7b13247d.js";import"./p-595ce045.js";import"./p-89242a33.js";import"./p-3b8b0ae8.js";import"./p-ec95a4fb.js";import"./p-1f0b604e.js";import"./p-347800d3.js";import"./p-4c2ef9f4.js";import"./p-721433ed.js";import"./p-ffa11fc1.js";import"./p-808395fb.js";import"./p-7580bdba.js";import"./p-a62b18ce.js";import"./p-1cf43261.js";import"./p-8b1f6523.js";import"./p-4f73c6ea.js";import"./p-ffb26433.js";import"./p-033a99b5.js";import"./p-2d8c68ca.js";import"./p-17c1fa4b.js";import"./p-b6b871c6.js";import"./p-c779faaf.js";const C=[0,0];let q=class extends(g(f(d(b)))){constructor(){super(...arguments),this._fetchQueue=null,this._highlightGraphics=new t,this._highlightView=null,this._popupHighlightHelper=null,this._tileStrategy=null,this.layer=null}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}get tilemapCache(){return"tilemapCache"in this.layer?this.layer.tilemapCache:null}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume(),this._highlightView?.processUpdate(t)}attach(){const t="tileServers"in this.layer?this.layer.tileServers:null,p=this.tilemapCache;if(this._tileInfoView=new i(this.layer.tileInfo,this.layer.fullExtent,p?.effectiveMinLOD,p?.effectiveMaxLOD),this._fetchQueue=new s({tileInfoView:this._tileInfoView,concurrency:t&&10*t.length||10,process:(t,i)=>this.fetchTile(t,i)}),this._tileStrategy=new e({cachePolicy:"keep",resampling:this.resampling,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),y(this,this.layer)){const t=this._highlightView=new l({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new w(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new v({createFetchPopupFeaturesQueryGeometry:(t,i)=>T(t,i,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(i,s)=>{t.graphicUpdateHandler({graphic:i,property:s})},layerView:this,updatingHandles:this._updatingHandles})}this.requestUpdate(),this.addAttachHandles(this._updatingHandles.add((()=>this.resampling),(()=>{this.doRefresh()}))),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._popupHighlightHelper?.destroy(),this._highlightView?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=this._popupHighlightHelper=null}async fetchPopupFeaturesAtLocation(t,i){return this._popupHighlightHelper?this._popupHighlightHelper.fetchPopupFeaturesAtLocation(t,i):[]}highlight(t){return this._popupHighlightHelper?this._popupHighlightHelper.highlight(t):p()}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return h(this.layer.tileInfo?.spatialReference,t)}async doRefresh(){if(this.attached){if(this.suspended)return this._tileStrategy.clear(),void this.requestUpdate();this._fetchQueue.reset(),this._tileStrategy.refresh((t=>this._updatingHandles.addPromise(this._enqueueTileFetch(t))))}}acquireTile(t){const i=this._bitmapView.createTile(t),s=i.bitmap;return[s.x,s.y]=this._tileInfoView.getTileCoords(C,i.key),s.resolution=this._tileInfoView.getTileResolution(i.key),[s.width,s.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(i)),this._bitmapView.addChild(i),this.requestUpdate(),i}releaseTile(t){this._fetchQueue.abort(t.key.id),this._bitmapView.removeChild(t),t.once("detach",(()=>t.destroy())),this.requestUpdate()}async fetchTile(t,i={}){const s=this.tilemapCache,{signal:e,resamplingLevel:p=0}=i;if(!s)try{return await this._fetchImage(t,e)}catch(s){if(!r(s)&&!this.resampling)return j(this._tileInfoView.tileInfo.size);if(p<3){const s=this._tileInfoView.getTileParentId(t.id);if(s){const e=new a(s),h=await this.fetchTile(e,{...i,resamplingLevel:p+1});return u(this._tileInfoView,h,e,t)}}throw s}const h=new a(0,0,0,0);let o;try{if(await s.fetchAvailabilityUpsample(t.level,t.row,t.col,h,{signal:e}),h.level!==t.level&&!this.resampling)return j(this._tileInfoView.tileInfo.size);o=await this._fetchImage(h,e)}catch(i){if(r(i))throw i;o=await this._fetchImage(t,e)}return this.resampling?u(this._tileInfoView,o,h,t):o}async _enqueueTileFetch(t){if(!this._fetchQueue.has(t.key.id)){try{const i=await this._fetchQueue.push(t.key);t.bitmap.source=i,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.once("attach",(()=>this.requestUpdate()))}catch(t){r(t)||o.getLogger(this).error(t)}this.requestUpdate()}}async _fetchImage(t,i){return this.layer.fetchImageBitmapTile(t.level,t.row,t.col,{signal:i})}};c([m()],q.prototype,"resampling",null),c([m()],q.prototype,"tilemapCache",null),q=c([n("esri.views.2d.layers.TileLayerView2D")],q);const F=q;export default F;
//# sourceMappingURL=p-f37eb551.js.map