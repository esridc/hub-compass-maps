import{gP as t,h1 as e,h0 as s,ht as i,fa as r,dK as a,fN as n,e5 as o,cH as l,s as h,cM as p,an as d,ao as u,kN as c,ap as y,cL as m,kO as f,kt as g,kP as j,kQ as v,kR as w,kD as b,kv as k,g2 as I,kS as L,kT as F,kU as T,kV as _,kq as x,hq as C,hr as q,hs as O,kz as P,kA as S,dE as V,du as E,a as D,dj as Q,c_ as B,d5 as U,b_ as M,kW as R,U as N,kw as A}from"./p-028496e2.js";import{a as z}from"./p-2db650ee.js";import{T as G}from"./p-8979c003.js";import H from"./p-11282fe7.js";import{o as J}from"./p-5ef5a90d.js";import"./p-3b51db5e.js";import"./p-498d12fd.js";import"./p-4a7a2f9c.js";import"./p-b7771a23.js";import"./p-f251e1c8.js";import"./p-d0381905.js";import"./p-c2c5c63d.js";import"./p-2a4de840.js";import"./p-b2d5ab9c.js";import"./p-3f094b9d.js";import"./p-c439e241.js";import"./p-0120bda4.js";import"./p-82d7ddb5.js";import"./p-94b15954.js";import"./p-1f0b604e.js";import"./p-347800d3.js";import"./p-0053e125.js";import"./p-cd329783.js";import"./p-854d8fad.js";import"./p-976040d8.js";class K{constructor(t,e){this.objectId=t,this.itemSource=e,this.count=0,this.layer=null,this.sortValue=void 0}}const W=new t(20,(t=>t.destroy()));let X=class extends(e(s(i(r)))){constructor(t){super(t),this._oidToReference=new Map,this._layerToReference=new Map,this._portals=new Map,this.layers=new a,this.maximumVisibleSublayers=10,this.opacity=1,this.title="Layers In View",this.type="catalog-dynamic-group",this.visible=!0}load(t){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get _orderBy(){return this.parent.orderBy?.find((t=>!t.valueExpression&&t.field))??new n({field:this.parent.objectIdField})}get _referenceComparator(){const t=this._orderBy,e=this.parent.fieldsIndex.get(t.field),s=G(e?.toJSON().type,"descending"===t.order);return(t,e)=>{const i=s(t.sortValue,e.sortValue);return i||t.objectId-t.objectId}}acquireLayer(t){const e=t.getObjectId(),s=o(this._oidToReference,e,(()=>this._createLayerReference(t)));return s.count++,l((()=>{s.count--,s.count||this._disposeLayerReference(s)}))}_createLayerReference(t){const e=t.getObjectId(),s=t.getAttribute(this.parent.itemSourceField),i=new K(e,s);if(W.get(s))return this._addLayer(W.pop(s),i,t),i;let r;try{r=JSON.parse(s)}catch(t){return h.getLogger(this).error(t),i}return this._createLayer(r).then((e=>{this.destroyed||0===i.count?(W.get(s)||W.put(i.itemSource,e),i.layer=null):this._addLayer(e,i,t)})).catch((()=>{})),i}_addLayer(t,e,s){this._layerToReference.set(t,e),e.sortValue=s.getAttribute(this._orderBy.field),e.layer=t,t.parent=this,this.layers.add(t),this.layers.sort(((t,e)=>this._referenceComparator(this._layerToReference.get(t),this._layerToReference.get(e))))}_disposeLayerReference(t){t.layer&&(this._layerToReference.delete(t.layer),this.layers.remove(t.layer),W.put(t.itemSource,t.layer)),this._oidToReference.delete(t.objectId)}async _createLayer(t){if(!Z(t)){return new(await z.UnsupportedLayer())}const{itemId:e,portalUrl:s}=t,i=o(this._portals,s,(()=>new m({url:s})));return r.fromPortalItem(new p({id:e,portal:i}))}};d([u()],X.prototype,"_orderBy",null),d([u()],X.prototype,"_referenceComparator",null),d([u({readOnly:!0})],X.prototype,"layers",void 0),d([u()],X.prototype,"maximumVisibleSublayers",void 0),d([u(c)],X.prototype,"opacity",void 0),d([u({type:String,json:{name:"title",write:!0}})],X.prototype,"title",void 0),d([u({json:{read:!1}})],X.prototype,"type",void 0),d([u({type:Boolean,json:{name:"visibility",write:!0}})],X.prototype,"visible",void 0),X=d([y("esri.layers.catalog.CatalogDynamicGroupLayer")],X);const Y=X;function Z(t){return"object"==typeof t&&null!=t&&"itemId"in t&&"portalUrl"in t}let $=class extends(e(f(s(i(r))))){constructor(t){super(t),this.labelingInfo=null,this.labelsVisible=!0,this.legendEnabled=!0,this.opacity=1,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.type="catalog-footprint",this.visible=!0}load(t){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get fields(){return this.parent.fields}get fieldsIndex(){return this.parent.fieldsIndex}get geometryType(){return this.parent.geometryType}get objectIdField(){return this.parent.objectIdField}get orderBy(){return this.parent.orderBy}createPopupTemplate(t){const e={fields:this.parent.fields,objectIdField:this.parent.objectIdField,title:this.title};return g(e,t)}createQuery(){return this.parent.createQuery()}queryFeatures(t,e){return this.parent.queryFeatures(t,e)}};d([u({readOnly:!0})],$.prototype,"defaultPopupTemplate",null),d([u({type:[j],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:v,write:!0}})],$.prototype,"labelingInfo",void 0),d([u(w)],$.prototype,"labelsVisible",void 0),d([u(b)],$.prototype,"legendEnabled",void 0),d([u(c)],$.prototype,"opacity",void 0),d([u(k)],$.prototype,"popupEnabled",void 0),d([u({type:I,json:{name:"popupInfo",write:!0}})],$.prototype,"popupTemplate",void 0),d([u({types:L,json:{name:"layerDefinition.drawingInfo.renderer"}})],$.prototype,"renderer",void 0),d([u({json:{read:!1}})],$.prototype,"type",void 0),d([u({type:Boolean,json:{name:"visibility",write:!0}})],$.prototype,"visible",void 0),$=d([y("esri.layers.catalog.CatalogFootprintLayer")],$);const tt=$;const et="esri.layers.CatalogLayer",st=A();let it=class extends(F(s(T(_(e(x(C(q(O(i(P(S(V(r)))))))))))))){constructor(t){super(t),this.dynamicGroupLayer=new Y({parent:this}),this.fields=null,this.fieldsIndex=null,this.footprintLayer=new tt({parent:this}),this.itemSourceField="cd_itemsource",this.itemTypeField="cd_itemtype",this.layers=new a([this.dynamicGroupLayer,this.footprintLayer]),this.source=new H({layer:this}),this.type="catalog"}load(t){const e=null!=t?t.signal:null,s=this.loadFromPortal({supportedTypes:["Feature Service"]},t).catch(E).then((async()=>{if(!this.url)throw new D("catalog-layer:missing-url","Catalog layer must be created with a url");if(this.url&&null==this.layerId){const t=await this._fetchFirstValidLayerId(e);if(null==t)throw new D("catalog-layer:missing-layerId","There is no Catalog Layer in the service",{service:this.url});this.layerId=t}await this.source.load(),this.source.sourceJSON&&(this.sourceJSON=this.source.sourceJSON,this.read(this.source.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}))})).then((()=>Q(this,"load",t)));return this.addResolvingPromise(s),Promise.resolve(this)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("capabilities"),(this._get("createQueryVersion")??0)+1}get parsedUrl(){const t=B(this.url);return null!=t&&null!=this.layerId&&(t.path=U(t.path,this.layerId.toString())),t}createQuery(){const t=new M,e=this.capabilities?.query;t.returnGeometry=!0,e&&(t.compactGeometryEnabled=e.supportsCompactGeometry,t.defaultSpatialReferenceEnabled=e.supportsDefaultSpatialReference),t.outFields=["*"];const{timeOffset:s,timeExtent:i}=this;return t.timeExtent=null!=s&&null!=i?i.offset(-s.value,s.unit):i||null,t}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return this.fieldsIndex.get(t)?.domain}async queryFeatures(t,e){const s=await this.load(),i=await s.source.queryFeatures(M.from(t)??s.createQuery(),e);if(i?.features)for(const t of i.features)t.layer=t.sourceLayer=s.footprintLayer;return i}async queryObjectIds(t,e){return(await this.load()).source.queryObjectIds(M.from(t)??this.createQuery(),e)}async queryFeatureCount(t,e){return(await this.load()).source.queryFeatureCount(M.from(t)??this.createQuery(),e)}async queryExtent(t,e){return(await this.load()).source.queryExtent(M.from(t)??this.createQuery(),e)}serviceSupportsSpatialReference(t){return this.loaded&&R(this,t)}read(t,e){super.read(t,e);let s=t.footprintLayer;s||"service"!==e?.origin||(s={layerDefinition:{drawingInfo:J(t.geometryType)}}),this.footprintLayer.read(s,e)}_fetchFirstValidLayerId(t){return N(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:t}).then((t=>{const e=t.data;if(e)return Array.isArray(e.layers)?e.layers.find((t=>"Catalog Layer"===t.type))?.id:void 0}))}};d([u({readOnly:!0})],it.prototype,"createQueryVersion",null),d([u({...st.fields,json:{origins:{service:{name:"fields"}}}})],it.prototype,"fields",void 0),d([u(st.fieldsIndex)],it.prototype,"fieldsIndex",void 0),d([u({json:{read:!1,write:!1}})],it.prototype,"footprintLayer",void 0),d([u()],it.prototype,"itemSourceField",void 0),d([u()],it.prototype,"itemTypeField",void 0),d([u()],it.prototype,"layers",void 0),d([u({value:"CatalogLayer",type:["CatalogLayer"]})],it.prototype,"operationalLayerType",void 0),d([u()],it.prototype,"outFields",void 0),d([u({readOnly:!0})],it.prototype,"parsedUrl",null),d([u()],it.prototype,"source",void 0),d([u({json:{read:!1}})],it.prototype,"type",void 0),it=d([y(et)],it);const rt=it;export default rt;
//# sourceMappingURL=p-16f689c6.js.map