import{hL as t,hM as e,hN as i,hO as s,hP as n,az as r,r as a,p as o,bZ as l,e as c,q as h,ac as u,w as d,bD as p,s as m,hQ as f,hR as g,bQ as v,bS as y,bE as w,bK as b,bL as _,bM as F,hS as I,hT as A,hU as C,hV as M,hW as k,hX as $,hY as x,hZ as E,h_ as T,h$ as L,bT as P,i0 as O,i1 as N,i2 as R,i3 as V,n as j,U as S,af as D,hr as B,i4 as q,X as z,gC as H,bb as U,i5 as W,i6 as Z,F as X,i7 as G,i8 as Q,i9 as Y,ia as J,ib as K,ic as tt,id as et,ie as it,ig as st,ih as nt,ii as rt,ij as at,ik as ot,il as lt,a0 as ct,im as ht,io as ut,ip as dt,Y as pt,bG as mt,eN as ft,v as gt,iq as vt,ir as yt,dN as wt,N as bt,is as _t,bH as Ft,it as It,iu as At,hw as Ct,iv as Mt,iw as kt,gD as $t,ix as xt,iy as Et,gv as Tt,iz as Lt,di as Pt,iA as Ot,he as Nt,iB as Rt,iC as Vt,iD as jt,iE as St,iF as Dt,iG as Bt,iH as qt,bC as zt,er as Ht,iI as Ut,bU as Wt,bV as Zt,bW as Xt,d9 as Gt,iJ as Qt,iK as Yt,e6 as Jt,iL as Kt,iM as te,iN as ee,iO as ie,bi as se,iP as ne,iQ as re,iR as ae,iS as oe,iT as le,bN as ce,bR as he,c0 as ue}from"./p-aad64c9f.js";import{a as de}from"./p-a7013a3f.js";import{s as pe}from"./p-c783c054.js";import{j as me}from"./p-7950bc60.js";import{d as fe}from"./p-d6ce3d70.js";import{s as ge}from"./p-ab64f997.js";import"./p-2af77f97.js";import"./p-1062e8df.js";import"./p-4e60756f.js";import"./p-21ce5524.js";import"./p-aff89b86.js";import"./p-da522976.js";import"./p-d492d39b.js";import"./p-4295487d.js";async function ve(t,e,i){n(t,e,(()=>[])).push(...i)}async function ye(n){const r=new Map;if(!n)return r;if("visualVariables"in n&&n.visualVariables){const e=n.visualVariables.filter((t=>"color"===t.type));for(const i of e){const e=(await t(i)??[]).map((t=>t.color));await ve(r,i.field||i.valueExpression,e)}}if("heatmap"===n.type){const t=e(n).map((t=>t.color));await ve(r,n.field||n.valueExpression,t)}else if("pie-chart"===n.type){for(const t of n.attributes)await ve(r,t.field||t.valueExpression,[t.color]);await ve(r,"default",[n?.othersCategory?.color,i(n.backgroundFillSymbol,null)])}else if("dot-density"===n.type){for(const t of n.attributes)await ve(r,t.field||t.valueExpression,[t.color]);await ve(r,"default",[n.backgroundColor])}else if("unique-value"===n.type)if("predominance"===n.authoringInfo?.type)for(const t of n.uniqueValueInfos??[])await ve(r,t.value.toString(),[i(t.symbol,null)]);else{const t=(n.uniqueValueInfos??[]).map((t=>i(t.symbol,null))),{field:e,field2:s,field3:a,valueExpression:o}=n;(e||o)&&await ve(r,e||o,t),s&&await ve(r,s,t),a&&await ve(r,a,t)}else if("class-breaks"===n.type){const t=n.classBreakInfos.map((t=>i(t.symbol,null))),{field:e,valueExpression:s}=n;await ve(r,e??s,t)}else"simple"===n.type&&await ve(r,"default",[i(n.symbol,null)]);return"defaultSymbol"in n&&n.defaultSymbol&&await ve(r,"default",[i(n.defaultSymbol,null)]),r.forEach(((t,e)=>{const i=s(t.filter(Boolean),((t,e)=>JSON.stringify(t)===JSON.stringify(e)));r.set(e,i)})),r}function we(t,e,i,s){let n=null,r=1e3;"number"==typeof e?(r=e,s=i):(n=e??null,r=i);let a,o=0;const l=()=>{o=0,t.apply(s,a)},c=(...t)=>{n&&n.apply(s,t),a=t,r?o||(o=setTimeout(l,r)):l()};return c.remove=()=>{o&&(clearTimeout(o),o=0)},c.forceUpdate=()=>{o&&(clearTimeout(o),l())},c.hasPendingUpdates=()=>!!o,c}const be={editing:!1,operations:{add:!0,update:!0,delete:!0}},_e=r.ofType(de);let Fe=class extends u{constructor(t){super(t),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.capabilities={...be},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new _e,this.fileInfos=new r,this.graphic=null,this.mode="view",this.filesEnabled=!1,this.addHandles(d((()=>this.graphic),(()=>this._graphicChanged()),p))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(t){return{...be,...t}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:t}=this;if(!t)return!1;const e=t.layer||t.sourceLayer;return e?.loaded&&"capabilities"in e&&e.capabilities&&"operations"in e.capabilities&&"supportsResizeAttachments"in e.capabilities.operations&&e.capabilities.operations.supportsResizeAttachments||!1}async getAttachments(){const{_attachmentLayer:t,attachmentInfos:e}=this;if(!t||"function"!=typeof t.queryAttachments)throw new m("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getObjectId();if("number"!=typeof i)throw new m("invalid-object-id","getAttachments(): Numeric object id is required");const s=new f({objectIds:[i],returnMetadata:!0}),n=[],r=t.queryAttachments(s).then((t=>t[i]||n)).catch((()=>n));this._getAttachmentsPromise=r,this.notifyChange("state");const a=await r;return e.destroyAll(),a.length&&e.addMany(a),this._getAttachmentsPromise=null,this.notifyChange("state"),a}async addAttachment(t,e=this.graphic){const{_attachmentLayer:i,attachmentInfos:s,capabilities:n}=this;if(!e)throw new m("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:e});if(!t)throw new m("invalid-attachment","addAttachment(): An attachment is required.",{attachment:t});if(!n.operations?.add)throw new m("invalid-capabilities","addAttachment(): add capabilities are required.");if(!i||"function"!=typeof i.addAttachment)throw new m("invalid-layer","addAttachment(): A valid layer is required.");const r=i.addAttachment(e,t).then((t=>this._queryAttachment(t.objectId,e))),a=await r;return s.add(a),a}async deleteAttachment(t){const{_attachmentLayer:e,attachmentInfos:i,graphic:s,capabilities:n}=this;if(!t)throw new m("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!n.operations?.delete)throw new m("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!e||"function"!=typeof e.deleteAttachments)throw new m("invalid-layer","deleteAttachment(): A valid layer is required.");if(!s)throw new m("invalid-graphic","deleteAttachment(): A graphic is required.");const r=e.deleteAttachments(s,[t.id]).then((()=>t)),a=await r;return i.remove(a),a.destroy(),a}async updateAttachment(t,e=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:s,graphic:n,capabilities:r}=this;if(!t)throw new m("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:t});if(!e)throw new m("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!r.operations?.update)throw new m("invalid-capabilities","updateAttachment(): Update capabilities are required.");const a=s.indexOf(e);if(!i||"function"!=typeof i.updateAttachment)throw new m("invalid-layer","updateAttachment(): A valid layer is required.");if(!n)throw new m("invalid-graphic","updateAttachment(): A graphic is required.");const o=i.updateAttachment(n,e.id,t).then((t=>this._queryAttachment(t.objectId))),l=await o;return s.splice(a,1,l),l}async commitFiles(){return await Promise.all(this.fileInfos.items.map((t=>this.addAttachment(t.form)))),this.fileInfos.removeAll(),this.getAttachments()}addFile(t,e){if(!t||!e)return null;const i={file:t,form:e};return this.fileInfos.add(i),i}updateFile(t,e,i=this.activeFileInfo){if(!t||!e||!i)return null;const s=this.fileInfos.indexOf(i);return s>-1&&this.fileInfos.splice(s,1,{file:t,form:e}),this.fileInfos.items[s]}deleteFile(t){const e=this.fileInfos.find((e=>e.file===t));return e?(this.fileInfos.remove(e),e):null}async _queryAttachment(t,e){const{_attachmentLayer:i}=this;if(!t||!i?.queryAttachments)throw new m("invalid-attachment-id","Could not query attachment.");const s=this._getObjectId(e);if("number"!=typeof s)throw new m("invalid-object-id","getAttachments(): Numeric object id is required");const n=new f({objectIds:[s],attachmentsWhere:`AttachmentId=${t}`,returnMetadata:!0});return i.queryAttachments(n).then((t=>t[s][0]))}_getObjectId(t=this.graphic){return t?.getObjectId()??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch((()=>this.attachmentInfos.destroyAll())))}_setAttachmentLayer(){const{graphic:t}=this,e=g(t);this._attachmentLayer=e?"scene"===e.type&&null!=e.associatedLayer?e.associatedLayer:e:null}};a([o()],Fe.prototype,"capabilities",void 0),a([l("capabilities")],Fe.prototype,"castCapabilities",null),a([o()],Fe.prototype,"activeAttachmentInfo",void 0),a([o()],Fe.prototype,"activeFileInfo",void 0),a([o({readOnly:!0,type:_e})],Fe.prototype,"attachmentInfos",void 0),a([o()],Fe.prototype,"fileInfos",void 0),a([o({type:c})],Fe.prototype,"graphic",void 0),a([o()],Fe.prototype,"mode",void 0),a([o({readOnly:!0})],Fe.prototype,"state",null),a([o()],Fe.prototype,"filesEnabled",void 0),a([o({readOnly:!0})],Fe.prototype,"supportsResizeAttachments",null),Fe=a([h("esri.widgets.Attachments.AttachmentsViewModel")],Fe);const Ie=Fe;const Ae={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},Ce="esri-attachments",Me={base:Ce,loaderContainer:`${Ce}__loader-container`,loader:`${Ce}__loader`,fadeIn:`${Ce}--fade-in`,container:`${Ce}__container`,containerList:`${Ce}__container--list`,containerPreview:`${Ce}__container--preview`,actions:`${Ce}__actions`,deleteButton:`${Ce}__delete-button`,addAttachmentButton:`${Ce}__add-attachment-button`,errorMessage:`${Ce}__error-message`,items:`${Ce}__items`,item:`${Ce}__item`,itemButton:`${Ce}__item-button`,itemMask:`${Ce}__item-mask`,itemMaskIcon:`${Ce}__item-mask--icon`,itemImage:`${Ce}__image`,itemImageResizable:`${Ce}__image--resizable`,itemLabel:`${Ce}__label`,itemFilename:`${Ce}__filename`,itemChevronIcon:`${Ce}__item-chevron-icon`,itemLink:`${Ce}__item-link`,itemLinkOverlay:`${Ce}__item-link-overlay`,itemLinkOverlayIcon:`${Ce}__item-link-overlay-icon`,itemEditIcon:`${Ce}__item-edit-icon`,itemAddIcon:`${Ce}__item-add-icon`,itemAddButton:`${Ce}__item-add-button`,formNode:`${Ce}__form-node`,fileFieldset:`${Ce}__file-fieldset`,fileLabel:`${Ce}__file-label`,fileName:`${Ce}__file-name`,fileInput:`${Ce}__file-input`,metadata:`${Ce}__metadata`,metadataFieldset:`${Ce}__metadata-fieldset`,progressBar:`${Ce}__progress-bar`},ke=window.CSS;let $e=class extends y{constructor(t,e){super(t,e),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...Ae},this._supportsImageOrientation=ke&&ke.supports&&ke.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}normalizeCtorArgs(t){return t?.viewModel||(t={viewModel:new Ie,...t}),t}initialize(){this.addHandles([w((()=>this.viewModel?.attachmentInfos),"change",(()=>this.scheduleRender())),w((()=>this.viewModel?.fileInfos),"change",(()=>this.scheduleRender())),d((()=>this.viewModel?.mode),(()=>this._modeChanged()),p)])}loadDependencies(){return b({icon:()=>import("./p-a8caa0f1.js")})}get capabilities(){return this.viewModel.capabilities}set capabilities(t){this.viewModel.capabilities=t}get effectiveDisplayType(){const{displayType:t}=this;return t&&"auto"!==t?t:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get icon(){return"attachment"}set icon(t){this._overrideIfSome("icon",t)}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}castVisibleElements(t){return{...Ae,...t}}addAttachment(){const{_addAttachmentForm:t,viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.addAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((t=>{throw this._set("submitting",!1),this._set("error",new m("attachments:add-attachment",this.messages.addErrorMessage,t)),t}))}deleteAttachment(t){const{viewModel:e}=this;return this._set("submitting",!0),this._set("error",null),e.deleteAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((t=>{throw this._set("submitting",!1),this._set("error",new m("attachments:delete-attachment",this.messages.deleteErrorMessage,t)),t}))}updateAttachment(){const{viewModel:t}=this,{_updateAttachmentForm:e}=this;return this._set("submitting",!0),this._set("error",null),t.updateAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((t=>{throw this._set("submitting",!1),this._set("error",new m("attachments:update-attachment",this.messages.updateErrorMessage,t)),t}))}addFile(){const t=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",t}updateFile(){const{viewModel:t}=this,e=t.updateFile(this.selectedFile,this._updateAttachmentForm,t.activeFileInfo);return t.mode="view",e}deleteFile(t){const e=this.viewModel.deleteFile(t||this.viewModel.activeFileInfo?.file);return this.viewModel.mode="view",e}render(){const{submitting:t,viewModel:e}=this,{state:i}=e;return _("div",{class:this.classes(Me.base,F.widget)},t?this._renderProgressBar():null,"loading"===i?this._renderLoading():this._renderAttachments(),this._renderErrorMessage())}_renderErrorMessage(){const{error:t,visibleElements:e}=this;return t&&e.errorMessage?_("div",{class:Me.errorMessage,key:"error-message"},t.message):null}_renderAttachments(){const{activeFileInfo:t,mode:e,activeAttachmentInfo:i}=this.viewModel;return"add"===e?this._renderAddForm():"edit"===e?this._renderDetailsForm(i||t):this._renderAttachmentContainer()}_renderLoading(){return _("div",{class:Me.loaderContainer,key:"loader"},_("div",{class:Me.loader}))}_renderProgressBar(){return this.visibleElements.progressBar?_("div",{class:Me.progressBar,key:"progress-bar"}):null}_renderAddForm(){const{submitting:t,selectedFile:e}=this,i=t||!e,s=this.visibleElements.cancelAddButton?_("button",{bind:this,class:this.classes(F.button,F.buttonTertiary,F.buttonSmall,F.buttonHalf,t&&F.buttonDisabled),disabled:t,onclick:this._cancelForm,type:"button"},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?_("button",{class:this.classes(F.button,F.buttonSecondary,F.buttonSmall,F.buttonHalf,{[F.buttonDisabled]:i}),disabled:i,type:"submit"},this.messages.add):null,r=e?_("span",{class:Me.fileName,key:"file-name"},e.name):null,a=_("form",{afterCreate:I,afterRemoved:A,bind:this,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},_("fieldset",{class:Me.fileFieldset},r,_("label",{class:this.classes(Me.fileLabel,F.button,F.buttonSecondary)},e?this.messages.changeFile:this.messages.selectFile,_("input",{bind:this,class:Me.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))),n,s);return _("div",{class:Me.formNode,key:"add-form-container"},a)}_renderDetailsForm(t){const{visibleElements:e,viewModel:i,selectedFile:s,submitting:n}=this,{capabilities:r}=i,a=n||!s;let o,l,c,h;s?(o=s.type,l=s.name,c=s.size):t&&"file"in t?(o=t.file.type,l=t.file.name,c=t.file.size):t&&"contentType"in t&&(o=t.contentType,l=t.name,c=t.size,h=t.url);const u=r.editing&&r.operations?.delete&&e.deleteButton?_("button",{bind:this,class:this.classes(F.button,F.buttonSmall,F.buttonTertiary,Me.deleteButton,{[F.buttonDisabled]:n}),disabled:n,key:"delete-button",onclick:e=>this._submitDeleteAttachment(e,t),type:"button"},this.messages.delete):void 0,d=r.editing&&r.operations?.update&&e.updateButton?_("button",{class:this.classes(F.button,F.buttonSmall,F.buttonThird,{[F.buttonDisabled]:a}),disabled:a,key:"update-button",type:"submit"},this.messages.update):void 0,p=this.visibleElements.cancelUpdateButton?_("button",{bind:this,class:this.classes(F.button,F.buttonSmall,F.buttonTertiary,F.buttonThird,{[F.buttonDisabled]:n}),disabled:n,key:"cancel-button",onclick:this._cancelForm,type:"button"},this.messages.cancel):void 0,m=r.editing&&r.operations?.update?_("fieldset",{class:Me.fileFieldset,key:"file"},_("span",{class:Me.fileName,key:"file-name"},l),_("label",{class:this.classes(Me.fileLabel,F.button,F.buttonSecondary)},this.messages.changeFile,_("input",{bind:this,class:Me.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))):void 0,f=_("fieldset",{class:Me.metadataFieldset,key:"size"},_("label",null,C(this.messagesUnits,c??0))),g=_("fieldset",{class:Me.metadataFieldset,key:"content-type"},_("label",null,o)),v=null!=h?_("a",{class:Me.itemLink,href:h,rel:"noreferrer",target:"_blank"},this._renderImageMask(t,400),_("div",{class:Me.itemLinkOverlay},_("span",{class:Me.itemLinkOverlayIcon},_("calcite-icon",{icon:"launch"})))):this._renderImageMask(t,400),y=_("form",{afterCreate:I,afterRemoved:A,bind:this,"data-node-ref":"_updateAttachmentForm",onsubmit:e=>this._submitUpdateAttachment(e,t)},_("div",{class:Me.metadata},f,g),m,_("div",{class:Me.actions},u,p,d));return _("div",{class:Me.formNode,key:"edit-form-container"},v,y)}_renderImageMask(t,e){return t?"file"in t?this._renderGenericImageMask(t.file.name,t.file.type):this._renderImageMaskForAttachment(t,e):null}_renderGenericImageMask(t,e){const{supportsResizeAttachments:i}=this.viewModel,s=M(e),n={[Me.itemImageResizable]:i};return _("div",{class:this.classes(Me.itemMaskIcon,Me.itemMask),key:s},_("img",{alt:t,class:this.classes(n,Me.itemImage),src:s,title:t}))}_renderImageMaskForAttachment(t,e){const{supportsResizeAttachments:i}=this.viewModel;if(!t)return null;const{contentType:s,name:n,url:r}=t;if(!i||!k(s))return this._renderGenericImageMask(n,s);const a=this._getCSSTransform(t),o=a?{transform:a,"image-orientation":"none"}:{},l=`${r}${r?.includes("?")?"&":"?"}w=${e}`,c={[Me.itemImageResizable]:i};return _("div",{class:this.classes(Me.itemMask),key:l},_("img",{alt:n,class:this.classes(c,Me.itemImage),src:l,styles:o,title:n}))}_renderFile(t){const{file:e}=t;return _("li",{class:Me.item,key:e},_("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:Me.itemButton,key:"details-button",onclick:()=>this._startEditFile(t),title:this.messages.attachmentDetails,type:"button"},this._renderImageMask(t),_("label",{class:Me.itemLabel},_("span",{class:Me.itemFilename},e.name||this.messages.noTitle),_("span",{"aria-hidden":"true",class:this.classes(Me.itemChevronIcon,$(this.container)?x.left:x.right)}))))}_renderAttachmentInfo({attachmentInfo:t,displayType:e}){const{viewModel:i,effectiveDisplayType:s}=this,{capabilities:n,supportsResizeAttachments:r}=i,{contentType:a,name:o,url:l}=t,c=this._renderImageMask(t,"list"===e?48:400),h=n.editing?_("span",{"aria-hidden":"true",class:this.classes(Me.itemChevronIcon,$(this.container)?x.left:x.right)}):null,u=[c,"preview"===s&&r&&k(a)?null:_("label",{class:Me.itemLabel},_("span",{class:Me.itemFilename},o||this.messages.noTitle),h)],d=n.editing?_("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:Me.itemButton,"data-attachment-info-id":t.id,key:"details-button",onclick:()=>this._startEditAttachment(t),title:this.messages.attachmentDetails,type:"button"},u):_("a",{class:Me.itemButton,href:l??void 0,key:"details-link",rel:"noreferrer",target:"_blank"},u);return _("li",{class:Me.item,key:t},d)}_renderAttachmentContainer(){const{effectiveDisplayType:t,viewModel:e,visibleElements:i}=this,{attachmentInfos:s,capabilities:n,fileInfos:r}=e,a=!!s?.length,o=!!r?.length,l={[Me.containerList]:"preview"!==t,[Me.containerPreview]:"preview"===t},c=n.editing&&n.operations?.add&&i.addButton?_("button",{bind:this,class:this.classes(F.button,F.buttonTertiary,Me.addAttachmentButton),onclick:()=>this._startAddAttachment(),type:"button"},_("span",{"aria-hidden":"true",class:this.classes(Me.itemAddIcon,x.plus)}),this.messages.add):void 0,h=a?_("ul",{class:Me.items,key:"attachments-list"},s.toArray().map((e=>this._renderAttachmentInfo({attachmentInfo:e,displayType:t})))):void 0,u=o?_("ul",{class:Me.items,key:"file-list"},r.toArray().map((t=>this._renderFile(t)))):void 0,d=o||a?void 0:_("div",{class:F.empty},this.messages.noAttachments);return _("div",{class:this.classes(Me.container,l),key:"attachments-container"},h,u,d,c)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(t){const e=t.target,i=e.files?.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(t,e){t.preventDefault(),e&&("file"in e?this.deleteFile(e.file):e&&this.deleteAttachment(e))}_submitAddAttachment(t){t.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(t,e){t.preventDefault(),e&&"file"in e?this.updateFile():this.updateAttachment()}_startEditAttachment(t){const{viewModel:e}=this;e.activeFileInfo=null,e.activeAttachmentInfo=t,e.mode="edit"}_startEditFile(t){const{viewModel:e}=this;e.activeAttachmentInfo=null,e.activeFileInfo=t,e.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(t){t.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(t){const{orientationInfo:e}=t;return!this._supportsImageOrientation&&e?[e.rotation?`rotate(${e.rotation}deg)`:"",e.mirrored?"scaleX(-1)":""].join(" "):""}};a([o()],$e.prototype,"capabilities",null),a([o()],$e.prototype,"displayType",void 0),a([o({readOnly:!0})],$e.prototype,"effectiveDisplayType",null),a([o()],$e.prototype,"graphic",null),a([o()],$e.prototype,"icon",null),a([o()],$e.prototype,"label",null),a([o(),v("esri/widgets/Attachments/t9n/Attachments")],$e.prototype,"messages",void 0),a([o(),v("esri/core/t9n/Units")],$e.prototype,"messagesUnits",void 0),a([o({readOnly:!0})],$e.prototype,"selectedFile",void 0),a([o({readOnly:!0})],$e.prototype,"submitting",void 0),a([o({readOnly:!0})],$e.prototype,"error",void 0),a([o({type:Ie})],$e.prototype,"viewModel",void 0),a([o()],$e.prototype,"visibleElements",void 0),a([l("visibleElements")],$e.prototype,"castVisibleElements",null),$e=a([h("esri.widgets.Attachments")],$e);const xe=$e;let Ee=class extends Ie{constructor(t){super(t),this.description=null,this.title=null}};a([o()],Ee.prototype,"description",void 0),a([o()],Ee.prototype,"title",void 0),Ee=a([h("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],Ee);const Te=Ee;const Le="esri-feature-element-info",Pe={base:Le,title:`${Le}__title`,description:`${Le}__description`};let Oe=class extends y{constructor(t,e){super(t,e),this.description=null,this.headingLevel=2,this.title=null}render(){return _("div",{class:Pe.base},this._renderTitle(),this._renderDescription())}_renderTitle(){const{title:t}=this;return t?_(E,{class:Pe.title,innerHTML:t,level:this.headingLevel}):null}_renderDescription(){const{description:t}=this;return t?_("div",{class:Pe.description,innerHTML:t,key:"description"}):null}};a([o()],Oe.prototype,"description",void 0),a([o()],Oe.prototype,"headingLevel",void 0),a([o()],Oe.prototype,"title",void 0),Oe=a([h("esri.widgets.Feature.support.FeatureElementInfo")],Oe);const Ne=Oe;const Re={base:"esri-feature-attachments"};let Ve=class extends y{constructor(t,e){super(t,e),this._featureElementInfo=null,this.attachmentsWidget=new xe,this.headingLevel=2,this.viewModel=new Te}initialize(){this._featureElementInfo=new Ne,this.addHandles([d((()=>[this.viewModel?.description,this.viewModel?.title,this.headingLevel]),(()=>this._setupFeatureElementInfo()),p),d((()=>this.viewModel),(t=>this.attachmentsWidget.viewModel=t),p)])}destroy(){this.attachmentsWidget.viewModel=null,this.attachmentsWidget.destroy(),this._featureElementInfo?.destroy()}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get displayType(){return this.attachmentsWidget.displayType}set displayType(t){this.attachmentsWidget.displayType=t}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){const{attachmentsWidget:t}=this;return _("div",{class:Re.base},this._featureElementInfo?.render(),t?.render())}_setupFeatureElementInfo(){const{description:t,title:e,headingLevel:i}=this;this._featureElementInfo?.set({description:t,title:e,headingLevel:i})}};a([o({readOnly:!0})],Ve.prototype,"attachmentsWidget",void 0),a([o()],Ve.prototype,"description",null),a([o()],Ve.prototype,"displayType",null),a([o()],Ve.prototype,"graphic",null),a([o()],Ve.prototype,"headingLevel",void 0),a([o()],Ve.prototype,"title",null),a([o({type:Te})],Ve.prototype,"viewModel",void 0),Ve=a([h("esri.widgets.Feature.FeatureAttachments")],Ve);const je=Ve;let Se=class extends u{constructor(t){super(t),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(d((()=>this.creator),(t=>{this._destroyContent(),this._createContent(t)}),p))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:t,graphic:e,destroyer:i}=this;t&&e&&(T({type:"content",value:i,event:{graphic:e}}),this._set("created",null))}async _createContent(t){const e=this.graphic;if(!e||!t)return;const i=T({type:"content",value:t,event:{graphic:e}});this._loadingPromise=i,this.notifyChange("state");const s=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};a([o({readOnly:!0})],Se.prototype,"created",void 0),a([o()],Se.prototype,"creator",void 0),a([o()],Se.prototype,"destroyer",void 0),a([o({type:c})],Se.prototype,"graphic",void 0),a([o({readOnly:!0})],Se.prototype,"state",null),Se=a([h("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],Se);const De=Se;const Be="esri-feature-content",qe={base:Be,loaderContainer:`${Be}__loader-container`,loader:`${Be}__loader`};let ze=class extends y{constructor(t,e){super(t,e),this.viewModel=null,this._addTargetToAnchors=t=>{Array.from(t.querySelectorAll("a")).forEach((t=>{L(t.href)&&!t.hasAttribute("target")&&t.setAttribute("target","_blank")}))}}get creator(){return this.viewModel?.creator}set creator(t){this.viewModel&&(this.viewModel.creator=t)}get graphic(){return this.viewModel?.graphic}set graphic(t){this.viewModel&&(this.viewModel.graphic=t)}render(){const t=this.viewModel?.state;return _("div",{class:qe.base},"loading"===t?this._renderLoading():this._renderCreated())}_renderLoading(){return _("div",{class:qe.loaderContainer,key:"loader"},_("div",{class:qe.loader}))}_renderCreated(){const t=this.viewModel?.created;return t?t instanceof HTMLElement?_("div",{afterCreate:this._attachToNode,bind:t,key:t}):P(t)?_("div",{key:t},!t.destroyed&&t.render()):_("div",{afterCreate:this._addTargetToAnchors,innerHTML:t,key:t}):null}_attachToNode(t){const e=this;t.appendChild(e)}};a([o()],ze.prototype,"creator",null),a([o()],ze.prototype,"graphic",null),a([o({type:De})],ze.prototype,"viewModel",void 0),ze=a([h("esri.widgets.Feature.FeatureContent")],ze);const He=ze;let Ue=class extends u{constructor(t){super(t),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:t,fieldInfos:e}=this,i=[];return e?.forEach((e=>{if(!(!e.hasOwnProperty("visible")||e.visible))return;const s=e.clone();s.label=R(s,t),i.push(s)})),i}};a([o()],Ue.prototype,"attributes",void 0),a([o({type:[O]})],Ue.prototype,"expressionInfos",void 0),a([o()],Ue.prototype,"description",void 0),a([o({type:[N]})],Ue.prototype,"fieldInfos",void 0),a([o({readOnly:!0})],Ue.prototype,"formattedFieldInfos",null),a([o()],Ue.prototype,"title",void 0),Ue=a([h("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],Ue);const We=Ue;const Ze="esri-feature-fields",Xe={base:Ze,fieldHeader:`${Ze}__field-header`,fieldData:`${Ze}__field-data`,fieldDataDate:`${Ze}__field-data--date`};let Ge=class extends y{constructor(t,e){super(t,e),this._featureElementInfo=null,this.viewModel=new We,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new Ne,this.addHandles(d((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),p))}destroy(){this._featureElementInfo?.destroy()}get attributes(){return this.viewModel.attributes}set attributes(t){this.viewModel.attributes=t}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get expressionInfos(){return this.viewModel.expressionInfos}set expressionInfos(t){this.viewModel.expressionInfos=t}get fieldInfos(){return this.viewModel.fieldInfos}set fieldInfos(t){this.viewModel.fieldInfos=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){return _("div",{class:Xe.base},this._featureElementInfo?.render(),this._renderFields())}_renderFieldInfo(t,e){const{attributes:i}=this.viewModel,s=t.fieldName||"",n=t.label||s,r=i?null==i[s]?"":i[s]:"",a=!!t.format?.dateFormat,o="number"==typeof r&&!a?this._forceLTR(r):V(this.messagesURIUtils,r),l={[Xe.fieldDataDate]:a};return _("tr",{key:`fields-element-info-row-${s}-${e}`},_("th",{class:Xe.fieldHeader,innerHTML:n,key:`fields-element-info-row-header-${s}-${e}`}),_("td",{class:this.classes(Xe.fieldData,l),innerHTML:o,key:`fields-element-info-row-data-${s}-${e}`}))}_renderFields(){const{formattedFieldInfos:t}=this.viewModel;return t?.length?_("table",{class:F.table,summary:this.messages.fieldsSummary},_("tbody",null,t.map(((t,e)=>this._renderFieldInfo(t,e))))):null}_setupFeatureElementInfo(){const{description:t,title:e}=this;this._featureElementInfo?.set({description:t,title:e})}_forceLTR(t){return`&lrm;${t}`}};a([o()],Ge.prototype,"attributes",null),a([o()],Ge.prototype,"description",null),a([o()],Ge.prototype,"expressionInfos",null),a([o()],Ge.prototype,"fieldInfos",null),a([o()],Ge.prototype,"title",null),a([o({type:We,nonNullable:!0})],Ge.prototype,"viewModel",void 0),a([o(),v("esri/widgets/Feature/t9n/Feature")],Ge.prototype,"messages",void 0),a([o(),v("esri/widgets/support/t9n/uriUtils")],Ge.prototype,"messagesURIUtils",void 0),Ge=a([h("esri.widgets.Feature.FeatureFields")],Ge);const Qe=Ge;const Ye="esri.widgets.Feature.support.relatedFeatureUtils",Je=()=>j.getLogger(Ye),Ke=new Map;function ti(t){if(!q(t))return null;const[e,i]=t.split("/").slice(1);return{layerId:e,fieldName:i}}function ei(t,e){if(!e.relationships)return null;let i=null;const{relationships:s}=e;return s.some((e=>e.id===parseInt(t,10)&&(i=e,!0))),i}function ii({originRelationship:t,relationships:e,layerId:i}){return e.find((({relatedTableId:e,id:s})=>`${e}`===i&&s===t?.id))??null}function si(t,e){const i=e.toLowerCase();for(const e in t)if(e.toLowerCase()===i)return t[e];return null}function ni(t,e){const i=ei(t,e);if(!i)return;return{url:`${e.url}/${i.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:i,relatedFields:[],outStatistics:[]}}function ri(t,e){if(!e)return;if(!t)return;const{features:i,statsFeatures:s}=t,n=i?.value;e.relatedFeatures=n?n.features:[];const r=s?.value;e.relatedStatsFeatures=r?r.features:[]}function ai(t,e,i,s){const n=new W;return n.outFields=["*"],n.relationshipId="number"==typeof e.id?e.id:parseInt(e.id,10),n.objectIds=[t.attributes[i.objectIdField]],n.gdbVersion=i.gdbVersion??null,n.historicMoment=i.historicMoment??null,i.queryRelatedFeatures?.(n,s)??Promise.resolve({})}function oi(t,e,i){let s=0;const n=[];for(;s<e.length;)n.push(`${t} IN (${e.slice(s,i+s)})`),s+=i;return n.join(" OR ")}function li(t){return t?s(t):void 0}function ci(t){return t?s(t,((t,e)=>JSON.stringify(t.toJSON())===JSON.stringify(e.toJSON()))):void 0}async function hi(t,e,i,s){const n=i.layerId.toString(),{layerInfo:r,relation:a,relatedFields:o,outStatistics:l,url:c,sourceSpatialReference:h}=e,u=li(o),d=ci(l);if(!r||!a)return null;const p=ii({originRelationship:a,relationships:r.relationships,layerId:n});if(p?.relationshipTableId&&p.keyFieldInRelationshipTable){const e=(await ai(t,p,i,s))[t.attributes[i.objectIdField]];if(!e)return null;const n=e.features.map((t=>t.attributes[r.objectIdField]));if(d?.length&&r.supportsStatistics){const t=new z;t.where=oi(r.objectIdField,n,1e3),t.outFields=u,t.outStatistics=d,t.sourceSpatialReference=h;const i={features:Promise.resolve(e),statsFeatures:pe(c,t)};return B(i)}}const m=p?.keyField;if(m){const e=H(fi(r.fields,m)),n=si(t.attributes,a.keyField),o=e?`${m}=${n}`:`${m}='${n}'`,l=i.historicMoment,p=i.gdbVersion,f=pe(c,new z({where:o,outFields:u,sourceSpatialReference:h,historicMoment:l,gdbVersion:p}),s),g=!!d?.length&&r.supportsStatistics?pe(c,new z({where:o,outFields:u,outStatistics:d,sourceSpatialReference:h}),s):null,v={features:f};return g&&(v.statsFeatures=g),B(v)}return null}function ui(t,e){return S(t,{query:{f:"json"},signal:e?.signal})}function di({relatedInfos:t,layer:e},i){const s={};return t.forEach(((t,i)=>{const{relation:n}=t;if(!n){const t=new m("relation-required","A relation is required on a layer to retrieve related records.");throw Je().error(t),t}const{relatedTableId:r}=n;if("number"!=typeof r){const t=new m("A related table ID is required on a layer to retrieve related records.");throw Je().error(t),t}const a=`${e.url}/${r}`,o=Ke.get(a),l=o??ui(a);o||Ke.set(a,l),s[i]=l})),D(B(s),i)}function pi({graphic:t,relatedInfos:e,layer:i},s){const n={};return e.forEach(((e,r)=>{e.layerInfo&&(n[r]=hi(t,e,i,s))})),B(n)}function mi({relatedInfo:t,fieldName:e,fieldInfo:i}){if(t.relatedFields?.push(e),i.statisticType){const s=new U({statisticType:i.statisticType,onStatisticField:e,outStatisticFieldName:e});t.outStatistics?.push(s)}}function fi(t,e){if(null!=t){e=e.toLowerCase();for(const i of t)if(i&&i.name.toLowerCase()===e)return i}return null}const gi={chartAnimation:!0};let vi=class extends u{constructor(t){super(t),this.abilities={...gi},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...gi,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,i=(t+e)%e;this.activeMediaInfoIndex=i}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,i=e+t;this._setContentElementMedia(i)}_formatMediaInfos(){const{mediaInfos:t,layer:e}=this,i=this.attributes??{},s=this.formattedAttributes??{},n=this.expressionAttributes??{},r=this.fieldInfoMap??new Map;return t?.map((t=>{const a=t?.clone();if(!a)return null;if(a.title=Z({attributes:i,fieldInfoMap:r,globalAttributes:s,expressionAttributes:n,layer:e,text:a.title}),a.caption=Z({attributes:i,fieldInfoMap:r,globalAttributes:s,expressionAttributes:n,layer:e,text:a.caption}),a.altText=Z({attributes:i,fieldInfoMap:r,globalAttributes:s,expressionAttributes:n,layer:e,text:a.altText}),"image"===a.type){if(!a.value)return;return this._setImageValue({value:a.value,formattedAttributes:s,layer:e}),a.value.sourceURL?a:void 0}if("pie-chart"===a.type||"line-chart"===a.type||"column-chart"===a.type||"bar-chart"===a.type){if(!a.value)return;return this._setChartValue({value:a.value,chartType:a.type,attributes:i,formattedAttributes:s,layer:e,expressionAttributes:n}),a}return null})).filter(X)??[]}_setImageValue(t){const e=this.fieldInfoMap??new Map,{value:i,formattedAttributes:s,layer:n}=t,{linkURL:r,sourceURL:a}=i;if(a){const t=G(a,n);i.sourceURL=Q({formattedAttributes:s,template:t,fieldInfoMap:e})}if(r){const t=G(r,n);i.linkURL=Q({formattedAttributes:s,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:i,formattedAttributes:s,chartType:n,layer:r,expressionAttributes:a}=t,{popupTemplate:o,relatedInfos:l}=this,{fields:c,normalizeField:h}=e,u=r;e.fields=Y(c,u),h&&(e.normalizeField=J(h,u));if(!c.some((t=>!!(null!=s[t]||q(t)&&l?.size))))return;const d=o?.fieldInfos??[];c.forEach(((t,r)=>{const o=e.colors?.[r];if(q(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:d,fieldName:t,formattedAttributes:s,chartType:n,value:e,color:o})]);const l=this._getChartOption({value:e,attributes:i,chartType:n,formattedAttributes:s,expressionAttributes:a,fieldName:t,fieldInfos:d,color:o});e.series.push(l)}))}_getRelatedChartInfos(t){const{fieldInfos:e,fieldName:i,formattedAttributes:s,chartType:n,value:r,color:a}=t,o=[],l=ti(i),c=l&&this.relatedInfos?.get(l.layerId.toString());if(!c)return o;const{relatedFeatures:h,relation:u}=c;if(!u||!h)return o;const{cardinality:d}=u;h.forEach((t=>{const{attributes:c}=t;c&&Object.keys(c).forEach((t=>{t===l.fieldName&&o.push(this._getChartOption({value:r,attributes:c,formattedAttributes:s,fieldName:i,chartType:n,relatedFieldName:t,hasMultipleRelatedFeatures:h?.length>1,fieldInfos:e,color:a}))}))}));return"one-to-many"===d||"many-to-many"===d?o:[o[0]]}_getTooltip({label:t,value:e,chartType:i}){return"pie-chart"===i?`${t}`:`${t}: ${e}`}_getChartOption(t){const{value:e,attributes:i,formattedAttributes:s,expressionAttributes:n,fieldName:r,relatedFieldName:a,fieldInfos:o,chartType:l,hasMultipleRelatedFeatures:c,color:h}=t,u=this.layer,d=this.fieldInfoMap??new Map,{normalizeField:p,tooltipField:m}=e,f=p?q(p)?i[ti(p).fieldName]:i[p]:null,g=K(r)&&n&&void 0!==n[r]?n[r]:a&&void 0!==i[a]?i[a]:void 0!==i[r]?i[r]:s[r],v=new tt({fieldName:r,color:h,value:void 0===g?null:g&&f?g/f:g});if(q(r)){const t=d.get(r.toLowerCase()),e=m&&d.get(m.toLowerCase()),n=t?.fieldName??r,o=c&&m?ti(m).fieldName:e?.fieldName??m,h=c&&o?i[o]:s[o]??t?.label??t?.fieldName??a,u=c&&a?i[a]:s[n];return v.tooltip=this._getTooltip({label:h,value:u,chartType:l}),v}const y=et(o,r),w=J(r,u),b=m&&void 0!==s[m]?s[m]:R(y||new N({fieldName:w}),this.popupTemplate?.expressionInfos),_=s[w];return v.tooltip=this._getTooltip({label:b,value:_,chartType:l}),v}};a([o()],vi.prototype,"abilities",void 0),a([l("abilities")],vi.prototype,"castAbilities",null),a([o()],vi.prototype,"activeMediaInfoIndex",void 0),a([o({readOnly:!0})],vi.prototype,"activeMediaInfo",null),a([o()],vi.prototype,"attributes",void 0),a([o()],vi.prototype,"description",void 0),a([o()],vi.prototype,"fieldInfoMap",void 0),a([o()],vi.prototype,"formattedAttributes",void 0),a([o()],vi.prototype,"expressionAttributes",void 0),a([o({readOnly:!0})],vi.prototype,"formattedMediaInfos",null),a([o()],vi.prototype,"isAggregate",void 0),a([o()],vi.prototype,"layer",void 0),a([o({readOnly:!0})],vi.prototype,"formattedMediaInfoCount",null),a([o()],vi.prototype,"mediaInfos",void 0),a([o()],vi.prototype,"popupTemplate",void 0),a([o()],vi.prototype,"relatedInfos",void 0),a([o()],vi.prototype,"title",void 0),vi=a([h("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],vi);const yi=vi;const wi="esri-feature-media",bi={base:wi,mediaContainer:`${wi}__container`,mediaItemContainer:`${wi}__item-container`,mediaItem:`${wi}__item`,mediaItemText:`${wi}__item-text`,mediaItemTitle:`${wi}__item-title`,mediaItemCaption:`${wi}__item-caption`,mediaNavigation:`${wi}__item-navigation`,mediaPagination:`${wi}__pagination`,mediaPaginationText:`${wi}__pagination-text`,mediaPrevious:`${wi}__previous`,mediaPreviousIconLTR:`${wi}__previous-icon`,mediaPreviousIconRTL:`${wi}__previous-icon--rtl`,mediaNext:`${wi}__next`,mediaNextIconLTR:`${wi}__next-icon`,mediaNextIconRTL:`${wi}__next-icon--rtl`,mediaChart:`${wi}__chart`,mediaPaginationButton:`${wi}__pagination-button`,mediaPaginationIcon:`${wi}__pagination-icon`,mediaChartRendered:`${wi}__chart--rendered`},_i=15,Fi="category",Ii="value",Ai="rgba(50, 50, 50, 1)",Ci=250,Mi=500,ki=200;let $i=class extends y{constructor(t,e){super(t,e),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this._chartRootMap=new WeakMap,this.viewModel=new yi,this.messages=null,this._disposeChart=t=>{this._chartRootMap.get(t)?.dispose(),this._chartRootMap.delete(t)},this._createChart=async t=>{const{destroyed:e,viewModel:i}=this;if(e||!i||!t)return;const{createRoot:s}=await import("./p-2a2ad05b.js"),n=await s(t);this._chartRootMap.set(t,n),this._renderChart({mediaInfo:i.activeMediaInfo,root:n})}}initialize(){this._featureElementInfo=new Ne,this.addHandles([d((()=>[this.viewModel?.activeMediaInfo,this.viewModel?.activeMediaInfoIndex]),(()=>this._setupMediaRefreshTimer()),p),d((()=>[this.viewModel?.description,this.viewModel?.title]),(()=>this._setupFeatureElementInfo()),p)])}loadDependencies(){return b({icon:()=>import("./p-a8caa0f1.js")})}destroy(){this._clearMediaRefreshTimer(),this._featureElementInfo?.destroy()}get attributes(){return this.viewModel.attributes}set attributes(t){this.viewModel.attributes=t}get activeMediaInfoIndex(){return this.viewModel.activeMediaInfoIndex}set activeMediaInfoIndex(t){this.viewModel.activeMediaInfoIndex=t}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get fieldInfoMap(){return this.viewModel.fieldInfoMap}set fieldInfoMap(t){this.viewModel.fieldInfoMap=t}get layer(){return this.viewModel.layer}set layer(t){this.viewModel.layer=t}get mediaInfos(){return this.viewModel.mediaInfos}set mediaInfos(t){this.viewModel.mediaInfos=t}get popupTemplate(){return this.viewModel.popupTemplate}set popupTemplate(t){this.viewModel.popupTemplate=t}get relatedInfos(){return this.viewModel.relatedInfos}set relatedInfos(t){this.viewModel.relatedInfos=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){return _("div",{bind:this,class:bi.base,onkeyup:this._handleMediaKeyup},this._featureElementInfo?.render(),this._renderMedia())}_renderMedia(){const{formattedMediaInfoCount:t,activeMediaInfoIndex:e}=this.viewModel,i=this._renderMediaText();return t?_("div",{class:bi.mediaContainer,key:"media-element-container"},this._renderMediaInfo(),_("div",{class:bi.mediaNavigation},i,t>1?_("div",{class:bi.mediaPagination},this._renderMediaPageButton("previous"),_("span",{class:bi.mediaPaginationText},it(this.messages.pageText,{index:e+1,total:t})),this._renderMediaPageButton("next")):null)):null}_renderMediaText(){const{activeMediaInfo:t}=this.viewModel;if(!t)return null;const e=t&&t.title?_("div",{class:bi.mediaItemTitle,innerHTML:t.title,key:"media-title"}):null,i=t&&t.caption?_("div",{class:bi.mediaItemCaption,innerHTML:t.caption,key:"media-caption"}):null;return e||i?_("div",{class:bi.mediaItemText,key:"media-text"},e,i):null}_renderImageMediaInfo(t){if(!t.value)return null;const{_refreshIntervalInfo:e}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:s}=this.viewModel,{value:n,refreshInterval:r,altText:a,title:o,type:l}=t,{sourceURL:c,linkURL:h}=n,u=L(h??void 0)?"_blank":"_self",d="_blank"===u?"noreferrer":"",p=r?e:null,m=p?p.timestamp:0,f=p?p.sourceURL:c,g=_("img",{alt:a||o,key:`media-${l}-${i}-${s}-${m}`,src:f??void 0});return(h?_("a",{href:h,rel:d,target:u,title:o},g):null)??g}_renderChartMediaInfo(t){const{activeMediaInfoIndex:e,formattedMediaInfoCount:i}=this.viewModel;return _("div",{afterCreate:this._createChart,afterRemoved:this._disposeChart,bind:this,class:bi.mediaChart,key:`media-${t.type}-${e}-${i}`})}_renderMediaInfoType(){const{activeMediaInfo:t}=this.viewModel;return t?"image"===t.type?this._renderImageMediaInfo(t):t.type.includes("chart")?this._renderChartMediaInfo(t):null:null}_renderMediaInfo(){const{activeMediaInfo:t}=this.viewModel;return t?_("div",{class:bi.mediaItemContainer,key:"media-container"},_("div",{class:bi.mediaItem,key:"media-item-container"},this._renderMediaInfoType())):null}_renderMediaPageButton(t){if(this.viewModel.formattedMediaInfoCount<2)return null;const e="previous"===t,i=e?this.messages.previous:this.messages.next,s=e?"chevron-left":"chevron-right",n=e?"media-previous":"media-next",r=e?this._previous:this._next;return _("button",{"aria-label":i,bind:this,class:bi.mediaPaginationButton,key:n,onclick:r,tabIndex:0,title:i,type:"button"},_("calcite-icon",{class:bi.mediaPaginationIcon,icon:s,scale:"s"}))}_setupFeatureElementInfo(){const{description:t,title:e}=this;this._featureElementInfo?.set({description:t,title:e})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_getRenderer(){if(!this.viewModel)return;const{isAggregate:t,layer:e}=this.viewModel;return t&&e?.featureReduction&&"renderer"in e.featureReduction?e.featureReduction.renderer:e?.renderer}async _getSeriesColors(t){const{colorAm5:e}=await import("./p-9d9f0fc9.js"),i=new Map;return t.forEach((t=>{t.color&&i.set(t,e(t.color.toCss(!0)))})),i}async _getRendererColors(){const{colorAm5:t}=await import("./p-9d9f0fc9.js"),e=new Map,i=this._getRenderer(),s="default";if(!i)return e;const n=await ye(i);n.delete(s);return Array.from(n.values()).every((t=>1===t?.length))?(Array.from(n.keys()).forEach((i=>{const s=n.get(i)?.[0]?.toCss(!0);s&&e.set(i,t(s))})),e):e}_handleMediaKeyup(t){const{key:e}=t;"ArrowLeft"===e&&(t.stopPropagation(),this.viewModel.previous()),"ArrowRight"===e&&(t.stopPropagation(),this.viewModel.next())}_canAnimateChart(){return!!this.viewModel&&(!!this.viewModel.abilities.chartAnimation&&!st())}_getChartAnimationMS(){return this._canAnimateChart()?Ci:0}_getChartSeriesAnimationMS(){return this._canAnimateChart()?Mi:0}async _renderChart(t){const{root:e,mediaInfo:i}=t,{value:s,type:n}=i,{ResponsiveThemeAm5:r,DarkThemeAm5:a,AnimatedThemeAm5:o,ColorSetAm5:l,ThemeAm5:c,esriChartColorSet:h}=await import("./p-9d9f0fc9.js"),u=c.new(e);u.rule("ColorSet").set("colors",h),u.rule("ColorSet").set("reuse",!0);const d=[r.new(e),u];nt()&&d.push(a.new(e)),this._canAnimateChart()&&d.push(o.new(e)),e.setThemes(d);const p=await this._getRendererColors(),m=await this._getSeriesColors(s.series),f=l.new(e,{}),g=m.get(s.series[0]),v=g?{lineSettings:{stroke:g}}:void 0,y=s.series.map(((t,e)=>{const i=m.get(t)||p.get(t.fieldName)||f.getIndex(e);return{[Fi]:t.tooltip,[Ii]:t.value,columnSettings:{fill:i,stroke:i},...v}})).filter((t=>"pie-chart"!==n||null!=t.value&&t.value>0));"pie-chart"===n?this._createPieChart(t,y):this._createXYChart(t,y)}_getDirection(){return $(this.container)?"rtl":"ltr"}async _customizeChartTooltip(t,e="horizontal"){const{colorAm5:i}=await import("./p-9d9f0fc9.js");t.setAll({pointerOrientation:e}),t.get("background")?.setAll({stroke:i(Ai)}),t.label.setAll({direction:this._getDirection(),oversizedBehavior:"wrap",maxWidth:ki})}async _createPieChart(t,e){const{TooltipAm5:i}=await import("./p-9d9f0fc9.js"),{PieChartAm5:s,PieSeriesAm5:n}=await import("./p-74c1f244.js"),{mediaInfo:r,root:a}=t,{title:o}=r,l=5,c=r?.altText||r?.title||"",h=a.container.children.push(s.new(a,{ariaLabel:c,focusable:!0,paddingBottom:l,paddingTop:l,paddingLeft:l,paddingRight:l})),u="{category}: {valuePercentTotal.formatNumber('0.00')}%\n ({value})",d=i.new(a,{labelText:u}),p=h.series.push(n.new(a,{name:o,valueField:Ii,categoryField:Fi,tooltip:d}));p.ticks.template.set("forceHidden",!0),p.labels.template.set("forceHidden",!0),p.slices.template.states.create("active",{shiftRadius:l}),this._customizeChartTooltip(d),p.slices.template.setAll({ariaLabel:u,focusable:!0,templateField:"columnSettings"}),p.data.setAll(e),p.appear(this._getChartSeriesAnimationMS()),h.appear(this._getChartAnimationMS()),h.root.dom.classList.toggle(bi.mediaChartRendered,!0)}_getMinSeriesValue(t){let e=0;return t.forEach((t=>e=Math.min(t.value,e))),e}async _createColumnChart(t,e,i){const{TooltipAm5:s,ScrollbarAm5:n}=await import("./p-9d9f0fc9.js"),{CategoryAxisAm5:r,AxisRendererXAm5:a,ValueAxisAm5:o,AxisRendererYAm5:l,ColumnSeriesAm5:c}=await import("./p-3dc3928f.js"),{mediaInfo:h,root:u}=e,{value:d,title:p}=h;t.setAll({wheelX:"panX",wheelY:"zoomX"});const m=t.xAxes.push(r.new(u,{renderer:a.new(u,{inversed:$(this.container)}),categoryField:Fi}));m.get("renderer").labels.template.setAll({forceHidden:!0});const f=t.yAxes.push(o.new(u,{renderer:l.new(u,{inside:!1}),min:this._getMinSeriesValue(d.series)}));f.get("renderer").labels.template.setAll({direction:this._getDirection()});const g="{categoryX}",v=s.new(u,{labelText:g}),y=t.series.push(c.new(u,{name:p,xAxis:m,yAxis:f,valueYField:Ii,categoryXField:Fi,tooltip:v}));this._customizeChartTooltip(v),y.columns.template.setAll({ariaLabel:g,focusable:!0,templateField:"columnSettings"}),d.series.length>_i&&t.set("scrollbarX",n.new(u,{orientation:"horizontal"})),m.data.setAll(i),y.data.setAll(i),y.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())}async _createBarChart(t,e,i){const{TooltipAm5:s,ScrollbarAm5:n}=await import("./p-9d9f0fc9.js"),{CategoryAxisAm5:r,AxisRendererXAm5:a,ValueAxisAm5:o,AxisRendererYAm5:l,ColumnSeriesAm5:c}=await import("./p-3dc3928f.js"),{mediaInfo:h,root:u}=e,{value:d,title:p}=h;t.setAll({wheelX:"panY",wheelY:"zoomY"});const m=t.yAxes.push(r.new(u,{renderer:l.new(u,{inversed:!0}),categoryField:Fi}));m.get("renderer").labels.template.setAll({forceHidden:!0});const f=t.xAxes.push(o.new(u,{renderer:a.new(u,{inside:!1,inversed:$(this.container)}),min:this._getMinSeriesValue(d.series)}));f.get("renderer").labels.template.setAll({direction:this._getDirection()});const g="{categoryY}",v=s.new(u,{labelText:g}),y=t.series.push(c.new(u,{name:p,xAxis:f,yAxis:m,valueXField:Ii,categoryYField:Fi,tooltip:v}));this._customizeChartTooltip(v,"vertical"),y.columns.template.setAll({ariaLabel:g,focusable:!0,templateField:"columnSettings"}),d.series.length>_i&&t.set("scrollbarY",n.new(u,{orientation:"vertical"})),m.data.setAll(i),y.data.setAll(i),y.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())}async _createLineChart(t,e,i){const{TooltipAm5:s,ScrollbarAm5:n}=await import("./p-9d9f0fc9.js"),{CategoryAxisAm5:r,AxisRendererXAm5:a,ValueAxisAm5:o,AxisRendererYAm5:l,LineSeriesAm5:c}=await import("./p-3dc3928f.js"),{root:h,mediaInfo:u}=e,{value:d,title:p}=u;t.setAll({wheelX:"panX",wheelY:"zoomX"});const m=t.xAxes.push(r.new(h,{renderer:a.new(h,{inversed:$(this.container)}),categoryField:Fi}));m.get("renderer").labels.template.setAll({forceHidden:!0});const f=t.yAxes.push(o.new(h,{renderer:l.new(h,{inside:!1}),min:this._getMinSeriesValue(d.series)}));f.get("renderer").labels.template.setAll({direction:this._getDirection()});const g="{categoryX}",v=i[0]?.lineSettings?.stroke,y=s.new(h,{getFillFromSprite:!v,labelText:g});v&&y.get("background")?.setAll({fill:v});const w=t.series.push(c.new(h,{name:p,xAxis:m,yAxis:f,valueYField:Ii,categoryXField:Fi,tooltip:y}));w.strokes.template.setAll({templateField:"lineSettings"}),this._customizeChartTooltip(y,"vertical"),d.series.length>_i&&t.set("scrollbarX",n.new(h,{orientation:"horizontal"})),m.data.setAll(i),w.data.setAll(i),w.appear(this._getChartSeriesAnimationMS()),t.appear(this._getChartAnimationMS())}async _createXYChart(t,e){const{XYChartAm5:i,XYCursorAm5:s}=await import("./p-3dc3928f.js"),{root:n,mediaInfo:r}=t,{type:a}=r,o=r?.altText||r?.title||"",l=n.container.children.push(i.new(n,{ariaLabel:o,focusable:!0,panX:!0,panY:!0}));l.set("cursor",s.new(n,{})),"column-chart"===a&&await this._createColumnChart(l,t,e),"bar-chart"===a&&await this._createBarChart(l,t,e),"line-chart"===a&&await this._createLineChart(l,t,e),l.root.dom.classList.toggle(bi.mediaChartRendered,!0)}_clearMediaRefreshTimer(){const{_refreshTimer:t}=this;t&&(clearTimeout(t),this._refreshTimer=null)}_updateMediaInfoTimestamp(t){const e=Date.now();this._refreshIntervalInfo={timestamp:e,sourceURL:t&&this._getImageSource(t,e)}}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:t}=this.viewModel;"image"===t?.type&&t?.refreshInterval>0&&this._setRefreshTimeout(t)}_setRefreshTimeout(t){const{refreshInterval:e,value:i}=t,s=6e4*e;this._updateMediaInfoTimestamp(i.sourceURL);const n=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),s);this._refreshTimer=n}_getImageSource(t,e){const i=t.includes("?")?"&":"?",[s,n=""]=t.split("#");return`${s}${i}timestamp=${e}${n?"#":""}${n}`}};a([o()],$i.prototype,"_refreshIntervalInfo",void 0),a([o()],$i.prototype,"attributes",null),a([o()],$i.prototype,"activeMediaInfoIndex",null),a([o()],$i.prototype,"description",null),a([o()],$i.prototype,"fieldInfoMap",null),a([o()],$i.prototype,"layer",null),a([o()],$i.prototype,"mediaInfos",null),a([o()],$i.prototype,"popupTemplate",null),a([o()],$i.prototype,"relatedInfos",null),a([o()],$i.prototype,"title",null),a([o({type:yi})],$i.prototype,"viewModel",void 0),a([o(),v("esri/widgets/Feature/t9n/Feature")],$i.prototype,"messages",void 0),$i=a([h("esri.widgets.Feature.FeatureMedia")],$i);const xi=$i;const Ei="esri.widgets.Feature.support.arcadeFeatureUtils",Ti=()=>j.getLogger(Ei);function Li(t){return"string"==typeof t?rt(at(t)):Array.isArray(t)?Pi(t):"esri.arcade.Dictionary"===t?.declaredClass?Oi(t):t}function Pi(t){return`<ul class="esri-widget__list">${t.map((t=>`<li>${"string"==typeof t?rt(at(t)):t}</li>`)).join("")}</ul>`}function Oi(t){const e=t.keys().map((e=>{const i=t.field(e);return`<tr><th>${e}</th><td>${"string"==typeof i?rt(at(i)):i}</td></tr>`})).join("");return`<table class="${F.table}">${e}</table>`}function Ni(){return import("./p-52bac13c.js")}function Ri(t){return"createQuery"in t&&"queryFeatures"in t}async function Vi({graphic:t,view:e,options:i}){const{isAggregate:s,layer:n}=t;if(!s||!n||"2d"!==e?.type)return[];const r=await e.whenLayerView(n);if(!Ri(r))return[];const a=r.createQuery(),o=t.getObjectId();a.aggregateIds=null!=o?[o]:[];const{features:l}=await r.queryFeatures(a,i);return l}function ji({layer:t,aggregatedFeatures:e,interceptor:i}){const{fields:s,objectIdField:n,geometryType:r,spatialReference:a,displayField:o}=t;return new ot({fields:s,objectIdField:n,geometryType:r,spatialReference:a,displayField:o,interceptor:i,..."feature"===t.type?{templates:t.templates,typeIdField:t.typeIdField,types:t.types}:null,source:e})}async function Si({expressionInfo:t,arcade:e,interceptor:i,spatialReference:s,map:n,graphic:r,location:a,view:o,options:l}){if(!t?.expression)return null;const{isAggregate:c}=r,h=(r.sourceLayer||r.layer)??void 0,u=c?"feature-reduction-popup":"popup",d=e.createArcadeProfile(u),p=e.createArcadeExecutor(t.expression,d).catch((e=>Ti().error("arcade-executor-error",{error:e,expressionInfo:t}))),[m,f]=await Promise.all([Vi({graphic:r,view:o,options:l}),p]);if(!f)return null;const g="feature-reduction-popup"===u?ji({layer:h,aggregatedFeatures:m,interceptor:i}):void 0,v={..."feature-reduction-popup"===u?{$aggregatedFeatures:g}:{$datastore:h?.url,$layer:null!=h&&me(h)?h:"scene"===h?.type&&null!=h.associatedLayer?h.associatedLayer:void 0,$map:n,$userInput:a,$graph:"knowledge-graph-sublayer"===h?.type?h?.parentCompositeLayer?.knowledgeGraph:void 0},$feature:r},y={abortSignal:l?.signal??void 0,interceptor:i??void 0,rawOutput:!0,spatialReference:s??void 0,timeZone:o?.timeZone};return await f.executeAsync(v,y).catch((e=>Ti().error("arcade-execution-error",{error:e,graphic:r,expressionInfo:t}))).finally((()=>g?.destroy()))}async function Di({expressionInfos:t,spatialReference:e,graphic:i,interceptor:s,map:n,view:r,location:a,options:o}){if(!t?.length)return{};const l=await Ni(),c={};for(const h of t)c[`expression/${h.name}`]=Si({expressionInfo:h,arcade:l,interceptor:s,spatialReference:e,map:n,graphic:i,location:a,view:r,options:o});const h=await B(c),u={};for(const t in h)u[t]=Li(h[t].value);return u}const Bi=1;let qi=class extends u{constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new We:"media"===t?new yi:"text"===t?new De:null;this._set("contentElementViewModel",e)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=we(this._compile,Bi,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:e,interceptor:i,spatialReference:s,map:n,location:r,view:a,_abortController:o}=this;if(!t||!e)return void this._set("contentElement",null);const l=await Ni();if(o!==this._abortController)return;const c=await Si({arcade:l,expressionInfo:t,graphic:e,location:r,interceptor:i,map:n,spatialReference:s,view:a});if(!c||"esri.arcade.Dictionary"!==c.declaredClass)return void this._set("contentElement",null);const h=await c.castAsJsonAsync(o?.signal),u=h?.type,d="media"===u?ht.fromJSON(h):"text"===u?ut.fromJSON(h):"fields"===u?dt.fromJSON(h):null;"media"===d.type&&!d.mediaInfos||"fields"===d.type&&!d.fieldInfos||"text"===d.type&&!d.text?this._set("contentElement",null):this._set("contentElement",d)},this.addHandles([d((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),p),d((()=>[this.contentElement]),(()=>this._createVM()),p)])}initialize(){this.addHandles(this._compileThrottled)}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:i}=this;return t?"loading":e||i?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}};a([o()],qi.prototype,"_abortController",void 0),a([o({type:lt})],qi.prototype,"expressionInfo",void 0),a([o({type:c})],qi.prototype,"graphic",void 0),a([o({readOnly:!0})],qi.prototype,"contentElement",void 0),a([o({readOnly:!0})],qi.prototype,"contentElementViewModel",void 0),a([o()],qi.prototype,"interceptor",void 0),a([o({type:ct})],qi.prototype,"location",void 0),a([o()],qi.prototype,"spatialReference",null),a([o({readOnly:!0})],qi.prototype,"state",null),a([o()],qi.prototype,"map",null),a([o()],qi.prototype,"view",void 0),qi=a([h("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],qi);const zi=qi;const Hi="esri-feature",Ui={base:`${Hi}-expression`,loadingSpinnerContainer:`${Hi}__loading-container`};let Wi=class extends y{constructor(t,e){super(t,e),this._contentWidget=null,this.viewModel=new zi}initialize(){this.addHandles(d((()=>this.viewModel?.contentElementViewModel),(()=>this._setupExpressionWidget()),p))}loadDependencies(){return b({loader:()=>import("./p-4448c4d3.js")})}destroy(){this._destroyContentWidget()}render(){const{state:t}=this.viewModel;return _("div",{class:Ui.base},"loading"===t?this._renderLoading():"disabled"===t?null:this._contentWidget?.render())}_renderLoading(){return _("div",{class:Ui.loadingSpinnerContainer,key:"loading-container"},_("calcite-loader",{inline:!0,label:""}))}_destroyContentWidget(){const{_contentWidget:t}=this;t&&(t.viewModel=null,t.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:t,contentElement:e}=this.viewModel,i=e?.type;this._destroyContentWidget();const s=t?"fields"===i?new Qe({viewModel:t}):"media"===i?new xi({viewModel:t}):"text"===i?new He({viewModel:t}):null:null;this._contentWidget=s,this.scheduleRender()}};a([o({type:zi})],Wi.prototype,"viewModel",void 0),Wi=a([h("esri.widgets.Feature.FeatureExpression")],Wi);const Zi=Wi;const Xi=100;let Gi=class extends(pt(mt(u))){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:t}=this;t&&t.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const t=new AbortController;this._queryAbortController=t,await ft(this._query()),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await ft(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const t=new AbortController;this._queryPageAbortController=t,await ft(this._queryPage()),this._queryPageAbortController===t&&(this._queryPageAbortController=null)},this._queryDebounced=gt(this._queryController,Xi),this._queryFeatureCountDebounced=gt(this._queryFeatureCountController,Xi),this._queryPageDebounced=gt(this._queryPageController,Xi),this._query=async()=>{const{_queryAbortController:t,relatedFeatures:e}=this;this.featureCount&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,e.destroyAll(),this.destroyed||e.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:t?.signal}))))},this.addHandles([d((()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount]),(()=>this._queryDebounced()),p),d((()=>[this.featurePage,this.showAllEnabled]),(()=>this._queryPageDebounced())),d((()=>[this.layer,this.relationshipId,this.objectId,this.canQuery]),(()=>this._queryFeatureCountDebounced()))])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(t){const{featuresPerPage:e,featureCount:i}=this,s=1,n=Math.ceil(i/e)||1;this._set("featurePage",Math.min(Math.max(t,s),n))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:t,relatedLayer:e}=this;return t&&e?.loaded?t.map((t=>{const i=t.clone();return i.field=J(t.field,e),i})):t??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&null!=this.relationshipId&&"number"==typeof this.objectId}get canQuery(){const t=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&null!=this.relationshipId&&null!=this.objectId&&t?.supportsCount&&t?.supportsPagination)}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}set displayCount(t){const e=0,i=10;this._set("displayCount",Math.min(Math.max(t,e),i))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new r}get relatedLayer(){const{layer:t,map:e,relationship:i}=this;return t?.loaded&&e&&i?vt(e,t,i)??null:null}get relationship(){const{relationshipId:t,layer:e}=this;return null!=t?e?.relationships?.find((({id:e})=>e===t))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new r}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:i,canQuery:s,_loaded:n,canLoad:r}=this;return e||r&&!n?"loading":t||i?"querying":s?"ready":"disabled"}getRelatedFeatureByObjectId(t){return this.relatedFeatures.find((e=>e.getObjectId()===t))}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.destroyAll()}async _queryFeatureCount(){const{layer:t,relatedLayer:e,relationshipId:i,objectId:s,_queryFeatureCountAbortController:n,canQuery:r,supportsCacheHint:a}=this;if(await(t?.load()),await(e?.load()),!r||!t||!e||null==s)return void this._set("featureCount",0);const o=e.createQuery(),{historicMoment:l,gdbVersion:c}=t,h=new W({cacheHint:a,gdbVersion:c,historicMoment:l,relationshipId:i,returnGeometry:!1,objectIds:[s],where:o.where??void 0}),u=await t.queryRelatedFeaturesCount(h,{signal:n?.signal});this._set("featureCount",u[s]||0)}_sliceFeatures(t){const{showAllEnabled:e,displayCount:i}=this;return e?t:i?t.slice(0,i):[]}async _queryPage(){const{relatedFeatures:t,featurePage:e,showAllEnabled:i,_queryPageAbortController:s,featureCount:n}=this;!i||e<2||!n||t.addMany(await this._queryRelatedFeatures({signal:s?.signal}))}async _queryRelatedFeatures(t){const{orderByFieldsFixedCasing:e,showAllEnabled:i,featuresPerPage:s,displayCount:n,layer:r,relationshipId:a,featurePage:o,featureCount:l,relatedLayer:c,supportsCacheHint:h}=this,{canQuery:u,objectId:d}=this;if(!u||!r||!c||null==d)return[];const p=i?((o-1)*s+l)%l:0,m=i?s:n,f=c.objectIdField,g=[...e.map((t=>t.field)),...yt(c),f].filter(X),v=e.map((t=>`${t.field} ${t.order}`)),y=c.createQuery(),{historicMoment:w,gdbVersion:b}=r,_=new W({orderByFields:v,start:p,num:m,outFields:g,cacheHint:h,historicMoment:w,gdbVersion:b,relationshipId:a,returnGeometry:!1,objectIds:[d],where:y.where??void 0}),F=await r.queryRelatedFeatures(_,{signal:t?.signal}),I=F[d]?.features||[];return I.forEach((t=>{t.sourceLayer=c,t.layer=c})),I}};a([o()],Gi.prototype,"_loaded",void 0),a([o()],Gi.prototype,"_queryAbortController",void 0),a([o()],Gi.prototype,"_queryPageAbortController",void 0),a([o()],Gi.prototype,"_queryFeatureCountAbortController",void 0),a([o({value:1})],Gi.prototype,"featurePage",null),a([o()],Gi.prototype,"featuresPerPage",void 0),a([o({readOnly:!0})],Gi.prototype,"orderByFieldsFixedCasing",null),a([o({readOnly:!0})],Gi.prototype,"supportsCacheHint",null),a([o({readOnly:!0})],Gi.prototype,"canLoad",null),a([o({readOnly:!0})],Gi.prototype,"canQuery",null),a([o()],Gi.prototype,"description",void 0),a([o({readOnly:!0})],Gi.prototype,"itemDescriptionFieldName",null),a([o({value:3})],Gi.prototype,"displayCount",null),a([o({type:c})],Gi.prototype,"graphic",void 0),a([o()],Gi.prototype,"layer",void 0),a([o()],Gi.prototype,"map",void 0),a([o({readOnly:!0})],Gi.prototype,"objectId",null),a([o({readOnly:!0})],Gi.prototype,"objectIdField",null),a([o()],Gi.prototype,"orderByFields",void 0),a([o({readOnly:!0})],Gi.prototype,"relatedFeatures",null),a([o({readOnly:!0})],Gi.prototype,"relatedLayer",null),a([o({readOnly:!0})],Gi.prototype,"relationship",null),a([o()],Gi.prototype,"featureCount",void 0),a([o({readOnly:!0})],Gi.prototype,"relatedFeatureViewModels",null),a([o()],Gi.prototype,"relationshipId",void 0),a([o()],Gi.prototype,"showAllEnabled",void 0),a([o()],Gi.prototype,"state",null),a([o()],Gi.prototype,"title",void 0),Gi=a([h("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],Gi);const Qi=Gi;var Yi;const Ji="esri-feature",Ki=`${Ji}-relationship`,ts={base:Ki,listContainer:`${Ki}__list`,listItem:`${Ki}__list-item`,listItemHidden:`${Ki}__list-item--hidden`,listContainerQuerying:`${Ki}__list--querying`,featureObserver:`${Ji}__feature-observer`,stickySpinnerContainer:`${Ji}__sticky-loading-container`,loadingSpinnerContainer:`${Ji}__loading-container`},es={title:!0,description:!0};let is=Yi=class extends y{constructor(t,e){super(t,e),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver((([t])=>{t?.isIntersecting&&this._increaseFeaturePage()}),{root:window.document}),this.flowItems=null,this.flowType="feature-relationship",this.headingLevel=2,this.viewModel=new Qi,this.messages=null,this.messagesCommon=null,this.visibleElements={...es},this._increaseFeaturePage=()=>{const{state:t,showAllEnabled:e,relatedFeatures:i,featuresPerPage:s,featurePage:n}=this.viewModel;"ready"===t&&e&&i.length>=s*n&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new Ne,this.addHandles([d((()=>[this.viewModel.description,this.viewModel.title,this.headingLevel]),(()=>this._setupFeatureElementInfo()),p),d((()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode]),(()=>this._handleRelatedFeatureObserverChange())),w((()=>this.viewModel.relatedFeatureViewModels),"change",(()=>this._setupRelatedFeatureViewModels()))])}loadDependencies(){return b({icon:()=>import("./p-a8caa0f1.js"),list:()=>import("./p-4bdb39fa.js"),"list-item":()=>import("./p-0b8be892.js"),loader:()=>import("./p-4448c4d3.js"),notice:()=>import("./p-cebdc047.js")})}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=wt(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:t,featureCount:e,displayCount:i,state:s}=this.viewModel;return!t&&!!e&&"ready"===s&&(e>i||0===i)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get featureCountDescription(){const{messages:t}=this,{featureCount:e}=this.viewModel;return it(t?.numberRecords,{number:e})}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}castVisibleElements(t){return{...es,...t}}render(){const{state:t}=this.viewModel;return _("div",{class:this.classes(ts.base,F.widget)},this._featureElementInfo?.render(),"loading"===t?this._renderLoading():"disabled"===t?this._renderRelationshipNotFound():this._renderRelatedFeatures())}async _selectRecord(t){const{flowItems:e,featureVisibleElements:i}=this;if(!e)return;t.abilities={relationshipContent:!0};const{default:s}=await Promise.resolve().then((function(){return Rs}));e.push(new s({flowItems:e,flowType:this.flowType,viewModel:t,visibleElements:i}))}_showAllRecords(){const{flowItems:t}=this;if(!t)return;const{viewModel:e,featureVisibleElements:i}=this;e.showAllEnabled=!0;const s=new Yi({flowItems:t,featureVisibleElements:i,visibleElements:{title:!1,description:!1},viewModel:e});t.push(s)}_renderStickyLoading(){return"querying"===this.viewModel.state?_("div",{class:ts.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return _("calcite-loader",{inline:!0,label:""})}_renderLoading(){return _("div",{class:ts.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderShowAllIconNode(){return _("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})}_renderChevronIconNode(){const t=$(this.container)?"chevron-left":"chevron-right";return _("calcite-icon",{icon:t,scale:"s",slot:"content-end"})}_renderRelatedFeature(t){const{itemDescriptionFieldName:e}=this.viewModel,i=t.title;t.description=e&&t.formattedAttributes?.global[e];const s="loading"===t.state;return _("calcite-list-item",{class:this.classes(ts.listItem,{[ts.listItemHidden]:s}),description:t.description??"",key:t.uid,label:i,onCalciteListItemSelect:()=>this._selectRecord(t)},this._renderChevronIconNode())}_renderShowAllListItem(){return this.displayShowAllButton?_("calcite-list-item",{description:this.featureCountDescription,key:"show-all-item",label:this.messages?.showAll,onCalciteListItemSelect:()=>this._showAllRecords()},this._renderShowAllIconNode()):null}_renderNoRelatedFeaturesMessage(){return _("calcite-notice",{icon:"information",key:"no-related-features-message",kind:"brand",open:!0,scale:"s",width:"full"},_("div",{slot:"message"},this.messages?.noRelatedFeatures))}_renderFeatureObserver(){return _("div",{afterCreate:this._relatedFeatureIntersectionObserverCreated,bind:this,class:ts.featureObserver,key:"feature-observer"})}_renderList(){const{relatedFeatureViewModels:t}=this.viewModel;return _("calcite-list",null,t.toArray().map((t=>this._renderRelatedFeature(t))),this._renderShowAllListItem())}_renderRelatedFeatures(){const{displayListItems:t}=this,{state:e}=this.viewModel;return _("div",{class:this.classes(ts.listContainer,{[ts.listContainerQuerying]:"querying"===e}),key:"list-container"},t?this._renderList():"ready"===e?this._renderNoRelatedFeaturesMessage():null,this._renderStickyLoading(),this._renderFeatureObserver())}_renderRelationshipNotFound(){return _("calcite-notice",{icon:"exclamation-mark-triangle",key:"relationship-not-found",kind:"danger",open:!0,scale:"s",width:"full"},_("div",{slot:"message"},this.messages?.relationshipNotFound))}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:t}=this.viewModel,e="related-feature-viewmodels";this.removeHandles(e),t?.forEach((t=>{this.addHandles(d((()=>[t.title,t.state]),(()=>this.scheduleRender()),p),e)})),this.scheduleRender()}_setupFeatureElementInfo(){const{headingLevel:t,visibleElements:e}=this,i=e.description&&this.description,s=e.title&&this.title;this._featureElementInfo?.set({description:i,title:s,headingLevel:t})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:t,showAllEnabled:e}=this.viewModel;await bt(0),this._relatedFeatureIntersectionObserverNode&&"ready"===t&&e&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(t){this._relatedFeatureIntersectionObserverNode=t}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};a([o()],is.prototype,"_relatedFeatureIntersectionObserverNode",void 0),a([o({readOnly:!0})],is.prototype,"displayShowAllButton",null),a([o({readOnly:!0})],is.prototype,"displayListItems",null),a([o()],is.prototype,"description",null),a([o({readOnly:!0})],is.prototype,"featureCountDescription",null),a([o()],is.prototype,"featureVisibleElements",void 0),a([o()],is.prototype,"flowItems",void 0),a([o()],is.prototype,"flowType",void 0),a([o()],is.prototype,"headingLevel",void 0),a([o()],is.prototype,"title",null),a([o({type:Qi})],is.prototype,"viewModel",void 0),a([o(),v("esri/widgets/Feature/t9n/Feature")],is.prototype,"messages",void 0),a([o(),v("esri/t9n/common")],is.prototype,"messagesCommon",void 0),a([o()],is.prototype,"visibleElements",void 0),a([l("visibleElements")],is.prototype,"castVisibleElements",null),is=Yi=a([h("esri.widgets.Feature.FeatureRelationship")],is);const ss=is;const ns={fromGlobalId:"fromglobalid",fromNetworkSourceId:"fromnetworksourceid",fromTerminalId:"fromterminalid",toGlobalId:"toglobalid",toNetworkSourceId:"tonetworksourceid",toTerminalId:"toterminalid",associationType:"associationtype",globalId:"globalid",status:"status",isContentVisible:"iscontentvisible",percentAlong:"percentalong",assetGroup:"assetgroup",assetType:"assettype"};const rs=100;let as=class extends(pt(mt(u))){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._queryController=async t=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await ft(this._query(t)),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await ft(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=gt(this._queryController,rs),this._queryFeatureCountDebounced=gt(this._queryFeatureCountController,rs)}initialize(){this.associationTypes?.forEach((t=>{t.open=!1})),this.addHandles([...this.associationTypes?.map((t=>d((()=>t.open),(()=>{t.open&&this._queryDebounced(t)}))))??[],d((()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery]),(()=>this._queryFeatureCountDebounced()),p)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&"string"==typeof this.globalId}get canQuery(){const t=this.layer?.capabilities?.query;return!!this.associationTypes&&"string"==typeof this.globalId&&!!t?.supportsPagination}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:t}=this;return"subtype-sublayer"===t?.type&&t?.parent?t.parent.globalIdField??null:t?.globalIdField??null}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:i,canQuery:s,_loaded:n,canLoad:r}=this;return e||r&&!n?"loading":t||i?"querying":s&&0!==this.featureCount?"ready":"disabled"}get utilityNetwork(){const{layer:t,map:e}=this;return t?.loaded&&e?"subtype-sublayer"===t?.type&&t?.parent?_t(e,t.parent)??null:_t(e,t)??null:null}get associationsLayer(){const{utilityNetwork:t}=this;return t?.loaded?new ot({url:t.networkSystemLayers.associationsTableUrl,gdbVersion:t.gdbVersion}):null}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new r}get structureAssociations(){return this._get("structureAssociations")||new r}get contentAssociations(){return this._get("contentAssociations")||new r}get containerAssociations(){return this._get("containerAssociations")||new r}get connectivityAssociations(){return this._get("connectivityAssociations")||new r}get associationFeatures(){return this._get("associationFeatures")||new Ft}get associationViewModels(){return this._get("associationViewModels")||new Map}refresh(){this._queryFeatureCountDebounced()}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach((t=>t.destroyAll()))}_generateGlobalIdWhereClause(t,e){const{globalId:i,networkSourceIdsInUse:s}=this,{associatedNetworkSourceId:n}=t,r=e.fieldsIndex.get(ns.fromGlobalId),a=e.fieldsIndex.get(ns.toGlobalId),o=e.fieldsIndex.get(ns.fromNetworkSourceId),l=e.fieldsIndex.get(ns.toNetworkSourceId),c=null!=n,h=`(${Array.from(s.values())})`,u=c?` AND ${l.name} = ${n} AND ${l.name} IN ${h}`:"",d=c?` AND ${o.name} = ${n} AND ${o.name} IN ${h}`:"";switch(t.type){case"connectivity":return`((${r.name} = '${i}'${u}) OR (${a.name} = '${i}'${d}))`;case"attachment":case"content":return`${r.name} = '${i}'${u}`;case"container":case"structure":return`${a.name} = '${i}'${d}`;default:return""}}_generateNetworkSourceIdWhereClause(t){const{networkSourceIdsInUse:e}=this,i=`(${Array.from(e.values())})`,s=t.fieldsIndex.get(ns.fromNetworkSourceId),n=t.fieldsIndex.get(ns.toNetworkSourceId);return`(${s.name} IN ${i} AND ${n.name} IN ${i})`}_generateAssociationTypeWhereClause(t,e){const i=e.fieldsIndex.get(ns.associationType);switch(t.type){case"attachment":case"structure":return`${i.name} = 3`;case"connectivity":return`${i.name} IN  (1, 4, 5, 6)`;case"container":case"content":return`${i.name} = 2`;default:return""}}_generateWhereClause(t,e){const i=e.fieldsIndex.get(ns.status),s=`(${It.join(",")})`,n=`${i.name} IN ${s}`;return`(${this._generateGlobalIdWhereClause(t,e)} AND ${n} AND ${this._generateAssociationTypeWhereClause(t,e)})`}async _loadUtiltyNetworks(){const t=this.map;if(!t)return;await Promise.allSettled(t.utilityNetworks?.map((async t=>{await t.load()}))??[]);const e=t=>{if("layerId"in t&&i.isUtilityLayer(t)){const e=i.getSourceIdByLayerId(t.layerId);null!==e&&this.networkSourceIdsInUse.add(e)}},i=this.utilityNetwork;this._set("networkSourceIdsInUse",new Set),t.allLayers.forEach(e),t.allTables.forEach(e)}async _findLayersBySourceId(t){const{utilityNetwork:e,map:i}=this,s=t=>{const i=t;if(!t.url)return!1;if(i.layerId===n){return t.url.replace(/\/\d+$/,"")===e?.featureServiceUrl}return!1};await(e?.load());const n=e.getLayerIdBySourceId(t),r=i.allLayers.filter(s),a=i.allTables.filter(s),o=r.concat(a).toArray();return await Promise.allSettled(o.map((t=>t.load()))),o}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach((t=>t.removeAll())),this.associationFeatures.clear()}_getAssociationsByType(t){switch(t){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}_createAssociationFromFeature(t,e){if(!t)return null;const i=At.get(e.attributes[t.fieldsIndex.get(ns.associationType).name]);return new fe({globalId:e.attributes[t.fieldsIndex.get(ns.globalId).name],fromNetworkElement:new Ct({globalId:e.attributes[t.fieldsIndex.get(ns.fromGlobalId).name],networkSourceId:e.attributes[t.fieldsIndex.get(ns.fromNetworkSourceId).name],terminalId:e.attributes[t.fieldsIndex.get(ns.fromTerminalId).name]}),toNetworkElement:new Ct({globalId:e.attributes[t.fieldsIndex.get(ns.toGlobalId).name],networkSourceId:e.attributes[t.fieldsIndex.get(ns.toNetworkSourceId).name],terminalId:e.attributes[t.fieldsIndex.get(ns.toTerminalId).name]}),associationType:i,status:e.attributes[t.fieldsIndex.get(ns.status).name],isContentVisible:e.attributes[t.fieldsIndex.get(ns.isContentVisible).name],percentAlong:e.attributes[t.fieldsIndex.get(ns.percentAlong).name]})}async _queryLayer(t,e,i,s,n){const r=t.fieldsIndex.get(ns.assetGroup),a=t.fieldsIndex.get(ns.assetType),o=null!=i,l=null!=s,c="("+e.map((t=>`'${t}'`)).join(", ")+")",h=o?` AND ${r?.name} = ${i}`:"",u=o&&l?` AND ${a?.name} = ${s}`:"",d=`${t.globalIdField} IN ${c}`+h+u,p=new z({outFields:["*"],cacheHint:this.supportsCacheHint,where:d});return await this._queryAll(p,t,{signal:n?.signal})}async _createAssociationFeatureObjects(t,e,i,s,n,r){if(0===t.length)return[];const a=new Map;for(const[t,i]of e){const e=await this._findLayersBySourceId(t);for(const t of e){(await this._queryLayer(t,i,s,n,r)).forEach((e=>{if(e.getEffectivePopupTemplate()&&e.layer){const i=a.get(e.attributes[t.globalIdField])??[];i.push(e),a.set(e.attributes[t.globalIdField],i)}}))}}const o=[];return t.toArray().forEach((t=>{const e=t.fromNetworkElement.globalId===i?t.toNetworkElement:t.fromNetworkElement;(a.get(e.globalId)??[]).forEach((i=>{const s=this.utilityNetwork?.getTerminalById(e?.terminalId)?.name;o.push({association:t,feature:i,terminalName:s})}))})),o}_parseFeatureObjects(t,e){t.forEach((t=>{const i=t?.feature,s=i.layer,n=e.get(s)??new r;n.add(t),e.set(s,n)}))}async _queryAll(t,e,i){const s=[];let n=0,r=!1;t.num=e.sourceJSON?.maxRecordCount??2e3;do{t.start=n;const a=await e.queryFeatures(t,i);s.push(...a.features),r=a.exceededTransferLimit,r&&(n+=a.features.length)}while(r);return s}async _queryAssociatedFeatureCount(t){const{layer:e,globalId:i,supportsCacheHint:s,associationTypes:n,associationsLayer:r,utilityNetwork:a,canQuery:o}=this;if(await Promise.allSettled([e?.load(),a?.load(),r?.load()]),this._clearAssociations(),!(o&&e&&n&&r))return;const l=r.fieldsIndex.get(ns.toGlobalId).name,c=r.fieldsIndex.get(ns.fromGlobalId).name,h=n.map((t=>this._generateWhereClause(t,r))),u=this._generateNetworkSourceIdWhereClause(r),d=h.join(" OR "),p=new z({outFields:["*"],cacheHint:s,returnGeometry:!1,where:`(${d}) AND (${u})`}),m=await this._queryAll(p,r,{signal:t?.signal}),f=new Map;n.forEach((t=>{f.set(t.type,[])})),m.forEach((t=>{const e=r.fieldsIndex.get(ns.associationType);switch(t.attributes[e.name]){case 1:case 4:case 5:case 6:t.attributes[c]===i?f.get("connectivity").push(t.attributes[l]):f.get("connectivity").push(t.attributes[c]),this.connectivityAssociations.add(this._createAssociationFromFeature(r,t));break;case 2:t.attributes[c]===i?(f.get("content").push(t.attributes[l]),this.contentAssociations.add(this._createAssociationFromFeature(r,t))):(f.get("container").push(t.attributes[c]),this.containerAssociations.add(this._createAssociationFromFeature(r,t)));break;case 3:t.attributes[c]===i?(f.get("attachment").push(t.attributes[l]),this.attachmentsAssociations.add(this._createAssociationFromFeature(r,t))):(f.get("structure").push(t.attributes[c]),this.structureAssociations.add(this._createAssociationFromFeature(r,t)))}}));const g=n.map((async e=>{const{associatedNetworkSourceId:i,associatedAssetGroup:s,associatedAssetType:n}=e,r=f.get(e.type),a=null!=s?await this._countAssociatedFeatures(i,r,s,n,t):r.length;switch(e.type){case"attachment":this._set("attachmentsFeatureCount",a);break;case"structure":this._set("structureFeatureCount",a);break;case"content":this._set("contentFeatureCount",a);break;case"container":this._set("containerFeatureCount",a);break;case"connectivity":this._set("connectivityFeatureCount",a)}}));await Promise.allSettled(g)}async _countAssociatedFeatureCount(t,e,i,s,n){const r=t.fieldsIndex.get(ns.assetGroup),a=t.fieldsIndex.get(ns.assetType),o=null!=s,l="("+e.map((t=>`'${t}'`)).join(", ")+")",c=` AND ${r?.name} = ${i}`,h=o?` AND ${a?.name} = ${s}`:"",u=`${t.globalIdField} IN ${l}`+c+h;return t.queryFeatureCount({where:u,outFields:["*"],returnGeometry:!1},{signal:n?.signal})}async _countAssociatedFeatures(t,e,i,s,n){if(0===e.length)return 0;const r=(await this._findLayersBySourceId(t)).map((async t=>this._countAssociatedFeatureCount(t,e,i,s,n)));return(await Promise.all(r)).reduce(((t,e)=>t+e),0)}async _queryAssociatedFeatures(t,e){const{layer:i,globalId:s,associationTypes:n,associationsLayer:r,utilityNetwork:a,canQuery:o,associationFeatures:l}=this;if(await Promise.allSettled([i?.load(),a?.load(),r?.load()]),!(o&&i&&n&&r))return;const c=this._getAssociationsByType(t.type),{associatedAssetGroup:h,associatedAssetType:u}=t,d=new Map;c.forEach((t=>{const{networkSourceId:e,elementGlobalId:i}=t.fromNetworkElement.globalId===s?{networkSourceId:t.toNetworkElement.networkSourceId,elementGlobalId:t.toNetworkElement.globalId}:{networkSourceId:t.fromNetworkElement.networkSourceId,elementGlobalId:t.fromNetworkElement.globalId},n=d.get(e)||[];n.push(i),d.set(e,n)}));const p=await this._createAssociationFeatureObjects(c,d,s,h,u,e);this._parseFeatureObjects(p,l)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:t,canQuery:e}=this;e?(await this._queryAssociatedFeatureCount(t),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(t){await this._loadUtiltyNetworks();const{_queryAbortController:e}=this;this.featureCount&&(this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.destroyed||await this._queryAssociatedFeatures(t,{signal:e?.signal}))}};a([o()],as.prototype,"_loaded",void 0),a([o()],as.prototype,"_queryAbortController",void 0),a([o()],as.prototype,"_queryPageAbortController",void 0),a([o()],as.prototype,"_queryFeatureCountAbortController",void 0),a([o({readOnly:!0})],as.prototype,"supportsCacheHint",null),a([o({readOnly:!0})],as.prototype,"canLoad",null),a([o({readOnly:!0})],as.prototype,"canQuery",null),a([o()],as.prototype,"networkSourceIdsInUse",void 0),a([o()],as.prototype,"description",void 0),a([o({type:c})],as.prototype,"graphic",void 0),a([o()],as.prototype,"layer",void 0),a([o()],as.prototype,"map",void 0),a([o({readOnly:!0})],as.prototype,"objectId",null),a([o({readOnly:!0})],as.prototype,"objectIdField",null),a([o({readOnly:!0})],as.prototype,"globalId",null),a([o({readOnly:!0})],as.prototype,"globalIdField",null),a([o()],as.prototype,"featureCount",void 0),a([o()],as.prototype,"associationTypes",void 0),a([o()],as.prototype,"showAllEnabled",void 0),a([o()],as.prototype,"state",null),a([o()],as.prototype,"title",void 0),a([o({readOnly:!0})],as.prototype,"utilityNetwork",null),a([o({readOnly:!0})],as.prototype,"associationsLayer",null),a([o({readOnly:!0})],as.prototype,"attachmentsFeatureCount",void 0),a([o({readOnly:!0})],as.prototype,"structureFeatureCount",void 0),a([o({readOnly:!0})],as.prototype,"attachmentsAssociations",null),a([o({readOnly:!0})],as.prototype,"structureAssociations",null),a([o({readOnly:!0})],as.prototype,"contentFeatureCount",void 0),a([o({readOnly:!0})],as.prototype,"containerFeatureCount",void 0),a([o({readOnly:!0})],as.prototype,"contentAssociations",null),a([o({readOnly:!0})],as.prototype,"containerAssociations",null),a([o({readOnly:!0})],as.prototype,"connectivityFeatureCount",void 0),a([o({readOnly:!0})],as.prototype,"connectivityAssociations",null),a([o({readOnly:!0})],as.prototype,"associationFeatures",null),a([o({readOnly:!0})],as.prototype,"associationViewModels",null),as=a([h("esri.widgets.Feature.FeatureUtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],as);const os=as;let ls=class extends u{constructor(t){super(t),this.title=!0,this.description=!0}};a([o({type:Boolean,nonNullable:!0})],ls.prototype,"title",void 0),a([o({type:Boolean,nonNullable:!0})],ls.prototype,"description",void 0),ls=a([h("esri.widgets.Feature.FeatureUtilityNetworkAssociations.VisibleElements")],ls);const cs=ls;var hs;const us="esri-feature",ds=`${us}-relationship`,ps={base:ds,listContainer:`${ds}__list`,listItem:`${ds}__list-item`,listItemHidden:`${ds}__list-item--hidden`,listContainerQuerying:`${ds}__list--querying`,featureObserver:`${us}__feature-observer`,stickySpinnerContainer:`${us}__sticky-loading-container`,loadingSpinnerContainer:`${us}__loading-container`,expander:`${ds}__expander`,filterContainer:`${us}__filter-container`};let ms=hs=class extends y{constructor(t,e){super(t,e),this.flowType="feature-utility-network-association-type",this.description=null,this.headingLevel=2,this.title=null,this.viewModel=new os,this.parentFeatureViewModel=null,this.listType=null,this.selectedLayer=null,this.flowItems=null,this.messages=null,this.messagesCommon=null,this.visibleElements=new cs,this._featuresPerPage=50,this._maxNumFeatures=1e3,this._currentFeaturePage=1,this._previewDisplayCount=3,this._associatedFeatureIntersectionObserverNode=null,this._associatedFeatureIntersectionObserver=new IntersectionObserver((([t])=>{t?.isIntersecting&&this._increaseFeaturePage()}),{root:window.document}),this._tooltipReferenceMap=new Ft,this._filterText=""}initialize(){this.addHandles([d((()=>[this._associatedFeatureIntersectionObserverNode]),(()=>this._handleAssociatedFeatureObserverChange()))])}loadDependencies(){return b({chip:()=>import("./p-b8acd634.js"),icon:()=>import("./p-a8caa0f1.js"),input:()=>import("./p-0949d63c.js"),loader:()=>import("./p-4448c4d3.js"),list:()=>import("./p-4bdb39fa.js"),"list-item":()=>import("./p-0b8be892.js"),tooltip:()=>import("./p-c63113ff.js")})}destroy(){this._tooltipReferenceMap.clear()}get _numAssociatedFeatures(){const t=this.viewModel.associationViewModels;return this.selectedLayer?t.get(this.selectedLayer).length:0}set currentFeaturePage(t){const{_featuresPerPage:e,_numAssociatedFeatures:i}=this,s=1,n=Math.ceil(i/e)||1;this._currentFeaturePage=Math.max(Math.min(t,n),s)}get currentFeaturePage(){return this._currentFeaturePage}render(){const t=this.viewModel.associationViewModels,{state:e,showAllEnabled:i}=this.viewModel,{state:s}=this.parentFeatureViewModel??{};return _("div",{class:this.classes(ps.base,F.widget)},"loading"===e||"querying"===e||"loading"===s?this._renderLoading():_("calcite-list",null,i&&this.selectedLayer?_(Mt,null,this._renderFilter(),this._renderAssociatedFeatureListPage(),this._renderFeatureObserver()):Array.from(t.keys(),(e=>this._renderTypeList(e,t.get(e))))))}_renderFilter(){return _("div",{class:ps.filterContainer,key:"filter"},_("calcite-input",{icon:"search",placeholder:this.messages.associationFilterPlaceholder,type:"search",onCalciteInputInput:t=>{this._filterText=t.target.value.trim().toLowerCase(),this._currentFeaturePage=1}}))}_showAllAssociations(t){const{flowItems:e,viewModel:i,description:s}=this;if(!e||!t)return;i.showAllEnabled=!0;const n=new hs({selectedLayer:t,title:t?.title,flowItems:e,parentFeatureViewModel:this.parentFeatureViewModel,featureVisibleElements:this.featureVisibleElements,description:s,visibleElements:{title:!1,description:!1},viewModel:i});e.push(n)}_renderAssociatedFeatureListPage(){const{currentFeaturePage:t,_featuresPerPage:e,_maxNumFeatures:i,_filterText:s}=this,n=Math.min(t*e,i),r=this.viewModel.associationViewModels.get(this.selectedLayer).filter((t=>kt(t.featureViewModel).toLowerCase().includes(s))).slice(0,n);return[...this._renderTooltips(r),...this._renderAssociatedFeatureList(r)]}async _handleAssociatedFeatureObserverChange(){this._associatedFeatureIntersectionObserverNode&&this._associatedFeatureIntersectionObserver.unobserve(this._associatedFeatureIntersectionObserverNode);const{state:t,showAllEnabled:e}=this.viewModel;await bt(0),this._associatedFeatureIntersectionObserverNode&&"ready"===t&&e&&this._associatedFeatureIntersectionObserver.observe(this._associatedFeatureIntersectionObserverNode)}_associatedFeatureIntersectionObserverCreated(t){this._associatedFeatureIntersectionObserverNode=t}_renderFeatureObserver(){return _("div",{afterCreate:this._associatedFeatureIntersectionObserverCreated,bind:this,class:ps.featureObserver,key:"feature-observer"})}_increaseFeaturePage(){this.currentFeaturePage++}_renderLoading(){return _("div",{class:ps.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderLoadingIcon(){return _("calcite-loader",{inline:!0,label:""})}isConnectivity(t){return["connectivity","junction-junction-connectivity","junction-edge-from-connectivity","junction-midspan-connectivity","junction-edge-to-connectivity"].includes(t.association.associationType)}_getConnectivityTooltip(t){switch(t){case"connectivity":case"junction-junction-connectivity":return this.messages.associationsJunctionJunction;case"junction-edge-from-connectivity":return this.messages.associationsJunctionEdgeFrom;case"junction-midspan-connectivity":return this.messages.associationsJunctionEdgeMidspan;case"junction-edge-to-connectivity":return this.messages.associationsJunctionEdgeTo;default:return""}}_renderItemTooltip(t){const{_tooltipReferenceMap:e}=this;return this.isConnectivity(t)?_("calcite-tooltip",{key:`tooltip-${t.featureViewModel.uid}`,referenceElement:e.get(t.featureViewModel.uid)},this._getConnectivityTooltip(t.association.associationType)):null}_renderConnectivityIcon(t,e){let i;switch(t){case"junction-edge-from-connectivity":i="connection-end-left";break;case"junction-edge-to-connectivity":i="connection-end-right";break;case"junction-midspan-connectivity":i="connection-middle";break;default:i="connection-to-connection"}return _("calcite-icon",{afterCreate:t=>this._tooltipReferenceMap.set(e,t),afterRemoved:()=>this._tooltipReferenceMap.delete(e),icon:i,scale:"s",slot:"content-start"})}_formatPercentAlong(t){return`${$t(t.association.percentAlong,{style:"percent",maximumFractionDigits:2})}`}_renderAssociatedFeature(t){const{featureViewModel:e}=t,i=kt(e),s="loading"===e.state,n=this._findFlowItem(e),r=n<0&&this._isParentFeature(e),a=r||n>=0,o=this.isConnectivity(t),l=o&&"junction-midspan-connectivity"===t.association.associationType;return _("calcite-list-item",{class:this.classes(ps.listItem,{[ps.listItemHidden]:s}),description:t.terminalName??"",key:`associated-feature-type-${e.uid}`,label:i,onCalciteListItemSelect:()=>this._handleFeatureClick(r,n,e)},o?this._renderConnectivityIcon(t.association.associationType,t.featureViewModel.uid):null,l?_("calcite-chip",{scale:"s",slot:"content-end",value:t.association.percentAlong},this._formatPercentAlong(t)):null,this._renderChevronIconNode(a))}async _selectAssociation(t){const{flowItems:e,featureVisibleElements:i}=this;if(!e)return;t.abilities={utilityNetworkAssociationsContent:!0};const{default:s}=await Promise.resolve().then((function(){return Rs}));e.push(new s({flowItems:e,flowType:"feature-association",viewModel:t,visibleElements:i}))}_handleFeatureClick(t,e,i){if(t)this.flowItems.drain((t=>{"showAllEnabled"in t.viewModel&&(t.viewModel.showAllEnabled=!1),t.viewModel=null,t.destroy()}));else if(e<0||!this.flowItems)this._selectAssociation(i);else for(;this.flowItems.length>e+1;){const t=this.flowItems.pop();t&&("showAllEnabled"in t.viewModel&&(t.viewModel.showAllEnabled=!1),t.viewModel=null,t.destroy())}}_featureViewModelMatch(t,e){const i=t.graphic,s=i?.layer;let n=null;"subtype-sublayer"===s?.type&&s.parent?n=s.parent.globalIdField??null:s&&"globalIdField"in s&&(n=s.globalIdField);const r=n?i?.attributes[n]:null,a=e.graphic,o=a?.layer;let l=null;"subtype-sublayer"===o?.type&&o.parent?l=o.parent.globalIdField??null:o&&"globalIdField"in o&&(l=o.globalIdField);const c=l?a?.attributes[l]:null;return r&&c&&r===c}_isParentFeature(t){const e=this.flowItems?.getItemAt(0);if(!e)return!1;const i=e.parentFeatureViewModel;return this._featureViewModelMatch(i,t)}_findFlowItem(t){return this.flowItems?.findIndex((e=>{if("feature"!==e.flowType)return!1;const i=e.viewModel;return this._featureViewModelMatch(i,t)}))??-1}_renderTooltips(t){return t.toArray().map((t=>this._renderItemTooltip(t)))}_renderAssociatedFeatureList(t){return t.toArray().map((t=>this._renderAssociatedFeature(t)))}_renderChevronIconNode(t){return _("calcite-icon",{flipRtl:!0,icon:t?"move-up":"chevron-right",scale:"s",slot:"content-end"})}_renderTypeList(t,e){const{messages:i}=this,s=e.slice(0,this._previewDisplayCount),n=s.length<e.length;return _("calcite-list-item",{key:"show-all",label:t.title,open:!0,value:t.id},_("calcite-chip",{scale:"s",slot:"actions-end",value:t.id},e.length),_("calcite-list",{group:t.id},[this._renderTooltips(s),this._renderAssociatedFeatureList(s)],n?_("calcite-list-item",{description:it(i?.numberRecords,{number:e.length.toString()}),key:"show-all-item",label:i.showAll,onCalciteListItemSelect:()=>this._showAllAssociations(t)},_("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})):null))}};a([o()],ms.prototype,"flowType",void 0),a([o()],ms.prototype,"description",void 0),a([o()],ms.prototype,"headingLevel",void 0),a([o()],ms.prototype,"title",void 0),a([o({type:os})],ms.prototype,"viewModel",void 0),a([o()],ms.prototype,"parentFeatureViewModel",void 0),a([o()],ms.prototype,"listType",void 0),a([o()],ms.prototype,"selectedLayer",void 0),a([o()],ms.prototype,"featureVisibleElements",void 0),a([o()],ms.prototype,"flowItems",void 0),a([o(),v("esri/widgets/Feature/t9n/Feature")],ms.prototype,"messages",void 0),a([o(),v("esri/t9n/common")],ms.prototype,"messagesCommon",void 0),a([o({type:cs,nonNullable:!0})],ms.prototype,"visibleElements",void 0),a([o()],ms.prototype,"_featuresPerPage",void 0),a([o()],ms.prototype,"_maxNumFeatures",void 0),a([o()],ms.prototype,"_numAssociatedFeatures",null),a([o()],ms.prototype,"_currentFeaturePage",void 0),a([o()],ms.prototype,"currentFeaturePage",null),a([o()],ms.prototype,"_previewDisplayCount",void 0),a([o()],ms.prototype,"_associatedFeatureIntersectionObserverNode",void 0),a([o()],ms.prototype,"_tooltipReferenceMap",void 0),a([o()],ms.prototype,"_filterText",void 0),ms=hs=a([h("esri.widgets.Feature.FeatureUtilityNetworkAssociationType")],ms);const fs=ms;const gs="esri-feature",vs=`${gs}-relationship`,ys={base:vs,listContainer:`${vs}__list`,listItem:`${vs}__list-item`,listItemHidden:`${vs}__list-item--hidden`,listContainerQuerying:`${vs}__list--querying`,featureObserver:`${gs}__feature-observer`,stickySpinnerContainer:`${gs}__sticky-loading-container`,loadingSpinnerContainer:`${gs}__loading-container`,expander:`${vs}__expander`};let ws=class extends y{constructor(t,e){super(t,e),this._featureElementInfo=null,this.flowType="feature-utility-network-associations",this.flowItems=null,this.parentFeatureViewModel=null,this.headingLevel=2,this.viewModel=new os,this.messages=null,this.messagesCommon=null,this.visibleElements=new cs}initialize(){this._featureElementInfo=new Ne,this.addHandles([d((()=>[this.viewModel.description,this.viewModel.title,this.headingLevel]),(()=>this._setupFeatureElementInfo()),p)])}loadDependencies(){return b({chip:()=>import("./p-b8acd634.js"),icon:()=>import("./p-a8caa0f1.js"),loader:()=>import("./p-4448c4d3.js"),notice:()=>import("./p-cebdc047.js"),list:()=>import("./p-4bdb39fa.js"),"list-item":()=>import("./p-0b8be892.js")})}destroy(){this._featureElementInfo=wt(this._featureElementInfo)}get description(){return this.viewModel.description}set description(t){this.viewModel.description=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}render(){const{state:t}=this.viewModel;return _("div",{class:this.classes(ys.base,F.widget)},this._featureElementInfo?.render(),"loading"===t?this._renderLoading():"disabled"===t?this._renderAssociationNotFound():this._renderContent())}_renderStickyLoading(){return"querying"===this.viewModel.state?_("div",{class:ys.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return _("calcite-loader",{inline:!0,label:""})}_renderLoading(){return _("div",{class:ys.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderAssociationNotFound(){return _("calcite-notice",{icon:"exclamation-mark-triangle",key:"association-not-found",kind:"danger",open:!0,scale:"s",width:"full"},_("div",{slot:"message"},this.messages?.noAssociations))}_setupFeatureElementInfo(){const{headingLevel:t,visibleElements:e}=this,i=e.description&&this.description,s=e.title&&this.title;this._featureElementInfo?.set({description:i,title:s,headingLevel:t})}_getAssociationTypeTitle(t){const{messages:e}=this;if(t.title)return t.title;switch(t.type){case"attachment":return e.associationsAttachments;case"connectivity":return e.associationsConnectivity;case"structure":return e.associationsStructure;case"content":return e.associationsContents;case"container":return e.associationsContainer}}_selectAssociationType(t){const{viewModel:e,flowItems:i,parentFeatureViewModel:s}=this;if(!i)return;const{associationTypes:n}=e;n.forEach((e=>{e.type===t.type?e.open=!0:e.open=!1}));const r=new fs({viewModel:e,parentFeatureViewModel:s,listType:t,title:this._getAssociationTypeTitle(t),featureVisibleElements:this.featureVisibleElements,description:this.parentFeatureViewModel?.title,flowItems:i});i.push(r)}_renderAssociationType(t){const e=this._getAssociationTypeTitle(t);return _("calcite-list-item",{description:t.description,key:`association-type-${t.type}`,label:e,value:t.type,onCalciteListItemSelect:()=>this._selectAssociationType(t)},_("calcite-chip",{scale:"s",slot:"content-end",value:t.type},this._getFeatureCount(t.type)),_("calcite-icon",{flipRtl:!0,icon:"chevron-right",scale:"s",slot:"content-end"}))}_getFeatureCount(t){switch(t){case"attachment":return this.viewModel.attachmentsFeatureCount;case"structure":return this.viewModel.structureFeatureCount;case"content":return this.viewModel.contentFeatureCount;case"container":return this.viewModel.containerFeatureCount;case"connectivity":return this.viewModel.connectivityFeatureCount}}_renderAssociations(t){return _("div",null,this._getFeatureCount(t.type)>0?this._renderAssociationType(t):null)}_renderContent(){const{state:t,associationTypes:e}=this.viewModel;return _("div",{class:this.classes(ys.listContainer,{[ys.listContainerQuerying]:"querying"===t}),key:"list-container"},"ready"===t?_("calcite-list",null,e.map((t=>this._renderAssociations(t)))):null,this._renderStickyLoading())}};a([o()],ws.prototype,"flowType",void 0),a([o()],ws.prototype,"flowItems",void 0),a([o()],ws.prototype,"parentFeatureViewModel",void 0),a([o()],ws.prototype,"featureVisibleElements",void 0),a([o()],ws.prototype,"description",null),a([o()],ws.prototype,"headingLevel",void 0),a([o()],ws.prototype,"title",null),a([o({type:os})],ws.prototype,"viewModel",void 0),a([o(),v("esri/widgets/Feature/t9n/Feature")],ws.prototype,"messages",void 0),a([o(),v("esri/t9n/common")],ws.prototype,"messagesCommon",void 0),a([o({type:cs,nonNullable:!0})],ws.prototype,"visibleElements",void 0),ws=a([h("esri.widgets.Feature.FeatureUtilityNetworkAssociations")],ws);const bs=ws;class _s{constructor(t,e){this.preLayerQueryCallback=t,this.preRequestCallback=e,this.preLayerQueryCallback||(this.preLayerQueryCallback=t=>{}),this.preRequestCallback||(this.preLayerQueryCallback=t=>{})}}var Fs;const Is=1,As="content-view-models",Cs="relationship-view-models",Ms="association-view-models",ks={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0,utilityNetworkAssociationsContent:!0};let $s=Fs=class extends(mt(u)){constructor(t){super(t),this._error=null,this._featureAbortController=null,this._associationVMAbortController=null,this._graphicChangedThrottled=we(this._graphicChanged,Is,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...ks},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=t=>{const{abilities:e}=this;return"attachments"===t.type&&!!e.attachmentsContent||"custom"===t.type&&!!e.customContent||"fields"===t.type&&!!e.fieldsContent||"media"===t.type&&!!e.mediaContent||"text"===t.type&&!!e.textContent||"expression"===t.type&&!!e.expressionContent||"relationship"===t.type&&!!e.relationshipContent||"utility-network-associations"===t.type&&!!e.utilityNetworkAssociationsContent},this.addHandles(d((()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone]),(()=>this._graphicChangedThrottled()),p))}initialize(){this.addHandles(this._graphicChangedThrottled)}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return null!=this.graphic?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return xt(Et(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return g(this.graphic)}castAbilities(t){return{...ks,...t}}get isTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._featureAbortController=new AbortController,this._set("graphic",t?.clone()??null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get timeZone(){return this.view?.timeZone??Tt}set timeZone(t){this._overrideIfSome("timeZone",t)}get map(){return this.view?.map||null}set map(t){this._override("map",t)}get waitingForContent(){return!(!this._featureAbortController&&!this._associationVMAbortController)}setActiveMedia(t,e){const i=this.contentViewModels[t];i instanceof yi&&i.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof yi&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof yi&&e.previous()}async updateGeometry(){const{graphic:t,spatialReference:e,_sourceLayer:i}=this;await(i?.load());const s=i?.objectIdField;if(!s||!t||!i)return;const n=t?.attributes?.[s];if(null==n)return;const r=[n];if(!t.geometry){const s=await Lt({layer:i,graphic:t,outFields:[],objectIds:r,returnGeometry:!0,spatialReference:e}),n=s?.geometry;n&&(t.geometry=n)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(e){Pt(e)||(this._error=e,j.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:e,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return"attachments"===t.type?this._compileAttachments(t,e):"custom"===t.type?this._compileCustom(t,e):"fields"===t.type?this._compileFields(t,e):"media"===t.type?this._compileMedia(t,e):"text"===t.type?this._compileText(t,e):"expression"===t.type?this._compileExpression(t,e):"relationship"===t.type?this._compileRelationship(t,e):"utility-network-associations"===t.type?this._compileUtilityNetworkAssociation(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map(((t,e)=>this._compileContentElement(t,e))).filter(X):"string"==typeof t?this._compileText(new ut({text:t}),0).text:t}_destroyContentViewModels(){this.removeHandles(Cs),this.removeHandles(As),this.contentViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("contentViewModels",[])}_matchesFeature(t,e){const i=t?.graphic?.getObjectId(),s=e?.getObjectId();return null!=i&&null!=s&&i===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:t,relatedFeatures:e,map:i}){const{view:s,spatialReference:n,timeZone:r}=this;e?.filter(Boolean).forEach((e=>{t.some((t=>this._matchesFeature(t,e)))||t.add(new Fs({abilities:{relationshipContent:!1},map:i,view:s,spatialReference:n,timeZone:r,graphic:e}))})),t.forEach((i=>{const s=e?.find((t=>this._matchesFeature(i,t)));s||t.remove(i)}))}_setExpressionContentVM(t,e){const i=this.formattedAttributes,{contentElement:s,contentElementViewModel:n}=t,r=s?.type;n&&r&&("fields"===r&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:i}),n.set(this._createFieldsVMParams(s,e))),"media"===r&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:i}),n.set(this._createMediaVMParams(s,e))),"text"===r&&n.set(this._createTextVMParams(s)))}_compileRelationship(t,e){const{displayCount:i,orderByFields:s,relationshipId:n,title:r,description:a}=t,{_sourceLayer:o,graphic:l,map:c}=this;if(!Ot(o))return;const h=new Qi({displayCount:i,graphic:l,orderByFields:s,relationshipId:n,layer:o,map:c,...this._compileTitleAndDesc({title:r,description:a})});return this.contentViewModels[e]=h,this.addHandles(w((()=>h.relatedFeatures),"change",(()=>this._setRelatedFeaturesViewModels(h))),Cs),t}_matchesGlobalFeature(t,e){const i=t?.association.globalId,s=e?.association.globalId;return null!=i&&null!=s&&i===s}async _setUpUtilityNetworkAssociationsViewModels(t,e,i){const{view:s,spatialReference:n,timeZone:a}=this;t.forEach(((i,s)=>{const n=e.get(s);n?i.forEach((e=>{n.find((t=>this._matchesGlobalFeature(e,t)))||(i.remove(e),0===i.length&&t.delete(s))})):(i.removeAll(),t.delete(s))})),e.forEach(((e,o)=>{const l=t.get(o)||new r;e?.filter(Boolean).forEach((t=>{l.some((e=>this._matchesGlobalFeature(e,t)))||l.add({association:t.association,featureViewModel:new Fs({abilities:{utilityNetworkAssociationsContent:!1},map:i,view:s,spatialReference:n,timeZone:a,graphic:t.feature}),terminalName:t.terminalName})})),t.set(o,l)}));const o=new AbortController;this._associationVMAbortController=o,await this._sortListObjectsByTitle(t,{signal:o.signal}),this._associationVMAbortController===o&&(this._associationVMAbortController=null)}async _sortListObjectsByTitle(t,e){for(const i of t.values()){const t=i.map((t=>Nt((()=>"ready"===t.featureViewModel.state),e?.signal)));await Promise.all(t),i.sort(this._compareByFeatureTitle)}}_compareByFeatureTitle(t,e){const i=kt(t.featureViewModel),s=kt(e.featureViewModel);return i.localeCompare(s,void 0,{numeric:!0})}_compileUtilityNetworkAssociation(t,e){const{title:i,description:s,associationTypes:n}=t,{_sourceLayer:r,graphic:a,map:o}=this;if(!Rt(r))return;const l=new os({graphic:a,associationTypes:n,layer:r,map:o,...this._compileTitleAndDesc({title:i,description:s})});return this.contentViewModels[e]=l,this.addHandles([d((()=>l.associationFeatures.values()),(()=>this._setUpUtilityNetworkAssociationsViewModels(l.associationViewModels,l.associationFeatures,l.map)))],Ms),t}_compileExpression(t,e){const{expressionInfo:i}=t,{graphic:s,map:n,spatialReference:r,view:a,location:o}=this,l=new zi({expressionInfo:i,graphic:s,interceptor:Fs.interceptor,map:n,spatialReference:r,view:a,location:o});return this.contentViewModels[e]=l,this.addHandles(d((()=>l.contentElementViewModel),(()=>this._setExpressionContentVM(l,e)),p),As),t}_compileAttachments(t,e){const{graphic:i}=this,{description:s,title:n}=t;return this.contentViewModels[e]=new Te({graphic:i,...this._compileTitleAndDesc({title:n,description:s})}),t}_compileCustom(t,e){const{graphic:i}=this,{creator:s,destroyer:n}=t;return this.contentViewModels[e]=new De({graphic:i,creator:s,destroyer:n}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:i,_sourceLayer:s,graphic:n,formattedAttributes:r}=this,a=n?.attributes,o=this._expressionAttributes,l=r.global;return{title:Z({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:s,text:t}),description:Z({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:s,text:e})}}_createFieldsVMParams(t,e){const i=this._effectivePopupTemplate,s=this.formattedAttributes,n={...s?.global,...s?.content[e]},r=t?.fieldInfos||i?.fieldInfos,a=r?.filter((({fieldName:t})=>!!t&&(K(t)||q(t)||n.hasOwnProperty(t)))),o=i?.expressionInfos,{description:l,title:c}=t;return{attributes:n,expressionInfos:o,fieldInfos:a,...this._compileTitleAndDesc({title:c,description:l})}}_compileFields(t,e){const i=t.clone(),s=new We(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=s,i.fieldInfos=s.formattedFieldInfos.slice(),i}_createMediaVMParams(t,e){const{abilities:i,graphic:s,_fieldInfoMap:n,_effectivePopupTemplate:r,relatedInfos:a,_sourceLayer:o,_expressionAttributes:l}=this,c=this.formattedAttributes,h=s?.attributes??{},{description:u,mediaInfos:d,title:p}=t;return{abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:h,isAggregate:s?.isAggregate,layer:o,fieldInfoMap:n,formattedAttributes:{...c?.global,...c?.content[e]},expressionAttributes:l,mediaInfos:d,popupTemplate:r,relatedInfos:a,...this._compileTitleAndDesc({title:p,description:u})}}_compileMedia(t,e){const i=t.clone(),s=new yi(this._createMediaVMParams(t,e));return i.mediaInfos=s.formattedMediaInfos.slice(),this.contentViewModels[e]=s,i}_createTextVMParams(t){const{graphic:e,_fieldInfoMap:i,_sourceLayer:s,_expressionAttributes:n}=this;if(t&&t.text){const r=e?.attributes??{},a=this.formattedAttributes?.global??{};t.text=Z({attributes:r,fieldInfoMap:i,globalAttributes:a,expressionAttributes:n,layer:s,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const i=t.clone();return this.contentViewModels[e]=new De(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:i,timeZone:s}=this;if(!t)return;const{lastEditInfoEnabled:n}=t,r=e?.editFieldsInfo;return n&&r?Vt(r,i?.attributes,s,e):void 0}_compileTitle(t){const{_fieldInfoMap:e,_sourceLayer:i,graphic:s,_expressionAttributes:n}=this,r=s?.attributes??{},a=this.formattedAttributes?.global??{};return Z({attributes:r,fieldInfoMap:e,globalAttributes:a,expressionAttributes:n,layer:i,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this;return e?T({type:"title",value:t?.title,event:{graphic:e}}):null}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this;return e?T({type:"content",value:t?.content,event:{graphic:e}}):null}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:i,graphic:s,_effectivePopupTemplate:n}=this,r=this.map,a=this.view,o=this.spatialReference,l=this.location;if(e!==this._featureAbortController||!s)return;await jt({graphic:s,popupTemplate:n,layer:i,spatialReference:o},t);const{content:{value:c},title:{value:h}}=await B({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:u}}=await B({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:Di({expressionInfos:n?.expressionInfos,spatialReference:o,graphic:s,map:r,interceptor:Fs.interceptor,view:a,options:t,location:l})});e===this._featureAbortController&&s&&(this._expressionAttributes=u,this._graphicExpressionAttributes={...s.attributes,...u},this._set("formattedAttributes",this._createFormattedAttributes(c)),this._set("title",this._compileTitle(h)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(c)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){const{_effectivePopupTemplate:s,graphic:n,relatedInfos:r,_sourceLayer:a,_fieldInfoMap:o,_graphicExpressionAttributes:l,timeZone:c}=this;i.content[e]=St({fieldInfos:s?.fieldInfos,graphic:n,attributes:{...l,...t.attributes},layer:a,fieldInfoMap:o,relatedInfos:r,timeZone:c})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:i}){if(t.fieldInfos){const{graphic:s,relatedInfos:n,_sourceLayer:r,_fieldInfoMap:a,_graphicExpressionAttributes:o,timeZone:l}=this;i.content[e]=St({fieldInfos:t.fieldInfos,graphic:s,attributes:{...o,...t.attributes},layer:r,fieldInfoMap:a,relatedInfos:n,timeZone:l})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:i,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:r,_graphicExpressionAttributes:a,timeZone:o}=this,l=e?.fieldInfos,c={global:St({fieldInfos:l,graphic:i,attributes:a,layer:n,fieldInfoMap:r,relatedInfos:s,timeZone:o}),content:[]};return Array.isArray(t)&&t.forEach(((t,e)=>{"fields"===t.type&&this._createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:c}),"media"===t.type&&this._createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:c})})),c}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(e,Et(i),t)}async _queryRelatedInfos(t,e,i){const{relatedInfos:s,_sourceLayer:n}=this;s.clear();const r=null!=n?.associatedLayer?await(n?.associatedLayer.load(i)):n;if(!r||!t)return;const a=e.filter((t=>!!t.fieldName&&q(t.fieldName)));if(!a?.length)return;e.forEach((t=>this._configureRelatedInfo(t,r)));const o=await di({relatedInfos:s,layer:r},i);Object.keys(o).forEach((t=>{const e=s.get(t.toString()),i=o[t]?.value;e&&i&&(e.layerInfo=i.data)}));const l=await pi({graphic:t,relatedInfos:s,layer:r},i);Object.keys(l).forEach((t=>{ri(l[t]?.value,s.get(t.toString()))}))}_configureRelatedInfo(t,e){const{relatedInfos:i}=this,s=ti(t.fieldName||"");if(!s)return;const{layerId:n,fieldName:r}=s;if(!n)return;const a=i.get(n.toString())||ni(n,e);a&&(mi({relatedInfo:a,fieldName:r,fieldInfo:t}),this.relatedInfos.set(n,a))}};$s.interceptor=new _s(Dt,Bt),a([o()],$s.prototype,"_error",void 0),a([o()],$s.prototype,"_featureAbortController",void 0),a([o()],$s.prototype,"_associationVMAbortController",void 0),a([o({readOnly:!0})],$s.prototype,"_effectivePopupTemplate",null),a([o({readOnly:!0})],$s.prototype,"_fieldInfoMap",null),a([o({readOnly:!0})],$s.prototype,"_sourceLayer",null),a([o()],$s.prototype,"abilities",void 0),a([l("abilities")],$s.prototype,"castAbilities",null),a([o({readOnly:!0})],$s.prototype,"content",void 0),a([o({readOnly:!0})],$s.prototype,"contentViewModels",void 0),a([o()],$s.prototype,"description",void 0),a([o({type:Boolean})],$s.prototype,"defaultPopupTemplateEnabled",void 0),a([o({readOnly:!0})],$s.prototype,"isTable",null),a([o({readOnly:!0})],$s.prototype,"state",null),a([o({readOnly:!0})],$s.prototype,"formattedAttributes",void 0),a([o({type:c,value:null})],$s.prototype,"graphic",null),a([o({readOnly:!0})],$s.prototype,"lastEditInfo",void 0),a([o({type:ct})],$s.prototype,"location",void 0),a([o({readOnly:!0})],$s.prototype,"relatedInfos",void 0),a([o()],$s.prototype,"spatialReference",null),a([o()],$s.prototype,"timeZone",null),a([o({readOnly:!0})],$s.prototype,"title",void 0),a([o()],$s.prototype,"map",null),a([o({readOnly:!0})],$s.prototype,"waitingForContent",null),a([o()],$s.prototype,"view",void 0),$s=Fs=a([h("esri.widgets.Feature.FeatureViewModel")],$s);const xs=$s;const Es="esri-feature",Ts={base:Es,container:`${Es}__size-container`,title:`${Es}__title`,main:`${Es}__main-container`,btn:`${Es}__button`,icon:`${Es}__icon`,content:`${Es}__content`,contentNode:`${Es}__content-node`,contentNodeText:`${Es}__content-node--text`,contentElement:`${Es}__content-element`,text:`${Es}__text`,lastEditedInfo:`${Es}__last-edited-info`,fields:`${Es}__fields`,fieldHeader:`${Es}__field-header`,fieldData:`${Es}__field-data`,fieldDataDate:`${Es}__field-data--date`,loadingSpinnerContainer:`${Es}__loading-container`};const Ls=t=>{let e=class extends t{constructor(){super(...arguments),this.renderNodeContent=t=>P(t)&&!t.destroyed?_("div",{class:Ts.contentNode,key:t},t.render()):t instanceof HTMLElement?_("div",{afterCreate:this._attachToNode,bind:t,class:Ts.contentNode,key:t}):qt(t)?_("div",{afterCreate:this._attachToNode,bind:t.domNode,class:Ts.contentNode,key:t}):null}_attachToNode(t){const e=this;t.appendChild(e)}};return e=a([h("esri.widgets.Feature.support.FeatureContentMixin")],e),e};const Ps={title:!0,content:!0,lastEditedInfo:!0};let Os=class extends(Ls(y)){constructor(t,e){super(t,e),this._contentWidgets=[],this.flowType="feature",this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.visibleElements={...Ps},this.viewModel=new xs}initialize(){this.addHandles(d((()=>this.viewModel?.contentViewModels),(()=>this._setupContentWidgets()),p))}loadDependencies(){return b({notice:()=>import("./p-cebdc047.js"),loader:()=>import("./p-4448c4d3.js")})}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get isTable(){return this.viewModel.isTable}get icon(){return"polygon"}set icon(t){this._overrideIfSome("icon",t)}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(t){this.viewModel.spatialReference=t}get timeZone(){return this.viewModel.timeZone}set timeZone(t){this.viewModel.timeZone=t}get title(){return this.viewModel.title}castVisibleElements(t){return{...Ps,...t}}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}setActiveMedia(t,e){return this.viewModel.setActiveMedia(t,e)}nextMedia(t){return this.viewModel.nextMedia(t)}previousMedia(t){return this.viewModel.previousMedia(t)}render(){const{state:t}=this.viewModel,e=_("div",{class:Ts.container,key:"container"},this._renderTitle(),"error"===t?this._renderError():"loading"===t?this._renderLoading():this._renderContentContainer());return _("div",{class:this.classes(Ts.base,F.widget)},e)}_renderError(){const{messagesCommon:t,messages:e,visibleElements:i}=this;return _("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,scale:"s"},i.title?_("div",{key:"error-title",slot:"title"},t.errorMessage):null,_("div",{key:"error-message",slot:"message"},e.loadingError))}_renderLoading(){return _("div",{class:Ts.loadingSpinnerContainer,key:"loading-container"},_("calcite-loader",{inline:!0,label:""}))}_renderContentContainer(){const{visibleElements:t}=this;return t.content?_("div",{class:Ts.main},[this._renderContent(),this._renderLastEditInfo()]):null}_renderTitle(){const{visibleElements:t,title:e}=this;return t.title?_(E,{class:Ts.title,innerHTML:e,level:this.headingLevel}):null}_renderContent(){const t=this.viewModel.content,e="content";if(!t)return null;if(Array.isArray(t))return t.length?_("div",{class:Ts.contentNode,key:`${e}-content-elements`},t.map(this._renderContentElement,this)):null;if("string"==typeof t){const t=this._contentWidgets[0];return!t||t.destroyed?null:_("div",{class:this.classes(Ts.contentNode,Ts.contentNodeText),key:`${e}-content`},t.render())}return this.renderNodeContent(t)}_renderContentElement(t,e){const{visibleElements:i}=this;if("boolean"!=typeof i.content&&!i.content?.[t.type])return null;switch(t.type){case"attachments":return this._renderAttachments(e);case"custom":return this._renderCustom(t,e);case"fields":return this._renderFields(e);case"media":return this._renderMedia(e);case"text":return this._renderText(t,e);case"expression":return this._renderExpression(e);case"relationship":return this._renderRelationship(e);case"utility-network-associations":return this._renderAssociation(e);default:return null}}_renderAttachments(t){const e=this._contentWidgets[t];if(!e||e.destroyed)return null;const{state:i,attachmentInfos:s}=e.viewModel;return"loading"===i||s.length>0?_("div",{class:this.classes(Ts.contentElement),key:this._buildKey("attachments-element",t)},e.render()):null}_renderRelationship(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&this.flowItems?_("div",{class:Ts.contentElement,key:this._buildKey("relationship-element",t)},e.render()):null}_renderAssociation(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&this.flowItems?_("div",{class:Ts.contentElement,key:this._buildKey("utility-network-association-element",t)},e.render()):null}_renderExpression(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&e.viewModel.contentElement?_("div",{class:Ts.contentElement,key:this._buildKey("expression-element",t)},e.render()):null}_renderCustom(t,e){const{creator:i}=t,s=this._contentWidgets[e];return!s||s.destroyed?null:i?_("div",{class:Ts.contentElement,key:this._buildKey("custom-element",e)},s.render()):null}_renderFields(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:_("div",{class:Ts.contentElement,key:this._buildKey("fields-element",t)},e.render())}_renderMedia(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:_("div",{class:Ts.contentElement,key:this._buildKey("media-element",t)},e.render())}_renderLastEditInfo(){const{visibleElements:t,messages:e}=this,{lastEditInfo:i}=this.viewModel;if(!i||!t.lastEditedInfo)return null;const{date:s,user:n}=i,r="edit"===i.type?n?e.lastEditedByUser:e.lastEdited:n?e.lastCreatedByUser:e.lastCreated,a=it(r,{date:s,user:n});return _("div",{class:this.classes(Ts.lastEditedInfo,Ts.contentElement),key:"edit-info-element"},a)}_renderText(t,e){const i=t.text,s=this._contentWidgets[e];return!s||s.destroyed?null:i?_("div",{class:this.classes(Ts.contentElement,Ts.text),key:this._buildKey("text-element",e)},s.render()):null}_buildKey(t,...e){return`${t}__${this.viewModel?.graphic?.uid||"0"}-${e.join("-")}`}_destroyContentWidget(t){t&&(t.viewModel=null,!t.destroyed&&t.destroy())}_destroyContentWidgets(){this._contentWidgets.forEach((t=>this._destroyContentWidget(t))),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:t,visibleElements:e,flowItems:i,viewModel:s}=this,n=s?.content,{contentViewModels:r}=s;if(Array.isArray(n))n.forEach(((n,a)=>{if("attachments"===n.type&&(this._contentWidgets[a]=new je({displayType:n.displayType,headingLevel:e.title&&t<6?t+1:t,viewModel:r[a]})),"fields"===n.type&&(this._contentWidgets[a]=new Qe({viewModel:r[a]})),"media"===n.type&&(this._contentWidgets[a]=new xi({viewModel:r[a]})),"text"===n.type&&(this._contentWidgets[a]=new He({viewModel:r[a]})),"custom"===n.type&&(this._contentWidgets[a]=new He({viewModel:r[a]})),"expression"===n.type&&(this._contentWidgets[a]=new Zi({viewModel:r[a]})),"relationship"===n.type){const t=new ss({flowItems:i,featureVisibleElements:e,viewModel:r[a]});this._contentWidgets[a]=t}if("utility-network-associations"===n.type){const t=new bs({flowItems:i,parentFeatureViewModel:s,featureVisibleElements:e,viewModel:r[a]});this._contentWidgets[a]=t}}),this);else{const t=r[0];t&&!t.destroyed&&(this._contentWidgets[0]=new He({viewModel:t}))}this.scheduleRender()}};a([o()],Os.prototype,"flowType",void 0),a([o()],Os.prototype,"graphic",null),a([o()],Os.prototype,"defaultPopupTemplateEnabled",null),a([o()],Os.prototype,"flowItems",void 0),a([o()],Os.prototype,"headingLevel",void 0),a([o({readOnly:!0})],Os.prototype,"isTable",null),a([o()],Os.prototype,"icon",null),a([o()],Os.prototype,"label",null),a([o()],Os.prototype,"location",null),a([o(),v("esri/widgets/Feature/t9n/Feature")],Os.prototype,"messages",void 0),a([o(),v("esri/t9n/common")],Os.prototype,"messagesCommon",void 0),a([o()],Os.prototype,"spatialReference",null),a([o()],Os.prototype,"timeZone",null),a([o({readOnly:!0})],Os.prototype,"title",null),a([o()],Os.prototype,"visibleElements",void 0),a([l("visibleElements")],Os.prototype,"castVisibleElements",null),a([o()],Os.prototype,"map",null),a([o()],Os.prototype,"view",null),a([o({type:xs})],Os.prototype,"viewModel",void 0),Os=a([h("esri.widgets.Feature")],Os);const Ns=Os;const Rs=Object.freeze({__proto__:null,default:Ns});let Vs=class extends zt.EventedAccessor{constructor(t){super(t),this.location=null,this.screenLocationEnabled=!1,this.view=null,this.addHandles([Ht((()=>{const t=this.screenLocationEnabled?this.view:null;return t?[t.size,"3d"===t.type?t.camera:t.viewpoint]:null}),(()=>this.notifyChange("screenLocation"))),d((()=>this.screenLocation),((t,e)=>{null!=t&&null!=e&&this.emit("view-change")}))])}destroy(){this.view=null}get screenLocation(){const{location:t,view:e,screenLocationEnabled:i}=this,s=e?.spatialReference,n=s?Ut(t,s).geometry:null;return i&&n&&e?.ready?e.toScreen(n):null}};a([o()],Vs.prototype,"location",void 0),a([o()],Vs.prototype,"screenLocation",null),a([o()],Vs.prototype,"screenLocationEnabled",void 0),a([o()],Vs.prototype,"view",void 0),Vs=a([h("esri.widgets.support.AnchorElementViewModel")],Vs);const js=Vs;let Ss=class extends js{constructor(t){super(t),this.visible=!1}};a([o()],Ss.prototype,"visible",void 0),Ss=a([h("esri.widgets.Spinner.SpinnerViewModel")],Ss);const Ds=Ss;const Bs="esri-spinner",qs={base:Bs,spinnerStart:`${Bs}--start`,spinnerFinish:`${Bs}--finish`};let zs=class extends y{constructor(t,e){super(t,e),this._animationDelay=500,this._animationPromise=null,this.viewModel=new Ds}initialize(){this.addHandles(d((()=>this.visible),(t=>this._visibleChange(t))))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}show(t){const{location:e,promise:i}=t??{};e&&(this.viewModel.location=e),this.visible=!0;const s=()=>this.hide();i&&i.catch((()=>{})).then(s)}hide(){this.visible=!1}render(){const{visible:t}=this,{screenLocation:e}=this.viewModel,i=!!e,s=t&&i,n=!t&&i,r={[qs.spinnerStart]:s,[qs.spinnerFinish]:n},a=this._getPositionStyles();return _("div",{class:this.classes(qs.base,r),styles:a})}_visibleChange(t){if(t)return void(this.viewModel.screenLocationEnabled=!0);const e=bt(this._animationDelay);this._animationPromise=e,e.catch((()=>{})).then((()=>{this._animationPromise===e&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)}))}_getPositionStyles(){const{screenLocation:t,view:e}=this.viewModel;if(null==e||null==t)return{};const{padding:i}=e;return{left:t.x-i.left+"px",top:t.y-i.top+"px"}}};a([o()],zs.prototype,"location",null),a([o()],zs.prototype,"view",null),a([o({type:Ds})],zs.prototype,"viewModel",void 0),a([o()],zs.prototype,"visible",null),zs=a([h("esri.widgets.Spinner")],zs);const Hs=zs;const Us="esri-features",Ws={icon:`${Us}__icon`,actionImage:`${Us}__action-image`,base:Us,container:`${Us}__container`,contentContainer:`${Us}__content-container`,contentFeature:`${Us}__content-feature`,flowItemCollapsed:`${Us}__flow-item--collapsed`,header:`${Us}__header`,footer:`${Us}__footer`,featureMenuObserver:`${Us}__feature-menu-observer`,actionExit:`${Us}__action--exit`,loader:`${Us}__loader`,featuresHeading:`${Us}__heading`,paginationActionBar:`${Us}__pagination-action-bar`,paginationPrevious:`${Us}__pagination-previous`,paginationNext:`${Us}__pagination-next`};const Zs=r.ofType({key:"type",defaultKeyValue:"button",base:Wt,typeMap:{button:Zt,toggle:Xt}}),Xs=new Zt({icon:"magnifying-glass-plus",id:"zoom-to-feature",title:"{messages.zoom}",className:x.zoomInMagnifyingGlass}),Gs=new Zt({icon:"trash",id:"remove-selected-feature",title:"{messages.remove}",className:x.trash}),Qs=new Zt({icon:"magnifying-glass-plus",id:"zoom-to-clustered-features",title:"{messages.zoom}",className:x.zoomInMagnifyingGlass}),Ys=new Xt({icon:"table",id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:x.table,value:!1});const Js=Xs.clone();let Ks=class extends y{constructor(t,e){super(t,e),this.messages=null,this.closed=!1,this.closable=!0,this._handleOpenFeature=t=>{this.emit("open-feature",{feature:t})},this._handleZoomToFeature=t=>{this.emit("zoom-to-feature",{featureWidget:t})}}loadDependencies(){return b({action:()=>import("./p-255edeba.js"),"action-bar":()=>import("./p-1ec4c7b3.js"),"action-group":()=>import("./p-1c563561.js"),"flow-item":()=>import("./p-e9d31c79.js")})}render(){const{flowItems:t}=this,e=t?.toArray();return _(Mt,null,e?.map((t=>this._renderFlowItem(t))))}_handleCloseClick(){this.emit("close")}_handleExitClick(){this.emit("exit")}_handleDrillInBackClick(){const t=this.flowItems?.pop();t&&("showAllEnabled"in t.viewModel&&(t.viewModel.showAllEnabled=!1),t&&(t.viewModel=null,t.destroy()))}_getExitMessage(t){switch(t.flowType){case"feature":case"feature-association":return"";case"feature-relationship":return this.messages.exitRelatedRecords;case"feature-utility-network-associations":case"feature-utility-network-association-type":return this.messages.exitAssociations}}_renderFlowItem(t){const{messages:e,closable:i,closed:s}=this,n="graphic"in t&&!t.isTable,r="feature-association"===t.flowType,a=this._getExitMessage(t),o=e.selectFeature;return _("calcite-flow-item",{bind:this,closable:i,closed:s,description:this._getDrillInFlowItemDescription(t),heading:t.title??"",key:`flow-item-${t.viewModel.uid}`,onCalciteFlowItemBack:t=>{t.preventDefault(),this._handleDrillInBackClick()},onCalciteFlowItemClose:this._handleCloseClick},_("calcite-action",{appearance:"transparent",bind:this,class:Ws.actionExit,icon:"move-up",key:"exit-action",onclick:this._handleExitClick,slot:"header-actions-start",text:a,title:a}),n?_("calcite-action",{appearance:"transparent",bind:this,icon:"zoom-to-object",key:"open-feature-action",onclick:()=>this._handleOpenFeature(t),slot:"header-actions-end",text:o,title:o}):null,r?_("calcite-action-bar",{expandDisabled:!0,expanded:!0,key:"header-action-bar",scale:"s",slot:"action-bar"},_("calcite-action-group",{overlayPositioning:"fixed",scale:"s"},this._renderDefaultActions(t))):null,_("div",{class:Ws.container},t.render()))}_renderDefaultActions(t){const e=this._getActionTitle(Js);return _("calcite-action",{active:Js.active,appearance:"solid",bind:this,"data-action-uid":Js.uid,disabled:Js.disabled,icon:Js.icon??"question",indicator:Js.indicator,key:`action-${Js.uid}`,loading:Js.active,onclick:()=>this._handleZoomToFeature(t),scale:"s",text:e,textEnabled:!0,title:e})}_getActionTitle(t){const{messages:e}=this,{id:i}=t,s=t.title??"";return"zoom-to-feature"===i?it(s,{messages:e}):s}_getDrillInFlowItemDescription(t){switch(t.flowType){case"feature":case"feature-association":case"feature-utility-network-associations":return t.viewModel.description??"";case"feature-relationship":return t.featureCountDescription;case"feature-utility-network-association-type":return t.description??""}}};a([o()],Ks.prototype,"flowItems",void 0),a([o(),v("esri/widgets/Features/t9n/Features")],Ks.prototype,"messages",void 0),a([o()],Ks.prototype,"closed",void 0),a([o()],Ks.prototype,"closable",void 0),Ks=a([h("esri.widgets.Features.FeaturesDrillIn")],Ks);const tn=Ks;const en="OBJECTID";const sn="esri.widgets.Popup.PopupViewModel",nn=()=>j.getLogger(sn),rn=t=>{const{event:e,view:i,viewModel:s}=t,{action:n}=e;if(!n)return Promise.reject(new m("trigger-action:missing-arguments","Event has no action"));const{disabled:r,id:a}=n;if(!a)return Promise.reject(new m("trigger-action:invalid-action","action.id is missing"));if(r)return Promise.reject(new m("trigger-action:invalid-action","Action is disabled"));if(a===Xs.id)return cn(s).catch(Gt);if(a===Qs.id)return hn(s);if(a===Ys.id)return s.browseClusterEnabled=!s.browseClusterEnabled,s.featureMenuOpen=s.browseClusterEnabled,Promise.resolve();if(a===Gs.id){s.visible=!1;const{selectedFeature:t}=s;if(!t)return Promise.reject(new m(`trigger-action:${Gs.id}`,"selectedFeature is required",{selectedFeature:t}));const{sourceLayer:e}=t;return e?e.remove(t):i?.graphics.remove(t),Promise.resolve()}return Promise.resolve()};function an(t){const{selectedFeature:e,location:i,view:s}=t;return s?e??i??null:null}function on(t){return!!t&&t.isAggregate&&"cluster"===t.sourceLayer?.featureReduction?.type}async function ln(t,e){if("3d"!==e?.type||!t||"esri.Graphic"!==t.declaredClass)return!0;const i=e.getViewForGraphic(t);if(i&&"whenGraphicBounds"in i){let e=null;try{e=await i.whenGraphicBounds(t,{useViewElevation:!0})}catch(t){}return!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]}return!0}async function cn(t,e){const{location:i,selectedFeature:s,view:n,zoomFactor:r}=t;await(e?.viewModel?.updateGeometry());const a=e?.graphic,o=a?.geometry?a:an(t);if(!n||!o){const t=new m("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:o,view:n});throw nn().error(t),t}const l=n.scale/r,c=a?.geometry??t.selectedFeature?.geometry??i,h=null!=c&&"point"===c.type&&await ln(a??s,n);Xs.active=!0,Xs.disabled=!0;try{await t.zoomTo({target:{target:o,scale:h?l:void 0}})}catch(t){if(Pt(t))return;const e=new m("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:a??s});nn().error(e)}finally{Xs.active=!1,Xs.disabled=!1,t.zoomToLocation=null,h&&(t.location=c)}}async function hn(t){const{selectedFeature:e,view:i}=t;if("2d"!==i?.type){const t=new m("zoomToCluster:invalid-view","View must be 2d MapView.",{view:i});throw nn().error(t),t}if(!e||!on(e)){const t=new m("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw nn().error(t),t}const[s,n]=await pn(i,e);Qs.active=!0,Qs.disabled=!0;const{extent:r}=await s.queryExtent(n);r&&await t.zoomTo({target:r}),Qs.active=!1,Qs.disabled=!1}async function un(t){const{view:e,selectedFeature:i}=t;if(!e||!i)return;const[s,n]=await pn(e,i),{extent:r}=await s.queryExtent(n);t.selectedClusterBoundaryFeature.geometry=r,e.graphics.add(t.selectedClusterBoundaryFeature)}async function dn(t){const{selectedFeature:e,view:i}=t;if(!i||!e)return;const[s,n]=await pn(i,e);Ys.active=!0,Ys.disabled=!0;const{features:r}=await s.queryFeatures(n);Ys.active=!1,Ys.disabled=!1,Ys.value=!0,t?.open({features:[e].concat(r),featureMenuOpen:!0})}async function pn(t,e){const i=await t.whenLayerView(e.sourceLayer),s=i.createQuery(),n=e.getObjectId();return s.aggregateIds=null!=n?[n]:[],[i,s]}function mn(t){Ys.value=!1;const e=t.features.filter((t=>on(t)));e.length&&(t.features=e)}const fn="location-scale-handle",gn=()=>[Xs.clone()],vn=()=>[Qs.clone(),Ys.clone()];let yn=null;function wn(t,e){return"building-scene"===t||"2d"===e&&("map-image"===t||"tile"===t||"imagery"===t||"imagery-tile"===t)}let bn=class extends(Qt(js)){constructor(t){super(t),this._pendingPromises=new ge,this._fetchFeaturesController=null,this._highlightSelectedFeaturePromise=null,this._highlightActiveFeaturePromise=null,this._selectedClusterFeature=null,this.actions=new Zs,this.activeFeature=null,this.autoCloseEnabled=!1,this.browseClusterEnabled=!1,this.content=null,this.defaultPopupTemplateEnabled=!1,this.featurePage=null,this.featuresPerPage=20,this.featureMenuOpen=!1,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new c({symbol:new Yt({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null,this._debouncedLocationUpdate=gt((async t=>{const{spatialReference:e}=this,i=this.selectedFeature?.geometry?.type,s=this.location??t;if(i&&"mesh"!==i&&e&&s&&this.selectedFeature)if("point"!==i)try{const t=this.selectedFeature;let i=t.geometry;const n=this._getHighlightLayer(t),r=t.getObjectId();if(!n||!this.view)return;if(r){const t=this.view?.allLayerViews.find((t=>t.layer.uid===n.uid));if(!t||!("queryFeatures"in t))return;const s=t.createQuery();s.outSpatialReference=e,s.objectIds=[r],s.returnGeometry=!0;const{features:a}=await t.queryFeatures(s);i=a[0]?.geometry}if(!i||"mesh"===i.type)return;if(i=Jt(i,e),yn||(yn=await import("./p-4e3882f9.js")),!await yn.intersects(i,s)){const e=(await yn.nearestCoordinate(i,s)).coordinate??s;this.selectedFeature===t&&(this.location=e)}}catch(t){Pt(t)||j.getLogger(this).error(t)}else this.location=Kt(this.selectedFeature.geometry)??s}))}initialize(){this.addHandles([this.on("view-change",(()=>this._autoClose())),d((()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view]),(()=>this._highlightSelectedFeature())),d((()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view]),(()=>this._highlightActiveFeature())),d((()=>this.view?.animation?.state),(t=>this._animationStateChange(t))),d((()=>this.location),(t=>this._locationChange(t))),d((()=>this.selectedFeature),(t=>this._selectedFeatureChange(t))),d((()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage]),(()=>this._selectedFeatureIndexChange())),d((()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels]),(()=>this._setGraphicOnFeatureViewModels())),d((()=>this.featureViewModels),(()=>this._featureViewModelsChange())),this.on("trigger-action",(t=>rn({event:t,viewModel:this,view:this.view}))),Ht((()=>!this.waitingForResult),(()=>this._waitingForResultChange()),te),d((()=>[this.features,this.map,this.spatialReference,this.timeZone]),(()=>this._updateFeatureVMs())),d((()=>this.view?.scale),(()=>this._viewScaleChange())),Ht((()=>!this.visible),(()=>this.browseClusterEnabled=!1)),d((()=>this.browseClusterEnabled),(t=>t?this.enableClusterBrowsing():this.disableClusterBrowsing()))])}destroy(){this._cancelFetchingFeatures(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null,this.map=null,this.spatialReference=null,this.timeZone=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const t=this._get("allActions")||new Zs;t.removeAll();const{actions:e,defaultActions:i,defaultPopupTemplateEnabled:s,includeDefaultActions:n,selectedFeature:r}=this,a=n?i.concat(e):e,o=r&&("function"==typeof r.getEffectivePopupTemplate&&r.getEffectivePopupTemplate(s)||r.popupTemplate),l=o?.actions,c=o?.overwriteActions?l:l?.concat(a)??a;return c?.filter(Boolean).forEach((e=>t.add(e))),t}get defaultActions(){const t=this._get("defaultActions")||new Zs;return t.removeAll(),t.addMany(on(this.selectedFeature)?vn():gn()),t}get featureCount(){return this.features.length}set features(t){const e=t||[];this._set("features",e);const{pendingPromisesCount:i,promiseCount:s,selectedFeatureIndex:n}=this,r=s&&e.length;r&&i&&-1===n?this.selectedFeatureIndex=0:r&&-1!==n||(this.selectedFeatureIndex=e.length?0:-1)}set location(t){let e=t;const i=this.spatialReference?.isWebMercator,s=t?.spatialReference?.isWGS84;s&&i&&(e=ee(t)),this._set("location",e)}get map(){return this.view?.map??null}set map(t){this._override("map",t)}get pendingPromisesCount(){return this._pendingPromises.size}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(t){this._pendingPromises.clear(),this.features=[],Array.isArray(t)&&t.length?(this._set("promises",t),(t=t.slice()).forEach((t=>this._pendingPromises.add(t))),t.reduce(((t,e)=>t.finally((()=>e.then((t=>{this._pendingPromises.has(e)&&this._updateFeatures(t)})).finally((()=>this._pendingPromises.delete(e))).catch((()=>{}))))),Promise.resolve())):this._set("promises",[])}get selectedFeature(){const{features:t,selectedFeatureIndex:e}=this;if(-1===e)return null;return t[e]||null}get selectedFeatureIndex(){const t=this._get("selectedFeatureIndex");return"number"==typeof t?t:-1}set selectedFeatureIndex(t){const{featureCount:e}=this;t=isNaN(t)||t<-1||!e?-1:(t+e)%e,this.activeFeature=null,this._set("selectedFeatureIndex",t)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{view:t,map:e}=this;return t?t.ready?"ready":"disabled":e?"ready":"disabled"}get timeZone(){return this.view?.timeZone??Tt}set timeZone(t){this._overrideIfSome("timeZone",t)}get waitingForContents(){return this.featureViewModels.some((t=>t.waitingForContent))}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}centerAtLocation(){const{view:t}=this,e=an(this);return e&&t?this.callGoTo({target:{target:e,scale:t.scale}}):Promise.reject(new m("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:e,view:t}))}zoomTo(t){return this.callGoTo(t)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(t,e){const{view:i}=this;if(!i||!t)throw new m("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:t,view:i});return i.fetchPopupFeatures(t,{pointerType:e?.event?.pointerType,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:e?.signal})}open(t){const e={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...t,visible:!0},{fetchFeatures:i}=e;delete e.fetchFeatures,i&&this._setFetchFeaturesPromises(e.location);const s=["actionsMenuOpen","collapsed"];for(const t of s)delete e[t];this.set(e)}triggerAction(t){const e=this.allActions.at(t);e&&!e.disabled&&this.emit("trigger-action",{action:e})}next(){return this.selectedFeatureIndex++,this}previous(){return this.selectedFeatureIndex--,this}disableClusterBrowsing(){mn(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:t,selectedFeature:e}=this;"2d"===t?.type?on(e)?(await un(this),await dn(this)):j.getLogger(this).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",e):j.getLogger(this).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",e)}handleViewClick(t){this._fetchFeaturesAndOpen(t)}_animationStateChange(t){this.zoomToLocation||(Xs.disabled="waiting-for-target"===t)}_clearBrowsedClusterGraphics(){const t=[this.selectedClusterBoundaryFeature,this._selectedClusterFeature].filter(X);this.view?.graphics?.removeMany(t),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(on(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(t){const{selectedFeature:e,updateLocationEnabled:i,view:s}=this;s&&i&&t&&(!e||e.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:t,featureCount:e,featurePage:i,featuresPerPage:s,featureViewModels:n}=this;if(null===i)return;const r=((i-1)*s+e)%e,a=r+s;n.slice(r,a).forEach(((e,i)=>{e&&(e.graphic??=t[r+i])}))}async _selectedFeatureChange(t){const{location:e,updateLocationEnabled:i,view:s}=this;if(!t||!s)return;if(this.browseClusterEnabled){if(this._selectedClusterFeature&&(s.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),on(t))return;return t.symbol=await ie(t),this._selectedClusterFeature=t,void s.graphics.add(this._selectedClusterFeature)}const n=t.sourceLayer?.type;if("map-image"!==n&&"imagery"!==n&&"imagery-tile"!==n||(t.symbol=await ie(t)),!i&&e||!t.geometry){if(i&&!t.geometry){await this.centerAtLocation();const t=s.center?.clone();t&&(this.location=t)}}else this.location=Kt(t.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}async _setFetchFeaturesPromises(t){const{pendingFeatures:e}=await this._fetchFeaturesWithController({mapPoint:t});this.promises=e}_destroyFeatureVMs(){this.featureViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:t,features:e,featureViewModels:i,view:s,spatialReference:n,map:r,timeZone:a,location:o}=this;if(on(t)||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!e?.length)return;const l=i.slice(),c=[];e.forEach(((e,i)=>{if(!e)return;let h=null;if(l.some(((t,i)=>(t&&t.graphic===e&&(h=t,l.splice(i,1)),!!h))),h)c[i]=h;else{const l=new xs({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:n,graphic:e===t?e:null,location:o,map:r,view:s,timeZone:a});c[i]=l}})),l.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("featureViewModels",c)}async _getScreenPoint(t,e){const{spatialReference:i,view:s}=this;if(!s)return null;await(s?.when());const n=t?.spatialReference;return n&&i?(await se(n,i,null,e),s.toScreen(t)):null}_cancelFetchingFeatures(){const t=this._fetchFeaturesController;t&&t.abort(),this._fetchFeaturesController=null}async _projectScreenPointAndFetchFeatures({mapPoint:t,screenPoint:e,event:i,signal:s}){return this.fetchFeatures(e??await this._getScreenPoint(t??this.location,{signal:s}),{signal:s,event:i})}_fetchFeaturesWithController({mapPoint:t,screenPoint:e,event:i}){this._cancelFetchingFeatures();const s=new AbortController,{signal:n}=s;this._fetchFeaturesController=s;const r=this._projectScreenPointAndFetchFeatures({mapPoint:t,screenPoint:e,signal:n,event:i});return r.catch((()=>{})).then((()=>{this._fetchFeaturesController=null})),r}async _fetchFeaturesAndOpen(t){const{mapPoint:e,screenPoint:i}=t,{view:s}=this;this.removeHandles(fn),this.addHandles([d((()=>this.view?.scale),(()=>this._debouncedLocationUpdate(e).catch((t=>{Pt(t)||j.getLogger(this).error(t)})))),Ht((()=>!this.visible),(()=>{this.removeHandles(fn)}),{once:!0})],fn);const{pendingFeatures:n}=await this._fetchFeaturesWithController({mapPoint:e,screenPoint:i,event:t});s?.popup&&"open"in s.popup&&s.popup.open({location:e??void 0,promises:n})}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(t,e){return await t.when(),t.whenLayerView(e)}_getHighlightLayer(t){const{layer:e,sourceLayer:i}=t;return i&&"layer"in i&&i.layer?i.layer:"map-notes"===i?.type||"subtype-group"===i?.type?i:e}_getHighlightTarget(t,e,i){if(wn(e.type,i))return t;const s=t.getObjectId();if(null!=s)return s;const n="imagery"===e.type?void 0:"objectIdField"in e?e.objectIdField||en:null,r=t.attributes;return r&&n&&r[n]||t}_mapIncludesLayer(t){return!!this.map?.allLayers?.includes(t)}async _highlightActiveFeature(){const t="highlight-active-feature";this.removeHandles(t);const{highlightEnabled:e,view:i,activeFeature:s,visible:n}=this;if(!(s&&i&&e&&n))return;const r=this._getHighlightLayer(s);if(!(r&&r instanceof ne&&this._mapIncludesLayer(r)))return;const a=this._getLayerView(i,r);this._highlightActiveFeaturePromise=a;const o=await a;if(!(o&&re(o)&&this._highlightActiveFeaturePromise===a&&this.activeFeature&&this.highlightEnabled))return;const l=o.highlight(this._getHighlightTarget(s,r,i.type));this.addHandles(l,t)}async _highlightSelectedFeature(){const t="highlight-selected-feature";this.removeHandles(t);const{selectedFeature:e,highlightEnabled:i,view:s,visible:n}=this;if(!(e&&s&&i&&n))return;const r=this._getHighlightLayer(e);if(!(r&&r instanceof ne&&this._mapIncludesLayer(r)))return;const a=this._getLayerView(s,r);this._highlightSelectedFeaturePromise=a;const o=await a;if(!(o&&re(o)&&this._highlightSelectedFeaturePromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const l=o.highlight(this._getHighlightTarget(e,r,s.type));this.addHandles(l,t)}_updateFeatures(t){const{features:e}=this,i=t.filter((t=>!e.includes(t)));i?.length&&(this.features=e.concat(i))}};a([o()],bn.prototype,"_fetchFeaturesController",void 0),a([o({type:Zs})],bn.prototype,"actions",void 0),a([o({readOnly:!0})],bn.prototype,"active",null),a([o()],bn.prototype,"activeFeature",void 0),a([o({readOnly:!0})],bn.prototype,"allActions",null),a([o()],bn.prototype,"autoCloseEnabled",void 0),a([o()],bn.prototype,"browseClusterEnabled",void 0),a([o()],bn.prototype,"content",void 0),a([o({type:Zs,readOnly:!0})],bn.prototype,"defaultActions",null),a([o({type:Boolean})],bn.prototype,"defaultPopupTemplateEnabled",void 0),a([o({readOnly:!0})],bn.prototype,"featureCount",null),a([o()],bn.prototype,"featurePage",void 0),a([o({value:[]})],bn.prototype,"features",null),a([o()],bn.prototype,"featuresPerPage",void 0),a([o()],bn.prototype,"featureMenuOpen",void 0),a([o()],bn.prototype,"featureViewModelAbilities",void 0),a([o({readOnly:!0})],bn.prototype,"featureViewModels",void 0),a([o()],bn.prototype,"highlightEnabled",void 0),a([o()],bn.prototype,"includeDefaultActions",void 0),a([o({type:ct})],bn.prototype,"location",null),a([o()],bn.prototype,"map",null),a([o({readOnly:!0})],bn.prototype,"pendingPromisesCount",null),a([o({readOnly:!0})],bn.prototype,"promiseCount",null),a([o()],bn.prototype,"promises",null),a([o({readOnly:!0})],bn.prototype,"selectedClusterBoundaryFeature",void 0),a([o({value:null,readOnly:!0})],bn.prototype,"selectedFeature",null),a([o({value:-1})],bn.prototype,"selectedFeatureIndex",null),a([o({readOnly:!0})],bn.prototype,"selectedFeatureViewModel",null),a([o({readOnly:!0})],bn.prototype,"state",null),a([o()],bn.prototype,"timeZone",null),a([o()],bn.prototype,"title",void 0),a([o()],bn.prototype,"updateLocationEnabled",void 0),a([o()],bn.prototype,"view",void 0),a([o()],bn.prototype,"visible",void 0),a([o({readOnly:!0})],bn.prototype,"waitingForContents",null),a([o({readOnly:!0})],bn.prototype,"waitingForResult",null),a([o()],bn.prototype,"zoomFactor",void 0),a([o()],bn.prototype,"zoomToLocation",void 0),a([o()],bn.prototype,"centerAtLocation",null),bn=a([h("esri.widgets.Features.FeaturesViewModel")],bn);const _n=bn;let Fn=class extends u{constructor(){super(...arguments),this.actionBar=!0,this.closeButton=!0,this.collapseButton=!1,this.featureNavigation=!0,this.featureListLayerTitle=!0,this.flow=!0,this.heading=!0,this.spinner=!0}};a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"actionBar",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"closeButton",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"collapseButton",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"featureNavigation",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"featureListLayerTitle",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"flow",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"heading",void 0),a([o({type:Boolean,nonNullable:!0})],Fn.prototype,"spinner",void 0),Fn=a([h("esri.widgets.Features.FeaturesVisibleElements")],Fn);const In=Fn;const An="selected-index",Cn=0,Mn="features-spinner";function kn(t){return t?.declaredClass.startsWith("esri.layers.")??!1}let $n=class extends(Ls(y)){constructor(t,e){super(t,e),this._featureMenuIntersectionObserverCallback=([t])=>{t?.isIntersecting&&null!=this.viewModel.featurePage&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._featureMenuIntersectionObserverNode=null,this._spinner=null,this._feature=null,this._focusAbortController=null,this._drillInFlowItems=new r,this._drillInWidget=new tn({flowItems:this._drillInFlowItems}),this._rootFlowItemNode=null,this._featureMenuViewportNode=null,this._actionBarMenuNode=null,this.collapsed=!1,this.featureNavigationTop=!1,this.headerActions=new Zs,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.responsiveActionsEnabled=!1,this.viewModel=new _n,this.visibleElements=new In,this._renderAction=(t,e)=>{const i=this._getActionTitle(t),{type:s,active:n,uid:r,disabled:a,indicator:o}=t;return t.visible?_("calcite-action",{active:"toggle"===s&&t.value,appearance:"solid",bind:this,"data-action-uid":r,disabled:a,icon:this._getActionIcon(t),indicator:o,key:`action-${e}`,loading:n,onclick:this._triggerAction,scale:"s",text:i,title:this._hideActionText?i:void 0},this._getFallbackIcon(t)):null},this._openFeatureMenu=()=>{this.featureMenuOpen=!0,this._focusFlowItemNode("menu-flow-item")},this._previousFeature=()=>{this.viewModel.selectedFeatureIndex--},this._nextFeature=()=>{this.viewModel.selectedFeatureIndex++},this._handleFeatureMenuBack=()=>{this.featureMenuOpen&&(this._focusFlowItemNode("root-flow-item"),this.featureMenuOpen=!1)},this._displaySpinnerThrottled=we((()=>this._displaySpinner()),Cn),this._addSelectedFeatureIndexHandle(),this.addHandles([this._displaySpinnerThrottled,d((()=>this.viewModel?.active),(()=>this._toggleScreenLocationEnabled())),d((()=>this.viewModel?.active),(t=>this._drillInWidget.closed=!t)),d((()=>this.visibleElements?.closeButton),(t=>this._drillInWidget.closable=t)),d((()=>this.visibleElements?.spinner),(t=>this._spinnerEnabledChange(t))),d((()=>this.viewModel?.view),((t,e)=>this._viewChange(t,e))),d((()=>this.viewModel?.view?.ready),((t,e)=>this._viewReadyChange(t??!1,e??!1))),d((()=>[this.viewModel?.waitingForResult,this.viewModel?.location]),(()=>{this._hideSpinner(),this._displaySpinnerThrottled()})),d((()=>this.viewModel?.screenLocation),(()=>this._closeOpenActionMenu())),d((()=>this.selectedFeatureWidget),(()=>this._destroyDrillInFlowItemWidgets())),d((()=>{const t=this.selectedFeatureWidget?.viewModel;return[t?.title,t?.state]}),(()=>this._setTitleFromFeatureWidget())),d((()=>{const t=this.selectedFeatureWidget?.viewModel;return[t?.content,t?.state]}),(()=>this._setContentFromFeatureWidget())),d((()=>this.viewModel?.featureViewModels),(()=>this._featureMenuViewportScrollTop())),this._drillInWidget.on("close",(()=>this.close())),this._drillInWidget.on("exit",(()=>this._destroyDrillInFlowItemWidgets())),this._drillInWidget.on("open-feature",(({feature:t})=>this._openRelatedFeature(t))),this._drillInWidget.on("zoom-to-feature",(({featureWidget:t})=>cn(this.viewModel,t)))])}loadDependencies(){return b({action:()=>import("./p-255edeba.js"),"action-bar":()=>import("./p-1ec4c7b3.js"),"action-group":()=>import("./p-1c563561.js"),button:()=>import("./p-5b44be17.js"),flow:()=>import("./p-b1874b0a.js"),"flow-item":()=>import("./p-e9d31c79.js"),list:()=>import("./p-4bdb39fa.js"),"list-item":()=>import("./p-0b8be892.js"),"list-item-group":()=>import("./p-5dd80c68.js"),loader:()=>import("./p-4448c4d3.js")})}destroy(){this._destroyDrillInFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver?.disconnect(),this._drillInWidget?.destroy(),this._focusAbortController?.abort()}get _hideActionText(){if(!this.responsiveActionsEnabled)return!1;const t=this.view?.widthBreakpoint;return"xsmall"===t||"small"===t||"medium"===t}get _featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get _isCollapsed(){return this._collapseEnabled&&this.collapsed}get _collapseEnabled(){return this.visibleElements.collapseButton&&!!this.title&&!!this.content}get active(){return this.viewModel.active}get content(){return this.viewModel.content}set content(t){this.viewModel.content=t}get icon(){return null}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(t){this.viewModel.featureMenuOpen=t}get features(){return this.viewModel.features}set features(t){this.viewModel.features=t}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(t){this.viewModel.goToOverride=t}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get promises(){return this.viewModel.promises}set promises(t){this.viewModel.promises=t}get selectedFeature(){return this.viewModel.selectedFeature}get selectedDrillInFeature(){const t=Array.from(this._drillInFlowItems).at(-1);if(!t)return null;const{flowType:e}=t;return"feature-association"===e||"feature-relationship"===e?t.graphic??null:null}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(t){this.viewModel.selectedFeatureIndex=t}get selectedFeatureWidget(){const{_feature:t,headingLevel:e,_drillInFlowItems:i,timeZone:s,spatialReference:n,map:r}=this,{selectedFeatureViewModel:a}=this.viewModel,o={title:!1};return a?(t?(t.viewModel=a,t.visibleElements=o):this._feature=new Ns({flowItems:i,headingLevel:e+1,timeZone:s,spatialReference:n,map:r,viewModel:a,visibleElements:o}),this._feature):null}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(t){this.viewModel.spatialReference=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}get timeZone(){return this.viewModel.timeZone}set timeZone(t){this.viewModel.timeZone=t}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(t){this.viewModel.updateLocationEnabled=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}blur(){const{active:t}=this.viewModel;t?this._rootFlowItemNode?.blur():j.getLogger(this).warn("Features can only be blurred when currently active.")}clear(){return this.viewModel.clear()}close(){this.viewModel.visible=!1}fetchFeatures(t,e){return this.viewModel.fetchFeatures(t,e)}focus(){const{active:t}=this.viewModel;t?this._focusFlowItemNode(this.featureMenuOpen?"menu-flow-item":"root-flow-item"):j.getLogger(this).warn("Features can only be focused when currently active.")}next(){return this.viewModel.next()}open(t){this.removeHandles(An);const e={collapsed:t?.collapsed??!1};this.set(e),this.viewModel.open(t),this.addHandles(Ht((()=>!this.viewModel.waitingForResult),(()=>this._addSelectedFeatureIndexHandle()),{once:!0}))}previous(){return this.viewModel.previous()}triggerAction(t){return this.viewModel.triggerAction(t)}render(){return _("div",{bind:this,class:this.classes(Ws.base,F.widget,F.panel),onkeydown:this._onMainKeydown},this._renderHeader(),this._renderContentContainer())}_renderFeatureNavigation(){return[this._renderPagination(),this._renderFeatureMenuButton()]}_renderHeader(){return!this.featureMenuOpen&&this.featureNavigationTop&&this._featureNavigationVisible?_("div",{class:Ws.header,key:"header-actions"},this._renderFeatureNavigation()):null}_renderFooter(){return this.featureMenuOpen||this.featureNavigationTop||!this._featureNavigationVisible?null:_("div",{class:Ws.footer,key:"footer-actions",slot:"footer"},this._renderFeatureNavigation())}_renderFeatureMenuButton(){const{messages:t,viewModel:e}=this,{featureCount:i,selectedFeatureIndex:s,pendingPromisesCount:n}=e;return _("calcite-action",{appearance:"solid",bind:this,icon:"list",key:"feature-menu-button",label:t.selectFeature,loading:n>0,onclick:this._openFeatureMenu,scale:"s",text:it(t.pageText,{index:$t(s+1),total:$t(i)}),textEnabled:!0,title:t.selectFeature})}_renderPagination(){const{previous:t,next:e}=this.messagesCommon.pagination;return _("calcite-action-bar",{class:Ws.paginationActionBar,expandDisabled:!0,key:"pagination-action-bar",layout:"horizontal",overflowActionsDisabled:!0,scale:"s"},_("calcite-action-group",{scale:"s"},_("calcite-action",{appearance:"solid",class:Ws.paginationPrevious,icon:"chevron-left",iconFlipRtl:!0,label:t,onclick:this._previousFeature,scale:"s",text:t,title:t}),_("calcite-action",{appearance:"solid",icon:"chevron-right",iconFlipRtl:!0,label:e,onclick:this._nextFeature,scale:"s",text:e,title:e})))}_renderFeatureMenuItem(t){const{selectedFeatureViewModel:e,featureViewModels:i}=this.viewModel,s=t===e,n=i.indexOf(t);return _("calcite-list-item",{bind:this,"data-feature-index":n,key:`feature-menu-item-${t.uid}`,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onmouseleave:this._removeActiveFeature,onmouseover:this._setActiveFeature,selected:s,onCalciteListItemSelect:this._selectFeature},_("span",{innerHTML:t.title||this.messagesCommon.untitled,slot:"content"}))}_groupResultsByLayer(){const{featureViewModels:t}=this.viewModel,e=new Map;return t.forEach((t=>{const i=t?.graphic;if(!i)return;const{layer:s,sourceLayer:n}=i,r=(kn(s)?s:null)||(kn(n)?n:null),a=e.get(r)??[];e.set(r,[...a,t])})),e}_renderFeatureMenu(){const{featureViewModels:t}=this.viewModel,e=this._groupResultsByLayer();return t.length?_("calcite-list",{selectionAppearance:"icon",selectionMode:"single"},Array.from(e.keys(),(t=>{const i=e.get(t)?.map((t=>this._renderFeatureMenuItem(t))),s=t?t.title??this.messagesCommon.untitled:null;return this.visibleElements.featureListLayerTitle&&null!==s?_("calcite-list-item-group",{heading:s,key:t?.uid||"map-graphics"},i):i}))):null}_renderHeaderAction(t,e){const i=t.title||"";return t.visible?_("calcite-action",{active:"toggle"===t.type&&t.value,appearance:"solid",bind:this,"data-action-uid":t.uid,disabled:t.disabled,icon:t.icon??void 0,indicator:t.indicator,key:`header-action-${e}`,loading:t.active,onclick:this._triggerHeaderAction,slot:"header-actions-end",text:i,title:i}):null}_renderHeaderActions(){return this.headerActions.map(((t,e)=>this._renderHeaderAction(t,e))).toArray()}_renderContentFeature(){const{headingLevel:t,visibleElements:e,_isCollapsed:i,_collapseEnabled:s,featureNavigationTop:n}=this,{title:r,active:a}=this.viewModel,o=e.heading&&r?r:"";return _("calcite-flow-item",{afterCreate:this._storeRootFlowItemNode,bind:this,class:this.classes({[Ws.contentFeature]:!0,[Ws.flowItemCollapsed]:i}),closable:e.closeButton,closed:!a,collapsed:i,collapseDirection:n?"down":"up",collapsible:s,headingLevel:t,key:"root-flow-item",onCalciteFlowItemClose:this.close,onCalciteFlowItemToggle:this._handleCollapseToggle},o?_(E,{class:this.classes(Ws.featuresHeading,F.heading),innerHTML:o,key:"header-content",level:this.headingLevel,slot:"header-content"}):null,this._renderHeaderActions(),this._renderActionBar(),i?null:_("div",{class:this.classes(Ws.container,Ws.contentContainer)},this._renderContent()),this._renderFooter())}_renderFeatureMenuContainer(){const{viewModel:t,featureMenuOpen:e,messages:i,messagesCommon:s}=this,{active:n,featureViewModels:r,pendingPromisesCount:a}=t;return e?_("calcite-flow-item",{afterCreate:this._storeFeatureMenuFlowItemNode,bind:this,closable:!1,closed:!n,description:it(i.total,{total:r.length}),heading:i.selectFeature,key:"feature-menu",loading:t.waitingForContents,onCalciteFlowItemBack:t=>{t.preventDefault(),this._handleFeatureMenuBack()}},a>0?_("calcite-loader",{class:Ws.loader,inline:!0,key:"feature-menu-loader",label:s.loading,slot:"header-actions-end"}):null,_("div",{class:Ws.container},this._renderFeatureMenu()),_("div",{afterCreate:this._featureMenuIntersectionObserverCreated,bind:this,class:Ws.featureMenuObserver}),_("calcite-button",{appearance:"transparent",onclick:this._handleFeatureMenuBack,slot:"footer-actions",width:"full"},s.back)):null}_renderContentContainer(){const t=[this._renderContentFeature(),this._renderFeatureMenuContainer(),this._drillInWidget.render()];return this.visibleElements.flow?_("calcite-flow",{key:"content-container"},t):t}_getFallbackIcon(t){const{className:e,icon:i}=t;if(i)return null;const s=ae({action:t,feature:this.selectedFeature}),n={[Ws.icon]:!!e,[Ws.actionImage]:!!s};return e&&(n[e]=!0),s||e?_("span",{"aria-hidden":"true",class:this.classes(Ws.icon,n),key:"icon",styles:oe(s)}):null}_renderActionBar(){return!this._isCollapsed&&this.visibleElements.actionBar&&this.viewModel.allActions?.length?_("calcite-action-bar",{expandDisabled:!0,expanded:!this._hideActionText,key:"header-action-bar",scale:"s",slot:"action-bar"},_("calcite-action-group",{afterCreate:t=>this._actionBarMenuNode=t,overlayPositioning:"fixed",scale:"s"},this._renderActions())):null}_renderActions(){return this.viewModel.allActions.toArray().map(this._renderAction)}_renderContent(){const t=this.viewModel?.content;return t?"string"==typeof t?_("div",{class:Ts.contentNode,innerHTML:t,key:t}):this.renderNodeContent(t):null}_handleCollapseToggle(){this.collapsed=!this.collapsed}async _openRelatedFeature(t){await t.viewModel.updateGeometry();const e=t.graphic,i=e?.geometry;if(null==i||null==e)return;this._destroyDrillInFlowItemWidgets(),await this.viewModel.zoomTo({target:i});const s=Kt(i);this.open({features:[e],location:null!=s?s:void 0})}async _focusFlowItemNode(t){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const e=this._focusAbortController.signal;await ft(le(e));const i="menu-flow-item"===t?this._featureMenuViewportNode:this._rootFlowItemNode;ce(i)}_storeRootFlowItemNode(t){this._rootFlowItemNode=t}_storeFeatureMenuFlowItemNode(t){this._featureMenuViewportNode=t}_setActiveFeature(t){const{viewModel:e}=this,i=t.currentTarget["data-feature-index"];e.activeFeature=e.features?.[i]||null}_removeActiveFeature(){this.viewModel.activeFeature=null}_selectFeature(t){const e=t.currentTarget["data-feature-index"];isNaN(e)||(this.viewModel.selectedFeatureIndex=e),this._handleFeatureMenuBack()}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(t){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(t),this._featureMenuIntersectionObserverNode=t}_getActionIcon(t){return t.icon?t.icon:t.image||t.className?void 0:"question"}_getActionTitle(t){const{messages:e,selectedFeature:i,messagesCommon:s}=this,{id:n}=t,r=i?.attributes,a=t.title??"",o="zoom-to-feature"===n?it(a,{messages:e}):"remove-selected-feature"===n?it(a,{messages:s}):"zoom-to-clustered-features"===n||"browse-clustered-features"===n?it(a,{messages:e}):t.title;return o&&r?it(o,r):o??""}_onMainKeydown(t){const{key:e}=t;"ArrowLeft"===e&&(t.stopPropagation(),this._handleFeatureMenuBack(),this.previous()),"ArrowRight"===e&&(t.stopPropagation(),this._handleFeatureMenuBack(),this.next())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&this._featureMenuViewportNode.scrollContentTo({top:0})}_setContentFromFeatureWidget(){const{selectedFeatureWidget:t}=this;t&&(this.viewModel.content=t)}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:t,messagesCommon:e}=this,i=t?.viewModel;t&&(this.viewModel.title="error"===i?.state?e?.errorMessage:i?.title||"")}_addSelectedFeatureIndexHandle(){const t=d((()=>this.viewModel?.selectedFeatureIndex),((t,e)=>this._selectedFeatureIndexUpdated(t,e)));this.addHandles(t,An)}_selectedFeatureIndexUpdated(t,e){const{featureCount:i}=this.viewModel;i&&t!==e&&-1!==t&&(this._destroyDrillInFlowItemWidgets(),this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))}_triggerHeaderAction(t){const e=t.currentTarget;if(e.disabled)return;const i=e.dataset.actionUid,s=this.headerActions.find((({uid:t})=>t===i));s&&!s.disabled&&("toggle"===s?.type&&(s.value=!s.value),this.emit("trigger-header-action",{action:s}))}_triggerAction(t){const e=t.currentTarget;if(e.disabled)return;const i=e.dataset.actionUid,{allActions:s}=this.viewModel,n=s.findIndex((t=>t.uid===i)),r=s.at(n);r&&"toggle"===r.type&&(r.value=!r.value),this.viewModel.triggerAction(n)}_createSpinner(t){t&&(this._spinner=new Hs({view:t}),t.ui.add(this._spinner,{key:Mn,position:"manual",internal:!0}))}_wireUpView(t){this._destroySpinner(),t&&this.visibleElements?.spinner&&this._createSpinner(t)}_hideSpinner(){const{_spinner:t}=this;t&&(t.location=null,t.hide())}_viewReadyChange(t,e){t?this._wireUpView(this.viewModel?.view):e&&this.viewModel.clear()}_viewChange(t,e){t&&e&&this.viewModel.clear()}_destroySelectedFeatureWidget(){const{_feature:t}=this;t&&(t.viewModel=null,!t.destroyed&&t.destroy()),this._feature=null}_closeOpenActionMenu(){const{_actionBarMenuNode:t}=this;t&&(t.menuOpen=!1)}_destroyDrillInFlowItemWidgets(){this._drillInFlowItems.drain((t=>{"showAllEnabled"in t.viewModel&&(t.viewModel.showAllEnabled=!1),t.viewModel=null,t.destroy()}))}_toggleScreenLocationEnabled(){const{viewModel:t}=this;t&&(t.screenLocationEnabled=t.active)}_displaySpinner(){const{_spinner:t}=this;if(!t)return;const{location:e,waitingForResult:i}=this.viewModel;i&&e?t.show({location:e}):t.hide()}_destroySpinner(){const{_spinner:t,view:e}=this;t&&(e?.ui?.remove(t,Mn),t.destroy(),this._spinner=null)}_spinnerEnabledChange(t){this._destroySpinner(),t&&this._createSpinner(this.viewModel?.view)}};a([o()],$n.prototype,"_drillInFlowItems",void 0),a([o()],$n.prototype,"_hideActionText",null),a([o()],$n.prototype,"_featureNavigationVisible",null),a([o()],$n.prototype,"_isCollapsed",null),a([o()],$n.prototype,"_collapseEnabled",null),a([o({readOnly:!0})],$n.prototype,"active",null),a([o()],$n.prototype,"collapsed",void 0),a([o()],$n.prototype,"content",null),a([o()],$n.prototype,"icon",null),a([o()],$n.prototype,"featureMenuOpen",null),a([o()],$n.prototype,"featureNavigationTop",void 0),a([o()],$n.prototype,"features",null),a([o()],$n.prototype,"goToOverride",null),a([o({type:Zs})],$n.prototype,"headerActions",void 0),a([o()],$n.prototype,"headingLevel",void 0),a([o()],$n.prototype,"location",null),a([o()],$n.prototype,"label",null),a([o()],$n.prototype,"map",null),a([o(),v("esri/widgets/Features/t9n/Features")],$n.prototype,"messages",void 0),a([o(),v("esri/t9n/common")],$n.prototype,"messagesCommon",void 0),a([o()],$n.prototype,"promises",null),a([o()],$n.prototype,"responsiveActionsEnabled",void 0),a([o({readOnly:!0})],$n.prototype,"selectedFeature",null),a([o({readOnly:!0})],$n.prototype,"selectedDrillInFeature",null),a([o()],$n.prototype,"selectedFeatureIndex",null),a([o({readOnly:!0})],$n.prototype,"selectedFeatureWidget",null),a([o()],$n.prototype,"spatialReference",null),a([o()],$n.prototype,"title",null),a([o()],$n.prototype,"timeZone",null),a([o()],$n.prototype,"updateLocationEnabled",null),a([o()],$n.prototype,"view",null),a([o({type:_n}),he(["triggerAction","trigger-action"])],$n.prototype,"viewModel",void 0),a([o({type:In,nonNullable:!0})],$n.prototype,"visibleElements",void 0),a([o()],$n.prototype,"visible",null),$n=a([h("esri.widgets.Features")],$n);const xn=$n;const En="esri-popup",Tn=`${En}--is-docked`,Ln={base:En,baseHidden:`${En}--hidden`,main:`${En}__main-container`,shadow:`${En}--shadow`,isDocked:Tn,isDockedTopLeft:`${Tn}-top-left`,isDockedTopCenter:`${Tn}-top-center`,isDockedTopRight:`${Tn}-top-right`,isDockedBottomLeft:`${Tn}-bottom-left`,isDockedBottomCenter:`${Tn}-bottom-center`,isDockedBottomRight:`${Tn}-bottom-right`,alignTopCenter:`${En}--aligned-top-center`,alignBottomCenter:`${En}--aligned-bottom-center`,alignTopLeft:`${En}--aligned-top-left`,alignBottomLeft:`${En}--aligned-bottom-left`,alignTopRight:`${En}--aligned-top-right`,alignBottomRight:`${En}--aligned-bottom-right`,pointer:`${En}__pointer`,pointerDirection:`${En}__pointer-direction`};let Pn=class extends _n{constructor(t){super(t)}};Pn=a([h("esri.widgets.Popup.PopupViewModel")],Pn);const On=Pn;let Nn=class extends u{constructor(){super(...arguments),this.actionBar=!0,this.closeButton=!0,this.collapseButton=!0,this.featureNavigation=!0,this.featureListLayerTitle=!0,this.heading=!0,this.spinner=!0}};a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"actionBar",void 0),a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"closeButton",void 0),a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"collapseButton",void 0),a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"featureNavigation",void 0),a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"featureListLayerTitle",void 0),a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"heading",void 0),a([o({type:Boolean,nonNullable:!0})],Nn.prototype,"spinner",void 0),Nn=a([h("esri.widgets.Popup.PopupVisibleElements")],Nn);const Rn=Nn;const Vn=200,jn={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};let Sn=class extends y{constructor(t,e){super(t,e),this._dockAction=new Zt({id:"popup-dock-action"}),this._featuresWidget=new xn({responsiveActionsEnabled:!0}),this._containerNode=null,this._mainContainerNode=null,this._pointerOffsetInPx=16,this._focusAbortController=null,this.alignment="auto",this.dockEnabled=!1,this.headingLevel=2,this.messages=null,this.viewModel=new On,this.visibleElements=new Rn}initialize(){this.addHandles([d((()=>[this.viewModel?.view?.widthBreakpoint,this.dockEnabled]),(()=>this._handleDockIcon()),p),d((()=>[this.dockEnabled,this.messages?.undock,this.messages?.dock]),(()=>this._handleDockEnabled()),p),d((()=>this.dockOptions),(t=>{const{_dockAction:e}=this,i=this._featuresWidget.headerActions;i.remove(e),t.buttonEnabled&&i.add(e)}),p),d((()=>this.viewModel?.screenLocation),(()=>this._positionContainer())),d((()=>[this.viewModel?.active,this.dockEnabled]),(()=>this._toggleScreenLocationEnabled())),d((()=>[this.viewModel?.screenLocation,this.viewModel?.view?.padding,this.viewModel?.view?.size,this.viewModel?.active,this.viewModel?.location,this.alignment]),(()=>this.reposition())),d((()=>this.viewModel?.view?.size),((t,e)=>this._updateDockEnabledForViewSize(t,e))),d((()=>this.viewModel?.view),((t,e)=>this._viewChange(t,e))),d((()=>this.viewModel?.view?.ready),((t,e)=>this._viewReadyChange(t??!1,e??!1))),d((()=>this.viewModel),(()=>this._featuresWidget.viewModel=this.viewModel),p),d((()=>this._featureNavigationTop),(t=>this._featuresWidget.featureNavigationTop=t),p),d((()=>this.headingLevel),(t=>this._featuresWidget.headingLevel=t),p),d((()=>this.visibleElements.actionBar),(t=>this._featuresWidget.visibleElements.actionBar=!!t),p),d((()=>this.visibleElements.closeButton),(t=>this._featuresWidget.visibleElements.closeButton=!!t),p),d((()=>this.visibleElements.collapseButton),(t=>this._featuresWidget.visibleElements.collapseButton=!!t),p),d((()=>this.visibleElements.heading),(t=>this._featuresWidget.visibleElements.heading=!!t),p),d((()=>this.visibleElements.spinner),(t=>this._featuresWidget.visibleElements.spinner=!!t),p),d((()=>this.visibleElements.featureNavigation),(t=>this._featuresWidget.visibleElements.featureNavigation=!!t),p),d((()=>this.visibleElements.featureListLayerTitle),(t=>this._featuresWidget.visibleElements.featureListLayerTitle=!!t),p),w((()=>this._featuresWidget),"trigger-header-action",(t=>{t.action===this._dockAction&&(this.dockEnabled=!this.dockEnabled)}))])}normalizeCtorArgs(t){const e={...t};return null!=t?.visibleElements&&(e.visibleElements=new Rn(t.visibleElements),null!=t.collapseEnabled&&(e.visibleElements.collapseButton=t.collapseEnabled),null!=t.spinnerEnabled&&(e.visibleElements.spinner=t.spinnerEnabled)),e}destroy(){this._dockAction.destroy(),this._featuresWidget?.destroy(),this._focusAbortController?.abort()}get _featureNavigationTop(){const{currentAlignment:t,currentDockPosition:e}=this;return"bottom-left"===t||"bottom-center"===t||"bottom-right"===t||"top-left"===e||"top-center"===e||"top-right"===e}get actions(){return this.viewModel.actions}set actions(t){this.viewModel.actions=t}get active(){return this.viewModel.active}get autoCloseEnabled(){return this.viewModel.autoCloseEnabled}set autoCloseEnabled(t){this.viewModel.autoCloseEnabled=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get content(){return this.viewModel.content}set content(t){this.viewModel.content=t}get collapsed(){return this._featuresWidget.collapsed}set collapsed(t){this._featuresWidget.collapsed=t}get collapseEnabled(){return ue(j.getLogger(this),"collapseEnabled",{replacement:"PopupVisibleElements.collapseButton",version:"4.29"}),this.visibleElements.collapseButton}set collapseEnabled(t){ue(j.getLogger(this),"collapseEnabled",{replacement:"PopupVisibleElements.collapseButton",version:"4.29"}),this.visibleElements.collapseButton=t}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||jn}set dockOptions(t){const e={...jn},i=this.viewModel?.view?.breakpoints,s={};i&&(s.width=i.xsmall,s.height=i.xsmall);const n={...e,...t},r={...e.breakpoint,...s},{breakpoint:a}=n;"object"==typeof a?n.breakpoint={...r,...a}:a&&(n.breakpoint=r),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}get featureCount(){return this.viewModel.featureCount}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(t){this.viewModel.featureMenuOpen=t}get features(){return this.viewModel.features}set features(t){this.viewModel.features=t}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(t){this.viewModel.goToOverride=t}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(t){this.viewModel.highlightEnabled=t}get icon(){return"popup"}set icon(t){this._overrideIfSome("icon",t)}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get promises(){return this.viewModel.promises}set promises(t){this.viewModel.promises=t}get selectedFeature(){return this.viewModel.selectedFeature}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(t){this.viewModel.selectedFeatureIndex=t}get selectedFeatureWidget(){return this._featuresWidget.selectedFeatureWidget}get spinnerEnabled(){return ue(j.getLogger(this),"spinnerEnabled",{replacement:"PopupVisibleElements.spinner",version:"4.29"}),this.visibleElements.spinner}set spinnerEnabled(t){ue(j.getLogger(this),"spinnerEnabled",{replacement:"PopupVisibleElements.spinner",version:"4.29"}),this.visibleElements.spinner=t}get title(){return this.viewModel.title}set title(t){this.viewModel.title=t}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(t){this.viewModel.updateLocationEnabled=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}blur(){const{active:t}=this.viewModel;t||j.getLogger(this).warn("Popup can only be blurred when currently active."),this._featuresWidget.blur()}clear(){return this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(t,e){return this.viewModel.fetchFeatures(t,e)}focus(){const{active:t}=this.viewModel;t||j.getLogger(this).warn("Popup can only be focused when currently active."),this._handleFocus()}next(){return this.viewModel.next()}open(t){const e=!!t&&!!t.featureMenuOpen,i={collapsed:!!t&&!!t.collapsed,featureMenuOpen:e};this.set(i),this.viewModel.open(t),t?.shouldFocus&&this._handleFocus(!0)}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(t){return this.viewModel.triggerAction(t)}render(){const{dockEnabled:t,currentAlignment:e,currentDockPosition:i}=this,{active:s,screenLocation:n}=this.viewModel,r=s&&t,a=s&&!t,o=this.selectedFeature?.layer?.title,l=this.selectedFeature?.layer?.id,c={[Ln.alignTopCenter]:"top-center"===e,[Ln.alignBottomCenter]:"bottom-center"===e,[Ln.alignTopLeft]:"top-left"===e,[Ln.alignBottomLeft]:"bottom-left"===e,[Ln.alignTopRight]:"top-right"===e,[Ln.alignBottomRight]:"bottom-right"===e,[Ln.isDocked]:r,[Ln.shadow]:a,[Ln.isDockedTopLeft]:"top-left"===i,[Ln.isDockedTopCenter]:"top-center"===i,[Ln.isDockedTopRight]:"top-right"===i,[Ln.isDockedBottomLeft]:"bottom-left"===i,[Ln.isDockedBottomCenter]:"bottom-center"===i,[Ln.isDockedBottomRight]:"bottom-right"===i};return _("div",{afterCreate:this._positionContainer,afterUpdate:this._positionContainer,bind:this,class:this.classes(Ln.base,c,{[Ln.baseHidden]:!n&&!t}),"data-layer-id":l,"data-layer-title":o,role:"presentation"},s?[this._renderMainContainer(),this._renderPointer()]:null)}_renderPointer(){return this.dockEnabled?null:_("div",{class:Ln.pointer,key:"popup-pointer",role:"presentation"},_("div",{class:this.classes(Ln.pointerDirection,Ln.shadow)}))}_renderMainContainer(){const{dockEnabled:t}=this,e={[Ln.shadow]:t};return _("div",{afterCreate:this._setMainContainerNode,afterUpdate:this._setMainContainerNode,bind:this,class:this.classes(Ln.main,F.widget,e)},this._featuresWidget.render())}_getAnimationDurationMS(){const{_containerNode:t}=this;return t?1e3*parseFloat(window.getComputedStyle(t).animationDuration):Vn}async _handleFocus(t=!1){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const e=this._focusAbortController.signal;t&&await Nt((()=>!0===this.viewModel?.active),{signal:e}),await ft(le(e)),await ft(bt(this._getAnimationDurationMS(),e)),this._featuresWidget.focus()}_isOutsideView(t){const{popupHeight:e,popupWidth:i,screenLocation:s,side:n,view:r}=t;if(isNaN(i)||isNaN(e)||!r||!s)return!1;const a=r.padding;return"right"===n&&s.x+i/2>r.width-a.right||("left"===n&&s.x-i/2<a.left||("top"===n&&s.y-e<a.top||"bottom"===n&&s.y+e>r.height-a.bottom))}_calculateAutoAlignment(t){if("auto"!==t)return t;const{_pointerOffsetInPx:e,_containerNode:i,_mainContainerNode:s,viewModel:n}=this,{screenLocation:r,view:a}=n;if(null==r||!a||!i)return"top-center";function o(t){return parseInt(t.replaceAll(/[^-\d.]/g,""),10)}const l=s?window.getComputedStyle(s,null):null,c=l?o(l.getPropertyValue("max-height")):0,h=l?o(l.getPropertyValue("height")):0,{height:u,width:d}=i.getBoundingClientRect(),p=d+e,m=Math.max(u,c,h)+e,f=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"right",view:a}),g=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"left",view:a}),v=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"top",view:a}),y=this._isOutsideView({popupHeight:m,popupWidth:p,screenLocation:r,side:"bottom",view:a});return g?v?"bottom-right":"top-right":f?v?"bottom-left":"top-left":v?y?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(t){return"function"==typeof t?t.call(this):t}_getCurrentAlignment(){const{alignment:t,dockEnabled:e}=this;return e||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(t)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(t){const e=["left","right"];return $(this.container)&&e.reverse(),t?.replace(/leading/gi,e[0]).replaceAll(/trailing/gi,e[1])}_callDockPosition(t){return"function"==typeof t?t.call(this):t}_getDockPosition(){return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(this.dockOptions?.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_calculateAutoDockPosition(t){if("auto"!==t)return t;const e=this.viewModel?.view,i=$(this.container)?"top-left":"top-right";if(!e)return i;const s=e.padding||{left:0,right:0,top:0,bottom:0},n=e.width-s.left-s.right,{breakpoints:r}=e;return r&&n<=r.xsmall?"bottom-center":i}_getDockIcon(){const t=this._getDockPosition();if(this.dockEnabled)return"minimize";switch(t){case"top-left":case"bottom-left":return"dock-left";case"top-center":return"maximize";case"bottom-center":return"dock-bottom";default:return"dock-right"}}_handleDockIcon(){this._dockAction.icon=this._getDockIcon()}_handleDockEnabled(){this._dockAction.title=this.dockEnabled?this.messages?.undock:this.messages?.dock}_setMainContainerNode(t){this._mainContainerNode=t}_positionContainer(t=this._containerNode){if(t&&(this._containerNode=t),!this._containerNode)return;const{screenLocation:e}=this.viewModel,{width:i}=this._containerNode.getBoundingClientRect(),s=this._calculatePositionStyle(e,i);s&&Object.assign(this._containerNode.style,s)}_calculateFullWidth(t){const{currentAlignment:e,_pointerOffsetInPx:i}=this;return"top-left"===e||"bottom-left"===e||"top-right"===e||"bottom-right"===e?t+i:t}_calculateAlignmentPosition(t,e,i,s){const{currentAlignment:n,_pointerOffsetInPx:r}=this;if(!i)return;const{padding:a}=i,o=s/2,l=i.height-e,c=i.width-t;return"bottom-center"===n?{top:e+r-a.top,left:t-o-a.left}:"top-left"===n?{bottom:l+r-a.bottom,right:c+r-a.right}:"bottom-left"===n?{top:e+r-a.top,right:c+r-a.right}:"top-right"===n?{bottom:l+r-a.bottom,left:t+r-a.left}:"bottom-right"===n?{top:e+r-a.top,left:t+r-a.left}:"top-center"===n?{bottom:l+r-a.bottom,left:t-o-a.left}:void 0}_calculatePositionStyle(t,e){const{dockEnabled:i,view:s}=this;if(!s)return;if(i)return{left:"",top:"",right:"",bottom:""};if(null==t||!e)return;const n=this._calculateFullWidth(e),r=this._calculateAlignmentPosition(t.x,t.y,s,n);return r?{top:void 0!==r.top?`${r.top}px`:"auto",left:void 0!==r.left?`${r.left}px`:"auto",bottom:void 0!==r.bottom?`${r.bottom}px`:"auto",right:void 0!==r.right?`${r.right}px`:"auto"}:void 0}_viewChange(t,e){t&&e&&(this.close(),this.clear())}_viewReadyChange(t,e){t?this._wireUpView():e&&(this.close(),this.clear())}_wireUpView(){this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(t,e,i){const[s,n]=t,[r,a]=e,{width:o=0,height:l=0}=i??{};return s<=o&&r>o||s>o&&r<=o||n<=l&&a>l||n>l&&a<=l}_updateDockEnabledForViewSize(t,e){if(!t||!e)return;const i=this.viewModel?.view?.padding||{left:0,right:0,top:0,bottom:0},s=i.left+i.right,n=i.top+i.bottom,r=[],a=[];r[0]=t[0]-s,r[1]=t[1]-n,a[0]=e[0]-s,a[1]=e[1]-n;const{dockOptions:o}=this,l=o.breakpoint;this._dockingThresholdCrossed(r,a,l)&&this._setDockEnabledForViewSize(o),this._setCurrentDockPosition()}_toggleScreenLocationEnabled(){const{dockEnabled:t,viewModel:e}=this;if(!e)return;const i=e.active&&!t;e.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(t){const e=t.breakpoint,i=this.viewModel?.view?.ui;if(!i)return!1;const{width:s,height:n}=i;if(isNaN(s)||isNaN(n))return!1;if(!e)return!1;const r=e.hasOwnProperty("width")&&s<=(e.width??0),a=e.hasOwnProperty("height")&&n<=(e.height??0);return r||a}_setDockEnabledForViewSize(t){t.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(t))}};a([o({readOnly:!0})],Sn.prototype,"_featureNavigationTop",null),a([o()],Sn.prototype,"actions",null),a([o({readOnly:!0})],Sn.prototype,"active",null),a([o()],Sn.prototype,"alignment",void 0),a([o()],Sn.prototype,"autoCloseEnabled",null),a([o()],Sn.prototype,"defaultPopupTemplateEnabled",null),a([o()],Sn.prototype,"content",null),a([o()],Sn.prototype,"collapsed",null),a([o()],Sn.prototype,"collapseEnabled",null),a([o({readOnly:!0})],Sn.prototype,"currentAlignment",null),a([o({readOnly:!0})],Sn.prototype,"currentDockPosition",null),a([o()],Sn.prototype,"dockOptions",null),a([o()],Sn.prototype,"dockEnabled",void 0),a([o({readOnly:!0})],Sn.prototype,"featureCount",null),a([o()],Sn.prototype,"featureMenuOpen",null),a([o()],Sn.prototype,"features",null),a([o()],Sn.prototype,"goToOverride",null),a([o()],Sn.prototype,"headingLevel",void 0),a([o()],Sn.prototype,"highlightEnabled",null),a([o()],Sn.prototype,"icon",null),a([o()],Sn.prototype,"location",null),a([o()],Sn.prototype,"label",null),a([o(),v("esri/widgets/Popup/t9n/Popup")],Sn.prototype,"messages",void 0),a([o()],Sn.prototype,"promises",null),a([o({readOnly:!0})],Sn.prototype,"selectedFeature",null),a([o()],Sn.prototype,"selectedFeatureIndex",null),a([o({readOnly:!0})],Sn.prototype,"selectedFeatureWidget",null),a([o()],Sn.prototype,"spinnerEnabled",null),a([o()],Sn.prototype,"title",null),a([o()],Sn.prototype,"updateLocationEnabled",null),a([o()],Sn.prototype,"view",null),a([o({type:On}),he(["triggerAction","trigger-action"])],Sn.prototype,"viewModel",void 0),a([o()],Sn.prototype,"visible",null),a([o({type:Rn,nonNullable:!0})],Sn.prototype,"visibleElements",void 0),Sn=a([h("esri.widgets.Popup")],Sn);const Dn=Sn;export default Dn;
//# sourceMappingURL=p-e03db14b.js.map