import{dq as t,eF as e,dC as s,r,q as i}from"./p-aad64c9f.js";import{S as n}from"./p-2527295a.js";import{r as a,a as h}from"./p-682c165c.js";import{i as c}from"./p-d6556377.js";class o extends a{constructor(t,e,s,r,i,a,h=null){super(t,e,s,r,i,a),this.bitmap=new n(h),this.bitmap.coordScale=[i,a],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(t){this.bitmap.beforeRender(t),super.beforeRender(t)}afterRender(t){this.bitmap.afterRender(t),super.afterRender(t)}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}_createTransforms(){return{displayViewScreenMat3:t(),tileMat3:t()}}setTransform(t){super.setTransform(t),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}}class u extends c{get requiresDedicatedFBO(){return this.children.some((t=>"additive"===t.bitmap.blendFunction))}createTile(t){const s=this.tileInfoView.getTileBounds(e(),t),r=this.tileInfoView.getTileResolution(t.level),[i,n]=this.tileInfoView.tileInfo.size;return new o(t,r,s[0],s[3],i,n)}prepareRenderPasses(t){const e=t.registerRenderPass({name:"bitmap (tile)",brushes:[h.bitmap],target:()=>this.children.map((t=>t.bitmap)),drawPhase:s.MAP});return[...super.prepareRenderPasses(t),e]}doRender(t){this.visible&&t.drawPhase===s.MAP&&super.doRender(t)}}const d=t=>{let e=class extends t{attach(){this.view.timeline.record(`${this.layer.title} (BitmapTileLayer) Attach`),this._bitmapView=new u(this._tileInfoView),this.container.addChild(this._bitmapView)}detach(){this.container.removeChild(this._bitmapView),this._bitmapView?.removeAllChildren(),this._bitmapView=null}};return e=r([i("esri.views.2d.layers.BitmapTileLayerView2D")],e),e};function l(t){return t instanceof HTMLImageElement?t.naturalWidth:t.width}function p(t){return t instanceof HTMLImageElement?t.naturalHeight:t.height}function m(t,e,s,r){if(s.level===r.level)return e;const i=t.tileInfo.size,n=t.getTileResolution(s.level),a=t.getTileResolution(r.level);let h=t.getLODInfoAt(r.level);const c=h.getXForColumn(r.col),o=h.getYForRow(r.row);h=t.getLODInfoAt(s.level);const u=h.getXForColumn(s.col),d=h.getYForRow(s.row),m=l(e)/i[0],M=p(e)/i[1],w=Math.round(m*((c-u)/n)),R=Math.round(M*(-(o-d)/n)),T=Math.round(m*i[0]*(a/n)),y=Math.round(M*i[1]*(a/n)),g=f(i);return g.getContext("2d").drawImage(e,w,R,T,y,0,0,i[0],i[1]),g}function f(t){const e=document.createElement("canvas");return[e.width,e.height]=t,e}export{m as n,f as o,d as r};
//# sourceMappingURL=p-260ceb60.js.map