import{kz as t,hP as s,a3 as e,aZ as i,mi as n,a7 as r,cE as h,d$ as o,mj as a,kf as c,eH as u,eF as l,r as f,p as d,q as p,ac as y,mk as g,ml as m,mm as w,dZ as b,c as v,iM as _,er as S,P as F,n as I,H as C,X as j,E,mn as O,jM as T,l1 as M,mo as x,mp as R,jN as P,mq as $,mr as z,l4 as N,bC as k,av as A,T as D,kO as q,w as H,he as Z,g as J}from"./p-aad64c9f.js";import{m as U}from"./p-339b5e24.js";import{V as B}from"./p-02236077.js";import{i as G,c as V,g as Q}from"./p-875cbb57.js";import{a as L}from"./p-4e60756f.js";import{x as W,f as X,c as K,S as Y}from"./p-1062e8df.js";import{o as tt}from"./p-56b85bad.js";import"./p-2af77f97.js";import"./p-1c285990.js";import"./p-aff89b86.js";import"./p-e3657bc3.js";import"./p-bac7b09c.js";import"./p-e2849960.js";import"./p-da522976.js";import"./p-cea3971b.js";import"./p-4295487d.js";import"./p-1317d6d9.js";import"./p-bdd45e95.js";import"./p-ca379176.js";import"./p-85c76b3c.js";import"./p-d492d39b.js";import"./p-21ce5524.js";import"./p-5ae33da2.js";function st(t=!1,s){if(t){const{elevationInfo:t,alignPointsInFeatures:e}=s;return new nt(t,e)}return new et}class et{async alignCandidates(t,s,e){return t}notifyElevationSourceChange(){}}const it=1024;class nt{constructor(s,e){this._elevationInfo=s,this._alignPointsInFeatures=e,this._alignmentsCache=new t(it),this._cacheVersion=0}async alignCandidates(t,s,e){const i=this._elevationInfo;return null==i||"absolute-height"!==i.mode||i.featureExpressionInfo?this._alignComputedElevationCandidates(t,s,e):(ot(t,s,i),t)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(t,i,n){const r=new Map;for(const e of t)s(r,e.objectId,at).push(e);const[h,o,a]=this._prepareQuery(r,i),c=await this._alignPointsInFeatures(h,n);e(n);if(a!==this._cacheVersion)return this._alignComputedElevationCandidates(t,i,n);this._applyCacheAndResponse(h,c,o);const{drapedObjectIds:u,failedObjectIds:l}=c,f=[];for(const s of t){const{objectId:t}=s;u.has(t)&&"edge"===s.type&&(s.draped=!0),l.has(t)||f.push(s)}return f}_prepareQuery(t,s){const e=[],i=[];for(const[s,n]of t){const t=[];for(const e of n)this._addToQueriesOrCachedResult(s,e.target,t,i),"edge"===e.type&&(this._addToQueriesOrCachedResult(s,e.start,t,i),this._addToQueriesOrCachedResult(s,e.end,t,i));0!==t.length&&e.push({objectId:s,points:t})}return[{spatialReference:s.toJSON(),pointsInFeatures:e},i,this._cacheVersion]}_addToQueriesOrCachedResult(t,s,e,i){const n=ht(t,s),r=this._alignmentsCache.get(n);null==r?e.push(s):i.push(new rt(s,r))}_applyCacheAndResponse(t,{elevations:s,drapedObjectIds:e,failedObjectIds:i},n){for(const t of n)t.apply();let r=0;const h=this._alignmentsCache;for(const{objectId:n,points:o}of t.pointsInFeatures){if(i.has(n)){r+=o.length;continue}const t=!e.has(n);for(const e of o){const i=ht(n,e),o=s[r++];e.z=o,t&&h.put(i,o,1)}}}}class rt{constructor(t,s){this.point=t,this.z=s}apply(){this.point.z=this.z}}function ht(t,{x:s,y:e,z:i,spatialReference:n}){return`${t}-${s}-${e}-${i??0}}-wkid:${n?.wkid}`}function ot(t,s,e){const{offset:r,unit:h}=e;if(null==r)return;const o=i(s),a=r*(n(h??"meters")/o);for(const s of t)switch(s.type){case"edge":s.start.z+=a,s.end.z+=a;continue;case"vertex":s.target.z+=a;continue}}function at(){return[]}class ct{filter(t,s){return s}notifyElevationSourceChange(){}}class ut{filter(t,s){const{point:e,distance:i}=t,{z:n}=e;if(!(null!=n))return s;if(0===s.length)return s;const r=gt(i),h=this._updateCandidatesTo3D(s,e,r).filter(lt);return h.sort(mt),h}_updateCandidatesTo3D(t,s,e){for(const i of t)switch(i.type){case"edge":dt(i,s,e);continue;case"vertex":yt(i,s,e);continue}return t}}function lt(t){return t.distance<=1}function ft(t=!1){return t?new ut:new ct}function dt(t,s,{x:e,y:i,z:n}){const{start:r,end:h,target:o}=t;t.draped||pt(o,s,r,h);const a=(s.x-o.x)/e,c=(s.y-o.y)/i,u=(s.z-o.z)/n;t.distance=Math.sqrt(a*a+c*c+u*u)}function pt(t,s,e,i){const n=i.x-e.x,r=i.y-e.y,h=i.z-e.z,o=n*n+r*r+h*h,a=(s.x-e.x)*n+(s.y-e.y)*r+h*(s.z-e.z),c=Math.min(1,Math.max(0,a/o)),u=e.x+n*c,l=e.y+r*c,f=e.z+h*c;t.x=u,t.y=l,t.z=f}function yt(t,s,{x:e,y:i,z:n}){const{target:r}=t,h=(s.x-r.x)/e,o=(s.y-r.y)/i,a=(s.z-r.z)/n,c=Math.sqrt(h*h+o*o+a*a);t.distance=c}function gt(t){return"number"==typeof t?{x:t,y:t,z:t}:t}function mt(t,s){return t.distance-s.distance}function wt(t=!1,s){return t?new _t(s):new bt}class bt{async fetch(){return[]}notifySymbologyChange(){}}const vt=1024;class _t{constructor(s){this._getSymbologyCandidates=s,this._candidatesCache=new t(vt),this._cacheVersion=0}async fetch(t,s){if(0===t.length)return[];const i=[],n=[],h=this._candidatesCache;for(const s of t){const t=St(s),e=h.get(t);if(e)for(const t of e)n.push(r(t));else i.push(s),h.put(t,[],1)}if(0===i.length)return n;const o=this._cacheVersion,{candidates:a,sourceCandidateIndices:c}=await this._getSymbologyCandidates(i,s);e(s);if(o!==this._cacheVersion)return this.fetch(t,s);const u=[],{length:l}=a;for(let t=0;t<l;++t){const s=a[t],e=St(i[c[t]]),n=h.get(e);n.push(s),h.put(e,n,n.length),u.push(r(s))}return n.concat(u)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function St(t){switch(t.type){case"vertex":{const{objectId:s,target:e}=t,i=`${s}-vertex-${e.x}-${e.y}-${e.z??0}`;return h(i).toString()}case"edge":{const{objectId:s,start:e,end:i}=t,n=`${s}-edge-${e.x}-${e.y}-${e.z??0}-to-${i.x}-${i.y}-${i.z??0}`;return h(n).toString()}default:return""}}class Ft{constructor(t,s){this.data=t,this.resolution=s,this.state={type:jt.CREATED},this.alive=!0}process(t){switch(this.state.type){case jt.CREATED:return this.state=this._gotoFetchCount(this.state,t),this.state.task.promise.then(t.resume,t.resume);case jt.FETCH_COUNT:break;case jt.FETCHED_COUNT:return this.state=this._gotoFetchFeatures(this.state,t),this.state.task.promise.then(t.resume,t.resume);case jt.FETCH_FEATURES:break;case jt.FETCHED_FEATURES:this.state=this._goToDone(this.state,t)}return null}get debugInfo(){return{data:this.data,featureCount:this._featureCount,state:this._stateToString}}get _featureCount(){switch(this.state.type){case jt.CREATED:case jt.FETCH_COUNT:return 0;case jt.FETCHED_COUNT:return this.state.featureCount;case jt.FETCH_FEATURES:return this.state.previous.featureCount;case jt.FETCHED_FEATURES:return this.state.features.length;case jt.DONE:return this.state.previous.features.length}}get _stateToString(){switch(this.state.type){case jt.CREATED:return"created";case jt.FETCH_COUNT:return"fetch-count";case jt.FETCHED_COUNT:return"fetched-count";case jt.FETCH_FEATURES:return"fetch-features";case jt.FETCHED_FEATURES:return"fetched-features";case jt.DONE:return"done"}}_gotoFetchCount(t,s){return{type:jt.FETCH_COUNT,previous:t,task:o((async t=>{const e=await a(s.fetchCount(this,t));this.state.type===jt.FETCH_COUNT&&(this.state=It(this.state,e.ok?e.value:1/0))}))}}_gotoFetchFeatures(t,s){return{type:jt.FETCH_FEATURES,previous:t,task:o((async e=>{const i=await a(s.fetchFeatures(this,t.featureCount,e));this.state.type===jt.FETCH_FEATURES&&(this.state=Ct(this.state,i.ok?i.value:[]))}))}}_goToDone(t,s){return s.finish(this,t.features),{type:jt.DONE,previous:t}}reset(){const t=this.state;switch(this.state={type:jt.CREATED},t.type){case jt.CREATED:case jt.FETCHED_COUNT:case jt.FETCHED_FEATURES:case jt.DONE:break;case jt.FETCH_COUNT:case jt.FETCH_FEATURES:t.task.abort()}}intersects(t){return null==t||!this.data.extent||(c(t,Et),u(this.data.extent,Et))}}function It(t,s){return{type:jt.FETCHED_COUNT,featureCount:s,previous:t}}function Ct(t,s){return{type:jt.FETCHED_FEATURES,previous:t,features:s}}var jt;!function(t){t[t.CREATED=0]="CREATED",t[t.FETCH_COUNT=1]="FETCH_COUNT",t[t.FETCHED_COUNT=2]="FETCHED_COUNT",t[t.FETCH_FEATURES=3]="FETCH_FEATURES",t[t.FETCHED_FEATURES=4]="FETCHED_FEATURES",t[t.DONE=5]="DONE"}(jt||(jt={}));const Et=l();let Ot=class extends y{get _minimumVerticesPerFeature(){switch(this.store?.featureStore.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":return 1;case"esriGeometryPolygon":return 4;case"esriGeometryPolyline":return 2}}get _mandatoryOutFields(){const t=new Set;return this.objectIdField&&t.add(this.objectIdField),this.globalIdField&&t.add(this.globalIdField),t}set outFields(t){const s=this._get("outFields"),e=g(t,this._mandatoryOutFields);m(e,s)||(this._set("outFields",e),w(e,s)||this.refresh())}get outFields(){return this._get("outFields")??this._mandatoryOutFields}set filter(t){const s=this._get("filter"),e=this._filterProperties(t);JSON.stringify(s)!==JSON.stringify(e)&&this._set("filter",e)}set customParameters(t){const s=this._get("customParameters");JSON.stringify(s)!==JSON.stringify(t)&&this._set("customParameters",t)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(t){const s=this._get("tileInfo");s!==t&&(null!=t&&null!=s&&JSON.stringify(t)===JSON.stringify(s)||(this._set("tileInfo",t),this.store.tileInfo=t))}set tileSize(t){this._get("tileSize")!==t&&this._set("tileSize",t)}get updating(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(t){super(t),this.suspended=!0,this._historicMoment=null,this.tilesOfInterest=[],this.availability=0,this._pendingTiles=new Map,this._updatingHandles=new b}initialize(){this._initializeFetchExtent(),this._updatingHandles.add((()=>this._configuration),(()=>this.refresh())),this._updatingHandles.add((()=>this.tilesOfInterest),((t,s)=>{v(t,s,(({id:t},{id:s})=>t===s))||this._process()}),_),this.addHandles(S((()=>!this.suspended),(()=>this._process())))}destroy(){this._pendingTiles.forEach((t=>this._deletePendingTile(t))),this._pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this._updatingHandles.destroy()}refresh(){this.store.refresh(),this._pendingTiles.forEach((t=>this._deletePendingTile(t))),this._process()}async handleEdits(t){if(t.historicMoment&&(this._historicMoment=t.historicMoment),!t.addedFeatures.length&&!t.updatedFeatures.length&&!t.deletedFeatures.length)return;for(const t of this._pendingTiles.values())t.reset();const s={...t,deletedFeatures:t.deletedFeatures.map((({objectId:t,globalId:s})=>t&&-1!==t?t:this._lookupObjectIdByGlobalId(s)))},e=o((async t=>{try{await this.store.processEdits(s,((t,s)=>this._queryFeaturesById(t,s)),t),this._processPendingTiles()}catch(t){F(t),I.getLogger(this).warn("Failed to apply edits",t)}}));this.addHandles(e),await this._updatingHandles.addPromise(e.promise)}setHistoricMoment(t){t?.getTime()!==this._historicMoment?.getTime()&&(this._historicMoment=t,this.refresh())}_initializeFetchExtent(){if(!this.capabilities.query.supportsExtent||!C(this.url))return;const t=o((async t=>{try{const s=await W(this.url,new j({where:"1=1",outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint??void 0}),{query:this._configuration.customParameters,signal:t});this.store.extent=E.fromJSON(s.data?.extent)}catch(t){F(t),I.getLogger(this).warn("Failed to fetch data extent",t)}}));this._updatingHandles.addPromise(t.promise.then((()=>this._process()))),this.addHandles(t)}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map((t=>t.debugInfo)),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(const t of this._pendingTiles.values())t.alive=!1}_createPendingTiles(){if(this.suspended)return;const t=this._collectMissingTilesInfo();if(this._setAvailability(null==t?1:t.coveredArea/t.fullArea),null!=t)for(const{data:s,resolution:e}of t.missingTiles){const t=this._pendingTiles.get(s.id);t?(t.resolution=e,t.alive=!0):this._createPendingTile(s,e)}}_collectMissingTilesInfo(){let t=null;for(let s=this.tilesOfInterest.length-1;s>=0;s--){const e=this.tilesOfInterest[s],i=this.store.process(e,((t,s)=>this._verifyTileComplexity(t,s)),this.outFields);null==t?t=i:t.prepend(i)}return t}_deletePendingTiles(){for(const t of this._pendingTiles.values())t.alive||this._deletePendingTile(t)}_processPendingTiles(){const t={fetchCount:(t,s)=>this._fetchCount(t,s),fetchFeatures:(t,s,e)=>this._fetchFeatures(t,s,e),finish:(t,s)=>this._finishPendingTile(t,s),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(t))for(const s of this._pendingTiles.values())this._verifyTileComplexity(this.store.getFeatureCount(s.data),s.resolution)&&this._updatingHandles.addPromise(s.process(t))}_verifyTileComplexity(t,s){return this._verifyVertexComplexity(t)&&this._verifyFeatureDensity(t,s)}_verifyVertexComplexity(t){return t*this._minimumVerticesPerFeature<xt}_verifyFeatureDensity(t,s){if(null==this.tileInfo)return!1;const e=this.tileSize*s;return t*(Rt/(e*e))<Pt}_ensureFetchAllCounts(t){let s=!0;for(const e of this._pendingTiles.values())e.state.type<jt.FETCHED_COUNT&&this._updatingHandles.addPromise(e.process(t)),e.state.type<=jt.FETCH_COUNT&&(s=!1);return s}_finishPendingTile(t,s){this.store.add(t.data,s),this._deletePendingTile(t),this._updateAvailability()}_updateAvailability(){const t=this._collectMissingTilesInfo();this._setAvailability(null==t?1:t.coveredArea/t.fullArea)}_setAvailability(t){this._set("availability",t)}_createPendingTile(t,s){const e=new Ft(t,s);return this._pendingTiles.set(t.id,e),e}_deletePendingTile(t){t.reset(),this._pendingTiles.delete(t.data.id)}async _fetchCount(t,s){return this.store.fetchCount(t.data,this.url,this._createCountQuery(t),{query:this.customParameters,timeout:Mt,signal:s})}async _fetchFeatures(t,s,e){let i=0;const n=[];let r=0,h=s;for(;;){const o=this._createFeaturesQuery(t),a=this._setPagingParameters(o,i,h),{features:c,exceededTransferLimit:u}=await this._queryFeatures(o,e);a&&(i+=o.num),r+=c.length;for(const t of c)n.push(t);if(h=s-r,!a||!u||h<=0)return n}}_filterProperties(t){return null==t?{where:"1=1",gdbVersion:void 0,timeExtent:void 0}:{where:t.where||"1=1",timeExtent:t.timeExtent,gdbVersion:t.gdbVersion}}_lookupObjectIdByGlobalId(t){const s=this.globalIdField,e=this.objectIdField;if(null==s)throw new Error("Expected globalIdField to be defined");let i=null;if(this.store.featureStore.forEach((n=>{t===n.attributes[s]&&(i=n.objectId??n.attributes[e])})),null==i)throw new Error(`Expected to find a feature with globalId ${t}`);return i}_queryFeaturesById(t,s){const e=this._createFeaturesQuery();return e.objectIds=t,this._queryFeatures(e,s)}_queryFeatures(t,s){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(t,s):this._queryFeaturesJSON(t,s)}async _queryFeaturesPBF(t,s){const{sourceSpatialReference:e}=this,{data:i}=await X(this.url,t,new L({sourceSpatialReference:e}),{query:this._configuration.customParameters,timeout:Mt,signal:s});return G(i)}async _queryFeaturesJSON(t,s){const{sourceSpatialReference:e}=this,{data:i}=await K(this.url,t,e,{query:this._configuration.customParameters,timeout:Mt,signal:s});return V(i,this.objectIdField)}_createCountQuery(t){const s=this._createBaseQuery(t);return this.capabilities.query.supportsCacheHint&&(s.cacheHint=!0),s}_createFeaturesQuery(t=null){const s=this._createBaseQuery(t),e=null!=t?.data?this.store.getAttributesForTile(t?.data?.id):null,i=g(O(this.outFields,e??new Set),this._mandatoryOutFields);return s.outFields=Array.from(i),s.returnGeometry=!0,null!=t&&(this.capabilities.query.supportsResultType?s.resultType="tile":this.capabilities.query.supportsCacheHint&&(s.cacheHint=!0)),s}_createBaseQuery(t){const s=new j({returnZ:this.hasZ,returnM:!1,historicMoment:this._historicMoment,geometry:null!=this.tileInfo&&null!=t?T(t.data.extent,this.tileInfo.spatialReference):void 0}),e=this._configuration.filter;return null!=e&&(s.where=e.where,s.gdbVersion=e.gdbVersion,s.timeExtent=e.timeExtent),s.outSpatialReference=this.spatialReference,s}_setPagingParameters(t,s,e){if(!this.capabilities.query.supportsPagination)return!1;const{supportsMaxRecordCountFactor:i,supportsCacheHint:n,tileMaxRecordCount:r,maxRecordCount:h,supportsResultType:o}=this.capabilities.query,a=i?j.MAX_MAX_RECORD_COUNT_FACTOR:1,c=a*((o||n)&&r?r:h||Tt);return t.start=s,i?(t.maxRecordCountFactor=Math.min(a,Math.ceil(e/c)),t.num=Math.min(e,t.maxRecordCountFactor*c)):t.num=Math.min(e,c),!0}};f([d({constructOnly:!0})],Ot.prototype,"url",void 0),f([d({constructOnly:!0})],Ot.prototype,"objectIdField",void 0),f([d({constructOnly:!0})],Ot.prototype,"globalIdField",void 0),f([d({constructOnly:!0})],Ot.prototype,"capabilities",void 0),f([d({constructOnly:!0})],Ot.prototype,"sourceSpatialReference",void 0),f([d({constructOnly:!0})],Ot.prototype,"spatialReference",void 0),f([d({constructOnly:!0})],Ot.prototype,"store",void 0),f([d({readOnly:!0})],Ot.prototype,"_minimumVerticesPerFeature",null),f([d()],Ot.prototype,"_mandatoryOutFields",null),f([d()],Ot.prototype,"outFields",null),f([d()],Ot.prototype,"suspended",void 0),f([d()],Ot.prototype,"_historicMoment",void 0),f([d()],Ot.prototype,"filter",null),f([d()],Ot.prototype,"customParameters",null),f([d({readOnly:!0})],Ot.prototype,"_configuration",null),f([d()],Ot.prototype,"tileInfo",null),f([d()],Ot.prototype,"tileSize",null),f([d()],Ot.prototype,"tilesOfInterest",void 0),f([d({readOnly:!0})],Ot.prototype,"updating",null),f([d({readOnly:!0})],Ot.prototype,"availability",void 0),f([d()],Ot.prototype,"hasZ",null),Ot=f([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],Ot);const Tt=2e3,Mt=6e5,xt=1e6,Rt=25,Pt=1;class $t{constructor(){this._store=new Map,this._byteSize=0}set(t,s){this.delete(t),this._store.set(t,s),this._byteSize+=s.byteSize}delete(t){const s=this._store.get(t);return!!this._store.delete(t)&&(null!=s&&(this._byteSize-=s.byteSize),!0)}get(t){return this._used(t),this._store.get(t)}has(t){return this._used(t),this._store.has(t)}clear(){this._store.clear()}applyByteSizeLimit(t,s){for(const[e,i]of this._store){if(this._byteSize<=t)break;this.delete(e),s(i)}}values(){return this._store.values()}[Symbol.iterator](){return this._store[Symbol.iterator]()}_used(t){const s=this._store.get(t);s&&(this._store.delete(t),this._store.set(t,s))}}let zt=class extends y{constructor(t){super(t),this.tileInfo=null,this.extent=null,this.maximumByteSize=10*M.MEGABYTES,this._tileBounds=new tt,this._tiles=new $t,this._refCounts=new Map,this._tileFeatureCounts=new Map,this._tmpBoundingRect=l()}add(t,s){for(const t of s)this._referenceFeature(t.objectId);const e=this.featureStore.upsertMany(s),i=e.map((t=>new Set(Object.keys(t.attributes)))).reduce(((t,s)=>x(t,s)),new Set(Object.keys(e[0]?.attributes??[])));this._addTileStorage(t,new Set(e.map((t=>t.objectId))),kt(e),i),this._tiles.applyByteSizeLimit(this.maximumByteSize,(t=>this._removeTileStorage(t)))}getAttributesForTile(t){return t?this._tiles.get(t)?.attributeKeys:null}destroy(){this.clear(),this._tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this._tileBounds.clear(),this._tiles.clear(),this._refCounts.clear()}refresh(){this.clear(),this._tileFeatureCounts.clear()}processEdits(t,s,e){return this._processEditsDelete(t.deletedFeatures.concat(t.updatedFeatures)),this._processEditsRefetch(t.addedFeatures.concat(t.updatedFeatures),s,e)}_addTileStorage(t,s,e,i){const n=t.id;this._tiles.set(n,new qt(t,s,e,i)),this._tileBounds.set(n,t.extent),this._tileFeatureCounts.set(n,s.size)}_remove({id:t}){const s=this._tiles.get(t);s&&this._removeTileStorage(s)}_removeTileStorage(t){const s=[];for(const e of t.objectIds)this._unreferenceFeature(e)===Bt.REMOVED&&s.push(e);this.featureStore.removeManyById(s);const e=t.data.id;this._tiles.delete(e),this._tileBounds.delete(e)}_processEditsDelete(t){this.featureStore.removeManyById(t);for(const s of this._tiles.values()){for(const e of t)s.objectIds.delete(e);this._tileFeatureCounts.set(s.data.id,s.objectIds.size)}for(const s of t)this._refCounts.delete(s)}async _processEditsRefetch(t,s,e){if(!t.length)return;const i=(await s(t,e)).features,{hasZ:n,hasM:r}=this.featureStore;for(const t of i){const s=Q(this._tmpBoundingRect,t.geometry,n,r);null!=s&&this._tileBounds.forEachInBounds(s,(s=>{const e=this._tiles.get(s);this.featureStore.add(t);const i=t.objectId;e.objectIds.has(i)||(e.objectIds.add(i),this._referenceFeature(i),this._tileFeatureCounts.set(e.data.id,e.objectIds.size))}))}}process(t,s=(()=>!0),e){if(null==this.tileInfo||!t.extent||null!=this.extent&&!u(c(this.extent,this._tmpBoundingRect),t.extent))return new Zt(t);const i=this.getAttributesForTile(t.id);if(w(e,i))return new Zt(t);const n=this._createTileTree(t,this.tileInfo);return this._simplify(n,s,null,0,1),this._collectMissingTiles(t,n,this.tileInfo,e)}get debugInfo(){return Array.from(this._tiles.values()).map((({data:t})=>({data:t,featureCount:this._tileFeatureCounts.get(t.id)||0})))}getFeatureCount(t){return this._tileFeatureCounts.get(t.id)??0}async fetchCount(t,s,e,i){const n=this._tileFeatureCounts.get(t.id);if(null!=n)return n;const r=await Y(s,e,i);return this._tileFeatureCounts.set(t.id,r.data.count),r.data.count}_createTileTree(t,s){const e=new Ht(t.level,t.row,t.col);return s.updateTileInfo(e,P.ExtrapolateOptions.POWER_OF_TWO),this._tileBounds.forEachInBounds(t.extent,(i=>{const n=this._tiles.get(i)?.data;n&&Nt(t,n)&&this._populateChildren(e,n,s,this._tileFeatureCounts.get(n.id)||0)})),e}_populateChildren(t,s,e,i){const n=s.level-t.level-1;if(n<0)return void(t.isLeaf=!0);const r=s.row>>n,h=s.col>>n,o=t.row<<1,a=h-(t.col<<1)+(r-o<<1),c=t.children[a];if(null!=c)this._populateChildren(c,s,e,i);else{const n=new Ht(t.level+1,r,h);e.updateTileInfo(n,P.ExtrapolateOptions.POWER_OF_TWO),t.children[a]=n,this._populateChildren(n,s,e,i)}}_simplify(t,s,e,i,n){const r=n*n;if(t.isLeaf)return s(this.getFeatureCount(t),n)?0:(this._remove(t),null!=e&&(e.children[i]=null),r);const h=n/2,o=h*h;let a=0;for(let e=0;e<t.children.length;e++){const i=t.children[e];a+=null!=i?this._simplify(i,s,t,e,h):o}return 0===a?this._mergeChildren(t):1-a/r<Ut&&(this._purge(t),null!=e&&(e.children[i]=null),a=r),a}_mergeChildren(t){const s=new Set;let e,i=0;this._forEachLeaf(t,(t=>{const n=this._tiles.get(t.id);if(n){e=e?x(e,n.attributeKeys):new Set(n.attributeKeys),i+=n.byteSize;for(const t of n.objectIds)s.has(t)||(s.add(t),this._referenceFeature(t));this._remove(t)}})),this._addTileStorage(t,s,i,e??new Set),t.isLeaf=!0,t.children[0]=t.children[1]=t.children[2]=t.children[3]=null,this._tileFeatureCounts.set(t.id,s.size)}_forEachLeaf(t,s){for(const e of t.children)null!=e&&(e.isLeaf?s(e):this._forEachLeaf(e,s))}_purge(t){if(null!=t)if(t.isLeaf)this._remove(t);else for(let s=0;s<t.children.length;s++){const e=t.children[s];this._purge(e),t.children[s]=null}}_collectMissingTiles(t,s,e,i){const n=new Jt(e,t,this.extent);return this._collectMissingTilesRecurse(s,n,1,i),n.info}_collectMissingTilesRecurse(t,s,e,i){const n=this.getAttributesForTile(t.id),r=n&&!w(i,n);if(r&&s.addMissing(t.level,t.row,t.col,e),t.isLeaf)return;if(!t.hasChildren)return void(r||s.addMissing(t.level,t.row,t.col,e));const h=e/2;for(let e=0;e<t.children.length;e++){const n=t.children[e];null==n?s.addMissing(t.level+1,(t.row<<1)+((2&e)>>1),(t.col<<1)+(1&e),h):this._collectMissingTilesRecurse(n,s,h,i)}}_referenceFeature(t){const s=(this._refCounts.get(t)||0)+1;return this._refCounts.set(t,s),1===s?Bt.ADDED:Bt.UNCHANGED}_unreferenceFeature(t){const s=(this._refCounts.get(t)||0)-1;return 0===s?(this._refCounts.delete(t),Bt.REMOVED):(s>0&&this._refCounts.set(t,s),Bt.UNCHANGED)}get test(){}};function Nt(t,s){if(!t||!s)return!1;if(t.level===s.level)return t.row===s.row&&t.col===s.col;const e=t.level<s.level,i=e?t:s,n=e?s:t,r=1<<n.level-i.level;return Math.floor(n.row/r)===i.row&&Math.floor(n.col/r)===i.col}function kt(t){return t.reduce(((t,s)=>t+At(s)),0)}function At(t){return 32+Dt(t.geometry)+R(t.attributes)}function Dt(t){if(null==t)return 0;const s=$(t.lengths,4);return 32+$(t.coords,8)+s}f([d({constructOnly:!0})],zt.prototype,"featureStore",void 0),f([d()],zt.prototype,"tileInfo",void 0),f([d()],zt.prototype,"extent",void 0),f([d()],zt.prototype,"maximumByteSize",void 0),zt=f([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore")],zt);class qt{constructor(t,s,e,i){this.data=t,this.objectIds=s,this.byteSize=e,this.attributeKeys=i}}class Ht{constructor(t,s,e){this.level=t,this.row=s,this.col=e,this.isLeaf=!1,this.extent=null,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(null!=this.children[0]||null!=this.children[1]||null!=this.children[2]||null!=this.children[3])}}class Zt{constructor(t,s=[]){this.missingTiles=s,this.fullArea=0,this.coveredArea=0,this.fullArea=z(t.extent),this.coveredArea=this.fullArea}prepend(t){this.missingTiles=t.missingTiles.concat(this.missingTiles),this.coveredArea+=t.coveredArea,this.fullArea+=t.fullArea}}class Jt{constructor(t,s,e){this._tileInfo=t,this._extent=null,this.info=new Zt(s),null!=e&&(this._extent=c(e))}addMissing(t,s,e,i){const n=new N(null,t,s,e);this._tileInfo.updateTileInfo(n,P.ExtrapolateOptions.POWER_OF_TWO),null==n.extent||null!=this._extent&&!u(this._extent,n.extent)||(this.info.missingTiles.push({data:n,resolution:i}),this.info.coveredArea-=z(n.extent))}}const Ut=.18751;var Bt;!function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED",t[t.UNCHANGED=2]="UNCHANGED"}(Bt||(Bt={}));let Gt=class extends k.EventedAccessor{constructor(){super(...arguments),this._isInitializing=!0,this.remoteClient=null,this._whenSetup=A(),this._elevationAligner=st(),this._elevationFilter=ft(),this._symbologyCandidatesFetcher=wt(),this._updatingHandles=new b,this._alignPointsInFeatures=async(t,s)=>{const i={query:t},n=await this.remoteClient.invoke("alignElevation",i,{signal:s});return e(s),n},this._getSymbologyCandidates=async(t,s)=>{const i={candidates:t,spatialReference:this._spatialReference.toJSON()},n=await this.remoteClient.invoke("getSymbologyCandidates",i,{signal:s});return e(s),n}}get updating(){return this._isInitializing||this._updatingHandles.updating||this._featureFetcher.updating}destroy(){this._featureFetcher?.destroy(),this._queryEngine?.destroy(),this._featureStore?.clear()}async setup(t){if(this.destroyed)return{result:{}};const{geometryType:s,objectIdField:e,timeInfo:i,fieldsIndex:n}=t.serviceInfo,{hasZ:r}=t,h=D.fromJSON(t.spatialReference);this._spatialReference=h,this._featureStore=new U({...t.serviceInfo,hasZ:r,hasM:!1}),this._queryEngine=new B({spatialReference:t.spatialReference,featureStore:this._featureStore,geometryType:s,fieldsIndex:n,hasZ:r,hasM:!1,objectIdField:e,timeInfo:i}),this._featureFetcher=new Ot({store:new zt({featureStore:this._featureStore}),url:t.serviceInfo.url,objectIdField:t.serviceInfo.objectIdField,globalIdField:t.serviceInfo.globalIdField,capabilities:t.serviceInfo.capabilities,spatialReference:h,sourceSpatialReference:D.fromJSON(t.serviceInfo.spatialReference),customParameters:t.configuration.customParameters});const o="3d"===t.configuration.viewType;return this._elevationAligner=st(o,{elevationInfo:null!=t.elevationInfo?q.fromJSON(t.elevationInfo):null,alignPointsInFeatures:this._alignPointsInFeatures}),this._elevationFilter=ft(o),this.addHandles([H((()=>this._featureFetcher.availability),(t=>this.emit("notify-availability",{availability:t})),_),H((()=>this.updating),(()=>this._notifyUpdating()))]),this._whenSetup.resolve(),this._isInitializing=!1,this.configure(t.configuration)}async configure(t){return await this._updatingHandles.addPromise(this._whenSetup.promise),this._updateFeatureFetcherConfiguration(t),Lt}async setSuspended(t,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),e(s),this._featureFetcher.suspended=t,Lt}async updateOutFields(t,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),e(s),this._featureFetcher.outFields=new Set(t??[]),Lt}async fetchCandidates(t,s){await this._whenSetup.promise,e(s);const i=Qt(t),n=s?.signal,r=await this._queryEngine.executeQueryForSnapping(i,n);e(n);const h=await this._elevationAligner.alignCandidates(r.candidates,D.fromJSON(t.point.spatialReference)??D.WGS84,n);e(n);const o=await this._symbologyCandidatesFetcher.fetch(h,n);e(n);const a=0===o.length?h:h.concat(o);return{result:{candidates:this._elevationFilter.filter(i,a)}}}async updateTiles(t,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),e(s),this._featureFetcher.tileSize=t.tileSize,this._featureFetcher.tilesOfInterest=t.tiles,this._featureFetcher.tileInfo=null!=t.tileInfo?P.fromJSON(t.tileInfo):null,Lt}async refresh(t,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),e(s),this._featureFetcher.refresh(),Lt}async whenNotUpdating(t,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),e(s),await Z((()=>!this.updating),s),e(s),Lt}async getDebugInfo(t,s){return e(s),{result:this._featureFetcher.debugInfo}}async handleEdits(t,s){return await this._updatingHandles.addPromise(this._whenSetup.promise),e(s),await this._updatingHandles.addPromise(this._featureFetcher.handleEdits(t)),e(s),Lt}async setHistoricMoment(t,s){return this._featureFetcher.setHistoricMoment(t.moment),Lt}async notifyElevationSourceChange(t,s){return this._elevationAligner.notifyElevationSourceChange(),Lt}async notifySymbologyChange(t,s){return this._symbologyCandidatesFetcher.notifySymbologyChange(),Lt}async setSymbologySnappingSupported(t){return this._symbologyCandidatesFetcher=wt(t,this._getSymbologyCandidates),Lt}_updateFeatureFetcherConfiguration(t){this._featureFetcher.filter=null!=t.filter?j.fromJSON(t.filter):null,this._featureFetcher.customParameters=t.customParameters}_notifyUpdating(){this.emit("notify-updating",{updating:this.updating})}};f([d({readOnly:!0})],Gt.prototype,"updating",null),f([d()],Gt.prototype,"_isInitializing",void 0),Gt=f([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker")],Gt);const Vt=Gt;function Qt(t){if(!t.filter)return{...t,query:{where:"1=1"}};const{distance:s,units:e,spatialRel:i,where:n,timeExtent:r,objectIds:h}=t.filter,o={geometry:t.filter.geometry?J(t.filter.geometry):void 0,distance:s,units:e,spatialRel:i,timeExtent:r,objectIds:h,where:n??"1=1"};return{...t,query:o}}const Lt={result:{}};export default Vt;
//# sourceMappingURL=p-e0972aae.js.map