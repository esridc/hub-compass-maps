{"version":3,"names":["t","constructor","e","this","_timer","_cachedBlocks","Map","_size","_duration","_interval","Math","min","decreaseRefCount","s","r","has","get","refCount","delete","controller","abort","getBlock","ts","Date","now","set","block","putBlock","i","c","_trim","_updateTimer","deleteBlock","updateMaxSize","empty","clear","_clearTimer","getCurrentSize","size","setInterval","Array","from","length","clearInterval","u","n","extent","rasterInfo","cache","o","push","a","some","l","m","x","isResolved","isRejected","then","catch","h","d","g","f","xmin","xmax","ymin","ymax","clone","normalize","spatialReference","y","transform","p","k","Set","inverseTransform","pyramidLevel","pyramidResolution","excessiveReading","storageInfo","M","origin","R","C","max","floor","B","ceil","j","v","pyramidBlockWidth","blockWidth","b","pyramidBlockHeight","blockHeight","w","$","I","H","E","add","forEach"],"sources":["./node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js","./node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import e from\"./EphemeralBlockCache.js\";import{projectExtent as t,projectResolution as n,snapPyramid as o}from\"../rasterFunctions/rasterProjectionHelper.js\";import l from\"../../../geometry/Point.js\";const r=new Map,c=new e;function i(e,t){return null==t?e:`${e}?sliceId=${t}`}function u(e,t){const n={extent:null,rasterInfo:t,cache:new Map},o=r.get(e);return o?(o.push(n),o.length-1):(r.set(e,[n]),0)}function a(e,t){const n=r.get(e);n&&(n[t]=null,n.some((e=>null!=e))||r.delete(e))}function f(e){r.delete(e)}function s(e,t,n){const o=r.get(e);if(!o)return null==t?c.decreaseRefCount(e,n):0;if(null==t||null==o[t])return c.decreaseRefCount(e,n);const l=o[t]?.cache,i=l?.get(n);if(l&&i){if(i.refCount--,0===i.refCount){l.delete(n);for(let e=0;e<o.length;e++)o[e]?.cache.delete(n);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,t,n){const o=r.get(e);if(!o)return null==t?c.getBlock(e,n):null;if(null==t||null==o[t]){for(let e=0;e<o.length;e++){const t=o[e]?.cache.get(n);if(t)return t.refCount++,t.block}return c.getBlock(e,n)}const l=o[t]?.cache.get(n);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===t||!o[r])continue;const e=o[r]?.cache,l=e?.get(n);if(e&&l)return l.refCount++,e.set(n,l),l.block}return null}function x(e,t,n,o,l=null){const i=r.get(e);if(!i)return void(null==t&&c.putBlock(e,n,o,l));if(null==t||null==i[t])return void c.putBlock(e,n,o,l);const u={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),i[t]?.cache.set(n,u)}function h(e,t,n){const o=r.get(e);o?null!=t&&null!=o[t]?o[t]?.cache.delete(n):c.deleteBlock(e,n):null==t&&c.deleteBlock(e,n)}function d(e,t){const n=r.get(e);return n?n[t]??null:null}function g(e,r,c,i,u,a,f=null){const s=d(e,r);if(!s)return;const m=s.extent,{cache:x,rasterInfo:h}=s;if(m&&m.xmin===c.xmin&&m.xmax===c.xmax&&m.ymin===c.ymin&&m.ymax===c.ymax)return;i=i??0;const g=c.clone().normalize(),{spatialReference:y,transform:p}=h,k=new Set;for(let d=0;d<g.length;d++){const e=g[d];if(e.xmax-e.xmin<=i||e.ymax-e.ymin<=i)continue;let r=t(e,y,f);null!=p&&(r=p.inverseTransform(r));const c=new l({x:i,y:i,spatialReference:e.spatialReference});if(null==u&&!(u=n(c,y,e,f)))return;const{pyramidLevel:s,pyramidResolution:m,excessiveReading:x}=o(u,h,a||\"closest\");if(x)return;const{storageInfo:M}=h,{origin:R}=M,C={x:Math.max(0,Math.floor((r.xmin-R.x)/m.x)),y:Math.max(0,Math.floor((R.y-r.ymax)/m.y))},B=Math.ceil((r.xmax-r.xmin)/m.x-.1),j=Math.ceil((r.ymax-r.ymin)/m.y-.1),v=s>0?M.pyramidBlockWidth:M.blockWidth,b=s>0?M.pyramidBlockHeight:M.blockHeight,w=1,$=Math.max(0,Math.floor(C.x/v)-w),I=Math.max(0,Math.floor(C.y/b)-w),H=Math.floor((C.x+B-1)/v)+w,E=Math.floor((C.y+j-1)/b)+w;for(let t=I;t<=E;t++)for(let e=$;e<=H;e++)k.add(`${s}/${t}/${e}`)}x.forEach(((e,t)=>{if(!k.has(t)){const e=x.get(t);(null==e||e.isResolved||e.isRejected)&&x.delete(t)}})),s.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}export{s as decreaseRefCount,h as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,x as putBlock,u as register,a as unregister,g as update};\n"],"mappings":"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"}