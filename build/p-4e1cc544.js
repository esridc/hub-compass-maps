import{s as e,mF as n,k7 as t,U as i,n as r,ly as a,eM as s,lv as o,T as l,l8 as c,bn as u,ad as f}from"./p-aad64c9f.js";import{l as d,r as m,o as p}from"./p-875cbb57.js";import{e as g}from"./p-d492d39b.js";import{E as y,I as w,N as h}from"./p-07f1865a.js";import{u as b}from"./p-4c90e3f2.js";import{p as x}from"./p-512046c6.js";const I=()=>r.getLogger("esri.layers.ogc.ogcFeatureUtils"),F="startindex",j=new Set([F,"offset"]),k="http://www.opengis.net/def/crs/",v=`${k}OGC/1.3/CRS84`;var T;async function P(r,l,c={},u=5){const{links:f}=r,d=E(f,"items",T.geojson)||E(f,"http://www.opengis.net/def/rel/ogc/1.0/items",T.geojson);if(null==d)throw new e("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:m,customParameters:p,signal:g}=c,h=n(d.href,r.landingPage.url),x={limit:u,...p,token:m},j=t(h,x),k={accept:T.geojson},{data:v}=await i(j,{signal:g,headers:k}),P=U(j,u,v.links)??F;y(v);const $=w(v,{geometryType:l.geometryType}),q=l.fields||$.fields||[],O=null!=l.hasZ?l.hasZ:$.hasZ,C=$.geometryType,D=l.objectIdField||$.objectIdFieldName||"OBJECTID";let K=l.timeInfo;const M=q.find((({name:e})=>e===D));if(M)M.editable=!1,M.nullable=!1;else{if(!$.objectIdFieldType)throw new e("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");q.unshift({name:D,alias:D,type:"number"===$.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(D!==$.objectIdFieldName){const e=q.find((({name:e})=>e===$.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}q===$.fields&&$.unknownFields.length>0&&I().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:$.unknownFields}});for(const n of q){if(null==n.name&&(n.name=n.alias),null==n.alias&&(n.alias=n.name),"esriFieldTypeOID"!==n.type&&"esriFieldTypeGlobalID"!==n.type&&(n.editable=null==n.editable||!!n.editable,n.nullable=null==n.nullable||!!n.nullable),!n.name)throw new e("ogc-feature-layer:invalid-field-name","field name is missing",{field:n});if(!a.jsonValues.includes(n.type))throw new e("ogc-feature-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n})}if(K){const e=new s(q);if(K.startTimeField){const n=e.get(K.startTimeField);n?(K.startTimeField=n.name,n.type="esriFieldTypeDate"):K.startTimeField=null}if(K.endTimeField){const n=e.get(K.endTimeField);n?(K.endTimeField=n.name,n.type="esriFieldTypeDate"):K.endTimeField=null}if(K.trackIdField){const n=e.get(K.trackIdField);n?K.trackIdField=n.name:(K.trackIdField=null,I().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:K}}))}K.timeReference||={timeZoneIANA:o},K.startTimeField||K.endTimeField||(I().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:K}}),K=void 0)}return{drawingInfo:C?b(C):null,extent:z(r),geometryType:C,fields:q,hasZ:!!O,objectIdField:D,paginationParameter:P,timeInfo:K}}async function $(t,r={}){const{links:a,url:s}=t,o=E(a,"data",T.json)||E(a,"http://www.opengis.net/def/rel/ogc/1.0/data",T.json);if(null==o)throw new e("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:l,customParameters:c,signal:u}=r,f=n(o.href,s),{data:d}=await i(f,{signal:u,headers:{accept:T.json},query:{...c,token:l}});for(const e of d.collections)e.landingPage=t;return d}async function q(t,r={}){const{links:a,url:s}=t,o=E(a,"conformance",T.json)||E(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance",T.json);if(null==o)throw new e("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:l,customParameters:c,signal:u}=r,f=n(o.href,s),{data:d}=await i(f,{signal:u,headers:{accept:T.json},query:{...c,token:l}});return d}async function O(e,n={}){const{apiKey:t,customParameters:r,signal:a}=n,{data:s}=await i(e,{signal:a,headers:{accept:T.json},query:{...r,token:t}});return s.url=e,s}async function C(e,t={}){const{links:r,url:a}=e,s=E(r,"service-desc",T.openapi);if(null==s)return I().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:l,signal:c}=t,u=n(s.href,a),{data:f}=await i(u,{signal:c,headers:{accept:T.openapi},query:{...l,token:o}});return f}function D(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=n?.groups;if(!t)return null;const{authority:i,code:r}=t;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return l.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return l.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}}async function K(e,n,t){const i=await M(e,n,t);return d(i)}async function M(t,r,a){const{collection:{links:o,landingPage:{url:f}},layerDefinition:d,maxRecordCount:y,queryParameters:{apiKey:w,customParameters:b},spatialReference:I,supportedCrs:F}=t,j=E(o,"items",T.geojson)||E(o,"http://www.opengis.net/def/rel/ogc/1.0/items",T.geojson);if(null==j)throw new e("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:k,num:v,start:P,timeExtent:$,where:q}=r;if(r.objectIds)throw new e("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const O=l.fromJSON(I),C=r.outSpatialReference??O,D=C.isWGS84?null:R(C,F),K=G(k,F),M=S($),N=Z(q),A=v??(null==P?y:10),z=0===P?void 0:P,{fields:U,geometryType:B,hasZ:J,objectIdField:Q,paginationParameter:W}=d,H=n(j.href,f),{data:L}=await i(H,{...a,query:{...b,...K,crs:D,datetime:M,query:N,limit:A,[W]:z,token:w},headers:{accept:T.geojson}}),V=h(L,{geometryType:B,hasZ:J,objectIdField:Q}),X=V.length===A&&!!E(L.links??[],"next",T.geojson),Y=new s(U);for(const e of V){const n={};x(Y,n,e.attributes,!0);for(const e of Y.fields)e.nullable&&!(e.name in n)&&(n[e.name]=null);n[Q]=e.attributes[Q],e.attributes=n}if(!D&&C.isWebMercator)for(const e of V)if(null!=e.geometry&&null!=B){const n=m(e.geometry,B,J,!1);n.spatialReference=l.WGS84,e.geometry=p(c(n,C))}for(const e of V)e.objectId=e.attributes[Q];const _=D||!D&&C.isWebMercator?C.toJSON():u,ee=new g;return ee.exceededTransferLimit=X,ee.features=V,ee.fields=U,ee.geometryType=B,ee.hasZ=J,ee.objectIdFieldName=Q,ee.spatialReference=_,ee}function N(e){return null!=e&&"extent"===e.type}function R(e,n){const{isWebMercator:t,wkid:i}=e;if(!i)return null;const r=t?n[3857]??n[102100]??n[102113]??n[900913]:n[e.wkid];return r?`${k}${r}`:null}function A(e){if(null==e)return"";const{xmin:n,ymin:t,xmax:i,ymax:r}=e;return`${n},${t},${i},${r}`}function S(e){if(null==e)return null;const{start:n,end:t}=e;return`${null!=n?n.toISOString():".."}/${null!=t?t.toISOString():".."}`}function Z(e){return null!=e&&e&&"1=1"!==e?e:null}function G(e,n){if(!N(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:A(e)};const i=R(t,n);return null!=i?{bbox:A(e),"bbox-crs":i}:t.isWebMercator?{bbox:A(c(e,l.WGS84))}:null}function z(e){const n=e.extent?.spatial;if(!n)return null;const t=n.bbox[0],i=4===t.length,[r,a]=t,s=i?void 0:t[2];return{xmin:r,ymin:a,xmax:i?t[2]:t[3],ymax:i?t[3]:t[4],zmin:s,zmax:i?void 0:t[5],spatialReference:l.WGS84.toJSON()}}function E(e,n,t){return e.find((({rel:e,type:i})=>e===n&&i===t))??e.find((({rel:e,type:t})=>e===n&&!t))}function U(e,n,t){if(!t)return;const i=E(t,"next",T.geojson),r=f(i?.href)?.query;if(!r)return;const a=f(e).query,s=Object.keys(a??{}),o=Object.entries(r).filter((([e])=>!s.includes(e))).find((([e,t])=>j.has(e.toLowerCase())&&Number.parseInt(t,10)===n)),l=o?.[0];return l}!function(e){e.json="application/json",e.geojson="application/geo+json",e.openapi="application/vnd.oai.openapi+json;version=3.0"}(T||(T={}));export{M as $,D as C,$ as N,q as O,O as P,K as R,k,C as q,P as v,v as x};
//# sourceMappingURL=p-4e1cc544.js.map