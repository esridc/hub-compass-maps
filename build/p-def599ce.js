import{aE as t,ah as s,ai as e,r as i,aw as r,G as o,s as n,a,aA as h,ar as p,a1 as c,aU as l,cb as m,b9 as f,a6 as d,bf as u,a4 as j,a5 as y,aV as w,gg as b,dK as g,ec as v,fj as M,fk as x,gs as E,X as _,cB as R,e5 as T,gt as V,an as A,ao as O,ap as P,aO as S}from"./p-3013819f.js";import{j as L,m as q}from"./p-512c727a.js";import"./p-f1aede5a.js";import"./p-a9376829.js";import{f as z}from"./p-30a1f911.js";import"./p-b362a32c.js";import"./p-44a36259.js";import{a as C,E as D}from"./p-0d83e514.js";import{m as H,d as I}from"./p-c268fbe3.js";import{D as U,F}from"./p-8567e6fe.js";import{c as G,a as k}from"./p-d97e7de8.js";import{h as B}from"./p-201cec5f.js";import"./p-c7810a6f.js";import"./p-10e5b6ea.js";import"./p-89423226.js";import"./p-b3d3ca01.js";import"./p-ad726e47.js";import"./p-72db18d5.js";import"./p-894e6a6a.js";import"./p-54d1d89d.js";import"./p-59429ce9.js";import"./p-6d5c327b.js";import"./p-508fdb0a.js";import{r as K}from"./p-325c6878.js";import{e as W}from"./p-10315be7.js";import{f as X}from"./p-96e8fb80.js";import{o as J}from"./p-595ce045.js";import{m as N,u as Q}from"./p-4e55d8f0.js";import"./p-3b51db5e.js";import"./p-ffb26433.js";import"./p-3811f238.js";import"./p-e6812c2f.js";import"./p-94b15954.js";import"./p-a925664a.js";import"./p-a897fcf8.js";import"./p-7b13247d.js";import"./p-89242a33.js";import"./p-3b8b0ae8.js";import"./p-ec95a4fb.js";import"./p-1f0b604e.js";import"./p-347800d3.js";import"./p-4c2ef9f4.js";import"./p-721433ed.js";import"./p-ffa11fc1.js";import"./p-808395fb.js";import"./p-7580bdba.js";import"./p-a62b18ce.js";import"./p-1cf43261.js";import"./p-8b1f6523.js";import"./p-4f73c6ea.js";const Y=W(),Z={none:z.None,loop:z.Loop,oscillate:z.Oscillate};function $(t){return t?{...t,playAnimation:t.playing,repeatType:t.repeatType?Z[t.repeatType]:void 0}:{}}class tt extends C{constructor(h){super(),this.elementView=h,this.isWrapAround=!1,this.perspectiveTransform=t(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(s((()=>this.elementView.element.opacity),(t=>this.opacity=t),e),s((()=>[this.elementView.coords]),(()=>{this.requestRender()}),e),s((()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions]),(()=>{this._playHandle?.remove(),this.texture=i(this.texture),this.requestRender()}),e),r((()=>this.elementView.element.loaded),(()=>{const t=this.elementView.element;this.ready(),"video"===t.type&&null!=t.content&&this._handles.push(o(t.content,"play",(()=>this.requestRender())))}),e)),h.element.load().catch((t=>{n.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new a("element-load-error","Element cannot be displayed",{element:h,error:t}))}))}getMesh(t){throw new Error("Method not implemented.")}destroy(){this._playHandle?.remove(),this._handles.forEach((t=>t.remove())),this.texture=i(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,e=this.elementView.element.content;if(null!=e){const t=e instanceof HTMLImageElement,i=e instanceof HTMLVideoElement,r=t?e.naturalWidth:i?e.videoWidth:e.width,o=t?e.naturalHeight:i?e.videoHeight:e.height;if(this._updatePerspectiveTransform(r,o),this.texture)i&&!e.paused&&(this.texture.setData(e),this.requestRender(),this.texture.generateMipmap());else{const t=new I;if(t.wrapMode=U.CLAMP_TO_EDGE,t.preMultiplyAlpha=!0,t.width=r,t.height=o,"getFrame"in e){const i=e=>{this.texture?this.texture.setData(e):this.texture=new H(s,t,e),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=X(e,$(this.elementView.element.animationOptions),null,i))}else this.texture=new H(s,t,e);this.texture.generateMipmap(),i&&!e.paused&&this.requestRender()}}super.beforeRender(t)}_createTransforms(){return null}updateDrawCoords(t,s){const e=this.elementView.coords;if(null==e)return;const[i,r,o,n]=e.rings[0],a=this._vertices,{x:h,y:p}=t,c=0!==s;c?a.set([r[0]-h,r[1]-p,i[0]-h,i[1]-p,o[0]-h,o[1]-p,n[0]-h,n[1]-p,n[0]-h,n[1]-p,r[0]+s-h,r[1]-p,r[0]+s-h,r[1]-p,i[0]+s-h,i[1]-p,o[0]+s-h,o[1]-p,n[0]+s-h,n[1]-p]):a.set([r[0]-h,r[1]-p,i[0]-h,i[1]-p,o[0]-h,o[1]-p,n[0]-h,n[1]-p]),this.isWrapAround=c}getVAO(t,s,e){if(null==this.elementView.coords)return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=B.createVertex(t,F.DYNAMIC_DRAW,i);const r=B.createVertex(t,F.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new J(t,e,s,{geometry:this._geometryVbo,tex:r})}return this._vao}_updatePerspectiveTransform(t,s){const e=this._vertices;L(Y,[0,0,t,0,0,s,t,s],[e[0],e[1],e[4],e[5],e[2],e[3],e[6],e[7]]),h(this.perspectiveTransform,Y[6]/Y[8]*t,Y[7]/Y[8]*s)}}class st extends G{constructor(){super(...arguments),this._localOrigin=p(0,0),this._viewStateId=-1,this._dvsMat3=c()}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const s of this.children)s.beforeRender(t)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"overlay",brushes:[k.overlay],target:()=>this.children,drawPhase:D.MAP});return[...super.prepareRenderPasses(t),s]}_updateMatrices(t){const{state:s}=t,{id:e,size:i,pixelRatio:r,resolution:o,rotation:n,viewpoint:a,displayMat3:h}=s;if(this._viewStateId===e)return;const p=Math.PI/180*n,c=r*i[0],w=r*i[1],{x:b,y:g}=a.targetGeometry,v=l(b,s.spatialReference);this._localOrigin.x=v,this._localOrigin.y=g;const M=o*c,x=o*w,E=m(this._dvsMat3);f(E,E,h),d(E,E,u(c/2,w/2)),j(E,E,K(c/M,-w/x,1)),y(E,E,-p),this._viewStateId=e}_updateOverlays(t,s){const{state:e}=t,{rotation:i,spatialReference:r,worldScreenWidth:o,size:n,viewpoint:a}=e,h=this._localOrigin;let p=0;const c=w(r);if(c&&r.isWrappable){const t=n[0],l=n[1],m=180/Math.PI*i,f=Math.abs(Math.cos(m)),d=Math.abs(Math.sin(m)),u=Math.round(t*f+l*d),[j,y]=c.valid,w=b(r),{x:g,y:v}=a.targetGeometry,M=[g,v],x=[0,0];e.toScreen(x,M);const E=[0,0];let _;_=u>o?.5*o:.5*u;const R=Math.floor((g+.5*w)/w),T=j+R*w,V=y+R*w,A=[x[0]+_,0];e.toMap(E,A),E[0]>V&&(p=w),A[0]=x[0]-_,e.toMap(E,A),E[0]<T&&(p=-w);for(const t of s){const s=t.elementView.bounds;if(null==s)continue;const[e,,i]=s;e<j&&i>j?t.updateDrawCoords(h,w):i>y&&e<y?t.updateDrawCoords(h,-w):t.updateDrawCoords(h,p)}}else for(const t of s)t.updateDrawCoords(h,p)}}let et=class extends(N(Q)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new g}attach(){this.addAttachHandles([v((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((t=>this._updateTile(t))),this.requestUpdate()})),v((()=>this.layer.effectiveSource),"change",(({element:t})=>this._elementUpdateHandler(t)))]),this._overlayContainer=new st,this.container.addChild(this._overlayContainer),this._fetchQueue=new M({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(t,s)=>this._queryElements(t,s)}),this._tileStrategy=new x({cachePolicy:"purge",resampling:!0,acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(t){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(t){this._tileStrategy.update(t),this._debugGraphicsView?.update(t)}async hitTest(t,s){const e=[],i=t.normalize(),r=[i.x,i.y];for(const{projectedElement:{normalizedCoords:s,element:i}}of this._elementReferences.values())null!=s&&E(s.rings,r)&&e.push({type:"media",element:i,layer:this.layer,mapPoint:t,sourcePoint:i.toSource(t)});return e.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((t=>this._updateTile(t)))}_acquireTile(t){const s=new nt(t.clone());return this._updateTile(s),s}_updateTile(t){this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then((s=>{const[e,i]=t.setElements(s);this._referenceElements(t,e),this._dereferenceElements(t,i),this.requestUpdate()}),(t=>{_(t)||n.getLogger(this).error(t)})))}_releaseTile(t){this._fetchQueue.abort(t.key.id),t.elements&&this._dereferenceElements(t,t.elements),this.requestUpdate()}async _queryElements(t,s){const e=this.layer.effectiveSource;if(null==e)return[];this.view.featuresTilingScheme.getTileBounds(it,t,!0);const i=new R({xmin:it[0],ymin:it[1],xmax:it[2],ymax:it[3],spatialReference:this.view.spatialReference});return e.queryElements(i,s)}_referenceElements(t,s){if(null!=this.layer.source)for(const e of s)this._referenceElement(t,e)}_referenceElement(t,s){T(this._elementReferences,s.uid,(()=>{const t=new q({element:s,spatialReference:this.view.spatialReference}),e=new tt(t);this._overlayContainer.addChild(e),this.elements.add(s);let i=null;return{tiles:new Set,projectedElement:t,overlay:e,debugGraphic:i}})).tiles.add(t)}_dereferenceElements(t,s){for(const e of s)this._dereferenceElement(t,e)}_dereferenceElement(t,s){const e=this._elementReferences.get(s.uid);e.tiles.delete(t),e.tiles.size||(this._overlayContainer.removeChild(e.overlay),e.overlay.destroy(),e.projectedElement.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s),this._debugGraphicsView?.graphics.remove(e.debugGraphic))}_elementUpdateHandler(t){let s=this._elementReferences.get(t.uid);if(s){const e=s.projectedElement.normalizedCoords;if(null==e)return this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),void this._debugGraphicsView?.graphics.remove(s.debugGraphic);const i=[],r=[];for(const t of this._tileStrategy.tiles){const o=ot(this.view.featuresTilingScheme,t,e);s.tiles.has(t)?o||r.push(t):o&&i.push(t)}for(const s of i)this._referenceElement(s,t);for(const s of r)this._dereferenceElement(s,t);return s=this._elementReferences.get(t.uid),void(s?.debugGraphic&&(s.debugGraphic.geometry=s.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:s.debugGraphic,property:"geometry"})))}const e=new q({element:t,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=e)for(const s of this._tileStrategy.tiles){ot(this.view.featuresTilingScheme,s,e)&&this._referenceElement(s,t)}}};A([O()],et.prototype,"layer",void 0),A([O({readOnly:!0})],et.prototype,"elements",void 0),et=A([P("esri.views.2d.layers.MediaLayerView2D")],et);const it=S(),rt={xmin:0,ymin:0,xmax:0,ymax:0};function ot(t,s,e){return t.getTileBounds(it,s.key,!0),rt.xmin=it[0],rt.ymin=it[1],rt.xmax=it[2],rt.ymax=it[3],V(rt,e)}class nt{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const s=[],e=new Set(this.elements);this.elements=t;for(const i of t)e.has(i)?e.delete(i):s.push(i);return this.isReady=!0,[s,Array.from(e)]}destroy(){}}const at=et;export default at;
//# sourceMappingURL=p-def599ce.js.map