import{bt as t,b3 as e,dc as s,aX as i,hD as n,lN as r,nE as l,h as a,dC as h,dD as u,b_ as o,dB as c,a as f,et as d,eH as w,dP as y,U as g,b$ as p,dq as m,m3 as S,fl as F,eu as I,cM as _}from"./p-028496e2.js";import{a3 as b,a4 as T,a5 as A,a6 as R,a7 as v,a8 as N,a9 as O,aa as E,ab as D,ac as k,ad as C,ae as x,af as P,N as G,ag as M,ah as j,ai as U}from"./p-32a39338.js";import{x as L,s as B,r as q,n as V,t as W,a as K}from"./p-70a81651.js";import{x as Q,t as J,g as X,m as Z,f as Y,y as z,L as H,w as $,E as tt,T as et,S as st,F as it,v as nt,p as rt,D as lt,I as at,d as ht,a as ut,b as ot,c as ct}from"./p-4713be1a.js";import{c as ft,a as dt,n as wt}from"./p-ecde740d.js";import yt from"./p-1781aa3a.js";import{u as gt,i as pt}from"./p-c2c5c63d.js";import{a as mt,s as St}from"./p-0053e125.js";import{n as Ft}from"./p-cd329783.js";import"./p-0aeccf8c.js";import{n as It,s as _t}from"./p-3f094b9d.js";import"./p-82d7ddb5.js";class bt{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(t,e,s){this._layerById[e]=s,this._layerByName[t]=s}async featureSetByName(t,e=!0,s=["*"]){return void 0===this._layerByName[t]?null:this._layerByName[t]}async featureSetById(t,e=!0,s=["*"]){return void 0===this._layerById[t]?null:this._layerById[t]}castToText(t=!1){return"object, FeatureSetCollection"}}class Tt extends Q{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=t.parentfeatureset,t.whereclause instanceof L?(this._whereclause=t.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=t.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new t({wkid:4326}),this.geometryType=b.point)}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._parent._getFilteredSet("",null,this._whereclause,null,t);return this._checkCancelled(t),null!==this._whereClauseFunction?this._wset=new J(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):this._wset=new J(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(t){let e=this._parent?._isInFeatureSet(t);return e===T.NotInFeatureSet?e:(e=this._idstates[t],void 0===e?T.Unknown:e)}_getFeature(t,e,s){return this._parent._getFeature(t,e,s)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){return this._parent._featureFromCache(t)}executeWhereClause(t){return this._whereclause?.testFeature(t)??!1}async executeWhereClauseDeferred(t){if(null!==this._whereClauseFunction){const e=this._whereClauseFunction(t);return e}return this.executeWhereClause(t)}async _fetchAndRefineFeatures(t,e,s){const i=new J([],t,!1,null),n=Math.min(e,t.length);if(await(this._parent?._getFeatures(i,-1,n,s)),this._checkCancelled(s),null==this._whereClauseFunction){for(let e=0;e<n;e++){const s=this._parent?._featureFromCache(t[e]);!0===this.executeWhereClause(s)?this._idstates[t[e]]=T.InFeatureSet:this._idstates[t[e]]=T.NotInFeatureSet}return"success"}const r=[];for(let e=0;e<n;e++){const s=this._parent?._featureFromCache(t[e]);r.push(await this.executeWhereClauseDeferred(s))}for(let s=0;s<e;s++)!0===r[s]?this._idstates[t[s]]=T.InFeatureSet:this._idstates[t[s]]=T.NotInFeatureSet;return"success"}async _getFilteredSet(t,e,s,i,n){null!==this._whereClauseFunction||(null!==s?null!==this._whereclause&&(s=X(this._whereclause,s)):s=this._whereclause),await this._ensureLoaded();const r=await this._parent._getFilteredSet(t,e,s,i,n);let l;return this._checkCancelled(n),l=null!==this._whereClauseFunction?new J(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,this._clonePageDefinition(r.pagesDefinition)):new J(r._candidates.slice(0),r._known.slice(0),r._ordered,this._clonePageDefinition(r.pagesDefinition)),l}async _stat(t,e,s,i,n,r,l){if(null!==this._whereClauseFunction)return null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1};let a=this._whereclause;null!==n&&null!==this._whereclause&&(a=X(this._whereclause,n));const h=await this._parent._stat(t,e,s,i,a,r,l);return!1===h.calculated?null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1}:h}async _canDoAggregates(t,e,s,i,n){return null===this._whereClauseFunction&&(null!==n?null!==this._whereclause&&(n=X(this._whereclause,n)):n=this._whereclause,null!==this._parent&&this._parent._canDoAggregates(t,e,s,i,n))}async _getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l){if(null===this._parent)throw new B(q.NeverReach);return null!==n?null!==this._whereclause&&(n=X(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l)}static registerAction(){Q._featuresetFunctions.filter=function(t){if("function"==typeof t)return new Tt({parentfeatureset:this,whereclause:t});let e=null;return t instanceof L&&(e=t),new Tt({parentfeatureset:this,whereclause:e})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}class At{constructor(t){this.field=t,this.sqlRewritable=!1}postInitialization(t,e){}}class Rt extends At{constructor(t){super(t),this.sqlRewritable=!0}extractValue(t){return t.attributes[this.field.name]}rewriteSql(t){return{rewritten:this.sqlRewritable,where:t}}}class vt extends At{constructor(t,e,s){super(A(t)),this.originalField=t,this.sqlRewritable=!0,this.field.name=e,this.field.alias=s}rewriteSql(t,e){return{rewritten:this.sqlRewritable,where:Z(t,this.field.name,this.originalField.name,e.getFieldsIndex())}}extractValue(t){return t.attributes[this.originalField.name]}}class Nt extends At{constructor(t,e,s){super(t),this.codefield=e,this.lkp=s,this.reverseLkp={};for(const t in s)this.reverseLkp[s[t]]=t;this.sqlRewritable=!0}rewriteSql(t,e){const s=this.evaluateNodeToWhereClause(t.parseTree,R.Standardised,this.field.name,this.codefield instanceof L?Y(this.codefield,R.Standardised):this.codefield,t.parameters);return s.includes(Nt.BADNESS)?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:L.create(s,e._parent.getFieldsIndex(),e.dateFieldsTimeZoneDefaultUTC)}}evaluateNodeToWhereClause(t,e,s=null,i=null,n){let r,l,a,h;switch(t.type){case"interval":return it(this.evaluateNodeToWhereClause(t.value,e,s,i,n),t.qualifier,t.op);case"case-expression":{let i=" CASE ";"simple"===t.format&&(i+=this.evaluateNodeToWhereClause(t.operand,e,s,Nt.BADNESS,n));for(let r=0;r<t.clauses.length;r++)i+=" WHEN "+this.evaluateNodeToWhereClause(t.clauses[r].operand,e,s,Nt.BADNESS,n)+" THEN "+this.evaluateNodeToWhereClause(t.clauses[r].value,e,s,Nt.BADNESS,n);return null!==t.else&&(i+=" ELSE "+this.evaluateNodeToWhereClause(t.else,e,s,Nt.BADNESS,n)),i+=" END ",i}case"parameter":{const s=n[t.value.toLowerCase()];if("string"==typeof s)return"'"+s.toString().replaceAll("'","''")+"'";if(v(s))return $(s,e);if(N(s))return $(s,e);if(O(s))return tt(s,e);if(E(s))return et(s,e);if(D(s))return st(s,e);if(s instanceof Array){const t=[];for(let i=0;i<s.length;i++)"string"==typeof s[i]?t.push("'"+s[i].toString().replaceAll("'","''")+"'"):v(s[i])||N(s[i])?t.push($(s[i],e)):O(s[i])?t.push(tt(s[i],e)):E(s[i])?t.push(et(s[i],e)):D(s[i])?t.push(st(s[i],e)):t.push(s[i].toString());return t}return s.toString()}case"expression-list":l=[];for(const r of t.value)l.push(this.evaluateNodeToWhereClause(r,e,s,i,n));return l;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(t.expr,e,s,Nt.BADNESS,n)+" ) ";case"binary-expression":switch(t.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" AND "+this.evaluateNodeToWhereClause(t.right,e,s,i,n)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" OR "+this.evaluateNodeToWhereClause(t.right,e,s,i,n)+") ";case"IS":if("null"!==t.right.type)throw new V(W.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IS NULL )";case"ISNOT":if("null"!==t.right.type)throw new V(W.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IS NOT NULL )";case"IN":if(r=[],"expression-list"===t.right.type){if("column-reference"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}r.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+r.join(",")+")) "}return r=this.evaluateNodeToWhereClause(t.right,e,s,i,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+r.join(",")+")) "}return h=this.evaluateNodeToWhereClause(t.right,e,s,i,n),h instanceof Array?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" IN ("+h+")) ";case"NOT IN":if(r=[],"expression-list"===t.right.type){if("column-reference"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const r=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}r.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+r.join(",")+")) "}return r=this.evaluateNodeToWhereClause(t.right,e,s,i,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+r.join(",")+")) "}return h=this.evaluateNodeToWhereClause(t.right,e,s,i,n),h instanceof Array?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,n)+" NOT IN ("+h+")) ";case"BETWEEN":return a=this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" BETWEEN "+a[0]+" AND "+a[1]+" ) ";case"NOTBETWEEN":return a=this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)," ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" NOT BETWEEN "+a[0]+" AND "+a[1]+" ) ";case"LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)+") ";case"NOT LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)+") ";case"<>":case"=":if("column-reference"===t.left.type&&"string"===t.right.type){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[t.right.value.toString()])return" ("+i+" "+t.operator+" "+this.lkp[t.right.value.toString()].toString()+") "}else if("column-reference"===t.right.type&&"string"===t.left.type&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[t.right.value.toString()].toString()+" "+t.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,Nt.BADNESS,n)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,Nt.BADNESS,n)+") "}case"null":return"null";case"boolean":return!0===t.value?"1":"0";case"string":return"'"+t.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${t.value}'`;case"date":return`date '${t.value}'`;case"time":return`time '${t.value}'`;case"number":return t.value.toString();case"current-time":return H("date"===t.mode,e);case"column-reference":return s&&s.toLowerCase()===t.column.toLowerCase()?"("+i+")":t.column;case"data-type":return t.value;case"function":{const i=this.evaluateNodeToWhereClause(t.args,e,s,Nt.BADNESS,n);return z(t.name,i,e)}}throw new V(W.UnsupportedSyntax,{node:t.type})}extractValue(t){return this.codefield instanceof L?this.reverseLkp[L.convertValueToStorageFormat(this.codefield.calculateValueCompiled(t))]:this.reverseLkp[t.attributes[this.codefield]]}}Nt.BADNESS="_!!!_BAD_LKP_!!!!";class Ot extends At{constructor(t,e){super(t),this._sql=e}rewriteSql(t,e){return{rewritten:!0,where:Z(t,this.field.name,Y(this._sql,R.Standardised),e.getFieldsIndex())}}extractValue(t){return L.convertValueToStorageFormat(this._sql.calculateValueCompiled(t),this.field.type)}}class Et extends Q{static findField(t,e){for(const s of t)if(s.name.toLowerCase()===e.toString().toLowerCase())return s;return null}constructor(t){super(t),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=t.extraFilter,this._parent=t.parentfeatureset,this._maxProcessing=30,this.adaptedFields=t.adaptedFields}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new t({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=b.point,this.typeIdField="",this.types=null,this.subtypeField=null,this.subtypes=null),this.fields=[];for(const t of this.adaptedFields)t.postInitialization(this,this._parent),this.fields.push(t.field)}async _getSet(t){if(null===this._wset){await this._ensureLoaded();let s=null;return s=this._extraFilter?await this._getFilteredSet("",null,null,null,t):await(this._parent?._getSet(t)),this._checkCancelled(t),e(s),this._wset=new J(s._candidates.slice(0),s._known.slice(0),s._ordered,this._clonePageDefinition(s.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}async _getFeatures(t,e,i,n){const r=[];-1!==e&&void 0===this._featureCache[e]&&r.push(e);const l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,l))return await this._expandPagedSet(t,l,0,0,n),this._getFeatures(t,e,i,n);let a=0;for(let s=t._lastFetchedIndex;s<t._known.length&&(a++,a<=i&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[s]]&&(t._known[s]!==e&&r.push(t._known[s]),r.length>=l)));s++);if(0===r.length)return"success";t=new J([],r,t._ordered,null);const h=Math.min(r.length,i);await(this._parent?._getFeatures(t,-1,h,n)),this._checkCancelled(n);const u=[];for(let t=0;t<h;t++){const e=this._parent?._featureFromCache(r[t]);void 0!==e&&u.push({geometry:e.geometry,attributes:e.attributes,id:r[t]})}for(const t of u){const e=[];for(const s of this.adaptedFields)e[s.field.name]=s.extractValue(t);this._featureCache[t.id]=new s({attributes:e,geometry:ft(t.geometry)})}return"success"}async _fetchAndRefineFeatures(){throw new B(q.NeverReach)}async _getFilteredSet(t,e,s,i,n){let r=!1;const l=this._reformulateWithoutAdaptions(s);r=l.cannot,s=l.where;let a=!1;if(null!==i){a=!0;const t=[];for(const e of this.adaptedFields)if(!(e instanceof Rt)&&!0===i.scanForField(e.field.name)){if(!(e instanceof vt)){i=null,a=!1;break}t.push({field:e.field.name,newfield:e.originalField.name})}i&&t.length>0&&(i=i.replaceFields(t))}null!==s?null!==this._extraFilter&&(s=X(this._extraFilter,s)):s=this._extraFilter,await this._ensureLoaded();const h=await this._parent._getFilteredSet(t,e,s,i,n);let u;return this._checkCancelled(n),u=!0===r?new J(h._candidates.slice(0).concat(h._known.slice(0)),[],!0===a&&h._ordered,this._clonePageDefinition(h.pagesDefinition)):new J(h._candidates.slice(0),h._known.slice(0),!0===a&&h._ordered,this._clonePageDefinition(h.pagesDefinition)),u}_reformulateWithoutAdaptions(t){const e={cannot:!1,where:t};if(null!==t)for(const s of this.adaptedFields)if(!0===nt(t,s.field.name)){const i=s.rewriteSql(t,this);if(!0!==i.rewritten){e.cannot=!0,e.where=null;break}e.where=i.where}return e}async _stat(t,e,s,i,n,r,l){let a=!1,h=this._reformulateWithoutAdaptions(e);if(a=h.cannot,e=h.where,h=this._reformulateWithoutAdaptions(n),a=a||h.cannot,null!==(n=h.where)?null!==this._extraFilter&&(n=X(this._extraFilter,n)):n=this._extraFilter,!0===a)return null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1};const u=await this._parent._stat(t,e,s,i,n,r,l);return!1===u.calculated?null===n&&""===s&&null===i?this._manualStat(t,e,r,l):{calculated:!1}:u}async _canDoAggregates(t,e,s,i,n){if(null===this._parent)return!1;for(let e=0;e<t.length;e++)for(const s of this.adaptedFields)if(t[e].toLowerCase()===s.field.name.toLowerCase()&&!(s instanceof Rt))return!1;const r=[];for(let t=0;t<e.length;t++){const s=e[t];if(null!==s.workingexpr){const t=this._reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)return!1;const e=s.clone();e.workingexpr=t.where,r.push(e)}else r.push(s)}const l=this._reformulateWithoutAdaptions(n);return!l.cannot&&(null!==(n=l.where)?null!==this._extraFilter&&(n=X(this._extraFilter,n)):n=this._extraFilter,this._parent._canDoAggregates(t,r,s,i,n))}async _getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l){if(null===this._parent)throw new B(q.NeverReach);const a=[];for(let t=0;t<e.length;t++){const s=e[t];if(null!==s.workingexpr){const t=this._reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)throw new B(q.NeverReach);const e=s.clone();e.workingexpr=t.where,a.push(e)}else a.push(s)}const h=this._reformulateWithoutAdaptions(n);if(h.cannot)throw new B(q.NeverReach);return null!==(n=h.where)?null!==this._extraFilter&&(n=X(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(t,a,s,i,n,r,l)}}function Dt(t,e){return t===e?0:null===t?-1:null===e?1:t<e?-1:1}class kt{constructor(t){const e=t.split(",");this._fields=[],this._directions=[];for(let t=0;t<e.length;t++){const s=e[t].match(/\S+/g);this._fields.push(s[0]),2===s.length?"asc"===s[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let t="";for(let e=0;e<this._fields.length;e++)0!==e&&(t+=","),t+=this._fields[e],1===this._directions[e]?t+=" ASC":t+=" DESC";return t}order(t){t.sort(((t,e)=>{for(let s=0;s<this._fields.length;s++){const i=this.featureValue(t.feature,this._fields[s],s),n=this.featureValue(e.feature,this._fields[s],s);let r=0;if(r=1===this._directions[s]?Dt(i,n):-1*Dt(i,n),0!==r)return r}return 0}))}scanForField(t){for(let e=0;e<this._fields.length;e++)if(this._fields[e].toLowerCase().trim()===t.toLowerCase().trim())return!0;return!1}replaceFields(t){let e="";for(let s=0;s<this._fields.length;s++){0!==s&&(e+=",");let i=this._fields[s];for(const e of t)if(i.toLowerCase()===e.field.toLowerCase()){i=e.newfield;break}e+=i,1===this._directions[s]?e+=" ASC":e+=" DESC"}return new kt(e)}featureValue(t,e,s){const i=t.attributes[e];if(void 0!==i)return i;for(const i in t.attributes)if(e.toLowerCase()===i.toLowerCase())return this._fields[s]=i,t.attributes[i];return null}}class Ct extends Q{constructor(t){super(t),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=t.orderbyclause,this._parent=t.parentfeatureset}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,this._orderbyclause,t);return this._checkCancelled(t),this._wset=e,this._wset}return this._wset}async manualOrderSet(t,e){const s=await this.getIdColumnDictionary(t,[],-1,e);this._orderbyclause?.order(s);const i=new J([],[],!0,null);for(let t=0;t<s.length;t++)i._known.push(s[t].id);return i}async getIdColumnDictionary(t,e,s,i){if(s<t._known.length-1){const n=this._maxQueryRate();if("GETPAGES"===t._known[s+1])return await k(this._parent._expandPagedSet(t,n,0,0,i)),this.getIdColumnDictionary(t,e,s,i);let r=s+1;const l=[];for(;r<t._known.length&&"GETPAGES"!==t._known[r];)l.push(t._known[r]),r++;s+=l.length;const a=await k(this._parent._getFeatureBatch(l,i));this._checkCancelled(i);for(const t of a)e.push({id:t.attributes[this.objectIdField],feature:t});return this.getIdColumnDictionary(t,e,s,i)}return t._candidates.length>0?(await k(this._refineSetBlock(t,this._maxProcessingRate(),i)),this._checkCancelled(i),this.getIdColumnDictionary(t,e,s,i)):e}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){if(void 0===this._featureCache[t]){const e=this._parent._featureFromCache(t);if(void 0===e)return;return null===e?null:(this._featureCache[t]=e,e)}return this._featureCache[t]}async _fetchAndRefineFeatures(){throw new B(q.NeverReach)}async _getFilteredSet(t,e,s,i,n){await this._ensureLoaded();const r=await this._parent._getFilteredSet(t,e,s,null===i?this._orderbyclause:i,n);this._checkCancelled(n);const l=new J(r._candidates.slice(0),r._known.slice(0),r._ordered,this._clonePageDefinition(r.pagesDefinition));let a=!0;if(r._candidates.length>0&&(a=!1),!1===l._ordered){let t=await this.manualOrderSet(l,n);return!1===a&&(null===e&&null===s||(t=new J(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)))),t}return l}static registerAction(){Q._featuresetFunctions.orderBy=function(t){return""===t?this:new Ct({parentfeatureset:this,orderbyclause:new kt(t)})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}function xt(t){if("function"===t.parseTree.type){if(0===t.parseTree.args.value.length)return{name:t.parseTree.name,expr:null};if(t.parseTree.args.value.length>1)throw new V(W.MissingStatisticParameters);const e=L.create(rt(t.parseTree.args.value[0],R.Standardised,t.parameters),t.fieldsIndex,t.timeZone);return{name:t.parseTree.name,expr:e}}return null}class Pt{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const t=new Pt;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,e,s,i){const n=new Pt;n.field=t;const r=L.create(e,s,i),l=xt(r);if(null===l)throw new V(W.UnsupportedSqlFunction,{function:""});const a=l.name.toUpperCase().trim();if("MIN"===a){if(n.typeofstat="MIN",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:"min"})}else if("MAX"===a){if(n.typeofstat="MAX",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===a)n.typeofstat="COUNT",n.workingexpr=l.expr;else if("STDEV"===a){if(n.typeofstat="STDDEV",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===a){if(n.typeofstat="SUM",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===a){if(n.typeofstat="AVG",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:a})}else if("AVG"===a){if(n.typeofstat="AVG",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==a)throw new V(W.UnsupportedSqlFunction,{function:a});if(n.typeofstat="VAR",n.workingexpr=l.expr,null===r)throw new V(W.InvalidFunctionParameters,{function:"var"})}return n}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}function Gt(t){if(!t)return"COUNT";switch(t.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class Mt extends Q{constructor(t){super(t),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=t.parentfeatureset,this._config=t}isTable(){return!0}async _getSet(t){if(null===this._wset){const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,this._wset}return this._wset}_isInFeatureSet(){return T.InFeatureSet}_nextUniqueName(t){for(;1===t["T"+this._uniqueIds.toString()];)this._uniqueIds++;const e="T"+this._uniqueIds.toString();return t[e]=1,e}_convertToEsriFieldType(t){return t}_initialiseFeatureSet(){const e={};let s=!1,r=1;const l=this._parent?this._parent.getFieldsIndex():new i([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===s;){let t=!1;for(let e=0;e<this._config.groupbyfields.length;e++)if(this._config.groupbyfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}if(!1===t)for(let e=0;e<this._config.statsfields.length;e++)if(this._config.statsfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}!1===t?s=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}for(const t of this._config.statsfields){const e=new Pt;e.field=t.name,e.tofieldname=t.name,e.workingexpr=t.expression instanceof L?t.expression:L.create(t.expression,l,this.dateFieldsTimeZoneDefaultUTC),e.typeofstat=Gt(t.statistic),this._decodedStatsfield.push(e)}this._decodedGroupbyfield=[];for(const t of this._config.groupbyfields){const e={name:t.name,singlefield:null,tofieldname:t.name,expression:t.expression instanceof L?t.expression:L.create(t.expression,l,this.dateFieldsTimeZoneDefaultUTC),sqlType:null};this._decodedGroupbyfield.push(e)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const t of this._parent.fields)e[t.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=""}else this.geometryType=b.point,this.typeIdField="",this.types=null,this.subtypes=null,this.subtypeField="",this.spatialReference=new t({wkid:4326});this.fields=[];const a=new Pt;a.field=this._nextUniqueName(e),a.tofieldname=this.objectIdField,a.workingexpr=L.create(this._parent.objectIdField,this._parent.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC),a.typeofstat="MIN",this._decodedStatsfield.push(a);for(const t of this._decodedGroupbyfield){const s=new n;if(t.name=this._nextUniqueName(e),s.name=t.tofieldname,s.alias=s.name,lt(t.expression)){const e=this._parent.getField(Y(t.expression,R.Standardised));if(!e)throw new B(q.AggregationFieldNotFound);t.name=e.name,t.singlefield=e.name,this.phsyicalgroupbyfields.push(e.name),s.type=e.type,t.sqlType=e.type}else{s.type=this._convertToEsriFieldType(at(t.expression,this._parent.fields));const e=new n;e.name=t.name,e.alias=e.name,this.phsyicalgroupbyfields.push(t.name),this._adaptedFields.push(new Ot(e,t.expression)),this._candosimplegroupby=!1,t.sqlType=s.type}this.fields.push(s)}if(this._adaptedFields.length>0)for(const t of this._parent.fields)this._adaptedFields.push(new Rt(t));for(let t=0;t<this._decodedStatsfield.length;t++){const s=new n;let i=null;const r=this._decodedStatsfield[t];r.field=this._nextUniqueName(e),r.tofieldname===this.objectIdField&&(this._internalObjectIdField=r.field),s.name=r.tofieldname,s.alias=s.name;const l=null!==r.workingexpr&&lt(r.workingexpr)?Y(r.workingexpr,R.Standardised):"";switch(this._decodedStatsfield[t].typeofstat){case"SUM":if(""!==l){if(i=this._parent.getField(l),!i)throw new B(q.AggregationFieldNotFound);s.type=i.type}else s.type="double";break;case"MIN":case"MAX":if(""!==l){if(i=this._parent.getField(l),!i)throw new B(q.AggregationFieldNotFound);s.type=i.type}else s.type="double";break;case"COUNT":s.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==l&&(i=this._parent.getField(l),!i))throw new B(q.AggregationFieldNotFound);s.type="double"}this.fields.push(s)}}async _canDoAggregates(){return!1}async _getFeatures(t,e,s,i){const n=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(t,n)?(await this._expandPagedSet(t,n,0,0,i),this._getFeatures(t,e,s,i)):"success"}async _getFilteredSet(t,e,s,i,n){if(""!==t)return new J([],[],!0,null);let r=null;const l={ordered:!1,nowhereclause:!1};if(await this._ensureLoaded(),null!==s)for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===nt(s,this._decodedStatsfield[t].tofieldname)){l.nowhereclause=!0,s=null;break}if(null!==i){l.ordered=!0;for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===i.scanForField(this._decodedStatsfield[t].tofieldname)){i=null,l.ordered=!1;break}if(null!==i)for(const t of this._decodedGroupbyfield)if(null===t.singlefield&&!0===i.scanForField(t.tofieldname)){i=null,l.ordered=!1;break}}if(!1!==this._candosimplegroupby&&await this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)){let t=null;s&&(t=this._reformulateWhereClauseWithoutGroupByFields(s));let e=null;i&&(e=this._reformulateOrderClauseWithoutGroupByFields(i));const a=await this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,t,e,this._internalObjectIdField);return this._checkCancelled(n),r=!0===l.nowhereclause?new J(a._candidates.slice(0).concat(a._known.slice(0)),[],!0===l.ordered&&a._ordered,this._clonePageDefinition(a.pagesDefinition)):new J(a._candidates.slice(0),a._known.slice(0),!0===l.ordered&&a._ordered,this._clonePageDefinition(a.pagesDefinition)),r}let a=this._parent;if(this._adaptedFields.length>0&&(a=new Et({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===l.nowhereclause)r=new J(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new Ct({parentfeatureset:a,orderbyclause:new kt(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let t=a;if(null!==s){let e=null;s&&(e=this._reformulateWhereClauseWithoutGroupByFields(s)),t=new Tt({parentfeatureset:t,whereclause:e})}r=new J(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new Ct({parentfeatureset:t,orderbyclause:new kt(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return r}_reformulateWhereClauseWithoutStatsFields(t){for(const e of this._decodedStatsfield)t=Z(t,e.tofieldname,Y(e.workingexpr,R.Standardised),this._parent.getFieldsIndex());return t}_reformulateWhereClauseWithoutGroupByFields(t){for(const e of this._decodedGroupbyfield)e.tofieldname!==e.name&&(t=Z(t,e.tofieldname,Y(e.expression,R.Standardised),this._parent.getFieldsIndex()));return t}_reformulateOrderClauseWithoutGroupByFields(t){const e=[];for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&e.push({field:t.tofieldname,newfield:t.name});return e.length>0?t.replaceFields(e):t}_clonePageDefinition(t){return null===t?null:!0===t.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,internal:t.internal}:this._parent._clonePageDefinition(t)}async _refineSetBlock(t,e,s){if(!0===this._checkIfNeedToExpandCandidatePage(t,this._maxQuery))return await this._expandPagedSet(t,this._maxQuery,0,0,s),this._refineSetBlock(t,e,s);this._checkCancelled(s);this._refineKnowns(t,e);return t}_expandPagedSet(t,e,s,i,n){return this._expandPagedSetFeatureSet(t,e,s,i,n)}async _getPhysicalPage(t,e,i){if(!0===t.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(t,t.pagesDefinition.resultRecordCount,i,[]);const n=await this._getAgregagtePhysicalPage(t,e,i);for(const t of n){const e={geometry:t.geometry,attributes:{}},i={};for(const e in t.attributes)i[e.toLowerCase()]=t.attributes[e];for(const t of this._decodedGroupbyfield)e.attributes[t.tofieldname]=i[t.name.toLowerCase()];for(const t of this._decodedStatsfield)e.attributes[t.tofieldname]=i[t.field.toLowerCase()];this._featureCache[e.attributes[this.objectIdField]]=new s(e)}return n.length}_sequentialGetPhysicalItem(t,e,s,i){return new Promise(((n,r)=>{null===t.pagesDefinition.internal.iterator&&(t.pagesDefinition.internal.iterator=t.pagesDefinition.internal.subfeatureset.iterator(s)),!0===t.pagesDefinition.internal.fullyResolved||0===e?n(i.length):this._nextAggregateItem(t,e,s,i,(r=>{null===r?n(i.length):(e-=1,n(this._sequentialGetPhysicalItem(t,e,s,i)))}),r)}))}_nextAggregateItem(t,e,s,i,n,r){try{k(t.pagesDefinition.internal.iterator.next()).then((l=>{if(null===l)if(null!==t.pagesDefinition.internal.workingItem){const e=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);i.push(e),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(e.attributes[this.objectIdField]),t.pagesDefinition.internal.fullyResolved=!0,n(null)}else t.pagesDefinition.internal.fullyResolved=!0,n(null);else{const a=this._generateAggregateHash(l);if(null===t.pagesDefinition.internal.workingItem)t.pagesDefinition.internal.workingItem={features:[l],id:a};else{if(a!==t.pagesDefinition.internal.workingItem.id){const s=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);return i.push(s),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(s.attributes[this.objectIdField]),e-=1,t.pagesDefinition.internal.workingItem={features:[l],id:a},void n(s)}t.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(t,e,s,i,n,r)}}),r)}catch(t){r(t)}}_calculateFieldStat(t,e,s){const i=[];for(let s=0;s<t.features.length;s++)if(null!==e.workingexpr){const n=e.workingexpr.calculateValue(t.features[s]);null!==n&&(n instanceof dt||n instanceof wt?i.push(n.toNumber()):n instanceof K?i.push(n.toMilliseconds()):i.push(n))}else i.push(null);switch(e.typeofstat){case"MIN":s.attributes[e.tofieldname]=ht("min",i,-1);break;case"MAX":s.attributes[e.tofieldname]=ht("max",i,-1);break;case"SUM":s.attributes[e.tofieldname]=ht("sum",i,-1);break;case"COUNT":s.attributes[e.tofieldname]=i.length;break;case"VAR":s.attributes[e.tofieldname]=ht("var",i,-1);break;case"STDDEV":s.attributes[e.tofieldname]=ht("stddev",i,-1);break;case"AVG":s.attributes[e.tofieldname]=ht("avg",i,-1)}return!0}_calculateAndAppendAggregateItem(t){const e={attributes:{},geometry:null};for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.features[0].attributes[s.singlefield]:L.convertValueToStorageFormat(s.expression.calculateValue(t.features[0]),s.sqlType);e.attributes[s.tofieldname]=i}for(const s of this._decodedStatsfield)this._calculateFieldStat(t,s,e);const i=[];for(let s=0;s<this._decodedStatsfield.length;s++)i.push(this._calculateFieldStat(t,this._decodedStatsfield[s],e));return this._featureCache[e.attributes[this.objectIdField]]=new s({attributes:e.attributes,geometry:e.geometry}),e}_generateAggregateHash(t){let e="";for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.attributes[s.singlefield]:s.expression.calculateValue(t);e+=null==i?":":":"+i.toString()}return r(e,l.String)}async _stat(){return{calculated:!1}}async getFeatureByObjectId(){return null}static registerAction(){Q._featuresetFunctions.groupby=function(t,e){return new Mt({parentfeatureset:this,groupbyfields:t,statsfields:e})}}}class jt extends Q{constructor(t){super(t),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._parent._getSet(t);return this._wset=new J(e._candidates.slice(0),e._known.slice(0),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===T.NotInFeatureSet)return e;const s=this._idstates[t];return s===T.InFeatureSet||s===T.NotInFeatureSet?s:e===T.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=T.InFeatureSet,this._countedin++,T.InFeatureSet):(this._idstates[t]=T.NotInFeatureSet,T.NotInFeatureSet):T.Unknown}async _expandPagedSet(t,e,s,i,n){if(null===this._parent)throw new B(q.NotImplemented);if(e>this._topnum&&(e=this._topnum),this._countedin>=this._topnum&&t.pagesDefinition.internal.set.length<=t.pagesDefinition.resultOffset){let e=t._known.length;return e>0&&"GETPAGES"===t._known[e-1]&&(t._known.length=e-1),e=t._candidates.length,e>0&&"GETPAGES"===t._candidates[e-1]&&(t._candidates.length=e-1),"success"}const r=await this._parent._expandPagedSet(t,e,s,i,n);return this._setKnownLength(t)>this._topnum&&(t._known.length=this._topnum),this._setKnownLength(t)>=this._topnum&&(t._candidates.length=0),r}async _getFeatures(t,e,s,i){const n=[],r=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,r))return await this._expandPagedSet(t,r,0,0,i),this._getFeatures(t,e,s,i);-1!==e&&void 0===this._featureCache[e]&&n.push(e);let l=0;for(let i=t._lastFetchedIndex;i<t._known.length&&(l++,l<=s&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[i]]&&(t._known[i]!==e&&n.push(t._known[i]),n.length>r)));i++);if(0===n.length)return"success";const a=new J([],n,!1,null),h=Math.min(n.length,s);await this._parent._getFeatures(a,-1,h,i);for(let t=0;t<h;t++){const e=this._parent._featureFromCache(n[t]);void 0!==e&&(this._featureCache[n[t]]=e)}return"success"}async _getFilteredSet(t,e,s,i,n){await this._ensureLoaded();const r=await this._getSet(n);return new J(r._candidates.slice(0).concat(r._known.slice(0)),[],!1,this._clonePageDefinition(r.pagesDefinition))}_refineKnowns(t,e){let s=0,i=null;const n=[];for(let r=0;r<t._candidates.length;r++){const l=this._isInFeatureSet(t._candidates[r]);if(l===T.InFeatureSet){if(t._known.push(t._candidates[r]),s+=1,null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(n.push(i),i={start:r,end:r}),t._known.length>=this._topnum)break}else if(l===T.NotInFeatureSet)null===i?i={start:r,end:r}:i.end===r-1?i.end=r:(n.push(i),i={start:r,end:r}),s+=1;else if(l===T.Unknown)break;if(s>=e)break}null!==i&&n.push(i);for(let e=n.length-1;e>=0;e--)t._candidates.splice(n[e].start,n[e].end-n[e].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){Q._featuresetFunctions.top=function(t){return new jt({parentfeatureset:this,topnum:t})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}async function Ut(t,e,s,i){return qt(e,await Lt(t,e,s,i),s,i)}async function Lt(t,e,s,i){const n={...i},r=Vt(e,s),l=null!=e.outStatistics?.[0],h=a("featurelayer-pbf-statistics"),u=!l||h;let o;if("pbf"===s?.format&&u)try{o=await Ft(t,r,n)}catch(t){if("query:parsing-pbf"!==t.name)throw t;s.format="json"}return"json"!==s?.format&&u||(o=await mt(t,r,n)),Bt(s?.fieldsIndex,o.fields),o}function Bt(t,e){if(null!=t&&null!=e)for(const s of e){const e=t.get(s.name);e&&Object.assign(s,e.toJSON())}}async function qt(t,e,s,i){const n=s?.infoFor3D;if(!Wt(t,n)||null==n||!e.assetMaps||!e.features?.length)return h.fromJSON(e);const{meshFeatureSetFromJSON:r}=await u(import("./p-ae0fe065.js"),i);return r(t,n,e)}function Vt(t,e){let s=o.from(t);s.sourceSpatialReference=s.sourceSpatialReference??e?.sourceSpatialReference??null,(e?.gdbVersion||e?.dynamicDataSource)&&(s=s===t?s.clone():s,s.gdbVersion=t.gdbVersion||e.gdbVersion,s.dynamicDataSource=t.dynamicDataSource?c.from(t.dynamicDataSource):e.dynamicDataSource);const i=e?.infoFor3D;if(null!=i&&Wt(t,i)){s=s===t?s.clone():s,s.formatOf3DObjects=null;const{supportedFormats:e,queryFormats:n}=i,r=gt("model/gltf-binary",e)??pt("glb",e),l=gt("model/gltf+json",e)??pt("gtlf",e);for(const t of n){if(t===r){s.formatOf3DObjects=t;break}t!==l||s.formatOf3DObjects||(s.formatOf3DObjects=t)}if(!s.formatOf3DObjects)throw new f("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==s.outFields||!s.outFields.includes("*")){s=s===t?s.clone():s,null==s.outFields&&(s.outFields=[]);const{originX:e,originY:n,originZ:r,translationX:l,translationY:a,translationZ:h,scaleX:u,scaleY:o,scaleZ:c,rotationX:f,rotationY:d,rotationZ:w,rotationDeg:y}=i.transformFieldRoles;s.outFields.push(e,n,r,l,a,h,u,o,c,f,d,w,y)}}return s}function Wt(t,e){return null!=e&&!0===t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}class Kt extends Q{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return C}end(){return this._layer}optimisePagingFeatureQueries(t){this._pageJustIds=t}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(t){const e=this.urlQueryPath+","+x(t.toJSON());return r(e,l.String)}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ,this.hasM=!0===this._layer?.capabilities?.data?.supportsM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}if(this._layer.source&&this._layer.source.sourceJSON){const t=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=R.StandardisedNoInterval,null!=t&&t>=10.61&&(this._databaseType=R.Standardised)):null!=t&&(t>=10.5&&(this._databaseType=R.StandardisedNoInterval,this._requestStandardised=!0),t>=10.61&&(this._databaseType=R.Standardised))}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this._layer instanceof yt?(this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,this.types=null,this.typeIdField=null):(this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types,this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes)}_isInFeatureSet(){return T.InFeatureSet}async _refineSetBlock(t){return t}_candidateIdTransform(t){return t}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,e}return this._wset}async _runDatabaseProbe(t){await this._ensureLoaded();const e=new o;this.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),e.where=t.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(e),!0}catch(t){return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(t){const e=this._layer?.capabilities?.query;return!t.outStatistics&&!0===e?.supportsFormatPBF&&!0===e?.supportsQuantizationEditMode}async queryPBF(t){return t.quantizationParameters={mode:"edit"},(await Ut(this._layer.parsedUrl,t,{format:"pbf"},{})).unquantize()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(t,e){t.returnZ=this.hasZ,t.returnM=this.hasM;const s="execute"===e?St:"executeForCount"===e?It:_t,i="execute"===e&&this.pbfSupportedForQuery(t);let n=null;if(this.recentlyUsedQueries){const e=this.convertQueryToLruCacheKey(t);n=this.recentlyUsedQueries.getFromCache(e),null===n&&(n=!0!==i?s(this._layer.parsedUrl.path,t):this.queryPBF(t),this.recentlyUsedQueries.addToCache(e,n),n=n.catch((t=>{throw this.recentlyUsedQueries?.removeFromCache(e),t})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:t,method:e}),null===n&&(n=!0!==i?s(this._layer.parsedUrl.path,t):this.queryPBF(t)),n}async _getFilteredSet(t,e,s,i,n){const r=await this.databaseType();if(this.isTable()&&e&&null!==t&&""!==t){return new J([],[],!0,null)}if(this._canUsePagination())return this._getFilteredSetUsingPaging(t,e,s,i,n);let l="",a=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=i.constructClause(),a=!0);const h=new o;this.datesInUnknownTimezone&&(h.timeReferenceUnknownClient=!0),h.where=null===s?null===e?"1=1":"":Y(s,r),this._requestStandardised&&(h.sqlFormat="standard"),h.spatialRelationship=this._makeRelationshipEnum(t),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==l?l.split(","):null,h.geometry=null===e?null:e,h.relationParameter=this._makeRelationshipParam(t);let u=await this.executeQuery(h,"executeForIds");null===u&&(u=[]),this._checkCancelled(n);return new J([],u,a,null)}_expandPagedSet(t,e,s,i,n){return this._expandPagedSetFeatureSet(t,e,s,i,n)}async _getFilteredSetUsingPaging(t,e,s,i,n){let r="",l=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(r=i.constructClause(),l=!0);const a=await this.databaseType();let h=null===s?null===e?"1=1":"":Y(s,a);this._layer.definitionExpression&&this._useDefinitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression);let u=this._maxQueryRate();const o=this._layer.capabilities?.query.maxRecordCount;null!=o&&o<u&&(u=o);let c=null;if(!0===this._pageJustIds)c=new J([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:this._layer.objectIdField,resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:r,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let s=!0;!0===this._removeGeometry&&(s=!1);const i=this._overrideFields??this._fieldsIncludingObjectId(["*"]);c=new J([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:i.join(","),resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:r,returnGeometry:s,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return await this._expandPagedSet(c,u,0,1,n),c}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}async _getPhysicalPage(t,e,s){const i=t.pagesDefinition.internal.lastRetrieved,n=i,r=t.pagesDefinition.internal.lastPage,l=new o;this._requestStandardised&&(l.sqlFormat="standard"),this.datesInUnknownTimezone&&(l.timeReferenceUnknownClient=!0),l.spatialRelationship=t.pagesDefinition.spatialRel,l.relationParameter=t.pagesDefinition.relationParam,l.outFields=t.pagesDefinition.outFields.split(","),l.num=t.pagesDefinition.resultRecordCount,l.start=t.pagesDefinition.internal.lastPage,l.geometry=t.pagesDefinition.geometry,l.where=t.pagesDefinition.where,l.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=t.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference;const a=await this.executeQuery(l,"execute");if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return"done";const h=this._layer.objectIdField;for(let e=0;e<a.features.length;e++)t.pagesDefinition.internal.set[n+e]=a.features[e].attributes[h];if(!1===this._pageJustIds)for(let t=0;t<a.features.length;t++)this._featureCache[a.features[t].attributes[h]]=a.features[t];return(void 0===a.exceededTransferLimit&&a.features.length!==t.pagesDefinition.resultRecordCount||!1===a.exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=i+a.features.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,"done"}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice(0);if(e.includes("*"))return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}async _getFeatures(t,e,s,i){const n=[];if(-1!==e&&void 0===this._featureCache[e]&&n.push(e),!0===this._checkIfNeedToExpandKnownPage(t,this._maxProcessingRate()))return await this._expandPagedSet(t,this._maxProcessingRate(),0,0,i),this._getFeatures(t,e,s,i);let r=0;for(let i=t._lastFetchedIndex;i<t._known.length;i++){if(t._lastFetchedIndex+=1,r++,void 0===this._featureCache[t._known[i]]){let s=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const e=this._layer._mode;if(void 0!==e._featureMap[t._known[i]]){const n=e._featureMap[t._known[i]];null!==n&&(s=!0,this._featureCache[t._known[i]]=n)}}if(!1===s&&(t._known[i]!==e&&n.push(t._known[i]),n.length>=this._maxProcessingRate()-1))break}if(r>=s&&0===n.length)break}if(0===n.length)return"success";const l=new o;this._requestStandardised&&(l.sqlFormat="standard"),this.datesInUnknownTimezone&&(l.timeReferenceUnknownClient=!0),l.objectIds=n,l.outFields=this._overrideFields??this._fieldsIncludingObjectId(["*"]),l.returnGeometry=!0,!0===this._removeGeometry&&(l.returnGeometry=!1),l.outSpatialReference=this.spatialReference;const a=await this.executeQuery(l,"execute");if(this._checkCancelled(i),void 0!==a.error)throw new B(q.RequestFailed,{reason:a.error});const h=this._layer.objectIdField;for(let t=0;t<a.features.length;t++)this._featureCache[a.features[t].attributes[h]]=a.features[t];return"success"}async _getDistinctPages(t,e,s,i,n,r,l,a,h){await this._ensureLoaded();const u=await this.databaseType();let c=s.parseTree.column;const f=this._layer.fields??[];for(let t=0;t<f.length;t++)if(f[t].name.toLowerCase()===c.toLowerCase()){c=f[t].name;break}const d=new o;this._requestStandardised&&(d.sqlFormat="standard"),this.datesInUnknownTimezone&&(d.timeReferenceUnknownClient=!0);let w=null===r?null===n?"1=1":"":Y(r,u);this._layer.definitionExpression&&this._useDefinitionExpression&&(w=""!==w?"(("+this._layer.definitionExpression+") AND ("+w+"))":this._layer.definitionExpression),d.where=w,d.spatialRelationship=this._makeRelationshipEnum(i),d.relationParameter=this._makeRelationshipParam(i),d.geometry=null===n?null:n,d.returnDistinctValues=!0,d.returnGeometry=!1,d.outFields=[c];const y=await this.executeQuery(d,"execute");if(this._checkCancelled(h),!y.hasOwnProperty("features"))throw new B(q.InvalidStatResponse);let g=!1;for(let t=0;t<f.length;t++)if(f[t].name===c){"date"===f[t].type&&(g=!0);break}for(let t=0;t<y.features.length;t++){if(g){const e=y.features[t].attributes[c];null!==e?a.push(new Date(e)):a.push(e)}else a.push(y.features[t].attributes[c]);if(a.length>=l)break}if(0===y.features.length)return a;if(y.features.length===this._layer.capabilities?.query.maxRecordCount&&a.length<l){return{calculated:!0,result:await this._getDistinctPages(t+y.features.length,e,s,i,n,r,l,a,h)}}return a}async _distinctStat(t,e,s,i,n,r,l){return{calculated:!0,result:await this._getDistinctPages(0,t,e,s,i,n,r,[],l)}}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}async _countstat(t,e,s,i){const n=await this.databaseType(),r=new o;if(this._requestStandardised&&(r.sqlFormat="standard"),this.isTable()&&s&&null!==e&&""!==e)return{calculated:!0,result:0};let l=null===i?null===s?"1=1":"":Y(i,n);this._layer.definitionExpression&&this._useDefinitionExpression&&(l=""!==l?"(("+this._layer.definitionExpression+") AND ("+l+"))":this._layer.definitionExpression),r.where=l,this.datesInUnknownTimezone&&(r.timeReferenceUnknownClient=!0),r.where=l,r.spatialRelationship=this._makeRelationshipEnum(e),r.relationParameter=this._makeRelationshipParam(e),r.geometry=null===s?null:s,r.returnGeometry=!1;return{calculated:!0,result:await this.executeQuery(r,"executeForCount")}}async _stats(t,e,s,i,n,r,l){await this._ensureLoaded();const a=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,h=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===t)return u?this._countstat(t,s,i,n):{calculated:!1};if(!1===h||!1===lt(e)&&!1===a||!1===e.isStandardized)return""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,r,l);if("distinct"===t)return!1===u?""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,r,l):this._distinctStat(t,e,s,i,n,r,l);const c=await this.databaseType();if(this.isTable()&&i&&null!==s&&""!==s)return{calculated:!0,result:null};const f=new o;this._requestStandardised&&(f.sqlFormat="standard");let w=null===n?null===i?"1=1":"":Y(n,c);this._layer.definitionExpression&&this._useDefinitionExpression&&(w=""!==w?"(("+this._layer.definitionExpression+") AND ("+w+"))":this._layer.definitionExpression),f.where=w,f.spatialRelationship=this._makeRelationshipEnum(s),f.relationParameter=this._makeRelationshipParam(s),f.geometry=null===i?null:i,this.datesInUnknownTimezone&&(f.timeReferenceUnknownClient=!0);const y=new d;y.statisticType=ut(t),y.onStatisticField=Y(e,c),y.outStatisticFieldName="ARCADE_STAT_RESULT",f.returnGeometry=!1;let g="ARCADE_STAT_RESULT";f.outStatistics=[y];const p=await this.executeQuery(f,"execute");if(!p.hasOwnProperty("features")||0===p.features.length)throw new B(q.InvalidStatResponse);let m=!1;const S=p.fields??[];for(let t=0;t<S.length;t++)if("ARCADE_STAT_RESULT"===S[t].name.toUpperCase()){g=S[t].name,"date"===S[t].type&&(m=!0);break}if(m){let t=p.features[0].attributes[g];return null!==t&&(t=new Date(p.features[0].attributes[g])),{calculated:!0,result:t}}return{calculated:!0,result:p.features[0].attributes[g]}}_stat(t,e,s,i,n,r,l){return this._stats(t,e,s,i,n,r,l)}async _canDoAggregates(t,e){await this._ensureLoaded();let s=!1;const i=this._layer.capabilities?.query,n=!0===i?.supportsSqlExpression;if(null!=i&&!0===i.supportsStatistics&&!0===i.supportsOrderBy&&(s=!0),s)for(let t=0;t<e.length-1;t++)(!1===e[t].workingexpr?.isStandardized||!1===lt(e[t].workingexpr)&&!1===n)&&(s=!1);return!1!==s}_makeRelationshipEnum(t){if(t.includes("esriSpatialRelRelation"))return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.includes("esriSpatialRelRelation")?t.split(":")[1]:""}async _getAggregatePagesDataSourceDefinition(t,e,s,i,n,r,l){await this._ensureLoaded();const a=await this.databaseType();let h="",u=!1,o=!1;null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(h=r.constructClause(),o=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(o=!1,u=!0,h=this._layer.objectIdField);const c=[];for(let t=0;t<e.length;t++){const s=new d;s.onStatisticField=null!==e[t].workingexpr?Y(e[t].workingexpr,a):"",s.outStatisticFieldName=e[t].field,s.statisticType=e[t].toStatisticsName(),c.push(s)}""===h&&(h=t.join(","));let f=this._maxQueryRate();const w=this._layer.capabilities?.query.maxRecordCount;null!=w&&w<f&&(f=w);let y=null===n?null===i?"1=1":"":Y(n,a);this._layer.definitionExpression&&this._useDefinitionExpression&&(y=""!==y?"(("+this._layer.definitionExpression+") AND ("+y+"))":this._layer.definitionExpression);return new J([],["GETPAGES"],o,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:u,generatedOid:l,resultRecordCount:f,resultOffset:0,groupByFieldsForStatistics:t,outStatistics:c,geometry:null===i?null:i,where:y,orderByFields:h,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}async _getAgregagtePhysicalPage(t,e,i){let n=t.pagesDefinition.where;!0===t.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+t.pagesDefinition.generatedOid+">"+t.pagesDefinition.internal.lastMaxId.toString()+")":t.pagesDefinition.generatedOid+">"+t.pagesDefinition.internal.lastMaxId.toString());const r=t.pagesDefinition.internal.lastRetrieved,l=r,a=t.pagesDefinition.internal.lastPage,h=new o;if(this._requestStandardised&&(h.sqlFormat="standard"),h.where=n,h.spatialRelationship=t.pagesDefinition.spatialRel,h.relationParameter=t.pagesDefinition.relationParam,h.outFields=t.pagesDefinition.outFields,h.outStatistics=t.pagesDefinition.outStatistics,h.geometry=t.pagesDefinition.geometry,h.groupByFieldsForStatistics=t.pagesDefinition.groupByFieldsForStatistics,h.num=t.pagesDefinition.resultRecordCount,h.start=t.pagesDefinition.internal.lastPage,h.returnGeometry=t.pagesDefinition.returnGeometry,this.datesInUnknownTimezone&&(h.timeReferenceUnknownClient=!0),h.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,this.isTable()&&h.geometry&&h.spatialRelationship)return[];const u=await this.executeQuery(h,"execute");if(this._checkCancelled(i),!u.hasOwnProperty("features"))throw new B(q.InvalidStatResponse);const c=[];if(t.pagesDefinition.internal.lastPage!==a)return[];u.features.length>0&&void 0===u.features[0].attributes[t.pagesDefinition.generatedOid]&&(t.pagesDefinition.generatedOid=t.pagesDefinition.generatedOid.toLowerCase());for(let e=0;e<u.features.length;e++)t.pagesDefinition.internal.set[l+e]=u.features[e].attributes[t.pagesDefinition.generatedOid];for(let t=0;t<u.features.length;t++)c.push(new s({attributes:u.features[t].attributes,geometry:null}));return!0===t.pagesDefinition.useOIDpagination?0===u.features.length?t.pagesDefinition.internal.fullyResolved=!0:t.pagesDefinition.internal.lastMaxId=u.features[u.features.length-1].attributes[t.pagesDefinition.generatedOid]:(void 0===u.exceededTransferLimit&&u.features.length!==t.pagesDefinition.resultRecordCount||!1===u.exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=r+u.features.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,c}static create(t,e,s,i,n){const r=new w({url:t,outFields:null===e?["*"]:e});return new Kt({layer:r,spatialReference:s,lrucache:i,interceptor:n})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON?.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return P(this._layer.parsedUrl.path)}async queryAttachments(t,e,s,i,n){const r=this._layer.capabilities;if(r?.data.supportsAttachment&&r?.operations.supportsQueryAttachments){const r={objectIds:[t],returnMetadata:n};(e&&e>0||s&&s>0)&&(r.size=[e&&e>0?e:0,s&&s>0?s:e+1]),i&&i.length>0&&(r.attachmentTypes=i),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:r,method:"attachments"});const l=await this._layer.queryAttachments(r),a=[];return l&&l[t]&&l[t].forEach((e=>{const s=this._layer.parsedUrl.path+"/"+t.toString()+"/attachments/"+e.id.toString();let i=null;n&&e.exifInfo&&(i=G.convertJsonToArcade(e.exifInfo,"system",!0)),a.push(new M(e.id,e.name,e.contentType,e.size,s,i,e.keywords??null))})),a}return[]}async queryRelatedFeatures(t){const e={f:"json",relationshipId:t.relationshipId.toString(),definitionExpression:t.where,outFields:t.outFields?.join(","),returnGeometry:t.returnGeometry.toString()};void 0!==t.resultOffset&&null!==t.resultOffset&&(e.resultOffset=t.resultOffset.toString()),void 0!==t.resultRecordCount&&null!==t.resultRecordCount&&(e.resultRecordCount=t.resultRecordCount.toString()),t.orderByFields&&(e.orderByFields=t.orderByFields.join(",")),t.objectIds&&t.objectIds.length>0&&(e.objectIds=t.objectIds.join(",")),t.outSpatialReference&&(e.outSR=y(t.outSpatialReference)),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:e,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});const i=await g(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:e});if(i.data){const t={},e=i.data;if(e?.relatedRecordGroups){const i=e.spatialReference;for(const n of e.relatedRecordGroups){const r=n.objectId,l=[];for(const t of n.relatedRecords){t.geometry&&(t.geometry.spatialReference=i);const e=new s({geometry:t.geometry?p(t.geometry):null,attributes:t.attributes});l.push(e)}t[r]={features:l,exceededTransferLimit:!0===e.exceededTransferLimit}}}return t}throw new B(q.InvalidRequest)}async getFeatureByObjectId(t,e){const s=new o;s.outFields=e,s.returnGeometry=!1,s.outSpatialReference=this.spatialReference,s.where=this.objectIdField+"="+t.toString(),this.datesInUnknownTimezone&&(s.timeReferenceUnknownClient=!0),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:s,method:"execute"});const i=await St(this._layer.parsedUrl.path,s);return 1===i.features.length?i.features[0]:null}async getIdentityUser(){await this.load();const t=m?.findCredential(this._layer.url);return t?t.userId:null}async getOwningSystemUrl(){await this.load();const t=m?.findServerInfo(this._layer.url);if(t)return t.owningSystemUrl;let e=this._layer.url;const s=e.toLowerCase().indexOf("/rest/services");if(e=s>-1?e.substring(0,s):e,e){e+="/rest/info";try{const t=await g(e,{query:{f:"json"}});let s="";return t.data?.owningSystemUrl&&(s=t.data.owningSystemUrl),s}catch(t){return""}}return""}getDataSourceFeatureSet(){const t=new Kt({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return t._useDefinitionExpression=!1,t}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone}get editFieldsInfo(){return this._layer.editFieldsInfo??null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){if(this.fsetInfo)return this.fsetInfo;let t=null,{parsedUrl:{path:e},serviceItemId:s=null}=this._layer;if(e){const i=await g(e,{responseType:"json",query:{f:"json"}});t=i?.data?.name??null,s=i?.data?.serviceItemId??null}const i=this._layer.title&&null!==(this._layer.parent??null);return this.featureSetInfo={layerId:this._layer.layerId,layerName:""===t?null:t,itemId:""===s?null:s,serviceLayerUrl:""===e?null:e,webMapLayerId:i?this._layer.id??null:null,webMapLayerTitle:i?this._layer.title??null:null,className:null,objectClassId:null},this.fsetInfo}}class Qt extends Q{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,!0===t.isTable&&(this._forceIsTable=!0),void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return C}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this._databaseType=R.Standardised,this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ,this.hasM=!0===this._layer?.capabilities?.data?.supportsM,this._layer instanceof yt?(this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,this.types=null,this.typeIdField=null):(this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types,this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes)}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return T.InFeatureSet}_candidateIdTransform(t){return t}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,e}return this._wset}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new s({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}async _getFilteredSet(t,e,s,i,n){let r="",l=!1;if(null!==i&&(r=i.constructClause(),l=!0),this.isTable()&&e&&null!==t&&""!==t){return new J([],[],!0,null)}const a=new o;a.returnZ=this.hasZ,a.returnM=this.hasM,a.where=null===s?null===e?"1=1":"":Y(s,R.Standardised),a.spatialRelationship=this._makeRelationshipEnum(t),a.outSpatialReference=this.spatialReference,a.orderByFields=""!==r?r.split(","):null,a.geometry=null===e?null:e,a.returnGeometry=!0,a.relationParameter=this._makeRelationshipParam(t);const h=await this._layer.queryFeatures(a);if(null===h)return new J([],[],l,null);this._checkCancelled(n);const u=[];h.features.forEach((t=>{const e=t.attributes[this._layer.objectIdField];u.push(e),this._featureCache[e]=this._changeFeature(t)}));return new J([],u,l,null)}_makeRelationshipEnum(t){if(t.includes("esriSpatialRelRelation"))return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.includes("esriSpatialRelRelation")?t.split(":")[1]:""}async _queryAllFeatures(){if(this._wset)return this._wset;const t=new o;if(t.where="1=1",await this._ensureLoaded(),this._layer.source&&this._layer.source.items){const t=[];return this._layer.source.items.forEach((e=>{const s=e.attributes[this._layer.objectIdField];t.push(s),this._featureCache[s]=this._changeFeature(e)})),this._wset=new J([],t,!1,null),this._wset}t.returnZ=this.hasZ,t.returnM=this.hasM;const e=await this._layer.queryFeatures(t),s=[];return e.features.forEach((t=>{const e=t.attributes[this._layer.objectIdField];s.push(e),this._featureCache[e]=this._changeFeature(t)})),this._wset=new J([],s,!1,null),this._wset}async _getFeatures(t,e,s){const i=[];-1!==e&&void 0===this._featureCache[e]&&i.push(e);for(let n=t._lastFetchedIndex;n<t._known.length&&(t._lastFetchedIndex+=1,!(void 0===this._featureCache[t._known[n]]&&(t._known[n]!==e&&i.push(t._known[n]),i.length>s)));n++);if(0===i.length)return"success";throw new B(q.MissingFeatures)}async _refineSetBlock(t){return t}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(t){const e={};for(const s in t)e[s]=t[s];return e}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(t,e){let s=t.layerDefinition.objectIdField;const i=t.layerDefinition.typeIdField??"",r=[];if(t.layerDefinition.types)for(const e of t.layerDefinition.types)r.push(S.fromJSON(e));let l=t.layerDefinition.geometryType;void 0===l&&(l=t.featureSet.geometryType||"");let a=t.featureSet.features;const h=e.toJSON();if(!s){let e=!1;for(const i of t.layerDefinition.fields)if("oid"===i.type||"esriFieldTypeOID"===i.type){s=i.name,e=!0;break}if(!1===e){let e="FID",i=!0,n=0;for(;i;){let s=!0;for(const i of t.layerDefinition.fields)if(i.name===e){s=!1;break}!0===s?i=!1:(n++,e="FID"+n.toString())}t.layerDefinition.fields.push({type:"esriFieldTypeOID",name:e,alias:e});const r=[];for(let s=0;s<a.length;s++)r.push({geometry:t.featureSet.features[s].geometry,attributes:t.featureSet.features[s].attributes?this._cloneAttr(t.featureSet.features[s].attributes):{}}),r[s].attributes[e]=s;a=r,s=e}}const u=[];for(const e of t.layerDefinition.fields)e instanceof n?u.push(e):u.push(n.fromJSON(e));let o=l;switch(o||(o=""),o){case"esriGeometryPoint":o="point";break;case"esriGeometryPolyline":o="polyline";break;case"esriGeometryPolygon":o="polygon";break;case"esriGeometryEnvelope":o="extent";break;case"esriGeometryMultipoint":o="multipoint";break;case"":case"esriGeometryNull":o="esriGeometryNull"}if("esriGeometryNull"!==o)for(const t of a)t.geometry&&t.geometry instanceof F==!1&&(t.geometry.type=o,void 0===t.geometry.spatialReference&&(t.geometry.spatialReference=h));else for(const t of a)t.geometry&&(t.geometry=null);const c={outFields:["*"],source:a,fields:u,hasZ:!0===t?.layerDefinition?.hasZ||!0===t?.featureSet?.hasZ,hasM:!0===t?.layerDefinition?.hasM||!0===t?.featureSet?.hasM,types:r,typeIdField:i,objectIdField:s,spatialReference:e},f="esriGeometryNull"===o||null===o;f||(c.geometryType=o);const d=new w(c);t?.layerDefinition?.subtypeField&&t?.layerDefinition?.subtypes&&d.read({subtypes:t.layerDefinition.subtypes,subtypeField:t.layerDefinition.subtypeField});return new Qt({layer:d,spatialReference:e,isTable:f})}async queryAttachments(){return[]}async getFeatureByObjectId(t){const e=new o;e.where=this.objectIdField+"="+t.toString(),e.returnZ=this.hasZ,e.returnM=this.hasM;const s=await this._layer.queryFeatures(e);return 1===s.features.length?s.features[0]:null}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer?.datesInUnknownTimezone}get editFieldsInfo(){return this._layer?.editFieldsInfo}get timeInfo(){return this._layer?.timeInfo}async getFeatureSetInfo(){const t=this._layer.title&&this._layer.parent;return this.fsetInfo??{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:t?this._layer.id??null:null,webMapLayerTitle:t?this._layer.title??null:null,className:null,objectClassId:null}}}class Jt extends Q{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,this._findObjectId=t.objectId,this.featureObjectId=t.objectId,this.relationship=t.relationship,this._relatedLayer=t.relatedLayer,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return C}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return await Promise.all([this._layer.load(),this._relatedLayer?.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}const t=this._layer.nativeCapabilities();t&&(this._databaseType=t.databaseType,this._requestStandardised=t.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return await this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return T.InFeatureSet}_candidateIdTransform(t){return t}async _getSet(t){if(null===this._wset){await this._ensureLoaded();const e=await this._getFilteredSet("",null,null,null,t);return this._wset=e,e}return this._wset}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new s({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}async _getFilteredSet(t,e,s,i,n){if(await this.databaseType(),this.isTable()&&e&&null!==t&&""!==t){return new J([],[],!0,null)}const r=this._layer.nativeCapabilities();if(!1===r.canQueryRelated){return new J([],[],!0,null)}if(r.capabilities?.queryRelated&&r.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(t,e,s,i,n);let l="",a=!1;null!==i&&r.capabilities?.queryRelated&&!0===r.capabilities.queryRelated.supportsOrderBy&&(l=i.constructClause(),a=!0);const h=new I;h.objectIds=[this._findObjectId];const u=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((t=>t.name)):["*"]);h.outFields=u,h.relationshipId=this.relationship.id,h.where="1=1";let o=!0;!0===this._removeGeometry&&(o=!1),h.returnGeometry=o,this._requestStandardised&&(h.sqlFormat="standard"),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==l?l.split(","):null;const c=await r.source.queryRelatedFeatures(h);this._checkCancelled(n);const f=c[this._findObjectId]?c[this._findObjectId].features:[],d=[];for(let t=0;t<f.length;t++)this._featureCache[f[t].attributes[this._relatedLayer.objectIdField]]=f[t],d.push(f[t].attributes[this._relatedLayer.objectIdField]);const w=e&&null!==t&&""!==t,y=null!=s;return new J(w||y?d:[],w||y?[]:d,a,null)}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice(0);if(e.includes("*"))return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}async _getFilteredSetUsingPaging(t,e,s,i,n){let r="",l=!1;const a=this._layer.nativeCapabilities();null!==i&&a?.capabilities?.queryRelated&&!0===a.capabilities.queryRelated.supportsOrderBy&&(r=i.constructClause(),l=!0),await this.databaseType();const h="1=1";let u=this._maxQueryRate();const o=a.capabilities?.query.maxRecordCount;null!=o&&o<u&&(u=o);const c=e&&null!==t&&""!==t,f=null!=s;let d=null,w=!0;!0===this._removeGeometry&&(w=!1);const y=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((t=>t.name)):["*"]);return d=new J(c||f?["GETPAGES"]:[],c||f?[]:["GETPAGES"],l,{outFields:y.join(","),resultRecordCount:u,resultOffset:0,objectIds:[this._findObjectId],where:h,orderByFields:r,returnGeometry:w,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),await this._expandPagedSet(d,u,0,0,n),d}_expandPagedSet(t,e,s,i,n){return this._expandPagedSetFeatureSet(t,e,s,i,n)}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}async _getPhysicalPage(t,e,s){const i=t.pagesDefinition.internal.lastRetrieved,n=i,r=t.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),a=new I;!0===this._requestStandardised&&(a.sqlFormat="standard"),a.relationshipId=this.relationship.id,a.objectIds=t.pagesDefinition.objectIds,a.resultOffset=t.pagesDefinition.internal.lastPage,a.resultRecordCount=t.pagesDefinition.resultRecordCount,a.outFields=t.pagesDefinition.outFields.split(","),a.where=t.pagesDefinition.where,a.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=t.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference;const h=await l.source.queryRelatedFeatures(a);if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return 0;const u=h[this._findObjectId]?h[this._findObjectId].features:[];for(let e=0;e<u.length;e++)t.pagesDefinition.internal.set[n+e]=u[e].attributes[this._relatedLayer.objectIdField];for(let t=0;t<u.length;t++)this._featureCache[u[t].attributes[this._relatedLayer.objectIdField]]=u[t];const o=!h[this._findObjectId]||!1===h[this._findObjectId].exceededTransferLimit;return u.length!==t.pagesDefinition.resultRecordCount&&o&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=i+u.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,u.length}async _getFeatures(t,e,s,i){const n=[];-1!==e&&void 0===this._featureCache[e]&&n.push(e);const r=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,r))return await this._expandPagedSet(t,r,0,0,i),this._getFeatures(t,e,s,i);let l=0;for(let i=t._lastFetchedIndex;i<t._known.length&&(l++,l<=s&&(t._lastFetchedIndex+=1),!("GETPAGES"!==t._known[i]&&void 0===this._featureCache[t._known[i]]&&(t._known[i]!==e&&n.push(t._known[i]),n.length>s)))&&!(l>=s&&0===n.length);i++);if(0===n.length)return"success";throw new B(q.MissingFeatures)}async _refineSetBlock(t,e,s){return t}async _stat(t,e,s,i,n,r,l){return{calculated:!1}}get gdbVersion(){return this._relatedLayer.gdbVersion}async _canDoAggregates(t,e,s,i,n){return!1}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(t,e,s,i,n){return this._relatedLayer.queryAttachments(t,e,s,i,n)}getFeatureByObjectId(t,e){return this._relatedLayer.getFeatureByObjectId(t,e)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){return this._relatedLayer?.preferredTimeZone??null}get dateFieldsTimeZone(){return this._relatedLayer?.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._relatedLayer?.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer?.editFieldsInfo??null}get timeInfo(){return this._relatedLayer?.timeInfo??null}async getFeatureSetInfo(){return this.fsetInfo??this._layer.featureSetInfo}}function Xt(){null===ct.applicationCache&&(ct.applicationCache=new ct)}async function Zt(t,e){if(ct.applicationCache){const s=ct.applicationCache.getLayerInfo(t);if(s){const i=await s;return new w({url:t,outFields:e,sourceJSON:i})}const i=new w({url:t,outFields:e}),n=(async()=>(await i.load(),i.sourceJSON))();if(ct.applicationCache){ct.applicationCache.setLayerInfo(t,n);try{return await n,i}catch(e){throw ct.applicationCache.clearLayerInfo(t),e}}return await n,i}return new w({url:t,outFields:e})}async function Yt(t,e,s,i,n,r=null){return zt(await Zt(t,["*"]),e,s,i,n,r)}function zt(t,e=null,s=null,i=!0,n=null,r=null){if(t instanceof w||j(t)){const l={layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:n,interceptor:r};return!0==!(t.url||!t.source)?new Qt(l):new Kt(l)}const l=zt(t.parent,e,s,i,n,r);return l.filter(L.create(t.parent.subtypeField+"="+t.subtypeCode.toString(),t.parent.fieldsIndex,l.dateFieldsTimeZoneDefaultUTC))}async function Ht(t){if(null!==ct.applicationCache){const e=ct.applicationCache.getLayerInfo(t);if(null!==e)return e}const e=(async()=>{const e=await g(t,{responseType:"json",query:{f:"json"}});return e.data?e.data:null})();if(null!==ct.applicationCache){ct.applicationCache.setLayerInfo(t,e);try{return await e}catch(e){throw ct.applicationCache.clearLayerInfo(t),e}}return e}async function $t(t,e){const s="QUERYDATAELEMTS:"+e.toString()+":"+t;if(null!==ct.applicationCache){const t=ct.applicationCache.getLayerInfo(s);if(null!==t)return t}const i=(async()=>{const s=await g(t+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(s.data){const t=s.data;if(t.layerDataElements?.[0])return t.layerDataElements[0]}throw new B(q.DataElementsNotFound)})();if(null!==ct.applicationCache){ct.applicationCache.setLayerInfo(s,i);try{return await i}catch(t){throw ct.applicationCache.clearLayerInfo(s),t}}return i}async function te(t){if(null!==ct.applicationCache){const e=ct.applicationCache.getLayerInfo(t);if(null!==e)return e}const e=(async()=>{const e=await g(t,{responseType:"json",query:{f:"json"}});if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),t}return{layers:[],tables:[]}})();if(null!==ct.applicationCache){ct.applicationCache.setLayerInfo(t,e);try{return await e}catch(e){throw ct.applicationCache.clearLayerInfo(t),e}}return e}async function ee(t,e){const s={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},i=await te(t);if(s.metadata=i,void 0!==i.controllerDatasetLayers?.utilityNetworkLayerId&&null!==i.controllerDatasetLayers.utilityNetworkLayerId){if(i.layers)for(const t of i.layers)s.layerNameLkp[t.id]=t.name;if(i.tables)for(const t of i.tables)s.layerNameLkp[t.id]=t.name;const n=i.controllerDatasetLayers.utilityNetworkLayerId;s.networkId=n;const r=await $t(t,n);if(r){s.queryelem=r,s.queryelem?.dataElement&&void 0!==s.queryelem.dataElement.schemaGeneration&&(s.unVersion=s.queryelem.dataElement.schemaGeneration),s.lkp={},s.queryelem.dataElement.domainNetworks||(s.queryelem.dataElement.domainNetworks=[]);for(const t of s.queryelem.dataElement.domainNetworks){for(const e of t.edgeSources??[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:s.layerNameLkp[e.layerId]??null};t.className&&(s.lkp[t.className]=t)}for(const e of t.junctionSources??[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:s.layerNameLkp[e.layerId]??null};t.className&&(s.lkp[t.className]=t)}}if(s.queryelem.dataElement.terminalConfigurations)for(const t of s.queryelem.dataElement.terminalConfigurations)for(const e of t.terminals)s.terminals.push({terminalId:e.terminalId,terminalName:e.terminalName});const i=await Ht(t+"/"+n);if(void 0!==i.systemLayers?.associationsTableId&&null!==i.systemLayers.associationsTableId){const n=[];s.unVersion>=4&&(n.push("STATUS"),n.push("PERCENTALONG"));let r=await Yt(t+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...n],!1,null,null);return await r.load(),s.unVersion>=4&&(r=r.filter(L.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",r.getFieldsIndex(),r.dateFieldsTimeZoneDefaultUTC)),await r.load()),{lkp:s.lkp,associations:r,unVersion:s.unVersion,terminals:s.terminals}}return{associations:null,unVersion:s.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:s.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:s.unVersion,lkp:null,terminals:[]}}async function se(t,e,s,i=null,n=null,r=!0,l=null,a=null){let h=t.serviceUrl();if(!h)return null;h="/"===h.charAt(h.length-1)?h+e.relatedTableId.toString():h+"/"+e.relatedTableId.toString();const u=await Yt(h,i,n,r,l,a);return new Jt({layer:t,relatedLayer:u,relationship:e,objectId:s,spatialReference:i,outFields:n,includeGeometry:r,lrucache:l,interceptor:a})}Tt.registerAction(),Mt.registerAction(),Ct.registerAction(),ot.registerAction(),jt.registerAction();class ie extends bt{constructor(t,e=null,s=null,i=null){super(),this._map=t,this._overridespref=e,this._lrucache=s,this._interceptor=i,this._instantLayers=[]}_makeAndAddFeatureSet(t,e=!0,s=null){const i=zt(t,this._overridespref,null===s?["*"]:s,e,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}async featureSetByName(t,e=!0,s=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return await this._map.load(),this.featureSetByName(t,e,s);null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.title===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=this._map.allLayers.find((e=>{if(e instanceof w){if(e.title===t)return!0}else if(j(e)&&e.title===t)return!0;return!1}));if(n)return this._makeAndAddFeatureSet(n,e,s);if(this._map.tables){const i=this._map.tables.find((e=>!!(e.title&&e.title===t||e.title&&e.title===t)));if(i){if(i instanceof w)return this._makeAndAddFeatureSet(i,e,s);if(i._materializedTable);else{const t=i.outFields?i:{...i,outFields:["*"]};i._materializedTable=new w(t)}return await i._materializedTable.load(),this._makeAndAddFeatureSet(i._materializedTable,e,s)}}return null}async featureSetById(t,e=!0,s=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return await this._map.load(),this.featureSetById(t,e,s);null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.id===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=this._map.allLayers.find((e=>{if(e instanceof w){if(e.id===t)return!0}else if(j(e)&&e.id===t)return!0;return!1}));if(n)return this._makeAndAddFeatureSet(n,e,s);if(this._map.tables){const i=this._map.tables.find((e=>e.id===t));if(i){if(i instanceof w)return this._makeAndAddFeatureSet(i,e,s);if(i._materializedTable);else{const t={...i,outFields:["*"]};i._materializedTable=new w(t)}return await i._materializedTable.load(),this._makeAndAddFeatureSet(i._materializedTable,e,s)}}return null}}class ne extends bt{constructor(t,e=null,s=null,i=null){super(),this._url=t,this._overridespref=e,this._lrucache=s,this._interceptor=i,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(t,e=!0,s=null){const i=zt(t,this._overridespref,null===s?["*"]:s,e,this._lrucache);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}async _loadMetaData(){const t=await te(this._url);return this.metadata=t,t}load(){return this._loadMetaData()}clone(){return new ne(this._url,this._overridespref,this._lrucache,this._interceptor)}async featureSetByName(t,e=!0,s=null){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.title===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=await this._loadMetaData();let r=null;for(const e of n.layers??[])e.name===t&&(r=e);if(!r)for(const e of n.tables??[])e.name===t&&(r=e);if(r){const t=await Zt(this._url+"/"+r.id,["*"]);return this._makeAndAddFeatureSet(t,e,s)}return null}async featureSetById(t,e=!0,s=["*"]){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);t=null!=t?t.toString():"";for(let s=0;s<this._instantLayers.length;s++){const n=this._instantLayers[s];if(n.opitem.id===t&&n.includeGeometry===e&&n.outFields===i)return this._instantLayers[s].featureset}const n=await this._loadMetaData();let r=null;for(const e of n.layers??[])null!==e.id&&void 0!==e.id&&e.id.toString()===t&&(r=e);if(!r)for(const e of n.tables??[])null!==e.id&&void 0!==e.id&&e.id.toString()===t&&(r=e);if(r){const t=await Zt(this._url+"/"+r.id,["*"]);return this._makeAndAddFeatureSet(t,e,s)}return null}}function re(t,e,s=null,i=null){return new ie(t,e,s,i)}function le(t,e,s=null,i=null){return new ne(t,e,s,i)}function ae(t,e,s,i,n){if(null===t)return null;if(t instanceof w){switch(e){case"datasource":return zt(t,n,t.outFields,!0,s,i).getDataSourceFeatureSet();case"parent":case"root":return zt(t,n,t.outFields,!0,s,i)}return null}if(j(t)){switch(e){case"datasource":return zt(t,n,t.outFields,!0,s,i).getDataSourceFeatureSet();case"parent":case"root":return zt(t,n,t.outFields,!0,s,i)}return null}if(U(t)){switch(e){case"datasource":return zt(t.parent,n,t.parent.outFields,!0,s,i).getDataSourceFeatureSet();case"parent":case"root":return zt(t,n,t.parent.outFields,!0,s,i)}return null}if(t instanceof Q)switch(e){case"datasource":return t.getDataSourceFeatureSet();case"parent":return t;case"root":return t.getRootFeatureSet()}return null}async function he(t,e,s,i,n,r,l,a=null){if(ct.applicationCache){const h=ct.applicationCache.getLayerInfo(t+":"+r.url);if(h){const t=await h;return zt(new w({url:P(t.url)+"/"+e,outFields:["*"]}),s,i,n,l,a)}}const h=new _({id:t,portal:r}).load();ct.applicationCache&&ct.applicationCache.setLayerInfo(t+":"+r.url,h);try{const t=await h;return zt(new w({url:P(t.url??"")+"/"+e,outFields:["*"]}),s,i,n,l,a)}catch(e){throw ct.applicationCache&&ct.applicationCache.clearLayerInfo(t+":"+r.url),e}}const ue=Object.freeze({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:ee,constructFeatureSet:zt,constructFeatureSetFromPortalItem:he,constructFeatureSetFromRelationship:se,constructFeatureSetFromUrl:Yt,convertToFeatureSet:ae,createFeatureSetCollectionFromMap:re,createFeatureSetCollectionFromService:le,initialiseMetaDataCache:Xt});export{ee as A,Ot as B,Yt as F,Rt as I,Et as L,kt as a,Ct as b,Tt as c,jt as d,bt as e,Qt as f,zt as g,Nt as h,vt as i,ae as j,se as k,ue as l,he as q};
//# sourceMappingURL=p-ac828811.js.map