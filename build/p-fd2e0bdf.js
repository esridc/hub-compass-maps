import{av as t}from"./p-028496e2.js";import{J as n,C as e,r}from"./p-1fb2423d.js";class l{constructor(t=15e3,n=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,n)}decreaseRefCount(t,n){const e=t+"/"+n,r=this._cachedBlocks;if(r.has(e)){const t=r.get(e);return t.refCount--,t.refCount<=0&&(r.delete(e),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,n){const e=t+"/"+n,r=this._cachedBlocks;if(r.has(e)){const t=r.get(e);return t.ts=Date.now(),t.refCount++,r.delete(e),r.set(e,t),t.block}return null}putBlock(t,n,e,r){const l=this._cachedBlocks,s=t+"/"+n;if(l.has(s)){const t=l.get(s);t.ts=Date.now(),t.refCount++}else l.set(s,{block:e,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,n){const e=this._cachedBlocks,r=t+"/"+n;e.has(r)&&e.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const n=Array.from(t),e=Date.now();for(let r=0;r<n.length&&n[r][1].ts<=e-this._duration;r++)t.delete(n[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const n=Array.from(t);for(let e=0;e<n.length-this._size;e++)t.delete(n[e][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}const s=new Map,i=new l;function o(t,n){return null==n?t:`${t}?sliceId=${n}`}function u(t,n){const e={extent:null,rasterInfo:n,cache:new Map},r=s.get(t);return r?(r.push(e),r.length-1):(s.set(t,[e]),0)}function c(t,n){const e=s.get(t);e&&(e[n]=null,e.some((t=>null!=t))||s.delete(t))}function f(t,n,e){const r=s.get(t);if(!r)return null==n?i.decreaseRefCount(t,e):0;if(null==n||null==r[n])return i.decreaseRefCount(t,e);const l=r[n]?.cache,o=l?.get(e);if(l&&o){if(o.refCount--,0===o.refCount){l.delete(e);for(let t=0;t<r.length;t++)r[t]?.cache.delete(e);o.controller&&o.controller.abort()}return o.refCount}return 0}function a(t,n,e){const r=s.get(t);if(!r)return null==n?i.getBlock(t,e):null;if(null==n||null==r[n]){for(let t=0;t<r.length;t++){const n=r[t]?.cache.get(e);if(n)return n.refCount++,n.block}return i.getBlock(t,e)}const l=r[n]?.cache.get(e);if(l)return l.refCount++,l.block;for(let t=0;t<r.length;t++){if(t===n||!r[t])continue;const l=r[t]?.cache,s=l?.get(e);if(l&&s)return s.refCount++,l.set(e,s),s.block}return null}function h(t,n,e,r,l=null){const o=s.get(t);if(!o)return void(null==n&&i.putBlock(t,e,r,l));if(null==n||null==o[n])return void i.putBlock(t,e,r,l);const u={refCount:1,block:r,isResolved:!1,isRejected:!1,controller:l};r.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),o[n]?.cache.set(e,u)}function M(t,n,e){const r=s.get(t);r?null!=n&&null!=r[n]?r[n]?.cache.delete(e):i.deleteBlock(t,e):null==n&&i.deleteBlock(t,e)}function p(t,n){const e=s.get(t);return e?e[n]??null:null}function m(l,s,i,o,u,c,f=null){const a=p(l,s);if(!a)return;const h=a.extent,{cache:M,rasterInfo:m}=a;if(h&&h.xmin===i.xmin&&h.xmax===i.xmax&&h.ymin===i.ymin&&h.ymax===i.ymax)return;o=o??0;const d=i.clone().normalize(),{spatialReference:x,transform:y}=m,v=new Set;for(let l=0;l<d.length;l++){const s=d[l];if(s.xmax-s.xmin<=o||s.ymax-s.ymin<=o)continue;let i=n(s,x,f);null!=y&&(i=y.inverseTransform(i));const a=new t({x:o,y:o,spatialReference:s.spatialReference});if(null==u&&!(u=e(a,x,s,f)))return;const{pyramidLevel:h,pyramidResolution:M,excessiveReading:p}=r(u,m,c||"closest");if(p)return;const{storageInfo:R}=m,{origin:w}=R,I={x:Math.max(0,Math.floor((i.xmin-w.x)/M.x)),y:Math.max(0,Math.floor((w.y-i.ymax)/M.y))},g=Math.ceil((i.xmax-i.xmin)/M.x-.1),k=Math.ceil((i.ymax-i.ymin)/M.y-.1),$=h>0?R.pyramidBlockWidth:R.blockWidth,C=h>0?R.pyramidBlockHeight:R.blockHeight,D=1,b=Math.max(0,Math.floor(I.x/$)-D),j=Math.max(0,Math.floor(I.y/C)-D),B=Math.floor((I.x+g-1)/$)+D,S=Math.floor((I.y+k-1)/C)+D;for(let t=j;t<=S;t++)for(let n=b;n<=B;n++)v.add(`${h}/${t}/${n}`)}M.forEach(((t,n)=>{if(!v.has(n)){const t=M.get(n);(null==t||t.isResolved||t.isRejected)&&M.delete(n)}})),a.extent={xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax}}export{c as a,m as g,M as h,o as i,a as m,f as s,u,h as x};
//# sourceMappingURL=p-fd2e0bdf.js.map