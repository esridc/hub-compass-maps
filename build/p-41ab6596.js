import{t,f5 as s,av as i,U as e,fh as a,dK as r,ah as o,ag as h,af as n,cB as p,g8 as c,bt as m,gi as l,gj as d,dA as f,gk as j,an as u,ao as b,ap as w}from"./p-028496e2.js";import{b as g,g as x,d as v}from"./p-2fc84476.js";import{g as y,f as _,b as k}from"./p-f3b54403.js";import{a as S}from"./p-57a8581d.js";import{m as D,u as I}from"./p-a29a1b7a.js";import{t as L}from"./p-b3bc59ae.js";import{$ as M}from"./p-eccdd480.js";import{C as V,e as A}from"./p-1fb2423d.js";import{h as U}from"./p-b0afd947.js";import{w as C,o as E}from"./p-49515cdf.js";import{D as T,G as z,U as B,X as P}from"./p-8567e6fe.js";import{x as q}from"./p-5a65512b.js";import{c as R}from"./p-3e445020.js";import{m as F,d as G}from"./p-711ed159.js";import"./p-3b51db5e.js";import"./p-d1d0c06b.js";import"./p-95e79972.js";import"./p-b362a32c.js";import"./p-262e0e67.js";import"./p-44dc1c97.js";import"./p-eaa7279e.js";import"./p-91f3f02f.js";import"./p-30a1f911.js";import"./p-6f5e77a7.js";import"./p-7b65c278.js";import"./p-94b15954.js";import"./p-6b5df147.js";import"./p-3811f238.js";import"./p-8e631d44.js";import"./p-a925664a.js";import"./p-851e644d.js";import"./p-5c282fdd.js";import"./p-89242a33.js";import"./p-7580bdba.js";import"./p-a62b18ce.js";import"./p-af8cc455.js";import"./p-6339641f.js";import"./p-0b0f20ea.js";import"./p-325c6878.js";import"./p-18b49978.js";import"./p-ecde740d.js";import"./p-3a28ec18.js";import"./p-854d8fad.js";import"./p-1f0b604e.js";import"./p-347800d3.js";import"./p-4f73c6ea.js";import"./p-f87a9f21.js";import"./p-10e5b6ea.js";import"./p-3b8b0ae8.js";import"./p-5b86a937.js";import"./p-bb7a38bc.js";import"./p-2e4751c2.js";import"./p-54d1d89d.js";import"./p-894e6a6a.js";import"./p-7b2fe465.js";import"./p-1e93177b.js";class K{constructor(s){if(this._ownsRctx=!1,s)this._ownsRctx=!1,this._rctx=s;else{if(K._instance)return K._instanceRefCount++,K._instance;K._instanceRefCount=1,K._instance=this,this._ownsRctx=!0;const s=document.createElement("canvas"),i=t(s);i.getExtension("OES_texture_float"),this._rctx=new C(i,{})}const i={applyProjection:!0,bilinear:!1,bicubic:!1},e=E("raster/reproject","raster/reproject",new Map([["a_position",0]]),i);this._program=this._rctx.programCache.acquire(e.shaders.vertexShader,e.shaders.fragmentShader,e.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new U(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(t,e,a=!1){const r=s(t.extent,e),o=new i({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:h,y:n}=V(o,e,t.extent);let p=(h+n)/2;const c=Math.round((r.xmax-r.xmin)/p),m=Math.round((r.ymax-r.ymin)/p);p=(r.width/c+r.height/m)/2;const l=new i({x:p,y:p,spatialReference:r.spatialReference}),d=A({projectedExtent:r,srcBufferExtent:t.extent,pixelSize:l,hasWrapAround:!0,spacing:[16,16]}),f=R(this._rctx,d),j=new G(c,m);j.wrapMode=T.CLAMP_TO_EDGE;const u=new q(this._rctx,j);this._rctx.bindFramebuffer(u),this._rctx.setViewport(0,0,c,m),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(f,1),this._quad.bind();const{width:b=0,height:w=0}=t.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",b,w),this._program.setUniform2fv("u_transformSpacing",d.spacing),this._program.setUniform2fv("u_transformGridSize",d.size),this._program.setUniform2f("u_targetImageSize",c,m),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),f.dispose(),a){const{width:t,height:s}=u,i=new ImageData(t??0,s??0);u.readPixels(0,0,t??0,s??0,z.RGBA,B.UNSIGNED_BYTE,i.data);const e=u.detachColorTexture(P.COLOR_ATTACHMENT0);return u.dispose(),{texture:e,extent:r,imageData:i}}const g=u.detachColorTexture(P.COLOR_ATTACHMENT0);return u.dispose(),{texture:g,extent:r}}reprojectBitmapData(t,s){const i=y(t.bitmapData)?_(t.bitmapData):t.bitmapData,e=new G;e.wrapMode=T.CLAMP_TO_EDGE,e.width=t.bitmapData.width,e.height=t.bitmapData.height;const a=new F(this._rctx,e,i),r=this.reprojectTexture({texture:a,extent:t.extent},s,!0);r.texture.dispose();const o=document.createElement("canvas"),h=r.imageData;o.width=h.width,o.height=h.height;return o.getContext("2d").putImageData(h,0,0),{bitmapData:o,extent:r.extent}}async loadAndReprojectBitmapData(t,s,i){const a=(await e(t,{responseType:"image"})).data,r=document.createElement("canvas");r.width=a.width,r.height=a.height;const o=r.getContext("2d");o.drawImage(a,0,0);const h=o.getImageData(0,0,r.width,r.height);if(s.spatialReference.equals(i))return{bitmapData:h,extent:s};const n=this.reprojectBitmapData({bitmapData:h,extent:s},i);return{bitmapData:n.bitmapData,extent:n.extent}}destroy(){this._ownsRctx?(K._instanceRefCount--,0===K._instanceRefCount&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),K._instance=null)):(this._quad.dispose(),this._program.dispose())}}K._instanceRefCount=0;class N{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}}let W=class extends(D(I)){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new S,this._kmlVisualData=new N,this._fetchController=null,this.allVisiblePoints=new a,this.allVisiblePolylines=new a,this.allVisiblePolygons=new a,this.allVisibleMapImages=new r}async hitTest(t,s){const i=this.layer;return[this._pointsView?.hitTest(t),this._polylinesView?.hitTest(t),this._polygonsView?.hitTest(t)].flat().filter(Boolean).map((s=>(s.layer=i,s.sourceLayer=i,{type:"graphic",graphic:s,layer:i,mapPoint:t})))}update(t){this._polygonsView&&this._polygonsView.processUpdate(t),this._polylinesView&&this._polylinesView.processUpdate(t),this._pointsView&&this._pointsView.processUpdate(t)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new M({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new M({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new M({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",(t=>{t.added.forEach((t=>this._addMapImage(t))),t.removed.forEach((t=>this._removeMapImage(t)))})),o((()=>this.layer.visibleSublayers),(t=>{for(const[t,s]of this._kmlVisualData.allSublayers)s.visibility=0;for(const s of t){const t=this._kmlVisualData.allSublayers.get(s.id);t&&(t.visibility=1)}this._refreshCollections()}))]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new K}detach(){this._fetchController=h(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=n(this._polygonsView),this._polylinesView=n(this._polylinesView),this._pointsView=n(this._pointsView),this._imageReprojector=n(this._imageReprojector)}moveStart(){}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(t){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(t.href,p.fromJSON(t.extent),this.view.spatialReference).then((s=>{const i=new k(s.bitmapData);i.x=s.extent.xmin,i.y=s.extent.ymax,i.resolution=s.extent.width/s.bitmapData.width,i.rotation=t.rotation,this._mapImageContainer.addChild(i),this._bitmapIndex.set(t,i)}))}async _getViewDependentUrl(t,i){const{viewFormat:e,viewBoundScale:a,httpQuery:r}=t;if(null!=e){if(null==i)throw new Error("Loading this network link requires a view state.");let o;if(await c(),null!=a&&1!==a){const t=new p(i.extent);t.expand(a),o=t}else o=i.extent;o=s(o,m.WGS84);const h=s(o,m.WebMercator),n=o.xmin,u=o.xmax,b=o.ymin,w=o.ymax,g=i.size[0]*i.pixelRatio,x=i.size[1]*i.pixelRatio,v=Math.max(h.width,h.height),y={"[bboxWest]":n.toString(),"[bboxEast]":u.toString(),"[bboxSouth]":b.toString(),"[bboxNorth]":w.toString(),"[lookatLon]":o.center.x.toString(),"[lookatLat]":o.center.y.toString(),"[lookatRange]":v.toString(),"[lookatTilt]":"0","[lookatHeading]":i.rotation.toString(),"[lookatTerrainLon]":o.center.x.toString(),"[lookatTerrainLat]":o.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":o.center.x.toString(),"[cameraLat]":o.center.y.toString(),"[cameraAlt]":v.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":g.toString(),"[vertPixels]":x.toString(),"[terrainEnabled]":"0","[clientVersion]":l,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},_=t=>{for(const s in t){let i;for(i in y)t[s]=t[s].replace(i,y[i])}},k=d(e);_(k);let S={};null!=r&&(S=d(r),_(S));const D=f(t.href);D.query={...D.query,...k,...S};return`${D.path}?${j(k)}`}return t.href}async _fetchService(t){const s=new N;await this._loadVisualData(this.layer.url,s,t),this._kmlVisualData=s,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter((t=>this._isSublayerVisible(t.sublayerId))).map((({item:t})=>t))),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter((t=>this._isSublayerVisible(t.sublayerId))).map((({item:t})=>t))),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter((t=>this._isSublayerVisible(t.sublayerId))).map((({item:t})=>t))),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter((t=>this._isSublayerVisible(t.sublayerId))).map((({item:t})=>t)))}_isSublayerVisible(t){const s=this._kmlVisualData.allSublayers.get(t);return!!s?.visibility&&(-1===s.parentFolderId||this._isSublayerVisible(s.parentFolderId))}_loadVisualData(t,s,i){return this._fetchParsedKML(t,i).then((async t=>{for(const e of t.sublayers){s.allSublayers.set(e.id,e);const t=e.points?await g(e.points):[],a=e.polylines?await g(e.polylines):[],r=e.polygons?await g(e.polygons):[],o=e.mapImages||[];if(s.allPoints.push(...t.map((t=>({item:t,sublayerId:e.id})))),s.allPolylines.push(...a.map((t=>({item:t,sublayerId:e.id})))),s.allPolygons.push(...r.map((t=>({item:t,sublayerId:e.id})))),s.allMapImages.push(...o.map((t=>({item:t,sublayerId:e.id})))),e.networkLink){const t=await this._getViewDependentUrl(e.networkLink,this.view.state);await this._loadVisualData(t,s,i)}}}))}_fetchParsedKML(t,s){return x(t,this.layer.spatialReference,this.layer.refreshInterval,s).then((t=>v(t.data)))}_removeMapImage(t){const s=this._bitmapIndex.get(t);s&&(this._mapImageContainer.removeChild(s),this._bitmapIndex.delete(t))}};u([b()],W.prototype,"_pointsView",void 0),u([b()],W.prototype,"_polylinesView",void 0),u([b()],W.prototype,"_polygonsView",void 0),u([b()],W.prototype,"updating",void 0),W=u([w("esri.views.2d.layers.KMLLayerView2D")],W);const $=W;export default $;
//# sourceMappingURL=p-41ab6596.js.map