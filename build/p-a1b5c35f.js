import{b7 as t,an as i,ao as s,ap as a,am as o,di as e,W as n,du as h,d3 as r,g0 as c,g1 as u,fi as l,aO as d,aV as p}from"./p-028496e2.js";import{b as f}from"./p-f3b54403.js";const m=Math.PI/180;function g(t){return t*m}function M(t,i){const s=g(i.rotation),a=Math.abs(Math.cos(s)),o=Math.abs(Math.sin(s)),[e,n]=i.size;return t[0]=Math.round(n*o+e*a),t[1]=Math.round(n*a+e*o),t}function v(t,i,s,a){const[o,e]=i,[n,h]=a,r=.5*s;return t[0]=o-r*n,t[1]=e-r*h,t[2]=o+r*n,t[3]=e+r*h,t}const w=d(),x=[0,0],y=new t(0,0,0,0),S={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let R=class extends o{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=S.hidpi,this.imageMaxWidth=S.imageMaxWidth,this.imageMaxHeight=S.imageMaxHeight,this.imageRotationSupported=S.imageRotationSupported,this.imageNormalizationSupported=S.imageNormalizationSupported,this.update=e((async(t,i)=>{if(n(i),!t.stationary||this.destroyed)return;const s=t.state,a=p(s.spatialReference),o=this.hidpi?t.pixelRatio:1,e=this.imageNormalizationSupported&&s.worldScreenWidth&&s.worldScreenWidth<s.size[0],r=this.imageMaxWidth??0,c=this.imageMaxHeight??0;e?(x[0]=s.worldScreenWidth,x[1]=s.size[1]):this.imageRotationSupported?(x[0]=s.size[0],x[1]=s.size[1]):M(x,s);const u=Math.floor(x[0]*o)>r||Math.floor(x[1]*o)>c,l=a&&(s.extent.xmin<a.valid[0]||s.extent.xmax>a.valid[1]),d=!this.imageNormalizationSupported&&l,f=!u&&!d,m=this.imageRotationSupported?s.rotation:0,g=this.container.children.slice();if(f){const t=e?s.paddedViewState.center:s.center;this._imagePromise&&console.error("Image promise was not defined!"),this._imagePromise=this._singleExport(s,x,t,s.resolution,m,o,i)}else{let t=Math.min(r,c);d&&(t=Math.min(s.worldScreenWidth,t)),this._imagePromise=this._tiledExport(s,t,o,i)}try{const t=await this._imagePromise??[];n(i);const s=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const i of g)t.includes(i)||s.push(i.fadeOut().then((()=>{i.remove(),i.destroy()})));for(const i of t)s.push(i.fadeIn());await Promise.all(s)}catch(t){this._imagePromise=null,h(t)}}),5e3),this.updateExports=e((async t=>{const i=[];for(const s of this.container.children){if(!s.visible||!s.stage)return;i.push(t(s).then((()=>{s.invalidateTexture(),s.requestRender()})))}this._imagePromise=r(i).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,i,s,a,o,e){const h=await this.fetchSource(t,Math.floor(i*o),Math.floor(s*o),{rotation:a,pixelRatio:o,signal:e});n(e);const r=new f(null,!0);return r.x=t.xmin,r.y=t.ymax,r.resolution=t.width/i,r.rotation=a,r.pixelRatio=o,r.opacity=0,this.container.addChild(r),await r.setSourceAsync(h,e),n(e),r}async _singleExport(t,i,s,a,o,e,n){v(w,s,a,i);const h=c(w,t.spatialReference);return[await this._export(h,i[0],i[1],o,e,n)]}_tiledExport(t,i,s,a){const o=u.create({size:i,spatialReference:t.spatialReference,scales:[t.scale]}),e=new l(o),n=e.getTileCoverage(t);if(!n)return null;const h=[];return n.forEach(((o,n,r,u)=>{y.set(o,n,r,0),e.getTileBounds(w,y);const l=c(w,t.spatialReference);h.push(this._export(l,i,i,0,s,a).then((t=>(0!==u&&(y.set(o,n,r,u),e.getTileBounds(w,y),t.x=w[0],t.y=w[3]),t))))})),Promise.all(h)}};i([s()],R.prototype,"_imagePromise",void 0),i([s()],R.prototype,"bitmaps",void 0),i([s()],R.prototype,"container",void 0),i([s()],R.prototype,"fetchSource",void 0),i([s()],R.prototype,"hidpi",void 0),i([s()],R.prototype,"imageMaxWidth",void 0),i([s()],R.prototype,"imageMaxHeight",void 0),i([s()],R.prototype,"imageRotationSupported",void 0),i([s()],R.prototype,"imageNormalizationSupported",void 0),i([s()],R.prototype,"requestUpdate",void 0),i([s()],R.prototype,"updating",null),R=i([a("esri.views.2d.layers.support.ExportStrategy")],R);const _=R;export{_ as v};
//# sourceMappingURL=p-a1b5c35f.js.map