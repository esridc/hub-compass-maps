import{eX as t,r as i,p as s,q as a,ac as o,v as e,a3 as n,P as h,hr as r,jM as c,jN as u,iX as l,eF as p,eL as d}from"./p-aad64c9f.js";import{S as M}from"./p-2527295a.js";const f=Math.PI/180;function m(t){return t*f}function g(t,i){const s=m(i.rotation),a=Math.abs(Math.cos(s)),o=Math.abs(Math.sin(s)),[e,n]=i.size;return t[0]=Math.round(n*o+e*a),t[1]=Math.round(n*a+e*o),t}function v(t,i,s,a){const[o,e]=i,[n,h]=a,r=.5*s;return t[0]=o-r*n,t[1]=e-r*h,t[2]=o+r*n,t[3]=e+r*h,t}const x=p(),w=[0,0],y=new t(0,0,0,0),S={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let j=class extends o{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=S.hidpi,this.imageMaxWidth=S.imageMaxWidth,this.imageMaxHeight=S.imageMaxHeight,this.imageRotationSupported=S.imageRotationSupported,this.imageNormalizationSupported=S.imageNormalizationSupported,this.update=e((async(t,i)=>{if(n(i),!t.stationary||this.destroyed)return;const s=t.state,a=d(s.spatialReference),o=this.hidpi?t.pixelRatio:1,e=s.worldScreenWidth>0,r=e&&this.imageNormalizationSupported&&s.worldScreenWidth<s.size[0],c=Math.round((this.imageMaxWidth??0)/o),u=Math.round((this.imageMaxHeight??0)/o);r?(w[0]=s.worldScreenWidth,w[1]=s.size[1]):this.imageRotationSupported?(w[0]=s.size[0],w[1]=s.size[1]):g(w,s);const l=Math.floor(w[0])>c||Math.floor(w[1])>u,p=a&&(s.extent.xmin<a.valid[0]||s.extent.xmax>a.valid[1]),M=!this.imageNormalizationSupported&&p,f=!l&&!M,m=this.imageRotationSupported?s.rotation:0,v=this.container.children.slice();if(f){const t=r?s.paddedViewState.center:s.center;this._imagePromise=this._singleExport(s,w,t,s.resolution,m,o,i)}else{let t=Math.min(c,u);e&&(t=Math.min(s.worldScreenWidth,t),t=Math.round(s.worldScreenWidth/Math.ceil(s.worldScreenWidth/t))),this._imagePromise=this._tiledExport(s,t,o,i)}try{const t=await this._imagePromise??[];n(i);const s=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const i of v)t.includes(i)||s.push(i.fadeOut().then((()=>{i.remove(),i.destroy()})));for(const i of t)s.push(i.fadeIn());await Promise.all(s)}catch(t){this._imagePromise=null,h(t)}}),5e3),this.updateExports=e((async t=>{const i=[];for(const s of this.container.children){if(!s.visible||!s.stage)return;i.push(t(s).then((()=>{s.invalidateTexture(),s.requestRender()})))}this._imagePromise=r(i).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,i,s,a,o,e){const h=await this.fetchSource(t,Math.floor(i*o),Math.floor(s*o),{rotation:a,pixelRatio:o,signal:e});n(e);const r=new M(null,!0);return r.x=t.xmin,r.y=t.ymax,r.resolution=t.width/i,r.rotation=a,r.pixelRatio=o,r.opacity=0,this.container.addChild(r),await r.setSourceAsync(h,e),n(e),r}async _singleExport(t,i,s,a,o,e,n){v(x,s,a,i);const h=c(x,t.spatialReference);return[await this._export(h,i[0],i[1],o,e,n)]}_tiledExport(t,i,s,a){const o=u.create({size:i,spatialReference:t.spatialReference,scales:[t.scale]}),e=new l(o),n=e.getTileCoverage(t);if(!n)return null;const h=[];return n.forEach(((o,n,r,u)=>{y.set(o,n,r,0),e.getTileBounds(x,y);const l=c(x,t.spatialReference);h.push(this._export(l,i,i,0,s,a).then((t=>(0!==u&&(y.set(o,n,r,u),e.getTileBounds(x,y),t.x=x[0],t.y=x[3]),t))))})),Promise.all(h)}};i([s()],j.prototype,"_imagePromise",void 0),i([s()],j.prototype,"bitmaps",void 0),i([s()],j.prototype,"container",void 0),i([s()],j.prototype,"fetchSource",void 0),i([s()],j.prototype,"hidpi",void 0),i([s()],j.prototype,"imageMaxWidth",void 0),i([s()],j.prototype,"imageMaxHeight",void 0),i([s()],j.prototype,"imageRotationSupported",void 0),i([s()],j.prototype,"imageNormalizationSupported",void 0),i([s()],j.prototype,"requestUpdate",void 0),i([s()],j.prototype,"updating",null),j=i([a("esri.views.2d.layers.support.ExportStrategy")],j);const P=j;export{P as _};
//# sourceMappingURL=p-b1288cb0.js.map