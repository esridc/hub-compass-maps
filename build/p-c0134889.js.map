{"version":3,"names":["async","I","e","t","r","instance","portalItem","id","load","L","validateItem","v","type","supportedTypes","includes","expectedType","join","o","url","n","title","s","i","l","S","read","p","a","u","C","resourceReferences","paths","readResourcePaths","g","sourceIsPortalItem","w","T","j","fetchData","context","layerModuleTypeMap","FeatureLayer","StreamLayer","SceneLayer","d","h","Promise","all","customParameters","c","y","length","push","Map","forEach","set","layerType","get","f","G","loadContext","M","m","P","b","layers","map","tables","layerDefinition","filter","reverse","x","add","clone","layerId","sourceJSON","sublayerTitleMode","origin","portal","getDefault","showLegend","supportsData","k","F","D","fetchServiceMetadata","path","catch","find","E","layersJSON"],"sources":["./node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as o}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as n}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as l}from\"./jsonContext.js\";import{getFirstLayerOrTable as i,preprocessFSItemData as p,getSubtypeGroupLayerIds as u,getOrientedImageryLayerIds as c,getCatalogLayerIds as y,populateSceneServiceItemData as f,getNumLayersAndTables as m,createSublayerData as d,getFirstLayerOrTableId as h}from\"./loadUtils.js\";import{hasTypeKeyword as w}from\"./portalItemUtils.js\";import{loadStyleRenderer as g}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as b}from\"../../support/requestPresets.js\";async function I(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),L(e),e.validateItem&&e.validateItem(r),v(e,t)}function L(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function v(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:n,title:s}=o,i=l(o,\"portal-item\");if(\"group\"===r.type)return S(r,i,e);n&&\"media\"!==r.type&&r.read({url:n},i);const p=new a,u=await C(e,p,t);return u&&r.read(u,i),r.resourceReferences={portalItem:o,paths:i.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},i),g(r,i)}async function S(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!w(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return T(t)}return t.read({title:n},r),j(t,a)}async function T(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=l(t,\"web-map\");e.read(r,a),await o(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function j(t,r){let o;const{portalItem:n}=t;if(!n)return;const s=n.type,l=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":o=l.FeatureLayer;break;case\"Stream Service\":o=l.StreamLayer;break;case\"Scene Service\":o=l.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const d=new a;let[h,w]=await Promise.all([o(),C(r,d)]),g=()=>h;if(\"Feature Service\"===s){const e=i(w)?.customParameters;w=n.url?await p(w,n.url,d):{};const r=u(w),a=c(w),o=y(w),s=[];if(r.length||a?.length){r.length&&s.push(\"SubtypeGroupLayer\"),a?.length&&s.push(\"OrientedImageryLayer\"),o?.length&&s.push(\"CatalogLayer\");const e=[];for(const r of s){const t=l[r];e.push(t())}const t=await Promise.all(e),n=new Map;s.forEach(((e,r)=>{n.set(e,t[r])})),g=e=>e.layerType?n.get(e.layerType)??h:h}const f=await G(n.url,{customParameters:e,loadContext:d});return await M(t,g,w,f)}return\"Scene Service\"===s&&n.url&&(w=await f(n,w,d)),m(w)>0?await M(t,g,w):await P(t,g)}async function P(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await b(r.url);a&&M(e,t,{layers:a.layers?.map(d),tables:a.tables?.map(d)})}async function M(e,t,r,a){let o=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),o=o.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(o.reverse(),s.reverse()),o.forEach((o=>{const n=a?.(o);if(n||!a){const a=x(e,t(o),r,o,n);e.add(a)}})),s.length){const t=await n.FeatureLayer();s.forEach((o=>{const n=a?.(o);if(n||!a){const a=x(e,t,r,o,n);e.tables.add(a)}}))}}function x(e,t,r,a,o){const n=e.portalItem,l={portalItem:n.clone(),layerId:a.id};null!=a.url&&(l.url=a.url);const i=new t(l);if(\"sourceJSON\"in i&&(i.sourceJSON=o),\"subtype-group\"!==i.type&&\"catalog\"!==i.type&&(i.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===n.type){const e={origin:\"portal-item\",portal:n.portal||s.getDefault()};i.read(a,e);const t=r.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function C(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(s){}if(k(a)){let e=null;const r=await F(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=u(n);a.layerId=\"subtype-group\"===a.type?e?.[0]:h(n)}e=D(n,a),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function F(e,r,a){if(r?.layers&&r?.tables)return m(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:i(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function D(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&E(a,t)?a:null}function k(e){return\"stream\"!==e.type&&\"layerId\"in e}function E(e,t){return!(\"feature\"===t.type&&\"layerType\"in e&&\"SubtypeGroupLayer\"===e.layerType||\"subtype-group\"===t.type&&!(\"layerType\"in e))}async function G(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}export{I as load};\n"],"mappings":"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"}