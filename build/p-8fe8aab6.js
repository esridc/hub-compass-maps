import{a as e,g as t,fE as a,cL as n,dc as r,dC as o,eH as c}from"./p-028496e2.js";import{n as s,a as i,m as l}from"./p-ecde740d.js";import{t as u}from"./p-7db7fa08.js";import"./p-3b51db5e.js";let f=null;function p(e,t,a,n={}){const r=t.elementType,o="value",c="array"===r.type?[{name:o,type:r.type,elementType:r.elementType}]:"dictionary"===r.type?[{name:o,type:r.type,properties:r.properties}]:[{name:o,type:r.type}];return new u(e.map((e=>{const t={};return b(t,c,{[o]:e},a,n),t[o]})))}function y(e,t,a={}){const n=e instanceof o?new c({source:e.features,geometryType:e.geometryType,fields:e.fields,spatialReference:e.spatialReference}):e;return t.constructFeatureSet(n,a.spatialReference,null,!0,a.lruCache,a.interceptor)}function m(e,t,a={}){const{spatialReference:n,interceptor:r,lruCache:o}=a;return"string"==typeof e?t.createFeatureSetCollectionFromService(e,n,o,r):t.createFeatureSetCollectionFromMap(e,n,o,r)}function d(e,t,a,n={}){const r={};return b(r,t.properties,e,a,n),new f.Dictionary(r)}function b(e,t,a,n,r={}){const o={};for(const e of Object.keys(a))o[e.toLowerCase()]=a[e];for(const a of t){const t=a.name.toLowerCase();if(r.variablesPreProcessed)e[t]=o[t];else switch(a.type){case"array":{const c=o[t];e[t]=null==c?null:p(c,a,n,r);break}case"feature":{const a=o[t];e[t]=null==a?null:f.Feature.createFromGraphic(a,r?.timeZone);break}case"featureSet":{const a=o[t];e[t]=null==a?null:n?y(a,n,r):null;break}case"featureSetCollection":{const a=o[t];e[t]=null==a?null:n?m(a,n,r):null;break}case"dictionary":{const c=o[t];e[t]=null==c?null:d(c,a,n,r);break}case"date":{const a=o[t];e[t]=a?a instanceof l?a:r?.timeZone?l.dateJSAndZoneToArcadeDate(a,r?.timeZone):l.dateJSToArcadeDate(a):null;break}case"dateOnly":{const a=o[t];e[t]=a?a instanceof i?a:i.fromReader(a):null;break}case"time":{const a=o[t];e[t]=a?a instanceof s?a:s.fromReader(a):null;break}case"knowledgeGraph":case"geometry":case"boolean":case"text":case"number":e[t]=o[t]}}}function $(e,t){for(const a of e)t.push(a),"dictionary"===a.type&&$(a.properties,t);return t}function v(e,t,a,r,o){const{spatialReference:c,interceptor:s,lruCache:i,console:l,abortSignal:u,timeZone:f,services:p={portal:n.getDefault()}}=a,y={vars:{},spatialReference:c,interceptor:s,timeZone:f,lrucache:i,useAsync:o,services:p,console:l,abortSignal:u};return t?(b(y.vars,e.variables,t,r,a),y):y}function g(e,t){switch(t.getArcadeType(e)){case"number":case"text":case"boolean":case"point":case"polygon":case"polyline":case"multipoint":case"extent":return e;case"date":return e.toJSDate();case"time":case"dateOnly":return e.toString();case"feature":{const t=e,a="geometry"in t?t.geometry():null,n="readAttributes"in t?t.readAttributes():t.attributes;return new r({geometry:a,attributes:n})}case"dictionary":{const a=e,n=a.attributes,r={};for(const e of Object.keys(n))r[e]=g(a.field(e),t);return r}case"array":return("toArray"in e?e.toArray():e).map((e=>g(e,t)))}return e}const w={variables:[{name:"$feature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"},{name:"$userInput",type:"geometry"},{name:"$graph",type:"knowledgeGraph"}]},S={variables:[{name:"$feature",type:"feature"},{name:"$aggregatedFeatures",type:"featureSet"}]},h=new Map([["form-constraint",{variables:[{name:"$feature",type:"feature"}]}],["feature-z",{variables:[{name:"$feature",type:"feature"}]}],["field-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$datastore",type:"featureSetCollection"}]}],["form-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$originalFeature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$featureSet",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"},{name:"$editContext",type:"dictionary",properties:[{name:"editType",type:"text"}]}]}],["labeling",{variables:[{name:"$feature",type:"feature"}]}],["popup",w],["popup-element",w],["feature-reduction-popup",S],["feature-reduction-popup-element",S],["visualization",{variables:[{name:"$feature",type:"feature"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"}]}]}]]);function C(a){const n=h.get(a);if(!n){const t=Array.from(h.keys()).map((e=>`'${e}'`)).join(", ");throw new e("createArcadeProfile:invalid-profile-name",`Invalid profile name '${a}'. You must specify one of the following values: ${t}`)}return t(n)}async function x(t,n,r={}){f||(f=await a());const{arcade:o,arcadeUtils:c}=f,{loadScriptDependencies:s,referencesMember:i,scriptIsAsync:l}=o,u=$(n.variables,[]),p=u.filter((e=>"featureSet"===e.type||"featureSetCollection"===e.type)).map((e=>e.name.toLowerCase())),y=o.parseScript(t,p);if(!y)throw new e("arcade:invalid-script","Unable to create SyntaxTree");const m=c.extractFieldNames(y),d=o.scriptTouchesGeometry(y),b=u.map((e=>e.name.toLowerCase())).filter((e=>i(y,e))),w=l(y,p);await s(y,w,p);const S={vars:{},spatialReference:null,useAsync:w};for(const e of b)S.vars[e]="any";const{lruCache:h}=r,C=o.compileScript(y,S),x=o.featureSetUtils(),{services:A}=r;return{execute:(t,a={})=>{if(w)throw new e("arcade:invalid-execution-mode","Cannot execute the script in synchronous mode");const r=C(v(n,t,{lruCache:h,...a},x,w));return a.rawOutput?r:g(r,c)},executeAsync:async(e,t={})=>{const a=await C(v(n,e,{lruCache:h,services:A,...t},x,w));return t.rawOutput?a:g(a,c)},isAsync:w,variablesUsed:b,fieldsUsed:m,geometryUsed:d,syntaxTree:y}}export{x as createArcadeExecutor,C as createArcadeProfile};
//# sourceMappingURL=p-8fe8aab6.js.map