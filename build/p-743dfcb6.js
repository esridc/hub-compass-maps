import{eM as e,s as t,ly as s,lu as i,lw as n,aH as r,lv as o,a_ as a,bn as l}from"./p-aad64c9f.js";import{e as p,n as d,t as u}from"./p-875cbb57.js";import{t as f,n as c}from"./p-9191afce.js";import{m}from"./p-339b5e24.js";import{x as y,j as h}from"./p-e3657bc3.js";import{V as j}from"./p-02236077.js";import{a as I,u as b,l as g}from"./p-4c90e3f2.js";import{j as F,f as T,p as R,d as w,y as x}from"./p-512046c6.js";import"./p-2af77f97.js";import"./p-da522976.js";import"./p-aff89b86.js";import"./p-d492d39b.js";import"./p-56b85bad.js";import"./p-5ae33da2.js";import"./p-1c285990.js";import"./p-e2849960.js";import"./p-bac7b09c.js";import"./p-cea3971b.js";import"./p-4295487d.js";import"./p-1317d6d9.js";import"./p-bdd45e95.js";import"./p-ca379176.js";import"./p-85c76b3c.js";import"./p-e33d4456.js";import"./p-49632661.js";const v=l,E={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:l},D={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0}};function S(e){return a(e)?null!=e.z:!!e.hasZ}function O(e){return a(e)?null!=e.m:!!e.hasM}class Q{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(r){const a=[],{features:l}=r,p=this._inferLayerProperties(l,r.fields),d=r.fields||[],u=null!=r.hasM?r.hasM:!!p.hasM,h=null!=r.hasZ?r.hasZ:!!p.hasZ,F=!r.spatialReference&&!p.spatialReference,T=F?v:r.spatialReference||p.spatialReference,R=F?E:null,w=r.geometryType||p.geometryType,x=!w;let S=r.objectIdField||p.objectIdField,O=r.timeInfo;const Q=new e(d);if(!x&&(F&&a.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!w))throw new t("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!S)throw new t("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(p.objectIdField&&S!==p.objectIdField&&(a.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${S}" doesn't match the field name "${p.objectIdField}", found in the provided fields`}),S=p.objectIdField),S&&!p.objectIdField){const e=Q.get(S);e?(S=e.name,e.type="esriFieldTypeOID",e.editable=!1,e.nullable=!1):d.unshift({alias:S,name:S,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const e of d){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),!e.name)throw new t("feature-layer:invalid-field-name","field name is missing",{field:e});if(e.name===S&&(e.type="esriFieldTypeOID"),!s.jsonValues.includes(e.type))throw new t("feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e});null==e.length&&(e.length=i(e))}const M={};for(const e of d)if("esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type){const t=n(e);void 0!==t&&(M[e.name]=t)}if(O){if(O.startTimeField){const e=Q.get(O.startTimeField);e?(O.startTimeField=e.name,e.type="esriFieldTypeDate"):O.startTimeField=null}if(O.endTimeField){const e=Q.get(O.endTimeField);e?(O.endTimeField=e.name,e.type="esriFieldTypeDate"):O.endTimeField=null}if(O.trackIdField){const e=Q.get(O.trackIdField);e?O.trackIdField=e.name:(O.trackIdField=null,a.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:O}}))}O.startTimeField||O.endTimeField||(a.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:O}}),O=null)}const Z=Q.dateFields.length?{timeZoneIANA:r.dateFieldsTimeZone??o}:null;this._createDefaultAttributes=I(M,S);const q={warnings:a,featureErrors:[],layerDefinition:{...D,drawingInfo:b(w),templates:g(M),extent:R,geometryType:w,objectIdField:S,fields:d,hasZ:h,hasM:u,timeInfo:O,dateFieldsTimeReference:Z},assignedObjectIds:{}};if(this._queryEngine=new j({fieldsIndex:e.fromLayerJSON({fields:d,timeInfo:O,dateFieldsTimeReference:Z}),geometryType:w,hasM:u,hasZ:h,objectIdField:S,spatialReference:T,featureStore:new m({geometryType:w,hasM:u,hasZ:h}),timeInfo:O}),!l?.length)return this._nextObjectId=f,q;const _=c(S,l);return this._nextObjectId=_+1,await y(l,T),this._loadInitialFeatures(q,l)}async applyEdits(e){const{spatialReference:t,geometryType:s}=this._queryEngine;return await Promise.all([F(t,s),y(e.adds,t),y(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)}_inferLayerProperties(e,t){let s,i,n=null,o=null,a=null;for(const t of e){const e=t.geometry;if(null!=e&&(n||(n=r(e)),o||(o=e.spatialReference),null==s&&(s=S(e)),null==i&&(i=O(e)),n&&o&&null!=s&&null!=i))break}if(t&&t.length){let e=null;t.some((t=>{const s="esriFieldTypeOID"===t.type,i=!t.type&&t.name&&"objectid"===t.name.toLowerCase();return e=t,s||i}))&&(a=e.name)}return{geometryType:n,spatialReference:o,objectIdField:a,hasM:i,hasZ:s}}async _loadInitialFeatures(e,t){const{geometryType:s,hasM:i,hasZ:n,objectIdField:o,spatialReference:a,featureStore:l,fieldsIndex:d}=this._queryEngine,u=[];for(const i of t){if(null!=i.uid&&(e.assignedObjectIds[i.uid]=-1),i.geometry&&s!==r(i.geometry)){e.featureErrors.push(T("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),n=R(d,t,i.attributes,!0);n?e.featureErrors.push(n):(this._assignObjectId(t,i.attributes,!0),i.attributes=t,null!=i.uid&&(e.assignedObjectIds[i.uid]=i.attributes[o]),null!=i.geometry&&(i.geometry=h(i.geometry,i.geometry.spatialReference,a)),u.push(i))}l.addMany(p([],u,s,n,i,o));const{fullExtent:f,timeExtent:c}=await this._queryEngine.fetchRecomputedExtents();if(e.layerDefinition.extent=f,c){const{start:t,end:s}=c;e.layerDefinition.timeInfo.timeExtent=[t,s]}return e}async _applyEdits(e){const{adds:t,updates:s,deletes:i}=e,n={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(n,t),s?.length&&this._applyUpdateEdits(n,s),i?.length){for(const e of i)n.deleteResults.push(w(e));this._queryEngine.featureStore.removeManyById(i)}const{fullExtent:r,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();return{extent:r,timeExtent:o,featureEditResults:n}}_applyAddEdits(e,t){const{addResults:s}=e,{geometryType:i,hasM:n,hasZ:o,objectIdField:a,spatialReference:l,featureStore:d,fieldsIndex:u}=this._queryEngine,f=[];for(const n of t){if(n.geometry&&i!==r(n.geometry)){s.push(T("Incorrect geometry type."));continue}const t=this._createDefaultAttributes(),o=R(u,t,n.attributes);if(o)s.push(o);else{if(this._assignObjectId(t,n.attributes),n.attributes=t,null!=n.uid){const t=n.attributes[a];e.uidToObjectId[n.uid]=t}if(null!=n.geometry){const e=n.geometry.spatialReference??l;n.geometry=h(x(n.geometry,e),e,l)}f.push(n),s.push(w(n.attributes[a]))}}d.addMany(p([],f,i,o,n,a))}_applyUpdateEdits({updateResults:e},t){const{geometryType:s,hasM:i,hasZ:n,objectIdField:o,spatialReference:a,featureStore:l,fieldsIndex:p}=this._queryEngine;for(const f of t){const{attributes:t,geometry:c}=f,m=t?.[o];if(null==m){e.push(T(`Identifier field ${o} missing`));continue}if(!l.has(m)){e.push(T(`Feature with object id ${m} missing`));continue}const y=d(l.getFeature(m),s,n,i);if(null!=c){if(s!==r(c)){e.push(T("Incorrect geometry type."));continue}const t=c.spatialReference??a;y.geometry=h(x(c,t),t,a)}if(t){const s=R(p,y.attributes,t);if(s){e.push(s);continue}}l.add(u(y,s,n,i,o)),e.push(w(m))}}_assignObjectId(e,t,s=!1){const i=this._queryEngine.objectIdField;s&&t&&isFinite(t[i])?e[i]=t[i]:e[i]=this._nextObjectId++}}export default Q;
//# sourceMappingURL=p-743dfcb6.js.map