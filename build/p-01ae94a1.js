import{fT as t,c9 as n,eC as e,x as s}from"./p-aad64c9f.js";import{a as r,i}from"./p-55f3e0f9.js";import"./p-c0b174ee.js";import{e as o,i as c}from"./p-b8a25c33.js";import{s as f}from"./p-aff89b86.js";import{Q as u,A as l,k as h,c as a}from"./p-559f4b2d.js";import{r as p,o as w,a as d}from"./p-22458323.js";const m=96/72;class y{static executeEffects(t,n,e,s){const r=m,i=u(t);let o=new h(n);for(const n of t){const t=l(n);t&&(o=t.execute(o,n,r,e,s,i))}return o}static applyEffects(n,e,s){if(!n)return e;const r=u(n);let i,o=new h(a.fromJSONCIM(e));for(const t of n){const n=l(t);n&&(o=n.execute(o,t,1,null,s,r))}const c=[];let f=null;for(;i=o.next();)c.push(...t(i)),f=i.geometryType;return 0===c.length||null===f?null:"esriGeometryPolygon"===f?{rings:c}:{paths:c}}}let b=null;function M(){return b}async function g(){b=await import("./p-a9020a78.js")}function k(t){switch(t){case n.BYTE:case n.UNSIGNED_BYTE:return 1;case n.SHORT:case n.UNSIGNED_SHORT:case n.HALF_FLOAT:return 2;case n.FLOAT:case n.INT:case n.UNSIGNED_INT:return 4}}function x(t){const n=[],e=[],s=[];for(const r of t){const t=k(r.type)*r.count;switch(t%2||t%4||4){case 4:n.push(r);continue;case 2:e.push(r);continue;case 1:s.push(r);continue;default:throw new Error("Found unexpected dataType byte count")}}return n.push(...e),n.push(...s),n}class _{static fromVertexSpec(t,n){const{attributes:e,optionalAttributes:s}=t;let r,i,o;const c=[];for(const t in e){const n=e[t];"position"===n.pack?r={...n,name:t,offset:0}:"id"===n.pack?i={...n,name:t,offset:4}:"bitset"===t?o={...n,name:t,offset:7}:c.push({...n,name:t})}for(const t in s)if(!0===n[t]){const n=s[t];c.push({...n,name:t})}const f=x(c),u=[];let l=8,h=1;for(const t of f)u.push({...t,offset:l}),l+=k(t.type)*t.count,t.packAlternating&&(h=Math.max(t.packAlternating.count,h));const a=Uint32Array.BYTES_PER_ELEMENT,p=l%a;return new _(r,i,o,u,l+(p?a-p:0),h)}constructor(t,n,e,s,r,i){this.position=t,this.id=n,this.bitset=e,this.standardAttributes=s,this.stride=r,this.packVertexCount=i,s.push(e),this._attributes=[t,n,e,...s]}get attributeLayout(){if(!this._attributeLayout){const t=p(this._attributes),n=this._attributes.map((t=>({name:t.name,count:t.count,offset:t.offset,type:t.type,packPrecisionFactor:t.packPrecisionFactor,normalized:t.normalized??!1})));this._attributeLayout={attributes:n,hash:t,stride:this.stride}}return this._attributeLayout}}class j{static fromVertexSpec(t,n){const e=_.fromVertexSpec(t,n);return new j(e)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,n,e,s,r,i){for(let t=0;t<this._spec.packVertexCount;t++){const o=t*this._spec.stride;this._packPosition(e,s,o),this._packId(n,o);const c=this._spec.bitset;if(i){if(c.packTessellation){const t=c.packTessellation(i,r);this._pack(t,c,o)}for(const t of this._spec.standardAttributes)if(null!=t.packTessellation){const n=t.packTessellation(i,r);this._pack(n,t,o)}else if(t.packAlternating?.packTessellation){const n=t.packAlternating.packTessellation(i,r);for(let e=0;e<this._spec.packVertexCount;e++){const s=n[e];this._pack(s,t,e*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,n){for(const e of this._spec.standardAttributes)if(e.pack&&"string"!=typeof e.pack){const s=e.pack(t,n);for(let t=0;t<this._spec.packVertexCount;t++)this._pack(s,e,t*this._spec.stride)}else if(e.packAlternating?.pack){const s=e.packAlternating.pack(t,n);for(let t=0;t<this._spec.packVertexCount;t++){const n=s[t];this._pack(n,e,t*this._spec.stride)}}}_packPosition(t,n,e){const{offset:s}=this._spec.position,r=this._spec.position.packPrecisionFactor??1,i=d(t*r,n*r);this._dataView.setUint32(e+s,i,!0)}_packId(t,n){const e=t*(this._spec.id.packPrecisionFactor??1),s=4278190080&this._dataView.getUint32(n+this._spec.id.offset,!0);this._dataView.setUint32(n+this._spec.id.offset,e|s,!0)}_pack(t,n,e){w(this._dataView,t,n,e)}}function E(t){if(!t)return!1;for(const n of t)switch(n.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1}class I{constructor(t,n,e,s){this._instanceId=t,this._evaluator=n,this._enabledOptionalAttributes=e,this._viewParams=s,this._evaluator.evaluator=t=>this.vertexSpec.createComputedParams(t)}get _vertexPack(){if(!this._cachedVertexPack){const t=j.fromVertexSpec(this.vertexSpec,this._enabledOptionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){E(this._evaluator.inputMeshParams.effects?.effectInfos)&&await g()}enqueueRequest(t,n,e){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,n,e)}write(t,n,e,s,r){this.ensurePacked(n,e,s);const i=this.evaluatedMeshParams.effects;if(!i||0===i.length)return void this._write(t,e,void 0,r);const o=e.readGeometryForDisplay()?.clone();if(!o)return;const c=a.fromOptimizedCIM(o,e.geometryType),f=M();c.invertY();const u=t.id||"",l=y.executeEffects(i,c,u,f);let h;for(;h=l.next();)h.invertY(),this._write(t,e,h,r)}ensurePacked(t,n,e){if(!this._evaluator.hasDynamicProperties)return;const s=this._evaluator.evaluateMeshParams(t,n,e);this._vertexPack.pack(s,this._viewParams)}_writeVertex(t,n,e,s,r){const i=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,n,e,s,i,r)}}function P(t,n,e,s,r,i,o){rt=0;const c=(s-e)*i,f=r&&r.length,u=f?(r[0]-e)*i:c;let l,h,a,p,w,d=v(n,e,s,0,u,i,!0);if(d&&d.next!==d.prev){if(f&&(d=U(n,e,s,r,d,i)),c>80*i){l=a=n[0+e*i],h=p=n[1+e*i];for(let t=i;t<u;t+=i){const s=n[t+e*i],r=n[t+1+e*i];l=Math.min(l,s),h=Math.min(h,r),a=Math.max(a,s),p=Math.max(p,r)}w=Math.max(a-l,p-h),w=0!==w?1/w:0}V(d,t,i,l,h,w,o,0)}}function v(t,n,e,s,r,i,o){let c;if(o===H(t,n,e,s,r,i)>0)for(let e=s;e<r;e+=i)c=D(e+n*i,t[e+n*i],t[e+1+n*i],c);else for(let e=r-i;e>=s;e-=i)c=D(e+n*i,t[e+n*i],t[e+1+n*i],c);return c&&Q(c,c.next)&&(L(c),c=c.next),c}function A(t,n=t){if(!t)return t;let e,s=t;do{if(e=!1,s.steiner||!Q(s,s.next)&&0!==S(s.prev,s,s.next))s=s.next;else{if(L(s),s=n=s.prev,s===s.next)break;e=!0}}while(e||s!==n);return n}function V(t,n,e,s,r,i,o,c){if(!t)return;!c&&i&&(t=F(t,s,r,i));let f=t;for(;t.prev!==t.next;){const u=t.prev,l=t.next;if(i?C(t,s,r,i):G(t))n.push(u.index/e+o),n.push(t.index/e+o),n.push(l.index/e+o),L(t),t=l.next,f=l.next;else if((t=l)===f){c?1===c?V(t=X(t,n,e,o),n,e,s,r,i,o,2):2===c&&Y(t,n,e,s,r,i,o):V(A(t),n,e,s,r,i,o,1);break}}}function G(t){const n=t.prev,e=t,s=t.next;if(S(n,e,s)>=0)return!1;let r=t.next.next;const i=r;let o=0;for(;r!==t.prev&&(0===o||r!==i);){if(o++,J(n.x,n.y,e.x,e.y,s.x,s.y,r.x,r.y)&&S(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function C(t,n,e,s){const r=t.prev,i=t,o=t.next;if(S(r,i,o)>=0)return!1;const c=r.x<i.x?r.x<o.x?r.x:o.x:i.x<o.x?i.x:o.x,f=r.y<i.y?r.y<o.y?r.y:o.y:i.y<o.y?i.y:o.y,u=r.x>i.x?r.x>o.x?r.x:o.x:i.x>o.x?i.x:o.x,l=r.y>i.y?r.y>o.y?r.y:o.y:i.y>o.y?i.y:o.y,h=N(c,f,n,e,s),a=N(u,l,n,e,s);let p=t.prevZ,w=t.nextZ;for(;p&&p.z>=h&&w&&w.z<=a;){if(p!==t.prev&&p!==t.next&&J(r.x,r.y,i.x,i.y,o.x,o.y,p.x,p.y)&&S(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,w!==t.prev&&w!==t.next&&J(r.x,r.y,i.x,i.y,o.x,o.y,w.x,w.y)&&S(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;p&&p.z>=h;){if(p!==t.prev&&p!==t.next&&J(r.x,r.y,i.x,i.y,o.x,o.y,p.x,p.y)&&S(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;w&&w.z<=a;){if(w!==t.prev&&w!==t.next&&J(r.x,r.y,i.x,i.y,o.x,o.y,w.x,w.y)&&S(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function D(t,n,e,s){const r=nt.create(t,n,e);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function L(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function T(t){let n=t,e=t;do{(n.x<e.x||n.x===e.x&&n.y<e.y)&&(e=n),n=n.next}while(n!==t);return e}function U(t,n,e,s,r,i){const o=new Array;for(let r=0,c=s.length;r<c;r++){const f=v(t,n,e,s[r]*i,r<c-1?s[r+1]*i:e*i,i,!1);f===f.next&&(f.steiner=!0),o.push(T(f))}o.sort(W);for(const t of o)r=q(t,r);return r}function q(t,n){const e=B(t,n);if(!e)return n;const s=tt(e,t);return A(s,s.next),A(e,e.next)}function B(t,n){let e=n;const s=t.x,r=t.y;let i,o=-1/0;do{if(r<=e.y&&r>=e.next.y&&e.next.y!==e.y){const t=e.x+(r-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(t<=s&&t>o){if(o=t,t===s){if(r===e.y)return e;if(r===e.next.y)return e.next}i=e.x<e.next.x?e:e.next}}e=e.next}while(e!==n);if(!i)return null;if(s===o)return i.prev;const c=i,f=i.x,u=i.y;let l,h=1/0;for(e=i.next;e!==c;)s>=e.x&&e.x>=f&&s!==e.x&&J(r<u?s:o,r,f,u,r<u?o:s,r,e.x,e.y)&&(l=Math.abs(r-e.y)/(s-e.x),(l<h||l===h&&e.x>i.x)&&K(e,t)&&(i=e,h=l)),e=e.next;return i}function F(t,n,e,s){let r;for(;r!==t;r=r.next){if(r=r||t,null===r.z&&(r.z=N(r.x,r.y,n,e,s)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,F(t,n,e,s);r.prevZ=r.prev,r.nextZ=r.next}return t.prevZ.nextZ=null,t.prevZ=null,R(t)}function R(t){let n,e=1;for(;;){let s,r=t;t=null,n=null;let i=0;for(;r;){i++,s=r;let o=0;for(;o<e&&s;o++)s=s.nextZ;let c=e;for(;o>0||c>0&&s;){let e;0===o?(e=s,s=s.nextZ,c--):0!==c&&s?r.z<=s.z?(e=r,r=r.nextZ,o--):(e=s,s=s.nextZ,c--):(e=r,r=r.nextZ,o--),n?n.nextZ=e:t=e,e.prevZ=n,n=e}r=s}if(n.nextZ=null,e*=2,i<2)return t}}function S(t,n,e){return(n.y-t.y)*(e.x-n.x)-(n.x-t.x)*(e.y-n.y)}function z(t,n,e,s){return!!(Q(t,n)&&Q(e,s)||Q(t,s)&&Q(e,n))||S(t,n,e)>0!=S(t,n,s)>0&&S(e,s,t)>0!=S(e,s,n)>0}function O(t,n){let e=t;do{if(e.index!==t.index&&e.next.index!==t.index&&e.index!==n.index&&e.next.index!==n.index&&z(e,e.next,t,n))return!0;e=e.next}while(e!==t);return!1}function H(t,n,e,s,r,i){let o=0;for(let e=s,c=r-i;e<r;e+=i)o+=(t[c+n*i]-t[e+n*i])*(t[e+1+n*i]+t[c+1+n*i]),c=e;return o}function J(t,n,e,s,r,i,o,c){return(r-o)*(n-c)-(t-o)*(i-c)>=0&&(t-o)*(s-c)-(e-o)*(n-c)>=0&&(e-o)*(i-c)-(r-o)*(s-c)>=0}function K(t,n){return S(t.prev,t,t.next)<0?S(t,n,t.next)>=0&&S(t,t.prev,n)>=0:S(t,n,t.prev)<0||S(t,t.next,n)<0}function N(t,n,e,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-e)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=32767*(n-s)*r)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function Q(t,n){return t.x===n.x&&t.y===n.y}function W(t,n){return t.x-n.x}function X(t,n,e,s){let r=t;do{const i=r.prev,o=r.next.next;!Q(i,o)&&z(i,r,r.next,o)&&K(i,o)&&K(o,i)&&(n.push(i.index/e+s),n.push(r.index/e+s),n.push(o.index/e+s),L(r),L(r.next),r=t=o),r=r.next}while(r!==t);return r}function Y(t,n,e,s,r,i,o){let c=t;do{let t=c.next.next;for(;t!==c.prev;){if(c.index!==t.index&&Z(c,t)){let f=tt(c,t);return c=A(c,c.next),f=A(f,f.next),V(c,n,e,s,r,i,o,0),void V(f,n,e,s,r,i,o,0)}t=t.next}c=c.next}while(c!==t)}function Z(t,n){return t.next.index!==n.index&&t.prev.index!==n.index&&!O(t,n)&&K(t,n)&&K(n,t)&&$(t,n)}function $(t,n){let e=t,s=!1;const r=(t.x+n.x)/2,i=(t.y+n.y)/2;do{e.y>i!=e.next.y>i&&e.next.y!==e.y&&r<(e.next.x-e.x)*(i-e.y)/(e.next.y-e.y)+e.x&&(s=!s),e=e.next}while(e!==t);return s}function tt(t,n){const e=nt.create(t.index,t.x,t.y),s=nt.create(n.index,n.x,n.y),r=t.next,i=n.prev;return t.next=n,n.prev=t,e.next=r,r.prev=e,s.next=e,e.prev=s,i.next=s,s.prev=i,s}class nt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,n,e){const s=rt<et.length?et[rt++]:new nt;return s.index=t,s.x=n,s.y=e,s.prev=null,s.next=null,s.z=null,s.prevZ=null,s.nextZ=null,s.steiner=!1,s}}const et=[],st=8096;let rt=0;for(let t=0;t<st;t++)et.push(new nt);const it=1e-5,ot=new o(0,0,0,1,0),ct=new o(0,0,0,1,0);function ft(t,n,e){let s=0;for(let r=1;r<e;r++){const e=t[2*(n+r-1)],i=t[2*(n+r-1)+1];s+=(t[2*(n+r)]-e)*(t[2*(n+r)+1]+i)}return s}function ut(t,n,e,s,r){let i=0;const o=2;for(let c=e;c<s;c+=3){const e=(t[c]-r)*o,s=(t[c+1]-r)*o,f=(t[c+2]-r)*o;i+=Math.abs((n[e]-n[f])*(n[s+1]-n[e+1])-(n[e]-n[s])*(n[f+1]-n[e+1]))}return i}function lt(t,n){const{coords:e,lengths:s}=n,r=0,i=t;let o=0;for(let t=0;t<s.length;){let n=t,c=s[t],f=ft(e,o,c);const u=[];for(;++n<s.length;){const t=s[n],r=ft(e,o+c,t);if(!(r>0))break;f+=r,u.push(o+c),c+=t}const l=i.length;P(i,e,o,o+c,u,2,r);const h=ut(i,e,l,i.length,r),a=Math.abs(f);if(Math.abs((h-a)/Math.max(1e-7,a))>it)return i.length=0,!1;t=n,o+=c}return!0}function ht(t){const{coords:n,lengths:e}=t,{buffer:s}=r(n,e);return s}function at(t,n,e){let s=0;for(let r=0;r<t.lengths.length;r++){const i=t.lengths[r];for(let r=0;r<i;r++){const i=t.coords[2*(r+s)],o=t.coords[2*(r+s)+1];if(i<n||i>e||o<n||o>e)return!0}s+=i}return!1}function pt(t,n){if(null==t)return null;if(!at(t,-128,e+128))return t;ot.setPixelMargin(n),ot.reset(c.Polygon);let s=0;for(let n=0;n<t.lengths.length;n++){const e=t.lengths[n];let r=t.coords[2*(0+s)],i=t.coords[2*(0+s)+1];ot.moveTo(r,i);for(let n=1;n<e;n++)r=t.coords[2*(n+s)],i=t.coords[2*(n+s)+1],ot.lineTo(r,i);ot.close(),s+=e}const r=ot.result(!1);if(!r)return null;const i=[],o=[];for(const t of r){let n=0;for(const e of t)o.push(e.x),o.push(e.y),n++;i.push(n)}return new f(i,o)}function wt(t,n){ct.setPixelMargin(n);const s=ct,r=-n,i=e+n;let o=[],f=!1;if(!t.nextPath())return null;let u=!0;for(;u;){t.seekPathStart();const n=[];if(!t.pathSize)return null;s.reset(c.LineString),t.nextPoint();let e=t.x,l=t.y;if(f)s.moveTo(e,l);else{if(e<r||e>i||l<r||l>i){f=!0;continue}n.push({x:e,y:l})}let h=!1;for(;t.nextPoint();)if(e=t.x,l=t.y,f)s.lineTo(e,l);else{if(e<r||e>i||l<r||l>i){h=!0;break}n.push({x:e,y:l})}if(h)f=!0;else{if(f){const t=s.resultWithStarts();if(t)for(const n of t)o.push(n)}else o.push({line:n,start:0});u=t.nextPath(),f=!1}}return o=o.filter((t=>t.line.length>1)),0===o.length?null:o}ot.setExtent(e),ct.setExtent(e);const dt=100,mt=s("featurelayer-fast-triangulation-enabled");class yt extends I{async loadDependencies(){await Promise.all([super.loadDependencies(),i()])}_write(t,n,e){const s=e?.asOptimized()??n.readGeometryForDisplay(),r=this._clip(s);r&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,n,r),t.recordEnd())}_clip(t){if(!t)return null;const n=this.hasEffects;return pt(t,n?256:8)}_writeGeometry(t,n,e){const s=e.maxLength>dt,r=[],i=this.createTesselationParams(n);if(!s&&mt&&lt(r,e))return void(r.length&&this._writeVertices(t,n,e.coords,i,r));const o=ht(e);this._writeVertices(t,n,o,i)}_writeVertices(t,n,e,s,r){const i=n.getDisplayId(),o=t.vertexCount(),c=this.hasEffects;let f=0;if(r)for(const n of r){const r=e[2*n],o=e[2*n+1];c&&t.recordBounds(r,o,0,0),this._writeVertex(t,i,r,o,s),f++}else for(let n=0;n<e.length;n+=2){const r=Math.round(e[n]),o=Math.round(e[n+1]);c&&t.recordBounds(r,o,0,0),this._writeVertex(t,i,r,o,s),f++}t.indexEnsureSize(f);for(let n=0;n<f;n++)t.indexWrite(n+o)}}export{yt as a,I as c,wt as d,y as l,M as t,pt as x};
//# sourceMappingURL=p-01ae94a1.js.map