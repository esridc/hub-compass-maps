import{s as t,n as e,r as n,gJ as s,cE as i,gI as r,x as o,eg as a,p as c,q as u,ac as l,dZ as h,bH as f,w as d}from"./p-aad64c9f.js";import{a as p}from"./p-17d8c81f.js";import{s as m}from"./p-dc645a50.js";import{r as w}from"./p-1c4b55c0.js";import{T as v}from"./p-22458323.js";var g;!function(t){t[t.AnimatedMarker=0]="AnimatedMarker",t[t.Blend=1]="Blend",t[t.ComplexFill=2]="ComplexFill",t[t.ComplexOutlineFill=3]="ComplexOutlineFill",t[t.DotDensity=4]="DotDensity",t[t.Fill=5]="Fill",t[t.Grid=6]="Grid",t[t.Heatmap=7]="Heatmap",t[t.Label=8]="Label",t[t.Line=9]="Line",t[t.Magnifier=10]="Magnifier",t[t.Marker=11]="Marker",t[t.OutlineFill=12]="OutlineFill",t[t.Overlay=13]="Overlay",t[t.PatternFill=14]="PatternFill",t[t.PatternOutlineFill=15]="PatternOutlineFill",t[t.PieChart=16]="PieChart",t[t.Test=17]="Test",t[t.Text=18]="Text",t[t.TexturedLine=19]="TexturedLine"}(g||(g={}));const y={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4,isStroke:5}};var x;!function(t){t[t.Geographic=0]="Geographic",t[t.Arithmatic=1]="Arithmatic"}(x||(x={}));const b=3.14159265359/180,$=3.14159265359/128,S=1,T=1.1,O=1,_=24,P=8,D=1e-5,k=.05,C=1e-30,M=4,z=0,A=2,I=2,V=3,F=0,R=3,N=16777216,E=1.1;const U=()=>e.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class G{constructor(){this._includedModules=new Map}include(t,e){this._includedModules.has(t)?this._includedModules.get(t):(this._includedModules.set(t,e),t(this.builder,e))}}class L extends G{constructor(){super(...arguments),this.vertex=new B,this.fragment=new B,this.attributes=new W,this.varyings=new K,this.extensions=new q,this.constants=new Z}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,e=!0){const n=this.extensions.generateSource(t),s=this.attributes.generateSource(t),i=this.varyings.generateSource(t),r="vertex"===t?this.vertex:this.fragment,o=r.uniforms.generateSource(),a=r.code.generateSource(),c="vertex"===t?X:J(),u=this.constants.generateSource().concat(r.constants.generateSource());return`${e?"#version 300 es":""}\n${n.join("\n")}\n${c}\n${u.join("\n")}\n${o.join("\n")}\n${s.join("\n")}\n${i.join("\n")}\n${a.join("\n")}`}generateBindPass(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const n=t.bind[p.Pass];n&&e.set(t.name,n)})),this.fragment.uniforms.entries.forEach((t=>{const n=t.bind[p.Pass];n&&e.set(t.name,n)}));const n=Array.from(e.values()),s=n.length;return(e,i)=>{for(let r=0;r<s;++r)n[r](t,e,i)}}generateBindDraw(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const n=t.bind[p.Draw];n&&e.set(t.name,n)})),this.fragment.uniforms.entries.forEach((t=>{const n=t.bind[p.Draw];n&&e.set(t.name,n)}));const n=Array.from(e.values()),s=n.length;return(e,i,r)=>{for(let o=0;o<s;++o)n[o](t,r,e,i)}}}class H{constructor(){this._entries=new Map}add(...t){for(const e of t)this._add(e)}get(t){return this._entries.get(t)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new t(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else U().error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((t=>null!=t.arraySize?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`))}get entries(){return Array.from(this._entries.values())}}class j{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class B extends G{constructor(){super(...arguments),this.uniforms=new H,this.code=new j,this.constants=new Z}get builder(){return this}}class W{constructor(){this._entries=new Array}add(t,e){this._entries.push([t,e])}generateSource(t){return"fragment"===t?[]:this._entries.map((t=>`in ${t[1]} ${t[0]};`))}}class K{constructor(){this._entries=new Map}add(t,e){this._entries.has(t)&&m(this._entries.get(t)===e),this._entries.set(t,e)}generateSource(t){const e=new Array;return this._entries.forEach(((n,s)=>e.push("vertex"===t?`out ${n} ${s};`:`in ${n} ${s};`))),e}}class q{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const e="vertex"===t?q.ALLOWLIST_VERTEX:q.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((t=>e.includes(t))).map((t=>`#extension ${t} : enable`))}}q.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],q.ALLOWLIST_VERTEX=[];class Z{constructor(){this._entries=new Set}add(t,e,n){let s="ERROR_CONSTRUCTOR_STRING";switch(e){case"float":s=Z._numberToFloatStr(n);break;case"int":s=Z._numberToIntStr(n);break;case"bool":s=n.toString();break;case"vec2":s=`vec2(${Z._numberToFloatStr(n[0])},                            ${Z._numberToFloatStr(n[1])})`;break;case"vec3":s=`vec3(${Z._numberToFloatStr(n[0])},                            ${Z._numberToFloatStr(n[1])},                            ${Z._numberToFloatStr(n[2])})`;break;case"vec4":s=`vec4(${Z._numberToFloatStr(n[0])},                            ${Z._numberToFloatStr(n[1])},                            ${Z._numberToFloatStr(n[2])},                            ${Z._numberToFloatStr(n[3])})`;break;case"ivec2":s=`ivec2(${Z._numberToIntStr(n[0])},                             ${Z._numberToIntStr(n[1])})`;break;case"ivec3":s=`ivec3(${Z._numberToIntStr(n[0])},                             ${Z._numberToIntStr(n[1])},                             ${Z._numberToIntStr(n[2])})`;break;case"ivec4":s=`ivec4(${Z._numberToIntStr(n[0])},                             ${Z._numberToIntStr(n[1])},                             ${Z._numberToIntStr(n[2])},                             ${Z._numberToIntStr(n[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${e}(${Array.prototype.map.call(n,(t=>Z._numberToFloatStr(t))).join(", ")})`}return this._entries.add(`const ${e} ${t} = ${s};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}function J(){return"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n"}const X="precision highp float;\nprecision highp sampler2D;";function Q(t){return t.split(" ").map(((t,e)=>e>0?t.charAt(0).toUpperCase()+t.slice(1):t)).join("")}function Y(t,e){const n=[];for(n.push(e);n.length;){const e=n.pop();if("object"==typeof e&&!t.has(e.uid)){t.add(e.uid);for(const t of e.children)n.push(t)}}}class tt{constructor(){this.uid=tt.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=Q(t),this._debugName=t,this.isImplicit&&this.children[0]instanceof tt&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}}function et(t){return"object"==typeof t?t.clone():t}tt.NodeCount=0;class nt extends tt{constructor(){super(...arguments),this.shaderType="primitive-node"}}class st extends tt{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new st(et(this.child));return this.cloneInto(t),t}}class it extends tt{constructor(t,e,n){super(),this.property=t,this.target=e,this.returnType=n,this.shaderType="property-access-node"}get children(){const t=[this.target];return"string"!=typeof this.property&&t.push(this.property),t}clone(){const t=new it(this.property,et(this.target),this.returnType);return this.cloneInto(t),t}}class rt extends tt{constructor(t,e,n){super(),this.condition=t,this.ifTrue=e,this.ifFalse=n,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=et(this.ifTrue),e=this.ifFalse?et(this.ifFalse):null,n=new rt(this.condition,t,e);return this.cloneInto(n),n}}class ot extends tt{constructor(t,e,n,s){super(),this.captureList=t,this.returnType=e,this.generator=s,this.shaderType="block-node",n&&(this.subgraph=new st(n))}get children(){return Object.keys(this.captureList).map((t=>this.captureList[t])).concat(this.subgraph??[])}clone(){const t={};for(const e in this.captureList)t[e]=et(this.captureList[e]);const e=new ot(t,this.returnType,this.subgraph?et(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(e),e}}class at extends tt{constructor(t,e,n,s,i,r=!1){super(),this.token=t,this._children=e,this.isInfix=n,this.isPropertyAccess=s,this.returnType=i,this.isTernary=r,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new at(this.token,this._children.map(et),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}}var ct,ut,lt,ht,ft,dt,pt,mt,wt,vt,gt,yt,xt,bt;function $t(t){const e=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const n of e)if(n.includes(t))return n.map((t=>Jt[t]));throw new Error("Unable to find type family")}function St(t){return new Proxy(t,{get(e,n){if("constructor"===n)return new Proxy(e.constructor,{construct:(t,e,n)=>St(new t(...e))});if(n in e)return e[n];if("string"==typeof n){const e=$t(t.type);return se(t,n,e[n.length-1])}}})}function Tt(t){return new Proxy(t,{construct:(t,e,n)=>St(new t(...e))})}function Ot(t){return new Proxy(t,{get(e,n){if(n in e)return e[n];if("string"==typeof n){const e=parseInt(n,10);if(!isNaN(e))return se(t,`[${e}]`,t.elementType.constructor)}}})}function _t(t){return new Proxy(t,{construct:(t,e,n)=>Ot(new t(...e))})}class Pt extends Error{}let Dt=ct=class extends nt{constructor(t,e){super(),this.elementType=t,this.size=e,this.children=[],this.type="array"}clone(){const t=new ct(this.elementType,this.size);return super.cloneInto(t),t}get(t){if("number"==typeof t){const e=new Ht(t);return e.isImplicit=!0,se(this,e,this.elementType.constructor)}return se(this,t,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(t,e,n){return le(this,t,e,n)}glslFindIndex(t,e,n){return he(this,t,e,n)}static ofType(t,e){const n={construct:(n,s)=>new ct(new t,e)};return new Proxy(ct,n)}};Dt.type="array",Dt=ct=n([_t],Dt);class kt extends nt{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new kt;return t.children=this.children.map(et),super.cloneInto(t),t}}kt.type="sampler2D";class Ct extends nt{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new Ct(et(this.children[0]));return super.cloneInto(t),t}multiply(t){return pe(this,"number"==typeof t?Gt(t,Ct):t)}divide(t){return me(this,"number"==typeof t?Gt(t,Ct):t)}add(t){return we(this,"number"==typeof t?Gt(t,Ct):t)}subtract(t){return ve(this,"number"==typeof t?Gt(t,Ct):t)}}Ct.type="float";let Mt=ut=class extends nt{constructor(t,e){super(),this.type="vec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new ut(et(this.children[0]),et(this.children[1]));return super.cloneInto(t),t}get 0(){return se(this,"[0]",Ct)}get 1(){return se(this,"[1]",Ct)}get 2(){throw new Pt}get 3(){throw new Pt}multiply(t){return pe(this,"number"==typeof t?Gt(t,Ct):t)}divide(t){return me(this,"number"==typeof t?Gt(t,Ct):t)}add(t){return we(this,"number"==typeof t?Gt(t,Ct):t)}subtract(t){return ve(this,"number"==typeof t?Gt(t,Ct):t)}};Mt.type="vec2",Mt=ut=n([Tt],Mt);let zt=lt=class extends nt{constructor(t,e,n){super(),this.type="vec3",this.children=[t,e,n].filter((t=>null!=t))}get 0(){return se(this,"[0]",Ct)}get 1(){return se(this,"[1]",Ct)}get 2(){return se(this,"[2]",Ct)}get 3(){throw new Pt}clone(){const t=new lt(et(this.children[0]),et(this.children[1]),et(this.children[2]));return super.cloneInto(t),t}multiply(t){return pe(this,"number"==typeof t?Gt(t,Ct):t)}divide(t){return me(this,"number"==typeof t?Gt(t,Ct):t)}add(t){return we(this,"number"==typeof t?Gt(t,Ct):t)}subtract(t){return ve(this,"number"==typeof t?Gt(t,Ct):t)}};zt.type="vec3",zt=lt=n([Tt],zt);let At=ht=class extends nt{constructor(t,e,n,s){super(),this.type="vec4",this.children=[t,e,n,s].filter((t=>null!=t))}clone(){const t=new ht(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]));return super.cloneInto(t),t}get 0(){return se(this,"[0]",Ct)}get 1(){return se(this,"[1]",Ct)}get 2(){return se(this,"[2]",Ct)}get 3(){return se(this,"[3]",Ct)}multiply(t){return pe(this,"number"==typeof t?Gt(t,Ct):t)}divide(t){return me(this,"number"==typeof t?Gt(t,Ct):t)}add(t){return we(this,"number"==typeof t?Gt(t,Ct):t)}subtract(t){return ve(this,"number"==typeof t?Gt(t,Ct):t)}};At.type="vec4",At=ht=n([Tt],At);let It=ft=class extends nt{constructor(t){super(),this.type="uint",this.children=[t]}clone(){const t=new ft(et(this.children[0]));return super.cloneInto(t),t}};It.type="uint",It=ft=n([Tt],It);let Vt=dt=class extends nt{constructor(t,e){super(),this.type="uvec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new dt(et(this.children[0]),et(this.children[1]));return super.cloneInto(t),t}};Vt.type="uvec2",Vt=dt=n([Tt],Vt);let Ft=pt=class extends nt{constructor(t,e,n){super(),this.type="uvec3",this.children=[t,e,n].filter((t=>null!=t))}clone(){const t=new pt(et(this.children[0]),et(this.children[1]),et(this.children[2]));return super.cloneInto(t),t}};Ft.type="uvec3",Ft=pt=n([Tt],Ft);let Rt=mt=class extends nt{constructor(t,e,n,s){super(),this.type="uvec4",this.children=[t,e,n,s].filter((t=>null!=t))}clone(){const t=new mt(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]));return super.cloneInto(t),t}};Rt.type="uvec4",Rt=mt=n([Tt],Rt);class Nt extends nt{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return De(this,t)}or(t){return _e(this,t)}clone(){const t=new Nt(et(this.children[0]));return super.cloneInto(t),t}}Nt.type="bool";let Et=wt=class extends nt{constructor(t,e){super(),this.type="bvec2",this.children=[t,e].filter((t=>null!=t))}all(){return Me(this)}any(){return ze(this)}clone(){const t=new wt(et(this.children[0]),et(this.children[1]));return super.cloneInto(t),t}};Et.type="bvec2",Et=wt=n([Tt],Et);let Ut=vt=class extends nt{constructor(t,e,n){super(),this.type="bvec3",this.children=[t,e,n].filter((t=>null!=t))}all(){return Me(this)}any(){return ze(this)}clone(){const t=new vt(et(this.children[0]),et(this.children[1]),et(this.children[2]));return super.cloneInto(t),t}};function Gt(t,e){if("number"==typeof t){return new e(t)}return t}Ut.type="bvec3",Ut=vt=n([Tt],Ut);let Lt=gt=class extends nt{constructor(t,e,n,s){super(),this.type="bvec4",this.children=[t,e,n,s].filter((t=>null!=t))}all(){return Me(this)}any(){return ze(this)}clone(){const t=new gt(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]));return super.cloneInto(t),t}};Lt.type="bvec4",Lt=gt=n([Tt],Lt);class Ht extends nt{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return pe(this,Gt(t,Ht))}add(t){return we(this,Gt(t,Ht))}subtract(t){return ve(this,Gt(t,Ht))}divide(t){return me(this,Gt(t,Ht))}clone(){const t=new Ht(et(this.children[0]));return super.cloneInto(t),t}}Ht.type="int";let jt=yt=class extends nt{constructor(t,e){super(),this.type="ivec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new yt(et(this.children[0]),et(this.children[1]));return super.cloneInto(t),t}};jt.type="ivec2",jt=yt=n([Tt],jt);let Bt=xt=class extends nt{constructor(t,e,n){super(),this.type="ivec3",this.children=[t,e,n].filter((t=>null!=t))}clone(){const t=new xt(et(this.children[0]),et(this.children[1]),et(this.children[2]));return super.cloneInto(t),t}};Bt.type="ivec3",Bt=xt=n([Tt],Bt);let Wt=bt=class extends nt{constructor(t,e,n,s){super(),this.type="ivec4",this.children=[t,e,n,s].filter((t=>null!=t))}clone(){const t=new bt(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]));return super.cloneInto(t),t}};Wt.type="ivec4",Wt=bt=n([Tt],Wt);class Kt extends nt{constructor(t,e,n,s){super(),this.type="mat2",this.children=[t,e,n,s]}clone(){const t=new Kt(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]));return super.cloneInto(t),t}multiply(t){return pe(this,t)}}Kt.type="mat2";class qt extends nt{static identity(){return new qt(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const e=Je(t),n=Fe(t);return new qt(n,e,0,ce(e),n,0,0,0,1)}constructor(t,e,n,s,i,r,o,a,c){super(),this.type="mat3",this.children=[t,e,n,s,i,r,o,a,c]}add(t){return we(this,t)}multiply(t){return pe(this,t)}clone(){const t=new qt(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]),et(this.children[4]),et(this.children[5]),et(this.children[6]),et(this.children[7]),et(this.children[8]));return super.cloneInto(t),t}}qt.type="mat3";class Zt extends nt{static identity(){return new Zt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,e,n,s,i,r,o,a,c,u,l,h,f,d,p,m){super(),this.type="mat4",this.children=[t,e,n,s,i,r,o,a,c,u,l,h,f,d,p,m]}static fromColumns(t,e,n,s){return new Zt(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,n.x,n.y,n.z,n.w,s.x,s.y,s.z,s.w)}multiply(t){return pe(this,t)}clone(){const t=new Zt(et(this.children[0]),et(this.children[1]),et(this.children[2]),et(this.children[3]),et(this.children[4]),et(this.children[5]),et(this.children[6]),et(this.children[7]),et(this.children[8]),et(this.children[9]),et(this.children[10]),et(this.children[11]),et(this.children[12]),et(this.children[13]),et(this.children[14]),et(this.children[15]));return super.cloneInto(t),t}}Zt.type="mat4";const Jt={float:Ct,vec2:Mt,vec3:zt,vec4:At,int:Ht,ivec2:jt,ivec3:Bt,ivec4:Wt,uint:It,uvec2:Vt,uvec3:Ft,uvec4:Rt,bool:Nt,bvec2:Et,bvec3:Ut,bvec4:Lt},Xt=(...t)=>new Ht(...t),Qt=(...t)=>new Ct(...t),Yt=(...t)=>new Mt(...t),te=(...t)=>new zt(...t),ee=(...t)=>new At(...t),ne=(...t)=>new qt(...t);function se(t,e,n){const s=new n(new it(e,t,n));return s.isImplicit=!0,s}function ie(t,e,n,s=null){if(s){const i=new s,r=new s(new at(t,[e,n],!0,!1,i));return r.isImplicit=!0,r}if("float"===e.type||"int"===e.type){const s=new n.constructor(new at(t,[e,n],!0,!1,n.constructor));return s.isImplicit=!0,s}if(("mat2"===e.type||"mat3"===e.type||"mat4"===e.type)&&"float"!==n.type){const s=new n.constructor(new at(t,[e,n],!0,!1,n.constructor));return s.isImplicit=!0,s}const i=new e.constructor(new at(t,[e,n],!0,!1,e.constructor));return i.isImplicit=!0,i}function re(t,e,n=e.constructor){const s=new n(new at(t,[e],!1,!1,n));return s.isImplicit=!0,s}function oe(t,e,n,s=e.constructor){const i=new s(new at(t,[e,n],!1,!1,s));return i.isImplicit=!0,i}function ae(t,e,n,s,i=e.constructor){const r=new i(new at(t,[e,n,s],!1,!1,i));return r.isImplicit=!0,r}function ce(t){return pe(t,Qt(-1))}function ue(t,e,n,s){return new e(new ot(t,e,n,s))}function le(t,e,n=0,s=t.size){const i=new Ht(n).setMutable().setDebugName("FindIndexIterator"),r=e(t.get(i)).setDebugName("FindIndexPredicate"),o=ue({iter:i},Ht,r,(({out:t,iter:e,subgraph:n})=>`\n${t} = -1;\n\nfor (; ${e} < ${s}; ${e}++) {\n\n${n.body}\n\n  if (${n.varName}) {\n    ${t} = ${e};\n    break;\n  }\n\n}\n`)).setDebugName("FindIndexBlock");return o}function he(t,e,n=0,s=t.size){const i=ue({array:t},Ht,null,(({out:t,array:i})=>`\n${t} = -1;\nfor (int i = ${n}; i < ${s}; i++) {\n  bool condition;\n  ${e({array:i,i:"i",out:"condition"})}\n  if (condition) {\n    ${t} = i;\n    break;\n  }\n}\n`)).setDebugName("GlslFindIndexBlock");return i}function fe(t,e,n){const s="function"==typeof e?e():e,i="function"==typeof n?n():n,r=new s.constructor(new rt(t,s,i));return r.isImplicit=!0,r}function de(...t){const e=t.map((([t,e])=>"function"==typeof e?[t,e()]:[t,e])),n=e[0][1].constructor,s=e.findIndex((t=>!0===t[0]));if(-1===s)throw new Error("A cond must have a fallthrough case with `true`/; ");const i=e.slice(0,s),r=e[s][1],o=new n(i.reduceRight(((t,e)=>fe(e[0],e[1],t)),r));return o.isImplicit=!0,o}function pe(t,e){return ie("*",t,e)}function me(t,e){return ie("/",t,e)}function we(t,e){return ie("+",t,e)}function ve(t,e){return ie("-",t,e)}function ge(t,e){return ie("%",t,e)}function ye(t,e){return ie(">>",t,e)}function xe(t,e){return ie("&",t,e)}function be(t,e){return ie("==",t,e,Nt)}function $e(t,e){return ie("<",t,e,Nt)}function Se(t,e){return ie("<=",t,e,Nt)}function Te(t,e){return ie(">",t,e,Nt)}function Oe(t,e){return ie(">=",t,e,Nt)}function _e(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>Pe(t,e)),t[0])}function Pe(t,e){return ie("||",t,e,Nt)}function De(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>ke(t,e)),t[0])}function ke(t,e){return ie("&&",t,e,Nt)}function Ce(t){return re("abs",t)}function Me(t){return re("all",t,Nt)}function ze(t){return re("any",t,Nt)}function Ae(t,e){return null==e?re("atan",t):oe("atan",t,e,t.constructor)}function Ie(t){return re("ceil",t)}function Ve(t,e,n){return ae("clamp",t,e,n,t.constructor)}function Fe(t){return re("cos",t)}function Re(t,e){return oe("distance",t,e,Ct)}function Ne(t,e){return oe("dot",t,e,Ct)}function Ee(t){return re("floor",t)}function Ue(t){return re("fract",t)}function Ge(t){return re("length",t,Ct)}function Le(t,e){return oe("max",t,e)}function He(t,e){return oe("min",t,e)}function je(t,e,n){return ae("mix",t,e,n)}function Be(t,e){return oe("mod",t,e)}function We(t){return re("normalize",t)}function Ke(t){return"bool"===t.type?re("!",t):re("not",t)}function qe(t,e){return oe("pow",t,e)}function Ze(t){return re("round",t)}function Je(t){return re("sin",t)}function Xe(t,e,n){return ae("smoothstep",t,e,n)}function Qe(t){return re("sqrt",t)}function Ye(t,e){return oe("step",t,e,e.constructor)}function tn(t,e){return oe("texture",t,e,At)}const en=5;function nn(t,e,n){const s=e.split("\n");for(const e of s)if(e.trim().length){{let e="";null!=n&&(e+=`/*id:${n??"000"}*/   `),t.body+=e.padEnd(14)}t.body+=" ".repeat(t.indent)+e+"\n"}}class sn{write(t){for(const e of t.rootOutputNodes())t.shouldPruneOutputNode(e)||(e.variableName=this._write(t,e.node));return t}_createVarName(t,e){let n="";return"boolean"!=typeof e&&"number"!=typeof e&&e.debugInfo.name&&(n=`${e.debugInfo.name}_`),`${n}v${t.varCount++}`}_write(t,e,n=!1){if("number"==typeof e)return e.toString();if("boolean"==typeof e)return e.toString();let s=t.getEmit(e);if(s)return s;switch(e.shaderType){case"scope-node":s=this._writeScopeNode(t,e);break;case"primitive-node":s=this._writePrimitiveNode(t,e,n);break;case"function-node":s=this._writeFunctionNode(t,e);break;case"property-access-node":s=this._writePropertyAccessNode(t,e);break;case"text-node":s=e.text;break;case"block-node":s=this._writeBlockNode(t,e);break;case"condition-node":s=this._writeConditionNode(t,e)}return t.setEmit(e,s),s}_writeScopeNode(t,e){const n=new e.child.constructor;n.setDebugName(e.debugInfo.name);const s=this._write(t,n,!0);nn(t,`{ /*ScopeStart: ${e.uid} ${e.debugInfo.name}*/`),t.indent+=2;return nn(t,`${s} = ${this._write(t,e.child)};`),t.indent-=2,nn(t,`} /*ScopeEnd: ${e.uid} ${e.debugInfo.name}*/`),s}_writeConditionNode(t,e){const n=new e.ifTrue.constructor,s=this._write(t,n,!0);nn(t,`if (${this._write(t,e.condition)}) {`),t.indent+=2;const i=t.createSubgraphContext(),r=this._write(i,e.ifTrue);if(t.body+=i.body,r&&nn(t,`${s} = ${r};`),t.indent-=2,nn(t,"}"),e.ifFalse){nn(t,"else {"),t.indent+=2;const n=t.createSubgraphContext(),i=this._write(n,e.ifFalse);t.body+=n.body,i&&nn(t,`${s} = ${i};`),t.indent-=2,nn(t,"}")}return s}_writeBlockNode(t,e){const{captureList:n,generator:s,returnType:i}=e,r={};for(const e in n){if(!n[e])continue;const s=this._write(t,n[e]);r[e]=s}const o=new i,a=this._write(t,o,!0);if(r.out=a,e.subgraph){const n=t.createSubgraphContext(),s=this._write(n,e.subgraph.child),i=n.body;r.subgraph={varName:s,body:i}}const c=s(r);return nn(t,"{\n"),t.indent+=2,nn(t,c),t.indent-=2,nn(t,"}\n"),a}_writePropertyAccessNode(t,e){const n=this._write(t,e.target);if("string"==typeof e.property&&e.property.includes("["))return`${n}${e.property}`;if("string"!=typeof e.property){return`${n}[${this._write(t,e.property)}]`}return`${n}.${e.property}`}_writeFunctionNode(t,e){const n=e.returnType.type;if(e.isInfix){const[s,i]=e.children.map((e=>this._write(t,e))),r=this._createVarName(t,e);return nn(t,`${n.padEnd(en)} ${r} = ${s} ${e.token} ${i};`,e.uid),r}const s=e.children.map((e=>this._write(t,e))).join(", "),i=this._createVarName(t,e);return nn(t,`${n.padEnd(en)} ${i} = ${e.token}(${s});`,e.uid),i}_writePrimitiveNode(t,e,n=!1){const s=t.getInput(e);if(s)return s.isUsed=!0,s.variableName;const i=1===e.children.length&&e.children[0]?.type===e.type;if(e.isImplicit||i)return this._write(t,e.children[0]);const r=this._createVarName(t,e);if(n)return nn(t,`${e.type.padEnd(en)} ${r};`,e.uid),r;const o=!e.debugInfo.name&&!e.isMutable;if(o&&"float"===e.type&&"number"==typeof e.children[0])return Number.isInteger(e.children[0])?e.children[0].toFixed(1):e.children[0].toString();if(o&&"int"===e.type&&"number"==typeof e.children[0]&&Number.isInteger(e.children[0]))return e.children[0].toString();const a=e.children.map((e=>this._write(t,e))).join(", ");return"array"===e.type?(nn(t,`${e.type.padEnd(en)} ${r} = [${a}];`,e.uid),r):o?`${e.type}(${a})`:(nn(t,`${e.type.padEnd(en)} ${r} = ${e.type}(${a});`,e.uid),r)}}class rn{constructor(t,e,n){this.variableName=t,this.variableInputType=e,this.node=n,this.type="shader-input",this.isUsed=!1}clone(){return new rn(this.variableName,this.variableInputType,et(this.node))}}class on{constructor(t,e,n){this.outVariableName=t,this.outVariableType=e,this.node=n,this.type="shader-output"}clone(){const t=new on(this.outVariableName,this.outVariableType,et(this.node));return t.variableName=this.variableName,t}}class an{static createVertex(t,e,n,s,i,r){const o=[];for(const e in t){const s=t[e],i=n.get(e);i?o.push(new rn(i,"builtin",s)):o.push(new rn("a_"+e,"in",s))}for(const t of s){const e=t.uniformHydrated;o.push(new rn(t.uniformName,"uniform",e))}const a=[];for(const t in e){const n=e[t];"glPosition"===t?a.push(new on("gl_Position","builtin",n)):"glPointSize"===t?a.push(new on("gl_PointSize","builtin",n)):a.push(new on("v_"+t,"out",n))}return new an(o,a,i,r)}static createFragment(t,e,n,s,i,r){const o=[],a=Array.from(i.rootOutputNodes());for(const e in t){const s=t[e],i=n.get(e);if(i){o.push(new rn(i,"builtin",s));continue}const r=a.find((t=>t.node===s));r&&o.push(new rn(r.outVariableName,"in",s))}for(const t of s){const e=t.uniformHydrated;o.push(new rn(t.uniformName,"uniform",e))}const c=[];for(const t in e){const s=e[t],i=n.get(t);"discard"===t?c.push(new on(null,"discard",s)):i?c.push(new on(i,"builtin",s)):c.push(new on(t,"out",s))}return new an(o,c,r)}constructor(t,e,n,s){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const e of t)this._inputShaderTypesByNodeUid.set(e.node.uid,e);this._outputShaderTypes=e,this._transformFeedbackBindings=n,this._transformFeedbackNames=new Set(n.map((t=>"v_"+t.propertyKey))),this._usedInFragmentShader=s}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&("builtin"!==t.outVariableType&&(!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)))}setEmit(t,e){this._nodeEmitMap.set(t.uid,e)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const e of this._outputShaderTypes.values())t.push(e.node);for(;t.length;){const e=t.pop();"number"!=typeof e&&"boolean"!=typeof e&&t.push(...e.children.filter(Boolean)),yield e}}*nodesOfTypeOrFunction(){for(const t of this.nodes())"number"!=typeof t&&"boolean"!=typeof t&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new an([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){const n="builtin"===e.outVariableType;this.shouldPruneOutputNode(e)||(n?t.vertex.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.vertex.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())this.shouldPruneOutputNode(e)||t.vertex.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("// OUTPUTS: "),t.fragment.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){"builtin"===e.outVariableType?t.fragment.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.fragment.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`)}t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())"discard"===e.outVariableType?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${e.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.fragment.code.add("}")}_insertInputs(t,e){t[e].code.add("// INPUTS: "),t[e].code.add("// --------------------------------------------------------- ");for(const n of this.inputs())n.isUsed&&"builtin"!==n.variableInputType&&("array"===n.node.type?t[e].code.add(`${n.variableInputType.padEnd(10)} ${n.node.elementType.type.padEnd(9)} ${n.variableName}[${n.node.size}];`):t[e].code.add(`${n.variableInputType.padEnd(10)} ${n.node.type.padEnd(9)} ${n.variableName};`))}}const cn=()=>e.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram");function un(e,n,s){const i=n.length;if(i!==s){const r=new t("Invalid Uniform",`Invalid length, expected ${s} but got ${i}`,{uniformName:e,values:n});cn().errorOnce(r)}}class ln{constructor(t,e,n,s,i,r){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=e,this._locations=n,this._locationInfo=s,this._uniformBindings=i,this._transformFeedbackBindings=r}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const e=this._uniforms;if(!this._program){const e=new Map;for(const[t,n]of this._locations)e.set(t,n);const n=[];for(const t of this._transformFeedbackBindings??[]){const{index:e,propertyKey:s}=t;n[e]=`v_${s}`}this._program=new w(t,this.vertexShader,this.fragmentShader,e,new Map,n)}const n=this._program;t.useProgram(n);for(const i of this._uniformBindings){const{shaderModulePath:r,uniformName:o,uniformType:a,uniformArrayLength:c}=i,u=s(r,e);if(null==u){if("sampler2D"===a)continue;throw new Error(`Failed to find uniform value for ${r}`)}switch("array"===a?i.uniformArrayElementType:a){case"sampler2D":{const{unit:e,texture:s}=u;if(n.setUniform1i(o,e),"type"in s)t.bindTexture(s,e);else{const n=v(t,s.descriptor,s.data);t.bindTexture(n,e)}break}case"int":if(!c){n.setUniform1i(o,u);break}un(i.uniformName,u,c),n.setUniform1iv(o,u);break;case"float":if(!c){n.setUniform1f(o,u);break}un(i.uniformName,u,c),n.setUniform1fv(o,u);break;case"vec2":if(!c){n.setUniform2f(o,u[0],u[1]);break}un(i.uniformName,u,c),n.setUniform2fv(o,u.flat());break;case"vec3":if(!c){n.setUniform3f(o,u[0],u[1],u[2]);break}un(i.uniformName,u,c),n.setUniform3fv(o,u.flat());break;case"vec4":if(!c){n.setUniform4f(o,u[0],u[1],u[2],u[3]);break}un(i.uniformName,u,c),n.setUniform4fv(o,u.flat());break;case"mat3":n.setUniformMatrix3fv(o,u);break;case"mat4":n.setUniformMatrix4fv(o,u);break;default:throw new Error(`Unable to set uniform for type ${a}`)}}}}function hn(t){return new t}function fn(t,e,n){const s=t.constructor[e]??[];t.constructor.hasOwnProperty(e)||Object.defineProperty(t.constructor,e,{value:s.slice()}),t.constructor[e].push(n)}function dn(t,e){return(n,s)=>{fn(n,"locations",{typeCtor:e,propertyKey:s,parameterIndex:null,index:t})}}const pn=t=>(e,n,s)=>{fn(e,"inputs",{inputCtor:t,propertyKey:n,parameterIndex:s})},mn=t=>(e,n)=>{fn(e,"uniforms",{typeCtor:t,propertyKey:n})},wn=t=>(e,n)=>{fn(e,"options",{typeCtor:t,propertyKey:n})},vn=(t,e)=>{fn(t,"defines",{propertyKey:e})};const gn=(t,e)=>(n,s)=>{n.constructor.builtins.push({builtin:t,propertyKey:s,typeCtor:e})};class yn{}yn.builtins=[],n([gn("gl_VertexID",Ht)],yn.prototype,"glVertexID",void 0);class xn{}class bn{}bn.builtins=[],n([gn("gl_FragCoord",At)],bn.prototype,"glFragCoord",void 0),n([gn("gl_PointCoord",Mt)],bn.prototype,"glPointCoord",void 0);class $n{}class Sn{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}}class Tn{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=this._shaderModuleClass.inputs.findLast((t=>"vertex"===t.propertyKey&&0===t.parameterIndex));if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return this._shaderModuleClass.inputs.findLast((t=>"vertex"===t.propertyKey&&1===t.parameterIndex))}get fragmentInput(){const t=this._shaderModuleClass.inputs.findLast((t=>"fragment"===t.propertyKey));if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){const t=new Map,n=new Set;for(const s of this.locations)n.has(s.index)?e.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${s.propertyKey} to ${s.index}. Index already in use`,{locationsMap:t}):(t.set(s.propertyKey,s.index),n.add(s.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map((([t,e])=>`${t}.${e}`)).join("."),n=i(e),s=this.computeAttributes;this._locationInfo={hash:n,locations:t,computeAttributeMap:s}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const e of this.locations)t.set("a_"+e.propertyKey,e.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const e of this._options)t.add(e.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,e,n,s){try{const{vertex:i,fragment:r,uniformBindings:o}=this._generateShaders(t,e,n,s);return new ln(i,r,this.renamedLocationsMap,this.locationInfo,o,this.transformFeedbackBindings)}catch(t){return new ln("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const e=this._options.find((e=>e.propertyKey===t));if(e)return{type:"option",className:e.typeCtor};const n=this._uniforms.find((e=>e.propertyKey===t));if(!n)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:n.typeCtor}}getShaderKey(t,e,n,s){const i=Object.keys(t).map((e=>`${e}.${t[e]}`)).join("."),r=Object.keys(n).map((t=>`${t}.${n[t]}`)).join("."),o=Object.keys(s).map((t=>`${t}.${s[t]}`)).join("."),a=Object.keys(e).filter((t=>this.optionPropertyKeys.has(t)&&e[t])).join(".");return`${this.constructor.name}.${i}.${r}.${o}.${a}`}_generateShaders(t,e,n,s){const i=[];this._setDefines(n),this._setOptionalUniforms(i,e),this._setRequiredUniforms(i);const r=this._hydrateVertexInput(s),o=this._injectPackPrecisionFactor(r,t),a=this._hydrateComputeInput(),c=a&&this._injectComputePackPrecisionFactor(a,t),u=this.vertex(o,c),l=this._hydrateFragmentInput(u),h=this.fragment(l),f=new Set;for(const t in h){const e=h[t];Y(f,e)}const d=this._getVertexInputBuiltins(),p=an.createVertex({...r,...a},u,d,i,this.transformFeedbackBindings,f);(new sn).write(p);const m=this._getFragmentInputBuiltins(h);m.set("glPointCoord","gl_PointCoord");const w=an.createFragment(l,h,m,i,p,this.transformFeedbackBindings);(new sn).write(w);const v=this._createShaderBuilder(p,w),g=v.generate("vertex",!0),y=v.generate("fragment",!0);return this.logShader&&(console.log(g),console.log(y)),{vertex:g,fragment:y,uniformBindings:i}}_setDefines(t){for(const e in t)this[e]=t[e]}_setOptionalUniforms(t,e){for(const n of this._options){e[n.propertyKey]?this[n.propertyKey]=this._hydrateUniformGroup(t,n):this[n.propertyKey]=null}}_setRequiredUniforms(t){for(const e of this._uniforms)this[e.propertyKey]=this._hydrateUniformGroup(t,e)}_hydrateUniformGroup(t,e){const n=new e.typeCtor;for(const s of n._uniforms??[]){const i=hn(s.typeCtor),r=`u_${e.propertyKey}_${s.propertyKey}`,o=i.type,a=[e.propertyKey,s.propertyKey].join(".");if("type"in s.typeCtor&&"array"===s.typeCtor.type){const e=i;t.push({shaderModulePath:a,uniformName:r,uniformType:o,uniformArrayLength:e.size,uniformArrayElementType:e.elementType.type,uniformHydrated:i})}else t.push({shaderModulePath:a,uniformName:r,uniformType:o,uniformHydrated:i});n[s.propertyKey]=i}return n}_hydrateVertexInput(t){const e=this.vertexInput.inputCtor,n=e.locations.reduce(((e,n)=>!1===t[n.propertyKey]?e:{...e,[n.propertyKey]:hn(n.typeCtor)}),{});for(const{propertyKey:t,typeCtor:s}of e.builtins){const e=hn(s);n[t]=e}return n}_hydrateComputeInput(){if(null==this.computeInput)return null;return this.computeInput.inputCtor.locations.reduce(((t,e)=>({...t,[e.propertyKey]:hn(e.typeCtor)})),{})}_injectPackPrecisionFactor(t,e){const n={};for(const s in t){const i=t[s],r=e[s];if(r){if("float"!==i.type&&"vec2"!==i.type&&"vec3"!==i.type&&"vec4"!==i.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${i.type}`);n[s]=i.divide(new Ct(r))}else n[s]=i}return n}_injectComputePackPrecisionFactor(t,e){const n={},s=new Map;for(const t in this.computeAttributes)for(const e of this.computeAttributes[t]??[])s.set(e,t);for(const i in t){const r=t[i],o=s.get(i);if(!o)continue;const a=e[o];if(a){if("float"!==r.type&&"vec2"!==r.type&&"vec3"!==r.type&&"vec4"!==r.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${r.type}`);n[i]=r.divide(new Ct(a))}else n[i]=r}return n}_hydrateFragmentInput(t){const e={};for(const n in t)e[n]=t[n];for(const{propertyKey:t,typeCtor:n}of bn.builtins){const s=hn(n);e[t]=s}return e}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,e=new Map;for(const{builtin:n,propertyKey:s}of t.builtins)e.set(s,n);return e}_getFragmentInputBuiltins(t){const e=t.constructor,n=new Map;for(const t of e.builtins??[])n.set(t.propertyKey,t.builtin);return n}_createShaderBuilder(t,e){const n=new L;return this._insertDebugInfo(n),t.insertVertexShader(n),e.insertFragmentShader(n),n}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._defines)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._options)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`)}}function On(t){const e=Qt(12.9898),n=Qt(78.233),s=Qt(43758.5453),i=Ne(t,Yt(e,n)),r=Be(i,Qt(3.14));return Ue(Je(r).multiply(s))}function _n(t){return be(t,Qt(C))}function Pn(t,e){return t.x.multiply(e.y).subtract(e.x.multiply(t.y))}function Dn(t){return t.multiply(2).subtract(1)}function kn(t,e){const n=Qt(2**e);return Be(Ee(t.divide(n)),Qt(2))}function Cn(t,e){return Te(kn(t,e),Qt(.5))}function Mn(t,e){return kn(t,e+r)}function zn(t,e){return kn(t,e)}function An(t){const e=kn(t.z,7),n=Qt(1).subtract(e),s=t.xyz.subtract(te(0,0,Qt(128)));return n.multiply(t).add(e.multiply(s))}function In(t){const e=ee(255/256,255/65536,255/16777216,255/4294967296);return Ne(t,e)}function Vn(t){return Le(Le(Le(t.x,t.y),t.z),t.w)}function Fn(t){return new Ct(1).subtract(t)}function Rn(t){return t.subtract(new Ct(1))}function Nn(t,e){return t.subtract(new Ct(e))}class En extends Sn{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=tn(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=An(t),n=this.size,s=Xt(e.x),i=Xt(e.y).multiply(Xt(256)),r=Xt(e.z).multiply(Xt(256)).multiply(Xt(256)),o=Qt(s.add(i).add(r)),a=Be(o,n),c=o.subtract(a).divide(n);this._uv=new Mt(a,c).add(.5).divide(n)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return tn(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return tn(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return tn(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return tn(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return tn(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return tn(this.gpgpu,e).setDebugName("storage4")}getLocalTimeOrigin(t){const e=this.getAttributeDataCoords(t);return tn(this.localTimeOrigin,e).x.setDebugName("storage5")}getFilterFlags(t){return o("webgl-ignores-sampler-precision")?Ie(this.getFilterData(t).x.multiply(Qt(255))):this.getFilterData(t).x.multiply(Qt(255))}getLabelVisibility(t){const e=this.getFilterData(t).y.multiply(255);return new Ct(1).subtract(e)}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}}n([mn(kt)],En.prototype,"filterFlags",void 0),n([mn(kt)],En.prototype,"animation",void 0),n([mn(kt)],En.prototype,"gpgpu",void 0),n([mn(kt)],En.prototype,"localTimeOrigin",void 0),n([mn(kt)],En.prototype,"visualVariableData",void 0),n([mn(kt)],En.prototype,"dataDriven0",void 0),n([mn(kt)],En.prototype,"dataDriven1",void 0),n([mn(kt)],En.prototype,"dataDriven2",void 0),n([mn(Ct)],En.prototype,"size",void 0);class Un extends Sn{}n([mn(Ct)],Un.prototype,"activeReasons",void 0),n([mn(Ct)],Un.prototype,"highlightAll",void 0);class Gn extends Sn{}n([mn(Mt)],Gn.prototype,"position",void 0),n([mn(Ct)],Gn.prototype,"distance",void 0),n([mn(Ct)],Gn.prototype,"smallSymbolDistance",void 0),n([mn(Ct)],Gn.prototype,"smallSymbolSizeThreshold",void 0);class Ln extends Sn{}n([mn(qt)],Ln.prototype,"displayViewScreenMat3",void 0),n([mn(qt)],Ln.prototype,"displayViewMat3",void 0),n([mn(qt)],Ln.prototype,"displayMat3",void 0),n([mn(qt)],Ln.prototype,"viewMat3",void 0),n([mn(qt)],Ln.prototype,"tileMat3",void 0),n([mn(Ct)],Ln.prototype,"displayZoomFactor",void 0),n([mn(Ct)],Ln.prototype,"requiredZoomFactor",void 0),n([mn(Mt)],Ln.prototype,"tileOffset",void 0),n([mn(Ct)],Ln.prototype,"currentScale",void 0),n([mn(Ct)],Ln.prototype,"currentZoom",void 0),n([mn(Ct)],Ln.prototype,"metersPerSRUnit",void 0),n([mn(Ct)],Ln.prototype,"rotation",void 0),n([mn(Ct)],Ln.prototype,"pixelRatio",void 0);class Hn extends yn{}n([dn(0,zt)],Hn.prototype,"id",void 0),n([dn(1,Ct)],Hn.prototype,"bitset",void 0),n([dn(2,Mt)],Hn.prototype,"pos",void 0);class jn extends xn{}n([dn(14,Mt)],jn.prototype,"nextPos1",void 0),n([dn(15,Mt)],jn.prototype,"nextPos2",void 0);class Bn extends bn{}class Wn extends Tn{clip(t,e){let n=new Ct(0);const s=this.storage.getFilterFlags(t);if(n=n.add(Qt(2).multiply(Qt(1).subtract(Mn(s,0)))),this.inside?n=n.add(Qt(2).multiply(Qt(1).subtract(Mn(s,1)))):this.outside?n=n.add(Qt(2).multiply(Mn(s,1))):this.highlight&&(n=n.add(Qt(2).multiply(Qt(1).subtract(this._checkHighlight(s))))),null!=e){const t=new Ct(1).subtract(Ye(e.x,this.view.currentZoom)),s=Ye(e.y,this.view.currentZoom);n=n.add(new Ct(2).multiply(t.add(s)))}return n}getFragmentOutput(t,e,n=new Ct(1/255)){const s=new $n;return s.glFragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,n)??t,s}_maybeHighlight(t,e){return this.highlight?new At(t.rgb,Ye(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let n=1;n<r;n++)e=e.add(this._checkHighlightBit(t,n));return Ye(new Ct(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return zn(t,e).multiply(kn(this.highlight.activeReasons,e))}maybeRunHittest(t,e,n){if(null==this.hittestRequest)return null;const s=this.hittest(t,e,n);let i=fe(Te(s,this.hittestRequest.distance),new Ct(2),new Ct(0));const r=this.storage.getAttributeDataCoords(t.id),o=Dn(r);i=i.add(this.clip(t.id,t.zoomRange));const a=new At(new Ct(1/255),0,0,0);return{glPointSize:new Ct(1),glPosition:new At(o,i,1),color:a}}_maybeWriteHittest(t){return null!=this.hittestRequest?t.color:null}}n([vn],Wn.prototype,"inside",void 0),n([vn],Wn.prototype,"outside",void 0),n([wn(Un)],Wn.prototype,"highlight",void 0),n([mn(En)],Wn.prototype,"storage",void 0),n([mn(Ln)],Wn.prototype,"view",void 0),n([wn(Gn)],Wn.prototype,"hittestRequest",void 0);function Kn(t,e){return Ne(t,We(e))}function qn(t,e,n){const s=n.subtract(e),i=Kn(t.subtract(e),s),r=Ve(i.divide(Ge(s)),new Ct(0),new Ct(1));return Re(t,e.add(r.multiply(n.subtract(e))))}function Zn(t){const e=Ce(t);return Ye(e.x.add(e.y).add(e.z),new Ct(1.05))}function Jn(t,e,n,s){const i=new qt(n.x.multiply(s.y).subtract(s.x.multiply(n.y)),s.x.multiply(e.y).subtract(e.x.multiply(s.y)),e.x.multiply(n.y).subtract(n.x.multiply(e.y)),n.y.subtract(s.y),s.y.subtract(e.y),e.y.subtract(n.y),s.x.subtract(n.x),e.x.subtract(s.x),n.x.subtract(e.x)),r=e.x.multiply(n.y.subtract(s.y)),o=n.x.multiply(s.y.subtract(e.y)),a=s.x.multiply(e.y.subtract(n.y)),c=r.add(o).add(a);return new Ct(1).divide(c).multiply(i.multiply(new zt(1,t)))}function Xn(t,e,n,s){return be(Zn(Jn(t,e,n,s)),new Ct(1))}function Qn(t,e,n,s){const i=n.subtract(e),r=s.subtract(e),o=Pn(i,r),a=De($e(o,new Ct(k)),Te(o,new Ct(-k)));return de([De(Ke(a),Xn(t.xy,e,n,s)),new Ct(-1)],[!0,()=>{const i=qn(t,e,n),r=qn(t,n,s),o=qn(t,s,e);return He(He(i,r),o)}])}function Yn(t){return t.distance.add(1)}function ts(t,e,n){const{viewMat3:s,tileMat3:i}=t.view,r=s.multiply(i),o=r.multiply(new zt(e.pos,1)),a=r.multiply(new zt(n.nextPos1,1)),c=r.multiply(new zt(n.nextPos2,1));return Qn(t.hittestRequest.position,o.xy,a.xy,c.xy)}function es(t,e,n){return Re(t,n).subtract(e)}class ns extends Sn{getColor(t,e,n){return de([_e(_n(t),n),e],[Se(t,this.values.first()),this.colors.first()],[Oe(t,this.values.last()),this.colors.last()],[!0,()=>{const e=this.values.findIndex((e=>Te(e,t))),n=this.values.get(e),s=e.subtract(1),i=this.values.get(s),r=t.subtract(i).divide(n.subtract(i));return je(this.colors.get(s),this.colors.get(e),r)}])}}n([mn(Dt.ofType(At,8))],ns.prototype,"colors",void 0),n([mn(Dt.ofType(Ct,8))],ns.prototype,"values",void 0);class ss extends Sn{getOpacity(t){return de([_n(t),new Ct(1)],[Se(t,this.opacityValues.first()),this.opacities.first()],[Oe(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex((e=>Te(e,t))),n=this.opacityValues.get(e),s=e.subtract(1),i=this.opacityValues.get(s),r=t.subtract(i).divide(n.subtract(i));return je(this.opacities.get(s),this.opacities.get(e),r)}])}}n([mn(Dt.ofType(Ct,8))],ss.prototype,"opacities",void 0),n([mn(Dt.ofType(Ct,8))],ss.prototype,"opacityValues",void 0);function is(t){return null!=t.visualVariableSizeMinMaxValue||null!=t.visualVariableSizeScaleStops||null!=t.visualVariableSizeStops||null!=t.visualVariableSizeUnitValue}function rs(t,e,n){if(is(t)){const s=t.storage.getSizeValue(e);return t.visualVariableSizeMinMaxValue?.getSize(s,n)??t.visualVariableSizeScaleStops?.getSizeForViewScale(t.view.currentScale)??t.visualVariableSizeStops?.getSize(s,n)??t.visualVariableSizeUnitValue?.getSize(s,n)}return n}function os(t,e,n,s=new Nt(!1)){if(null==t.visualVariableColor)return n;const i=t.storage.getColorValue(e);return t.visualVariableColor.getColor(i,n,s)}function as(t,e){if(null==t.visualVariableOpacity)return new Ct(1);const n=t.storage.getOpacityValue(e);return t.visualVariableOpacity.getOpacity(n)}function cs(t,e){if(null==t.visualVariableRotation)return qt.identity();const n=t.storage.getRotationValue(e);return t.visualVariableRotation.getVVRotationMat3(n)}function us(t,e){if(null==t.visualVariableRotation)return new Ct(0);const n=t.storage.getRotationValue(e);return t.visualVariableRotation.getNormalizedAngle(n)}class ls extends Hn{}n([dn(3,At)],ls.prototype,"color",void 0),n([dn(4,Mt)],ls.prototype,"zoomRange",void 0);class hs extends Wn{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const n=as(this,t.id),s=os(this,t.id,t.color).multiply(n),i=this.view.displayViewScreenMat3.multiply(new zt(t.pos.xy,1)),r=this.clip(t.id,t.zoomRange);return{glPosition:new At(i.xy,r,1),color:s,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new Ct(0))}hittest(t,e){return ts(this,t,e)}}n([wn(ns)],hs.prototype,"visualVariableColor",void 0),n([wn(ss)],hs.prototype,"visualVariableOpacity",void 0),n([a(0,pn(ls)),a(1,pn(jn))],hs.prototype,"vertex",null),n([a(0,pn(Bn))],hs.prototype,"fragment",null);class fs extends Sn{getPatternOffsetAtTileOrigin(t,e=new Ct(0),n=new Ct(1)){const s=new Mt(N).divide(t);let i=t.multiply(Ue(this.maxIntsToLocalOrigin.multiply(s))).add(this.tileOffsetFromLocalOrigin).subtract(new Ct(.5).multiply(t));return i=new Mt(i.x.multiply(n).subtract(i.y.multiply(e)),i.x.multiply(e).add(i.y.multiply(n))),Be(i,t)}}n([mn(Mt)],fs.prototype,"tileOffsetFromLocalOrigin",void 0),n([mn(Mt)],fs.prototype,"maxIntsToLocalOrigin",void 0);class ds extends Sn{}n([mn(Mt)],ds.prototype,"size",void 0),n([mn(kt)],ds.prototype,"texture",void 0);class ps extends ls{}n([dn(5,At)],ps.prototype,"tlbr",void 0),n([dn(6,Ct)],ps.prototype,"width",void 0),n([dn(7,Ct)],ps.prototype,"height",void 0),n([dn(8,Mt)],ps.prototype,"offset",void 0),n([dn(9,Mt)],ps.prototype,"scale",void 0),n([dn(10,Ct)],ps.prototype,"angle",void 0);class ms extends Bn{}function ws(t,e,n,s,i){const r=be(kn(i,A),Qt(1)),o=In(new At(t,0));return fe(r,ne(s.divide(e.x),n.divide(e.y),0,ce(n.divide(e.x)),s.divide(e.y),0,On(Yt(o,0)),On(Yt(0,o)),1),ne(s.divide(e.x),n.divide(e.y),0,ce(n.divide(e.x)),s.divide(e.y),0,0,0,1))}function vs(t,e){const n=t.view.requiredZoomFactor,s=new Mt(e.width,e.height),i=s.multiply(e.scale).multiply(n),r=e.angle.multiply($),o=Je(r),a=Fe(r),c=ws(e.id,i,o,a,e.bitset),u=t.localTileOffset.getPatternOffsetAtTileOrigin(s,o,a),l=n.multiply(e.scale).multiply(e.offset.subtract(u)).divide(i),h=new zt(e.pos,1),f=c.multiply(h).xy.subtract(l),d=e.tlbr.divide(t.mosaicInfo.size.xyxy);let p=kn(e.bitset,M);return null!=t.visualVariableColor&&(p=fe(_n(t.storage.getColorValue(e.id)),new Ct(0),p)),{tileTextureCoord:f,tlbr:d,sampleAlphaOnly:p}}function gs(t,e){const n=Be(e.tileTextureCoord,new Ct(1)),s=je(e.tlbr.xy,e.tlbr.zw,n);let i=tn(t.mosaicInfo.texture,s);return i=fe(Te(e.sampleAlphaOnly,new Ct(.5)),i.aaaa,i),e.color.multiply(i)}class ys extends hs{vertex(t,e){return{...super.vertex(t,e),...vs(this,t)}}fragment(t){const e=gs(this,t);return this.getFragmentOutput(e,t,new Ct(0))}}n([mn(ds)],ys.prototype,"mosaicInfo",void 0),n([mn(fs)],ys.prototype,"localTileOffset",void 0),n([a(0,pn(ps)),a(1,pn(jn))],ys.prototype,"vertex",null),n([a(0,pn(ms))],ys.prototype,"fragment",null);class xs extends Sn{getSize(t,e){const n=this.minMaxValueAndSize.xy,s=this.minMaxValueAndSize.zw;return fe(_n(t),e,(()=>{const e=t.subtract(n.x).divide(n.y.subtract(n.x)),i=Ve(e,new Ct(0),new Ct(1));return s.x.add(i.multiply(s.y.subtract(s.x)))}))}}n([mn(At)],xs.prototype,"minMaxValueAndSize",void 0);class bs extends Sn{getSizeForViewScale(t){return de([Se(t,this.values.first()),this.sizes.first()],[Oe(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>Te(e,t))),n=this.values.get(e),s=e.subtract(1),i=this.values.get(s),r=t.subtract(i).divide(n.subtract(i));return je(this.sizes.get(s),this.sizes.get(e),r)}])}}n([mn(Dt.ofType(Ct,8))],bs.prototype,"sizes",void 0),n([mn(Dt.ofType(Ct,8))],bs.prototype,"values",void 0);class $s extends Sn{getSize(t,e){const n=de([_n(t),e],[Se(t,this.values.first()),this.sizes.first()],[Oe(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>Te(e,t))),n=this.values.get(e),s=e.subtract(1),i=this.values.get(s),r=t.subtract(i).divide(n.subtract(i));return je(this.sizes.get(s),this.sizes.get(e),r)}]);return fe(_n(n),e,n)}}n([mn(Dt.ofType(Ct,8))],$s.prototype,"sizes",void 0),n([mn(Dt.ofType(Ct,8))],$s.prototype,"values",void 0);class Ss extends Sn{getSize(t,e){return fe(_n(t),e,t.multiply(this.unitValueToPixelsRatio))}}n([mn(Ct)],Ss.prototype,"unitValueToPixelsRatio",void 0);class Ts extends Hn{}n([dn(3,At)],Ts.prototype,"color",void 0),n([dn(4,Mt)],Ts.prototype,"offset",void 0),n([dn(5,Mt)],Ts.prototype,"normal",void 0),n([dn(6,Ct)],Ts.prototype,"halfWidth",void 0),n([dn(7,Ct)],Ts.prototype,"referenceHalfWidth",void 0),n([dn(8,Mt)],Ts.prototype,"zoomRange",void 0);class Os extends Bn{}class _s extends Sn{}function Ps(t){return Le(new Ct(T).multiply(Ye(t,new Ct(O))),new Ct(1))}function Ds(t,e){const{halfWidth:n,normal:s}=t,i=Ps(n),r=Ge(s).multiply(n);return Ve(i.multiply(n.subtract(r)).divide(e.add(i).subtract(new Ct(1))),new Ct(0),new Ct(1))}function ks(t,e){const{id:n,halfWidth:s,referenceHalfWidth:i}=e;if(is(t)){const e=new Ct(2).multiply(i),r=rs(t,n,e);return new Ct(.5).multiply(s.divide(Le(i,new Ct(D)))).multiply(r)}return s}function Cs(t,e){const{id:n,offset:s,pos:i,normal:r,zoomRange:o}=e,{displayViewScreenMat3:a,displayViewMat3:c}=t.view,u=os(t,n,e.color),l=as(t,n),h=ks(t,e),f=new Ct(.5).multiply(t.antialiasingControls.antialiasing),d=Le(h.add(f),new Ct(.45)).add(new Ct(.1).multiply(f)),p=Ps(d).multiply(d).multiply(s),m=c.multiply(new zt(p,new Ct(0))),w=a.multiply(new zt(i,new Ct(1))).add(m),v=new Ct(2).multiply(Ye(h,new Ct(0))).add(t.clip(n,o)),g=new At(w.xy,v,1);return{color:u,opacity:l,halfWidth:d,normal:r,scaledOffset:p,scaledHalfWidth:h,glPosition:new At(g.xy,v,1)}}function Ms(t,e){const{opacity:n,color:s}=t,i=Ds(t,e);return n.multiply(s).multiply(i)}n([mn(Ct)],_s.prototype,"antialiasing",void 0),n([mn(Ct)],_s.prototype,"blur",void 0);class zs extends Wn{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const n=Cs(this,t);return{...n,...this.maybeRunHittest(t,e,n.halfWidth)}}fragment(t){const e=Ms(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,n){const{viewMat3:s,tileMat3:i}=this.view,r=s.multiply(i),o=r.multiply(new zt(t.pos,1)),a=r.multiply(new zt(e.nextPos1,1)),c=r.multiply(new zt(e.nextPos2,1)),{distance:u,smallSymbolDistance:l,smallSymbolSizeThreshold:h}=this.hittestRequest,f=Ye(n,h.multiply(.5)).multiply(u.subtract(l)),d=this.hittestRequest.position;return He(qn(d,o.xy,a.xy),qn(d,o.xy,c.xy)).subtract(n).add(f)}}n([mn(_s)],zs.prototype,"antialiasingControls",void 0),n([wn(ns)],zs.prototype,"visualVariableColor",void 0),n([wn(ss)],zs.prototype,"visualVariableOpacity",void 0),n([wn(xs)],zs.prototype,"visualVariableSizeMinMaxValue",void 0),n([wn(bs)],zs.prototype,"visualVariableSizeScaleStops",void 0),n([wn($s)],zs.prototype,"visualVariableSizeStops",void 0),n([wn(Ss)],zs.prototype,"visualVariableSizeUnitValue",void 0),n([a(0,pn(Ts)),a(1,pn(jn))],zs.prototype,"vertex",null),n([a(0,pn(Os))],zs.prototype,"fragment",null);class As extends Hn{}n([dn(3,Mt)],As.prototype,"offset",void 0),n([dn(4,At)],As.prototype,"color",void 0),n([dn(5,Mt)],As.prototype,"normal",void 0),n([dn(6,Ct)],As.prototype,"halfWidth",void 0),n([dn(7,Ct)],As.prototype,"referenceHalfWidth",void 0),n([dn(8,Mt)],As.prototype,"zoomRange",void 0);class Is extends Os{}function Vs(t,e,n){const{id:s,bitset:i}=e,r=kn(i,z),o=Te(r,new Ct(.5)),a=Cs(t,e),c=fe(o,a.halfWidth,new Ct(0)),u=as(t,s),l=os(t,s,e.color),h=fe(o,e.color,l.multiply(u)),f=t.view.displayViewScreenMat3.multiply(new zt(e.pos.xy,1)),d=t.clip(e.id),p=new At(f.xy,d,1),m=fe(o,a.glPosition,p),w=n&&t.maybeRunHittest(e,n,o);return{isOutline:r,color:h,opacity:new Ct(1),halfWidth:c,normal:a.normal,glPosition:m,...w}}class Fs extends Wn{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}n([mn(_s)],Fs.prototype,"antialiasingControls",void 0),n([wn(ns)],Fs.prototype,"visualVariableColor",void 0),n([wn(ss)],Fs.prototype,"visualVariableOpacity",void 0),n([wn(xs)],Fs.prototype,"visualVariableSizeMinMaxValue",void 0),n([wn(bs)],Fs.prototype,"visualVariableSizeScaleStops",void 0),n([wn($s)],Fs.prototype,"visualVariableSizeStops",void 0),n([wn(Ss)],Fs.prototype,"visualVariableSizeUnitValue",void 0);class Rs extends Fs{vertex(t,e){return Vs(this,t,e)}fragment(t){const{color:e,isOutline:n}=t,s=Te(n,new Ct(.5)),i=Ms(t,this.antialiasingControls.blur),r=fe(s,i,e),o=fe(s,new Ct(1/255),new Ct(0));return this.getFragmentOutput(r,t,o)}hittest(t,e,n){return fe(n,Yn(this.hittestRequest),ts(this,t,e))}}n([a(0,pn(As)),a(1,pn(jn))],Rs.prototype,"vertex",null),n([a(0,pn(Is))],Rs.prototype,"fragment",null);class Ns extends ls{}n([dn(5,At)],Ns.prototype,"tlbr",void 0),n([dn(6,Ct)],Ns.prototype,"inverseRasterizationScale",void 0);class Es extends Bn{}function Us(t){const e=new Ct(1),n=new Ct(0);return new qt(e.divide(t.x),n.divide(t.y),0,ce(n.divide(t.x)),e.divide(t.y),0,0,0,1)}function Gs(t,e){const n=e.tlbr.xy,s=e.tlbr.zw,i=s.x.subtract(n.x),r=n.y.subtract(s.y),o=new Mt(i,r).multiply(e.inverseRasterizationScale),a=o.multiply(t.view.requiredZoomFactor),c=Us(a),u=t.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),l=new zt(e.pos,1);return{tileTextureCoord:c.multiply(l).xy.subtract(u),tlbr:e.tlbr.divide(t.mosaicInfo.size.xyxy)}}function Ls(t,e){const n=Be(t.tileTextureCoord,new Ct(1)),s=je(t.tlbr.xy,t.tlbr.zw,n),i=tn(e.texture,s);return t.color.multiply(i)}class Hs extends hs{vertex(t,e){return{...super.vertex(t,e),...Gs(this,t)}}fragment(t){const e=Ls(t,this.mosaicInfo);return this.getFragmentOutput(e,t,new Ct(0))}}n([mn(ds)],Hs.prototype,"mosaicInfo",void 0),n([mn(fs)],Hs.prototype,"localTileOffset",void 0),n([a(0,pn(Ns)),a(1,pn(jn))],Hs.prototype,"vertex",null),n([a(0,pn(Es))],Hs.prototype,"fragment",null);class js extends As{}n([dn(9,At)],js.prototype,"tlbr",void 0),n([dn(10,Ct)],js.prototype,"inverseRasterizationScale",void 0);class Bs extends Is{}class Ws extends Rs{vertex(t,e){return{...Vs(this,t,e),...Gs(this,t)}}fragment(t){const{isOutline:e}=t,n=Te(e,new Ct(.5)),s=Ms(t,this.antialiasingControls.blur),i=Ls(t,this.mosaicInfo),r=fe(n,s,i),o=fe(n,new Ct(1/255),new Ct(0));return this.getFragmentOutput(r,t,o)}}n([mn(ds)],Ws.prototype,"mosaicInfo",void 0),n([mn(fs)],Ws.prototype,"localTileOffset",void 0),n([a(0,pn(js)),a(1,pn(jn))],Ws.prototype,"vertex",null),n([a(0,pn(Bs))],Ws.prototype,"fragment",null);const Ks=16,qs=1/Ks,Zs=128;class Js extends Hn{}n([dn(3,At)],Js.prototype,"color",void 0),n([dn(4,At)],Js.prototype,"tlbr",void 0),n([dn(5,Ct)],Js.prototype,"angle",void 0),n([dn(6,Ct)],Js.prototype,"aux1",void 0),n([dn(7,Ct)],Js.prototype,"aux2",void 0),n([dn(8,Mt)],Js.prototype,"aux3",void 0),n([dn(9,Mt)],Js.prototype,"aux4",void 0),n([dn(10,Mt)],Js.prototype,"zoomRange",void 0);class Xs extends Bs{}class Qs extends Fs{vertex(t,e){const{aux1:n,aux2:s,aux3:i,aux4:r}=t,o={...t,width:n,height:s,offset:i,scale:r.multiply(qs)},a={...t,halfWidth:n,referenceHalfWidth:s,offset:i,normal:r.subtract(Zs).multiply(qs)},c=Vs(this,a),u=vs(this,o),l=Te(c.isOutline,new Ct(.5));return{...c,...u,...this.maybeRunHittest(t,e,l)}}fragment(t){const{isOutline:e}=t,n=Te(e,new Ct(.5)),s=Ms(t,this.antialiasingControls.blur),i=gs(this,t),r=fe(n,s,i),o=fe(n,new Ct(1/255),new Ct(0));return this.getFragmentOutput(r,t,o)}hittest(t,e,n){return fe(n,Yn(this.hittestRequest),ts(this,t,e))}}n([mn(ds)],Qs.prototype,"mosaicInfo",void 0),n([mn(fs)],Qs.prototype,"localTileOffset",void 0),n([a(0,pn(Js)),a(1,pn(jn))],Qs.prototype,"vertex",null),n([a(0,pn(Xs))],Qs.prototype,"fragment",null);const Ys=8388607,ti=8388608,ei=t=>t&Ys;function ni(t,e){return((e?ti:0)|t)>>>0}var si;!function(t){t.Local="Local",t.Global="Global"}(si||(si={}));class ii{generateSource(t){const e=[];for(let n=1;n<this.length;n++)e.push(`vec4 atom${n} = texture(${t.animationTexture}, (pointer + 0.5) / size);`),e.push("pointer.x += 1.0;");for(let t=0;t<this.ins;t++)e.push("top--;"),e.push(`vec4 in${this.ins-t-1} = stack[top];`);for(let t=0;t<this.outs;t++)e.push(`vec4 out${t};`);const{microcode:n}=this;for(const t of n)e.push(t);for(let t=0;t<this.outs;t++)e.push(`stack[top] = out${t};`),e.push("top++;"),e.push(`if (top >= ${yi}) { top = ${yi-1}; }`);return e}}let ri=128;class oi extends ii{constructor(){super(...arguments),this.opcode=++ri,this.length=1,this.ins=0,this.outs=0,this.microcode=["break;"]}encode(){return[[this.opcode,0,0,0]]}}class ai extends ii{constructor(){super(...arguments),this.opcode=++ri,this.length=1,this.ins=0,this.outs=1,this.microcode=["out0 = vec4(atom0.y, atom0.y, atom0.y, atom0.y);"]}encode(t){return[[this.opcode,t,0,0]]}}class ci extends ii{constructor(){super(...arguments),this.opcode=++ri,this.length=1,this.ins=0,this.outs=1,this.microcode=["out0 = vec4(atom0.yzw, 0.0);"]}encode(t){return[[this.opcode,t[0]||0,t[1]||0,t[2]||0]]}}class ui extends ii{constructor(){super(...arguments),this.opcode=++ri,this.length=2,this.ins=0,this.outs=1,this.microcode=["out0 = atom1;"]}encode(t){return[[this.opcode,0,0,0],t]}}function li(t){return[`float duration = clamp(${t.duration}, 0.05, 3600.0);`,`float startTimeOffset = ${t.startTimeOffset};`,`float repeatDelay = ${t.repeatDelay};`,`float timeOriginSelector = ${t.timeOriginSelector};`,`float repeatType = ${t.repeatType};`,`float easing = ${t.easing};`,`float playAnimation = ${t.playAnimation} * (1.0 - step(0.0, -${t.duration}));`,`float reverseAnimation = ${t.reverseAnimation};`,"float time = globalTime - (timeOriginSelector == 1.0 ? localTimeOrigin : 0.0);","time *= playAnimation;","time *= 1.0 - reverseAnimation * 2.0;","float period = duration + repeatDelay;","time += reverseAnimation == 1.0 ? (period - startTimeOffset - 0.001) : startTimeOffset + 0.001;","float omega = time / period;","float oi = floor(omega);","omega = repeatType == 1.0 || repeatType == 3.0 ? omega - oi : omega;","float of = omega * period;","of = (clamp(of, reverseAnimation * repeatDelay, period - (1.0 - reverseAnimation) * repeatDelay) - reverseAnimation * repeatDelay) / duration;","of = easing == 2.0 ? pow(of, 3.0) : of;","of = easing == 3.0 ? 1.0 - pow(1.0 - of, 3.0) : of;","of = easing == 4.0 ? of < 0.5 ? 4.0 * pow(of, 3.0) : 1.0 - pow(-2.0 * of + 2.0, 3.0) / 2.0 : of;","bool oscillate = repeatType == 3.0 && mod(oi, 2.0) == 1.0;",`${t.out} = oscillate ? 1.0 - of : of;`]}const hi={Linear:1,EaseIn:2,EaseOut:3,EaseInOut:4},fi={Loop:1,None:2,Oscillate:3},di={Local:1,Global:2};function pi(t){const e=hi[t.easing],n=fi[t.repeatType],s=di[t.timeOriginSelector];return[[t.duration,t.startTimeOffset,t.repeatDelay,s],[n,e,t.playAnimation,t.reverseAnimation]]}class mi extends ii{constructor(){super(...arguments),this.opcode=++ri,this.length=10,this.ins=1,this.outs=1,this.microcode=["vec2 fromTranslation = atom1.xy;","vec2 toTranslation = atom1.zw;","float fromRotation = atom2.x;","float toRotation = atom2.y;","float fromScale = atom2.z;","float toScale = atom2.w;","bool relativeTranslation = atom9.x == 1.0;","bool absoluteScale = atom9.y == 1.0;","vec2 translationMultiplier = relativeTranslation ? pixelDimensions : vec2(1.0, 1.0);","float scaleDivisor = absoluteScale ? pixelDimensions.y : 1.0;","float fTranslation;","{",...li({duration:"atom3.x",startTimeOffset:"atom3.y",repeatDelay:"atom3.z",timeOriginSelector:"atom3.w",repeatType:"atom4.x",easing:"atom4.y",playAnimation:"atom4.z",reverseAnimation:"atom4.w",out:"fTranslation"}),"}","float fRotation;","{",...li({duration:"atom5.x",startTimeOffset:"atom5.y",repeatDelay:"atom5.z",timeOriginSelector:"atom5.w",repeatType:"atom6.x",easing:"atom6.y",playAnimation:"atom6.z",reverseAnimation:"atom6.w",out:"fRotation"}),"}","float fScale;","{",...li({duration:"atom7.x",startTimeOffset:"atom7.y",repeatDelay:"atom7.z",timeOriginSelector:"atom7.w",repeatType:"atom8.x",easing:"atom8.y",playAnimation:"atom8.z",reverseAnimation:"atom8.w",out:"fScale"}),"}","vec2 aTranslation = mix(fromTranslation, toTranslation, fTranslation);","float aRotation = mix(fromRotation, toRotation, fRotation);","float aScale = mix(fromScale, toScale, fScale);","vec2 pTranslation = in0.xy;","float pRotation = in0.z;","float pScale = in0.w;","aTranslation *= translationMultiplier;","aScale /= scaleDivisor;","float rotation = pRotation + aRotation;","float scale = pScale * aScale;","float sin1 = sin(pRotation);","float cos1 = cos(pRotation);","float s1 = pScale;","float x1 = pTranslation.x;","float y1 = pTranslation.y;","float x2 = aTranslation.x;","float y2 = aTranslation.y;","\n    vec2 translation = vec2(\n      cos1 * s1 * x2 - sin1 * s1 * y2 + x1,\n      sin1 * s1 * x2 + cos1 * s1 * y2 + y1\n    );\n    ","out0 = vec4(translation, rotation, scale);"]}encode(t){return[[this.opcode,0,0,0],[t.translation.from[0],t.translation.from[1],t.translation.to[0],t.translation.to[1]],[t.rotation.from,t.rotation.to,t.scale.from,t.scale.to],...pi(t.translation.timing),...pi(t.rotation.timing),...pi(t.scale.timing),[t.relativeTranslation?1:0,t.absoluteScale?1:0,0,0]]}}class wi extends ii{constructor(){super(...arguments),this.opcode=++ri,this.length=7,this.ins=1,this.outs=1,this.microcode=["float fromOpacity = atom0.y;","float toOpacity = atom0.z;","vec4 fromColor = atom1;","vec4 toColor = atom2;","float fColor;","{",...li({duration:"atom3.x",startTimeOffset:"atom3.y",repeatDelay:"atom3.z",timeOriginSelector:"atom3.w",repeatType:"atom4.x",easing:"atom4.y",playAnimation:"atom4.z",reverseAnimation:"atom4.w",out:"fColor"}),"}","float fOpacity;","{",...li({duration:"atom5.x",startTimeOffset:"atom5.y",repeatDelay:"atom5.z",timeOriginSelector:"atom5.w",repeatType:"atom6.x",easing:"atom6.y",playAnimation:"atom6.z",reverseAnimation:"atom6.w",out:"fOpacity"}),"}","vec4 aColor = mix(fromColor, toColor, fColor);","aColor.a *= mix(fromOpacity, toOpacity, fOpacity);","vec4 pColor = in0;","out0 = aColor * pColor;"]}encode(t){return[[this.opcode,t.opacity.from,t.opacity.to,0],[t.color.from[0],t.color.from[1],t.color.from[2],t.color.from[3]],[t.color.to[0],t.color.to[1],t.color.to[2],t.color.to[3]],...pi(t.color.timing),...pi(t.opacity.timing)]}}const vi={scalar:new ai,vector3:new ci,vector4:new ui,animatedTransform:new mi,animatedColor:new wi,ret:new oi},gi=40,yi=4;function xi(t){const e=[];e.push(`float globalTime = ${t.globalTime};`),e.push(`float localTimeOrigin = ${t.localTimeOrigin};`),e.push(`vec2 pointer = ${t.animationPointer};`),e.push(`vec2 size = ${t.animationTextureSize};`),e.push("int top = 0;"),e.push(`vec4 stack[${yi}];`),e.push(`for (int counter = 0; counter < ${gi}; counter++) {`),e.push(`vec4 atom0 = texture(${t.animationTexture}, (pointer + 0.5) / size);`),e.push("pointer.x += 1.0;"),e.push(`vec2 pixelDimensions = ${t.pixelDimensions};`),e.push("if (false) {");for(const n in vi){const s=vi[n];e.push(`} else if (int(atom0.x) == ${s.opcode}) {`);for(const n of s.generateSource(t))e.push(n)}return e.push("} // End if-else."),e.push("} // End for."),e.push(`${t.out} = top > 0 ? stack[top - 1] : vec4(0.0);`),e.join("\n")}let bi=class extends l{constructor(t){super(t),this.debugName="",this._updatingHandles=new h,this._idToUpdatingState=new f}get updating(){const t=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some((t=>t));if(o("esri-2d-log-updating")){const e=Array.from(this._idToUpdatingState.entries()).map((([t,e])=>`-> ${t}: ${e}`)).join("\n");console.log(`${this.debugName}: Updating: ${t}\n-> Handles: ${this._updatingHandles.updating}\n${e}`)}return t}addUpdateTracking(t,e){const n=d((()=>e.updating),(e=>this._idToUpdatingState.set(t,e)),{sync:!0});this.addHandles(n)}addPromise(t){return this._updatingHandles.addPromise(t)}};n([c({constructOnly:!0})],bi.prototype,"debugName",void 0),n([c({readOnly:!0})],bi.prototype,"updating",null),bi=n([u("esri.views.2d.layers.support.UpdateTracking2D")],bi);export{wn as $,qt as A,Ue as B,Mt as C,Fn as D,Rn as E,Xe as F,zt as G,At as H,yn as I,qe as J,vn as K,ge as L,je as M,bi as N,Ht as O,Sn as P,Ze as Q,Zt as R,kt as S,pe as T,be as U,Ae as V,_n as W,x as X,Ce as Y,Je as Z,b as _,Tn as a,ei as a$,Hn as a0,Wn as a1,us as a2,In as a3,S as a4,ds as a5,ns as a6,ss as a7,xs as a8,bs as a9,ys as aA,Qs as aB,Rs as aC,Hs as aD,Ws as aE,es as aF,Ee as aG,_ as aH,cs as aI,P as aJ,ye as aK,xe as aL,F as aM,R as aN,zs as aO,Ts as aP,Cs as aQ,Ds as aR,jn as aS,I as aT,V as aU,M as aV,ln as aW,A as aX,z as aY,Ks as aZ,Zs as a_,$s as aa,Ss as ab,ue as ac,xi as ad,Bn as ae,xn as af,kn as ag,Kt as ah,$ as ai,rs as aj,os as ak,_e as al,Nt as am,Cn as an,as as ao,Re as ap,Qn as aq,Jn as ar,ce as as,Zn as at,Yn as au,y as av,Ln as aw,Dt as ax,Vn as ay,hs as az,Ve as b,vi as b0,Ys as b1,ni as b2,C as b3,de as c,Te as d,g as e,$e as f,mn as g,dn as h,Se as i,Ct as j,He as k,tn as l,pn as m,Le as n,Nn as o,Ne as p,Qe as q,Ye as r,E as s,si as t,Ge as u,bn as v,$n as w,fe as x,Fe as y,Dn as z};
//# sourceMappingURL=p-2d2f231a.js.map