{"version":3,"names":["x","i","t","e","y","prototype","h","a","w","s","r","g","S","l","m","j","p","vertex","o","uv","divide","this","config","texSize","add","v","perspective","c","pos","wrapAroundShift","transform","dvs","multiply","glPosition","u","xy","fragment","f","texture","opacity","n","glFragColor","d","constructor","super","arguments","type","Overlay","_mesh","shaders","overlay","render","context","painter","_getMesh","setPipelineState","isWrapAround","shader","uniforms","defines","optionalAttributes","useComputeBuffer","stencil","write","test","compare","EQUAL","op","fail","KEEP","zFail","zPass","REPLACE","ref","mask","submitDrawMeshUntyped","shutdown","vertexBuffers","get","Error","setData","position","index","length","positions","uvs","tex","groups","attributes","name","count","FLOAT","location","stride","offset","UNSIGNED_SHORT","primitive","TRIANGLE_STRIP","parts","group","start","_viewStateId","_dvsMat3","_overlayTechnique","dvsMat3","beforeRender","_updateMatrices","_updateOverlays","children","doRender","drawPhase","MAP","visible","draw","onDetach","state","id","size","pixelRatio","resolution","rotation","viewpoint","displayMat3","_","M","_localOrigin","targetGeometry","clone","b","spatialReference","O","R","worldScreenWidth","isWrappable","Math","abs","cos","sin","round","valid","toScreen","floor","q","G","toMap","worldWidth","xBounds","updateDrawCoords"],"sources":["./node_modules/@arcgis/core/views/2d/engine/webgl/shaderGraph/techniques/shaders/OverlayShader.js","./node_modules/@arcgis/core/views/2d/engine/webgl/shaderGraph/techniques/overlay/OverlayTechnique.js","./node_modules/@arcgis/core/views/2d/engine/webgl/OverlayContainer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{_ as t,a as o}from\"../../../../../../../chunks/tslib.es6.js\";import{location as e,uniform as r,GraphShaderModule as p,VertexInput as i,UniformGroup as s,FragmentOutput as n,input as d,FragmentInput as a}from\"../../GraphShaderModule.js\";import{Float as l,dot as v,Vec3 as c,Vec2 as y,Vec4 as u,texture2D as f,Mat3 as g,Sampler2D as m}from\"../../graph/glsl.js\";class x extends i{}t([e(0,y)],x.prototype,\"pos\",void 0),t([e(1,y)],x.prototype,\"uv\",void 0);class h extends a{}class w extends s{}t([r(g)],w.prototype,\"dvs\",void 0);class S extends s{}t([r(y)],S.prototype,\"perspective\",void 0),t([r(y)],S.prototype,\"texSize\",void 0),t([r(l)],S.prototype,\"wrapAroundShift\",void 0),t([r(l)],S.prototype,\"opacity\",void 0),t([r(m)],S.prototype,\"texture\",void 0);class j extends p{vertex(t){const o=t.uv.divide(this.config.texSize),e=new l(1).add(v(o,this.config.perspective)),r=new c(t.pos.add(new y(this.config.wrapAroundShift,0)),1),p=this.transform.dvs.multiply(r);return{uv:o,glPosition:new u(p.xy.multiply(e),0,e)}}fragment(t){const o=f(this.config.texture,t.uv).multiply(this.config.opacity),e=new n;return e.glFragColor=o,e}}t([r(w)],j.prototype,\"transform\",void 0),t([r(S)],j.prototype,\"config\",void 0),t([o(0,d(x))],j.prototype,\"vertex\",null),t([o(0,d(h))],j.prototype,\"fragment\",null);export{j as OverlayShader};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{destroyMaybe as e}from\"../../../../../../../core/maybe.js\";import{Mesh as t}from\"../../../meshing/Mesh.js\";import{simplePipelineState as s}from\"../../utils.js\";import{Technique as i}from\"../Technique.js\";import{TechniqueType as o}from\"../TechniqueType.js\";import{OverlayShader as r}from\"../shaders/OverlayShader.js\";import{CompareFunction as n,StencilOperation as a,DataType as p,PrimitiveType as h}from\"../../../../../../webgl/enums.js\";class u extends i{constructor(){super(...arguments),this.type=o.Overlay,this._mesh=null,this.shaders={overlay:new r}}render(e,t){const{context:i,painter:o}=e,r=this._getMesh(e,t);o.setPipelineState(s);const{isWrapAround:p,wrapAroundShift:h}=t.config,u={...t.config,wrapAroundShift:0},m={shader:this.shaders.overlay,uniforms:{transform:t.transform,config:u},defines:null,optionalAttributes:null,useComputeBuffer:!1};o.setPipelineState({...s,stencil:{write:!1,test:{compare:n.EQUAL,op:{fail:a.KEEP,zFail:a.KEEP,zPass:a.REPLACE},ref:0,mask:255}}}),o.submitDrawMeshUntyped(i,m,r),p&&(u.wrapAroundShift=h,o.submitDrawMeshUntyped(i,m,r))}shutdown(){e(this._mesh)}_getMesh(e,s){const{context:i}=e;if(this._mesh){const e=this._mesh.vertexBuffers.get(\"positions\");if(!e)throw new Error(\"Buffer not found\");e.setData(s.position)}else{const e=null!=s.index?s.index.length:s.position.length/2;this._mesh=new t(i,{vertex:{positions:s.position,uvs:s.tex},index:null!=s.index?{index:s.index}:void 0,groups:[{attributes:[{name:\"pos\",count:2,type:p.FLOAT,location:0,vertex:\"positions\",stride:8,offset:0},{name:\"tex\",count:2,type:p.UNSIGNED_SHORT,location:1,vertex:\"uvs\",stride:4,offset:0}],index:null!=s.index?\"index\":void 0,primitive:h.TRIANGLE_STRIP}],parts:[{group:0,start:0,count:e}]})}return this._mesh}}export{u as OverlayTechnique};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{toRadian as t}from\"../../../../core/libs/gl-matrix-2/math/common.js\";import{identity as e,multiply as r,translate as o,scale as i,rotate as s}from\"../../../../core/libs/gl-matrix-2/math/mat3.js\";import{create as a}from\"../../../../core/libs/gl-matrix-2/factories/mat3f32.js\";import{fromValues as n}from\"../../../../core/libs/gl-matrix-2/factories/vec2f32.js\";import{fromValues as l}from\"../../../../core/libs/gl-matrix-2/factories/vec3f32.js\";import{normalizeMapX as c}from\"../../../../geometry/support/normalizeUtils.js\";import{getInfo as h}from\"../../../../geometry/support/spatialReferenceUtils.js\";import{getWorldWidth as m}from\"../../viewpointUtils.js\";import{WGLDrawPhase as d}from\"./enums.js\";import p from\"./WGLContainer.js\";import{OverlayTechnique as f}from\"./shaderGraph/techniques/overlay/OverlayTechnique.js\";class u extends p{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=a(),this._overlayTechnique=new f}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const e of this.children)e.beforeRender(t)}doRender(t){if(t.drawPhase!==d.MAP||!this.visible)return;super.doRender(t);const e=this._overlayTechnique;for(const r of this.children)r.draw(t,e)}onDetach(){this._overlayTechnique.shutdown()}_updateMatrices(a){const{state:h}=a,{id:m,size:d,pixelRatio:p,resolution:f,rotation:u,viewpoint:v,displayMat3:_}=h;if(this._viewStateId===m)return;const M=t(u),g=p*d[0],y=p*d[1];this._localOrigin=v.targetGeometry.clone();const{x:w,y:x}=this._localOrigin,b=c(w,h.spatialReference);this._localOrigin.x=b,this._localOrigin.y=x;const j=f*g,O=f*y,R=e(this._dvsMat3);r(R,R,_),o(R,R,n(g/2,y/2)),i(R,R,l(g/j,-y/O,1)),s(R,R,-M),this._viewStateId=m}_updateOverlays(e,r){const{state:o}=e,{rotation:i,spatialReference:s,worldScreenWidth:a,size:n,viewpoint:l}=o,c=this._localOrigin;let d,p=0;const f=h(s);if(f&&s.isWrappable){const e=n[0],r=n[1],c=t(i),h=Math.abs(Math.cos(c)),u=Math.abs(Math.sin(c)),v=Math.round(e*h+r*u),[_,M]=f.valid,g=m(s),{x:y,y:w}=l.targetGeometry,x=[y,w],b=[0,0];o.toScreen(b,x);const j=[0,0];let O;O=v>a?.5*a:.5*v;const R=Math.floor((y+.5*g)/g),q=_+R*g,S=M+R*g,G=[b[0]+O,0];o.toMap(j,G),j[0]>S&&(p=g),G[0]=b[0]-O,o.toMap(j,G),j[0]<q&&(p=-g),d={worldWidth:g,xBounds:[_,M]}}for(const t of r)t.updateDrawCoords(c,p,s,d)}}export{u as default};\n"],"mappings":"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"}