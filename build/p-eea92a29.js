import{ee as t,dY as s,w as i,bD as e,cn as r,er as n,cY as o,n as h,s as a,d8 as p,c4 as l,e8 as c,da as m,ct as d,r as u,p as f,q as j,ac as y,az as w,j3 as b,bE as v,iY as x,iZ as E,i_ as M,kd as g,di as V,E as _,hP as T,ke as A,eF as C}from"./p-aad64c9f.js";import{j as L,m as S}from"./p-30a1162b.js";import"./p-2d2f231a.js";import"./p-b8a25c33.js";import"./p-559f4b2d.js";import"./p-de84037a.js";import{e as q}from"./p-3f2fef32.js";import"./p-682c165c.js";import"./p-1c4b55c0.js";import"./p-22458323.js";import"./p-204b6b8c.js";import"./p-d26004a3.js";import"./p-ae438250.js";import"./p-21ce5524.js";import"./p-591e796f.js";import"./p-01ae94a1.js";import"./p-dc92c2ea.js";import"./p-dddb66c6.js";import"./p-08681176.js";import"./p-4f2b7ad8.js";import"./p-c0b174ee.js";import"./p-717596a8.js";import{e as I}from"./p-79c28fb7.js";import{f as P}from"./p-0527b5ce.js";import{u as R}from"./p-36525d97.js";import{j as k,y as F}from"./p-bbb18646.js";import"./p-2af77f97.js";import"./p-2250105d.js";import"./p-17d8c81f.js";import"./p-dc645a50.js";import"./p-7281a451.js";import"./p-b947b9d2.js";import"./p-aff89b86.js";import"./p-e7a66915.js";import"./p-a0004a96.js";import"./p-2ea4a2b9.js";import"./p-44881b12.js";import"./p-7ce0ff48.js";import"./p-e7002be3.js";import"./p-9ad0e060.js";import"./p-875cbb57.js";import"./p-da522976.js";import"./p-d492d39b.js";import"./p-008cf576.js";import"./p-fa2632fc.js";import"./p-4295487d.js";import"./p-1c285990.js";import"./p-e3657bc3.js";import"./p-bac7b09c.js";import"./p-deddb82e.js";import"./p-55f3e0f9.js";import"./p-b74976e9.js";const z=[1,1],D=I(),O={none:d.None,loop:d.Loop,oscillate:d.Oscillate};function H(t){return t?{type:"CIMAnimatedSymbolProperties",...t,playAnimation:t.playing,repeatType:t.repeatType?O[t.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"}}class Y extends q{constructor(p){super(),this.elementView=p,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=t(),this._handles=new s,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([i((()=>this.elementView.element.opacity),(t=>this.opacity=t),e),i((()=>[this.elementView.coords]),(()=>{this.requestRender()}),e),i((()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions]),(()=>{this._handles.remove("play"),this.texture=r(this.texture),this.requestRender()}),e),n((()=>this.elementView.element.loaded),(()=>{const t=this.elementView.element;this.ready(),"video"===t.type&&null!=t.content&&(this._handles.add([o(t.content,"play",(()=>this.requestRender())),o(t.content,"loadeddata",(()=>this.requestRender())),o(t.content,"loaded",(()=>this.requestRender()))]),"requestVideoFrameCallback"in t.content?t.content.requestVideoFrameCallback((()=>this.requestRender())):this._handles.add([o(t.content,"seeked",(()=>this.requestRender()))]),this.requestRender())}),e)]),p.element.load().catch((t=>{h.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new a("element-load-error","Element cannot be displayed",{element:p,error:t}))}))}getMesh(t){throw new Error("Method not implemented.")}destroy(){this._handles.destroy(),this.texture=r(this.texture)}get textureSize(){return z}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,i=this.elementView.element.content;if(null!=i){const t=i instanceof HTMLImageElement,e=i instanceof HTMLVideoElement,r=t?i.naturalWidth:e?i.videoWidth:i.width,n=t?i.naturalHeight:e?i.videoHeight:i.height;if(this._updatePerspectiveTransform(r,n),this.texture)e&&(this.texture.setData(i),this.texture.generateMipmap(),"requestVideoFrameCallback"in i?i.requestVideoFrameCallback((()=>this.requestRender())):i.paused||this.requestRender());else{const t=new m;if(t.wrapMode=p.CLAMP_TO_EDGE,t.preMultiplyAlpha=!0,t.width=r,t.height=n,"getFrame"in i){const e=i=>{this.texture?this.texture.setData(i):this.texture=new l(s,t,i),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(P(i,H(this.elementView.element.animationOptions),null,e),"play")}else this.texture=new l(s,t,i);this.texture.generateMipmap(),e&&("requestVideoFrameCallback"in i?i.requestVideoFrameCallback((()=>this.requestRender())):i.paused||this.requestRender())}}super.beforeRender(t)}_createTransforms(){return null}draw(t,s){this.isReady&&null!=this.texture?s.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:z,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(t,s,i,e){const{coords:r,bounds:n}=this.elementView;if(null==r||null==n)return;const[o,h,a,p]=r.rings[0],l=this._vertices,{x:c,y:m}=t;l.set([h[0]-c,h[1]-m,o[0]-c,o[1]-m,a[0]-c,a[1]-m,p[0]-c,p[1]-m]);let d=s;if(e){const[t,,s]=n,{worldWidth:i,xBounds:r}=e,[o,h]=r;t<o&&s>o?d=i:s>h&&t<h&&(d=-i)}this.wrapAroundShift=d,this.isWrapAround=0!==d}_updatePerspectiveTransform(t,s){const i=this._vertices;L(D,[0,0,t,0,0,s,t,s],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),c(this.perspectiveTransform,D[6]/D[8]*t,D[7]/D[8]*s)}}let U=class extends y{constructor(){super(...arguments),this.tool="transform"}};u([f()],U.prototype,"tool",void 0),U=u([j("esri.views.3d.layers.support.MediaLayerInteractionOptions")],U);const W=t=>{let s=class extends t{constructor(...t){super(...t),this.layer=null,this.interactive=!1,this.interactionOptions=new U,this.selectedElement=null}};return u([f()],s.prototype,"layer",void 0),u([f()],s.prototype,"interactive",void 0),u([f()],s.prototype,"interactionOptions",void 0),u([f()],s.prototype,"selectedElement",void 0),s=u([j("esri.views.layers.MediaLayerView")],s),s};let B=class extends(k(W(F))){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new w}initialize(){this.addHandles([i((()=>[this.interactive,this.suspended]),(async()=>{if(this.interactive&&!this._interaction){const{MediaLayerInteraction:t}=await import("./p-c2e4891b.js");this._interaction=new t({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)}),b),i((()=>this.interactionOptions),(t=>{this._interaction&&(this._interaction.options=t)}),b),i((()=>this.selectedElement),(t=>{this._interaction&&(this._interaction.selectedElement=t)}),b)])}attach(){this.addAttachHandles([v((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((t=>this._updateTile(t))),this.requestUpdate()})),v((()=>this.layer.effectiveSource),"change",(({element:t})=>this._elementUpdateHandler(t)))]),this._overlayContainer=new R,this.container.addChild(this._overlayContainer),this._fetchQueue=new x({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(t,s)=>this._queryElements(t,s),scheduler:this.scheduler,priority:E.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new M({cachePolicy:"purge",resampling:!0,acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(t){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(t){this._tileStrategy.update(t),this._debugGraphicsView?.update(t)}async hitTest(t,s){const i=[],e=t.normalize(),r=[e.x,e.y];for(const{elementView:{normalizedCoords:s,element:e}}of this._elementReferences.values())null!=s&&g(s.rings,r)&&i.push({type:"media",element:e,layer:this.layer,mapPoint:t,sourcePoint:e.toSource(t)});return i.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((t=>this._updateTile(t)))}_acquireTile(t){const s=new K(t.clone());return this._updateTile(s),s}_updateTile(t){this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then((s=>{const[i,e]=t.setElements(s);this._referenceElements(t,i),this._dereferenceElements(t,e),this.requestUpdate()}),(t=>{V(t)||h.getLogger(this).error(t)})))}_releaseTile(t){this._fetchQueue.abort(t.key.id),t.elements&&this._dereferenceElements(t,t.elements),this.requestUpdate()}async _queryElements(t,s){const i=this.layer.effectiveSource;if(null==i)return[];this.view.featuresTilingScheme.getTileBounds(G,t,!0);const e=new _({xmin:G[0],ymin:G[1],xmax:G[2],ymax:G[3],spatialReference:this.view.spatialReference});return i.queryElements(e,s)}_referenceElements(t,s){if(null!=this.layer.source)for(const i of s)this._referenceElement(t,i)}_referenceElement(t,s){T(this._elementReferences,s.uid,(()=>{const t=new S({element:s,spatialReference:this.view.spatialReference}),i=new Y(t);return this._overlayContainer.addChild(i),this.elements.add(s),this._updatingHandles.addPromise(s.load().catch((t=>{h.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new a("element-load-error","Element cannot be displayed",{element:s,error:t}))}))),{debugGraphic:null,elementView:t,overlay:i,tiles:new Set}})).tiles.add(t)}_dereferenceElements(t,s){for(const i of s)this._dereferenceElement(t,i)}_dereferenceElement(t,s){const i=this._elementReferences.get(s.uid);i.tiles.delete(t),i.tiles.size||(this._overlayContainer.removeChild(i.overlay),i.overlay.destroy(),i.elementView.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s),this._debugGraphicsView?.graphics.remove(i.debugGraphic))}_elementUpdateHandler(t){let s=this._elementReferences.get(t.uid);if(s){const i=s.elementView.normalizedCoords;if(null==i)return this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),void this._debugGraphicsView?.graphics.remove(s.debugGraphic);const e=[],r=[];for(const t of this._tileStrategy.tiles){const n=J(this.view.featuresTilingScheme,t,i);s.tiles.has(t)?n||r.push(t):n&&e.push(t)}for(const s of e)this._referenceElement(s,t);for(const s of r)this._dereferenceElement(s,t);return s=this._elementReferences.get(t.uid),void(s?.debugGraphic&&(s.debugGraphic.geometry=s.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:s.debugGraphic,property:"geometry"})))}const i=new S({element:t,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=i)for(const s of this._tileStrategy.tiles){J(this.view.featuresTilingScheme,s,i)&&this._referenceElement(s,t)}}};u([f()],B.prototype,"layer",void 0),u([f({readOnly:!0})],B.prototype,"elements",void 0),B=u([j("esri.views.2d.layers.MediaLayerView2D")],B);const G=C(),Z={xmin:0,ymin:0,xmax:0,ymax:0};function J(t,s,i){return t.getTileBounds(G,s.key,!0),Z.xmin=G[0],Z.ymin=G[1],Z.xmax=G[2],Z.ymax=G[3],A(Z,i)}class K{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const s=[],i=new Set(this.elements);this.elements=t;for(const e of t)i.has(e)?i.delete(e):s.push(e);return this.isReady=!0,[s,Array.from(i)]}destroy(){}}const N=B;export default N;
//# sourceMappingURL=p-eea92a29.js.map