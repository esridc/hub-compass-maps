import{an as e,ao as t,ap as s,dc as i,am as r,h as n,b6 as a,fx as o,dC as l,bt as u,e as c,b7 as h,aO as d,a as f,s as p,c9 as y,W as m,Z as b,fI as g,y as v,ca as S,fJ as w,al as I,bk as F,u as V,fK as x,ft as E,f4 as R,fL as O,fM as z,fN as P,g as T,ds as C,dL as M,fO as _,bj as A,fP as q,fQ as j,fR as $,ah as B,fn as L,ec as k,fG as D,fS as U,b_ as N,fT as H,fE as J,fU as K,fV as G,fW as Z,fX as W,fY as X,fD as Y,fZ as Q,f_ as ee,di as te,dK as se,aY as ie,cH as re,cB as ne,ai as ae,af as oe,R as le,c2 as ue,f$ as ce,X as he}from"./p-3013819f.js";import{t as de}from"./p-7b13247d.js";import{m as fe,u as pe}from"./p-4e55d8f0.js";import{i as ye,r as me}from"./p-b6b871c6.js";import{E as be,R as ge,b as ve,N as Se}from"./p-0d83e514.js";import{aK as we}from"./p-ffa11fc1.js";import{b as Ie}from"./p-d97e7de8.js";import{o as Fe}from"./p-9a31fdd8.js";import{K as Ve,o as xe,n as Ee,Z as Re}from"./p-a9376829.js";import{i as Oe,o as ze}from"./p-30a1f911.js";import{e as Pe}from"./p-5f4832a0.js";import{P as Te}from"./p-b362a32c.js";import{b as Ce,n as Me,c as _e,i as Ae,d as qe,e as je,f as $e,x as Be,t as Le,m as ke,g as De,a as Ue}from"./p-72db18d5.js";import{t as Ne}from"./p-90032174.js";import{p as He,n as Je}from"./p-c779faaf.js";import{i as Ke}from"./p-0482b904.js";let Ge=class extends i{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer?.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};e([t({type:Boolean})],Ge.prototype,"isAggregate",void 0),Ge=e([s("esri.AggregateGraphic")],Ge);const Ze=Ge;let We=class extends r{constructor(e){super(e),this._filter=null,this.duration=n("mapview-transitions-duration"),this._excludedEffectView=new a(e),this._includedEffectView=new a(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),s=e,i=s?.includedEffect,r=s?.excludedEffect,n=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(r);this._includedEffectView.effect=i,this._excludedEffectView.effect=r,this._set("featureEffect",s),this._filter=s?.filter||t?.filter||null,n||this.endTransitions()}};e([t()],We.prototype,"_filter",void 0),e([t()],We.prototype,"_excludedEffectView",void 0),e([t()],We.prototype,"_includedEffectView",void 0),e([t()],We.prototype,"duration",void 0),e([t()],We.prototype,"excludedEffects",null),e([t()],We.prototype,"featureEffect",null),e([t()],We.prototype,"filter",null),e([t()],We.prototype,"hasEffects",null),e([t()],We.prototype,"includedEffects",null),e([t({value:0})],We.prototype,"scale",null),e([t()],We.prototype,"transitioning",null),We=e([s("esri.layers.effects.FeatureEffectView")],We);const Xe=We;let Ye=class extends l{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const s=u.fromJSON(t.spatialReference),i=[];for(let t=0;t<e.length;t++){const r=e[t],n=Ze.fromJSON(r),a=r.geometry?.spatialReference;null==n.geometry||a||(n.geometry.spatialReference=s);const o=r.aggregateGeometries,l=n.aggregateGeometries;if(o&&null!=l)for(const e in l){const t=l[e],i=o[e],r=i?.spatialReference;null==t||r||(t.spatialReference=s)}i.push(n)}return i}};e([t({type:[Ze],json:{write:!0}})],Ye.prototype,"features",void 0),e([o("features")],Ye.prototype,"readFeatures",null),Ye=e([s("esri.rest.support.AggregateFeatureSet")],Ye);const Qe=Ye;class et{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}updateStart(){this._instanceByIdNext=new Map}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(const[e,t]of this._instanceByIdNext.entries()){const s=this._instanceById.get(e);s?s.setInput(t.getInput()):this._instanceById.set(e,t)}this._instanceByIdNext=null}values(){return this._instanceById.values()}ensureInstance(e,t,s){let i=`${e.registryName}`;for(const e in t){const s=t[e];if("object"==typeof s&&"geometry"===e)for(const t in s)i+=`.${e}.${t}.${null!=s[t]}`;else i+=`.${e}.${null!=t[e]}`}if(null!=s)for(const e in s)s[e]&&(i+=`-${e}`);const r=c(i);if(this._instanceByIdNext){const i=new ye(we(r),e,e.meshWriter.name,t,s);return this._instanceByIdNext.set(r,i),i}if(!this._instanceById.has(r)){const i=new ye(we(r),e,e.meshWriter.name,t,s);this._instanceById.set(r,i)}return this._instanceById.get(r)}getInstance(e){return this._instanceById.get(e)}}class tt{constructor(e,t,s){this.getStage=e,this.version=t,this._tileInfoView=s,this._tiles=new Map,this._pendingUpdates=[],this._locked=!1}destroy(){}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1;for(const e of this._pendingUpdates)this.updateTile(e);this._pendingUpdates=[]}updateTile(e){if(this._locked)return void this._pendingUpdates.push(e);if(n("esri-2d-update-debug")){const t=e.debugInfo?.chunkId??"<EnsureEnd>";console.debug(`Version[${e.version}] Tile[${e.id}] Chunk[${t}] RenderState.updateTile [${e.type}]`,e)}const t=this._ensureTile(e.id);if("update"===e.type){const[s,...i]=e.modify;t.onMessage({type:"update",modify:s,remove:e.remove,end:e.end,attributeEpoch:e.attributeEpoch});for(const t of i){const s=this._tiles.get(t.tileId);s&&s.onMessage({type:"update",modify:t,remove:e.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null})}return}if(null==e.append)return void t.onMessage({type:"append",clear:e.clear,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});const[s,...i]=e.append;t.onMessage({type:"append",clear:e.clear,append:s,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});for(const e of i){const t=this._tiles.get(e.tileId);t&&t.onMessage({type:"update",modify:e,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null})}}removeTile(e){const t=this._tiles.get(e);n("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t?.destroy(),this._tiles.delete(e)}isTileDone(e){const t=this._tiles.get(e.id);return!!t&&t.isReady}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){n("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const t=new h(e),s=this._tileInfoView.getTileBounds(d(),t),i=this._tileInfoView.getTileResolution(t.level),r=new Ie(t,i,s[0],s[3],!0);if(r.stage=this.getStage(),!r.stage){const e=new f("featurelayerview:webgl","Cannot create tile with empty stage");p.getLogger("esri.views.2d.layers.features.RenderState").error(e)}return r}_copyPixelBufferedEntitiesInto(e){let t=7;for(let s=-1;s<=1;s++)for(let i=-1;i<=1;i++){if(0===s&&0===i)continue;const r=this._tileInfoView.tileInfo.isWrappable,n=Fe(e.key,i,s,r).id,a=this._tiles.get(n);if(null!=a){const r=1<<t;e.copyPixelBufferedEntitesFrom(a,r,i,s)}t--}}}class st{constructor(e,t){this.id=e,this.version=t,this._resolver=b(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}}class it extends me{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new y,this._hitTestsRequests=[],this._store=new et,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e}renderChildren(e){if(this.attributeView.update(),this._renderState){const e=Array.from(this._renderState.tiles()).filter((e=>e.needsUpload));if(e.length){e[Math.floor(Math.random()*e.length)].upload(),e.length>=2&&this.requestRender()}for(const e of this._renderState.tiles())e.tryReady(this.attributeView.currentEpoch)&&(this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const t of this.children)t.setTransform(e.state);if(this.hasAnimation){e.painter.effects.integrate.draw(e,e.attributeView)}switch(super.renderChildren(e),e.drawPhase){case be.MAP:return this._renderMapPhase(e);case be.HIGHLIGHT:return this._renderHighlightPhase(e);case be.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getExclusivePostprocessingInstance({drawPhase:e}){if(null==this._instanceStore)return null;let t=0,s=null;for(const i of this._instanceStore.values())i.techniqueRef.drawPhase&e&&(t++,i.techniqueRef.postProcessingEnabled&&(s=i));return t>1?null:s}_getOverrideStencilRef({drawPhase:e}){if(null==this._instanceStore)return null;let t=null;for(const s of this._instanceStore.values()){if(!(s.techniqueRef.drawPhase&e))continue;const{overrideStencilRef:i}=s.techniqueRef;if(null==t)t=i;else if(t!==i){t=null;break}}return t}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter((e=>this._visibleTiles.has(e.key.id))):[]}async updateAttributeView(e){this.requestRender(),await this.updatingHandles.addPromise(this.attributeView.requestUpdate(e)),this.hasLabels&&this._layerView.view.labelManager.requestUpdate()}updateSubscriptions(e){for(const{tileId:t,version:s}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=s;else{const e=new st(t,s);this._subscriptions.set(t,e),this.updatingHandles.addPromise(e.promise)}for(const t of e.unsubscribe){const e=this._subscriptions.get(t);e?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){n("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new tt((()=>this._stage),e,this._tileInfoView)}getDisplayStatistics(e,t){const s=this._statisticsByLevel.get(e);return s?s.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let s=this._statisticsByLevel.get(e);s||(s=new Map,this._statisticsByLevel.set(e,s));for(const e of t)s.set(e.fieldName,{minValue:e.minValue,maxValue:e.maxValue})}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender()}swapRenderState(){if(this._renderStateNext&&(n("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState)for(const e of this._renderState.tiles())e.upload();this.requestRender()}setVisibleTiles(e){this._visibleTiles=e}async onMessage(e,t){if(m(t),!this._subscriptions.has(e.id))return;const s=this._subscriptions.get(e.id);if(s.version!==e.subscriptionVesrion){if(n("esri-2d-update-debug")){const t=`${e.subscriptionVesrion} != ${s.version}`;console.debug(`Version[${t}] Tile[${e.id}] FeatureContainer - Dropping message, outdated version]`,e)}return}const i=this._renderStateNext??this._renderState;if(!i)throw new Error("InternalError: No renderState defined");if(i.version!==e.version&&console.error(`InternalError: Version mismatch. [renderState: ${i.version}, message: ${e.version}]`),i.updateTile(e),e.end){this._subscriptions.get(e.id).end()}this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find((({x:t,y:s})=>t===e.x&&s===e.y));const s=b();return t?t.resolvers.push(s):(t={x:e.x,y:e.y,resolvers:[s]},this._hitTestsRequests.push(t)),this.requestRender(),s.promise}getSortKeys(e){const t=new Set(e),s=new Map;for(const e of this.children)if(e.getSortKeys(t).forEach(((e,t)=>s.set(t,e))),s.size===t.size)break;return s}get hasAnimation(){return this.hasLabels}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._layerView.featureEffectView.transitionStep(e,t),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(e){const{minScale:t,maxScale:s}=this._layer.effectiveScaleRange,i=e.state.scale;i<=(t||1/0)&&i>=s&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){const t=this._getOverrideStencilRef(e);if(null==t)super.setStencilReference(e);else for(const e of this.children)e.stencilRef=t(e)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,ge.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&ve(e,!1,(e=>{this._renderFeatures(e,ge.Highlight)}))}_renderLabelPhase(e){this._renderFeatures(e,ge.All)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,ge.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,ge.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,s=e.painter.effects.hittest,i=t.getBoundFramebufferObject(),r=t.getViewport(),n=e.passOptions;s.bind(e),e.passOptions=s.createOptions(e,this._hitTestsRequests),this._renderFeatures(e,ge.All),s.draw(e),s.unbind(),t.bindFramebuffer(i),t.restoreViewport(r),e.passOptions=n}_renderFeatures(e,t){for(const s of this.children){if(!s.visible)continue;const i=n("featurelayer-force-marker-text-draw-order")?Se.STRICT_MARKERS_AND_TEXT:Se.BATCHING,r=s.getDisplayList(e.drawPhase,this._instanceStore,i);e.selection=t,r?.render(e)}const s=this._getExclusivePostprocessingInstance(e);null!=s&&s.techniqueRef.postProcess(e,s)}}async function rt(e){const t=await g("FeaturePipelineWorker",{client:e,strategy:"dedicated"});return new nt(t)}class nt{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}}const at="esri.views.2d.layers.features.FeatureSourceEventLog";let ot=class extends r{constructor(){super(...arguments),this.events=new v,this._updatingStrategy=!0,this._tileToEvent=new S,this._fetchStatus={outstanding:0,done:0}}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(e){switch(e.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(e);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=e.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",e);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),e.done&&(this._fetchStatus={done:0,outstanding:0})}}_hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const e of this._tileToEvent.values()){if("loaded"!==e[e.length-1].type)return!1}return!0}_handleTileEvent(e){switch(e.type){case"subscribe":this._tileToEvent.set(e.tile,[e]);break;case"unsubscribe":this._tileToEvent.delete(e.tile);break;case"loaded":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.push(e),this._tileToEvent.set(e.tile,t);break}case"error":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.push(e),this._tileToEvent.set(e.tile,t),this.events.emit("error",e);break}}}};e([t({readOnly:!0})],ot.prototype,"hasAllFeatures",null),e([t({readOnly:!0})],ot.prototype,"hasAllFeaturesInView",null),e([t({readOnly:!0})],ot.prototype,"hasFullGeometries",null),e([t()],ot.prototype,"_updatingStrategy",void 0),e([t()],ot.prototype,"_strategyInfo",void 0),e([t()],ot.prototype,"_tileToEvent",void 0),ot=e([s(at)],ot);function lt(e){switch(e.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":case"multipatch":return"esriGeometryPolygon";case"multipoint":return"esriGeometryMultipoint";default:return null}}const ut=Math.PI;function ct(e,t){switch(t.transformationType){case w.Additive:return dt(e,t);case w.Constant:return ft(t,e);case w.ClampedLinear:return pt(e,t);case w.Proportional:return yt(e,t);case w.Stops:return mt(e,t);case w.RealWorldSize:return bt(e,t);case w.Identity:return e;case w.Unknown:return null}}function ht(e,t){return"number"==typeof e?e:ct(t,e)}function dt(e,t){return e+(ht(t.minSize,e)||t.minDataValue)}function ft(e,t){const s=e.stops;let i=s?.length&&s[0].size;return null==i&&(i=e.minSize),ht(i,t)}function pt(e,t){const s=t.minDataValue,i=t.maxDataValue,r=(e-s)/(i-s),n=ht(t.minSize,e),a=ht(t.maxSize,e);return e<=s?n:e>=i?a:n+r*(a-n)}function yt(e,t){const s=e/t.minDataValue,i=ht(t.minSize,e),r=ht(t.maxSize,e);let n=null;return n=s*i,I(n,i,r)}function mt(e,t){const[s,i,r]=gt(e,t.cache.ipData);if(s===i)return ht(t.stops[s].size,e);{const n=ht(t.stops[s].size,e);return n+(ht(t.stops[i].size,e)-n)*r}}function bt(e,t){const s=F[t.valueUnit],i=ht(t.minSize,e),r=ht(t.maxSize,e),{valueRepresentation:n}=t;let a=null;return a="area"===n?2*Math.sqrt(e/ut)/s:"radius"===n||"distance"===n?2*e/s:e/s,I(a,i,r)}function gt(e,t){if(!t)return;let s=0,i=t.length-1;return t.some(((t,r)=>e<t?(i=r,!0):(s=r,!1))),[s,i,(e-t[s])/(t[i]-t[s])]}function vt(e){return(e.labelsVisible&&e.labelingInfo?.every((e=>"none"!==e.deconflictionStrategy)))??!1}function St(e,t){const s=x(e,t);if(s?.labelsVisible&&s.labelingInfo?.length)return s.labelingInfo.every((e=>"none"!==e.deconflictionStrategy))}function wt(e){return t=>V(ct(t,e))}function It(e){const t=null!=e&&"visualVariables"in e&&e.visualVariables;if(!t)return null;for(const e of t)if("size"===e.type)return wt(e);return null}function Ft(e,t,s,i,r){const n=null!=t.subtypeCode?`${t.subtypeField} = ${t.subtypeCode}`:null,a=E(t.definitionExpression,n),o=t.customParameters??{};return r&&(o.token=r),{type:"feature",mutable:{sourceRefreshVersion:i,availableFields:s.availableFields,dataFilter:{definitionExpression:a,gdbVersion:t.gdbVersion,historicMoment:t.historicMoment?.getTime(),outSpatialReference:s.outSpatialReference.toJSON(),timeExtent:t.timeExtent?.toJSON(),customParameters:o}},service:e,tileInfoJSON:s.tileInfoJSON}}function Vt(e,t,s=0){if(null==t)return e[s]=0,e[s+1]=0,e[s+2]=0,void(e[s+3]=0);const{r:i,g:r,b:n,a}=t;e[s]=i*a/255,e[s+1]=r*a/255,e[s+2]=n*a/255,e[s+3]=a}async function xt(e,t){if(!e)return[];switch(e.type){case"simple-fill":return $t(e,t);case"picture-fill":return Bt(e,t);case"simple-marker":return Pt(e,t);case"picture-marker":return Tt(e,t);case"simple-line":return Lt(e,t,!1);case"text":return Mt(e,t);case"label":return _t(e,t);case"cim":return Me(e.data,t);case"web-style":{const s=await e.fetchCIMSymbol();return Me(s.data,t)}default:throw new Error(`symbol not supported ${e.type}`)}}async function Et(e,t){const{schemaOptions:s}=t,{store:i}=s,r=new Array(Te),n=new Array(Te/4);for(let t=0;t<Te;t++){const s=t<e.attributes.length?e.attributes[t].color:null;r[t]=[0,0,0,0],Vt(r[t],s)}for(let t=0;t<Te/4;t++)n[t]=[0,0,0,0],n[t][0]=4*t<e.attributes.length?1:0,n[t][1]=4*t+1<e.attributes.length?1:0,n[t][2]=4*t+2<e.attributes.length?1:0,n[t][3]=4*t+3<e.attributes.length?1:0;const a={isActive:n,colors:r,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},o=i.ensureInstance(Ce.dotDensity,a,{}).createMeshInfo({params:{effects:null}}),l=[];if(e.backgroundColor){const s=new R({color:e.backgroundColor,outline:null}),i=await xt(s,t);l.push(...i)}if(l.push(o),e.outline){const s=Lt(e.outline,t,!0);l.push(...s)}return l}async function Rt(e,t){const{store:s}=t,{radius:i,minDensity:r,maxDensity:n,referenceScale:a,field:o,valueExpression:l,colorStops:u}=e,c=O(u);return[s.ensureInstance(Ce.heatmap,{radius:V(i),minDensity:r,maxDensity:n,referenceScale:a,isFieldActive:!(!o&&!l),gradient:c,gradientHash:c.join(",")},{}).createMeshInfo({params:{effects:null}})]}function Ot(e,t){const{store:s}=t,i=e.outline?.width||0,r=je(e),n=s.ensureInstance(Ce.pieChart,{geometry:{outlineWidth:Math.round(V(i)),defaultColor:$e(e.defaultColor),outlineColor:$e(e.outline?.color),othersColor:$e(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map((e=>$e(e.color))),visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:e.attributes.length},{}).createMeshInfo({params:{size:e.size,outlineWidth:i,effects:null,scaleInfo:null,minPixelBuffer:_e(r)}});return[...e.backgroundFillSymbol?$t(e.backgroundFillSymbol,{schemaOptions:t,path:"",uniforms:Be}):[],n]}function zt(e){if("path"===e.style){if(null==e.path)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const t=Ve.fromSimpleMarker(e);if("outline"in e&&e.outline&&"none"!==e.outline.style){if("solid"!==e.outline.style){if(!t||!t.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:t.symbolLayers[0],overrides:[]}}}return{type:"sprite-rasterization-param",resource:Pe(t),overrides:[]}}async function Pt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i;if("path"===e.style||e.outline&&"solid"!==e.outline.style&&"none"!==e.outline.style){const i=Ve.fromSimpleMarker(e);if(!i||!i.symbolLayers)throw new Error("Error handling marker! ");if(s.visualVariableRotation&&(i.angleAlignment="Map"),"path"!==e.style){const e=i.symbolLayers[0];if(qe(t.uniforms)){const s=_e(t.uniforms,0,1);if(s>e.size){const t=s/e.size;e.size=s;const i=e.markerGraphics?.[0].symbol;(i.symbolLayers&&i.symbolLayers[0]).width*=t}}}return Me({type:"CIMSymbolReference",symbol:i},t)}const n=r.ensureInstance(Ce.marker,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation}},{zoomRange:!1}),a=zt(e);let o=e.color?.toArray()??[0,0,0,0];"CIMVectorMarker"===a.resource.type&&(o=[255,255,255,255]);const l="triangle"===e.style?124/116:1,u=e.size,c=u*l,h=null!=s.visualVariableColor&&("cross"===e.style||"x"===e.style);return[n.createMeshInfo({params:{type:"simple",color:o,height:u,width:c,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ae(s)?Oe.MAP:Oe.SCREEN,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:u,sprite:a,overrideOutlineColor:h,hasSizeVV:qe(s),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:_e(s)}})]}function Tt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i,n=r.ensureInstance(Ce.marker,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation}},{zoomRange:!1}),a=Ve.createPictureMarkerRasterizationParam(e);if(!a)return[];return[n.createMeshInfo({params:{type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ae(s)?Oe.MAP:Oe.SCREEN,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:a,overrideOutlineColor:!1,hasSizeVV:qe(s),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:_e(s)}})]}function Ct(e,t,s){const{uniforms:i,schemaOptions:r}=s,{store:n}=r,a=n.ensureInstance(Ce.marker,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation}},{zoomRange:!1}),o=zt(e),l=6,u=l*t.width,c=u,h=e.color?.toArray()??t.color?.toArray()??[0,0,0,0],d="cross"===e.style||"x"===e.style;let f;switch(e.placement){case"begin-end":f=ze.Both;break;case"begin":f=ze.JustBegin;break;case"end":f=ze.JustEnd;break;default:f=ze.None}const p={type:"cim-marker-placement-info",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:f,offsetAlongLine:0},overrides:[]};return[a.createMeshInfo({params:{type:"simple",color:h,height:c,width:u,offsetX:0,offsetY:0,angle:0,alignment:Ae(i)?Oe.MAP:Oe.SCREEN,outlineColor:h,outlineSize:d?t.width:0,referenceSize:c/l,sprite:o,overrideOutlineColor:d&&null!=i.visualVariableColor,hasSizeVV:qe(i),placement:p,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:_e(i)}})]}function Mt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i;return[r.ensureInstance(Ce.text,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue}},{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}).createMeshInfo({params:{boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloFontSize:e.haloSize??0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:Ve.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:_e(s),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function _t(e,t){const{schemaOptions:s,uniforms:i}=t,{store:r}=s,n=e.symbol,{allowOverrun:a,repeatLabel:o,repeatLabelDistance:l}=e,u={maxScale:e.maxScale??0,minScale:e.minScale??0},c=r.ensureInstance(Ce.label,{geometry:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}),h=e.labelPlacement,[d,f]=xe(h);return[c.createMeshInfo({params:{boxBackgroundColor:n.backgroundColor?.toArray(),boxBorderLineColor:n.borderLineColor?.toArray(),boxBorderLineSize:n.borderLineSize??0,color:n.color?.toArray()??[0,0,0,0],offsetX:n.xoffset,offsetY:n.yoffset,postAngle:n.angle,fontSize:n.font.size,decoration:n.font.decoration,haloColor:n.haloColor?.toArray()??[0,0,0,0],haloFontSize:n.haloSize??0,lineWidth:n.lineWidth,lineHeightRatio:n.lineHeight,horizontalAlignment:d,verticalAlignment:f,repeatLabel:o,repeatLabelDistance:V(l),allowOverrun:a,labelPosition:e.labelPosition,scaleInfo:u,minPixelBuffer:_e(i),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:n.font.toJSON(),textString:n.text,symbol:Ve.createCIMTextSymbolfromTextSymbol(n),primitiveName:"label-override"},useLegacyLabelEvaluationRules:null==e.labelExpressionInfo?.expression,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,isLineLabel:!1}})]}function At(e,t){const s=e.width;return{outlineColor:e.color?.toArray()||[0,0,0,1],width:s,referenceWidth:s,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:t}}function qt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i,n=e.color?.toArray()??[0,0,0,0],a={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if("solid"===e.outline?.style){return[r.ensureInstance(Ce.patternOutlineFill,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{color:n,...At(e.outline,!!s.visualVariableSizeOutlineScaleStops),sprite:a,scaleInfo:null,effects:null}})]}const o=[],l=r.ensureInstance(Ce.patternFill,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity}},{zoomRange:!1}).createMeshInfo({params:{color:e.color?.toArray()??[0,0,0,0],sprite:a,scaleInfo:null,effects:null}});return o.push(l),e.outline&&o.push(...Lt(e.outline,t,!0)),o}function jt(e,t){const{uniforms:s,schemaOptions:i}=t,{store:r}=i,n=e.color?.toArray()??[0,0,0,0];if("none"!==e.style&&"solid"===e.outline?.style){return[r.ensureInstance(Ce.outlineFill,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{color:n,...At(e.outline,!!s.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null}})]}const a=[];if("none"!==e.style){const e=r.ensureInstance(Ce.fill,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity}},{zoomRange:!1}).createMeshInfo({params:{color:n,scaleInfo:null,effects:null}});a.push(e)}return e.outline&&a.push(...Lt(e.outline,t,!0)),a}function $t(e,t){const{style:s}=e;return s&&"none"!==s&&"solid"!==s?qt(e,t):jt(e,t)}function Bt(e,t){const{outline:s}=e,{uniforms:i,schemaOptions:r}=t,{store:n}=r,a=[],o=Ve.createPictureFillRasterizationParam(e);if(!o)return[];const{width:l,height:u,xoffset:c,yoffset:h,xscale:d,yscale:f}=e,p={color:[255,255,255,255],sprite:o,height:u,aspectRatio:l/u,offsetX:c,offsetY:h,scaleX:d,scaleY:f,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if("solid"===s?.style){return[n.ensureInstance(Ce.complexOutlineFill,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{...p,...At(s,!!i.visualVariableSizeOutlineScaleStops)}})]}const y=n.ensureInstance(Ce.complexFill,{geometry:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!1});return a.push(y.createMeshInfo({params:p})),s&&a.push(...Lt(s,t,!0)),a}function Lt(e,t,s){const{color:i,style:r,width:n,cap:a,join:o}=e,{schemaOptions:l}=t,{store:u}=l,c=[],h=s?{...Be,visualVariableSizeScaleStops:t.uniforms.visualVariableSizeOutlineScaleStops}:t.uniforms,d={geometry:{visualVariableColor:h.visualVariableColor,visualVariableOpacity:h.visualVariableOpacity,visualVariableSizeMinMaxValue:h.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:h.visualVariableSizeScaleStops,visualVariableSizeStops:h.visualVariableSizeStops,visualVariableSizeUnitValue:h.visualVariableSizeUnitValue}},f={color:i?.toArray()??[0,0,0,0],width:n,referenceWidth:n,capType:a,joinType:o,miterLimit:e.miterLimit,hasSizeVV:qe(h),effects:null,scaleInfo:null};if(null==r||"solid"===r){const e=u.ensureInstance(Ce.line,d,{zoomRange:!1}).createMeshInfo({params:f});c.push(e)}else if("none"!==r){const e=u.ensureInstance(Ce.texturedLine,d,{zoomRange:!1}).createMeshInfo({params:{...f,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:Ee(r,a),capStyle:Re(a)},overrides:[]}}});c.push(e)}return null!=e.marker&&c.push(...Ct(e.marker,e,t)),c}async function kt(e,t,s){const i=t.labelsVisible&&t.labelingInfo||[],r=lt(t),n=z(i,r);return{type:"label",classes:await Promise.all(n.map(((t,i)=>Dt(e,t,i,s))))}}async function Dt(e,t,s,i){const r=await xt(t,{path:`${s}`,schemaOptions:e,uniforms:i});return{maxScale:t.maxScale,minScale:t.minScale,expression:t.labelExpressionInfo?.expression??t.labelExpression,where:t.where,meshes:r}}async function Ut(e,t){if(!t)return{type:"simple",meshes:[]};switch(t.type){case"simple":return Nt(e,t);case"dot-density":return Ht(e,t);case"class-breaks":return Jt(e,t);case"unique-value":return Kt(e,t);case"dictionary":return Gt(t);case"heatmap":return Zt(e,t);case"pie-chart":return Wt(e,t)}}async function Nt(e,t){const s=t.getSymbols(),i=s.length?s[0]:null,r=je(t),n="renderer.symbol";return{type:"simple",meshes:await xt(i,{schemaOptions:e,uniforms:r,path:n})}}async function Ht(e,t){const s=je(t),i="renderer.symbol";return{type:"dot-density",meshes:await Et(t,{schemaOptions:e,uniforms:s,path:i})}}async function Jt(e,t){const s=je(t),i=t.backgroundFillSymbol,r=t.normalizationType,n="log"===r?"esriNormalizeByLog":"percent-of-total"===r?"esriNormalizeByPercentOfTotal":"field"===r?"esriNormalizeByField":null,a=t.classBreakInfos.map((async t=>({meshes:await xt(t.symbol,{path:`renderer-stop-${t.minValue}-${t.maxValue}`,schemaOptions:e,uniforms:s}),min:t.minValue,max:t.maxValue}))),o=(await Promise.all(a)).sort(((e,t)=>e.min-t.min)),l=await xt(i,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{...Be,visualVariableSizeOutlineScaleStops:s.visualVariableSizeOutlineScaleStops}}),u=await xt(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:s});return{type:"interval",field:t.field,expression:t.valueExpression,backgroundFill:l,defaultSymbol:u,intervals:o,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,normalizationType:n,isMaxInclusive:t.isMaxInclusive}}async function Kt(e,t){const s=[],i=je(t),r=await xt(t.backgroundFillSymbol,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{...Be,visualVariableSizeOutlineScaleStops:i.visualVariableSizeOutlineScaleStops}}),n=await xt(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:i});for(const r of t.uniqueValueInfos??[]){const t=await xt(r.symbol,{path:`renderer-unique-value-${r.value}`,schemaOptions:e,uniforms:i});s.push({value:""+r.value,symbol:t})}return{type:"map",field:t.field,expression:t.valueExpression,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,backgroundFill:r,defaultSymbol:n,map:s}}function Gt(e){const t=je(e),s=e.scaleExpression,i=null!=s&&"1"!==s?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0;return{type:"dictionary",fieldMap:e.fieldMap,scaleExpression:i,visualVariableUniforms:t}}async function Zt(e,t){return{type:"heatmap",meshes:await Rt(t,e)}}async function Wt(e,t){return{type:"pie-chart",meshes:Ot(t,e)}}async function Xt(e,t){const s=t.renderer,i=je(s);return{symbology:await Ut(e,s),labels:await kt(e,t,i)}}async function Yt(e,t,s,i){const r=s.featureReduction;if(r)switch(r.type){case"binning":return ts(r,e,t,s,i);case"cluster":return ss(r,e,t,s,i)}const n=is(s.orderBy,s.renderer,s.objectIdField);return{storage:Le(s.renderer,t.filters),mesh:{displayRefreshVersion:i,strategy:{type:"feature"},factory:await Xt(e,s),sortKey:n,timeZone:t.timeZone}}}function Qt(e,t){return e.fields.map((e=>({...e.toJSON(),type:es(e,t)})))}function es(e,t){const{onStatisticExpression:s,onStatisticField:i,statisticType:r}=e;switch(r){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(s){const{returnType:e}=s;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=t.find((e=>e.name===i));return e?e.type:"esriFieldTypeString"}}}async function ts(e,t,s,i,r){const n=Qt(e,i.fields),a=e.renderer,o=await Ut(t,a),l=Le(a,[null,null]),u=je(a),c=await kt(t,{geometryType:"polygon",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},u);return{storage:l,mesh:{displayRefreshVersion:r,strategy:{type:"binning",fields:n,fixedBinLevel:e.fixedBinLevel,featureFilter:s.filters[0]},factory:{labels:c,symbology:o},sortKey:null,timeZone:s.timeZone}}}async function ss(e,t,s,i,r){const n=Qt(e,i.fields),a={type:"cluster",feature:await Ut(t,e.effectiveFeatureRenderer),cluster:await Ut(t,e.effectiveClusterRenderer)},o=je(e.effectiveFeatureRenderer),l={type:"cluster",feature:await kt(t,i,o),cluster:await kt(t,{geometryType:"point",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},o)};return{storage:Le(e.effectiveFeatureRenderer,[null,null]),mesh:{displayRefreshVersion:r,strategy:{type:"cluster",fields:n,featureFilter:s.filters[0],clusterRadius:V(e.clusterRadius/2)},factory:{labels:l,symbology:a},sortKey:null,timeZone:s.timeZone}}}function is(e,t,s){const i=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||i||(e=[new P({field:s,order:"descending"})]),"default"!==e&&e.length){const t=e[0],s="ascending"===t.order?"asc":"desc";return t.field?{field:t.field,order:s}:t.valueExpression?{expression:t.valueExpression,order:s}:null}if(i){return{byRenderer:!0,order:"asc"}}return null}class rs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,s=t.parent,i=M(s),{capabilities:r,editingInfo:n,objectIdField:a,globalIdField:o,datesInUnknownTimezone:l,orderBy:u,subtypeField:c,parsedUrl:h}=s,d=s.fieldsIndex.toJSON(),f=lt(t),p=s.timeInfo?.toJSON(),y=t.spatialReference.toJSON(),m=T(h);let b=a;if(u?.length){const e=!u[0].valueExpression&&u[0].field;e&&(b=e)}return{type:"feature-service",source:m,isSourceHosted:C(m.path),orderByFields:b,metadata:{timeReferenceUnknownClient:l,subtypeField:c,globalIdField:o,fieldsIndex:d,geometryType:f,objectIdField:a,timeInfo:p,spatialReference:y,subtypes:null,typeIdField:null,types:null},queryMetadata:{capabilities:r,effectiveCapabilities:i,lastEditDate:n?.lastEditDate?.getTime(),snapshotInfo:null}}}createSourceSchema(e,t,s){const{definitionExpression:i,customParameters:r,timeExtent:n,apiKey:a}=this.layer.parent;return Ft(e,{definitionExpression:i,customParameters:r,timeExtent:n},t,s,a)}createProcessorSchema(e,t,s){const{parent:{fields:i,geometryType:r,orderBy:n,objectIdField:a},renderer:o,labelingInfo:l,labelsVisible:u}=this.layer,c={featureReduction:null,fields:i.map((e=>e.toJSON())),geometryType:r,labelingInfo:l,labelsVisible:u,objectIdField:a,orderBy:n??"default",renderer:o?.clone()};return Yt(e,t,c,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{parent:s,parent:{definitionExpression:i,apiKey:r},renderer:n}=t,a=this.layer.labelsVisible?this.layer.labelingInfo:null;return{apiKey:r,customParameters:JSON.stringify(s.customParameters),definitionExpression:i,labelingInfo:a,orderBy:JSON.stringify(s.orderBy),renderer:n}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}}function ns(e,t){const s=e.extent,i=t?.clone().intersection(s),r=null!=i?i.width*i.height:0,a=t?t.width*t.height:0,o=0===a?0:r/a,l=n("featurelayer-snapshot-point-coverage");return!isNaN(o)&&o>=l}function as(e,t){return null!=e.floorInfo&&(e.floorInfo.viewAllLevelIds.length>0||t.floors.length>0)}function os(e,t,s){const i=ls(e,t?.where,s);return i?(t??=new _,t.where=i,t):t}function ls(e,t,s){if(null==e.floorInfo||!s.floors?.length)return t;let i=s.floors;const{floorField:r,viewAllLevelIds:n}=e.floorInfo;n.length&&(i=n);const a=i.filter((e=>""!==e)).map((e=>"'"+e+"'"));if(a.push("''"),t?.includes(r)){let e=new RegExp("AND \\("+r+".*NULL\\)","g");t=t.replace(e,""),e=new RegExp("\\("+r+".*NULL\\)","g"),t=(t=t.replace(e,"")).replaceAll(/\s+/g," ").trim()}let o="("+r+" IN ({ids}) OR "+r+" IS NULL)";return o=o.replace("{ids}",a.join(", ")),E(t,o)}class us{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=St(t,e)??vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,s=M(t),{capabilities:i,editingInfo:r,objectIdField:a,typeIdField:o,globalIdField:l,datesInUnknownTimezone:u,orderBy:c,subtypeField:h,refreshInterval:d}=t,f=t.fieldsIndex.toJSON(),p=f.fields,y=lt(t),m=t.timeInfo?.toJSON(),b=t.spatialReference.toJSON(),g=t.types?.map((e=>e.toJSON())),v=T(this.layer.parsedUrl);this.layer.dynamicDataSource&&(v.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let S=this.layer.objectIdField;if(c?.length){const e=!c[0].valueExpression&&c[0].field;e&&(S=e)}const w=!(null!=r?.lastEditDate)&&d>0,I=n("featurelayer-snapshot-enabled")&&"point"===t.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!w,F=I&&ns(e,t.fullExtent);return{type:"feature-service",source:v,isSourceHosted:C(v.path),orderByFields:S,metadata:{typeIdField:o??void 0,types:g,timeReferenceUnknownClient:u,subtypeField:h,globalIdField:l,fields:p,fieldsIndex:f,geometryType:y,objectIdField:a,timeInfo:m,spatialReference:b,subtypes:this.layer.subtypes?.map((e=>e.toJSON()))},queryMetadata:{capabilities:i,effectiveCapabilities:s,lastEditDate:r?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:I,supportsSnapshotMaxThreshold:F,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t,s){const{definitionExpression:i,customParameters:r,gdbVersion:n,historicMoment:a,subtypeCode:o,subtypeField:l,timeExtent:u,apiKey:c}=this.layer;return Ft(e,{definitionExpression:i,customParameters:r,gdbVersion:n,historicMoment:a,subtypeCode:o,subtypeField:l,timeExtent:u},t,s,c)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:x(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return Yt(e,t,c,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}hasFilters(e){return as(this.layer,e)}addFilters(e,t){return os(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i,gdbVersion:r,apiKey:n,subtypeCode:a}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=t.historicMoment?.getTime()??void 0,u=JSON.stringify(t.customParameters),c=x(t,e)?.toJSON(),h=JSON.stringify(t.orderBy);return{apiKey:n,customParameters:u,definitionExpression:s,featureReduction:c,floors:as(this.layer,e)?e.floors:null,gdbVersion:r,historicMoment:l,labelingInfo:o,orderBy:h,renderer:i,subtypeCode:a}}}function cs(e){if(!("openPorts"in e))throw new f("source-not-supported")}class hs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=St(t,e)??vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,s=M(t),{capabilities:i,objectIdField:r}=t,n=t.fieldsIndex.toJSON(),a=lt(t),o=t.timeInfo?.toJSON(),l=t.spatialReference.toJSON();cs(t.source);return{type:"memory",source:await t.source.openPorts(),orderByFields:r,metadata:{fieldsIndex:n,geometryType:a,objectIdField:r,timeInfo:o,spatialReference:l,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{capabilities:i,effectiveCapabilities:s,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t,s){const{definitionExpression:i,timeExtent:r}=this.layer;return Ft(e,{definitionExpression:i,timeExtent:r,customParameters:null},t,s,null)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:x(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return Yt(e,t,c,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=x(t,e)?.toJSON();return{orderBy:JSON.stringify(t.orderBy),definitionExpression:s,renderer:i,labelingInfo:r,featureReduction:n}}}class ds{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=St(t,e)??vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,s=M(t),{capabilities:i,objectIdField:r}=t,n=t.fieldsIndex.toJSON(),a=lt(t),o=t.spatialReference.toJSON();return{type:"memory",source:await t.source.openPorts(),orderByFields:r,metadata:{fieldsIndex:n,geometryType:a,objectIdField:r,spatialReference:o,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{capabilities:i,effectiveCapabilities:s,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t,s){const{definitionExpression:i}=this.layer;return Ft(e,{definitionExpression:i,customParameters:null},t,s,null)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l}=this.layer,u={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:x(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l,orderBy:"default"};return Yt(e,t,u,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=x(t,e)?.toJSON();return{definitionExpression:s,renderer:i,labelingInfo:r,featureReduction:n}}}class fs{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=St(t,e)??vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,s=M(t),{capabilities:i,objectIdField:r}=t,n=t.fieldsIndex.toJSON(),a=lt(t),o=t.timeInfo?.toJSON(),l=t.spatialReference.toJSON(),u=t.source.getSource(),c=this.layer.objectIdField,h=T(i);return h.query.maxRecordCount=u.maxRecordCount,{type:"ogc",source:u,orderByFields:c,metadata:{fieldsIndex:n,geometryType:a,objectIdField:r,timeInfo:o,spatialReference:l,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{capabilities:h,effectiveCapabilities:s,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t,s){const{customParameters:i,timeExtent:r,apiKey:n}=this.layer;return Ft(e,{customParameters:i,timeExtent:r},t,s,n)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:x(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return Yt(e,t,c,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{renderer:s,apiKey:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),a=x(t,e)?.toJSON();return{apiKey:i,customParameters:n,featureReduction:a,labelingInfo:r,orderBy:JSON.stringify(t.orderBy),renderer:s}}}class ps{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=St(t,e)??vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,s=M(t),{capabilities:i,objectIdField:r,globalIdField:a,orderBy:o,refreshInterval:l}=t,u=t.fieldsIndex.toJSON(),c=u.fields,h=lt(t),d=t.timeInfo?.toJSON(),f=t.spatialReference.toJSON(),p=T(this.layer.parsedUrl);let y=this.layer.objectIdField;if(o?.length){const e=!o[0].valueExpression&&o[0].field;e&&(y=e)}const m=l>0,b=n("featurelayer-snapshot-enabled")&&"point"===t.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!m,g=b&&ns(e,t.fullExtent);return{type:"feature-service",source:p,isSourceHosted:C(p.path),orderByFields:y,metadata:{globalIdField:a,fields:c,fieldsIndex:u,geometryType:h,objectIdField:r,timeInfo:d,spatialReference:f,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{capabilities:i,effectiveCapabilities:s,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:b,supportsSnapshotMaxThreshold:g,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t,s){const{definitionExpression:i,customParameters:r,timeExtent:n}=this.layer;return Ft(e,{definitionExpression:i,customParameters:r,timeExtent:n},t,s,null)}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,c={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:x(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return Yt(e,t,c,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}hasFilters(e){return as(this.layer,e)}addFilters(e,t){return os(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),a=x(t,e)?.toJSON();return{orderBy:JSON.stringify(t.orderBy),definitionExpression:s,renderer:i,labelingInfo:r,featureReduction:a,customParameters:n,floors:as(this.layer,e)?e.floors:null}}}class ys{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=St(t,e)??vt(t);return[{vvEvaluators:{0:It(t.renderer)},deconflictionEnabled:s}]}async createServiceOptions(e){const t=this.layer,{objectIdField:s}=t,i=lt(t),r=t.timeInfo?.toJSON()||null,n=t.spatialReference?t.spatialReference.toJSON():null;return{source:this.layer.parsedUrl,metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:i,objectIdField:s,timeInfo:r,timeReferenceUnknownClient:null,spatialReference:n,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}createSourceSchema(e,t,s){const{definitionExpression:i,geometryDefinition:r,customParameters:n}=this.layer;return{type:"stream",service:e,tileInfoJSON:t.tileInfoJSON,mutable:{sourceRefreshVersion:s,availableFields:t.availableFields,dataFilter:{geometryDefinition:r?.toJSON(),definitionExpression:i,outSpatialReference:t.outSpatialReference.toJSON(),customParameters:n??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(e,t,s){const{fields:i,renderer:r,geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l}=this.layer,u={fields:i.map((e=>e.toJSON())),renderer:r?.clone(),featureReduction:x(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:o,objectIdField:l,orderBy:"default"};return Yt(e,t,u,s)}get hasRequiredSupport(){return ke(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),a=x(t,e)?.toJSON();return{definitionExpression:s,renderer:i,labelingInfo:r,featureReduction:a,customParameters:n,streamFilter:`${JSON.stringify(t.geometryDefinition)}${t.definitionExpression}`}}}async function ms(e,{subtypeField:t,sublayers:s}){const i=await Promise.all(s.map((({renderer:t})=>Ut(e,t))));return{type:"subtype",subtypeField:t,renderers:s.reduce(((e,{subtypeCode:t},s)=>({...e,[t]:i[s]})),{})}}function bs(e,t){const s=A();return{type:"subtype",filters:e.filters,capabilities:{maxTextureSize:s.maxTextureSize},subtypeField:t.subtypeField,target:"feature",bindings:t.sublayers.reduce(((e,{renderer:t,subtypeCode:s})=>({...e,[s]:De(t)})),{})}}async function gs(e,{subtypeField:t,sublayers:s}){const i=await Promise.all(s.map((t=>{const s=je(t.renderer),i={...t,geometryType:t.geometryType??null};return kt(e,i,s)})));return{type:"subtype",subtypeField:t,renderers:s.reduce(((e,{subtypeCode:t},s)=>({...e,[t]:i[s]})),{})}}async function vs(e,t,s,i){return{storage:bs(t,s),mesh:{displayRefreshVersion:i,strategy:{type:"feature"},factory:{symbology:await ms(e,s),labels:await gs(e,s)},sortKey:null,timeZone:t.timeZone}}}class Ss{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every((e=>vt(e)))}]}async createServiceOptions(e){const t=this.layer,s=M(t),{capabilities:i,datesInUnknownTimezone:r,editingInfo:a,globalIdField:o,objectIdField:l,refreshInterval:u,subtypeField:c}=t,h=t.fieldsIndex.toJSON(),d=lt(t),f=t.timeInfo?.toJSON(),p=t.spatialReference.toJSON(),y=T(this.layer.parsedUrl),m=l,b=!(null!=a?.lastEditDate)&&u>0,g=n("featurelayer-snapshot-enabled")&&"point"===t.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!b,v=g&&ns(e,t.fullExtent);return{type:"feature-service",source:y,isSourceHosted:C(y.path),orderByFields:m,metadata:{timeReferenceUnknownClient:r,subtypeField:c,globalIdField:o,fieldsIndex:h,geometryType:d,objectIdField:l,timeInfo:f,spatialReference:p,subtypes:this.layer.subtypes?.map((e=>e.toJSON())),typeIdField:null,types:null},queryMetadata:{capabilities:i,effectiveCapabilities:s,lastEditDate:a?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:g,supportsSnapshotMaxThreshold:v,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t,s){const{definitionExpression:i,customParameters:r,gdbVersion:n,historicMoment:a,subtypeField:o,timeExtent:l,apiKey:u}=this.layer,c=this.layer.sublayers.map((e=>e.subtypeCode)).join(","),h=this.layer.sublayers.length?`${this.layer.subtypeField} IN (${c})`:"1=2",d={definitionExpression:E(i,h),customParameters:r,gdbVersion:n,historicMoment:a,subtypeField:o,timeExtent:l};return Ft(e,d,t,s,u)}createProcessorSchema(e,t,s){const i={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(e=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null})))};return vs(e,t,i,s)}hasFilters(e){return as(this.layer,e)||ws(this.layer,e)}addFilters(e,t){e=os(this.layer,e,t);const s=this.layer.sublayers.filter((e=>!Is(e,t))).map((e=>e.subtypeCode));if(!s.length)return e;e??=new _;const i=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=E(e.where,i),e}get hasRequiredSupport(){return!0}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,gdbVersion:i,apiKey:r}=t,n=t.historicMoment?.getTime()??void 0,a=JSON.stringify(t.customParameters),o=as(this.layer,e)?e.floors:null;return{gdbVersion:i,definitionExpression:s,historicMoment:n,customParameters:a,apiKey:r,sublayerHash:"sublayers"in this.layer&&this.layer.sublayers.items.reduce(((e,t)=>e+`${t.visible?1:0}.${JSON.stringify(t.renderer)}.${t.labelsVisible}\n.${JSON.stringify(t.labelingInfo)}`),""),floors:o}}setGraphicOrigin(e){const t=this.layer.fieldsIndex.get(this.layer.subtypeField),s=e.attributes[t.name],i=this.layer.sublayers.find((e=>e.subtypeCode===s));e.layer=e.sourceLayer=i}}function ws(e,t){return e.sublayers.some((e=>!Is(e,t)))}function Is(e,t){return e.visible&&(0===e.minScale||q(t.scale,e.minScale)||t.scale<e.minScale)&&(0===e.maxScale||q(t.scale,e.maxScale)||t.scale>e.maxScale)}async function Fs(e,t){try{return await e}catch(e){if("no-queryEngine"!==e.name)throw e;return t}}function Vs(e,t){const s=new Set;for(const i of e instanceof Set?e.values():e.keys())t.has(i)||s.add(i);return s}class xs{constructor(e){this.version=e}}class Es{constructor(e){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=e}destroy(){}get _coverageSet(){const e=this._coverage?Array.from(this._coverage.keys()).map((e=>e.id)):[];return new Set(e)}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){null==this._coverage&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions())}update(e){return this._version=this._version+1%Number.MAX_SAFE_INTEGER,this._updateCoverage(e),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(e){this._coverage=this._config.tileInfoView.getTileCoverage(e.state,0,!0,"closest")}_updateSubscriptions(){const e=this._coverageSet,t=this._updateVisibility(),s=Vs(t,e),i=Vs(this._subscriptions,t),r=Vs(e,this._subscriptions),n=Vs(i,e),a=Vs(s,n),o=Vs(a,this._paused);this._visible=t;for(const e of r.values())this._subscriptions.set(e,new xs(this._version));for(const e of o.values())this._paused.add(e);for(const e of n.values())this._subscriptions.delete(e),this._paused.delete(e);(r.size||n.size||o.size)&&this._sendUpdateSubscriptions(r,n,o)}_sendUpdateSubscriptions(e,t,s){const i=Array.from(e.values()).map((e=>({tileId:e,version:this._subscriptions.get(e).version})));this._config.updateSubscriptions({subscribe:i,unsubscribe:Array.from(t.values()),pause:Array.from(s.values()),tileInfoJSON:this._config.tileInfoView.tileInfo.toJSON()})}_updateVisibility(){const e=new Set;if(!this._coverage)return e;for(const t of this._coverage.keys()){if(this._config.isDone(t)){e.add(t.id);continue}if(this._addVisibleParent(e,t))continue;this._addVisibleChildren(e,t)||e.add(t.id)}return e}_addVisibleParent(e,t){let s=!1;for(const i of this._visible.values()){new h(i).containsChild(t)&&(e.add(i),s=!0)}return s}_addVisibleChildren(e,t){let s=!1;for(const i of this._visible.values()){const r=new h(i);t.containsChild(r)&&(e.add(i),s=!0)}return s}}const Rs=i=>{let r=class extends i{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([B((()=>{const e=this.layer;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),L),k((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),k((()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null}),"change",(()=>this._handleRequiredFieldsChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:s}=this;return"outFields"in e&&e.outFields?D(t,[...U(t,e.outFields),...s]):D(t,s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){p.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new N(e);if("floorInfo"in this.layer&&this.layer.floorInfo){const e=H(this);null!=e&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new N(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){return this._validateFetchPopupFeatures(e,t),this._fetchPopupFeatures(e,t)}_loadArcadeModules(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?J():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:s,objectIdField:i}}=this,r="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,a="featureReduction"in t?t.featureReduction:null,o=new Set,l=await Promise.allSettled([r?r.collectRequiredFields(o,s):null,K(o,t),e&&"elevationInfo"in t?G(o,t):null,null!=this.filter?Z(o,t,this.filter):null,e||null==this.featureEffect?null:Z(o,t,this.featureEffect.filter),!e&&a?W(o,t,a):null,!e&&n?X(o,t,n):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&Y(o,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"floorInfo"in t&&t.floorInfo&&Y(o,t.fieldsIndex,[t.floorInfo.floorField]),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&p.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),Y(o,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){Q(o,s,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(o,s),K(o,e)])));await Promise.allSettled(e)}"catalog-footprint"===t.type&&Y(o,s,[t.parent.itemSourceField,t.parent.itemTypeField]);for(const e of l)"rejected"===e.status&&p.getLogger(this).error(e.reason);Q(o,s,i),e&&"displayField"in t&&t.displayField&&Q(o,s,t.displayField);const u=Array.from(o).sort();this._set("requiredFields",u)}_validateFetchPopupFeatures(e,t){if(null!=t)for(const s of e){const e=s.origin&&"layer"in s.origin?s.origin.layer:s.layer;if("popupEnabled"in e&&!e.popupEnabled)throw new f("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e});if(s.isAggregate){const t="featureReduction"in e?e.featureReduction:null;if(!(t&&"popupTemplate"in t&&t.popupEnabled&&t.popupTemplate))throw new f("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e})}else if("popupTemplate"in e){if(!He(e,t))throw new f("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:e})}}}_popupFeatureHasRequiredFields(e,t){return ee(t,e)}async _fetchPopupFeatures(e,t){const s=new Array(e.length),i=new Map,r=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);for(let n=0;n<e.length;n++){const a=e[n];if(a.isAggregate){s[n]=a;continue}const o=a.origin?.layer??a.layer;if(!o||!("popupEnabled"in o))continue;const l=U(this.layer.fieldsIndex,r.outFields),u=He(o,t);if(null==u)continue;const c=await this._loadArcadeModules(u);m(t);c&&c.arcadeUtils.hasGeometryOperations(u)||!this._popupFeatureHasRequiredFields(a,l)?i.set(a.getObjectId(),{graphic:a,index:n}):s[n]=a}if("stream"===this.layer.type||0===i.size)return s.filter(Boolean);r.objectIds=Array.from(i.keys());try{const e=await this.layer.queryFeatures(r,t);for(const t of e.features){const{graphic:{geometry:e,origin:r},index:n}=i.get(t.getObjectId());t.geometry||=e,t.origin=r,s[n]=t}}catch{}return s.filter(Boolean)}async _createPopupQuery(e,t){const s=this.layer.createQuery(),i=new Set;let r=!1;const n=e??[this.layer];for(const e of n){if(!("popupEnabled"in e))continue;const s=He(e,t);if(null==s)continue;const n=await this._loadArcadeModules(s);m(t);const a=n&&n.arcadeUtils.hasGeometryOperations(s);r=!("point"!==this.layer.geometryType&&!a);const o=await Je(this.layer,s);m(t);for(const e of o)i.add(e)}if(s.returnGeometry=r,s.returnZ=r,s.returnM=r,s.outFields=Array.from(i),s.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const e=H(this);null!=e&&(s.where=s.where?`(${s.where}) AND (${e})`:e)}return s}canResume(){return!!super.canResume()&&(null==this.timeExtent||!this.timeExtent.isEmpty)}getTest(){return{createPopupQuery:e=>this._createPopupQuery(void 0,e)}}get test(){return this.getTest()}};return e([t()],r.prototype,"_updatingRequiredFieldsPromise",void 0),e([t({readOnly:!0})],r.prototype,"availableFields",null),e([t({readOnly:!0})],r.prototype,"dataUpdating",void 0),e([t({type:j})],r.prototype,"featureEffect",null),e([t({type:_})],r.prototype,"filter",void 0),e([t($)],r.prototype,"timeExtent",void 0),e([t()],r.prototype,"layer",void 0),e([t({type:Number})],r.prototype,"maximumNumberOfFeatures",null),e([t({readOnly:!0,type:Boolean})],r.prototype,"maximumNumberOfFeaturesExceeded",null),e([t({readOnly:!0})],r.prototype,"requiredFields",void 0),e([t()],r.prototype,"suspended",void 0),e([t()],r.prototype,"view",void 0),r=e([s("esri.views.layers.FeatureLayerView")],r),r};function Os(e,t){const s=new Set;return e&&e.forEach((e=>s.add(e))),t&&t.forEach((e=>s.add(e))),s.has("*")?["*"]:Array.from(s)}const zs="esri.views.2d.layers.FeatureLayerView2D",Ps=4294967294;let Ts=class extends(Rs(Ke(fe(pe)))){constructor(){super(...arguments),this._commandsQueue=new Ue({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new Ne,this._updateHighlight=te((async()=>{const e=[];for(const t of this._highlightCounter.ids()){const s=this._highlightCounter.getHighestReason(t),i=de(s);e.push({objectId:t,highlightFlags:i})}this._worker.pipeline.updateHighlight({highlights:e})})),this._lastAvailableFields=[],this.eventLog=new ot,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new Xe}destroy(){this._worker?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransitions()}async _initProxy(){const e=this.layer;if("isTable"in e&&e.isTable)throw new f("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if("mesh"===e.geometryType)throw new f("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if(("feature"===e.type||"subtype-group"===e.type)&&!1===M(e)?.operations.supportsQuery)throw new f("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});this._worker&&this._worker.destroy();const t=this._createClientOptions();this._worker=await rt(t)}get hasAllFeatures(){return this.layer.visible&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,s=!this.suspended;return e.map((({vvEvaluators:e,deconflictionEnabled:i})=>({container:this.featureContainer,vvEvaluators:e,deconflictionEnabled:i,geometryType:t,visible:s})))}get layerAdapter(){switch(this.layer.type){case"feature":return"memory"===this.layer.source.type?new hs(this.layer):new us(this.layer);case"geojson":case"csv":case"wfs":return new hs(this.layer);case"subtype-group":return new Ss(this.layer);case"ogc-feature":return new fs(this.layer);case"stream":return new ys(this.layer);case"oriented-imagery":return new ps(this.layer);case"knowledge-graph-sublayer":return new ds(this.layer);case"catalog-footprint":return new rs(this.layer)}return null}get updateHash(){if(!this.layerAdapter)return null;const{availableFields:e,_displayRefreshVersion:t,timeExtent:s,clips:i,filter:r,featureEffect:n,_sourceRefreshVersion:a,view:{timeZone:o}}=this,l=JSON.stringify(i),u=n?.toJSON(),c=r?.toJSON();return JSON.stringify({availableFields:e,clipsHash:l,displayRefreshVersion:t,effectHash:u,filterHash:c,sourceRefreshVersion:a,timeExtent:s,timeZone:o,...this.layerAdapter.getUpdateHashProperties(this.view)})}getDisplayStatistics(e,t){return this.featureContainer?.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return this._worker.pipeline.queryHeatmapStatistics(e)}highlight(e,t="highlight"){let s;e instanceof i?s=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?s=[e]:se.isCollection(e)&&e.length>0?s=e.map((e=>e?.getObjectId())).toArray():Array.isArray(e)&&e.length>0&&(s="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((e=>e?.getObjectId())));const r=s?.filter(ie);return r?.length?(this._addHighlight(r,t),re((()=>this._removeHighlight(r,t)))):re()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return!this._highlightCounter.empty}async hitTest(e,t){const s=await this.featureContainer.hitTest(t);if(0===s.length)return null;const{features:r,aggregates:n}=await this._worker.pipeline.getDisplayFeatures(s),a=this.featureContainer.getSortKeys(s),o=({displayId:e},{displayId:t})=>a.has(e)&&a.has(t)?a.get(e)-a.get(t):e-t;return r.sort(o).reverse(),n.sort(o).reverse(),[...n.map((t=>this._createGraphicHit(e,Ze.fromJSON(t)))),...r.map((t=>this._createGraphicHit(e,i.fromJSON(t))))]}queryStatistics(){return Fs(this._worker.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}querySummaryStatistics(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),i,s);return Fs(r,{})}async queryAggregateSummaryStatistics(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),i,s);return Fs(r,{})}async queryUniqueValues(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.features.executeQueryForUniqueValues(this._cleanUpQuery(e),i,s);return Fs(r,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),i,s);return Fs(r,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.features.executeQueryForClassBreaks(this._cleanUpQuery(e),i,s);return Fs(r,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),i,s);return Fs(r,{classBreakInfos:[]})}async queryHistogram(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.features.executeQueryForHistogram(this._cleanUpQuery(e),i,s);return Fs(r,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,s){const i={...t,scale:this.view.scale},r=this._worker.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),i,s);return Fs(r,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then((e=>{const t=l.fromJSON(e);return t.features.forEach((e=>this._setLayersForFeature(e))),t}))}async queryVisibleFeatures(e,t){const s=this._worker.pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),i=await Fs(s,{features:[]}),r=l.fromJSON(i);return r.features.forEach((e=>this._setLayersForFeature(e))),r}async queryAggregates(e,t){const s=this._worker.aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),i=await Fs(s,{features:[]}),r=Qe.fromJSON(i);return r.features.forEach((e=>this._setLayersForFeature(e))),r}queryAggregateIds(e,t){const s=this._worker.aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return Fs(s,[])}queryAggregateCount(e,t){const s=this._worker.aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return Fs(s,0)}queryAggregateJSON(e,t){const s=this._worker.aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return Fs(s,{features:[]})}async queryFeaturesJSON(e,t){const s=this._worker.features.executeQuery(this._cleanUpQuery(e),t);return Fs(s,{features:[]})}queryObjectIds(e,t){const s=this._worker.features.executeQueryForIds(this._cleanUpQuery(e),t);return Fs(s,[])}queryFeatureCount(e,t){const s=this._worker.features.executeQueryForCount(this._cleanUpQuery(e),t);return Fs(s,0)}async queryExtent(e,t){const s=this._worker.features.executeQueryForExtent(this._cleanUpQuery(e),t),i=await Fs(s,{count:0,extent:null});return{count:i.count,extent:ne.fromJSON(i.extent)}}async getSampleFeatures(e){return this._worker.pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._subscriptionManager)return;const t=this._subscriptionManager.update(e);this.featureContainer.setVisibleTiles(t)}attach(){n("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),this.featureContainer=new it(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new Es({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),this._worker.pipeline.updateSubscriptions(e)},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([B((()=>this.updateHash),(()=>this._update()),ae),B((()=>this.updateSuspended),(e=>{e||this._subscriptionManager.resume()}))]),"stream"!==this.layer.type&&"catalog-footprint"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",(e=>this._edit(e))))}detach(){n("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._fields=null,this.featureContainer.destroy(),this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=oe(this._subscriptionManager),this._worker.pipeline.onDetach()}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&null!=this.layer.renderer,t=this._commandsQueue.updateTracking.updating,s=null!=this._updatingRequiredFieldsPromise,i=this.featureContainer.updatingHandles.updating,r=e&&(t||s)||i||this._pipelineUpdating||this.dataUpdating;if(n("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${r}\n  -> hasRenderer ${e}\n  -> updatingRequiredFields ${s}\n  -> hasPendingCommand ${t}\n  -> dataUpdating ${this.dataUpdating}\n  -> processing ${this._pipelineUpdating}\n  -> updatingContainer ${i}\n`);for(const e of this.featureContainer.subscriptions())console.log(`    -> Tile[${e.id}] Done: ${e.done}`)}return r}_createClientOptions(){const e=this;return{get container(){return e.featureContainer},setUpdating:e=>{this._set("_pipelineUpdating",e.pipeline),this._set("dataUpdating",e.data)},emitEvent:e=>{this.emit(e.name,e.event)},get eventLog(){return e.eventLog},fetch:t=>Promise.all(t.map((t=>e.view.stage.painter.textureManager.rasterizeItem(t)))),fetchDictionary:e=>Promise.all(e.map((e=>this._fetchDictionaryRequest(e))))}}async _fetchDictionaryRequest(e){try{if("subtype-group"===this.layer.type)throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=this.layer.renderer;if(!t||"dictionary"!==t.type)throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const s=this._lastSchema.processor.mesh.factory.symbology;if("dictionary"!==s.type)throw new Error("InternalError: Expected schema to be of type 'dictionary'");const i={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:s.scaleExpression};this._fields||(this._fields=this.layer.fields.map((e=>e.toJSON())));const r=s.visualVariableUniforms,n=await t.getSymbolAsync(e.feature,{fields:this._fields});if(!n||!n.data)return{type:"dictionary-response",meshes:[]};return{type:"dictionary-response",meshes:await Me(n.data,{uniforms:r,path:"renderer",schemaOptions:i})}}catch(e){return{type:"dictionary-response",meshes:[]}}}_cleanUpQuery(e){const t=N.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAggregateQuery(e){const t=N.from(e)||this.createAggregateQuery();t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference);const s=t.objectIds??[];for(const e of t.aggregateIds??[])s.push(e);return t.objectIds=s,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(e){if(this.updateSuspended)return void this._subscriptionManager.suspend();return this._validateEdit(e)?this._commandsQueue.push({type:"edit",edits:e}).catch(le):void 0}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()))}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%Ps+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%Ps+1}_validateEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,s=e.deletedFeatures.some((e=>-1===e.objectId||!e.objectId)),i=t&&this.availableFields.includes(t);return s&&!i?(p.getLogger(this).error(new f("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null):e}async _doUpdate(){"featureReduction"in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=this.layer.featureReduction?.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await this._updateRequiredFields(),this.destroyed||!this.layerAdapter?.hasRequiredSupport||!this._subscriptionManager)return;const e=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const t=this.featureEffect,s={store:e,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},i=await this.layerAdapter.createServiceOptions(this.view),r=this._createViewSchemaConfig(),a={source:this.layerAdapter.createSourceSchema(i,r,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(s,r,this._displayRefreshVersion)},o=!!ue(this._lastSchema?.source.mutable,a.source.mutable)||!!ue(this._lastSchema?.processor,a.processor);if(!o)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(this.featureEffectView.featureEffect=t);this._lastSchema=a,this._fields=null;const l=Math.round(performance.now());n("esri-2d-update-debug")&&console.debug(`Id[${this.layer.uid}] Version[${l}] FeatureLayerView2D._doUpdate`,{changes:o});let u=[];Array.isArray(i.source)&&(u=i.source),await this._worker.pipeline.updateSchema(a,l,{transferList:u}),e.updateEnd(),this.featureEffectView.featureEffect=t,this.featureEffectView.endTransitions(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.swapRenderState(),this.featureContainer.requestRender(),n("esri-2d-update-debug")&&console.debug(`Version[${l}] FeatureLayerView2D.updateEnd`),this.requestUpdate()}catch(e){n("esri-2d-update-debug")&&console.error("Encountered an error during update",e)}}async _doEdit(e){try{this.featureContainer.editStart(),await this._worker.pipeline.onEdits(e),this.featureContainer.editEnd()}catch(e){}}get hasFilter(){const e=this.layerAdapter.hasFilters?.(this.view)??!1;return null!=this.filter||null!=this.timeExtent||this._visibilityOverrides.size>0||e}_getEffectiveAvailableFields(e){const t=Os(this._lastAvailableFields,e);return this._lastAvailableFields=t,ce(this.layer.fieldsIndex,t)}_createViewSchemaConfig(){const e=[Cs(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:e,outSpatialReference:this.view.spatialReference,tileInfoJSON:this.view.featuresTilingScheme.tileInfo.toJSON(),scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlight(e,t){this._highlightCounter.addReason(e,t),this._updateHighlight().catch((e=>{he(e)||p.getLogger(this).error(e)}))}_removeHighlight(e,t){this._highlightCounter.deleteReason(e,t),this._updateHighlight().catch((e=>{he(e)||p.getLogger(this).error(e)}))}_setLayersForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(e)}_createGraphicHit(e,t){return this._setLayersForFeature(t),null!=t.geometry&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};function Cs(e,t,s,i,r){r&&(r=r.clone());const n=null!=r?r.timeExtent:null,a=null!=s&&null!=n?s.intersection(n):s||n;a&&(r??=new _,r.timeExtent=a),r=t.addFilters?.(r,e)??r;let o=r?.toJSON()??null;return i.size&&(o??=(new _).toJSON(),o.hiddenIds=Array.from(i)),o}e([t()],Ts.prototype,"_worker",void 0),e([t()],Ts.prototype,"_commandsQueue",void 0),e([t()],Ts.prototype,"_sourceRefreshVersion",void 0),e([t()],Ts.prototype,"_displayRefreshVersion",void 0),e([t({readOnly:!0})],Ts.prototype,"_pipelineUpdating",void 0),e([t({readOnly:!0})],Ts.prototype,"hasAllFeatures",null),e([t({readOnly:!0})],Ts.prototype,"hasAllFeaturesInView",null),e([t({readOnly:!0})],Ts.prototype,"hasFullGeometries",null),e([t()],Ts.prototype,"featureEffectView",void 0),e([t()],Ts.prototype,"labelingCollisionInfos",null),e([t()],Ts.prototype,"layerAdapter",null),e([t()],Ts.prototype,"updateHash",null),e([t()],Ts.prototype,"updating",void 0),Ts=e([s(zs)],Ts);const Ms=Ts;const _s=Object.freeze({__proto__:null,default:Ms});export{_s as F,Ms as X,Fs as n};
//# sourceMappingURL=p-28a20b6f.js.map