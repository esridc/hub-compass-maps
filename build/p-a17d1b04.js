import{ct as e,cu as i,cv as s,n,cw as r,cx as o,cy as a,cz as l,cA as h,cB as c,cC as u,cD as f,cE as d,a7 as p,cF as m,cG as _,cH as g,cI as v,cJ as w,cK as x,cL as M,cM as C,cN as S,cO as P,cP as z,cQ as k,cR as T,cS as R,cT as I,cU as A,cV as O,cW as D,bC as j,cX as E,cY as L,x as N,cZ as U,c_ as W,c$ as V,ah as X,d0 as $,d1 as G,cn as B,d2 as H,d3 as Y,c6 as q,d4 as J,d5 as K,d6 as Q,d7 as Z,ch as tt,d8 as et,c4 as it,d9 as st,da as nt,U as rt,db as ot,dc as at,dd as lt,s as ht,ci as ct,de as ut,df as ft,dg as dt,dh as pt,a3 as mt,di as _t,K as gt,dj as vt,dk as yt,dl as wt,av as bt,dm as xt,dn as Mt,dp as Ct,$ as St,dq as Pt,dr as zt,ds as kt,dt as Tt,du as Rt,dv as It,dw as At,dx as Ot,dy as Ft,dz as Dt,dA as jt,dB as Et,dC as Lt,dD as Nt,dE as Ut,dF as Wt,dG as Vt,dH as Xt,c9 as $t,co as Gt,dI as Bt,dJ as Ht,dK as Yt,dL as qt,dM as Jt,cd as Kt,dN as Qt,dO as Zt,dP as te,dQ as ee,dR as ie,dS as se,dT as ne,dU as re,dV as oe,dW as ae,dX as le,dY as he,dZ as ce,d_ as ue,w as fe,bD as de,d$ as pe,bj as me,e0 as _e,T as ge,a0 as ve,e1 as ye,c2 as we,e2 as be,e3 as xe,e4 as Me,j as Ce,e5 as Se,e6 as Pe,e7 as ze,e8 as ke,e9 as Te,ea as Re,eb as Ie,ec as Ae,ed as Oe,ee as Fe,ef as De}from"./p-aad64c9f.js";import{u as je,f as Ee}from"./p-b947b9d2.js";import{t as Le,a as Ne,b as Ue,o as We,w as Ve,j as Xe}from"./p-591e796f.js";import{t as $e,e as Ge}from"./p-2d2f231a.js";import{e as Be,t as He,n as Ye,a as qe,b as Je,i as Ke}from"./p-559f4b2d.js";import{m as Qe,c as Ze,h as ti,a as ei,u as ii}from"./p-be38a32f.js";import{l as si}from"./p-01ae94a1.js";import{n as ni,e as ri}from"./p-3f2fef32.js";import{t as oi,e as ai,n as li,a as hi,i as ci}from"./p-682c165c.js";import{L as ui}from"./p-d26004a3.js";import{e as fi,a as di}from"./p-e7002be3.js";import{n as pi}from"./p-439fba24.js";import{e as mi,r as _i,D as gi,v as vi,t as yi,a as wi,n as bi,E as xi,S as Mi}from"./p-ae438250.js";export{b as LabelManager,y as MapViewNavigation}from"./p-ae438250.js";import{E as Ci}from"./p-2ea4a2b9.js";import{o as Si}from"./p-44881b12.js";import{o as Pi,y as zi}from"./p-25f9a898.js";import{i as ki}from"./p-d807bd93.js";import{s as Ti,i as Ri}from"./p-aefd4328.js";import{t as Ii}from"./p-e7a66915.js";import{n as Ai}from"./p-21ce5524.js";import{o as Oi}from"./p-de84037a.js";import{A as Fi,j as Di,y as ji}from"./p-22458323.js";import{f as Ei}from"./p-0527b5ce.js";import{t as Li}from"./p-7ce0ff48.js";import{E as Ni,i as Ui,s as Wi}from"./p-1c4b55c0.js";import{j as Vi}from"./p-59e47154.js";export{F as GraphicsView2D}from"./p-4f2b7ad8.js";export{t as GraphicContainer}from"./p-d8c74537.js";import{t as Xi}from"./p-c65f105a.js";import{y as $i,R as Gi}from"./p-f7f8e29b.js";import"./p-2af77f97.js";import"./p-deddb82e.js";import"./p-17d8c81f.js";import"./p-dc645a50.js";import"./p-7281a451.js";import"./p-aff89b86.js";import"./p-b8a25c33.js";import"./p-a0004a96.js";import"./p-55f3e0f9.js";import"./p-c0b174ee.js";import"./p-717596a8.js";import"./p-204b6b8c.js";import"./p-9ad0e060.js";import"./p-875cbb57.js";import"./p-da522976.js";import"./p-d492d39b.js";import"./p-af33d18c.js";import"./p-008cf576.js";import"./p-08681176.js";import"./p-fa2632fc.js";import"./p-4295487d.js";import"./p-1c285990.js";import"./p-e3657bc3.js";import"./p-bac7b09c.js";import"./p-790e1969.js";import"./p-dc92c2ea.js";import"./p-dddb66c6.js";import"./p-b74976e9.js";import"./p-6bf0c935.js";import"./p-2250105d.js";import"./p-31b7e91d.js";import"./p-23e8befe.js";import"./p-d6556377.js";function Bi(t,e,i){return{transform:es(t,e,i.transform),fromColor:is(t,e,i.fromColor),toColor:ss(t,e,i.toColor),colorMix:ns(t,e,i.colorMix),toOpacity:rs(t,e,i.toOpacity),opacityMix:os(t,e,i.opacityMix),hasAnimations:i.hasAnimations||!!e.animations&&e.animations.length>0}}function Hi(t){return!Le.forceStaticPath&&(Le.forceAnimatedPath||t.hasAnimations)}function Yi(t,e,i){if("CIMCharacterMarker"===e.type)return n.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),i;const r=s(t,e,"OffsetX"),o=s(t,e,"OffsetY");if("CIMPictureMarker"===e.type)return{...i,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:us([r,o]),rotation:us(0),scale:us(s(t,e,"Size")),parent:i.transform}};const a=e.frame,l=a.ymax-a.ymin;return{...i,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:us([r,o]),rotation:us(0),scale:us({type:"Process",op:"Divide",left:s(t,e,"Size"),right:l}),parent:i.transform}}}function qi(t,e){let i=0,s=0;const n="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(i=-t.anchorPoint.x,s=-t.anchorPoint.y),{...e,transform:{type:"AnimatedTransform",relativeTranslation:n,absoluteScale:!1,translation:us([i,s]),rotation:us(0),scale:us(1),parent:e.transform}}}function Ji(t,e){return"Absolute"===t.anchorPointUnits?e:qi(t,e)}function Ki(t,e){return"Absolute"!==t.anchorPointUnits?e:qi(t,e)}function Qi(t,e,i){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:us([e,i]),rotation:us(0),scale:us(1),parent:t.transform}}}function Zi(t,e){switch(e.type){case"CIMPictureMarker":case"CIMVectorMarker":return s(t,e,"Rotation")}return 0}function ts(t,e){switch(e.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return s(t,e,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return s(t,e,"TintColor")}return[1,1,1,1]}function es(t,e,i){return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:hs(t,e),rotation:cs(t,e),scale:ls(t,e),parent:i}}function is(t,e,i){return{type:"AnimatedColor",color:us(ts(t,e)),opacity:us(1),parent:i}}function ss(t,e,i){const{animations:n}=e;let r=ts(t,e);const o=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return o&&(r=s(t,o,"ToColor")),{type:"AnimatedColor",color:us(r),opacity:us(1),parent:i}}function ns(t,e,i){const{animations:s}=e,n=s?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return n?{type:"AnimatedColor",color:us([1,1,1,1]),opacity:{from:0,to:1,timing:as(t,n?.animatedSymbolProperties)},parent:[1,1,1,1]}:i}function rs(t,e,i){const{animations:n}=e;let r=us(1);const o=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];if(o){r=us({type:"Process",op:"Transparency",value:s(t,o,"ToTransparency")})}return{type:"AnimatedColor",color:us([1,1,1,1]),opacity:r,parent:i}}function os(t,e,i){const{animations:s}=e,n=s?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];return n?{type:"AnimatedColor",color:us([1,1,1,1]),opacity:{from:0,to:1,timing:as(t,n?.animatedSymbolProperties)},parent:[1,1,1,1]}:i}function as(t,n){if(!n)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:$e.Local,repeatType:e.Loop,easing:i.Linear,playAnimation:1,reverseAnimation:0};const o=s(t,n,"Duration");let l;if(s(t,n,"RandomizeStartTime")){l={type:"Process",op:"Random",min:0,max:o,seed:s(t,n,"RandomizeStartSeed")}}else l=s(t,n,"StartTimeOffset");const h=s(t,n,"RepeatDelay"),c=s(t,n,"PlayAnimation"),u=s(t,n,"ReverseAnimation"),f=r(n.repeatType,a.CIMAnimatedSymbolProperties.repeattype);return{duration:o,startTimeOffset:l,repeatDelay:h,timeOriginSelector:f===e.None?$e.Local:$e.Global,repeatType:f,easing:r(n.easing,a.CIMAnimatedSymbolProperties.easing),playAnimation:c,reverseAnimation:u}}function ls(t,e){const{animations:i}=e;if("CIMPictureMarker"!==e.type&&"CIMVectorMarker"!==e.type&&"CIMPointSymbol"!==e.type)return us(1);let n;n="CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type?s(t,e,"Size"):o(e)||10;const r=i?.filter((t=>"CIMSymbolAnimationScale"===t.type))[0];if(!r){const e=i?.filter((t=>"CIMSymbolAnimationSize"===t.type))[0];if(!e)return us(1);return{from:1,to:{type:"Process",op:"Divide",left:s(t,e,"ToSize"),right:n},timing:as(t,e.animatedSymbolProperties)}}return{from:1,to:s(t,r,"ScaleFactor"),timing:as(t,r.animatedSymbolProperties)}}function hs(t,e){const{animations:i}=e,n=i?.filter((t=>"CIMSymbolAnimationOffset"===t.type))[0];if(!n)return us([0,0]);return{from:[0,0],to:[s(t,n,"OffsetX"),s(t,n,"OffsetY")],timing:as(t,n.animatedSymbolProperties)}}function cs(t,e){const{animations:i}=e,n=Zi(t,e),r=i?.filter((t=>"CIMSymbolAnimationRotation"===t.type))[0];if(!r)return us(n);return{from:n,to:s(t,r,"ToRotation"),timing:as(t,r.animatedSymbolProperties)}}function us(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:$e.Local,repeatType:e.Loop,easing:i.Linear,playAnimation:1,reverseAnimation:0}}}function fs(t){if(null==t)return!1;if("object"!=typeof t)return!1;if(t.animations&&Array.isArray(t.animations)&&t.animations.length>0)return!0;for(const e in t)if(fs(t[e]))return!0;return!1}const ds=()=>n.getLogger("esri.symbols.cim.cimAnalyzer");function ps(t){const e=t.markerPlacement;return e&&e.angleToLine?k.MAP:k.SCREEN}class ms{constructor(t){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],t&&(this._resourceManager=t)}analyzeSymbolReference(t,e,i){if(this._cimLayers=i??[],!t)return this._cimLayers;if(this._reset(),t.primitiveOverrides){this._primitiveOverrides=t.primitiveOverrides;for(const t of this._primitiveOverrides){const e=t.valueExpressionInfo;if(e)this._setPoMap(t.primitiveName,t.propertyName,e);else if(null!=t.value){let e=t.value;t.propertyName.includes("Color")&&(P(e)&&(e=z(e)),e=l(e)),this._setPoMap(t.primitiveName,t.propertyName,e)}}}return this._analyzeSymbol(t.symbol,e),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(t,e){switch(t?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(t,e)}}_analyzeMultiLayerSymbol(t,e){const i=t?.symbolLayers;if(!i)return;const s=t.effects;let n=k.SCREEN;const r=o(t)??0;"CIMPointSymbol"===t.type&&"Map"===t.angleAlignment&&(n=k.MAP);let a={transform:[0,0,0,1],fromColor:[1,1,1,1],toColor:[1,1,1,1],colorMix:[0,0,0,0],toOpacity:[1,1,1,1],opacityMix:[0,0,0,0],hasAnimations:fs(t)};a=Bi(this._poMap,t,a);const l="CIMPolygonSymbol"===t.type;let c=i.length;for(;c--;){const o=i[c];if(!o||!1===o.enable)continue;let u;s?.length&&(u=[...s]);const f=o.effects;f?.length&&(s?u.push(...f):u=[...f]);let d=null;if(u){d=[];for(const t of u){const e=h.findEffectOverrides(t,this._primitiveOverrides);e&&d.push(e)}}const p=[];switch(h.findApplicableOverrides(o,this._primitiveOverrides,p),o.type){case"CIMSolidFill":this._analyzeSolidFill(o,d);break;case"CIMPictureFill":this._analyzePictureFill(o,d);break;case"CIMHatchFill":this._analyzeHatchFill(o,d);break;case"CIMGradientFill":this._analyzeGradientFill(o,d);break;case"CIMSolidStroke":this._analyzeSolidStroke(o,d,l,r);break;case"CIMPictureStroke":this._analyzePictureStroke(o,d,l,r);break;case"CIMGradientStroke":this._analyzeGradientStroke(o,d,l,r);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==t.type&&"CIMPolygonSymbol"!==t.type||(n=ps(o));const i=[],s=o.primitiveName;s&&i.push(s);const h=l&&T(o.markerPlacement);this._analyzeMarker(o,d,null,i,n,r,e,[],a,!1,h);break}default:ds().error("Cannot analyze CIM layer",o.type)}}}_analyzeSolidFill(t,e){const{primitiveName:i,type:s}=t,n=l(t.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!t.colorLocked,color:this._getValueOrOverrideExpression(s,i,"Color",n),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(t,e){const{primitiveName:i,type:s}=t,n=R(t),r=c(t.height,a.CIMPictureFill.height);let o=c(t.scaleX,1);if("width"in t&&"number"==typeof t.width){const e=t.width;let i=1;const s=this._resourceManager.getResource(t.url);null!=s&&(i=s.width/s.height),o/=i*(r/e)}const l={type:"sprite-rasterization-param",resource:t,overrides:this._getPrimitiveMaterialOverrides(i,s)};this._cimLayers.push({type:"fill",spriteRasterizationParam:l,colorLocked:!!t.colorLocked,effects:e,color:this._getValueOrOverrideExpression(s,i,"TintColor",n),height:this._getValueOrOverrideExpression(s,i,"Height",r),scaleX:this._getValueOrOverrideExpression(s,i,"ScaleX",o),angle:this._getValueOrOverrideExpression(s,i,"Rotation",c(t.rotation)),offsetX:this._getValueOrOverrideExpression(s,i,"OffsetX",c(t.offsetX)),offsetY:this._getValueOrOverrideExpression(s,i,"OffsetY",c(t.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(t,e){const{primitiveName:i,type:s}=t,n=this._analyzeMaterialOverrides(i,["Rotation","OffsetX","OffsetY"]),r=u(n);let o=[255,255,255,1],h=!1;if(t.lineSymbol?.symbolLayers)for(const e of t.lineSymbol.symbolLayers){if("CIMSolidStroke"!==e.type)continue;const t=e.primitiveName??i;h||!t||e.colorLocked||null==this._poMap[t]?.Color&&null==this._poMap[t]?.StrokeColor||(o=l(e.color),o=this._maybeGetValueOrOverrideExpression(t,"StrokeColor")??this._getValueOrOverrideExpression(s,t,"Color",o),h=!0);const n=this._maybeGetValueOrOverrideExpression(t,"StrokeWidth");if(n){let e=null,i=null;"number"==typeof n?e=n:i=n.valueExpressionInfo;let o=r.find((t=>"strokeWidth"===t.propertyName));o?o.propertyName="width":(o={type:"CIMPrimitiveOverride",primitiveName:t,propertyName:"width",valueExpressionInfo:i,value:e,defaultValue:f(s,"width")},r.push(o))}}const d={type:"sprite-rasterization-param",resource:t,overrides:r};this._cimLayers.push({type:"fill",spriteRasterizationParam:d,colorLocked:!!t.colorLocked,effects:e,color:o,height:this._getValueOrOverrideExpression(s,i,"Separation",c(t.separation,a.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(s,i,"Rotation",c(t.rotation)),offsetX:this._getValueOrOverrideExpression(s,i,"OffsetX",c(t.offsetX)),offsetY:this._getValueOrOverrideExpression(s,i,"OffsetY",c(t.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!h})}_analyzeGradientFill(t,e){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!t.colorLocked,effects:e,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(t,e,i,s){const{primitiveName:n,type:r}=t,o=l(t.color),h=c(t.width,a.CIMSolidStroke.width),u=I(t.capStyle,a.CIMSolidStroke.capstyle),f=I(t.joinStyle,a.CIMSolidStroke.joinstyle),d=t.miterLimit;let p,m,_,g,v=[];if(this._analyzePrimitiveOverrides(n,e,null,null)&&(v=this._getPrimitiveMaterialOverrides(n,r)),e&&Array.isArray(e)&&e.length>0){const t=e[e.length-1].effect;t&&"CIMGeometricEffectDashes"===t.type&&"NoConstraint"===t.lineDashEnding&&(p=t.dashTemplate,m=t.scaleDash,_=t.offsetAlongLine,g=t.primitiveName,(e=[...e]).pop())}null!=g&&v.push(...this._getPrimitiveMaterialOverrides(g,r).filter((t=>"dashTemplate"===t.propertyName)));const y=void 0!==p?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:p,primitiveName:g},overrides:v}:null;this._cimLayers.push({type:"line",spriteRasterizationParam:y,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:this._getValueOrOverrideExpression(r,n,"Color",o),width:this._getValueOrOverrideExpression(r,n,"Width",h),cap:this._getValueOrOverrideExpression(r,n,"CapStyle",u),join:this._getValueOrOverrideExpression(r,n,"JoinStyle",f),miterLimit:d&&this._getValueOrOverrideExpression(r,n,"MiterLimit",d),referenceWidth:s,zOrder:gs(t.name),dashTemplate:this._maybeGetValueOrOverrideExpression(g,"DashTemplate")??p,offsetAlongLine:this._getValueOrOverrideExpression(r,g,"OffsetAlongLine",_??0),scaleDash:m,sampleAlphaOnly:!0})}_analyzePictureStroke(t,e,i,s){const{primitiveName:n,type:r}=t,o=R(t),l=c(t.width,a.CIMPictureStroke.width),h=I(t.capStyle,a.CIMPictureStroke.capstyle),u=I(t.joinStyle,a.CIMPictureStroke.joinstyle),f=t.miterLimit,d={type:"sprite-rasterization-param",resource:t,overrides:this._getPrimitiveMaterialOverrides(n,r)};this._cimLayers.push({type:"line",spriteRasterizationParam:d,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:this._getValueOrOverrideExpression(r,n,"TintColor",o),width:this._getValueOrOverrideExpression(r,n,"Width",l),cap:this._getValueOrOverrideExpression(r,n,"CapStyle",h),join:this._getValueOrOverrideExpression(r,n,"JoinStyle",u),miterLimit:f&&this._getValueOrOverrideExpression(r,n,"MiterLimit",f),referenceWidth:s,zOrder:gs(t.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(t,e,i,s){const{primitiveName:n,type:r}=t,o=c(t.width,a.CIMSolidStroke.width),l=I(t.capStyle,a.CIMGradientStroke.capstyle),h=I(t.joinStyle,a.CIMGradientStroke.joinstyle),u=t.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:[128,128,128,1],width:this._getValueOrOverrideExpression(r,n,"Width",o),cap:this._getValueOrOverrideExpression(r,n,"CapStyle",l),join:this._getValueOrOverrideExpression(r,n,"JoinStyle",h),miterLimit:u&&this._getValueOrOverrideExpression(r,n,"MiterLimit",u),referenceWidth:s,zOrder:gs(t.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(t,e,i,s,n,r,o,l,h,u=!1,f=!1){if(u||=!!t.colorLocked,this._analyzeMarkerInsidePolygon(t,e,u))return;const d=c(t.size,a.CIMVectorMarker.size),p=c(t.rotation),m=c(t.offsetX),_=c(t.offsetY),{primitiveName:g,type:v}=t,y=this._getValueOrOverrideExpression(v,g,"Size",d),w=this._getValueOrOverrideExpression(v,g,"Rotation",p),b=this._getValueOrOverrideExpression(v,g,"OffsetX",m),x=this._getValueOrOverrideExpression(v,g,"OffsetY",_);let M=h;switch(M=Ki(t,M),M=Yi(this._poMap,t,M),M=Ji(t,M),M=Bi(this._poMap,t,M),t.type){case"CIMPictureMarker":this._analyzePictureMarker(t,e,i,s,n,r,y,w,b,x,l,M,u,f);break;case"CIMVectorMarker":this._analyzeVectorMarker(t,e,i,s,n,r,y,w,b,x,l,M,o,u,f)}}_analyzeMarkerInsidePolygon(t,e,i){const{markerPlacement:s,type:n}=t;if(!s||"CIMMarkerPlacementInsidePolygon"!==s.type)return!1;if("CIMVectorMarker"===n||"CIMPictureMarker"===n){const i=t.primitiveName;if(i&&this._analyzePrimitiveOverrides([i],e,null,null))return!1;const r=s.primitiveName;if(r&&this._analyzePrimitiveOverrides([r],e,null,null))return!1;if("CIMVectorMarker"===n){const{markerGraphics:e}=t;if(e)for(const t of e){const{symbol:e}=t;if("CIMPolygonSymbol"===e?.type&&e.symbolLayers){const{symbolLayers:t}=e;for(const e of t)if("CIMSolidStroke"===e.type)return!1}}}else{const{animatedSymbolProperties:e}=t;if(e)return!1}}const r=Math.abs(s.stepX),o=Math.abs(s.stepY);if(0===r||0===o)return!0;let a,l;if("Random"===s.gridType){const t=O(D),e=Math.max(Math.floor(t/r),1);a=o*Math.max(Math.floor(t/o),1);l=e*r/a}else s.shiftOddRows?(a=2*o,l=r/o*.5):(a=o,l=r/o);const h=R(t),u="CIMCharacterMarker"===t.type?null:{type:"sprite-rasterization-param",resource:t,overrides:[]};return this._cimLayers.push({type:"fill",spriteRasterizationParam:u,colorLocked:i,effects:e,color:h,height:a,scaleX:l,angle:s.gridAngle,offsetX:c(s.offsetX),offsetY:c(s.offsetY),applyRandomOffset:"Random"===s.gridType,sampleAlphaOnly:"CIMPictureMarker"!==t.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(t,e,i,s,n,r,o,a,l,h,u,f,m,_){const{animatedSymbolProperties:g,primitiveName:v,type:y}=t;let w=c(t.scaleX,1);const b=R(t);i||(i=this._createMarkerPlacementOverrideExpression(t.markerPlacement));const x=this._createGIFAnimatedSymbolPropertiesOverrideExpression(g),M=t.anchorPoint??{x:0,y:0};if("width"in t&&"number"==typeof t.width){const e=t.width;let i=1;const s=this._resourceManager.getResource(t.url);null!=s&&(i=s.width/s.height);w/=i*(c(t.size)/e)}const C=[...s];let S;t.primitiveName&&C.push(t.primitiveName),g||x?S={type:"animated",url:t.url,urlHash:"H"+d(t.url),playAnimation:t.animatedSymbolProperties?.playAnimation,reverseAnimation:t.animatedSymbolProperties?.reverseAnimation,randomizeStartTime:t.animatedSymbolProperties?.randomizeStartTime,randomizeStartSeed:t.animatedSymbolProperties?.randomizeStartSeed,startTimeOffset:t.animatedSymbolProperties?.startTimeOffset,duration:t.animatedSymbolProperties?.duration,repeatType:t.animatedSymbolProperties?.repeatType,repeatDelay:t.animatedSymbolProperties?.repeatDelay}:(S=p(t),S.markerPlacement=null);const P={type:"sprite-rasterization-param",resource:S,overrides:this._getMaterialOverrides(C,y)};x&&P.overrides.push(...x.overrides);const z=o;this._cimLayers.push({type:"marker",spriteRasterizationParam:P,colorLocked:m,effects:e,scaleSymbolsProportionally:!1,alignment:n,size:o,scaleX:this._getValueOrOverrideExpression(y,v,"ScaleX",w),rotation:a,offsetX:l,offsetY:h,transform:{type:"cim-marker-transform-param",params:u},color:this._getValueOrOverrideExpression(y,v,"TintColor",b),anchorPoint:{x:M.x,y:M.y},isAbsoluteAnchorPoint:"Relative"!==t.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!t.rotateClockwise,referenceSize:r,sizeRatio:1,isOutline:_,markerPlacement:i,animationParams:bs(f),baseSize:z})}_analyzeVectorMarker(t,e,i,s,n,r,o,a,l,h,c,u,f,d,p){const m=t.markerGraphics;if(!m)return;const _=t.frame;let g=0;g=_?_.ymax-_.ymin:r;const v=!!t.scaleSymbolsProportionally;if(g){const e={offsetX:l,offsetY:h,rotation:a,size:o,frameHeight:g,rotateClockWise:!!t.rotateClockwise,absoluteAnchorPoint:!1,scaleSymbolsProportionally:v};c=[...c,e]}i||(i=this._createMarkerPlacementOverrideExpression(t.markerPlacement));for(const o of m)if(o){const a=o.symbol;if(!a)continue;const l=o.primitiveName;l&&s.push(l);let h,m=u;if(("CIMPointSymbol"===a.type||"CIMTextSymbol"===a.type)&&_){let e=0,i=0;const s=o.geometry;"x"in s&&"y"in s&&(e+=s.x-.5*(_.xmin+_.xmax),i+=s.y-.5*(_.ymin+_.ymax));const n=t.anchorPoint;let r=!1;n&&("Absolute"===t.anchorPointUnits?(e-=n.x,i-=n.y,r=!0):_&&(e-=(_.xmax-_.xmin)*n.x,i-=(_.ymax-_.ymin)*n.y));const a={offsetX:e,offsetY:i,rotation:0,size:0,frameHeight:0,rotateClockWise:!1,absoluteAnchorPoint:r,scaleSymbolsProportionally:v};h=[...c,a]}if("CIMPointSymbol"===a.type||"CIMTextSymbol"===a.type){const t=o.geometry;if("x"in t&&"y"in t){const{x:e,y:i}=t,s=_?.5*-(_.xmin+_.xmax):0,n=_?.5*-(_.ymin+_.ymax):0;e+s===0&&i+n===0||(m=Qi(m,e+s,i+n))}}switch("CIMPointSymbol"===a.type&&(m=Bi(this._poMap,a,m)),a.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":f||ys(a)?(m={...m,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:us([0,0]),rotation:us(0),scale:us(g),parent:u.transform}},this._analyzeMultiLayerGraphicNonSDF(t,e,i,o,s,n,r,h??c,m,g,d,p)):this._analyzeMultiLayerGraphic(t,e,i,o,s,n,r,h??c,m,g,d,p);break;case"CIMTextSymbol":this._analyzeTextGraphic(e,i,o,s,n,r,h??c,d)}l&&s.pop()}}_analyzeMultiLayerGraphic(t,e,i,s,n,r,o,h,u,f,d,p){const v=s.symbol,y=v.symbolLayers;if(!y)return;let w=y.length;if(vs(y)&&!Hi(u))return void this._analyzeCompositeMarkerGraphic(t,e,i,s,y,r,o,h,f,d,p);const b=this._resourceManager.geometryEngine,x=si.applyEffects(v.effects,s.geometry,b);if(x)for(;w--;){const v=y[w];if(!v||!1===v.enable)continue;const M=v.primitiveName;switch(M&&n.push(M),v.type){case"CIMSolidFill":case"CIMSolidStroke":{const n=si.applyEffects(v.effects,x,b),y=Qe(n);if(!y)continue;const w="Relative"!==t.anchorPointUnits,C=m(v)??0,{frameSizeRatio:S,anchorX:P,anchorY:z,widthRatio:k,sdfPaddingRatio:T}=ti(y,t.frame,t.size,t.anchorPoint,w,C,t.scaleSymbolsProportionally),R="CIMSolidFill"===v.type,I={type:"sdf",geom:n,sdfPaddingRatio:T,asFill:R},{path:A}=v,O=R?l(_(v)):null==A?l(g(v)):[0,0,0,0],F=R?[0,0,0,0]:l(g(v));if(!R&&!C)break;const D=s.primitiveName;let j=null;R&&!v.colorLocked&&(j=this._maybeGetValueOrOverrideExpression(D,"FillColor"));let E=null;R||v.colorLocked||(E=this._maybeGetValueOrOverrideExpression(D,"StrokeColor"));const L=j??this._getValueOrOverrideExpression(v.type,M,"Color",O),N=E??this._getValueOrOverrideExpression(v.type,M,"Color",F),U=this._maybeGetValueOrOverrideExpression(D,"StrokeWidth")??this._getValueOrOverrideExpression(v.type,M,"Width",C),W=A?{type:"sprite-rasterization-param",resource:{type:"path",path:A,asFill:R},overrides:[]}:{type:"sprite-rasterization-param",resource:I,overrides:[]},V=Bi(this._poMap,v,u),X=c(t.size,a.CIMVectorMarker.size),$=this._getValueOrOverrideExpression(t.type,t.primitiveName,"Size",X);this._cimLayers.push({type:"marker",spriteRasterizationParam:W,colorLocked:!!v.colorLocked||!!d,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:r,anchorPoint:{x:P,y:z},isAbsoluteAnchorPoint:w,size:f,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:h},frameHeight:f,widthRatio:k,rotateClockwise:!1,referenceSize:o,sizeRatio:S,color:L,outlineColor:N,outlineWidth:U,isOutline:p,markerPlacement:i,animationParams:bs(V),isStroke:"CIMSolidFill"!==v.type,baseSize:$,...Ze(n,T)});break}case"CIMPictureMarker":case"CIMVectorMarker":v.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(t,e,i,s,n,r,o,h,u,f,!!v.colorLocked||!!d,p):this._analyzeMarker(v,e,i,n,r,o,!1,h,u,d,p);break;default:this._analyzeMultiLayerGraphicNonSDF(t,e,i,s,n,r,o,h,u,f,!!v.colorLocked||!!d,p)}M&&n.pop()}}_analyzeTextGraphic(t,e,i,s,n,r,o,u){const f=[];h.findApplicableOverrides(i,this._primitiveOverrides,f);const d=i.geometry;if(!("x"in d)||!("y"in d))return;const p=i.symbol,_=A(p),g=v(p.fontStyleName),y=je(p.fontFamilyName);p.font={family:y,decoration:_,...g};const b=c(p.height,a.CIMTextSymbol.height),M=c(p.angle),C=c(p.offsetX),S=c(p.offsetY),{haloSymbol:P}=p,z=c(p.haloSize,0);let k=[0,0,0,0];if(P?.symbolLayers?.length){const t=P.symbolLayers;for(const e of t)if(e.color){k=this._getValueOrOverrideExpression(p?.haloSymbol?.type??"CIMPolygonSymbol",e.primitiveName,"Color",l(e.color));break}}const T=i.primitiveName;let R=[0,0,0,1],I=[0,0,0,0],O=0,F=!1;if(p.symbol?.symbolLayers)for(const t of p.symbol.symbolLayers){const e=t.primitiveName;if("CIMSolidStroke"===t.type)I=this._getValueOrOverrideExpression("CIMSolidStroke",e,"Color",l(t.color)),O=this._getValueOrOverrideExpression("CIMSolidStroke",e,"Width",m(t)??0);else if("CIMSolidFill"===t.type){const i=l(t.color);F=F??!!t.colorLocked,R=this._getValueOrOverrideExpression("CIMSolidFill",e??T,"Color",i)}}let D=null,j=null,E=null,L=null,N=null;T&&(D=this._maybeGetValueOrOverrideExpression(T,"TextSize"),j=this._maybeGetValueOrOverrideExpression(T,"TextAngle"),E=this._maybeGetValueOrOverrideExpression(T,"TextOffsetX"),L=this._maybeGetValueOrOverrideExpression(T,"TextOffsetY"),F||(N=this._maybeGetValueOrOverrideExpression(T,"FillColor")));const U=N??R;let W=null,V=null,X=0;if(p.callout&&"CIMBackgroundCallout"===p.callout.type){const t=p.callout;if(t.backgroundSymbol){const e=t.backgroundSymbol.symbolLayers;if(e)for(const t of e)"CIMSolidFill"===t.type?W=l(t.color):"CIMSolidStroke"===t.type&&(V=l(t.color),X=c(t.width,a.CIMSolidStroke.width))}}const $=this._getValueOrOverrideExpression(p.type,i.primitiveName,"TextString",i.textString??"");if(null==$)return;const{fontStyleName:G}=p,B=y+(G?"-"+G.toLowerCase():"-regular"),H=this._getMaterialOverrides(s,p.type);H.push(...this._getPrimitiveMaterialOverrides(i.primitiveName,p.type));const Y={type:"text-rasterization-param",resource:{type:"text",textString:i.textString??"",font:p.font,symbol:p,primitiveName:i.primitiveName},overrides:H};this._cimLayers.push({type:"text",lineWidth:p.lineWidth,textRasterizationParam:Y,colorLocked:!!u||!!F,effects:t,alignment:n,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:B,decoration:_,haloSize:z,haloColor:k,weight:g.weight,style:g.style,size:D??b,angle:j??M,offsetX:E??C,offsetY:L??S,transform:{type:"cim-marker-transform-param",params:o},horizontalAlignment:w(p.horizontalAlignment),verticalAlignment:x(p.verticalAlignment),text:$,color:U,outlineColor:I,outlineSize:O,backgroundColor:W,borderLineColor:V,borderLineWidth:X,referenceSize:r,sizeRatio:1,markerPlacement:e})}_analyzeMultiLayerGraphicNonSDF(t,e,i,s,n,r,o,l,h,f,d,p){const m=_s(t,s),_=t.primitiveName,g=this._analyzeMaterialOverrides(_,["Rotation","OffsetX","OffsetY"]),v=u(g),[y,w,b]=Be.getTextureAnchor(m,this._resourceManager),x=this._getMaterialOverrides(n,t.type);x.push(...v);const C={type:"sprite-rasterization-param",resource:{...m,avoidSDFRasterization:!0},overrides:x},S=c(t.size,a.CIMVectorMarker.size),P=this._getValueOrOverrideExpression(t.type,_,"Size",S);this._cimLayers.push({type:"marker",spriteRasterizationParam:C,colorLocked:d,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:r,anchorPoint:{x:y,y:w},isAbsoluteAnchorPoint:!1,size:f,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:l},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:f,widthRatio:1,rotateClockwise:!!t.rotateClockwise,referenceSize:o,sizeRatio:b/M(t.size),isOutline:p,markerPlacement:i,animationParams:bs(h),baseSize:P})}_createMarkerPlacementOverrideExpression(t){if(!t)return null;const e=[];return h.findApplicableOverrides(t,this._primitiveOverrides,e),{type:"cim-marker-placement-param",placement:t,overrides:ws(e)}}_createGIFAnimatedSymbolPropertiesOverrideExpression(t){if(!t)return null;const e=[];return h.findApplicableOverrides(t,this._primitiveOverrides,e),{type:"cim-gif-animation-params",animation:t,overrides:ws(e)}}_analyzeCompositeMarkerGraphic(t,e,i,s,n,r,o,h,u,f,d){const p=s.geometry,m=n[0],_=n[1],g=Qe(p);if(!g)return;const v="Relative"!==t.anchorPointUnits,y=c(m.width,a.CIMSolidStroke.width),{frameSizeRatio:w,anchorX:b,anchorY:x,widthRatio:M,sdfPaddingRatio:C}=ti(g,t.frame,t.size,t.anchorPoint,v,y,t.scaleSymbolsProportionally),{path:S}=_,P=_.primitiveName,z=m.primitiveName,k=s.primitiveName;let T=null;_.colorLocked||f||(T=this._maybeGetValueOrOverrideExpression(k,"FillColor"));const R=T??this._getValueOrOverrideExpression(_.type,P,"Color",l(_.color));let I=null;m.colorLocked||f||(I=this._maybeGetValueOrOverrideExpression(k,"StrokeColor"));const A=I??this._getValueOrOverrideExpression(m.type,z,"Color",l(m.color)),O=this._maybeGetValueOrOverrideExpression(k,"StrokeWidth")??this._getValueOrOverrideExpression(m.type,z,"Width",y),F={type:"sprite-rasterization-param",resource:S?{type:"path",path:S,asFill:!0}:{type:"sdf",geom:p,sdfPaddingRatio:C,asFill:!0},overrides:[]};this._cimLayers.push({type:"marker",spriteRasterizationParam:F,colorLocked:f,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:r,anchorPoint:{x:b,y:x},isAbsoluteAnchorPoint:v,size:u,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:h},frameHeight:u,widthRatio:M,rotateClockwise:!1,referenceSize:o,sizeRatio:w,color:R,outlineColor:A,outlineWidth:O,isOutline:d,markerPlacement:i})}_setPoMap(t,e,i){let s;this._poMap[t]?s=this._poMap[t]:(s={},this._poMap[t]=s),s[e]=i}_maybeGetValueOrOverrideExpression(t,e,i){return this._getValueOrOverrideExpression("",t,e,i,!1)}_getValueOrOverrideExpression(t,e,i,s,n=!0){if(n&&!S(s)&&(s=f(t,i.toLowerCase())),null==e)return s;const r=this._poMap[e];if(null==r)return s;const o=r[i];return"string"==typeof o||"number"==typeof o||Array.isArray(o)?o:o?{valueExpressionInfo:o,defaultValue:s}:s}_analyzePrimitiveOverrides(t,e,i,s){if(null==t)return!1;"string"==typeof t&&(t=[t]);for(const e of this._primitiveOverrides)if(t.includes(e.primitiveName)&&e.valueExpressionInfo)return!0;if(null!=e)for(const t of e)if(t?.overrides.length>0)return!0;if(null!=i)for(const t of i)if(t?.overrides.length>0)return!0;if(null!=s)for(const t of s)if(t?.overrides.length>0)return!0;return!1}_getMaterialOverrides(t,e){if(!t)return[];const i=[];for(const s of t)i.push(...this._getPrimitiveMaterialOverrides(s,e));return i}_getPrimitiveMaterialOverrides(t,e){if(!t)return[];const i=u(this._primitiveOverrides.filter((e=>e.primitiveName===t)));return i.forEach((t=>t.defaultValue=f(e,t.propertyName.toLowerCase()))),i}_analyzeMaterialOverrides(t,e){return this._primitiveOverrides.filter((i=>i.primitiveName!==t||!e.includes(i.propertyName)))}}function _s(t,e){return{type:t.type,enable:!0,name:t.name,colorLocked:t.colorLocked,primitiveName:t.primitiveName,anchorPoint:t.anchorPoint,anchorPointUnits:t.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:t.rotateClockwise,rotation:0,size:t.size,billboardMode3D:t.billboardMode3D,depth3D:t.depth3D,frame:t.frame,markerGraphics:[e],scaleSymbolsProportionally:t.scaleSymbolsProportionally,respectFrame:t.respectFrame,clippingPath:t.clippingPath}}function gs(t){if(t&&0===t.indexOf("Level_")){const e=parseInt(t.slice(6),10);if(!isNaN(e))return e}return 0}const vs=t=>t&&2===t.length&&t[0].enable&&t[1].enable&&"CIMSolidStroke"===t[0].type&&"CIMSolidFill"===t[1].type&&null==t[0].path&&null==t[1].path&&!t[0].effects&&!t[1].effects&&!t[0].animations&&!t[1].animations;function ys(t){const e=t.symbolLayers;if(!e)return!1;const i=e.find((t=>t.effects?.find((t=>"CIMGeometricEffectDashes"===t.type&&null!=t.dashTemplate)))),s=e.find((t=>t.effects?.find((t=>"CIMGeometricEffectAddControlPoints"===t.type))));return!!i||!!s}function ws(t){return p(t).map((t=>({...t,propertyName:C(t.propertyName)})))}function bs(t){return Hi(t)?{type:"animation-params",params:t}:null}class xs{constructor(t){this.events=new j,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const e={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0,powerPreference:"high-performance"};t.appendChild(this._canvas);let i=this._canvas.getContext("webgl2",e);i||(i=this._canvas.getContext("webgl2",{...e,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=i,this._handles=E([L(this._canvas,"webglcontextlost",(t=>this.events.emit("webgl-context-lost",t)))])}destroy(){this._canvas.parentNode?.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(t,e){if(this._hasMajorPerformanceCaveat||N("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=N("esri-performance-mode-frames-between-render")&&(e(),this._lastRenderViewState=t.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[e,i,s,n,r,o]=this._computeViewTransform(this._lastRenderViewState,t.state);this._canvas.style.transform=`matrix(${e}, ${i}, ${s}, ${n}, ${r}, ${o})`}}else e()}resize(t){const e=this._canvas,i=e.style,{state:{size:s},pixelRatio:n}=t,r=s[0],o=s[1],a=Math.round(r*n),l=Math.round(o*n);e.width===a&&e.height===l||(e.width=a,e.height=l),i.width=r+"px",i.height=o+"px"}_computeViewTransform(t,e){const[i,s]=t.center,[n,r]=e.center,[o,a]=t.toScreen([0,0],n,r),[l,h]=t.toScreen([0,0],i,s),c=l-o,u=h-a,f=t.scale/e.scale,d=e.rotation-t.rotation,p=G();return U(p),W(p,p,[f,f]),V(p,p,X(d)),$(p,p,[c,u]),p}}const Ms={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};function Cs(t){let e=Ms;return t.split("/").forEach((t=>{e&&(e=e[t])})),e}const Ss=new fi(Cs);function Ps(t){return Ss.resolveIncludes(t)}const zs=t=>pi({PATTERN:t.pattern}),ks={shaders:t=>({vertexShader:zs(t)+Ps("background/background.vert"),fragmentShader:zs(t)+Ps("background/background.frag")})},Ts={shaders:t=>({vertexShader:Ps("circle/circle.vert"),fragmentShader:Ps("circle/circle.frag")})},Rs=t=>pi({PATTERN:t.pattern}),Is={shaders:t=>({vertexShader:Rs(t)+Ps("fill/fill.vert"),fragmentShader:Rs(t)+Ps("fill/fill.frag")})},As={shaders:t=>({vertexShader:Ps("outline/outline.vert"),fragmentShader:Ps("outline/outline.frag")})},Os=t=>pi({SDF:t.sdf}),Fs={shaders:t=>({vertexShader:Os(t)+Ps("icon/icon.vert"),fragmentShader:Os(t)+Ps("icon/icon.frag")})},Ds=t=>pi({PATTERN:t.pattern,SDF:t.sdf}),js={shaders:t=>({vertexShader:Ds(t)+Ps("line/line.vert"),fragmentShader:Ds(t)+Ps("line/line.frag")})},Es={shaders:t=>({vertexShader:Ps("text/text.vert"),fragmentShader:Ps("text/text.frag")})};class Ls{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach((t=>t.dispose())),this._programByKey.clear()}getMaterialProgram(t,e,i){const s=e.key<<3|this._getMaterialOptionsValue(e.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const n=this._getProgramTemplate(e.type),{shaders:r}=n,{vertexShader:o,fragmentShader:a}=r(i),l=e.getShaderHeader(),h=e.getShaderMain(),c=o.replace("#pragma header",l).replace("#pragma main",h),u=t.programCache.acquire(c,a,e.getAttributeLocations());return this._programByKey.set(s,u),u}_getMaterialOptionsValue(t,e){switch(t){case ui.BACKGROUND:return(e.pattern?1:0)<<1;case ui.FILL:return(e.pattern?1:0)<<1;case ui.OUTLINE:return 0;case ui.LINE:{const t=e;return(t.sdf?1:0)<<2|(t.pattern?1:0)<<1}case ui.ICON:return(e.sdf?1:0)<<1;case ui.CIRCLE:case ui.TEXT:default:return 0}}_getProgramTemplate(t){switch(t){case ui.BACKGROUND:return ks;case ui.CIRCLE:return Ts;case ui.FILL:return Is;case ui.ICON:return Fs;case ui.LINE:return js;case ui.OUTLINE:return As;case ui.TEXT:return Es;default:return null}}}class Ns{constructor(){this._initialized=!1}dispose(){this._program=B(this._program),this._vertexArrayObject=B(this._vertexArrayObject)}render(t,e,i,s){t&&(this._initialized||this._initialize(t),t.setBlendFunctionSeparate(H.ONE,H.ONE_MINUS_SRC_ALPHA,H.ONE,H.ONE_MINUS_SRC_ALPHA),t.bindVAO(this._vertexArrayObject),t.useProgram(this._program),e.setSamplingMode(i),t.bindTexture(e,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),t.drawArrays(Y.TRIANGLE_STRIP,0,4),t.bindTexture(null,0),t.bindVAO())}_initialize(t){if(this._initialized)return!0;const e=di(t,mi);if(!e)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const s=mi.attributes,n=new Si(t,s,oi,new Map([["geometry",Ci.createVertex(t,q.STATIC_DRAW,i)]]));return this._program=e,this._vertexArrayObject=n,this._initialized=!0,!0}}class Us{constructor(t){this._rctx=t,this._programByKey=new Map}dispose(){this._programByKey.forEach((t=>t.dispose())),this._programByKey.clear()}getProgram(t,e=[]){const i=t.vsPath+"."+t.fsPath+JSON.stringify(e);if(this._programByKey.has(i))return this._programByKey.get(i);const s={...e.map((t=>"string"==typeof t?{name:t,value:!0}:t)).reduce(((t,e)=>({...t,[e.name]:e.value})),{})},{vsPath:n,fsPath:r,attributes:o}=t,a=Pi(n,r,o,s),l=this._rctx.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(i,l),l}}const Ws=512;class Vs{constructor(t){this._resourceManager=t,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(t){switch(t.type){case"dash":{const e=J(t.dashTemplate),[i,s,n]=Ri(e);return{size:[s,n],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[e,i,s,n]=Ti(this._canvas,t,Q);return{size:[i,s],image:new Uint32Array(e.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:n}}case"sdf":return Xs(t);case"CIMHatchFill":case"CIMVectorMarker":case"CIMPictureMarker":return this._rasterizeCIMJSONResource(t)}}_rasterizeCIMJSONResource(t){switch(t.type){case"CIMHatchFill":{const e=Be.fromCIMHatchFill(t,Q);return this._rasterizeCIMVectorMarker(e)}case"CIMPictureMarker":{const e=Be.fromCIMInsidePolygon(t);return this._rasterizeCIMVectorMarker(e)}case"CIMVectorMarker":{if("CIMMarkerPlacementInsidePolygon"===t.markerPlacement?.type){const e=Be.fromCIMInsidePolygon(t);return this._rasterizeCIMVectorMarker(e)}const e=ei(t);return e&&!t.avoidSDFRasterization?Xs(e):this._rasterizeCIMVectorMarker(t,!1,K)}}}_rasterizeCIMVectorMarker(t,e=!0,i){const s=e?He.fromExtent(t.frame):null,[n,r,o,a,l]=Be.rasterize(this._canvas,t,s,this._resourceManager,!0,i);return n?{size:[r,o],image:new Uint32Array(n.buffer),sdf:!1,simplePattern:!1,anchorX:a,anchorY:l}:null}rasterizeImageResource(t,e,i,s){this._canvas.width=t,this._canvas.height=e;const n=this._canvas.getContext("2d",{willReadFrequently:!0});i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${t}px`),i.setAttribute("height",`${e}px`),n.drawImage(i,0,0,t,e));const r=n.getImageData(0,0,t,e),o=new Uint8Array(r.data);if(s)for(const t of s)if(t&&t.oldColor&&4===t.oldColor.length&&t.newColor&&4===t.newColor.length){const[e,i,s,n]=t.oldColor,[r,a,l,h]=t.newColor;if(e===r&&i===a&&s===l&&n===h)continue;for(let t=0;t<o.length;t+=4)e===o[t]&&i===o[t+1]&&s===o[t+2]&&n===o[t+3]&&(o[t]=r,o[t+1]=a,o[t+2]=l,o[t+3]=h)}let a;for(let t=0;t<o.length;t+=4)a=o[t+3]/255,o[t]=o[t]*a,o[t+1]=o[t+1]*a,o[t+2]=o[t+2]*a;let l=o,h=t,c=e;const u=Ws;if(h>=u||c>=u){const i=h/c;i>1?(h=u,c=Math.round(u/i)):(c=u,h=Math.round(u*i)),l=new Uint8Array(4*h*c);const s=new Uint8ClampedArray(l.buffer);Z(o,t,e,s,h,c,!1)}return{size:[h,c],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}function Xs(t){if(!t)return null;const{data:e,width:i,height:s,sdfPaddingRatio:n,sdfDecodeCoeff:r}=ii(t);return e?{size:[i,s],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,sdfPaddingRatio:n,sdfDecodeCoeff:r,anchorX:0,anchorY:0}:null}class $s{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new Ii(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new Ii;let i=null,s=-1;for(let n=0;n<this._free.length;++n){const r=this._free[n];t<=r.width&&e<=r.height&&(null===i||r.y<=i.y&&r.x<=i.x)&&(i=r,s=n)}return null===i?new Ii:(this._free.splice(s,1),i.width<i.height?(i.width>t&&this._free.push(new Ii(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new Ii(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new Ii(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new Ii(i.x,i.y+e,t,i.height-e))),new Ii(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}const Gs=256,Bs=t=>Math.floor(t/256);function Hs(t){const e=new Set;for(const i of t)e.add(Bs(i));return e}function Ys(t,e,i){return t.has(e)||t.set(e,i().then((()=>{t.delete(e)})).catch((i=>{t.delete(e),st(i)}))),t.get(e)}const qs=t=>({rect:new Ii(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0});class Js{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=t,this.height=e,this._glyphSource=i,this._binPack=new $s(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const t=[117,149,181,207,207,181,149,117],e=[],i=[];for(let s=0;s<t.length;s++){const n=t[s];for(let t=0;t<11;t++){const r=s>=3&&s<5&&t>=3&&t<8?255:0;e.push(n),i.push(r)}}const s={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)},n={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)};this._recordGlyph(s),this._recordGlyph(n)}getTexture(t,e){if(!this._textures[e]){const i=new nt;i.pixelFormat=tt.ALPHA,i.wrapMode=et.CLAMP_TO_EDGE,i.width=this.width,i.height=this.height,this._textures[e]=new it(t,i,new Uint8Array(this.width*this.height))}return this._dirties[e]&&(this._textures[e].setData(this._glyphData[e]),this._dirties[e]=!1),this._textures[e]}async getGlyphItems(t,e,i){const s=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map((e=>this._getMosaicItem(s,t,e)))}bind(t,e,i,s){const n=this.getTexture(t,i);n.setSamplingMode(e),t.bindTexture(n,s)}preloadASCIIGlyphCache(t){const e=this._preloadCache[t];if(null!=e)return e;const i=this._glyphSource.preloadASCIIRange(t).then((()=>{const e=this._getGlyphCache(t);for(let i=0;i<256;i++)this._getMosaicItem(e,t,i)}));return this._preloadCache[t]=i,i}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,e,i){const s=Hs(e),n=[];s.forEach((e=>{n.push(this._fetchRange(t,e,i))})),await Promise.all(n)}async _fetchRange(t,e,i){if(e>Gs)return;const s=t+e;return Ys(this._rangePromises,s,(()=>this._glyphSource.getRange(t,e,i)))}_getMosaicItem(t,e,i){if(!t[i]){const s=this._glyphSource.getGlyph(e,i);if(!s?.metrics)return qs(i);const n=this._recordGlyph(s),r=this._currentPage,o=s.metrics;t[i]={rect:n,page:r,metrics:o,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(0===e.width)i=new Ii(0,0,0,0);else{const s=3,n=e.width+2*s,r=e.height+2*s;i=this._binPack.allocate(n,r),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new $s(this.width-4,this.height-4),i=this._binPack.allocate(n,r));const o=this._glyphData[this._currentPage],a=t.bitmap;let l,h;if(a)for(let t=0;t<r;t++){l=n*t,h=this.width*(i.y+t)+i.x;for(let t=0;t<n;t++)o[h+t]=a[l+t]}N("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),s=new ImageData(this.width,this.height),n=s.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let e=0;e<t.length;++e)n[4*e]=t[e],n[4*e+1]=0,n[4*e+2]=0,n[4*e+3]=255;i.putImageData(s,0,0),document.body.appendChild(e)}}class Ks{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const t=e.getMessage();let i,s,n,r,o,a,l;for(;t.next();)switch(t.tag()){case 1:i=t.getUInt32();break;case 2:s=t.getBytes();break;case 3:n=t.getUInt32();break;case 4:r=t.getUInt32();break;case 5:o=t.getSInt32();break;case 6:a=t.getSInt32();break;case 7:l=t.getUInt32();break;default:t.skip()}t.release(),i&&(this._metrics[i]={width:n,height:r,left:o,top:a,advance:l},this._bitmaps[i]=s);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class Qs{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class Zs{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const s=this._getFontStack(t);if(s.getRange(e))return Promise.resolve();const n=256*e,r=n+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",n+"-"+r);return rt(o,{responseType:"array-buffer",...i}).then((t=>{s.addRange(e,new Ks(new Ai(new Uint8Array(t.data),new DataView(t.data))))}))}async preloadASCIIRange(t){const e=this._getFontStack(t),i=0,s=255,n=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+s),r=await rt(n,{responseType:"array-buffer"}),o=new Ks(new Ai(new Uint8Array(r.data),new DataView(r.data)));for(let t=i;t<=s;t++)e.getRange(t)||e.addRange(t,o)}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const s=Math.floor(e/256),n=i.getRange(s);return n?{metrics:n.getMetrics(e),bitmap:n.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new Qs),e}}const tn=1e20;class en{constructor(t,e=2){this._textureSize=t,this._rasterizationScale=e,this._canvasSize=this._textureSize*this._rasterizationScale,this._svg=null;const{_canvasSize:i}=this,s=document.createElement("canvas");s.width=s.height=i,this._context=s.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(i*i),this._gridInner=new Float64Array(i*i),this._f=new Float64Array(i),this._d=new Float64Array(i),this._z=new Float64Array(i+1),this._v=new Int16Array(i)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg=Ye(this._svg)}draw(t,e,i){const{_canvasSize:s,_textureSize:n,_rasterizationScale:r}=this,o=n/4;this._initSVG();const a=this.createSVGString(t,e);return new Promise(((t,e)=>{const l=new Image;l.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(a),l.onload=()=>{l.onload=null,this._context.clearRect(0,0,s,s),this._context.drawImage(l,0,0,s,s);const e=this._context.getImageData(0,0,s,s),i=new Uint8Array(n*n*4);for(let t=0;t<s*s;t++){const i=e.data[4*t+3]/255;this._gridOuter[t]=1===i?0:0===i?tn:Math.max(0,.5-i)**2,this._gridInner[t]=1===i?tn:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,s,s),this._edt(this._gridInner,s,s);for(let t=0;t<n*n;t++){let e=0;for(let i=0;i<r;i++){const o=Math.floor(t/n)*r+i;for(let i=0;i<r;i++){const a=o*s+(t%n*r+i);e+=this._gridOuter[a]-this._gridInner[a]}}e/=r*r,e/=r;Oi(.5-e/(2*o),i,4*t)}t(i)};const h=i?.signal;h&&ot(h,(()=>e(at())))}))}_initSVG(){return this._svg||(this._svg=qe()),this._svg}createSVGString(t,e){const i=this._initSVG(),s=Je("path");s.setAttribute("d",t),i.appendChild(s);const n=s.getBBox(),r=n.width/n.height,o=this._canvasSize/2;let a,l,h;if(r>1){a=o/n.width;const t=o*(1/r);l=this._canvasSize/4,h=o-t/2}else{a=o/n.height;l=o-o*r/2,h=this._canvasSize/4}const c=-n.x*a+l,u=-n.y*a+h;s.setAttribute("style",`transform: matrix(${a}, 0, 0, ${a}, ${c}, ${u})`),s.setAttribute("stroke-width",""+.5/a);const f=`<svg style="fill:${e?"red":"none"}; stroke:${e?"none":"red"}" height="${this._canvasSize}" width="${this._canvasSize}" xmlns="http://www.w3.org/2000/svg">${i.innerHTML}</svg>`;return i.removeChild(s),f}_edt(t,e,i){const s=this._f,n=this._d,r=this._v,o=this._z;for(let a=0;a<e;a++){for(let n=0;n<i;n++)s[n]=t[n*e+a];this._edt1d(s,n,r,o,i);for(let s=0;s<i;s++)t[s*e+a]=n[s]}for(let a=0;a<i;a++){for(let i=0;i<e;i++)s[i]=t[a*e+i];this._edt1d(s,n,r,o,e);for(let i=0;i<e;i++)t[a*e+i]=Math.sqrt(n[i])}}_edt1d(t,e,i,s,n){i[0]=0,s[0]=-tn,s[1]=+tn;for(let e=1,r=0;e<n;e++){let n=(t[e]+e*e-(t[i[r]]+i[r]*i[r]))/(2*e-2*i[r]);for(;n<=s[r];)r--,n=(t[e]+e*e-(t[i[r]]+i[r]*i[r]))/(2*e-2*i[r]);r++,i[r]=e,s[r]=n,s[r+1]=+tn}for(let r=0,o=0;r<n;r++){for(;s[o+1]<r;)o++;e[r]=(r-i[o])*(r-i[o])+t[i[o]]}}}function sn(t){return t&&"static"===t.type}class nn{constructor(t,e,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,this._pageWidth=t,this._pageHeight=e,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new $s(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,s,n,r,o=1,a=.5,l=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let h,c,u;if(sn(i))[h,c,u]=this._allocateImage(e[0],e[1]);else{h=new Ii(0,0,e[0],e[1]),c=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:[e[0]+2*lt,e[1]+2*lt],dirty:!0,texture:t})}if(h.width<=0||h.height<=0)return null;const f={type:"sprite",rect:h,width:e[0],height:e[1],sdf:n,simplePattern:r,rasterizationScale:o,sdfPaddingRatio:a,sdfDecodeCoeff:l,page:c};return this._mosaicRects.set(t,f),sn(i)&&(N("esri-mosaic-debug")&&this._showDebugSprite(e,i.data),this._copy({rect:h,spriteSize:e,spriteData:i.data,page:c,pageSize:u,repeat:s,sdf:n})),f}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e?.rect;if(!i)return null;i.width=e.width,i.height=e.height;const s=e.width,n=e.height,r=lt,o=this._mosaicPages[e.page].size;return{size:[e.width,e.height],tl:[(i.x+r)/o[0],(i.y+r)/o[1]],br:[(i.x+r+s)/o[0],(i.y+r+n)/o[1]],page:e.page}}bind(t,e,i=0,s=0){const n=this._mosaicPages[i],r=n.mosaicsData;let o=n.texture;if(o||(o=on(t,n.size),n.texture=o),o.setSamplingMode(e),sn(r))t.bindTexture(o,s),n.dirty&&(o.setData(new Uint8Array(r.data.buffer)),o.generateMipmap(),N("esri-mosaic-debug")&&this._showDebugPage(i));else{r.data.loadFrame(o),t.bindTexture(o,s),o.generateMipmap()}n.dirty=!1}getTexture(t,e=0){const i=this._mosaicPages[e],s=i.mosaicsData;let n=i.texture;if(n||(n=on(t,i.size),i.texture=n),sn(s))i.dirty&&(n.setData(new Uint8Array(s.data.buffer)),n.generateMipmap(),N("esri-mosaic-debug")&&this._showDebugPage(e));else{s.data.loadFrame(n),n.generateMipmap()}return i.dirty=!1,n}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!sn(i)){i.data.destroy()}}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(t,e,i,s,n,r,o,a,l,h,c){let u=s*e+i,f=a*r+o;if(c){f-=r;for(let o=-1;o<=h;o++,u=((o+h)%h+s)*e+i,f+=r)for(let e=-1;e<=l;e++)n[f+e]=t[u+(e+l)%l]}else for(let i=0;i<h;i++){for(let e=0;e<l;e++)n[f+e]=t[u+e];u+=e,f+=r}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!sn(e.mosaicsData))throw new ht("mapview-invalid-resource","unsuitable data type!");const s=t.spriteData,n=i.data;nn._copyBits(s,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+lt,t.rect.y+lt,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*lt,e+=2*lt;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(ai(t)),s=2**Math.ceil(ai(e)),n=new Ii(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[n,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(t,e);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&sn(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new $s(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([t,e],i){const s=document.createElement("canvas");s.width=t,s.height=e,s.setAttribute("style",`position: absolute; top: ${4+204*rn++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const n=s.getContext("2d"),r=new ImageData(t,e);r.data.set(new Uint8Array(i.buffer)),n.putImageData(r,0,0),document.body.appendChild(s)}_showDebugPage(t){const e=this._mosaicPages[t],{size:[i,s],mosaicsData:n}=e;if(!sn(n))return;const r=`mosaicDebugPage${t}`,o=document.getElementById(r)??document.createElement("canvas");o.id=r,o.width=i,o.height=s,o.setAttribute("style",`position: absolute; top: ${4+204*t}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const a=o.getContext("2d"),l=new ImageData(i,s);l.data.set(new Uint8Array(n.data.buffer)),a.putImageData(l,0,0),document.body.appendChild(o)}}let rn=0;function on(t,e){const i=new nt;return i.width=e[0],i.height=e[1],i.wrapMode=et.CLAMP_TO_EDGE,new it(t,i,null)}class an{constructor(t,e,i,s){this._animation=t,this._frameData=null;const n=t=>{this._frameData=t,e.requestRender()};this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=Ei(this._animation,i,s,n)}destroy(){this._playHandle.remove()}loadFrame(t){const e=this._frameData;if(null==e)return;const i="width"in e?e.width:e.codedWidth,s="height"in e?e.height:e.codedHeight;t.updateData(0,lt,lt,i,s,e),this._frameData=null}}class ln{constructor(){this._entries=new cn,this._nodes=new Map,this._book=new un}add(t){let e=this._entries.get(t);if(!e){const i=this._book.add(t),s=new Object;e={location:i,references:0,handle:s};const n=this._entries.set(t,e);this._nodes.set(s,n)}return e.references++,e}remove(t){const e=this._nodes.get(t.handle);e&&e.payload&&(e.payload.references--,0===e.payload.references&&(this._book.remove(e.payload.location),this._entries.delete(e),this._nodes.delete(t.handle)))}getTexture(t,e){return this._book.getTexture(t,e)}destroy(){this._book.destroy()}}class hn{constructor(t,e){this.parent=t,this.key=e,this.payload=null,this._children=new Map}get(t){return this._children.get(t)}ensure(t){let e=this._children.get(t);return e||(e=new hn(this,t),this._children.set(t,e)),e}delete(t){this._children.delete(t)}}class cn{constructor(){this._root=new hn(null,NaN)}set(t,e){let i=this._root;for(const e of t)for(const t of e)i=i.ensure(t);return i.payload=e,i}delete(t){t.parent?.delete(t.key)}get(t){let e=this._root;for(const i of t)for(const t of i){const i=e.get(t);if(!i)return;e=i}return e.payload||void 0}}class un{constructor(){this._pages=[]}add(t){0===this._pages.length&&this._pages.push(new fn);let e=this._pages.length-1,i=this._pages[e].add(t);if(i||(this._pages.push(new fn),e=this._pages.length-1,i=this._pages[e].add(t)),!i)throw new Error("Data allocation failed.");return{...i,page:e}}remove(t){this._pages[t.page].remove(t)}getTexture(t,e){return this._pages[e].getTexture(t)}destroy(){}}class fn{constructor(){this._cursor={row:0,column:0},this._columns=1024,this._rows=1024,this._data=new Float32Array(this._columns*this._rows*4),this._texture=null,this._textureCursor={row:0,column:0}}add(t){if(t.length>this._columns)throw new Error(`The maximum allocation size is ${this._columns} texels.`);const e={...this._cursor};if(e.column+=t.length,e.column>=this._columns&&(e.column=t.length,e.row++),e.row>=this._rows)return null;this._cursor=e;const i={...this._cursor};i.column-=t.length;let s=4*(i.row*this._columns+i.column);for(let e=0;e<t.length;e++)this._data[s++]=t[e][0],this._data[s++]=t[e][1],this._data[s++]=t[e][2],this._data[s++]=t[e][3];return i}remove(t){}getTexture(t){if(!this._texture){const e=new nt(this._columns,this._rows);e.pixelFormat=tt.RGBA,e.dataType=ct.FLOAT,e.wrapMode=et.CLAMP_TO_EDGE,e.samplingMode=ut.NEAREST,e.hasMipmap=!1;const i=new ft(t,e);this._texture=new it(t,i)}if(this._cursor.row===this._textureCursor.row&&this._cursor.column===this._textureCursor.column)return this._texture;const e=this._textureCursor.row,i=this._cursor.row-e+1;return this._texture.updateData(0,0,e,this._columns,i,this._data,e),this._textureCursor.row=this._cursor.row,this._textureCursor.column=this._cursor.column,this._texture}destroy(){this._texture?.dispose()}}const dn="arial-unicode-ms-regular",pn=()=>n.getLogger("esri.views.2d.engine.webgl.TextureManager"),mn=(t,e,i)=>pn().error(new ht(t,e,i));class _n{static fromMosaic(t,e){return new _n(t,e.page,e.sdf)}constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}}class gn{constructor(t){this._requestRender=t,this._resourceManager=new ki,this._invalidFontsMap=new Map,this._sdfConverter=new en(dt),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new pt({concurrency:10,process:async(t,e)=>{mt(e);try{return await rt(t,{responseType:"image",signal:e})}catch(e){if(!_t(e))throw new ht("mapview-invalid-resource",`Could not fetch requested resource at ${t}`,e);throw e}}}),this.animationStore=new ln,this._spriteMosaic=new nn(2048,2048,500),this._glyphSource=new Zs(`${gt.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Js(1024,1024,this._glyphSource),this._rasterizer=new Vs(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy(),this.animationStore.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}async rasterizeItem(t,e){if(null==t)return mn("mapview-null-resource","Unable to rasterize null resource"),null;if("animation-info"===t.type){const{resource:e}=t,i=this.animationStore.add(e),{location:s}=i;return{rect:new Ii(s.column,s.row,e.length,1),page:s.page,type:"sprite",width:e.length,height:1,rasterizationScale:1,sdfPaddingRatio:.5,sdfDecodeCoeff:1,simplePattern:!1}}if("cim-rasterization-info"!==t.type)return mn("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:i}=t;if("text"===i.type){const t=await this._rasterizeText(i,e);for(const e of t.glyphs)this._setTextureBinding(vt.GLYPH,e);return t}const s=await this._rasterizeSprite(i,e);return s&&this._setTextureBinding(vt.SPRITE,s),s}getMosaicInfo(t,e,i=!1){const s=this._getTextureBindingInfo(t,e,i);return s?{size:s.size,texture:{texture:s.texture,unit:"sprite"===s.type?yt:wt}}:(mn("mapview-invalid-resource",`Unable to find resource for ${e}`),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(t,e,i){const s=this._bindingInfos[e-1],n=s.page,r=i?ut.LINEAR_MIPMAP_LINEAR:ut.LINEAR;switch(s.mosaicType){case vt.SPRITE:{const e=[this.sprites.getWidth(n),this.sprites.getHeight(n)],i=this._spriteMosaic.getTexture(t,n);return i.setSamplingMode(r),{type:"sprite",texture:i,size:e}}case vt.GLYPH:{const e=[this.glyphs.width,this.glyphs.height],i=this._glyphMosaic.getTexture(t,n);return this._glyphMosaic.bind(t,r,n,wt),i.setSamplingMode(r),{type:"glyph",texture:i,size:e}}default:return mn("mapview-texture-manager",`Cannot handle unknown type ${s.mosaicType}`),null}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const s=_n.fromMosaic(t,e),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(s)}e.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,e){const{font:i,textString:s}=t,n=Ee(i),r=this._invalidFontsMap.has(n),[o,a]=Ke(s),l=Fi(o);try{const t=r?dn:n;N("esri-2d-stabilize-glyphs")&&await this._glyphMosaic.preloadASCIIGlyphCache(t);return{type:"glyphs",glyphs:await this._glyphMosaic.getGlyphItems(t,l,e),isRightToLeft:a}}catch(t){mn("mapview-invalid-resource",`Couldn't find font ${n}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(n,!0);return{type:"glyphs",glyphs:await this._glyphMosaic.getGlyphItems(dn,l,e),isRightToLeft:a}}}_hashSpriteResource(t){switch(t.type){case"path":return`path:${t.path}.${t.asFill?1:0}`;case"CIMPictureMarker":return`${t.type}:${t.url}:${t.size}`;case"CIMPictureFill":return`${t.type}:${t.url}:${t.height}`;case"CIMPictureStroke":return`${t.type}:${t.url}:${t.width}`;case"dash":return`dash:${t.capStyle}.${J(t.dashTemplate).join("")}`;case"sdf":return`sdf:${JSON.stringify(t.geom)}.${t.asFill?1:0}`;case"fill-style":return`fill_style:${t.style}`;case"animated":return JSON.stringify(Di(t));case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(t)}}async _rasterizeSprite(t,e){if(!t)return null;const i=d(this._hashSpriteResource(t));if(this._spriteMosaic.has(i))return this._spriteMosaic.getSpriteItem(i);if("url"in t&&t.url||"CIMPictureFill"===t.type||"CIMPictureStroke"===t.type||"CIMPictureMarker"===t.type||"CIMVectorMarker"===t.type){const e=[];Be.fetchResources({type:"CIMPointSymbol",symbolLayers:[t]},this._resourceManager,e),e.length>0&&await Promise.all(e)}switch(t.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===t.markerPlacement?.type?this._rasterizeJSONResource(i,t):this._handleAsyncResource(i,t,e);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return this._handleAsyncResource(i,t,e);case"sdf":case"dash":case"fill-style":case"CIMVectorMarker":case"CIMHatchFill":return this._rasterizeJSONResource(i,t)}}_rasterizeJSONResource(t,e){const i=this._rasterizer.rasterizeJSONResource(e);if(i){const{size:s,image:n,sdf:r,simplePattern:o,rasterizationScale:a,sdfPaddingRatio:l,sdfDecodeCoeff:h}=i;return this._addItemToMosaic(t,s,{type:"static",data:n},vn(e),r,o,a,l,h)}return null}async _handleAsyncResource(t,e,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let s;return s="path"===e.type?this._handleSVG(e,t,i):this._handleImage(e,t,i),this._ongoingRasterizations.set(t,s),s.finally((()=>this._ongoingRasterizations.delete(t))),s}async _handleSVG(t,e,i){const s=[dt,dt],{asFill:n}=t,r=await this._sdfConverter.draw(t.path,n,i);return this._addItemToMosaic(e,s,{type:"static",data:new Uint32Array(r.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,e,i){const s=t.url,n=this.resourceManager.getResource(s);if(null==n)return null;const{width:r,height:o}=n;if(n instanceof HTMLImageElement){if("animated"===t.type)return mn("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const i="colorSubstitutions"in t?t.colorSubstitutions:void 0,{size:s,sdf:a,image:l}=this._rasterizer.rasterizeImageResource(r,o,n,i);return this._addItemToMosaic(e,s,{type:"static",data:l},vn(t),a,!1)}let a,l,h;"animated"===t.type?(a=!1,l={type:"CIMAnimatedSymbolProperties",playAnimation:t.playAnimation,reverseAnimation:t.reverseAnimation,randomizeStartTime:t.randomizeStartTime,randomizeStartSeed:t.randomizeStartSeed,startTimeOffset:t.startTimeOffset,duration:t.duration,repeatType:t.repeatType,repeatDelay:t.repeatDelay},h=t.startGroup||0):(a=vn(t),l={type:"CIMAnimatedSymbolProperties"},h=0);const c=new an(n,this._requestRender,l,h);return this._addItemToMosaic(e,[c.width,c.height],{type:"animated",data:c},a,!1,!1)}async _handleImage(t,e,i){const s=t.url;if(wn(s)||xn(s))return this._handleGIFOrPNG(t,e,i);if("animated"===t.type)return mn("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let n;const r=this.resourceManager.getResource(s);if(null!=r&&r instanceof HTMLImageElement)n=r;else{const{data:t}=await this._imageRequestQueue.push(s,{...i});n=t}if(ji(s))if("width"in t&&"height"in t)n.width=M(t.width),n.height=M(t.height);else if("cim"in t){const e=t;n.width=M(e.width??e.scaleX*e.size),n.height=M(e.size)}if(!n.width||!n.height)return null;const o=n.width,a=n.height,l="colorSubstitutions"in t?t.colorSubstitutions:void 0,{size:h,sdf:c,image:u}=this._rasterizer.rasterizeImageResource(o,a,n,l);return this._addItemToMosaic(e,h,{type:"static",data:u},vn(t),c,!1)}catch(t){if(!_t(t))throw new ht("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${t.message}`);throw t}}_addItemToMosaic(t,e,i,s,n,r,o,a,l){return this._spriteMosaic.addSpriteItem(t,e,i,s,n,r,o,a,l)}}function vn(t){switch(t.type){case"CIMVectorMarker":case"CIMPictureMarker":return Mn(t);default:return!0}}const yn=t=>null!=t&&t.startsWith("data:image/gif"),wn=t=>t&&(t.includes(".gif")||yn(t)),bn=t=>null!=t&&t.startsWith("data:image/png"),xn=t=>t&&(t.includes(".png")||bn(t)),Mn=t=>t&&"markerPlacement"in t&&t.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type;class Cn{constructor(t){this._queue=[],this._refreshable=t}destroy(){this._queue=[]}enqueueTextureUpdate(t,e){const i=bt(),s=t,n=Ct,r=Math.ceil(s.height/n);mt(e);for(let o=0;o<r;o++){const a=o*n,l=o===r-1,h=l?s.height-n*o:n;this._queue.push({type:"chunk",request:t,resolver:i,chunk:o,chunkOffset:a,destHeight:h,chunkIsLast:l,options:e})}return xt(e,(t=>i.reject(t))),i.promise}upload(){let t=0;for(;this._queue.length;){const e=performance.now(),i=this._queue.shift();if(i){if(null!=i.options.signal&&i.options.signal.aborted)continue;switch(i.type){case"chunk":this._uploadChunk(i);break;case"no-chunk":this._uploadNoChunk(i)}const s=performance.now()-e;if(t+=s,t+s>=Mt)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(t){const{request:e,resolver:i,chunkOffset:s,chunkIsLast:n,destHeight:r}=t,{data:o,texture:a,width:l}=e;null!=o&&(a.updateData(0,0,s,l,r,o,s),n&&i.resolve())}_uploadNoChunk(t){const{request:e,resolver:i}=t,{data:s,texture:n}=e;n.setData(s),i.resolve()}}const Sn=jt(-.5,-.5);class Pn{constructor(){this._centerNdc=St(),this._pxToNdc=St(),this._worldDimensionsPx=St(),this._mat3=Pt(),this._initialized=!1}dispose(){this._program=B(this._program),this._quad=B(this._quad)}render(t,e,i){const{context:s}=t,n=this._updateGeometry(t,i);if(null!=e){const{r:t,g:i,b:n,a:r}=e;s.setClearColor(r*t/255,r*i/255,r*n/255,r)}else s.setClearColor(0,0,0,0);if(s.setStencilFunction(zt.ALWAYS,0,255),s.setStencilWriteMask(255),!n)return s.setClearStencil(kt),void s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT);s.setClearStencil(Tt),s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(s),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setColorMask(!1,!1,!1,!1),s.setBlendingEnabled(!1),s.setStencilOp(Rt.KEEP,Rt.KEEP,Rt.REPLACE),s.setStencilFunction(zt.ALWAYS,kt,255),s.setStencilTestEnabled(!0),s.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.bind(),this._quad.draw(),this._quad.unbind()}_initialize(t){if(this._initialized)return;const e=di(t,_i);e&&(this._program=e,this._quad=new li(t,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(t,e){const{state:i,pixelRatio:s}=t,{size:n,rotation:r}=i,o=Math.round(n[0]*s),a=Math.round(n[1]*s);if(!i.spatialReference.isWrappable)return!1;const l=Et(r),h=Math.abs(Math.cos(l)),c=Math.abs(Math.sin(l)),u=Math.round(o*h+a*c),f=Math.round(s*i.worldScreenWidth);if(u<=f)return!1;const d=o*c+a*h,p=(e.left-e.right)*s/o,m=(e.bottom-e.top)*s/a;It(this._worldDimensionsPx,f,d,1),It(this._pxToNdc,2/o,-2/a,1),It(this._centerNdc,p,m,1);const _=this._mat3;return At(_,this._centerNdc),Ot(_,_,this._pxToNdc),0!==r&&Ft(_,_,l),Ot(_,_,this._worldDimensionsPx),Dt(_,_,Sn),!0}}class zn extends Ne{constructor(){super(...arguments),this.type=Ge.Blend,this._backBufferTexture=null,this.shaders={blend:new gi,opacity:new vi}}shutdown(){super.shutdown(),null!==this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null)}render(t,e){const{context:i,drawPhase:s,state:n,pixelRatio:r,inFadeTransition:o,painter:a}=t,{size:l}=n,h=i.getBoundFramebufferObject();let c,u;null!=h?(c=h.width,u=h.height):(c=Math.round(r*l[0]),u=Math.round(r*l[1]));const{blendMode:f}=e;if("normal"===f&&s!==Lt.LABEL){const t={shader:this.shaders.opacity,uniforms:{config:{layerTexture:{texture:e.colorTexture,unit:0},opacity:e.config.opacity}},defines:null,optionalAttributes:null,useComputeBuffer:!1};return a.setPipelineState(Ue),void a.submitDrawMesh(i,t,a.quadMesh)}const d=this._createOrResizeTexture(t,c,u);h.copyToTexture(0,0,c,u,0,0,d);const p={color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:H.ONE,dstRGB:H.ZERO,srcAlpha:H.ONE,dstAlpha:H.ZERO}},depth:!1,stencil:!1};a.setPipelineState(p);const m={backbufferTexture:{texture:d,unit:0},layerTexture:{texture:e.colorTexture,unit:1},inFadeOpacity:o?1:0,...e.config},_={shader:this.shaders.blend,uniforms:{config:m},defines:{blendMode:f},optionalAttributes:null,useComputeBuffer:!1};a.submitDrawMesh(i,_,a.quadMesh)}_createOrResizeTexture(t,e,i){const{context:s}=t;if(null!==this._backBufferTexture&&this._backBufferTexture.descriptor?.width===e&&this._backBufferTexture.descriptor?.height===i)return this._backBufferTexture;if(null===this._backBufferTexture){const t=new nt;t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,t.width=e,t.height=i,this._backBufferTexture=new it(s,t)}else this._backBufferTexture.resize(e,i);return this._backBufferTexture}}class kn{constructor(){this._blendTechnique=new zn}dispose(t){this._blendTechnique?.shutdown()}draw(t,e,i,s,n){const{drawPhase:r}=t;r!==Lt.LABEL&&r!==Lt.LABEL_ALPHA&&this._blendTechnique.render(t,{colorTexture:e,config:{opacity:n,samplingMode:i},blendMode:s})}}class Tn{constructor(){this.name=this.constructor.name}createOptions(t,e){return null}}class Rn extends Tn{constructor(t){super(),this.name=this.constructor.name,this.defines=[t]}dispose(){}bind({context:t,painter:e}){this._prev=t.getBoundFramebufferObject();const i=e.getFbos().effect0;t.bindFramebuffer(i),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}draw(t,e){const{context:i,painter:s}=t,n=s.getPostProcessingEffects(e),r=i.getBoundFramebufferObject();for(const{postProcessingEffect:e,effect:i}of n)e.draw(t,r,i);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,r.colorTexture,ut.NEAREST),i.setStencilTestEnabled(!0)}}class In{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(t,e){t.bindTexture(e,Nt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ut),t.bindVAO(this._resources.quadVAO),t.drawArrays(Y.TRIANGLE_STRIP,0,4),t.bindVAO()}finalBlur(t,e){t.bindTexture(e,Nt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Wt),t.bindVAO(this._resources.quadVAO),t.drawArrays(Y.TRIANGLE_STRIP,0,4),t.bindVAO()}renderHighlight(t,e,i){t.bindTexture(e,Nt),t.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(t,this._resources.highlightProgram),t.bindVAO(this._resources.quadVAO),t.setBlendingEnabled(!0),t.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),t.drawArrays(Y.TRIANGLE_STRIP,0,4),t.bindVAO()}_initialize(t,e,i){this._width=e,this._height=i;const s=Ci.createVertex(t,q.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new Si(t,new Map([["a_position",0],["a_texcoord",1]]),new Map([["geometry",[new Li("a_position",2,$t.BYTE,0,4),new Li("a_texcoord",2,$t.UNSIGNED_BYTE,2,4)]]]),new Map([["geometry",s]])),r=di(t,yi),o=di(t,wi);t.useProgram(r),r.setUniform1i("u_texture",Nt),r.setUniform1i("u_shade",Vt),r.setUniform1f("u_sigma",Xt),t.useProgram(o),o.setUniform1i("u_texture",Nt),o.setUniform1f("u_sigma",Xt),this._resources={quadGeometry:s,quadVAO:n,highlightProgram:r,blurProgram:o}}setup(t,e,i){this._resources?(this._width=e,this._height=i):this._initialize(t,e,i)}}function An(t,e,i){const s=new nt(e,i);return s.wrapMode=et.CLAMP_TO_EDGE,new Ni(t,s,new Ui(Gt.STENCIL_INDEX8,e,i))}class On{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(t,e,i){this._width=e,this._height=i;const s=An(t,e,i),n=An(t,e,i);this._resources={sharedBlur1Fbo:s,sharedBlur2Fbo:n}}setup(t,e,i){!this._resources||this._width===e&&this._height===i||this.dispose(),this._resources||this._initialize(t,e,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}const Fn=4,Dn=4/Fn;class jn extends Tn{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new In,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new On,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new Ns}dispose(){this._hlSurfaces?.dispose(),this._hlRenderer?.dispose(),this._boundFBO=null}bind(t){const{context:e,painter:i}=t,{width:s,height:n}=e.getViewport(),r=i.getFbos().effect0;this.setup(t,s,n),e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:t},e,i){this._width=e,this._height=i;const s=e%Fn,n=i%Fn;e+=s<Fn/2?-s:Fn-s,i+=n<Fn/2?-n:Fn-n,this._adjustedWidth=e,this._adjustedHeight=i,this._boundFBO=t.getBoundFramebufferObject();const r=Math.round(e*Dn),o=Math.round(i*Dn);this._hlRenderer.setup(t,r,o),this._hlSurfaces.setup(t,r,o)}draw(t){const{context:e,passOptions:i}=t,s=i.activeGradient,n=e.getBoundFramebufferObject();e.setViewport(0,0,this._adjustedWidth*Dn,this._adjustedHeight*Dn),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,n.colorTexture,ut.NEAREST,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,s),this._boundFBO=null}}class En extends Tn{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:t},e){if(!e.length)return null;const i=e.shift(),s=i.x,n=i.y;this._outstanding=i;const r=N("esri-mobile");return{type:"hittest",distance:(r?Bt:Ht)*t,smallSymbolDistance:(r?Bt:Yt)*t,smallSymbolSizeThreshold:qt,position:[s,n]}}bind(t){const{context:e,attributeView:i}=t;if(!i.size)return;const s=i.getBlock(Jt.GPGPU);if(null==s)return;const n=s.getFBO(e);e.setViewport(0,0,i.size,i.size),e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,e){const{context:i,attributeView:s}=t,n=s.getBlock(Jt.GPGPU);if(null==n)return void e.forEach((t=>t.resolve([])));const r=n.getFBO(i),o=new Uint8Array(r.width*r.height*4);try{await r.readPixelsAsync(0,0,r.width,r.height,tt.RGBA,ct.UNSIGNED_BYTE,o)}catch(t){return void e.forEach((t=>t.resolve([])))}const a=[];for(let t=0;t<o.length;t+=4){const e=t/4;o[t]&&a.push(e)}e.forEach((t=>t.resolve(a)))}}const Ln=5,Nn=[1,0],Un=[0,1],Wn=[1,.8,.6,.4,.2],Vn=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class Xn{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(Ln),this._nMips=Ln,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=B(this._quad),this._intensityFBO=B(this._intensityFBO),this._compositeFBO=B(this._compositeFBO),this._mipsFBOs){for(let t=0;t<this._nMips;t++)this._mipsFBOs[t]&&(this._mipsFBOs[t].horizontal.dispose(),this._mipsFBOs[t].vertical.dispose());this._mipsFBOs=null}}draw(t,e,i){const{width:s,height:n}=e,{context:r,painter:o}=t,{materialManager:a}=o,l=r.gl,h=this._programDesc,{strength:c,radius:u,threshold:f}=i;this._quad||(this._quad=new li(r,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(t,s,n),r.setStencilTestEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),r.setStencilWriteMask(0);const d=this._quad;d.bind(),r.bindFramebuffer(this._intensityFBO);const p=a.getProgram(h.luminosityHighPass);r.useProgram(p),r.bindTexture(e.colorTexture,0),p.setUniform1i("u_texture",0),p.setUniform3fv("u_defaultColor",[0,0,0]),p.setUniform1f("u_defaultOpacity",0),p.setUniform1f("u_luminosityThreshold",f),p.setUniform1f("u_smoothWidth",.01);const m=[Math.round(s/2),Math.round(n/2)];r.setViewport(0,0,m[0],m[1]),r.setClearColor(0,0,0,0),r.clear(l.COLOR_BUFFER_BIT),d.draw(),r.setBlendingEnabled(!1);let _=this._intensityFBO.colorTexture;for(let t=0;t<this._nMips;t++){const e=a.getProgram(h.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[t]}]);r.useProgram(e),r.bindTexture(_,t+1),e.setUniform1i("u_colorTexture",t+1),e.setUniform2fv("u_texSize",m),e.setUniform2fv("u_direction",Nn),r.setViewport(0,0,m[0],m[1]);const i=this._mipsFBOs[t];r.bindFramebuffer(i.horizontal),d.draw(),_=i.horizontal.colorTexture,r.bindFramebuffer(i.vertical),r.bindTexture(_,t+1),e.setUniform2fv("u_direction",Un),d.draw(),_=i.vertical.colorTexture,m[0]=Math.round(m[0]/2),m[1]=Math.round(m[1]/2)}r.setViewport(0,0,s,n);const g=a.getProgram(h.composite,[{name:"nummips",value:Ln}]);r.bindFramebuffer(this._compositeFBO),r.useProgram(g),g.setUniform1f("u_bloomStrength",c),g.setUniform1f("u_bloomRadius",u),g.setUniform1fv("u_bloomFactors",Wn),g.setUniform3fv("u_bloomTintColors",Vn),r.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),g.setUniform1i("u_blurTexture1",1),r.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),g.setUniform1i("u_blurTexture2",2),r.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),g.setUniform1i("u_blurTexture3",3),r.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),g.setUniform1i("u_blurTexture4",4),r.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),g.setUniform1i("u_blurTexture5",5),d.draw(),r.bindFramebuffer(e),r.setBlendingEnabled(!0);const v=a.getProgram(h.blit);r.useProgram(v),r.bindTexture(this._compositeFBO.colorTexture,6),v.setUniform1i("u_texture",6),r.setBlendFunction(H.ONE,H.ONE),d.draw(),d.unbind(),r.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0)}_createOrResizeResources(t,e,i){const{context:s}=t;if(this._compositeFBO&&this._size[0]===e&&this._size[1]===i)return;this._size[0]=e,this._size[1]=i;const n=[Math.round(e/2),Math.round(i/2)];if(this._compositeFBO)this._compositeFBO.resize(e,i);else{const t=new nt(e,i);t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,this._compositeFBO=new Ni(s,t)}if(this._intensityFBO)this._intensityFBO.resize(n[0],n[1]);else{const t=new nt(n[0],n[1]);t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,this._intensityFBO=new Ni(s,t)}for(let t=0;t<this._nMips;t++){if(this._mipsFBOs[t])this._mipsFBOs[t].horizontal.resize(n[0],n[1]),this._mipsFBOs[t].vertical.resize(n[0],n[1]);else{const e=new nt(n[0],n[1]);e.internalFormat=tt.RGBA,e.wrapMode=et.CLAMP_TO_EDGE,this._mipsFBOs[t]={horizontal:new Ni(s,e),vertical:new Ni(s,e)}}n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}const $n=[1,0],Gn=[0,1];class Bn{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(t,e,i){const{context:s}=t,{type:n,radius:r}=i;if(0===r)return;this._createOrResizeResources(t),this._quad||(this._quad=new li(s,[-1,-1,1,-1,-1,1,1,1]));const o=this._quad;o.bind(),"blur"===n?this._gaussianBlur(t,e,r):this._radialBlur(t,e),o.unbind()}_gaussianBlur(t,e,i){const{context:s,state:n,painter:r,pixelRatio:o}=t,{size:a}=n,{materialManager:l}=r,h=this._programDesc,c=this._quad,u=[Math.round(o*a[0]),Math.round(o*a[1])],f=this._blurFBO,d=l.getProgram(h.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(d),s.setBlendingEnabled(!1),s.bindFramebuffer(f),s.bindTexture(e.colorTexture,4),d.setUniform1i("u_colorTexture",4),d.setUniform2fv("u_texSize",u),d.setUniform2fv("u_direction",$n),d.setUniform1f("u_sigma",i),c.draw(),s.bindFramebuffer(e),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(f?.colorTexture,5),d.setUniform1i("u_colorTexture",5),d.setUniform2fv("u_direction",Gn),c.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}_radialBlur(t,e){const{context:i,painter:s}=t,{materialManager:n}=s,r=this._programDesc,o=this._quad,a=this._blurFBO;i.bindFramebuffer(a);const l=n.getProgram(r.radialBlur);i.useProgram(l),i.setBlendingEnabled(!1),i.bindTexture(e.colorTexture,4),l.setUniform1i("u_colorTexture",4),o.draw(),i.bindFramebuffer(e),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const h=n.getProgram(r.blit);i.useProgram(h),i.bindTexture(a?.colorTexture,5),h.setUniform1i("u_texture",5),i.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),o.draw()}_createOrResizeResources(t){const{context:e,state:i,pixelRatio:s}=t,{size:n}=i,r=Math.round(s*n[0]),o=Math.round(s*n[1]);if(!this._blurFBO||this._size[0]!==r||this._size[1]!==o)if(this._size[0]=r,this._size[1]=o,this._blurFBO)this._blurFBO.resize(r,o);else{const t=new nt(r,o);t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,this._blurFBO=new Ni(e,t)}}}class Hn{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=B(this._layerFBOTexture)}draw(t,e,i){const{width:s,height:n}=e;this._createOrResizeResources(t,s,n);const{context:r,painter:o}=t,{materialManager:a}=o,l=this._programDesc,h=this._quad,c=i.colorMatrix;h.bind();const u=this._layerFBOTexture;r.bindFramebuffer(e),e.copyToTexture(0,0,s,n,0,0,u),r.setBlendingEnabled(!1),r.setStencilTestEnabled(!1);const f=a.getProgram(l);r.useProgram(f),r.bindTexture(u,2),f.setUniformMatrix4fv("u_coefficients",c),f.setUniform1i("u_colorTexture",2),h.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0),h.unbind()}_createOrResizeResources(t,e,i){const{context:s}=t;if(!this._layerFBOTexture||this._size[0]!==e||this._size[1]!==i){if(this._size[0]=e,this._size[1]=i,this._layerFBOTexture)this._layerFBOTexture.resize(e,i);else{const t=new nt;t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,t.width=e,t.height=i,this._layerFBOTexture=new it(s,t)}this._quad||(this._quad=new li(s,[-1,-1,1,-1,-1,1,1,1]))}}}const Yn=[1,0],qn=[0,1];class Jn{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=B(this._layerFBOTexture),this._horizontalBlurFBO=B(this._horizontalBlurFBO),this._verticalBlurFBO=B(this._verticalBlurFBO)}draw(t,e,i){const{context:s,state:n,painter:r}=t,{materialManager:o}=r,a=this._programDesc,l=e.width,h=e.height,c=[Math.round(l),Math.round(h)],{blurRadius:u,offsetX:f,offsetY:d,color:p}=i,m=[M(f),M(d)];this._createOrResizeResources(t,l,h,c);const _=this._horizontalBlurFBO,g=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const v=this._layerFBOTexture;e.copyToTexture(0,0,l,h,0,0,v),this._quad||(this._quad=new li(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,c[0],c[1]);const y=this._quad;y.bind(),s.setBlendingEnabled(!1);const w=o.getProgram(a.blur,[{name:"radius",value:Math.ceil(u)}]);s.useProgram(w),s.bindFramebuffer(_),s.bindTexture(e.colorTexture,4),w.setUniform1i("u_colorTexture",4),w.setUniform2fv("u_texSize",c),w.setUniform2fv("u_direction",Yn),w.setUniform1f("u_sigma",u),y.draw(),s.bindFramebuffer(g),s.bindTexture(_?.colorTexture,5),w.setUniform1i("u_colorTexture",5),w.setUniform2fv("u_direction",qn),y.draw(),s.bindFramebuffer(e),s.setViewport(0,0,l,h);const b=o.getProgram(a.composite);s.useProgram(b),s.bindTexture(g?.colorTexture,2),b.setUniform1i("u_blurTexture",2),s.bindTexture(v,3),b.setUniform1i("u_layerFBOTexture",3),b.setUniform4fv("u_shadowColor",[p[3]*(p[0]/255),p[3]*(p[1]/255),p[3]*(p[2]/255),p[3]]),b.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),b.setUniform2fv("u_shadowOffset",m),y.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(H.ONE,H.ONE_MINUS_SRC_ALPHA),y.unbind()}_createOrResizeResources(t,e,i,s){const{context:n}=t;if(!this._horizontalBlurFBO||this._size[0]!==e||this._size[1]!==i){if(this._size[0]=e,this._size[1]=i,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(s[0],s[1]);else{const t=new nt(s[0],s[1]);t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,this._horizontalBlurFBO=new Ni(n,t)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(s[0],s[1]);else{const t=new nt(s[0],s[1]);t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,this._verticalBlurFBO=new Ni(n,t)}if(this._layerFBOTexture)this._layerFBOTexture.resize(e,i);else{const t=new nt;t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,t.width=e,t.height=i,this._layerFBOTexture=new it(n,t)}}}}class Kn{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=B(this._layerFBOTexture)}draw(t,e,i){const{width:s,height:n}=e;this._createOrResizeResources(t,s,n);const{context:r,painter:o}=t,{amount:a}=i,l=r.gl,h=this._layerFBOTexture;r.bindFramebuffer(e),e.copyToTexture(0,0,s,n,0,0,h),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!1),r.setDepthTestEnabled(!1),r.setClearColor(0,0,0,0),r.clear(l.COLOR_BUFFER_BIT),o.blitTexture(r,h,ut.NEAREST,a)}_createOrResizeResources(t,e,i){const{context:s}=t;if(!this._layerFBOTexture||this._size[0]!==e||this._size[1]!==i)if(this._size[0]=e,this._size[1]=i,this._layerFBOTexture)this._layerFBOTexture.resize(e,i);else{const t=new nt;t.internalFormat=tt.RGBA,t.wrapMode=et.CLAMP_TO_EDGE,t.samplingMode=ut.NEAREST,t.width=e,t.height=i,this._layerFBOTexture=new it(s,t)}}}function Qn(t){switch(t){case"bloom":case"blur":case"opacity":case"drop-shadow":return t;default:return"colorize"}}const Zn={colorize:()=>new Hn,blur:()=>new Bn,bloom:()=>new Xn,opacity:()=>new Kn,"drop-shadow":()=>new Jn};class tr{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach((t=>t.dispose())),this._effectMap.clear()}getPostProcessingEffects(t){if(!t||0===t.length)return[];const e=[];for(const i of t){const t=Qn(i.type);let s=this._effectMap.get(t);s||(s=Zn[t](),this._effectMap.set(t,s)),e.push({postProcessingEffect:s,effect:i})}return e}}class er{constructor(t,e){this.brushes=t,this.name=e.name,this.drawPhase=e.drawPhase||Lt.MAP,this._targetFn=e.target,this.effects=e.effects||[],this.enableDefaultDraw=e.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!e.forceDrawByDisplayOrder}render(t){const{context:e,profiler:i}=t,s=this._targetFn(),n=this.drawPhase&t.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(t,s),i.recordPassEnd();for(const i of this.effects){if(!i.enable())continue;const n=i.apply,r=i.args?.(),o=e.getViewport(),a=e.getBoundFramebufferObject(),l=t.passOptions;this._bindEffect(t,n,r),this._doRender(t,s,n.defines),this._drawAndUnbindEffect(t,n,o,a,l,r)}}}_doRender(t,e,i){if(null==e)return;const{profiler:s,context:n}=t;for(const r of this.brushes){if(s.recordBrushStart(r.name),null!=r.brushEffect){const s=n.getViewport(),o=n.getBoundFramebufferObject(),a=t.passOptions;this._bindEffect(t,r.brushEffect),this._drawWithBrush(r,t,e,i),this._drawAndUnbindEffect(t,r.brushEffect,s,o,a)}else this._drawWithBrush(r,t,e,i);s.recordBrushEnd()}}_drawWithBrush(t,e,i,s){Kt(i)?(t.prepareState(e,s),t.drawMany(e,i,s)):i.visible&&(t.prepareState(e,s),t.draw(e,i,s))}_bindEffect(t,e,i){const{profiler:s}=t;s.recordPassStart(this.name+"."+e.name),e.bind(t,i);const n=e.createOptions(t,i);t.passOptions=n}_drawAndUnbindEffect(t,e,i,s,n,r){const{profiler:o,context:a}=t;t.passOptions=n,o.recordBrushStart(e.name),e.draw(t,r),e.unbind(t,r),a.bindFramebuffer(s);const{x:l,y:h,width:c,height:u}=i;a.setViewport(l,h,c,u),o.recordBrushEnd(),o.recordPassEnd()}}class ir{constructor(){this._programCache=new Map}destroy(){for(const t of this._programCache.values())t.destroy();this._programCache.clear()}getProgram(t,e,i,s,n){const r=t.getShaderKey(e,i,s,n);let o=this._programCache.get(r);return o||(o=t.getProgram(e,i,s,n),this._programCache.set(r,o)),o}}class sr{constructor(t,e){this.context=t,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new Ns,this._worldExtentRenderer=new Pn,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new Ls,this._blendEffect=new kn,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new jn,hittest:new En,insideEffect:new Rn("inside"),outsideEffect:new Rn("outside")},this._programCache=new ir,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new Us(t),this.textureManager=new gn(e),this.textureUploadManager=new Cn(e),this._effectsManager=new tr,this._quadMesh=We.fromVertexStream(t,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=B(this._blitRenderer),this._worldExtentRenderer=B(this._worldExtentRenderer),this._quadMesh=Qt(this._quadMesh),this._brushCache&&(this._brushCache.forEach((t=>t.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos){let t;for(t in this._fbos)this._fbos[t]&&this._fbos[t].dispose()}for(const t of this._fboPool)t.dispose();if(this._fboPool.length=0,this.effects){let t;for(t in this.effects)this.effects[t]&&this.effects[t].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=B(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new ir}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}get quadMesh(){return this._quadMesh}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(t,e){let i;if(this._fboPool.length>0)i=this._fboPool.pop();else{const s=new nt(t,e);s.samplingMode=ut.NEAREST,s.wrapMode=et.CLAMP_TO_EDGE,i=new Ni(this.context,s,this._stencilBuf)}return i.width===t&&i.height===e||i.resize(t,e),i}releaseFbo(t){this._fboPool.push(t)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(t,e,i){const{context:s}=t;this._worldExtentRenderer.render(t,e,i);const{width:n,height:r}=s.getViewport();if(this.updateFBOs(n,r),this._prevFBO=s.getBoundFramebufferObject(),s.bindFramebuffer(this.getFbos().output),s.setColorMask(!0,!0,!0,!0),null!=e){const{r:t,g:i,b:n,a:r}=e;s.setClearColor(r*t/255,r*i/255,r*n/255,r)}else s.setClearColor(0,0,0,0);s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}afterRenderPhases(t){const{context:e}=t;e.bindFramebuffer(this._prevFBO),e.setStencilFunction(zt.EQUAL,kt,255),e.setStencilTestEnabled(!0),e.setDepthTestEnabled(!1),this.blitTexture(e,this.getFbos().output.colorTexture,ut.NEAREST)}beforeRenderLayer(t,e,i){const{context:s,blendMode:n,effects:r,drawPhase:o,requireFBO:a}=t;if(a||nr(o,n,r,i)){const t=s.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(t);const{width:e,height:i}=s.getViewport(),n=this.acquireFbo(e,i);s.bindFramebuffer(n),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(e),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(t,e){const{context:i,blendMode:s,effects:n,requireFBO:r,drawPhase:o}=t;if(r||nr(o,s,n,e)){const r=i.getBoundFramebufferObject();null!=n&&n.length>0&&o===Lt.MAP&&(i.setColorMask(!0,!0,!0,!0),this._applyEffects(t,n,r)),i.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(H.ONE,H.ONE_MINUS_SRC_ALPHA,H.ONE,H.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);const a=null==s||o===Lt.HIGHLIGHT?"normal":s;this._blendEffect.draw(t,r.colorTexture,ut.NEAREST,a,e),this.releaseFbo(r)}}renderObject(t,e,i,s){const n=hi[i];if(!n)return;let r=this._brushCache.get(n);void 0===r&&(r=new n,this._brushCache.set(n,r)),r.prepareState(t),r.draw(t,e,s)}renderObjects(t,e,i,s){const n=hi[i];if(!n)return;let r=this._brushCache.get(n);void 0===r&&(r=new n,this._brushCache.set(n,r)),r.drawMany(t,e,s)}registerRenderPass(t){const e=t.brushes.map((t=>(this._brushCache.has(t)||this._brushCache.set(t,new t),this._brushCache.get(t))));return new er(e,t)}blitTexture(t,e,i,s=1){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(H.ONE,H.ONE_MINUS_SRC_ALPHA,H.ONE,H.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(t,e,i,s),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(t){return this._effectsManager.getPostProcessingEffects(t)}updateFBOs(t,e){if(t!==this._lastWidth||e!==this._lastHeight){if(this._lastWidth=t,this._lastHeight=e,this._fbos){let i;for(i in this._fbos)this._fbos[i].resize(t,e);return}const i=new nt(t,e);i.samplingMode=ut.NEAREST,i.wrapMode=et.CLAMP_TO_EDGE;const s=new Ui(Gt.DEPTH_STENCIL,t,e);this._stencilBuf=new Wi(this.context,s),this._fbos={output:new Ni(this.context,i,this._stencilBuf),effect0:new Ni(this.context,i,this._stencilBuf)}}}_applyEffects(t,e,i){const{context:s}=t,n=this._effectsManager.getPostProcessingEffects(e);for(const{postProcessingEffect:e,effect:r}of n)s.bindFramebuffer(i),e.draw(t,i,r);this._currentPipelineStateNeedsUpdate=!0}setShader(t){this._shaderState.shader=t.shader,this._shaderState.uniforms=t.uniforms,this._shaderState.defines=t.defines,this._shaderState.optionalAttributes=t.optionalAttributes,this._shaderState.useComputeBuffer=t.useComputeBuffer??!1}setPipelineState(t){t!==this._currentPipelineState&&(this._currentPipelineState=t,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(t,e){const{shader:i,uniforms:s,defines:n,optionalAttributes:r}=this._shaderState,o=t.context,a=e.getAttributePrecisionPackFactors(),l=this._programCache.getProgram(i,a,s,n??{},r??{});return l.setUniforms(s),l.bind(o),this.updatePipelineState(o),this.setStencilRef(o,e),e.draw(t,i.locationInfo),l.cleanupTemporaryTextures(),{vertexShader:l.vertexShader,fragmentShader:l.fragmentShader}}submitDrawMesh(t,e,i,s){this.submitDrawMeshUntyped(t,e,i,s)}submitDrawMeshUntyped(t,e,i,s){this.setShader(e);const{shader:n,uniforms:r,defines:o,optionalAttributes:a}=this._shaderState,l=this._programCache.getProgram(n,{},r,o??{},a??{});if(l.setUniforms(r),l.bind(t),this.updatePipelineState(t),s)for(const e of s)i.bind(t,e),i.draw(t);else for(let e=0;e<i.parts.length;e++)i.bind(t,e),i.draw(t);i.unbind(t),l.cleanupTemporaryTextures()}updatePipelineState(t){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(t))}_updatePipelineState(t){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:e,depth:i,stencil:s}=this._currentPipelineState;if(e){const{blendMode:i,write:s}=e;switch(t.setColorMask(...s),t.setBlendingEnabled(!0),t.setBlendEquation(Zt.ADD),i){case"composite":t.setBlendFunctionSeparate(H.ONE,H.ONE_MINUS_SRC_ALPHA,H.ONE,H.ONE_MINUS_SRC_ALPHA);break;case"additive":t.setBlendFunctionSeparate(H.ONE,H.ONE,H.ONE,H.ONE);break;case"custom":{const{blendParameters:i}=e,{dstAlpha:s,dstRGB:n,srcAlpha:r,srcRGB:o}=i;t.setBlendFunctionSeparate(o,n,r,s);break}case"delete":t.setBlendEquation(Zt.REVERSE_SUBTRACT),t.setBlendFunctionSeparate(H.ONE,H.ONE_MINUS_SRC_ALPHA,H.ONE,H.ONE_MINUS_SRC_ALPHA)}}if(i){const{test:e,write:s}=i;s?(t.setDepthWriteEnabled(!0),t.setDepthRange(s.zNear,s.zFar)):t.setDepthWriteEnabled(!1),e?(t.setDepthTestEnabled(!0),t.setDepthFunction(e)):t.setDepthTestEnabled(!1)}else t.setDepthTestEnabled(!1),t.setDepthWriteEnabled(!1);if(s){const{test:e,write:i}=s;if(e){const{compare:i,mask:s,op:n,ref:r}=e;t.setStencilTestEnabled(!0),"function"!=typeof r&&t.setStencilFunctionSeparate(te.FRONT_AND_BACK,i,r,s),t.setStencilOpSeparate(te.FRONT_AND_BACK,n.fail,n.zFail,n.zPass)}else t.setStencilTestEnabled(!1);if(i){const{mask:e}=i;t.setStencilWriteMask(e)}else t.setStencilWriteMask(0)}else t.setStencilTestEnabled(!1),t.setStencilWriteMask(0)}setStencilRef(t,e){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:i}=this._currentPipelineState;if(i){const{test:s}=i;if(s){const{compare:i,mask:n,ref:r}=s;if("function"==typeof r){const s=e.getStencilReference();if(null===s)throw new Error("InternalError: Stencil reference expected for target but not defined");t.setStencilFunctionSeparate(te.FRONT_AND_BACK,i,s,n)}}}}}function nr(t,e,i,s){return t!==Lt.LABEL_ALPHA&&t!==Lt.LABEL&&t!==Lt.HIGHLIGHT&&(1!==s||null!=e&&"normal"!==e||null!=i&&i.length>0)}class rr{constructor(){this._candidateTiles=[]}schedule(t){this._candidateTiles.includes(t)||this._candidateTiles.push(t)}reshuffle(t){const e=[];for(const i of this._candidateTiles)t>0?(i.reshuffle(),t--):e.push(i);this._candidateTiles=e}}const or=2e3;class ar extends ni{constructor(t,e){super(),this.meshWriterRegistry=new Vi,this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=ee(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new rr,this._canvas=new xs(t),this.context=new zi(this._canvas.gl,e.contextOptions??{}),this.painter=new sr(this.context,this),this._cimAnalyzer=new ms(this.painter.textureManager.resourceManager),N("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),t.appendChild(this._debugOutput));const i=()=>this.highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:e.timeline||new ie,renderingOptions:e.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new bi(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return i()},reshuffleManager:this._reshuffleManager,backgroundColor:e.backgroundColor},this._taskHandle=se({render:t=>this.renderFrame(t)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",(t=>this.emit("webgl-error",{error:new ht("webgl-context-lost",t.statusMessage)}))),this._bufferPool=new ci,Ve()}destroy(){Xe(this.context),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=ne(this._taskHandle),this._lostWebGLContextHandle=ne(this._lostWebGLContextHandle),this._canvas.destroy(),this._debugOutput?.parentNode?.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(t){this._renderParameters.backgroundColor=t,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(t){this._renderingOptions=t,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(t){this._state=t,this.requestRender()}get stationary(){return this._stationary}set stationary(t){this._stationary!==t&&(this._stationary=t,this.requestRender())}trashDisplayObject(t){this._trash.add(t),this.requestRender()}untrashDisplayObject(t){return this._trash.delete(t)}requestRender(){this._renderRemainingTime=or,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(t){const e=this._lastFrameRenderTime?t.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=e,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=t.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=t.time,this._renderParameters.deltaTime=t.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:Pt()}}renderChildren(t){for(const e of this.children)e.beforeRender(t);this._reshuffleManager.reshuffle(re),this._canvas.render(t,(()=>this._renderChildren(this.children,t)));for(const e of this.children)e.afterRender(t)}_renderChildren(t,e){const i=this.context;this.painter.textureUploadManager.upload(),i.resetInfo(),e.profiler.recordStart("drawLayers"),e.dataUploadCounter=0,this.painter.beforeRenderPhases(e,e.backgroundColor,this.state.padding),e.drawPhase=Lt.MAP;for(const i of t)i.processRender(e);if(this.children.some((t=>t.hasHighlight))){e.drawPhase=Lt.HIGHLIGHT;for(const i of t)i.processRender(e)}if(this.children.some((t=>t.hasLabels))){e.drawPhase=Lt.LABEL;for(const i of t)i.processRender(e)}if(N("esri-tiles-debug")){e.drawPhase=Lt.DEBUG;for(const i of t)i.processRender(e)}this.painter.afterRenderPhases(e),e.profiler.recordEnd("drawLayers"),i.logInfo()}doRender(t){const e=this.context,{state:i,pixelRatio:s}=t;this._canvas.resize(t),e.setViewport(0,0,s*i.size[0],s*i.size[1]),e.setDepthWriteEnabled(!0),e.setStencilWriteMask(255),this.renderChildren(t)}async takeScreenshot(t,e,i,s){const n=Math.round(this.state.size[0]*t.resolutionScale),r=Math.round(this.state.size[1]*t.resolutionScale),o=t.resolutionScale,a=this.context,l=this._state.clone();if(null!=s){const t=l.viewpoint;l.viewpoint.rotation=s,l.viewpoint=t}const h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:l,pixelRatio:o,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:i},c=new nt(n,r);c.wrapMode=et.CLAMP_TO_EDGE,c.internalFormat=oe.RGBA8,c.isImmutable=!0;const u=new Ni(a,c,new Ui(Gt.DEPTH_STENCIL,n,r)),f=a.getBoundFramebufferObject(),d=a.getViewport();a.bindFramebuffer(u),a.setViewport(0,0,n,r),this._renderChildren(e??this.children,h);const p=this._readbackScreenshot(u,{...t.cropArea,y:r-(t.cropArea.y+t.cropArea.height)});a.bindFramebuffer(f),a.setViewport(d.x,d.y,d.width,d.height),this.requestRender();const m=await p;let _;return 1===t.outputScale?_=m:(_=new ImageData(Math.round(m.width*t.outputScale),Math.round(m.height*t.outputScale)),(await import("./p-aad64c9f.js").then((function(t){return t.sY}))).resampleHermite(m,_,!0)),u.dispose(),_}async _readbackScreenshot(t,e){const i=(await import("./p-aad64c9f.js").then((function(t){return t.sY}))).createEmptyImageData(e.width,e.height,document.createElement("canvas"));return await t.readPixelsAsync(e.x,e.y,e.width,e.height,tt.RGBA,ct.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i}_emptyTrash(){for(;this._trash.size>0;){const t=Array.from(this._trash);this._trash.clear();for(const e of t)e.processDetach()}}}class lr extends Ne{constructor(){super(...arguments),this.type=Ge.Magnifier,this._resourcePixelRatio=1,this._position=[0,0,0,0],this.shaders={magnifier:new xi}}updateResources(t,e,i,s){t.pixelRatio!==this._resourcePixelRatio&&this._destroyResources(),this._readbackTexture||this._initializeResources(t,e,i,s);const{context:n,pixelRatio:r}=t,{factor:o,offset:a,position:l}=s,{size:h}=t.state,c=s.size*r,u=1/o,f=Math.ceil(u*c);this._readbackTexture.resize(f,f);const d=r*h[0],p=r*h[1],m=.5*f,_=.5*f,g=le(r*l.x,m,d-m-1),v=le(p-r*l.y,_,p-_-1),y=g-m,w=v-_,b=this._readbackTexture;n.bindTexture(b,0),n.gl.copyTexImage2D(b.descriptor.target,0,b.descriptor.pixelFormat,y,w,f,f,0);const x=(g+a.x*r)/d*2-1,M=(v-a.y*r)/p*2-1,C=c/d*2,S=c/p*2;this._position[0]=x,this._position[1]=M,this._position[2]=C,this._position[3]=S}render(t,e){const{context:i,painter:s}=t;s.setPipelineState(Ue);const n={readbackTexture:{texture:this._readbackTexture,unit:0},maskTexture:{texture:this._maskTexture,unit:7},overlayTexture:{texture:this._overlayTexture,unit:6},drawPos:this._position,...e};s.submitDrawMesh(i,{shader:this.shaders.magnifier,uniforms:{config:n},defines:null,optionalAttributes:null,useComputeBuffer:!1},s.quadMesh)}shutdown(){this._destroyResources()}_initializeResources(t,e,i,s){const n=t.context;this._resourcePixelRatio=t.pixelRatio;const r=Math.ceil(s.size*t.pixelRatio);i.width=r,i.height=r;const o=new nt;o.internalFormat=tt.RGBA,o.wrapMode=et.CLAMP_TO_EDGE,o.samplingMode=ut.NEAREST,o.flipped=!0,o.preMultiplyAlpha=!ae(i.src)||!t.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new it(n,o,i),e.width=r,e.height=r,o.pixelFormat=o.internalFormat=tt.ALPHA,this._maskTexture=new it(n,o,e);const a=1/s.factor;o.pixelFormat=o.internalFormat=tt.RGBA,o.width=o.height=Math.ceil(a*r),o.samplingMode=ut.LINEAR,o.flipped=!1,this._readbackTexture=new it(n,o)}_destroyResources(){B(this._maskTexture),B(this._overlayTexture),B(this._readbackTexture)}}async function hr(t){const e=import("./p-7030064b.js"),i=import("./p-34162c5d.js"),s=Xi((await e).default,{signal:t}),n=Xi((await i).default,{signal:t}),r={mask:await s,overlay:await n};return mt(t),r}class cr extends ri{constructor(){super(),this._handles=new he,this._magnifierTechnique=new lr,this.updatingHandles=new ce,this.visible=!1}destroy(){this._handles=Qt(this._handles),this._magnifierTechnique.shutdown(),this._resourcesTask=ue(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){this._backgroundColor=t,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(t){this._magnifier=t,this._handles.removeAll(),this._handles.add([fe((()=>t.version),(()=>{this.visible=t.visible&&null!=t.position&&t.size>0,this.requestRender()}),de),fe((()=>[t.maskUrl,t.overlayUrl]),(()=>this._reloadResources())),fe((()=>t.size),(()=>{this._magnifierTechnique.shutdown(),this.requestRender()}))])}_createTransforms(){return{displayViewScreenMat3:Pt()}}doRender(t){if(!this._resourcesTask)return void this._reloadResources();if(t.drawPhase!==Lt.MAP||!this._canRender())return;const e=this._magnifier;if(null==e.position)return;this._magnifierTechnique.updateResources(t,this._mask,this._overlay,e);const i=this.backgroundColor,s=i?[i.a*i.r/255,i.a*i.g/255,i.a*i.b/255,i.a]:[1,1,1,1];this._magnifierTechnique.render(t,{background:s,maskEnabled:e.maskEnabled?1:0,overlayEnabled:e.overlayEnabled?1:0})}_canRender(){return this._mask&&this._overlay&&null!=this._magnifier}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const t=null!=this._magnifier?this._magnifier.maskUrl:null,e=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=pe((async i=>{const s=null==t||null==e?hr(i):null,n=null!=t?rt(t,{responseType:"image",signal:i}).then((t=>t.data)):s.then((t=>t.mask)),r=null!=e?rt(e,{responseType:"image",signal:i}).then((t=>t.data)):s.then((t=>t.overlay)),[o,a]=await Promise.all([n,r]);this._mask=o,this._overlay=a,this._magnifierTechnique.shutdown(),this.requestRender()})),this.updatingHandles.addPromise(this._resourcesTask.promise)}}class ur extends Ne{constructor(){super(...arguments),this.type=Ge.Grid,this.shaders={grid:new Mi}}render(t,e){const{context:i,painter:s}=t;s.setPipelineState(Ue),s.submitDrawMesh(i,{shader:this.shaders.grid,uniforms:e,defines:null,optionalAttributes:null,useComputeBuffer:!1},s.quadMesh)}}const fr=50,dr=5;function pr(t,e){return Math.log(t)/Math.log(e)}function mr(t,e,i){const s=1===t?10:t;return s**(i?Math.round(pr(fr/e,s)):0)}function _r(t){const{isGeographic:e,isWebMercator:i}=t;return!e&&!i}function gr(t,e,i){const s="number"==typeof t?null:t,n=i??s?.spatialReference;if(null==n||!me(n)||_r(n))return _e(n);let r=s?.x??t,o=s?.y??e;const a=1/Math.sqrt(2);let l=r+a,h=o+a;const{isWebMercator:c,isGeographic:u}=n;let f=u&&!$i(n)?ge.WGS84:n;if(c){let t=new ve({x:r,y:o,spatialReference:n});ye(t,!0,t),r=t.x,o=t.y,t=new ve({x:l,y:h,spatialReference:n}),ye(t,!0,t),l=t.x,h=t.y,f=ge.WGS84}const d=new we({paths:[[[r,o],[l,h]]],spatialReference:f}),p=be(d,10);let m;try{[m]=Gi([p],"meters")}catch{return _e(n)}return m}const vr=Fe();class yr extends ri{constructor(){super(),this._handles=new he,this._projectedCenter=null,this._metersPerSRUnit=null,this._technique=new ur,this._grid=null,this.visible=!0}destroy(){this._handles=Qt(this._handles),this._technique.shutdown()}get grid(){return this._grid}set grid(t){this._grid=t,this._handles.removeAll(),this._handles.add([fe((()=>t?.center),(()=>{this._projectedCenter=null}),de),fe((()=>[t?.center,t?.dynamicScaling,t?.majorLineColor,t?.majorLineInterval,t?.minorLineColor,t?.rotateWithMap,t?.rotation,t?.spacing,t?.units]),(()=>this.requestRender()),de)])}_createTransforms(){return{displayViewScreenMat3:Pt()}}doRender(t){if(t.drawPhase!==Lt.MAP||null==this.grid||!this.visible)return;const{spacing:e,units:i,majorLineInterval:s,dynamicScaling:n,majorLineColor:r,minorLineColor:o}=this.grid;if(0===e)return;if(this._updateDerivedValues(t),null==this._projectedCenter||null==this._metersPerSRUnit)return;const{scale:a,spatialReference:l}=t.state,h=xe(e,i,"meters"),c=this._metersPerSRUnit*Me(a,l),u=h/c;if(!n&&u<dr)return;const f=h*mr(s,u,n);this._updateTransform(t,c,f),this._technique.render(t,{transform:{dvs:this.transforms.displayViewScreenMat3},config:{pxPerCell:f/c,minorLineColor:br(o),majorLineColor:br(r),majorLineInterval:s,halfWidth:.25,aaWidth:.5}})}_updateDerivedValues(t){if(!this.grid)return;const{center:e}=this.grid,{spatialReference:i}=t.state;this._projectedCenter&&Ce(this._projectedCenter.spatialReference,i)||(this._metersPerSRUnit=null,Ce(e.spatialReference,i)?this._projectedCenter=e:Se(e.spatialReference,i)?this._projectedCenter=Pe(e,i):this.requestRender()),null==this._metersPerSRUnit&&null!=this._projectedCenter&&(this._metersPerSRUnit=gr(this._projectedCenter))}_updateTransform(t,e,i){const{grid:s}=this,{center:n,rotation:r,size:o,spatialReference:a}=t.state;if(null==s||null==this._projectedCenter||null==this._metersPerSRUnit)return;const l=e*(o[0]/2),h=e*(o[1]/2),c=this._metersPerSRUnit/i,u=this._projectedCenter,f=X(s.rotation),d=X(r),p=this.transforms.displayViewScreenMat3;ze(p,-f);const m=a.isWrappable?De(u.x,n[0],a):u.x,_=ke(vr,m,u.y),g=Te(vr,n,_);Re(g,g,c),s.rotateWithMap||Ie(g,g,Ae,-d),Ie(g,g,Ae,-f),Re(g,g,1/s.majorLineInterval),wr(g,g),Re(g,g,s.majorLineInterval),Ie(g,g,Ae,f),Dt(p,p,g),s.rotateWithMap&&Ft(p,p,d);const v=ke(vr,l/i,h/i);Oe(p,p,v)}}function wr(t,e){return t[0]=e[0]-Math.trunc(e[0]),t[1]=e[1]-Math.trunc(e[1]),t}function br(t){const[e,i,s,n]=t.toArray().map((t=>t/255));return[e*n,i*n,s*n,n]}export{yr as GridView2D,cr as MagnifierView2D,ar as Stage};
//# sourceMappingURL=p-a17d1b04.js.map