import{b$ as e,a as t,an as i,ao as s,ap as n,am as a,s as r,e5 as o,b_ as l,cl as h,cs as c,f5 as u,cB as d,bY as p,aN as y,kw as f,l2 as w,h0 as m,h1 as g,kq as T,fa as I,lW as b,kd as E,hD as R,g3 as v,l3 as M,kt as C,dC as N,d$ as A,kv as k,g2 as D,kS as L,cI as S,dK as _,W as x,av as $}from"./p-3013819f.js";import{z as G}from"./p-23c050ff.js";import{o as q}from"./p-ec95a4fb.js";import{e as O}from"./p-94b15954.js";import{t as P}from"./p-1f0b604e.js";import{G as j,p as F,t as H,T as U}from"./p-5cd0796e.js";import{a as Q}from"./p-1f2b7be7.js";import{m as B}from"./p-aa275c19.js";import{$ as W}from"./p-37d27f4e.js";import{l as Y,o as J}from"./p-a047dd27.js";import"./p-3b51db5e.js";import"./p-8b1f6523.js";import"./p-4f73c6ea.js";import"./p-347800d3.js";import"./p-6dec395d.js";import"./p-9a9a9a0b.js";import"./p-a20ea8a0.js";import"./p-1cf43261.js";import"./p-976040d8.js";import"./p-9a63ab56.js";import"./p-c1b8730f.js";import"./p-2779f4bc.js";const V="ESRI__DESTINATION_ID",z="ESRI__ORIGIN_ID";class K{constructor(){this._featureLookup=new Map}static getInstance(){return K.instance||(K.instance=new K),K.instance}static resetInstance(){K.instance&&(K.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const i=this.readFromStoreById(e);i&&t.push(i)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(t,i,s){const n=[];return t.forEach((t=>{if(!t?.id)return;t.properties||(t.properties=[]);let a,r=null;if(s&&t.properties[s]&&(r=q(t.properties[s])),"originId"in t&&"destinationId"in t&&(t.properties[z]=t.originId,t.properties[V]=t.destinationId),t.properties[i]=t.id,t.id&&this._featureLookup.has(t.id)&&this._featureLookup.get(t.id).attributes){const n=this._featureLookup.get(t.id),o=JSON.parse(JSON.stringify(Object.assign(n.attributes,t.properties)));s&&t.properties[s]&&(o[s]=e(t.properties[s])),a=new P(r?JSON.parse(JSON.stringify(r)):n?.geometry?JSON.parse(JSON.stringify(n.geometry)):null,o,null,t.properties[i])}else a=new P(r?JSON.parse(JSON.stringify(r)):null,t.properties,null,t.properties[i]);this._featureLookup.set(t.id,a),n.push(a)})),n}}var Z;!function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(Z||(Z={}));var X,ee;!function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(X||(X={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(ee||(ee={}));var te,ie,se,ne;!function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(te||(te={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(ie||(ie={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(se||(se={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(ne||(ne={}));function ae(e){if(!e.spatialReference.isWGS84)throw new t("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let i;return i=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],i}async function re(e,t){const i=[],s=new Map,n=[];if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&s.set(e.name,[]);for(const t of e)s.has(t.typeName)&&s.get(t.typeName)?.push(t.id);for(const[e,a]of s){if(a.length<1)continue;const s=new Q({openCypherQuery:`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:a}});n.push(j(t,s).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:s}=await t.read();if(e)break;for(const e of s)i.push({id:e[0],typeName:e[1]}),i.push({id:e[2],typeName:e[3]})}})))}return await Promise.all(n),i}const oe="ESRI__ID",le="ESRI__ORIGIN_ID",he="ESRI__DESTINATION_ID",ce="ESRI__LAYOUT_GEOMETRY",ue="ESRI__AGGREGATION_COUNT",de=12;let pe=class extends a{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((i,s)=>{if("entity"===t.get(s))this.entityTypeNames.add(s);else{if("relationship"!==t.get(s))return r.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this.relationshipTypeNames.add(s)}const n=new Map;i.members?.forEach((e=>{o(this.memberIdTypeLookup,e.id,(()=>new Set)).add(s);const t=this.getById(e.id);t&&n.set(e.id,t)})),this.sublayerCaches.set(s,n)}))}addToLayer(e){e.forEach((({typeName:e,id:i})=>{if(!this.inclusionModeDefinition)throw new t("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const t=this.inclusionModeDefinition.namedTypeDefinitions.get(e);t.members||(t.members=new Map),t.members.set(i,{id:i}),o(this.memberIdTypeLookup,i,(()=>new Set)).add(e)}}else{const t=new Map;t.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:t}),o(this.memberIdTypeLookup,i,(()=>new Set)).add(e)}}))}getById(e){return K.getInstance().readFromStoreById(e)}async getData(e,t,i){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let s;if(s=e||new l({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,i=this._processingCacheUpdatesLookup.get(t.objectType.name??""),n=s.outFields,a=s.geometry;let r="",o="";a&&a.extent&&(r=G(a.extent.ymin,a.extent.xmin,de),o=G(a.extent.ymax,a.extent.xmax,de)),n&&1===n.length&&n[0]===oe&&"1=1"===s.where||await Promise.all(i??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],h=[];return l.forEach((i=>{if(this.relationshipTypeNames.has(t.objectType.name)?i.geometry=e.relationshipLinkChartDiagramLookup.get(i.attributes[t.objectIdField]):i.geometry=e.entityLinkChartDiagramLookup.get(i.attributes[t.objectIdField]),i.attributes[ce]=i.geometry,r&&o){const s=e.linkChartGeohashLookup.get(i.attributes[t.objectIdField]);s?s>=r&&s<=o&&h.push(i):h.push(i)}else h.push(i)})),h}return this.retrieveDataFromService(s,t,i)}async getConnectedRecordIds(e,t){const i=[];let s="";const n=[],a=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;a.has(t)?a.get(t)?.push(e):a.set(t,[e])}})),t&&0!==t?.length){for(const e of t)s=s+e+"|";s=s.slice(0,-1)}return a.forEach(((e,a)=>{let o;o=t&&0!==t?.length?`MATCH (n:${a})-[r:${s}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${a})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const l=new Promise((t=>{(async()=>{const t=(await j(this.knowledgeGraph,new Q({openCypherQuery:o,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:s}=await t.read();if(e)break;for(let e=0;e<s.length;e++){const t=s[e];i.push({id:t[0],typeName:t[1]}),i.push({id:t[2],typeName:t[3]})}}}catch(e){if("AbortError"!==e.name)throw e;r.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));n.push(l)})),this.refreshCacheContent(),await Promise.all(n),i}async refreshCacheContent(e,i,s,n=!0){const a=K.getInstance(),r=[],l=new Map,h=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&h.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&h.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))l.has(t)?l.get(t)?.push(e):l.set(t,[e])})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?l.set(t,null):e.members&&e.members.forEach((e=>{l.has(t)&&null!==l.get(t)?l.get(t)?.push(e.id):l.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,null)})));for(const[e,c]of l){const l=new Promise((r=>{const l=async()=>{const r=new Set,l=[];let u,d="",p=!1;if(i||h.get(e)?.properties?.forEach((e=>{e.name&&r.add(e.name)})),s&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&r.add(t)}if(this.entityTypeNames.has(e))d=`MATCH (n:${e}) ${c?"WHERE id(n) IN $ids ":""}return ID(n)`,r.forEach((e=>{d+=`, n.${e}`,l.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new t("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);p=!0,d=`MATCH ()-[n:${e}]->() ${c?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,r.forEach((e=>{d+=`, n.${e}`,l.push(e)}))}u=new Q(c?{openCypherQuery:d,bindParameters:{ids:c}}:{openCypherQuery:d});const y=(await j(this.knowledgeGraph,u)).resultRowsStream.getReader();for(;;){const{done:t,value:i}=await y.read();if(t)break;const s=[];for(let e=0;e<i.length;e++){const t=i[e];let n=0,a=0;const r={properties:{}};for(r.id=t[n],n++,a++,p&&(r.originId=t[n],n++,a++,r.destinationId=t[n],n++,a++,o(this.nodeConnectionsLookup,r.originId,(()=>new Set)).add(r.id),o(this.nodeConnectionsLookup,r.destinationId,(()=>new Set)).add(r.id),o(this.relationshipConnectionsLookup,r.id,(()=>[r.originId,r.destinationId])));n<t.length;n++)r.properties[l[n-a]]=t[n];s.push(r)}const r=a.writeToStore(s,oe,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);const h=this.sublayerCaches.get(e);r.forEach((t=>{h?.set(t.attributes[oe],t),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes[oe])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes[oe],{id:t.attributes[oe]}),o(this.memberIdTypeLookup,t.attributes[oe],(()=>new Set)).add(e))}))}};l().then((()=>{r(null)}))}));r.push(l),this._processingCacheUpdatesLookup.get(e)?.push(l)}await Promise.all(r)}removeFromLayer(e){const t=new Set,i=new Set(e.map((e=>e.id)));for(const i of e)t.add(i.typeName),1===this.memberIdTypeLookup.get(i.id)?.size?this.memberIdTypeLookup.delete(i.id):this.memberIdTypeLookup.get(i.id)?.delete(i.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===i.typeName&&e.members?.has(i.id)&&e.members.delete(i.id)}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,s)=>{i.has(s)&&this.sublayerCaches.get(e)?.delete(s)}))}))}async retrieveDataFromService(e,i,s){const n=K.getInstance(),a=new Set,r=[];let o,l="",f=[];const w="relationship"===i.graphType,m=this.inclusionModeDefinition?.namedTypeDefinitions?.get(i.objectType.name)?.useAllData,g=i.parentCompositeLayer.sublayerIdsCache.get(i.objectType.name);let T=!m&&g?Array.from(g).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(i.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(i.objectType.name)?.useAllData&&null!=e.objectIds&&(T=e.objectIds);else if(null!=e.objectIds&&T&&T.length>0){const t=e.objectIds;e.objectIds=T.filter((e=>t.includes(e)))}else if(null!=e.objectIds)T=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(i.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(i.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(i.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=T}if(null!=e.outFields){const t=e.outFields;t.includes("*")?i.fields.forEach((e=>{a.add(e.name)})):t.forEach((e=>{e!==oe&&e!==i.geometryFieldName&&a.add(e)}))}if(null!=e.geometry){const s=e.geometry;let n;const f=i.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,m=f?.spatialReference,g=f?.serviceCapabilities?.geometryCapabilities;let T=g?.geometryMaxBoundingRectangleSizeX,I=g?.geometryMaxBoundingRectangleSizeY;if(s?.extent?.spatialReference&&!s.spatialReference?.isWGS84?(await h(s.extent.spatialReference,c),n=u(s.extent,c)):n=s.extent,T&&I&&m){if(4326!==m.wkid){const e=new d({spatialReference:m,xmax:T,ymax:I}),t=u(e,c);T=t.xmax,I=t.ymax}if(n.xmax-n.xmin>T)throw new t("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${T}° latitude, limit exceeded`);if(n.ymax-n.ymin>I)throw new t("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${I}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const t=await p(e.where.toUpperCase(),i.fieldsIndex);i.fields.forEach((e=>{t.fieldNames.includes(e.name)&&a.add(e.name)}))}l=w?`Match ()-[n:${i.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${i.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${i.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${i.geometryFieldName}) return ID(n)`,i.geometryFieldName&&a.add(i.geometryFieldName),a.forEach((e=>{l+=`, n.${e}`,r.push(e)})),o=new Q({openCypherQuery:l,bindParameters:{param_filter_geom:new y({rings:ae(n)})}})}else{let t="";if(null!=e.where&&"1=1"!==e.where){const s=await p(e.where,i.fieldsIndex);i.fields.forEach((e=>{s.fieldNames.includes(e.name)&&a.add(e.name)}));const n=new Set(["column-reference","string","number","binary-expression"]),r=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let o=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&n.has(e.left.type)&&n.has(e.right.type)&&r.has(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return o=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return o=!0,"";{let i=e.right.value;"%"===i.charAt(0)&&(i=i.slice(1)),"%"===i.charAt(i.length-1)&&(i=i.slice(0,-1)),t+=`'${i.toLowerCase()}')`}return t}return o=!0,""};t=l(s.parseTree),o&&(t="")}let s="";s=w?`Match ()-[n:${i.objectType.name}]->()`:`Match (n:${i.objectType.name})`;let n=!1;T&&(n=!0,s+=" WHERE ID(n) IN $ids"),t&&(s+=n?" AND":" WHERE",s+=` ${t}`),s+=" return ID(n)",w&&(s+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&i.geometryFieldName&&a.add(i.geometryFieldName),a.forEach((e=>{s+=`, n.${e}`,r.push(e)})),o=new Q(T?{openCypherQuery:s,bindParameters:{ids:T}}:{openCypherQuery:s})}const I=(await j(i.parentCompositeLayer.dataManager.knowledgeGraph,o,s)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await I.read();if(e)break;const s=[];for(let e=0;e<t.length;e++){const i=t[e];let n=0,a=0;const o={properties:{}};for(o.id=i[n],n++,a++,w&&(o.originId=i[n],n++,a++,o.destinationId=i[n],n++,a++);n<i.length;n++)o.properties[r[n-a]]=i[n];s.push(o)}f=f.concat(n.writeToStore(s,oe,i.parentCompositeLayer.dataManager.geographicLookup.get(i.objectType.name)?.name))}return f}};i([s()],pe.prototype,"knowledgeGraph",void 0),i([s()],pe.prototype,"inclusionModeDefinition",void 0),i([s()],pe.prototype,"entityTypeNames",void 0),i([s()],pe.prototype,"relationshipTypeNames",void 0),i([s()],pe.prototype,"geographicLookup",void 0),i([s()],pe.prototype,"sublayerCaches",void 0),i([s()],pe.prototype,"nodeConnectionsLookup",void 0),i([s()],pe.prototype,"relationshipConnectionsLookup",void 0),i([s()],pe.prototype,"memberIdTypeLookup",void 0),pe=i([n("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],pe);const ye=f(),fe=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return i([s(ye.fields)],t.prototype,"fields",void 0),i([s(ye.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=i([n("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};let we=class extends(w(fe(m(g(T(I)))))){constructor(e){if(super(e),this.capabilities=Y(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=oe,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new b(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const i=l.fromJSON(e);return this.queryFeaturesJSON(i,t)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=ce;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?E.fromJSON(t.geometryType):null;const i=t?.name,s=i?e.objectType.properties?.[i]:null;s?(this.hasM=s.hasM??!1,this.hasZ=s.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=null,i=e.fieldType;"esriFieldTypeOID"===i&&(i="esriFieldTypeInteger"),this.fields.push(R.fromJSON({name:e.name,type:i,alias:e.alias,defaultValue:t,editable:e.editable,nullable:e.nullable}))})),this.fields.push(R.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(R.fromJSON({name:ue,type:"esriFieldTypeInteger",alias:ue,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=v(J(E.toJSON("polyline")).renderer):this.renderer=v(J(E.toJSON("point")).renderer):this.renderer=v(J(E.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){M(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return C(this,e)}createQuery(){return new l({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:i,queryEngine:s}=await this._setupQueryObjects(e),n=N.fromJSON(await s.executeQuery(i.toJSON(),t?.signal));return n.features.forEach((e=>{e.sourceLayer=this})),n}async queryFeaturesJSON(e,t){const{resolvedQuery:i,queryEngine:s}=await this._setupQueryObjects(e);return await s.executeQuery(i.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:i,queryEngine:s}=await this._setupQueryObjects(e);return s.executeQueryForCount(i.toJSON(),t?.signal)}async queryExtent(e={},t){const i={...e,returnGeometry:!0},{resolvedQuery:s,queryEngine:n}=await this._setupQueryObjects(i),a=await n.executeQueryForExtent(s.toJSON(),t?.signal);let r;return r=null!=a.extent?.xmin&&null!=a.extent?.xmax&&null!=a.extent?.ymin&&null!=a.extent?.ymax?new d(a.extent):new d,{count:a.count,extent:r}}async queryObjectIds(e,t){const i=l.from(e);let s;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)s=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);s=this.loadQueryEngine(e)}return s.executeQueryForIds(i.toJSON(),t?.signal)}loadQueryEngine(e){const t=new B({geometryType:E.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new W({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:E.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return i.featureStore.addMany(e),i}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new l({where:"1=1",outFields:[oe]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const i=l.from(e),s=i.geometry;let n;if(s&&!s.spatialReference?.isWGS84&&(await h(s.spatialReference,c),i.geometry=u(s instanceof y||s instanceof A?s:s.extent,c)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(e)}return{resolvedQuery:i,queryEngine:n}}};i([s()],we.prototype,"capabilities",void 0),i([s({readOnly:!0})],we.prototype,"defaultPopupTemplate",null),i([s()],we.prototype,"definitionExpression",void 0),i([s()],we.prototype,"displayField",void 0),i([s()],we.prototype,"elevationInfo",void 0),i([s()],we.prototype,"geometryType",void 0),i([s()],we.prototype,"geometryFieldName",void 0),i([s()],we.prototype,"graphType",void 0),i([s()],we.prototype,"hasM",void 0),i([s()],we.prototype,"hasZ",void 0),i([s()],we.prototype,"labelsVisible",void 0),i([s()],we.prototype,"labelingInfo",void 0),i([s()],we.prototype,"objectIdField",void 0),i([s()],we.prototype,"objectType",void 0),i([s()],we.prototype,"parentCompositeLayer",void 0),i([s(k)],we.prototype,"popupEnabled",void 0),i([s({type:D,json:{name:"popupInfo",write:!0}})],we.prototype,"popupTemplate",void 0),i([s({types:L,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],we.prototype,"renderer",null),i([s()],we.prototype,"source",void 0),i([s({json:{read:!1}})],we.prototype,"type",void 0),we=i([n("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],we);const me=we;let ge,Te=null;function Ie(){return ge||(ge=import("./p-90c6ffef.js").then((e=>e.l)).then((({default:e})=>e({locateFile:e=>S(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{be(e)})),ge)}function be(e){Te=e}var Ee,Re;function ve(e,t,i,s,n,a){const r=i.length,o=n.length,l=Float64Array.BYTES_PER_ELEMENT,h=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,u=16,d=u-1+r*(c+2*l)+o*(2*h),p=Te._malloc(d);try{const c=p+u-p%u,d=c+r*l,y=d+r*l,f=y+o*h,w=f+o*h,m=()=>[Te.HEAPF64.subarray(c>>3,(c>>3)+r),Te.HEAPF64.subarray(d>>3,(d>>3)+r),Te.HEAPU32.subarray(y>>2,(y>>2)+o),Te.HEAPU32.subarray(f>>2,(f>>2)+o),Te.HEAPU8.subarray(w,w+r)],[g,T,I,b,E]=m();g.set(i),T.set(s),I.set(n),b.set(a),E.set(t);let R=e(r,w,c,d,o,y,f),v=null;if(R){const e=Te.getLayoutLinksTypes(),t=Te.getLayoutLinksVerticesEndIndices(),i=Te.getLayoutLinksVertices(),s=Te.countLayoutLinksVertices();!o||e&&t?s&&!i?R=!1:v={types:new Uint8Array(Te.HEAPU8.subarray(e,e+o)),vertexEndIndex:new Uint32Array(Te.HEAPU32.subarray(t>>2,(t>>2)+o)),vertices:new Float64Array(Te.HEAPF64.subarray(i>>3,(i>>3)+2*s))}:R=!1}const[M,C,N,A,k]=m();return i.set(M),s.set(C),n.set(N),a.set(A),t.set(k),{success:R,links:v}}finally{Te._free(p),Te.cleanupLayout()}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(Ee||(Ee={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(Re||(Re={}));const Me=2,Ce=1,Ne=-1;var Ae,ke,De,Le,Se,_e,xe,$e;!function(e){function t(){return Te.getMinIdealEdgeLength()}function i(e,t,i,s,n,a=Me,r=Ce,o=Ne){return ve(((e,t,i,s,n,l,h)=>Te.applyForceDirectedLayout(e,t,i,s,n,l,h,a,r,o)),e,t,i,s,n)}e.getMinIdealEdgeLength=t,e.apply=i}(Ae||(Ae={})),function(e){function t(e,t,i,s,n,a=Me,r=Ce,o=Ne){return ve(((e,t,i,s,n,l,h)=>Te.applyCommunityLayout(e,t,i,s,n,l,h,a,r,o)),e,t,i,s,n)}e.apply=t}(ke||(ke={})),function(e){function t(e,t,i,s,n){return ve(Te.applySimpleLayout,e,t,i,s,n)}e.apply=t}(De||(De={})),function(e){function t(e,t,i,s,n){return ve(Te.applyHierarchicalLayout,e,t,i,s,n)}e.apply=t}(Le||(Le={})),function(e){function t(e,t,i,s,n){return ve(Te.applyRadialTreeLayout,e,t,i,s,n)}e.apply=t}(Se||(Se={})),function(e){function t(e,t,i,s,n){return ve(Te.applySmartTreeLayout,e,t,i,s,n)}e.apply=t}(_e||(_e={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(xe||(xe={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}($e||($e={}));const Ge=(e,t,i)=>(e.has(t)||e.set(t,i()),e.get(t));let qe=class extends(m(g(I))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new _,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new d({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new _,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new t("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const i=new Set;let s=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new t("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(s=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((t,a)=>{if(!this._graphTypeLookup.get(a))return r.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(a);this._graphTypeLookup.get(a)instanceof F||"strictOrigin"in this._graphTypeLookup.get(a)?i.has(a)||(i.add(a),n.push(this._graphTypeLookup.get(a))):this._graphTypeLookup.get(a)instanceof H||"properties"in this._graphTypeLookup.get(a)?i.has(a)||(i.add(a),s.push(this._graphTypeLookup.get(a))):(r.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(a))})):(s=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const a=new pe({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=s,this.memberRelationshipTypes=n,this.dataManager=a}load(e){return this.addResolvingPromise(new Promise((t=>{U(this.url).then((i=>{if(this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof O?e.linkChartLocation:e.linkChartLocation?q(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,G(t.coords[1],t.coords[0],de)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t))})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{x(e);const t=[],i=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e,t){let i=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await re(e,this.dataManager.knowledgeGraph));const s=e.concat(i).filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));await this._handleNewRecords(s)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let s=[];for(const t of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id)&&s.push(t);if(t){const e=new Set,t=[];for(const t of s)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(const i of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(i);for(const i of e)if(this.dataManager.memberIdTypeLookup.has(i))for(const e of this.dataManager.memberIdTypeLookup.get(i))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:i,typeName:e});s=s.concat(t)}this.dataManager.removeFromLayer(s);for(const e of s)this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);i&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const n=[];return this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n),this._refreshNamedTypes(),s}async expand(e,t){const i=await this.dataManager.getConnectedRecordIds(e,t),s=i.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(i),{records:s}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new me({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new me({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const i=Ge(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(i.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof O)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,G(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],de)):this.linkChartGeohashLookup.set(e.id,"");else{const i=q(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,G(e.linkChartLocation.x,e.linkChartLocation.y,de)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(e="RADIAL_TREE",i){const s=[],n=[],a=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{s.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{n.push({typeName:t,feature:e})}))})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const o=new Map,l=new Map,h=new Map,c=new Map,u=new Uint8Array(s.length),p=new Float64Array(s.length),y=new Float64Array(s.length),f=new Uint32Array(n.length),w=new Uint32Array(n.length),m=[],g="FORCE_DIRECTED",T=new d({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let I,b="FORCE_DIRECTED",E=0,R=0;switch(b="GEOGRAPHIC"===e?g:e,b){case"FORCE_DIRECTED":I=Ae.apply;break;case"COMMUNITY":I=ke.apply;break;case"HIERARCHICAL":I=Le.apply;break;case"RADIAL_TREE":I=Se.apply;break;case"SMART_TREE":I=_e.apply;break;default:I=De.apply}s.forEach((({typeName:t,feature:s})=>{if(i?.lockedNodeLocations?.has(s.attributes[oe])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(t)?u[E]=Ee.IsGeographic:u[E]=Ee.None;const n=i.lockedNodeLocations.get(s.attributes[oe]);p[E]=n.x,y[E]=n.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(t)){u[E]=Ee.IsGeographic;let e=null;const i=s.attributes[this.dataManager.geographicLookup.get(t).name],n=this.dataManager.geographicLookup.get(t)?.geometryType;switch(n){case"esriGeometryPoint":p[E]=i?.x,y[E]=i?.y;break;case"esriGeometryPolygon":e=i?.centroid,null!=e?.x&&null!=e?.y?(p[E]=e.x,y[E]=e.y):u[E]=Ee.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=i?.extent?.center,null!=e?.x&&null!=e?.y?(p[E]=e.x,y[E]=e.y):u[E]=Ee.IsMovable;break;default:u[E]=Ee.IsMovable}(null==p[E]||null==y[E]||Number.isNaN(p[E])||Number.isNaN(y[E]))&&(u[E]=Ee.IsMovable,p[E]=0,y[E]=0)}else u[E]=Ee.IsMovable,p[E]=0,y[E]=0;c.set(s.attributes[oe],E),m[E]={feature:s,typeName:t},E++}));let v=!1;const M=new Map;n.forEach((e=>{const t=e.feature.attributes[le],i=e.feature.attributes[he],s=c.get(t),n=c.get(i);if(void 0!==s&&void 0!==n){const r=t+"-"+i,o=M.get(r),l=o?.has(e.typeName);l||(f[R]=s,w[R]=n,void 0===o?M.set(r,new Map([[e.typeName,R]])):o.set(e.typeName,R),R++),a.push(e)}else v=!0,this.relationshipLinkChartDiagramLookup.set(t,null),this.linkChartGeohashLookup.set(t,null)})),v&&r.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await Ie();const{success:C,links:N}=I(u,p,y,f.subarray(0,R),w.subarray(0,R));if(!C)throw new t("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let e=0;e<m.length;e++){if(y[e]>84.9999?y[e]=84.9999:y[e]<-84.9999&&(y[e]=-84.9999),p[e]>179.9999?p[e]=179.9999:p[e]<-179.9999&&(p[e]=-179.9999),m[e].feature.attributes[ce]=new $(p[e],y[e]),o.has(m[e].typeName)){const t=o.get(m[e].typeName);t?.set(m[e].feature.attributes[oe],m[e].feature)}else{const t=new Map;t.set(m[e].feature.attributes[oe],m[e].feature),o.set(m[e].typeName,t)}h.set(m[e].feature.attributes[oe],m[e].feature);const t=q(m[e].feature.attributes[ce]);this.entityLinkChartDiagramLookup.set(m[e].feature.attributes[oe],m[e].feature.attributes[ce]?t:null),this.linkChartGeohashLookup.set(m[e].feature.attributes[oe],G(m[e].feature.attributes[ce].y,m[e].feature.attributes[ce].x,de)),m[e].feature.attributes[ce].x<T.xmin&&(T.xmin=m[e].feature.attributes[ce].x),m[e].feature.attributes[ce].x>T.xmax&&(T.xmax=m[e].feature.attributes[ce].x),m[e].feature.attributes[ce].y<T.ymin&&(T.ymin=m[e].feature.attributes[ce].y),m[e].feature.attributes[ce].y>T.ymax&&(T.ymax=m[e].feature.attributes[ce].y)}if(this.linkChartExtent.xmin=T.xmin,this.linkChartExtent.xmax=T.xmax,this.linkChartExtent.ymin=T.ymin,this.linkChartExtent.ymax=T.ymax,!N)throw new t("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const k=new Map,D=new Map,L=new Map,S=new Set;for(let e=0;e<a.length;e++){const t=[],i=a[e],s=i.feature.attributes[le],n=i.feature.attributes[he],o=s+"-"+n,u=M.get(o).get(i.typeName),d=0===u?0:N?.vertexEndIndex[u-1];if(!S.has(u)){if(S.add(u),N.types[u]===Re.Recursive){const e=[N.vertices[2*d],N.vertices[2*d+1]],i=[N.vertices[2*(d+1)],N.vertices[2*(d+1)+1]],s=[.5*(e[0]+i[0]),.5*(e[1]+i[1])],n=[s[0]-e[0],s[1]-e[1]],a=[s[0]+n[1],s[1]-n[0]],r=[s[0]-n[1],s[1]+n[0]];t.push(e),t.push(a),t.push(i),t.push(r),t.push(e)}else{if(N.types[u]!==Re.Regular){r.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let e=d;e<N.vertexEndIndex[u];e++)t.push([N.vertices[2*e],N.vertices[2*e+1]])}const e=m[c.get(s)]?.feature.attributes[ce],i=m[c.get(n)]?.feature.attributes[ce];t[0][0]===e.x&&t[0][1]===e.y||(t[0]=[e.x,e.y]),t[t.length-1][0]===i.x&&t[t.length-1][1]===i.y||(t[t.length-1]=[i.x,i.y]);for(let e=1;e<t.length-1;e++)t[e][1]>85.5?t[e][1]=85.5:t[e][1]<-85.5&&(t[e][1]=-85.5),t[e][0]>179.9999?t[e][0]=179.9999:t[e][0]<-179.9999&&(t[e][0]=-179.9999);k.has(o)?k.get(o).push(t):k.set(o,[t])}const p=k.get(o);D.has(o)||(D.set(o,new Map),L.set(o,new Map));const y=D.get(o),f=L.get(o);y.has(i.typeName)||(y.set(i.typeName,p.shift()),f.set(i.typeName,0));const w=y.get(i.typeName);f.set(i.typeName,f.get(i.typeName)+1);const g=new A({paths:w});if(i.feature.attributes[ce]=g,l.has(i.typeName)){const e=l.get(i.typeName);e?.set(i.feature.attributes[oe],i.feature)}else{const e=new Map;e.set(i.feature.attributes[oe],i.feature),l.set(i.typeName,e)}h.set(i.feature.attributes[oe],i.feature);const T=q(i.feature.attributes[ce]);this.relationshipLinkChartDiagramLookup.set(i.feature.attributes[oe],i.feature.attributes[ce]?T:null),this.linkChartGeohashLookup.set(i.feature.attributes[oe],"")}for(const e of a)e.feature.attributes[ue]=L.get(e.feature.attributes[le]+"-"+e.feature.attributes[he])?.get(e.typeName)??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:o,links:l,idMap:h}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const i=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const i=t.linkChartLocation;let s;const n=t.id;i&&(s="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(n,new $({x:s.x,y:s.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const i=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!i.has(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(const e of t)if(this._graphTypeLookup.has(e)){const t=this._graphTypeLookup.get(e),i="endPoints"in t?"relationship":"entity",s=new me({objectType:t,parentCompositeLayer:this,graphType:i,title:e});"entity"===i?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),s.geometryType?this.layers.push(s):this.tables.push(s),this.dataManager.sublayerCaches.set(e,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e?.members?.forEach((e=>{const i=e.linkChartLocation;let s;const n=e.id;if(!i)return;s="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const a=q(s);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n,a):this.entityLinkChartDiagramLookup.set(n,a),this.linkChartGeohashLookup.set(n,G(s.x,s.y,de)),this.linkChartExtent.xmin>s.x&&(this.linkChartExtent.xmin=s.x),this.linkChartExtent.xmax<s.x&&(this.linkChartExtent.xmax=s.x),this.linkChartExtent.ymin>s.y&&(this.linkChartExtent.ymin=s.y),this.linkChartExtent.ymax<s.y&&(this.linkChartExtent.ymax=s.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[le]),i=this.relationshipLinkChartDiagramLookup.get(e.attributes[he]);if(t&&i){const s=q(new A({paths:[[t.coords[0],t.coords[1]],[i.coords[0],i.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[oe],s)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[oe],null);this.linkChartGeohashLookup.set(e.attributes[oe],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};i([s()],qe.prototype,"dataPreloadedInLocalCache",void 0),i([s()],qe.prototype,"defaultLinkChartConfig",void 0),i([s()],qe.prototype,"dataManager",void 0),i([s()],qe.prototype,"knowledgeGraph",void 0),i([s()],qe.prototype,"layers",void 0),i([s()],qe.prototype,"entityLinkChartDiagramLookup",void 0),i([s()],qe.prototype,"relationshipLinkChartDiagramLookup",void 0),i([s()],qe.prototype,"linkChartExtent",void 0),i([s()],qe.prototype,"linkChartGeohashLookup",void 0),i([s()],qe.prototype,"memberEntityTypes",void 0),i([s()],qe.prototype,"memberRelationshipTypes",void 0),i([s()],qe.prototype,"sublayerIdsCache",void 0),i([s()],qe.prototype,"tables",void 0),i([s({json:{read:!1}})],qe.prototype,"type",void 0),qe=i([n("esri.layers.LinkChartLayer")],qe);const Oe=qe;export default Oe;
//# sourceMappingURL=p-afa0273c.js.map