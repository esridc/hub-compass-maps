import{s as t,hJ as e,hK as r,hf as n,b as a,d as o}from"./p-aad64c9f.js";import{b as i,a as s,t as c}from"./p-c679ddd9.js";import{a as u,o as l,u as p,t as y,l as f,n as m,i as w,e as d,c as b}from"./p-014b10d8.js";import{populateGroupLayer as I}from"./p-517201ef.js";import"./p-2af77f97.js";import"./p-86923af6.js";async function S(t,e){const r=t.instance.portalItem;if(r?.id)return await r.load(e),h(t),t.validateItem&&t.validateItem(r),g(t,e)}function h(e){const r=e.instance.portalItem;if(!r?.type||!e.supportedTypes.includes(r.type))throw new t("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r?.type,expectedType:e.supportedTypes.join(", ")})}async function g(t,n){const a=t.instance,o=a.portalItem;if(!o)return;const{url:i,title:s}=o,c=e(o,"portal-item");if("group"===a.type)return v(a,c,t);i&&"media"!==a.type&&a.read({url:i},c);const u=new d,l=await x(t,u,n);return l&&a.read(l,c),a.resourceReferences={portalItem:o,paths:c.readResourcePaths??[]},"subtype-group"!==a.type&&a.read({title:s},c),r(a,c)}async function v(e,r,a){const o=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:i,type:s}=o;if("Group Layer"===s){if(!n(o,"Map"))throw new t("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return L(e)}return e.read({title:i},r),F(e,a)}async function L(t){const r=t.portalItem,n=await r.fetchData("json");if(!n)return;const a=e(r,"web-map");t.read(n,a),await I(t,n,{context:a}),t.resourceReferences={portalItem:r,paths:a.readResourcePaths??[]}}async function F(e,r){let n;const{portalItem:a}=e;if(!a)return;const o=a.type,i=r.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":n=i.FeatureLayer;break;case"Stream Service":n=i.StreamLayer;break;case"Scene Service":n=i.SceneLayer;break;default:throw new t("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}const s=new d;let[c,y]=await Promise.all([n(),x(r,s)]),m=()=>c;if("Feature Service"===o){const t=f(y)?.customParameters;y=a.url?await u(y,a.url,s):{},m=await J(y,i)||m;const r=await P(a.url,{customParameters:t,loadContext:s});return await j(e,m,y,r)}return"Scene Service"===o&&a.url&&(y=await l(a,y,s)),p(y)>0?await j(e,m,y):await T(e,m)}async function T(t,e){const{portalItem:r}=t;if(!r?.url)return;const n=await i(r.url);n&&j(t,e,{layers:n.layers?.map(y),tables:n.tables?.map(y)})}async function j(t,e,r,n){let a=r.layers||[];const o=r.tables||[];if("Feature Collection"===t.portalItem?.type?(a.forEach(((t,e)=>{t.id=e,"Table"===t?.layerDefinition?.type&&o.push(t)})),a=a.filter((t=>"Table"!==t?.layerDefinition?.type))):(a.reverse(),o.reverse()),a.forEach((a=>{const o=n?.(a);if(o||!n){const n=G(t,e(a),r,a,o);t.add(n)}})),o.length){const e=await s.FeatureLayer();o.forEach((a=>{const o=n?.(a);if(o||!n){const n=G(t,e,r,a,o);t.tables.add(n)}}))}}function G(t,e,r,n,o){const i=t.portalItem,s={portalItem:i.clone(),layerId:n.id};null!=n.url&&(s.url=n.url);const c=new e(s);if("sourceJSON"in c&&(c.sourceJSON=o),"subtype-group"!==c.type&&"catalog"!==c.type&&(c.sublayerTitleMode="service-name"),"Feature Collection"===i.type){const t={origin:"portal-item",portal:i.portal||a.getDefault()};c.read(n,t);const e=r.showLegend;null!=e&&c.read({showLegend:e},t)}return c}async function x(t,e,r){if(!1===t.supportsData)return;const n=t.instance,a=n.portalItem;if(!a)return;let o=null;try{o=await a.fetchData("json",r)}catch(t){}if(C(n)){let t=null;const r=await k(a,o,e);if((o?.layers||o?.tables)&&r>0){if(null==n.layerId){const t=b(n.type),e=t?m(o,t)[0]:f(o);e&&(n.layerId=e.id)}t=A(o,n),"OrientedImageryLayer"===t?.layerType&&"oriented-imagery"===n.type&&n.supportedSourceTypes.add("Feature Layer"),t&&null!=o.showLegend&&(t.showLegend=o.showLegend)}return r>1&&"sublayerTitleMode"in n&&"service-name"!==n.sublayerTitleMode&&(n.sublayerTitleMode="item-title-and-service-name"),t}return o}async function k(t,e,r){if(e?.layers&&e?.tables)return p(e);const n=o(t.url);if(!n)return 1;const a=await r.fetchServiceMetadata(n.url.path,{customParameters:f(e)?.customParameters}).catch((()=>null));return(e?.layers?.length??a?.layers?.length??0)+(e?.tables?.length??a?.tables?.length??0)}function A(t,e){const{layerId:r}=e,n=t.layers?.find((t=>t.id===r))||t.tables?.find((t=>t.id===r));return n&&M(n,e)?n:null}function C(t){return"stream"!==t.type&&"layerId"in t}function M(t,e){const r="layerType"in t&&t.layerType,{type:n}=e;return!("feature"===n&&r&&"ArcGISFeatureLayer"!==t.layerType||"catalog"===n&&!r||"oriented-imagery"===n&&!r||"subtype-group"===n&&!r)}async function P(t,e){const{layersJSON:r}=await c(t,e);if(!r)return null;const n=[...r.layers,...r.tables];return t=>n.find((e=>e.id===t.id))}async function J(t,e){const{layers:r}=t;if(!r?.length)return;const n=new Set,a=[];for(const{layerType:t}of r){const r=t??"ArcGISFeatureLayer";if(n.has(r))continue;n.add(r);const o=e[w(r)];a.push(o())}const o=await Promise.all(a),i=new Map;return Array.from(n).forEach(((t,e)=>{i.set(t,o[e])})),({layerType:t})=>{const e=t??"ArcGISFeatureLayer";return i.get(e)}}export{S as load};
//# sourceMappingURL=p-948d6175.js.map