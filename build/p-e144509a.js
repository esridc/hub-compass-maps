import{b as e,B as i,c as s,s as n,I as r,D as o,d as a,e as l,g as h,L as c,T as u,x as p,P as m,A as _,F as v,u as g,z as y,E as w,j as b,k as x,l as M,n as P,q as C,w as S,v as z,y as k,t as T,C as R,G as I,h as A,H as O,J as F,K as D,M as j,N as E,O as L,r as N,Q as U,R as W,U as X,S as B,V,a as H,_ as G,W as Y,X as q,Y as J,Z as Q,$ as K,a0 as Z,a1 as tt,a2 as et,a3 as it,a4 as st,a5 as nt,a6 as rt,a7 as ot,a8 as at,m as lt,a9 as ht,aa as ct,ab as ut,ac as ft,ad as pt,ae as dt,af as mt,ag as _t,ah as vt,ai as gt,aj as yt,ak as wt,al as bt}from"./p-3013819f.js";import{u as xt,f as Mt}from"./p-e6812c2f.js";import{K as Pt,t as Ct,i as St}from"./p-a9376829.js";import{i as zt}from"./p-30a1f911.js";import{f as kt,m as Tt,e as Rt,a as It}from"./p-5f4832a0.js";import{l as At}from"./p-ffa11fc1.js";import{o as Ot,$ as Ft,_ as Dt,b as jt,j as Et,t as Lt,p as Nt,f as Ut,M as $t,I as Wt,J as Xt,T as Bt,v as Vt}from"./p-b362a32c.js";import{A as Ht,E as Gt,t as Yt,i as qt,o as Jt,h as Qt,a as Kt}from"./p-0d83e514.js";import{t as Zt,e as te,h as ee,n as ie,a as se,i as ne,m as re}from"./p-d97e7de8.js";import{L as oe}from"./p-89423226.js";import{e as ae,a as le,o as he}from"./p-595ce045.js";import{n as ce}from"./p-235eeb37.js";import{e as ue,r as fe,t as pe,a as de,n as me,b as _e,c as ve}from"./p-b3d3ca01.js";export{d as LabelManager,f as MapViewNavigation}from"./p-b3d3ca01.js";import{h as ge,x as ye,i as we,s as be}from"./p-201cec5f.js";import{R as xe,E as Me,F as Pe,G as Ce,D as Se,L as ze,O as ke,I as Te,C as Re,B as Ie,U as Ae,T as Oe,N as Fe,P as De}from"./p-8567e6fe.js";import{o as je,w as Ee}from"./p-95fb5390.js";import{i as Le}from"./p-3622b703.js";import{e as Ne,i as Ue}from"./p-4c981aab.js";import{t as $e}from"./p-a925664a.js";import{m as We,d as Xe}from"./p-c268fbe3.js";import{n as Be}from"./p-ad726e47.js";import{o as Ve}from"./p-44a36259.js";import{j as He,M as Ge,y as Ye}from"./p-c7810a6f.js";import{f as qe}from"./p-96e8fb80.js";import{t as Je}from"./p-89242a33.js";import{F as Qe,T as Ke}from"./p-72db18d5.js";import{s as Ze}from"./p-c60ccdaa.js";export{$ as GraphicsView2D}from"./p-6d5c327b.js";export{t as GraphicContainer}from"./p-9cf72458.js";import{t as ti}from"./p-93662c1e.js";import"./p-3b51db5e.js";import"./p-3811f238.js";import"./p-94b15954.js";import"./p-f1aede5a.js";import"./p-a897fcf8.js";import"./p-808395fb.js";import"./p-508fdb0a.js";import"./p-7580bdba.js";import"./p-7b13247d.js";import"./p-a62b18ce.js";import"./p-10e5b6ea.js";import"./p-3b8b0ae8.js";import"./p-ec95a4fb.js";import"./p-1f0b604e.js";import"./p-347800d3.js";import"./p-bb7a38bc.js";import"./p-4c2ef9f4.js";import"./p-59429ce9.js";import"./p-721433ed.js";import"./p-1cf43261.js";import"./p-8b1f6523.js";import"./p-4f73c6ea.js";import"./p-2e4751c2.js";import"./p-54d1d89d.js";import"./p-894e6a6a.js";import"./p-ffb26433.js";import"./p-17c1fa4b.js";import"./p-b6b871c6.js";import"./p-2d8c68ca.js";import"./p-325c6878.js";const ei=()=>n.getLogger("esri.symbols.cim.cimAnalyzer");function ii(t){const e=t.markerPlacement;return e&&e.angleToLine?zt.MAP:zt.SCREEN}class si{constructor(t){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],t&&(this._resourceManager=t)}analyzeSymbolReference(t,i,s){if(this._cimLayers=s??[],!t)return this._cimLayers;if(this._reset(),t.primitiveOverrides){this._primitiveOverrides=t.primitiveOverrides;for(const t of this._primitiveOverrides){const i=t.valueExpressionInfo;if(i)this._setPoMap(t.primitiveName,t.propertyName,i);else if(null!=t.value){let i=t.value;t.propertyName.includes("Color")&&(b(i)&&(i=x(i)),i=e(i)),this._setPoMap(t.primitiveName,t.propertyName,i)}}}return this._analyzeSymbol(t.symbol,i),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(t,e){switch(t?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(t,e)}}_analyzeMultiLayerSymbol(t,e){const n=t?.symbolLayers;if(!n)return;const r=t.effects;let o=zt.SCREEN;const a=i(t)??0;"CIMPointSymbol"===t.type&&"Map"===t.angleAlignment&&(o=zt.MAP);const l="CIMPolygonSymbol"===t.type;let h=n.length;for(;h--;){const i=n[h];if(!i||!1===i.enable)continue;let c;r?.length&&(c=[...r]);const u=i.effects;u?.length&&(r?c.push(...u):c=[...u]);let f=null;if(c){f=[];for(const t of c){const e=s.findEffectOverrides(t,this._primitiveOverrides);e&&f.push(e)}}const p=[];switch(s.findApplicableOverrides(i,this._primitiveOverrides,p),i.type){case"CIMSolidFill":this._analyzeSolidFill(i,f);break;case"CIMPictureFill":this._analyzePictureFill(i,f);break;case"CIMHatchFill":this._analyzeHatchFill(i,f);break;case"CIMGradientFill":this._analyzeGradientFill(i,f);break;case"CIMSolidStroke":this._analyzeSolidStroke(i,f,l,a);break;case"CIMPictureStroke":this._analyzePictureStroke(i,f,l,a);break;case"CIMGradientStroke":this._analyzeGradientStroke(i,f,l,a);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==t.type&&"CIMPolygonSymbol"!==t.type||(o=ii(i));const s=[],n=i.primitiveName;n&&s.push(n);const r=l&&M(i.markerPlacement);this._analyzeMarker(i,f,null,s,o,a,e,[],!1,r);break}default:ei().error("Cannot analyze CIM layer",i.type)}}}_analyzeSolidFill(t,i){const{primitiveName:s,type:n}=t,r=e(t.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!t.colorLocked,color:this._getValueOrOverrideExpression(n,s,"Color",r),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:i,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(t,e){const{primitiveName:i,type:s}=t,n=P(t),o=r(t.height,a.CIMPictureFill.height);let l=r(t.scaleX,1);if("width"in t&&"number"==typeof t.width){const e=t.width;let i=1;const s=this._resourceManager.getResource(t.url);null!=s&&(i=s.width/s.height),l/=i*(o/e)}const h={type:"sprite-rasterization-param",resource:t,overrides:this._getPrimitiveMaterialOverrides(i,s)};this._cimLayers.push({type:"fill",spriteRasterizationParam:h,colorLocked:!!t.colorLocked,effects:e,color:this._getValueOrOverrideExpression(s,i,"TintColor",n),height:this._getValueOrOverrideExpression(s,i,"Height",o),scaleX:this._getValueOrOverrideExpression(s,i,"ScaleX",l),angle:this._getValueOrOverrideExpression(s,i,"Rotation",r(t.rotation)),offsetX:this._getValueOrOverrideExpression(s,i,"OffsetX",r(t.offsetX)),offsetY:this._getValueOrOverrideExpression(s,i,"OffsetY",r(t.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(t,i){const{primitiveName:s,type:n}=t,l=this._analyzeMaterialOverrides(s,["Rotation","OffsetX","OffsetY"]),h=this._normalizePrimitiveOverrideProps(l);let c=[255,255,255,1],u=!1;if(t.lineSymbol?.symbolLayers)for(const i of t.lineSymbol.symbolLayers){if("CIMSolidStroke"!==i.type)continue;const t=i.primitiveName??s;u||!t||i.colorLocked||null==this._poMap[t]?.Color&&null==this._poMap[t]?.StrokeColor||(c=e(i.color),c=this._maybeGetValueOrOverrideExpression(t,"StrokeColor")??this._getValueOrOverrideExpression(n,t,"Color",c),u=!0);const r=this._maybeGetValueOrOverrideExpression(t,"StrokeWidth");if(r){let e=null,i=null;"number"==typeof r?e=r:i=r.valueExpressionInfo;let s=h.find((t=>"strokeWidth"===t.propertyName));s?s.propertyName="width":(s={type:"CIMPrimitiveOverride",primitiveName:t,propertyName:"width",valueExpressionInfo:i,value:e,defaultValue:o(n,"width")},h.push(s))}}const f={type:"sprite-rasterization-param",resource:t,overrides:h};this._cimLayers.push({type:"fill",spriteRasterizationParam:f,colorLocked:!!t.colorLocked,effects:i,color:c,height:this._getValueOrOverrideExpression(n,s,"Separation",r(t.separation,a.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(n,s,"Rotation",r(t.rotation)),offsetX:this._getValueOrOverrideExpression(n,s,"OffsetX",r(t.offsetX)),offsetY:this._getValueOrOverrideExpression(n,s,"OffsetY",r(t.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!u})}_analyzeGradientFill(t,e){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!t.colorLocked,effects:e,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(t,i,s,n){const{primitiveName:o,type:l}=t,h=e(t.color),c=r(t.width,a.CIMSolidStroke.width),u=C(t.capStyle,a.CIMSolidStroke.capstyle),f=C(t.joinStyle,a.CIMSolidStroke.joinstyle),p=t.miterLimit;let d,m,_=[];if(this._analyzePrimitiveOverrides(o,i,null,null)&&(_=this._getPrimitiveMaterialOverrides(o,l)),i&&i instanceof Array&&i.length>0){const t=i[i.length-1].effect;t&&"CIMGeometricEffectDashes"===t.type&&"NoConstraint"===t.lineDashEnding&&null===t.offsetAlongLine&&(d=t.dashTemplate,m=t.scaleDash,(i=[...i]).pop())}const v=void 0!==d?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:d,capStyle:u},overrides:_}:null;this._cimLayers.push({type:"line",spriteRasterizationParam:v,isOutline:s,colorLocked:!!t.colorLocked,effects:i,color:this._getValueOrOverrideExpression(l,o,"Color",h),width:this._getValueOrOverrideExpression(l,o,"Width",c),cap:this._getValueOrOverrideExpression(l,o,"CapStyle",u),join:this._getValueOrOverrideExpression(l,o,"JoinStyle",f),miterLimit:p&&this._getValueOrOverrideExpression(l,o,"MiterLimit",p),referenceWidth:n,zOrder:ni(t.name),dashTemplate:d,scaleDash:m,sampleAlphaOnly:!0})}_analyzePictureStroke(t,e,i,s){const{primitiveName:n,type:o}=t,l=P(t),h=r(t.width,a.CIMPictureStroke.width),c=C(t.capStyle,a.CIMPictureStroke.capstyle),u=C(t.joinStyle,a.CIMPictureStroke.joinstyle),f=t.miterLimit,p={type:"sprite-rasterization-param",resource:t,overrides:this._getPrimitiveMaterialOverrides(n,o)};this._cimLayers.push({type:"line",spriteRasterizationParam:p,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:this._getValueOrOverrideExpression(o,n,"TintColor",l),width:this._getValueOrOverrideExpression(o,n,"Width",h),cap:this._getValueOrOverrideExpression(o,n,"CapStyle",c),join:this._getValueOrOverrideExpression(o,n,"JoinStyle",u),miterLimit:f&&this._getValueOrOverrideExpression(o,n,"MiterLimit",f),referenceWidth:s,zOrder:ni(t.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(t,e,i,s){const{primitiveName:n,type:o}=t,l=r(t.width,a.CIMSolidStroke.width),h=C(t.capStyle,a.CIMGradientStroke.capstyle),c=C(t.joinStyle,a.CIMGradientStroke.joinstyle),u=t.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:i,colorLocked:!!t.colorLocked,effects:e,color:[128,128,128,1],width:this._getValueOrOverrideExpression(o,n,"Width",l),cap:this._getValueOrOverrideExpression(o,n,"CapStyle",h),join:this._getValueOrOverrideExpression(o,n,"JoinStyle",c),miterLimit:u&&this._getValueOrOverrideExpression(o,n,"MiterLimit",u),referenceWidth:s,zOrder:ni(t.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(t,e,i,s,n,o,l,h,c=!1,u=!1){if(c||=!!t.colorLocked,this._analyzeMarkerInsidePolygon(t,e,c))return;const f=r(t.size,a.CIMVectorMarker.size),p=r(t.rotation),d=r(t.offsetX),m=r(t.offsetY),{primitiveName:_,type:v}=t,g=this._getValueOrOverrideExpression(v,_,"Size",f),y=this._getValueOrOverrideExpression(v,_,"Rotation",p),w=this._getValueOrOverrideExpression(v,_,"OffsetX",d),b=this._getValueOrOverrideExpression(v,_,"OffsetY",m);switch(t.type){case"CIMPictureMarker":this._analyzePictureMarker(t,e,i,s,n,o,g,y,w,b,h,c,u);break;case"CIMVectorMarker":this._analyzeVectorMarker(t,e,i,s,n,o,g,y,w,b,h,l,c,u)}}_analyzeMarkerInsidePolygon(t,e,i){const{markerPlacement:s,type:n}=t;if(!s||"CIMMarkerPlacementInsidePolygon"!==s.type)return!1;if("CIMVectorMarker"===n||"CIMPictureMarker"===n){const i=t.primitiveName;if(i&&this._analyzePrimitiveOverrides([i],e,null,null))return!1;const r=s.primitiveName;if(r&&this._analyzePrimitiveOverrides([r],e,null,null))return!1;if("CIMVectorMarker"===n){const{markerGraphics:e}=t;if(e)for(const t of e){const{symbol:e}=t;if("CIMPolygonSymbol"===e?.type&&e.symbolLayers){const{symbolLayers:t}=e;for(const e of t)if("CIMSolidStroke"===e.type)return!1}}}else{const{animatedSymbolProperties:e}=t;if(e)return!1}}const o=Math.abs(s.stepX),a=Math.abs(s.stepY);if(0===o||0===a)return!0;let l,h;if("Random"===s.gridType){const t=z(Ot),e=Math.max(Math.floor(t/o),1);l=a*Math.max(Math.floor(t/a),1);h=e*o/l}else s.shiftOddRows?(l=2*a,h=o/a*.5):(l=a,h=o/a);const c=P(t),u="CIMCharacterMarker"===t.type?null:{type:"sprite-rasterization-param",resource:t,overrides:[]};return this._cimLayers.push({type:"fill",spriteRasterizationParam:u,colorLocked:i,effects:e,color:c,height:l,scaleX:h,angle:s.gridAngle,offsetX:r(s.offsetX),offsetY:r(s.offsetY),applyRandomOffset:"Random"===s.gridType,sampleAlphaOnly:"CIMPictureMarker"!==t.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(t,e,i,s,n,o,a,c,u,f,p,d,m){const{primitiveName:_,type:v}=t;let g=r(t.scaleX,1);const y=P(t);i||(i=this._createMarkerPlacementOverrideExpression(t.markerPlacement));const w=this._createAnimatedSymbolPropertiesOverrideExpression(t.animatedSymbolProperties),b=t.anchorPoint??{x:0,y:0};if("width"in t&&"number"==typeof t.width){const e=t.width;let i=1;const s=this._resourceManager.getResource(t.url);null!=s&&(i=s.width/s.height);g/=i*(r(t.size)/e)}const x=[...s];let M;t.primitiveName&&x.push(t.primitiveName),t.animatedSymbolProperties||w?M={type:"animated",url:t.url,urlHash:"H"+l(t.url),playAnimation:t.animatedSymbolProperties?.playAnimation,reverseAnimation:t.animatedSymbolProperties?.reverseAnimation,randomizeStartTime:t.animatedSymbolProperties?.randomizeStartTime,randomizeStartSeed:t.animatedSymbolProperties?.randomizeStartSeed,startTimeOffset:t.animatedSymbolProperties?.startTimeOffset,duration:t.animatedSymbolProperties?.duration,repeatType:t.animatedSymbolProperties?.repeatType,repeatDelay:t.animatedSymbolProperties?.repeatDelay}:(M=h(t),M.markerPlacement=null);const C={type:"sprite-rasterization-param",resource:M,overrides:this._getMaterialOverrides(x,v)};w&&C.overrides.push(...w.overrides),this._cimLayers.push({type:"marker",spriteRasterizationParam:C,colorLocked:d,effects:e,scaleSymbolsProportionally:!1,alignment:n,size:a,scaleX:this._getValueOrOverrideExpression(v,_,"ScaleX",g),rotation:c,offsetX:u,offsetY:f,transform:{type:"cim-marker-transform-param",params:p},color:this._getValueOrOverrideExpression(v,_,"TintColor",y),anchorPoint:{x:b.x,y:b.y},isAbsoluteAnchorPoint:"Relative"!==t.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!t.rotateClockwise,referenceSize:o,sizeRatio:1,isOutline:m,markerPlacement:i,animatedSymbolProperties:w})}_analyzeVectorMarker(t,e,i,s,n,r,o,a,l,h,c,u,f,p){const d=t.markerGraphics;if(!d)return;const m=t.frame;let _=0;if(_=m?m.ymax-m.ymin:r,_){const e={offsetX:l,offsetY:h,rotation:a,size:o,frameHeight:_,rotateClockWise:!!t.rotateClockwise};c=[...c,e]}i||(i=this._createMarkerPlacementOverrideExpression(t.markerPlacement));for(const o of d)if(o){const a=o.symbol;if(!a)continue;const l=o.primitiveName;let h;if(l&&s.push(l),("CIMPointSymbol"===a.type||"CIMTextSymbol"===a.type)&&m){let e=0,i=0;const s=o.geometry;"x"in s&&"y"in s&&(e+=s.x-.5*(m.xmin+m.xmax),i+=s.y-.5*(m.ymin+m.ymax));const n=t.anchorPoint;n&&("Absolute"===t.anchorPointUnits?(e-=n.x,i-=n.y):m&&(e-=(m.xmax-m.xmin)*n.x,i-=(m.ymax-m.ymin)*n.y));const r={offsetX:e,offsetY:i,rotation:0,size:0,frameHeight:0,rotateClockWise:!1};h=[...c,r]}switch(a.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":u||oi(a)?this._analyzeMultiLayerGraphicNonSDF(t,e,i,null,o,s,n,r,h??c,_,f,p):this._analyzeMultiLayerGraphic(t,e,i,null,o,s,n,r,h??c,_,f,p);break;case"CIMTextSymbol":this._analyzeTextGraphic(e,i,o,s,n,r,h??c,f)}l&&s.pop()}}_analyzeMultiLayerGraphic(t,i,s,n,r,o,a,l,h,f,d,m){const _=r.symbol,v=_.symbolLayers;if(!v)return;let g=v.length;if(ri(v))return void this._analyzeCompositeMarkerGraphic(t,i,s,n,r,v,a,l,h,f,d,m);const y=this._resourceManager.geometryEngine,w=At.applyEffects(_.effects,r.geometry,y);if(w)for(;g--;){const _=v[g];if(!_||!1===_.enable)continue;const b=_.primitiveName;switch(b&&o.push(b),_.type){case"CIMSolidFill":case"CIMSolidStroke":{const o=At.applyEffects(_.effects,w,y),v=kt(o);if(!v)continue;const g="Relative"!==t.anchorPointUnits,[x,M,P,C]=Tt(v,t.frame,t.size,t.anchorPoint,g),S="CIMSolidFill"===_.type,z={type:"sdf",geom:o,asFill:S},{path:k}=_,T=S?e(c(_)):null==k?e(u(_)):[0,0,0,0],R=S?[0,0,0,0]:e(u(_)),I=p(_)??0;if(!S&&!I)break;const A=r.primitiveName;let O=null;S&&!_.colorLocked&&(O=this._maybeGetValueOrOverrideExpression(A,"FillColor"));let F=null;S||_.colorLocked||(F=this._maybeGetValueOrOverrideExpression(A,"StrokeColor"));const D=O??this._getValueOrOverrideExpression(_.type,b,"Color",T),j=F??this._getValueOrOverrideExpression(_.type,b,"Color",R),E=this._maybeGetValueOrOverrideExpression(A,"StrokeWidth")??this._getValueOrOverrideExpression(_.type,b,"Width",I),L=k?{type:"sprite-rasterization-param",resource:{type:"path",path:k,asFill:S},overrides:[]}:{type:"sprite-rasterization-param",resource:z,overrides:[]};this._cimLayers.push({type:"marker",spriteRasterizationParam:L,colorLocked:!!_.colorLocked||!!d,effects:i,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:M,y:P},isAbsoluteAnchorPoint:g,size:f,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:h},frameHeight:f,widthRatio:C,rotateClockwise:!1,referenceSize:l,sizeRatio:x,color:D,outlineColor:j,outlineWidth:E,isOutline:m,markerPlacement:s,animatedSymbolProperties:n});break}case"CIMPictureMarker":case"CIMVectorMarker":_.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(t,i,s,n,r,o,a,l,h,f,!!_.colorLocked||!!d,m):this._analyzeMarker(_,i,s,o,a,l,!1,h,d,m);break;default:this._analyzeMultiLayerGraphicNonSDF(t,i,s,n,r,o,a,l,h,f,!!_.colorLocked||!!d,m)}b&&o.pop()}}_analyzeTextGraphic(t,i,n,o,l,h,f,d){const g=[];s.findApplicableOverrides(n,this._primitiveOverrides,g);const y=n.geometry;if(!("x"in y)||!("y"in y))return;const w=n.symbol,b=S(w),x=m(w.fontStyleName),M=xt(w.fontFamilyName);w.font={family:M,decoration:b,...x};const P=r(w.height,a.CIMTextSymbol.height),C=r(w.angle),z=r(w.offsetX),k=r(w.offsetY),T=e(c(w));let R=e(u(w)),I=p(w)??0;I||(R=e(c(w.haloSymbol)),I=r(w.haloSize));let A=!1;if(w.symbol?.symbolLayers)for(const t of w.symbol.symbolLayers){null!=e(c(t))&&(A=!!t.colorLocked)}const O=n.primitiveName;let F=null;A||(F=this._maybeGetValueOrOverrideExpression(O,"FillColor"));const D=this._maybeGetValueOrOverrideExpression(O,"TextSize"),j=this._maybeGetValueOrOverrideExpression(O,"TextAngle"),E=this._maybeGetValueOrOverrideExpression(O,"TextOffsetX"),L=this._maybeGetValueOrOverrideExpression(O,"TextOffsetY");let N=null,U=null,$=0;if(w.callout&&"CIMBackgroundCallout"===w.callout.type){const t=w.callout;if(t.backgroundSymbol){const i=t.backgroundSymbol.symbolLayers;if(i)for(const t of i)"CIMSolidFill"===t.type?N=e(t.color):"CIMSolidStroke"===t.type&&(U=e(t.color),$=r(t.width,a.CIMSolidStroke.width))}}const W=this._getValueOrOverrideExpression(w.type,n.primitiveName,"TextString",n.textString??"");if(null==W)return;const{fontStyleName:X}=w,B=M+(X?"-"+X.toLowerCase():"-regular"),V=this._getMaterialOverrides(o,w.type);V.push(...this._getPrimitiveMaterialOverrides(n.primitiveName,w.type));const H={type:"text-rasterization-param",resource:{type:"text",textString:n.textString??"",font:w.font,symbol:w,primitiveName:n.primitiveName},overrides:V};this._cimLayers.push({type:"text",lineWidth:null,textRasterizationParam:H,colorLocked:!!d||!!A,effects:t,alignment:l,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:B,decoration:b,weight:x.weight,style:x.style,size:D??P,angle:j??C,offsetX:E??z,offsetY:L??k,transform:{type:"cim-marker-transform-param",params:f},horizontalAlignment:_(w.horizontalAlignment),verticalAlignment:v(w.verticalAlignment),text:W,color:F??this._getValueOrOverrideExpression(w.type,n.primitiveName,"Color",T),outlineColor:R,outlineSize:I,backgroundColor:N,borderLineColor:U,borderLineWidth:$,referenceSize:h,sizeRatio:1,markerPlacement:i})}_analyzeMultiLayerGraphicNonSDF(t,e,i,s,n,r,o,a,l,h,c,u){const f=this._buildSimpleMarker(t,n),p=t.primitiveName,d=this._analyzeMaterialOverrides(p,["Rotation","OffsetX","OffsetY"]),m=this._normalizePrimitiveOverrideProps(d),[_,v,y]=Pt.getTextureAnchor(f,this._resourceManager),w=this._getMaterialOverrides(r,t.type);w.push(...m);const b={type:"sprite-rasterization-param",resource:{...f,avoidSDFRasterization:!0},overrides:w};this._cimLayers.push({type:"marker",spriteRasterizationParam:b,colorLocked:c,effects:e,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:_,y:v},isAbsoluteAnchorPoint:!1,size:h,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:l},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:h,widthRatio:1,rotateClockwise:!!t.rotateClockwise,referenceSize:a,sizeRatio:y/g(t.size),isOutline:u,markerPlacement:i,animatedSymbolProperties:s})}_createMarkerPlacementOverrideExpression(t){if(!t)return null;const e=[];return s.findApplicableOverrides(t,this._primitiveOverrides,e),{type:"cim-marker-placement-info",placement:t,overrides:ai(e)}}_createAnimatedSymbolPropertiesOverrideExpression(t){if(!t)return null;const e=[];return s.findApplicableOverrides(t,this._primitiveOverrides,e),{type:"cim-animation-info",animation:t,overrides:ai(e)}}_buildSimpleMarker(t,e){return{type:t.type,enable:!0,name:t.name,colorLocked:t.colorLocked,primitiveName:t.primitiveName,anchorPoint:t.anchorPoint,anchorPointUnits:t.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:t.rotateClockwise,rotation:0,size:t.size,billboardMode3D:t.billboardMode3D,depth3D:t.depth3D,frame:t.frame,markerGraphics:[e],scaleSymbolsProportionally:t.scaleSymbolsProportionally,respectFrame:t.respectFrame,clippingPath:t.clippingPath}}_analyzeCompositeMarkerGraphic(t,i,s,n,o,l,h,c,u,f,p,d){const m=o.geometry,_=l[0],v=l[1],g=kt(m);if(!g)return;const y="Relative"!==t.anchorPointUnits,[w,b,x,M]=Tt(g,t.frame,t.size,t.anchorPoint,y),{path:P}=v,C=v.primitiveName,S=_.primitiveName,z=o.primitiveName;let k=null;v.colorLocked||p||(k=this._maybeGetValueOrOverrideExpression(z,"FillColor"));const T=k??this._getValueOrOverrideExpression(v.type,C,"Color",e(v.color));let R=null;_.colorLocked||p||(R=this._maybeGetValueOrOverrideExpression(z,"StrokeColor"));const I=R??this._getValueOrOverrideExpression(_.type,S,"Color",e(_.color)),A=this._maybeGetValueOrOverrideExpression(z,"StrokeWidth")??this._getValueOrOverrideExpression(_.type,S,"Width",r(_.width,a.CIMSolidStroke.width)),O={type:"sprite-rasterization-param",resource:P?{type:"path",path:P,asFill:!0}:{type:"sdf",geom:m,asFill:!0},overrides:[]};this._cimLayers.push({type:"marker",spriteRasterizationParam:O,colorLocked:p,effects:i,scaleSymbolsProportionally:!!t.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:b,y:x},isAbsoluteAnchorPoint:y,size:f,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:u},frameHeight:f,widthRatio:M,rotateClockwise:!1,referenceSize:c,sizeRatio:w,color:T,outlineColor:I,outlineWidth:A,isOutline:d,markerPlacement:s,animatedSymbolProperties:n})}_setPoMap(t,e,i){let s;this._poMap[t]?s=this._poMap[t]:(s={},this._poMap[t]=s),s[e]=i}_maybeGetValueOrOverrideExpression(t,e,i){return this._getValueOrOverrideExpression("",t,e,i,!1)}_getValueOrOverrideExpression(t,e,i,s,n=!0){if(n&&!w(s)&&(s=o(t,i.toLowerCase())),null==e)return s;const r=this._poMap[e];if(null==r)return s;const a=r[i];return"string"==typeof a||"number"==typeof a||Array.isArray(a)?a:a?{valueExpressionInfo:a,defaultValue:s}:s}_analyzePrimitiveOverrides(t,e,i,s){if(null==t)return!1;"string"==typeof t&&(t=[t]);for(const e of this._primitiveOverrides)if(t.includes(e.primitiveName)&&e.valueExpressionInfo)return!0;if(null!=e)for(const t of e)if(t?.overrides.length>0)return!0;if(null!=i)for(const t of i)if(t?.overrides.length>0)return!0;if(null!=s)for(const t of s)if(t?.overrides.length>0)return!0;return!1}_getMaterialOverrides(t,e){if(!t)return[];const i=[];for(const s of t)i.push(...this._getPrimitiveMaterialOverrides(s,e));return i}_getPrimitiveMaterialOverrides(t,e){if(!t)return[];const i=this._normalizePrimitiveOverrideProps(this._primitiveOverrides.filter((e=>e.primitiveName===t)));return i.forEach((t=>t.defaultValue=o(e,t.propertyName.toLowerCase()))),i}_analyzeMaterialOverrides(t,e){return this._primitiveOverrides.filter((i=>i.primitiveName!==t||!e.includes(i.propertyName)))}_normalizePrimitiveOverrideProps(t){return t.map((t=>({...t,propertyName:y(t.propertyName)})))}}function ni(t){if(t&&0===t.indexOf("Level_")){const e=parseInt(t.substr(6),10);if(!isNaN(e))return e}return 0}const ri=t=>t&&2===t.length&&t[0].enable&&t[1].enable&&"CIMSolidStroke"===t[0].type&&"CIMSolidFill"===t[1].type&&null==t[0].path&&null==t[1].path&&!t[0].effects&&!t[1].effects;function oi(t){const e=t.symbolLayers;if(!e||2!==e.length)return!1;const i=e.find((t=>t.effects?.find((t=>"CIMGeometricEffectDashes"===t.type&&null!=t.dashTemplate)))),s=e.find((t=>t.effects?.find((t=>"CIMGeometricEffectAddControlPoints"===t.type))));return!!i||!!s}function ai(t){return h(t).map((t=>({...t,propertyName:y(t.propertyName)})))}class li{constructor(t){this.events=new k,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const e={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0};t.appendChild(this._canvas);let i=T(this._canvas,e);i||(i=T(this._canvas,{...e,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=i,this._handles=R([I(this._canvas,"webglcontextlost",(t=>this.events.emit("webgl-context-lost",t)))])}destroy(){this._canvas.parentNode?.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(t,e){if(this._hasMajorPerformanceCaveat||A("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=A("esri-performance-mode-frames-between-render")&&(e(),this._lastRenderViewState=t.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[e,i,s,n,r,o]=this._computeViewTransform(this._lastRenderViewState,t.state);this._canvas.style.transform=`matrix(${e}, ${i}, ${s}, ${n}, ${r}, ${o})`}}else e()}resize(t){const e=this._canvas,i=e.style,{state:{size:s},pixelRatio:n}=t,r=s[0],o=s[1],a=Math.round(r*n),l=Math.round(o*n);e.width===a&&e.height===l||(e.width=a,e.height=l),i.width=r+"px",i.height=o+"px"}_computeViewTransform(t,e){const[i,s]=t.center,[n,r]=e.center,[o,a]=t.toScreen([0,0],n,r),[l,h]=t.toScreen([0,0],i,s),c=l-o,u=h-a,f=t.scale/e.scale,p=e.rotation-t.rotation,d=L();return O(d),F(d,d,[f,f]),D(d,d,j(p)),E(d,d,[c,u]),d}}const hi={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};function ci(t){let e=hi;return t.split("/").forEach((t=>{e&&(e=e[t])})),e}const ui=new ae(ci);function fi(t){return ui.resolveIncludes(t)}const pi=t=>ce({PATTERN:t.pattern}),di={shaders:t=>({vertexShader:pi(t)+fi("background/background.vert"),fragmentShader:pi(t)+fi("background/background.frag")})},mi={shaders:t=>({vertexShader:fi("circle/circle.vert"),fragmentShader:fi("circle/circle.frag")})},_i=t=>ce({PATTERN:t.pattern}),vi={shaders:t=>({vertexShader:_i(t)+fi("fill/fill.vert"),fragmentShader:_i(t)+fi("fill/fill.frag")})},gi={shaders:t=>({vertexShader:fi("outline/outline.vert"),fragmentShader:fi("outline/outline.frag")})},yi=t=>ce({SDF:t.sdf}),wi={shaders:t=>({vertexShader:yi(t)+fi("icon/icon.vert"),fragmentShader:yi(t)+fi("icon/icon.frag")})},bi=t=>ce({PATTERN:t.pattern,SDF:t.sdf}),xi={shaders:t=>({vertexShader:bi(t)+fi("line/line.vert"),fragmentShader:bi(t)+fi("line/line.frag")})},Mi={shaders:t=>({vertexShader:fi("text/text.vert"),fragmentShader:fi("text/text.frag")})};class Pi{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach((t=>t.dispose())),this._programByKey.clear()}getMaterialProgram(t,e,i){const s=e.key<<3|this._getMaterialOptionsValue(e.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const n=this._getProgramTemplate(e.type),{shaders:r}=n,{vertexShader:o,fragmentShader:a}=r(i),l=e.getShaderHeader(),h=e.getShaderMain(),c=o.replace("#pragma header",l).replace("#pragma main",h),u=t.programCache.acquire(c,a,e.getAttributeLocations());return this._programByKey.set(s,u),u}_getMaterialOptionsValue(t,e){switch(t){case oe.BACKGROUND:return(e.pattern?1:0)<<1;case oe.FILL:return(e.pattern?1:0)<<1;case oe.OUTLINE:return 0;case oe.LINE:{const t=e;return(t.sdf?1:0)<<2|(t.pattern?1:0)<<1}case oe.ICON:return(e.sdf?1:0)<<1;case oe.CIRCLE:case oe.TEXT:default:return 0}}_getProgramTemplate(t){switch(t){case oe.BACKGROUND:return di;case oe.CIRCLE:return mi;case oe.FILL:return vi;case oe.ICON:return wi;case oe.LINE:return xi;case oe.OUTLINE:return gi;case oe.TEXT:return Mi;default:return null}}}class Ci{constructor(){this._initialized=!1}dispose(){this._program=N(this._program),this._vertexArrayObject=N(this._vertexArrayObject)}render(t,e,i,s){t&&(this._initialized||this._initialize(t),t.setBlendFunctionSeparate(xe.ONE,xe.ONE_MINUS_SRC_ALPHA,xe.ONE,xe.ONE_MINUS_SRC_ALPHA),t.bindVAO(this._vertexArrayObject),t.useProgram(this._program),e.setSamplingMode(i),t.bindTexture(e,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),t.drawArrays(Me.TRIANGLE_STRIP,0,4),t.bindTexture(null,0),t.bindVAO())}_initialize(t){if(this._initialized)return!0;const e=le(t,ue);if(!e)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const s=ue.attributes,n=new he(t,s,Zt,{geometry:ge.createVertex(t,Pe.STATIC_DRAW,i)});return this._program=e,this._vertexArrayObject=n,this._initialized=!0,!0}}class Si{constructor(t){this._rctx=t,this._programByKey=new Map}dispose(){this._programByKey.forEach((t=>t.dispose())),this._programByKey.clear()}getProgram(t,e=[]){const i=t.vsPath+"."+t.fsPath+JSON.stringify(e);if(this._programByKey.has(i))return this._programByKey.get(i);const s={...e.map((t=>"string"==typeof t?{name:t,value:!0}:t)).reduce(((t,e)=>({...t,[e.name]:e.value})),{})},{vsPath:n,fsPath:r,attributes:o}=t,a=je(n,r,o,s),l=this._rctx.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(i,l),l}}const zi=512;class ki{constructor(t){this._resourceManager=t,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(t,e){switch(t.type){case"dash":{const e=t.dashTemplate,i=t.capStyle,[s,n,r]=Ue(e,i);return{size:[n,r],image:new Uint32Array(s.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[i,s,n,r]=Ne(this._canvas,t,e);return{size:[s,n],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:r}}case"sdf":return this._rasterizeSDFInfo(t);case"CIMHatchFill":case"CIMVectorMarker":case"CIMPictureMarker":return this._rasterizeCIMJSONResource(t,e)}}_rasterizeCIMJSONResource(t,e){switch(t.type){case"CIMHatchFill":{const i=Pt.fromCIMHatchFill(t,e);return this._rasterizeCIMVectorMarker(i)}case"CIMPictureMarker":{const e=Pt.fromCIMInsidePolygon(t);return this._rasterizeCIMVectorMarker(e)}case"CIMVectorMarker":{if("CIMMarkerPlacementInsidePolygon"===t.markerPlacement?.type){const e=Pt.fromCIMInsidePolygon(t);return this._rasterizeCIMVectorMarker(e)}const e=Rt(t);return e&&!t.avoidSDFRasterization?this._rasterizeSDFInfo(e):this._rasterizeCIMVectorMarker(t,!1)}}}_rasterizeSDFInfo(t){if(!t)return null;const[e,i,s]=It(t);return e?{size:[i,s],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}_rasterizeCIMVectorMarker(t,e=!0){const i=e?Ct.fromExtent(t.frame):null,[s,n,r,o,a]=Pt.rasterize(this._canvas,t,i,this._resourceManager);return s?{size:[n,r],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!1,anchorX:o,anchorY:a}:null}rasterizeImageResource(t,e,i,s){this._canvas.width=t,this._canvas.height=e;const n=this._canvas.getContext("2d",{willReadFrequently:!0});i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${t}px`),i.setAttribute("height",`${e}px`),n.drawImage(i,0,0,t,e));const r=n.getImageData(0,0,t,e),o=new Uint8Array(r.data);if(s)for(const t of s)if(t&&t.oldColor&&4===t.oldColor.length&&t.newColor&&4===t.newColor.length){const[e,i,s,n]=t.oldColor,[r,a,l,h]=t.newColor;if(e===r&&i===a&&s===l&&n===h)continue;for(let t=0;t<o.length;t+=4)e===o[t]&&i===o[t+1]&&s===o[t+2]&&n===o[t+3]&&(o[t]=r,o[t+1]=a,o[t+2]=l,o[t+3]=h)}let a;for(let t=0;t<o.length;t+=4)a=o[t+3]/255,o[t]=o[t]*a,o[t+1]=o[t+1]*a,o[t+2]=o[t+2]*a;let l=o,h=t,c=e;const u=zi;if(h>=u||c>=u){const i=h/c;i>1?(h=u,c=Math.round(u/i)):(c=u,h=Math.round(u*i)),l=new Uint8Array(4*h*c);const s=new Uint8ClampedArray(l.buffer);U(o,t,e,s,h,c,!1)}return{size:[h,c],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}class Ti{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new $e(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new $e;let i=null,s=-1;for(let n=0;n<this._free.length;++n){const r=this._free[n];t<=r.width&&e<=r.height&&(null===i||r.y<=i.y&&r.x<=i.x)&&(i=r,s=n)}return null===i?new $e:(this._free.splice(s,1),i.width<i.height?(i.width>t&&this._free.push(new $e(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new $e(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new $e(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new $e(i.x,i.y+e,t,i.height-e))),new $e(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}const Ri=256,Ii=t=>Math.floor(t/256);function Ai(t){const e=new Set;for(const i of t)e.add(Ii(i));return e}function Oi(t,e,i){return t.has(e)||t.set(e,i().then((()=>{t.delete(e)})).catch((i=>{t.delete(e),W(i)}))),t.get(e)}const Fi=t=>({rect:new $e(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0});class Di{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=t,this.height=e,this._glyphSource=i,this._binPack=new Ti(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const t=[117,149,181,207,207,181,149,117],e=[],i=[];for(let s=0;s<t.length;s++){const n=t[s];for(let t=0;t<11;t++){const r=s>=3&&s<5&&t>=3&&t<8?255:0;e.push(n),i.push(r)}}const s={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)},n={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)};this._recordGlyph(s),this._recordGlyph(n)}getTexture(t,e){if(!this._textures[e]){const i=new Xe;i.pixelFormat=Ce.ALPHA,i.wrapMode=Se.CLAMP_TO_EDGE,i.width=this.width,i.height=this.height,this._textures[e]=new We(t,i,new Uint8Array(this.width*this.height))}return this._dirties[e]&&(this._textures[e].setData(this._glyphData[e]),this._dirties[e]=!1),this._textures[e]}async getGlyphItems(t,e,i){const s=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map((e=>this._getMosaicItem(s,t,e)))}bind(t,e,i,s){const n=this.getTexture(t,i);n.setSamplingMode(e),t.bindTexture(n,s)}preloadASCIIGlyphCache(t){const e=this._preloadCache[t];if(null!=e)return e;const i=this._glyphSource.preloadASCIIRange(t).then((()=>{const e=this._getGlyphCache(t);for(let i=0;i<256;i++)this._getMosaicItem(e,t,i)}));return this._preloadCache[t]=i,i}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,e,i){const s=Ai(e),n=[];s.forEach((e=>{n.push(this._fetchRange(t,e,i))})),await Promise.all(n)}async _fetchRange(t,e,i){if(e>Ri)return;const s=t+e;return Oi(this._rangePromises,s,(()=>this._glyphSource.getRange(t,e,i)))}_getMosaicItem(t,e,i){if(!t[i]){const s=this._glyphSource.getGlyph(e,i);if(!s?.metrics)return Fi(i);const n=this._recordGlyph(s),r=this._currentPage,o=s.metrics;t[i]={rect:n,page:r,metrics:o,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(0===e.width)i=new $e(0,0,0,0);else{const s=3,n=e.width+2*s,r=e.height+2*s;i=this._binPack.allocate(n,r),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new Ti(this.width-4,this.height-4),i=this._binPack.allocate(n,r));const o=this._glyphData[this._currentPage],a=t.bitmap;let l,h;if(a)for(let t=0;t<r;t++){l=n*t,h=this.width*(i.y+t)+i.x;for(let t=0;t<n;t++)o[h+t]=a[l+t]}A("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),s=new ImageData(this.width,this.height),n=s.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let e=0;e<t.length;++e)n[4*e]=t[e],n[4*e+1]=0,n[4*e+2]=0,n[4*e+3]=255;i.putImageData(s,0,0),document.body.appendChild(e)}}class ji{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const t=e.getMessage();let i,s,n,r,o,a,l;for(;t.next();)switch(t.tag()){case 1:i=t.getUInt32();break;case 2:s=t.getBytes();break;case 3:n=t.getUInt32();break;case 4:r=t.getUInt32();break;case 5:o=t.getSInt32();break;case 6:a=t.getSInt32();break;case 7:l=t.getUInt32();break;default:t.skip()}t.release(),i&&(this._metrics[i]={width:n,height:r,left:o,top:a,advance:l},this._bitmaps[i]=s);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class Ei{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class Li{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const s=this._getFontStack(t);if(s.getRange(e))return Promise.resolve();const n=256*e,r=n+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",n+"-"+r);return X(o,{responseType:"array-buffer",...i}).then((t=>{s.addRange(e,new ji(new Be(new Uint8Array(t.data),new DataView(t.data))))}))}async preloadASCIIRange(t){const e=this._getFontStack(t),i=0,s=255,n=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+s),r=await X(n,{responseType:"array-buffer"}),o=new ji(new Be(new Uint8Array(r.data),new DataView(r.data)));for(let t=i;t<=s;t++)e.getRange(t)||e.addRange(t,o)}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const s=Math.floor(e/256),n=i.getRange(s);return n?{metrics:n.getMetrics(e),bitmap:n.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new Ei),e}}const Ni=1e20;class Ui{constructor(t){this._svg=null,this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,e,i,s=31){this._initSVG();const n=this.createSVGString(t,e);return new Promise(((t,e)=>{const r=new Image;r.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n),r.onload=()=>{r.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(r,0,0,this.size,this.size);const e=this._context.getImageData(0,0,this.size,this.size),i=new Uint8Array(this.size*this.size*4);for(let t=0;t<this.size*this.size;t++){const i=e.data[4*t+3]/255;this._gridOuter[t]=1===i?0:0===i?Ni:Math.max(0,.5-i)**2,this._gridInner[t]=1===i?Ni:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let t=0;t<this.size*this.size;t++){const e=this._gridOuter[t]-this._gridInner[t];Ve(.5-e/(2*s),i,4*t)}t(i)};const o=i?.signal;o&&B(o,(()=>e(V())))}))}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}return this._svg}createSVGString(t,e){const i=this._initSVG(),s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",t),i.appendChild(s);const n=s.getBBox(),r=n.width/n.height,o=this.size/2;let a,l,h;if(r>1){a=o/n.width;const t=o*(1/r);l=this.size/4,h=o-t/2}else{a=o/n.height;l=o-o*r/2,h=this.size/4}const c=-n.x*a+l,u=-n.y*a+h;s.setAttribute("style",`transform: matrix(${a}, 0, 0, ${a}, ${c}, ${u})`),s.setAttribute("stroke-width",""+.5/a);const f=`<svg style="fill:${e?"red":"none"}; stroke:${e?"none":"red"}" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${i.innerHTML}</svg>`;return i.removeChild(s),f}_edt(t,e,i){const s=this._f,n=this._d,r=this._v,o=this._z;for(let a=0;a<e;a++){for(let n=0;n<i;n++)s[n]=t[n*e+a];this._edt1d(s,n,r,o,i);for(let s=0;s<i;s++)t[s*e+a]=n[s]}for(let a=0;a<i;a++){for(let i=0;i<e;i++)s[i]=t[a*e+i];this._edt1d(s,n,r,o,e);for(let i=0;i<e;i++)t[a*e+i]=Math.sqrt(n[i])}}_edt1d(t,e,i,s,n){i[0]=0,s[0]=-Ni,s[1]=+Ni;for(let e=1,r=0;e<n;e++){let n=(t[e]+e*e-(t[i[r]]+i[r]*i[r]))/(2*e-2*i[r]);for(;n<=s[r];)r--,n=(t[e]+e*e-(t[i[r]]+i[r]*i[r]))/(2*e-2*i[r]);r++,i[r]=e,s[r]=n,s[r+1]=+Ni}for(let r=0,o=0;r<n;r++){for(;s[o+1]<r;)o++;e[r]=(r-i[o])*(r-i[o])+t[i[o]]}}}function $i(t){return t&&"static"===t.type}class Wi{constructor(t,e,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Ti(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,s,n,r,o=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let a,l,h;if($i(i))[a,l,h]=this._allocateImage(e[0],e[1]);else{a=new $e(0,0,e[0],e[1]),l=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:[e[0]+2*Ft,e[1]+2*Ft],dirty:!0,texture:t})}if(a.width<=0||a.height<=0)return null;const c={type:"sprite",rect:a,width:e[0],height:e[1],sdf:n,simplePattern:r,rasterizationScale:o,page:l};return this._mosaicRects.set(t,c),$i(i)&&(A("esri-mosaic-debug")&&this._showDebugSprite(e,i.data),this._copy({rect:a,spriteSize:e,spriteData:i.data,page:l,pageSize:h,repeat:s,sdf:n})),c}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e?.rect;if(!i)return null;i.width=e.width,i.height=e.height;const s=e.width,n=e.height,r=Ft,o=this._mosaicPages[e.page].size;return{size:[e.width,e.height],tl:[(i.x+r)/o[0],(i.y+r)/o[1]],br:[(i.x+r+s)/o[0],(i.y+r+n)/o[1]],page:e.page}}bind(t,e,i=0,s=0){const n=this._mosaicPages[i],r=n.mosaicsData;let o=n.texture;if(o||(o=Bi(t,n.size),n.texture=o),o.setSamplingMode(e),$i(r))t.bindTexture(o,s),n.dirty&&(o.setData(new Uint8Array(r.data.buffer)),o.generateMipmap(),A("esri-mosaic-debug")&&this._showDebugPage(i));else{r.data.loadFrame(o),t.bindTexture(o,s),o.generateMipmap()}n.dirty=!1}getTexture(t,e=0){const i=this._mosaicPages[e],s=i.mosaicsData;let n=i.texture;if(n||(n=Bi(t,i.size),i.texture=n),$i(s))i.dirty&&(n.setData(new Uint8Array(s.data.buffer)),n.generateMipmap(),A("esri-mosaic-debug")&&this._showDebugPage(e));else{s.data.loadFrame(n),n.generateMipmap()}return i.dirty=!1,n}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;if(!$i(i)){i.data.destroy()}}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(t,e,i,s,n,r,o,a,l,h,c){let u=s*e+i,f=a*r+o;if(c){f-=r;for(let o=-1;o<=h;o++,u=((o+h)%h+s)*e+i,f+=r)for(let e=-1;e<=l;e++)n[f+e]=t[u+(e+l)%l]}else for(let i=0;i<h;i++){for(let e=0;e<l;e++)n[f+e]=t[u+e];u+=e,f+=r}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!$i(e.mosaicsData))throw new H("mapview-invalid-resource","unsuitable data type!");const s=t.spriteData,n=i.data;n&&s||console.error("Source or target images are uninitialized!"),Wi._copyBits(s,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+Ft,t.rect.y+Ft,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*Ft,e+=2*Ft;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(te(t)),s=2**Math.ceil(te(e)),n=new $e(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[n,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(t,e);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&$i(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Ti(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([t,e],i){const s=document.createElement("canvas");s.width=t,s.height=e,s.setAttribute("style",`position: absolute; top: ${4+204*Xi++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const n=s.getContext("2d"),r=new ImageData(t,e);r.data.set(new Uint8Array(i.buffer)),n.putImageData(r,0,0),document.body.appendChild(s)}_showDebugPage(t){const e=this._mosaicPages[t],{size:[i,s],mosaicsData:n}=e;if(!$i(n))return void console.error("Could not show sprite mosaic debug for non-static resource");const r=`mosaicDebugPage${t}`,o=document.getElementById(r)??document.createElement("canvas");o.id=r,o.width=i,o.height=s,o.setAttribute("style",`position: absolute; top: ${4+204*t}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const a=o.getContext("2d"),l=new ImageData(i,s);l.data.set(new Uint8Array(n.data.buffer)),a.putImageData(l,0,0),document.body.appendChild(o)}}let Xi=0;function Bi(t,e){const i=new Xe;return i.width=e[0],i.height=e[1],i.wrapMode=Se.CLAMP_TO_EDGE,new We(t,i,null)}class Vi{constructor(t,e,i,s){this._animation=t,this._frameData=null;const n=t=>{this._frameData=t,e.requestRender()};this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=qe(this._animation,i,s,n)}destroy(){this._playHandle.remove()}loadFrame(t){const e=this._frameData;if(null==e)return;const i="width"in e?e.width:e.codedWidth,s="height"in e?e.height:e.codedHeight;t.updateData(0,Ft,Ft,i,s,e),this._frameData=null}}const Hi="arial-unicode-ms-regular",Gi=()=>n.getLogger("esri.views.2d.engine.webgl.TextureManager"),Yi=(t,e,i)=>Gi().error(new H(t,e,i));function qi(t){switch(t.type){case"fill-style":case"CIMHatchFill":return Lt}return 1}class Ji{static fromMosaic(t,e){return new Ji(t,e.page,e.sdf)}constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}}class Qi{constructor(t){this._requestRender=t,this._resourceManager=new Le,this._invalidFontsMap=new Map,this._sdfConverter=new Ui(Dt),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new G({concurrency:10,process:async(t,e)=>{Y(e);try{return await X(t,{responseType:"image",signal:e})}catch(e){if(!q(e))throw new H("mapview-invalid-resource",`Could not fetch requested resource at ${t}`,e);throw e}}}),this._spriteMosaic=new Wi(2048,2048,500),this._glyphSource=new Li(`${J.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Di(1024,1024,this._glyphSource),this._rasterizer=new ki(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}async rasterizeItem(t,e){if(null==t)return Yi("mapview-null-resource","Unable to rasterize null resource"),null;if("cim-rasterization-info"!==t.type)return Yi("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:i}=t;if("text"===i.type){const t=await this._rasterizeText(i,e);for(const e of t.glyphs)this._setTextureBinding(Ht.GLYPH,e);return t}const s=await this._rasterizeSprite(i,e);return s&&this._setTextureBinding(Ht.SPRITE,s),s}getMosaicInfo(t,e,i=!1){const s=this._getTextureBindingInfo(t,e,i);return s?{size:s.size,texture:{texture:s.texture,unit:"sprite"===s.type?jt:Et}}:(Yi("mapview-invalid-resource",`Unable to find resource for ${e}`),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(t,e,i){const s=this._bindingInfos[e-1],n=s.page,r=i?ze.LINEAR_MIPMAP_LINEAR:ze.LINEAR;switch(s.mosaicType){case Ht.SPRITE:{const e=[this.sprites.getWidth(n),this.sprites.getHeight(n)],i=this._spriteMosaic.getTexture(t,n);return i.setSamplingMode(r),{type:"sprite",texture:i,size:e}}case Ht.GLYPH:{const e=[this.glyphs.width,this.glyphs.height],i=this._glyphMosaic.getTexture(t,n);return this._glyphMosaic.bind(t,r,n,Et),i.setSamplingMode(r),{type:"glyph",texture:i,size:e}}default:return Yi("mapview-texture-manager",`Cannot handle unknown type ${s.mosaicType}`),null}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const s=Ji.fromMosaic(t,e),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(s)}e.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,e){const{font:i,textString:s}=t,n=Mt(i),r=this._invalidFontsMap.has(n),[o,a]=St(s),l=He(o);try{const t=r?Hi:n;A("esri-2d-stabilize-glyphs")&&await this._glyphMosaic.preloadASCIIGlyphCache(t);return{type:"glyphs",glyphs:await this._glyphMosaic.getGlyphItems(t,l,e),isRightToLeft:a}}catch(t){Yi("mapview-invalid-resource",`Couldn't find font ${n}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(n,!0);return{type:"glyphs",glyphs:await this._glyphMosaic.getGlyphItems(Hi,l,e),isRightToLeft:a}}}_hashSpriteResource(t){switch(t.type){case"path":return`path:${t.path}.${t.asFill?1:0}`;case"CIMPictureMarker":return`${t.type}:${t.url}:${t.size}`;case"CIMPictureFill":return`${t.type}:${t.url}:${t.height}`;case"CIMPictureStroke":return`${t.type}:${t.url}:${t.width}`;case"dash":return`dash:${t.capStyle}.${t.dashTemplate.join("")}`;case"sdf":return`sdf:${JSON.stringify(t.geom)}.${t.asFill?1:0}`;case"fill-style":return`fill_style:${t.style}`;case"animated":return JSON.stringify(Ge(t));case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(t)}}async _rasterizeSprite(t,e){if(!t)return null;const i=l(this._hashSpriteResource(t));if(this._spriteMosaic.has(i))return this._spriteMosaic.getSpriteItem(i);if("url"in t&&t.url||"CIMPictureFill"===t.type||"CIMPictureStroke"===t.type||"CIMPictureMarker"===t.type||"CIMVectorMarker"===t.type){const e=[];Pt.fetchResources({type:"CIMPointSymbol",symbolLayers:[t]},this._resourceManager,e),e.length>0&&await Promise.all(e)}switch(t.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===t.markerPlacement?.type?this._rasterizeJSONResource(i,t):this._handleAsyncResource(i,t,e);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return this._handleAsyncResource(i,t,e);case"sdf":case"dash":case"fill-style":case"CIMVectorMarker":case"CIMHatchFill":return this._rasterizeJSONResource(i,t)}}_rasterizeJSONResource(t,e){const i=this._rasterizer.rasterizeJSONResource(e,qi(e));if(i){const{size:s,image:n,sdf:r,simplePattern:o,rasterizationScale:a}=i;return this._addItemToMosaic(t,s,{type:"static",data:n},Ki(e),r,o,a)}return null}async _handleAsyncResource(t,e,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let s;return s="path"===e.type?this._handleSVG(e,t,i):this._handleImage(e,t,i),this._ongoingRasterizations.set(t,s),s.finally((()=>this._ongoingRasterizations.delete(t))),s}async _handleSVG(t,e,i){const s=[Dt,Dt],{asFill:n}=t,r=await this._sdfConverter.draw(t.path,n,i);return this._addItemToMosaic(e,s,{type:"static",data:new Uint32Array(r.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,e,i){const s=t.url,n=this.resourceManager.getResource(s);if(null==n)return null;const{width:r,height:o}=n;if(n instanceof HTMLImageElement){if("animated"===t.type)return Yi("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const i="colorSubstitutions"in t?t.colorSubstitutions:void 0,{size:s,sdf:a,image:l}=this._rasterizer.rasterizeImageResource(r,o,n,i);return this._addItemToMosaic(e,s,{type:"static",data:l},Ki(t),a,!1)}let a,l,h;"animated"===t.type?(a=!1,l={playAnimation:t.playAnimation,reverseAnimation:t.reverseAnimation,randomizeStartTime:t.randomizeStartTime,randomizeStartSeed:t.randomizeStartSeed,startTimeOffset:t.startTimeOffset,duration:t.duration,repeatType:t.repeatType,repeatDelay:t.repeatDelay},h=t.startGroup||0):(a=Ki(t),l={},h=0);const c=new Vi(n,this._requestRender,l,h);return this._addItemToMosaic(e,[c.width,c.height],{type:"animated",data:c},a,!1,!1)}async _handleImage(t,e,i){const s=t.url;if(ts(s)||is(s))return this._handleGIFOrPNG(t,e,i);if("animated"===t.type)return Yi("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let n;const r=this.resourceManager.getResource(s);if(null!=r&&r instanceof HTMLImageElement)n=r;else{const{data:t}=await this._imageRequestQueue.push(s,{...i});n=t}if(Ye(s))if("width"in t&&"height"in t)n.width=g(t.width),n.height=g(t.height);else if("cim"in t){const e=t;n.width=g(e.width??e.scaleX*e.size),n.height=g(e.size)}if(!n.width||!n.height)return null;const o=n.width,a=n.height,l="colorSubstitutions"in t?t.colorSubstitutions:void 0,{size:h,sdf:c,image:u}=this._rasterizer.rasterizeImageResource(o,a,n,l);return this._addItemToMosaic(e,h,{type:"static",data:u},Ki(t),c,!1)}catch(t){if(!q(t))throw new H("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${t.message}`);throw t}}_addItemToMosaic(t,e,i,s,n,r,o){return this._spriteMosaic.addSpriteItem(t,e,i,s,n,r,o)}}function Ki(t){switch(t.type){case"CIMVectorMarker":case"CIMPictureMarker":return ss(t);default:return!0}}const Zi=t=>null!=t&&t.startsWith("data:image/gif"),ts=t=>t&&(t.includes(".gif")||Zi(t)),es=t=>null!=t&&t.startsWith("data:image/png"),is=t=>t&&(t.includes(".png")||es(t)),ss=t=>t&&"markerPlacement"in t&&t.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type;class ns{constructor(t){this._queue=[],this._refreshable=t}destroy(){this._queue=[]}enqueueTextureUpdate(t,e){const i=Q(),s=t,n=Ut,r=Math.ceil(s.height/n);Y(e);for(let o=0;o<r;o++){const a=o*n,l=o===r-1,h=l?s.height-n*o:n;this._queue.push({type:"chunk",request:t,resolver:i,chunk:o,chunkOffset:a,destHeight:h,chunkIsLast:l,options:e})}return K(e,(t=>i.reject(t))),i.promise}upload(){let t=0;for(;this._queue.length;){const e=performance.now(),i=this._queue.shift();if(i){if(null!=i.options.signal&&i.options.signal.aborted)continue;switch(i.type){case"chunk":this._uploadChunk(i);break;case"no-chunk":this._uploadNoChunk(i)}const s=performance.now()-e;if(t+=s,t+s>=Nt)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(t){const{request:e,resolver:i,chunkOffset:s,chunkIsLast:n,destHeight:r}=t,{data:o,texture:a,width:l}=e;null!=o&&(a.updateData(0,0,s,l,r,o,s),n&&i.resolve())}_uploadNoChunk(t){const{request:e,resolver:i}=t,{data:s,texture:n}=e;n.setData(s),i.resolve()}}const rs=ot(-.5,-.5);class os{constructor(){this._centerNdc=Z(),this._pxToNdc=Z(),this._worldDimensionsPx=Z(),this._mat3=tt(),this._initialized=!1}dispose(){this._program=N(this._program),this._quad=N(this._quad)}render(t,e,i){const{context:s}=t,n=this._updateGeometry(t,i);if(null!=e){const{r:t,g:i,b:n,a:r}=e;s.setClearColor(r*t/255,r*i/255,r*n/255,r)}else s.setClearColor(0,0,0,0);if(s.setStencilFunction(ke.ALWAYS,0,255),s.setStencilWriteMask(255),!n)return s.setClearStencil(1),void s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT);s.setClearStencil(0),s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(s),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setColorMask(!1,!1,!1,!1),s.setBlendingEnabled(!1),s.setStencilOp(Te.KEEP,Te.KEEP,Te.REPLACE),s.setStencilFunction(ke.ALWAYS,1,255),s.setStencilTestEnabled(!0),s.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(t){if(this._initialized)return;const e=le(t,fe);e&&(this._program=e,this._quad=new ee(t,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(t,e){const{state:i,pixelRatio:s}=t,{size:n,rotation:r}=i,o=Math.round(n[0]*s),a=Math.round(n[1]*s);if(!i.spatialReference.isWrappable)return!1;const l=at(r),h=Math.abs(Math.cos(l)),c=Math.abs(Math.sin(l)),u=Math.round(o*h+a*c),f=Math.round(i.worldScreenWidth);if(u<=f)return!1;const p=o*c+a*h,d=f*s,m=(e.left-e.right)*s/o,_=(e.bottom-e.top)*s/a;et(this._worldDimensionsPx,d,p,1),et(this._pxToNdc,2/o,-2/a,1),et(this._centerNdc,m,_,1);const v=this._mat3;return it(v,this._centerNdc),st(v,v,this._pxToNdc),0!==r&&nt(v,v,l),st(v,v,this._worldDimensionsPx),rt(v,v,rs),!0}}class as{constructor(){this.name=this.constructor.name}createOptions(t,e){return null}}class ls extends as{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(t,e){if(!e?.size)return;const{context:i,renderingOptions:s}=t;this._quad||(this._quad=new ee(i,[0,0,1,0,0,1,1,1]));const n=i.getBoundFramebufferObject(),{x:r,y:o,width:a,height:l}=i.getViewport(),h=e.getBlock($t.Animation);if(null==h)return;const c=e.getUniforms(i);i.setViewport(0,0,e.size,e.size);const u=c.filterFlags,f=c.animation,p=A("featurelayer-animation-enabled")?s.labelsAnimationTime:1,d=h.getFBO(i,1);i.unbindTexture(d.colorTexture),this._computeDelta(t,d,f,u,p);const m=h.getFBO(i);i.unbindTexture(m.colorTexture),this._updateAnimationState(t,d,m),i.bindFramebuffer(n),i.setViewport(r,o,a,l)}_computeDelta(t,e,i,s,n){const{context:r,painter:o,displayLevel:a}=t,l=o.materialManager.getProgram(this._desc,["delta"]);if(r.bindFramebuffer(e),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.useProgram(l),!("type"in s.texture)||!("type"in i.texture))throw new Error("InternalError: Expected to find texture");r.bindTexture(s.texture,s.unit),r.bindTexture(i.texture,i.unit),l.setUniform1i("u_maskTexture",s.unit),l.setUniform1i("u_sourceTexture",i.unit),l.setUniform1f("u_timeDelta",t.deltaTime),l.setUniform1f("u_animationTime",n),l.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}_updateAnimationState(t,e,i){const{context:s,painter:n}=t,r=n.materialManager.getProgram(this._desc,["update"]);s.bindTexture(e.colorTexture,1),s.useProgram(r),r.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const hs=t=>t.replace("-","_").toUpperCase(),cs=t=>`#define ${hs(t)}\n`;function us(t){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:cs(t)+ie("blend/blend.vert"),fragmentShader:cs(t)+ie("blend/blend.frag")}}}const fs=()=>n.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class ps{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture=N(this._backBufferTexture),this._quad=N(this._quad)}draw(t,e,i,s,n){const{context:r,drawPhase:o}=t;if(this._setupShader(r),s&&"normal"!==s&&o!==Gt.LABEL)return void this._drawBlended(t,e,i,s,n);const a=us("normal"),l=r.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes);if(!l)return void fs().error(new H("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));r.useProgram(l),e.setSamplingMode(i),r.bindTexture(e,0),l.setUniform1i("u_layerTexture",0),l.setUniform1f("u_opacity",n),r.setBlendingEnabled(!0),r.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA);const h=this._quad;h.draw(),h.unbind(),l.dispose()}_drawBlended(t,e,i,s,n){const{context:r,state:o,pixelRatio:a,inFadeTransition:l}=t,{size:h}=o,c=r.getBoundFramebufferObject();let u,f;null!=c?(u=c.width,f=c.height):(u=Math.round(a*h[0]),f=Math.round(a*h[1])),this._createOrResizeTexture(t,u,f);const p=this._backBufferTexture;c.copyToTexture(0,0,u,f,0,0,p),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setDepthTestEnabled(!1),r.setDepthWriteEnabled(!1);const d=us(s),m=r.programCache.acquire(d.shaders.vertexShader,d.shaders.fragmentShader,d.attributes);if(!m)return void fs().error(new H("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));r.useProgram(m),p.setSamplingMode(i),r.bindTexture(p,0),m.setUniform1i("u_backbufferTexture",0),e.setSamplingMode(i),r.bindTexture(e,1),m.setUniform1i("u_layerTexture",1),m.setUniform1f("u_opacity",n),m.setUniform1f("u_inFadeOpacity",l?1:0),r.setBlendFunction(xe.ONE,xe.ZERO);const _=this._quad;_.draw(),_.unbind(),m.dispose(),r.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA)}_setupShader(t){this._quad||(this._quad=new ee(t,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(t,e,i){const{context:s}=t;if(null===this._backBufferTexture||e!==this._size[0]||i!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(e,i);else{const t=new Xe;t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,t.width=e,t.height=i,this._backBufferTexture=new We(s,t)}this._size[0]=e,this._size[1]=i}}}class ds extends as{constructor(t){super(),this.name=this.constructor.name,this.defines=[t]}dispose(){}bind({context:t,painter:e}){this._prev=t.getBoundFramebufferObject();const i=e.getFbos().effect0;t.bindFramebuffer(i),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}draw(t,e){const{context:i,painter:s}=t,n=s.getPostProcessingEffects(e),r=i.getBoundFramebufferObject();for(const{postProcessingEffect:e,effect:i}of n)e.draw(t,r,i);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,r.colorTexture,ze.NEAREST),i.setStencilTestEnabled(!0)}}class ms{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(t,e){t.bindTexture(e,Wt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Yt),t.bindVAO(this._resources.quadVAO),t.drawArrays(Me.TRIANGLE_STRIP,0,4),t.bindVAO()}finalBlur(t,e){t.bindTexture(e,Wt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",qt),t.bindVAO(this._resources.quadVAO),t.drawArrays(Me.TRIANGLE_STRIP,0,4),t.bindVAO()}renderHighlight(t,e,i){t.bindTexture(e,Wt),t.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(t,this._resources.highlightProgram),t.bindVAO(this._resources.quadVAO),t.setBlendingEnabled(!0),t.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),t.drawArrays(Me.TRIANGLE_STRIP,0,4),t.bindVAO()}_initialize(t,e,i){this._width=e,this._height=i;const s=ge.createVertex(t,Pe.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new he(t,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new Je("a_position",2,Re.BYTE,0,4),new Je("a_texcoord",2,Re.UNSIGNED_BYTE,2,4)]},{geometry:s}),r=le(t,pe),o=le(t,de);t.useProgram(r),r.setUniform1i("u_texture",Wt),r.setUniform1i("u_shade",Xt),r.setUniform1f("u_sigma",Jt),t.useProgram(o),o.setUniform1i("u_texture",Wt),o.setUniform1f("u_sigma",Jt),this._resources={quadGeometry:s,quadVAO:n,highlightProgram:r,blurProgram:o}}setup(t,e,i){this._resources?(this._width=e,this._height=i):this._initialize(t,e,i)}}function _s(t,e,i){const s=new Xe(e,i);return s.wrapMode=Se.CLAMP_TO_EDGE,new ye(t,s,new we(Ie.STENCIL_INDEX8,e,i))}class vs{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(t,e,i){this._width=e,this._height=i;const s=_s(t,e,i),n=_s(t,e,i);this._resources={sharedBlur1Fbo:s,sharedBlur2Fbo:n}}setup(t,e,i){!this._resources||this._width===e&&this._height===i||this.dispose(),this._resources||this._initialize(t,e,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}const gs=4,ys=4/gs;class ws extends as{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new ms,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new vs,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new Ci}dispose(){this._hlSurfaces?.dispose(),this._hlRenderer?.dispose(),this._boundFBO=null}bind(t){const{context:e,painter:i}=t,{width:s,height:n}=e.getViewport(),r=i.getFbos().effect0;this.setup(t,s,n),e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:t},e,i){this._width=e,this._height=i;const s=e%gs,n=i%gs;e+=s<gs/2?-s:gs-s,i+=n<gs/2?-n:gs-n,this._adjustedWidth=e,this._adjustedHeight=i,this._boundFBO=t.getBoundFramebufferObject();const r=Math.round(e*ys),o=Math.round(i*ys);this._hlRenderer.setup(t,r,o),this._hlSurfaces.setup(t,r,o)}draw(t){const{context:e,passOptions:i}=t,s=i.activeGradient,n=e.getBoundFramebufferObject();e.setViewport(0,0,this._adjustedWidth*ys,this._adjustedHeight*ys),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,n.colorTexture,ze.NEAREST,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,s),this._boundFBO=null}}class bs extends as{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:t},e,i=Bt){if(!e.length)return null;const s=e.shift(),n=s.x,r=s.y;return this._outstanding=s,{type:"hittest",distance:i*t,smallSymbolDistance:0,smallSymbolSizeThreshold:3,position:[n,r]}}bind(t){const{context:e,attributeView:i}=t;if(!i.size)return;const s=i.getBlock($t.GPGPU);if(null==s)return;const n=s.getFBO(e);e.setViewport(0,0,i.size,i.size),e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,e){const{context:i,attributeView:s}=t,n=s.getBlock($t.GPGPU);if(null==n)return void e.forEach((t=>t.resolve([])));const r=n.getFBO(i),o=new Uint8Array(r.width*r.height*4);try{await r.readPixelsAsync(0,0,r.width,r.height,Ce.RGBA,Ae.UNSIGNED_BYTE,o)}catch(t){return void e.forEach((t=>t.resolve([])))}const a=[];for(let t=0;t<o.length;t+=4){const e=t/4;o[t]&&a.push(e)}e.forEach((t=>t.resolve(a)))}}class xs extends as{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0,this._boundFBO=null}dispose(){null!=this._fbo&&this._fbo.dispose()}bind({context:t,painter:e}){this._boundFBO=t.getBoundFramebufferObject();const i=e.getFbos().effect0;t.bindFramebuffer(i),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind({context:t}){t.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw(t,e,i=2*Bt){this._resolve(t,e,i)}async _resolve({context:t,state:e,pixelRatio:i},s,n){const r=t.getBoundFramebufferObject(),o=e.size[1]*i,a=Math.round(n*i),l=a/2,h=a/2;this._ensureBuffer(a),s.forEach((async(t,e)=>{const n=new Map,c=Math.floor(e.x*i-a/2),u=Math.floor(o-e.y*i-a/2);await r.readPixelsAsync(c,u,a,a,Ce.RGBA,Ae.UNSIGNED_BYTE,this._buf);for(let t=0;t<this._buf32.length;t++){const e=this._buf32[t];if(4294967295!==e&&0!==e){const i=t%a,s=a-Math.floor(t/a),r=(l-i)*(l-i)+(h-s)*(h-s),o=n.has(e)?n.get(e):4294967295;n.set(e,Math.min(r,o))}}const f=Array.from(n).sort(((t,e)=>t[1]-e[1])).map((t=>t[0]));t.resolve(f),s.delete(e)}))}_ensureBuffer(t){this._lastSize!==t&&(this._lastSize=t,this._buf=new Uint8Array(4*t*t),this._buf32=new Uint32Array(this._buf.buffer))}}const Ms=5,Ps=[1,0],Cs=[0,1],Ss=[1,.8,.6,.4,.2],zs=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class ks{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(Ms),this._nMips=Ms,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=N(this._quad),this._intensityFBO=N(this._intensityFBO),this._compositeFBO=N(this._compositeFBO),this._mipsFBOs){for(let t=0;t<this._nMips;t++)this._mipsFBOs[t]&&(this._mipsFBOs[t].horizontal.dispose(),this._mipsFBOs[t].vertical.dispose());this._mipsFBOs=null}}draw(t,e,i){const{width:s,height:n}=e,{context:r,painter:o}=t,{materialManager:a}=o,l=r.gl,h=this._programDesc,{strength:c,radius:u,threshold:f}=i;this._quad||(this._quad=new ee(r,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(t,s,n),r.setStencilTestEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),r.setStencilWriteMask(0);const p=this._quad;p.bind(),r.bindFramebuffer(this._intensityFBO);const d=a.getProgram(h.luminosityHighPass);r.useProgram(d),r.bindTexture(e.colorTexture,0),d.setUniform1i("u_texture",0),d.setUniform3fv("u_defaultColor",[0,0,0]),d.setUniform1f("u_defaultOpacity",0),d.setUniform1f("u_luminosityThreshold",f),d.setUniform1f("u_smoothWidth",.01);const m=[Math.round(s/2),Math.round(n/2)];r.setViewport(0,0,m[0],m[1]),r.setClearColor(0,0,0,0),r.clear(l.COLOR_BUFFER_BIT),p.draw(),r.setBlendingEnabled(!1);let _=this._intensityFBO.colorTexture;for(let t=0;t<this._nMips;t++){const e=a.getProgram(h.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[t]}]);r.useProgram(e),r.bindTexture(_,t+1),e.setUniform1i("u_colorTexture",t+1),e.setUniform2fv("u_texSize",m),e.setUniform2fv("u_direction",Ps),r.setViewport(0,0,m[0],m[1]);const i=this._mipsFBOs[t];r.bindFramebuffer(i.horizontal),p.draw(),_=i.horizontal.colorTexture,r.bindFramebuffer(i.vertical),r.bindTexture(_,t+1),e.setUniform2fv("u_direction",Cs),p.draw(),_=i.vertical.colorTexture,m[0]=Math.round(m[0]/2),m[1]=Math.round(m[1]/2)}r.setViewport(0,0,s,n);const v=a.getProgram(h.composite,[{name:"nummips",value:Ms}]);r.bindFramebuffer(this._compositeFBO),r.useProgram(v),v.setUniform1f("u_bloomStrength",c),v.setUniform1f("u_bloomRadius",u),v.setUniform1fv("u_bloomFactors",Ss),v.setUniform3fv("u_bloomTintColors",zs),r.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),v.setUniform1i("u_blurTexture1",1),r.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),v.setUniform1i("u_blurTexture2",2),r.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),v.setUniform1i("u_blurTexture3",3),r.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),v.setUniform1i("u_blurTexture4",4),r.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),v.setUniform1i("u_blurTexture5",5),p.draw(),r.bindFramebuffer(e),r.setBlendingEnabled(!0);const g=a.getProgram(h.blit);r.useProgram(g),r.bindTexture(this._compositeFBO.colorTexture,6),g.setUniform1i("u_texture",6),r.setBlendFunction(xe.ONE,xe.ONE),p.draw(),p.unbind(),r.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0)}_createOrResizeResources(t,e,i){const{context:s}=t;if(this._compositeFBO&&this._size[0]===e&&this._size[1]===i)return;this._size[0]=e,this._size[1]=i;const n=[Math.round(e/2),Math.round(i/2)];if(this._compositeFBO)this._compositeFBO.resize(e,i);else{const t=new Xe(e,i);t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,this._compositeFBO=new ye(s,t)}if(this._intensityFBO)this._intensityFBO.resize(n[0],n[1]);else{const t=new Xe(n[0],n[1]);t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,this._intensityFBO=new ye(s,t)}for(let t=0;t<this._nMips;t++){if(this._mipsFBOs[t])this._mipsFBOs[t].horizontal.resize(n[0],n[1]),this._mipsFBOs[t].vertical.resize(n[0],n[1]);else{const e=new Xe(n[0],n[1]);e.internalFormat=Ce.RGBA,e.wrapMode=Se.CLAMP_TO_EDGE,this._mipsFBOs[t]={horizontal:new ye(s,e),vertical:new ye(s,e)}}n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}const Ts=[1,0],Rs=[0,1];class Is{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(t,e,i){const{context:s}=t,{type:n,radius:r}=i;if(0===r)return;this._createOrResizeResources(t),this._quad||(this._quad=new ee(s,[-1,-1,1,-1,-1,1,1,1]));const o=this._quad;o.bind(),"blur"===n?this._gaussianBlur(t,e,r):this._radialBlur(t,e),o.unbind()}_gaussianBlur(t,e,i){const{context:s,state:n,painter:r,pixelRatio:o}=t,{size:a}=n,{materialManager:l}=r,h=this._programDesc,c=this._quad,u=[Math.round(o*a[0]),Math.round(o*a[1])],f=this._blurFBO,p=l.getProgram(h.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(p),s.setBlendingEnabled(!1),s.bindFramebuffer(f),s.bindTexture(e.colorTexture,4),p.setUniform1i("u_colorTexture",4),p.setUniform2fv("u_texSize",u),p.setUniform2fv("u_direction",Ts),p.setUniform1f("u_sigma",i),c.draw(),s.bindFramebuffer(e),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(f?.colorTexture,5),p.setUniform1i("u_colorTexture",5),p.setUniform2fv("u_direction",Rs),c.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}_radialBlur(t,e){const{context:i,painter:s}=t,{materialManager:n}=s,r=this._programDesc,o=this._quad,a=this._blurFBO;i.bindFramebuffer(a);const l=n.getProgram(r.radialBlur);i.useProgram(l),i.setBlendingEnabled(!1),i.bindTexture(e.colorTexture,4),l.setUniform1i("u_colorTexture",4),o.draw(),i.bindFramebuffer(e),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const h=n.getProgram(r.blit);i.useProgram(h),i.bindTexture(a?.colorTexture,5),h.setUniform1i("u_texture",5),i.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),o.draw()}_createOrResizeResources(t){const{context:e,state:i,pixelRatio:s}=t,{size:n}=i,r=Math.round(s*n[0]),o=Math.round(s*n[1]);if(!this._blurFBO||this._size[0]!==r||this._size[1]!==o)if(this._size[0]=r,this._size[1]=o,this._blurFBO)this._blurFBO.resize(r,o);else{const t=new Xe(r,o);t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,this._blurFBO=new ye(e,t)}}}class As{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=N(this._layerFBOTexture)}draw(t,e,i){const{width:s,height:n}=e;this._createOrResizeResources(t,s,n);const{context:r,painter:o}=t,{materialManager:a}=o,l=this._programDesc,h=this._quad,c=i.colorMatrix;h.bind();const u=this._layerFBOTexture;r.bindFramebuffer(e),e.copyToTexture(0,0,s,n,0,0,u),r.setBlendingEnabled(!1),r.setStencilTestEnabled(!1);const f=a.getProgram(l);r.useProgram(f),r.bindTexture(u,2),f.setUniformMatrix4fv("u_coefficients",c),f.setUniform1i("u_colorTexture",2),h.draw(),r.setBlendingEnabled(!0),r.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),r.setStencilTestEnabled(!0),h.unbind()}_createOrResizeResources(t,e,i){const{context:s}=t;if(!this._layerFBOTexture||this._size[0]!==e||this._size[1]!==i){if(this._size[0]=e,this._size[1]=i,this._layerFBOTexture)this._layerFBOTexture.resize(e,i);else{const t=new Xe;t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,t.width=e,t.height=i,this._layerFBOTexture=new We(s,t)}this._quad||(this._quad=new ee(s,[-1,-1,1,-1,-1,1,1,1]))}}}const Os=[1,0],Fs=[0,1];class Ds{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=N(this._layerFBOTexture),this._horizontalBlurFBO=N(this._horizontalBlurFBO),this._verticalBlurFBO=N(this._verticalBlurFBO)}draw(t,e,i){const{context:s,state:n,painter:r}=t,{materialManager:o}=r,a=this._programDesc,l=e.width,h=e.height,c=[Math.round(l),Math.round(h)],{blurRadius:u,offsetX:f,offsetY:p,color:d}=i,m=[g(f),g(p)];this._createOrResizeResources(t,l,h,c);const _=this._horizontalBlurFBO,v=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const y=this._layerFBOTexture;e.copyToTexture(0,0,l,h,0,0,y),this._quad||(this._quad=new ee(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,c[0],c[1]);const w=this._quad;w.bind(),s.setBlendingEnabled(!1);const b=o.getProgram(a.blur,[{name:"radius",value:Math.ceil(u)}]);s.useProgram(b),s.bindFramebuffer(_),s.bindTexture(e.colorTexture,4),b.setUniform1i("u_colorTexture",4),b.setUniform2fv("u_texSize",c),b.setUniform2fv("u_direction",Os),b.setUniform1f("u_sigma",u),w.draw(),s.bindFramebuffer(v),s.bindTexture(_?.colorTexture,5),b.setUniform1i("u_colorTexture",5),b.setUniform2fv("u_direction",Fs),w.draw(),s.bindFramebuffer(e),s.setViewport(0,0,l,h);const x=o.getProgram(a.composite);s.useProgram(x),s.bindTexture(v?.colorTexture,2),x.setUniform1i("u_blurTexture",2),s.bindTexture(y,3),x.setUniform1i("u_layerFBOTexture",3),x.setUniform4fv("u_shadowColor",[d[3]*(d[0]/255),d[3]*(d[1]/255),d[3]*(d[2]/255),d[3]]),x.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),x.setUniform2fv("u_shadowOffset",m),w.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(xe.ONE,xe.ONE_MINUS_SRC_ALPHA),w.unbind()}_createOrResizeResources(t,e,i,s){const{context:n}=t;if(!this._horizontalBlurFBO||this._size[0]!==e||this._size[1]!==i){if(this._size[0]=e,this._size[1]=i,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(s[0],s[1]);else{const t=new Xe(s[0],s[1]);t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,this._horizontalBlurFBO=new ye(n,t)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(s[0],s[1]);else{const t=new Xe(s[0],s[1]);t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,this._verticalBlurFBO=new ye(n,t)}if(this._layerFBOTexture)this._layerFBOTexture.resize(e,i);else{const t=new Xe;t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,t.width=e,t.height=i,this._layerFBOTexture=new We(n,t)}}}}class js{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=N(this._layerFBOTexture)}draw(t,e,i){const{width:s,height:n}=e;this._createOrResizeResources(t,s,n);const{context:r,painter:o}=t,{amount:a}=i,l=r.gl,h=this._layerFBOTexture;r.bindFramebuffer(e),e.copyToTexture(0,0,s,n,0,0,h),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!1),r.setDepthTestEnabled(!1),r.setClearColor(0,0,0,0),r.clear(l.COLOR_BUFFER_BIT),o.blitTexture(r,h,ze.NEAREST,a)}_createOrResizeResources(t,e,i){const{context:s}=t;if(!this._layerFBOTexture||this._size[0]!==e||this._size[1]!==i)if(this._size[0]=e,this._size[1]=i,this._layerFBOTexture)this._layerFBOTexture.resize(e,i);else{const t=new Xe;t.internalFormat=Ce.RGBA,t.wrapMode=Se.CLAMP_TO_EDGE,t.samplingMode=ze.NEAREST,t.width=e,t.height=i,this._layerFBOTexture=new We(s,t)}}}function Es(t){switch(t){case"bloom":case"blur":case"opacity":case"drop-shadow":return t;default:return"colorize"}}const Ls={colorize:()=>new As,blur:()=>new Is,bloom:()=>new ks,opacity:()=>new js,"drop-shadow":()=>new Ds};class Ns{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach((t=>t.dispose())),this._effectMap.clear()}getPostProcessingEffects(t){if(!t||0===t.length)return[];const e=[];for(const i of t){const t=Es(i.type);let s=this._effectMap.get(t);s||(s=Ls[t](),this._effectMap.set(t,s)),e.push({postProcessingEffect:s,effect:i})}return e}}class Us{constructor(t,e){this.brushes=t,this.name=e.name,this.drawPhase=e.drawPhase||Gt.MAP,this._targetFn=e.target,this.effects=e.effects||[],this.enableDefaultDraw=e.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!e.forceDrawByDisplayOrder}render(t){const{context:e,profiler:i}=t,s=this._targetFn(),n=this.drawPhase&t.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(t,s),i.recordPassEnd();for(const i of this.effects){if(!i.enable())continue;const n=i.apply,r=i.args?.(),o=e.getViewport(),a=e.getBoundFramebufferObject(),l=t.passOptions;this._bindEffect(t,n,r),this._doRender(t,s,n.defines),this._drawAndUnbindEffect(t,n,o,a,l,r)}}}_doRender(t,e,i){if(null==e)return;const{profiler:s,context:n}=t;for(const r of this.brushes){if(s.recordBrushStart(r.name),null!=r.brushEffect){const s=n.getViewport(),o=n.getBoundFramebufferObject(),a=t.passOptions;this._bindEffect(t,r.brushEffect),this._drawWithBrush(r,t,e,i),this._drawAndUnbindEffect(t,r.brushEffect,s,o,a)}else this._drawWithBrush(r,t,e,i);s.recordBrushEnd()}}_drawWithBrush(t,e,i,s){lt(i)?(t.prepareState(e,s),t.drawMany(e,i,s)):i.visible&&(t.prepareState(e,s),t.draw(e,i,s))}_bindEffect(t,e,i){const{profiler:s}=t;s.recordPassStart(this.name+"."+e.name),e.bind(t,i);const n=e.createOptions(t,i);t.passOptions=n}_drawAndUnbindEffect(t,e,i,s,n,r){const{profiler:o,context:a}=t;t.passOptions=n,o.recordBrushStart(e.name),e.draw(t,r),e.unbind(t,r),a.bindFramebuffer(s);const{x:l,y:h,width:c,height:u}=i;a.setViewport(l,h,c,u),o.recordBrushEnd(),o.recordPassEnd()}}class $s{constructor(){this._programCache=new Map}destroy(){for(const t of this._programCache.values())t.destroy();this._programCache.clear()}getProgram(t,e,i,s,n){const r=t.getShaderKey(e,i,s,n);let o=this._programCache.get(r);return o||(o=t.getProgram(e,i,s,n),this._programCache.set(r,o)),o}}class Ws{constructor(t,e){this.context=t,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new Ci,this._worldExtentRenderer=new os,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new Pi,this._blendEffect=new ps,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new ws,hittest:new bs,hittestVTL:new xs,integrate:new ls,insideEffect:new ds("inside"),outsideEffect:new ds("outside")},this._programCache=new $s,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new Si(t),this.textureManager=new Qi(e),this.textureUploadManager=new ns(e),this._effectsManager=new Ns,this._quadMesh=new ee(t,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=N(this._blitRenderer),this._worldExtentRenderer=N(this._worldExtentRenderer),this._quadMesh.dispose(),this._brushCache&&(this._brushCache.forEach((t=>t.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos){let t;for(t in this._fbos)this._fbos[t]&&this._fbos[t].dispose()}for(const t of this._fboPool)t.dispose();if(this._fboPool.length=0,this.effects){let t;for(t in this.effects)this.effects[t]&&this.effects[t].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=N(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new $s}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(t,e){let i;if(this._fboPool.length>0)i=this._fboPool.pop();else{const s=new Xe(t,e);s.samplingMode=ze.NEAREST,s.wrapMode=Se.CLAMP_TO_EDGE,i=new ye(this.context,s,this._stencilBuf)}return i.width===t&&i.height===e||i.resize(t,e),i}releaseFbo(t){this._fboPool.push(t)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(t,e,i){const{context:s}=t;this._worldExtentRenderer.render(t,e,i);const{width:n,height:r}=s.getViewport();if(this.updateFBOs(n,r),this._prevFBO=s.getBoundFramebufferObject(),s.bindFramebuffer(this.getFbos().output),s.setColorMask(!0,!0,!0,!0),null!=e){const{r:t,g:i,b:n,a:r}=e;s.setClearColor(r*t/255,r*i/255,r*n/255,r)}else s.setClearColor(0,0,0,0);s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}afterRenderPhases(t){const{context:e}=t;e.bindFramebuffer(this._prevFBO),e.setStencilFunction(ke.EQUAL,1,255),e.setStencilTestEnabled(!0),e.setDepthTestEnabled(!1),this.blitTexture(e,this.getFbos().output.colorTexture,ze.NEAREST)}beforeRenderLayer(t,e,i){const{context:s,blendMode:n,effects:r,drawPhase:o,requireFBO:a}=t;if(a||Xs(o,n,r,i)){const t=s.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(t);const{width:e,height:i}=s.getViewport(),n=this.acquireFbo(e,i);s.bindFramebuffer(n),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(e),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(t,e){const{context:i,blendMode:s,effects:n,requireFBO:r,drawPhase:o}=t;if(r||Xs(o,s,n,e)){const r=i.getBoundFramebufferObject();null!=n&&n.length>0&&o===Gt.MAP&&(i.setColorMask(!0,!0,!0,!0),this._applyEffects(t,n,r)),i.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(xe.ONE,xe.ONE_MINUS_SRC_ALPHA,xe.ONE,xe.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);const a=null==s||o===Gt.HIGHLIGHT?"normal":s;this._blendEffect.draw(t,r.colorTexture,ze.NEAREST,a,e),this.releaseFbo(r)}}renderObject(t,e,i,s){const n=se[i];if(!n)return;let r=this._brushCache.get(n);void 0===r&&(r=new n,this._brushCache.set(n,r)),r.prepareState(t),r.draw(t,e,s)}renderObjects(t,e,i,s){const n=se[i];if(!n)return;let r=this._brushCache.get(n);void 0===r&&(r=new n,this._brushCache.set(n,r)),r.drawMany(t,e,s)}registerRenderPass(t){const e=t.brushes.map((t=>(this._brushCache.has(t)||this._brushCache.set(t,new t),this._brushCache.get(t))));return new Us(e,t)}blitTexture(t,e,i,s=1){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(xe.ONE,xe.ONE_MINUS_SRC_ALPHA,xe.ONE,xe.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(t,e,i,s),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(t){return this._effectsManager.getPostProcessingEffects(t)}updateFBOs(t,e){if(t!==this._lastWidth||e!==this._lastHeight){if(this._lastWidth=t,this._lastHeight=e,this._fbos){let i;for(i in this._fbos)this._fbos[i].resize(t,e);return}const i=new Xe(t,e);i.samplingMode=ze.NEAREST,i.wrapMode=Se.CLAMP_TO_EDGE;const s=new we(Ie.DEPTH_STENCIL,t,e);this._stencilBuf=new be(this.context,s),this._fbos={output:new ye(this.context,i,this._stencilBuf),effect0:new ye(this.context,i,this._stencilBuf)}}}_applyEffects(t,e,i){const{context:s}=t,n=this._effectsManager.getPostProcessingEffects(e);for(const{postProcessingEffect:e,effect:r}of n)s.bindFramebuffer(i),e.draw(t,i,r);this._currentPipelineStateNeedsUpdate=!0}setShader(t){this._shaderState.shader=t.shader,this._shaderState.uniforms=t.uniforms,this._shaderState.defines=t.defines,this._shaderState.optionalAttributes=t.optionalAttributes,this._shaderState.useComputeBuffer=t.useComputeBuffer??!1}setPipelineState(t){t!==this._currentPipelineState&&(this._currentPipelineState=t,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(t,e){const{instance:i}=e,s=i.instanceId,{shader:n,uniforms:r,defines:o,optionalAttributes:a,useComputeBuffer:l}=this._shaderState,h=e.target.getMesh(s),c={useComputeBuffer:l,locationInfo:n.locationInfo,computeAttributeMap:n.computeAttributes},u=h.getLayout(c);if(null==u)return null;const{primitive:f,count:p,offset:d}=h.getDrawArgs(Me.TRIANGLES,e.count,e.start*Uint32Array.BYTES_PER_ELEMENT,l),m=this._programCache.getProgram(n,u,r,o??{},a??{});m.setUniforms(r),m.bind(t),this.updatePipelineState(t),this._updateStencilRef(t,e.target);const _=h.getVAO(t,n.locationInfo,c);return t.bindVAO(_),t.drawElements(f,p,Re.UNSIGNED_INT,d),t.bindVAO(null),m.cleanupTemporaryTextures(),{vertexShader:m.vertexShader,fragmentShader:m.fragmentShader}}submitDrawQuad(t){const{shader:e,uniforms:i,defines:s,optionalAttributes:n}=this._shaderState,r=this._programCache.getProgram(e,this._quadMesh.layout,i,s??{},n??{});r.setUniforms(i),r.bind(t),this.updatePipelineState(t),this._updateStencilRef(t,null),this._quadMesh.draw(),t.bindVAO(null),r.cleanupTemporaryTextures()}submitDrawMesh(t,e,i){const{shader:s,uniforms:n,defines:r,optionalAttributes:o}=this._shaderState,a=this._programCache.getProgram(s,e.layout,n,r??{},o??{});if(a.setUniforms(n),a.bind(t),this.updatePipelineState(t),this._updateStencilRef(t,null),i)for(const s of i)e.bind(t,s),e.draw(t);else for(let i=0;i<e.parts.length;i++)e.bind(t,i),e.draw(t);e.unbind(t),a.cleanupTemporaryTextures()}updatePipelineState(t){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(t))}_updatePipelineState(t){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:e,depth:i,stencil:s}=this._currentPipelineState;if(e){const{blendMode:i,write:s}=e;switch(t.setColorMask(...s),t.setBlendingEnabled(!0),t.setBlendEquation(Oe.ADD),i){case"composite":t.setBlendFunctionSeparate(xe.ONE,xe.ONE_MINUS_SRC_ALPHA,xe.ONE,xe.ONE_MINUS_SRC_ALPHA);break;case"additive":t.setBlendFunctionSeparate(xe.ONE,xe.ONE,xe.ONE,xe.ONE);break;case"custom":{const{blendParameters:i}=e,{dstAlpha:s,dstRGB:n,srcAlpha:r,srcRGB:o}=i;t.setBlendFunctionSeparate(o,n,r,s);break}case"delete":t.setBlendEquation(Oe.REVERSE_SUBTRACT),t.setBlendFunctionSeparate(xe.ONE,xe.ONE_MINUS_SRC_ALPHA,xe.ONE,xe.ONE_MINUS_SRC_ALPHA)}}if(i){const{test:e,write:s}=i;s?(t.setDepthWriteEnabled(!0),t.setDepthRange(s.zNear,s.zFar)):t.setDepthWriteEnabled(!1),e?(t.setDepthTestEnabled(!0),t.setDepthFunction(e)):t.setDepthTestEnabled(!1)}else t.setDepthTestEnabled(!1),t.setDepthWriteEnabled(!1);if(s){const{test:e,write:i}=s;if(e){const{compare:i,mask:s,op:n,ref:r}=e;t.setStencilTestEnabled(!0),"function"!=typeof r&&t.setStencilFunctionSeparate(Fe.FRONT_AND_BACK,i,r,s),t.setStencilOpSeparate(Fe.FRONT_AND_BACK,n.fail,n.zFail,n.zPass)}else t.setStencilTestEnabled(!1);if(i){const{mask:e}=i;t.setStencilWriteMask(e)}else t.setStencilWriteMask(0)}else t.setStencilTestEnabled(!1),t.setStencilWriteMask(0)}_updateStencilRef(t,e){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:i}=this._currentPipelineState;if(i){const{test:s}=i;if(s){const{compare:i,mask:n,ref:r}=s;"function"==typeof r&&t.setStencilFunctionSeparate(Fe.FRONT_AND_BACK,i,r(e),n)}}}}function Xs(t,e,i,s){return t!==Gt.LABEL_ALPHA&&t!==Gt.LABEL&&t!==Gt.HIGHLIGHT&&(1!==s||null!=e&&"normal"!==e||null!=i&&i.length>0)}class Bs{constructor(){this._candidateTiles=[]}schedule(t){this._candidateTiles.includes(t)||this._candidateTiles.push(t)}reshuffle(t){const e=[];for(const i of this._candidateTiles)t>0?(i.reshuffle(),t--):e.push(i);this._candidateTiles=e}}const Vs=2e3;class Hs extends Qt{constructor(t,e){super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=ht(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new Bs,this._canvas=new li(t),this.context=new Ee(this._canvas.gl,e.contextOptions??{}),this.painter=new Ws(this.context,this),this._cimAnalyzer=new si(this.painter.textureManager.resourceManager),A("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),t.appendChild(this._debugOutput));const i=()=>this._highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:e.timeline||new ct,renderingOptions:e.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new me(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return i()},reshuffleManager:this._reshuffleManager,backgroundColor:e.backgroundColor},this._taskHandle=ut({render:t=>this.renderFrame(t)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",(t=>this.emit("webgl-error",{error:new H("webgl-context-lost",t.statusMessage)}))),this._bufferPool=new ne,Qe()}destroy(){Ke(this.context),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=ft(this._taskHandle),this._lostWebGLContextHandle=ft(this._lostWebGLContextHandle),this._canvas.destroy(),this._debugOutput?.parentNode?.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(t){this._renderParameters.backgroundColor=t,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(t){this._renderingOptions=t,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(t){this._state=t,this.requestRender()}get stationary(){return this._stationary}set stationary(t){this._stationary!==t&&(this._stationary=t,this.requestRender())}trashDisplayObject(t){this._trash.add(t),this.requestRender()}untrashDisplayObject(t){return this._trash.delete(t)}requestRender(){this._renderRemainingTime=Vs,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(t){const e=this._lastFrameRenderTime?t.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=e,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=t.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=t.time,this._renderParameters.deltaTime=t.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:tt()}}renderChildren(t){for(const e of this.children)e.beforeRender(t);this._reshuffleManager.reshuffle(Vt),this._canvas.render(t,(()=>this._renderChildren(this.children,t)));for(const e of this.children)e.afterRender(t)}_renderChildren(t,e){const i=this.context;this.painter.textureUploadManager.upload(),i.resetInfo(),e.profiler.recordStart("drawLayers"),e.dataUploadCounter=0,this.painter.beforeRenderPhases(e,e.backgroundColor,this.state.padding),e.drawPhase=Gt.MAP;for(const i of t)i.processRender(e);if(this.children.some((t=>t.hasHighlight))){e.drawPhase=Gt.HIGHLIGHT;for(const i of t)i.processRender(e)}if(this.children.some((t=>t.hasLabels))){e.drawPhase=Gt.LABEL;for(const i of t)i.processRender(e)}if(A("esri-tiles-debug")){e.drawPhase=Gt.DEBUG;for(const i of t)i.processRender(e)}this.painter.afterRenderPhases(e),e.profiler.recordEnd("drawLayers"),i.logInfo()}doRender(t){const e=this.context,{state:i,pixelRatio:s}=t;this._canvas.resize(t),e.setViewport(0,0,s*i.size[0],s*i.size[1]),e.setDepthWriteEnabled(!0),e.setStencilWriteMask(255),this.renderChildren(t)}async takeScreenshot(t,e,i,s){const n=Math.round(this.state.size[0]*t.resolutionScale),r=Math.round(this.state.size[1]*t.resolutionScale),o=t.resolutionScale,a=this.context,l=this._state.clone();if(null!=s){const t=l.viewpoint;l.viewpoint.rotation=s,l.viewpoint=t}const h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:l,pixelRatio:o,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:i},c=new Xe(n,r);c.wrapMode=Se.CLAMP_TO_EDGE,c.internalFormat=De.RGBA8,c.isImmutable=!0;const u=new ye(a,c,new we(Ie.DEPTH_STENCIL,n,r)),f=a.getBoundFramebufferObject(),p=a.getViewport();a.bindFramebuffer(u),a.setViewport(0,0,n,r),this._renderChildren(e??this.children,h);const d=this._readbackScreenshot(u,{...t.cropArea,y:r-(t.cropArea.y+t.cropArea.height)});a.bindFramebuffer(f),a.setViewport(p.x,p.y,p.width,p.height),this.requestRender();const m=await d;let _;return 1===t.outputScale?_=m:(_=new ImageData(Math.round(m.width*t.outputScale),Math.round(m.height*t.outputScale)),pt(m,_,!0)),u.dispose(),_}async _readbackScreenshot(t,e){const i=Ze(e.width,e.height,document.createElement("canvas"));return await t.readPixelsAsync(e.x,e.y,e.width,e.height,Ce.RGBA,Ae.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i}_emptyTrash(){for(;this._trash.size>0;){const t=Array.from(this._trash);this._trash.clear();for(const e of t)e.processDetach()}}}async function Gs(t){const e=import("./p-c5a0a325.js"),i=import("./p-450ca12d.js"),s=ti((await e).default,{signal:t}),n=ti((await i).default,{signal:t}),r={mask:await s,overlay:await n};return Y(t),r}class Ys extends Kt{constructor(){super(),this._handles=new dt,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles=mt(this._handles),this._disposeRenderResources(),this._resourcesTask=_t(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){this._backgroundColor=t,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(t){this._magnifier=t,this._handles.removeAll(),this._handles.add([vt((()=>t.version),(()=>{this.visible=t.visible&&null!=t.position&&t.size>0,this.requestRender()}),gt),vt((()=>[t.maskUrl,t.overlayUrl]),(()=>this._reloadResources())),vt((()=>t.size),(()=>{this._disposeRenderResources(),this.requestRender()}))])}_createTransforms(){return{displayViewScreenMat3:tt()}}doRender(t){const e=t.context;if(!this._resourcesTask)return void this._reloadResources();if(t.drawPhase!==Gt.MAP||!this._canRender())return;this._updateResources(t);const i=this._magnifier;if(null==i.position)return;const s=t.pixelRatio,n=i.size*s,r=1/i.factor,o=Math.ceil(r*n);this._readbackTexture.resize(o,o);const{size:a}=t.state,l=s*a[0],h=s*a[1],c=.5*o,u=.5*o,f=bt(s*i.position.x,c,l-c-1),p=bt(h-s*i.position.y,u,h-u-1);e.setBlendingEnabled(!0);const d=f-c,m=p-u,_=this._readbackTexture;e.bindTexture(_,0),e.gl.copyTexImage2D(_.descriptor.target,0,_.descriptor.pixelFormat,d,m,o,o,0);const v=this.backgroundColor,g=v?[v.a*v.r/255,v.a*v.g/255,v.a*v.b/255,v.a]:[1,1,1,1],y=(f+i.offset.x*s)/l*2-1,w=(p-i.offset.y*s)/h*2-1,b=n/l*2,x=n/h*2,M=this._program;e.bindVAO(this._vertexArrayObject),e.bindTexture(this._overlayTexture,6),e.bindTexture(this._maskTexture,7),e.useProgram(M),M.setUniform4fv("u_background",g),M.setUniform1i("u_readbackTexture",0),M.setUniform1i("u_overlayTexture",6),M.setUniform1i("u_maskTexture",7),M.setUniform4f("u_drawPos",y,w,b,x),M.setUniform1i("u_maskEnabled",i.maskEnabled?1:0),M.setUniform1i("u_overlayEnabled",i.overlayEnabled?1:0),e.setStencilTestEnabled(!1),e.setColorMask(!0,!0,!0,!0),e.drawArrays(Me.TRIANGLE_STRIP,0,4),e.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const t=null!=this._magnifier?this._magnifier.maskUrl:null,e=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=yt((async i=>{const s=null==t||null==e?Gs(i):null,n=null!=t?X(t,{responseType:"image",signal:i}).then((t=>t.data)):s.then((t=>t.mask)),r=null!=e?X(e,{responseType:"image",signal:i}).then((t=>t.data)):s.then((t=>t.overlay)),[o,a]=await Promise.all([n,r]);this.mask=o,this.overlay=a,this._disposeRenderResources(),this.requestRender()}))}_disposeRenderResources(){this._readbackTexture=N(this._readbackTexture),this._overlayTexture=N(this._overlayTexture),this._maskTexture=N(this._maskTexture),this._vertexArrayObject=N(this._vertexArrayObject),this._program=N(this._program)}_updateResources(t){if(t.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const e=t.context;this._resourcePixelRatio=t.pixelRatio;const i=Math.ceil(this._magnifier.size*t.pixelRatio);this._program=_e(e);const s=new Uint16Array([0,1,0,0,1,1,1,0]),n=ve.attributes;this._vertexArrayObject=new he(e,n,re,{geometry:ge.createVertex(e,Pe.STATIC_DRAW,s)}),this.overlay.width=i,this.overlay.height=i;const r=new Xe;r.internalFormat=Ce.RGBA,r.wrapMode=Se.CLAMP_TO_EDGE,r.samplingMode=ze.NEAREST,r.flipped=!0,r.preMultiplyAlpha=!wt(this.overlay.src)||!t.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new We(e,r,this.overlay),this.mask.width=i,this.mask.height=i,r.pixelFormat=r.internalFormat=Ce.ALPHA,this._maskTexture=new We(e,r,this.mask);const o=1/this._magnifier.factor;r.pixelFormat=r.internalFormat=Ce.RGBA,r.width=r.height=Math.ceil(o*i),r.samplingMode=ze.LINEAR,r.flipped=!1,this._readbackTexture=new We(e,r)}}export{Ys as MagnifierView2D,Hs as Stage};
//# sourceMappingURL=p-e144509a.js.map