import{E as t,a8 as e,X as s,a9 as i,aa as r,r as n,p as a,ab as o,q as u,ac as h,ad as c,x as l,ae as p,af as f,s as y,j as d}from"./p-aad64c9f.js";import{a as m,d as x}from"./p-d5a66c42.js";import{s as b,a as w}from"./p-07c8b3b5.js";import{x as F,f as j}from"./p-1062e8df.js";import{a as g}from"./p-c783c054.js";import{p as P,r as G}from"./p-875cbb57.js";async function Q(i,r,n){const a=e(i),o=await F(a,s.from(r),{...n}),u=o.data.extent;return!u||isNaN(u.xmin)||isNaN(u.ymin)||isNaN(u.xmax)||isNaN(u.ymax)?{count:o.data.count,extent:null}:{count:o.data.count,extent:t.fromJSON(u)}}function R(t,e){return e}function _(t,e,s,i){switch(s){case 0:return N(t,e+i,0);case 1:return"lowerLeft"===t.originPosition?N(t,e+i,1):q(t,e+i,1)}}function C(t,e,s,i){return 2===s?N(t,e,2):_(t,e,s,i)}function S(t,e,s,i){return 2===s?0===e?0:N(t,e,3):_(t,e,s,i)}function T(t,e,s,i){return 3===s?0===e?0:N(t,e,3):C(t,e,s,i)}function N({translate:t,scale:e},s,i){return t[i]+s*e[i]}function q({translate:t,scale:e},s,i){return t[i]-s*e[i]}class v{constructor(t){this._options=t,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this._previousCoordinate=[0,0],this._transform=null,this._applyTransform=R,this._lengths=[],this._currentLengthIndex=0,this._toAddInCurrentPath=0,this._vertexDimension=0,this._mValueOffset=null,this._coordinateBuffer=null,this._coordinateBufferPtr=0,this._attributesConstructor=class{}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(t){if(this._options.applyTransform&&(t.transform=null),this._attributesConstructor=class{},this._coordinateBuffer=null,this._lengths.length=0,!t.hasZ)return;const e=i(t.geometryType,this._options.sourceSpatialReference,t.spatialReference);if(null!=e)for(const s of t.features)e(s.geometry)}createSpatialReference(){return{}}addField(t,e){const s=t.fields;r(s),s.push(e);const i=s.map((t=>t.name));this._attributesConstructor=function(){for(const t of i)this[t]=null}}addFeature(t,e){t.features.push(e)}prepareFeatures(t){switch(this._transform=t.transform,this._options.applyTransform&&t.transform&&(this._applyTransform=this._deriveApplyTransform(t)),this._mValueOffset=null,this._vertexDimension=2,t.hasZ&&this._vertexDimension++,t.hasM&&(this._mValueOffset=this._vertexDimension,this._vertexDimension++),t.geometryType){case"esriGeometryPoint":this.addCoordinate=(t,e,s)=>this.addCoordinatePoint(t,e,s),this.createGeometry=t=>this.createPointGeometry(t);break;case"esriGeometryPolygon":this.addCoordinate=(t,e,s)=>this._addCoordinatePolygon(t,e,s),this.createGeometry=t=>this._createPolygonGeometry(t);break;case"esriGeometryPolyline":this.addCoordinate=(t,e,s)=>this._addCoordinatePolyline(t,e,s),this.createGeometry=t=>this._createPolylineGeometry(t);break;case"esriGeometryMultipoint":this.addCoordinate=(t,e,s)=>this._addCoordinateMultipoint(t,e,s),this.createGeometry=t=>this._createMultipointGeometry(t)}}createFeature(){return this._lengths.length=0,this._currentLengthIndex=0,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0,this._coordinateBuffer=null,this._coordinateBufferPtr=0,{attributes:new this._attributesConstructor}}allocateCoordinates(){}addLength(t,e,s){0===this._lengths.length&&(this._toAddInCurrentPath=e),this._lengths.push(e)}addQueryGeometry(t,e){const{queryGeometry:s,queryGeometryType:i}=e,r=P(s.clone(),s,!1,!1,this._transform),n=G(r,i,!1,!1);t.queryGeometryType=i,t.queryGeometry={...n}}createPointGeometry(t){const e={x:0,y:0,spatialReference:t.spatialReference};return t.hasZ&&(e.z=0),t.hasM&&(e.m=0),e}addCoordinatePoint(t,e,s){const i=this._transform;switch(e=this._applyTransform(i,e,s,0),s){case 0:t.x=e;break;case 1:t.y=e;break;case 2:"z"in t?t.z=e:t.m=e;break;case 3:t.m=e}}_transformPathLikeValue(t,e){let s=0;e<=1&&(s=this._previousCoordinate[e],this._previousCoordinate[e]+=t);const i=this._transform;return null!==this._mValueOffset&&0===t&&e>0&&!(e%this._mValueOffset)?0:this._applyTransform(i,t,e,s)}_addCoordinatePolyline(t,e,s){this._dehydratedAddPointsCoordinate(t.paths,e,s)}_addCoordinatePolygon(t,e,s){this._dehydratedAddPointsCoordinate(t.rings,e,s)}_addCoordinateMultipoint(t,e,s){0===s&&t.points.push([]);const i=this._transformPathLikeValue(e,s);t.points[t.points.length-1].push(i)}_createPolygonGeometry(t){return{rings:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_createPolylineGeometry(t){return{paths:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_createMultipointGeometry(t){return{points:[],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_dehydratedAddPointsCoordinate(t,e,s){0===s&&0==this._toAddInCurrentPath--&&(t.push([]),this._toAddInCurrentPath=this._lengths[++this._currentLengthIndex]-1,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0);const i=this._transformPathLikeValue(e,s),r=t[t.length-1];0===s&&(this._coordinateBufferPtr=0,this._coordinateBuffer=new Array(this._vertexDimension),r.push(this._coordinateBuffer)),this._coordinateBuffer[this._coordinateBufferPtr++]=i}_deriveApplyTransform(t){const{hasZ:e,hasM:s}=t;return e&&s?T:e?C:s?S:_}}async function k(t,i,r){const n=e(t),a={...r},o=s.from(i),u=!o.quantizationParameters,{data:h}=await j(n,o,new v({sourceSpatialReference:o.sourceSpatialReference,applyTransform:u}),a);return h}let D=class extends h{constructor(t){super(t),this.dynamicDataSource=null,this.fieldsIndex=null,this.gdbVersion=null,this.infoFor3D=null,this.pbfSupported=!1,this.queryAttachmentsSupported=!1,this.sourceSpatialReference=null,this.url=null}get parsedUrl(){return c(this.url)}async execute(t,e){const s=await this.executeJSON(t,e);return this.featureSetFromJSON(t,s,e)}async executeJSON(t,e){const s=this._normalizeQuery(t),i=null!=t.outStatistics?.[0],r=l("featurelayer-pbf-statistics"),n=!i||r;let a;if(this.pbfSupported&&n)try{a=await k(this.url,s,e)}catch(t){if("query:parsing-pbf"!==t.name)throw t;this.pbfSupported=!1}return this.pbfSupported&&n||(a=await g(this.url,s,e)),this._normalizeFields(a.fields),a}async featureSetFromJSON(t,e,s){if(!this._queryIs3DObjectFormat(t)||null==this.infoFor3D||!e.features)return p.fromJSON(e);const{meshFeatureSetFromJSON:i}=await f(import("./p-b51b36cc.js"),s);return i(t,this.infoFor3D,e)}executeForCount(t,e){return b(this.url,this._normalizeQuery(t),e)}executeForExtent(t,e){return Q(this.url,this._normalizeQuery(t),e)}executeForIds(t,e){return w(this.url,this._normalizeQuery(t),e)}async executeRelationshipQuery(t,e){const[{default:s},{executeRelationshipQuery:i}]=await f(Promise.all([import("./p-aad64c9f.js").then((function(t){return t.s_})),import("./p-c04b22cd.js")]),e);return t=s.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),i(this.url,t,e)}async executeRelationshipQueryForCount(t,e){const[{default:s},{executeRelationshipQueryForCount:i}]=await f(Promise.all([import("./p-aad64c9f.js").then((function(t){return t.s_})),import("./p-c04b22cd.js")]),e);return t=s.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),i(this.url,t,e)}async executeAttachmentQuery(t,s){const{executeAttachmentQuery:i,fetchAttachments:r,processAttachmentQueryResult:n}=await f(import("./p-e0fa5109.js"),s),a=e(this.url);return n(a,await(this.queryAttachmentsSupported?i(a,t,s):r(a,t,s)))}async executeBinsQuery(t,e){const{executeBinsQuery:s}=await f(import("./p-5e39bd87.js"),e);return s(this.parsedUrl,t,e)}async executeTopFeaturesQuery(t,e){const{executeTopFeaturesQuery:s}=await f(import("./p-87332428.js"),e);return s(this.parsedUrl,t,this.sourceSpatialReference,e)}async executeForTopIds(t,e){const{executeForTopIds:s}=await f(import("./p-1ac4b3ea.js"),e);return s(this.parsedUrl,t,e)}async executeForTopExtents(t,e){const{executeForTopExtents:s}=await f(import("./p-39353ac7.js"),e);return s(this.parsedUrl,t,e)}async executeForTopCount(t,e){const{executeForTopCount:s}=await f(import("./p-bfeb8e58.js"),e);return s(this.parsedUrl,t,e)}_normalizeQuery(t){let e=s.from(t);e.sourceSpatialReference=e.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(e=e===t?e.clone():e,e.gdbVersion=t.gdbVersion||this.gdbVersion,e.dynamicDataSource=t.dynamicDataSource?o.from(t.dynamicDataSource):this.dynamicDataSource);const{infoFor3D:i}=this;if(null!=i&&this._queryIs3DObjectFormat(t)){e=e===t?e.clone():e,e.formatOf3DObjects=null;const s=m(i),r=x(i);for(const t of i.queryFormats){if(t===s){e.formatOf3DObjects=t;break}t!==r||e.formatOf3DObjects||(e.formatOf3DObjects=t)}if(!e.formatOf3DObjects)throw new y("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(e.outSpatialReference&&!d(e.outSpatialReference,this.sourceSpatialReference))throw new y("query:unsupported-out-spatial-reference","3D object feature services do not support projection of geometries");if(null==e.outFields||!e.outFields.includes("*")){e=e===t?e.clone():e,null==e.outFields&&(e.outFields=[]);const{originX:s,originY:r,originZ:n,translationX:a,translationY:o,translationZ:u,scaleX:h,scaleY:c,scaleZ:l,rotationX:p,rotationY:f,rotationZ:y,rotationDeg:d}=i.transformFieldRoles;e.outFields.push(s,r,n,a,o,u,h,c,l,p,f,y,d)}}return e}_normalizeFields(t){if(null!=this.fieldsIndex&&null!=t)for(const e of t){const t=this.fieldsIndex.get(e.name);t&&Object.assign(e,t.toJSON())}}_queryIs3DObjectFormat(t){return null!=this.infoFor3D&&!0===t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}};n([a({type:o})],D.prototype,"dynamicDataSource",void 0),n([a()],D.prototype,"fieldsIndex",void 0),n([a()],D.prototype,"gdbVersion",void 0),n([a()],D.prototype,"infoFor3D",void 0),n([a({readOnly:!0})],D.prototype,"parsedUrl",null),n([a()],D.prototype,"pbfSupported",void 0),n([a()],D.prototype,"queryAttachmentsSupported",void 0),n([a()],D.prototype,"sourceSpatialReference",void 0),n([a({type:String})],D.prototype,"url",void 0),D=n([u("esri.layers.graphics.sources.support.QueryTask")],D);const A=D;export{A as j};
//# sourceMappingURL=p-dad6a156.js.map