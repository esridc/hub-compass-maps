import{r as s,eg as t,dr as e,du as i,dN as o,c9 as n,d3 as r,dq as a,dC as d,eK as h,gK as c,eZ as u,dz as p,fe as f,dx as l,dy as v,dB as x,eL as m,k0 as w}from"./p-aad64c9f.js";import{r as g}from"./p-717596a8.js";import{f as M}from"./p-682c165c.js";import{a as y,b as j,p as z}from"./p-591e796f.js";import{h as A,C as S,g as b,A as B,j as R,S as W,m as _,I as k,v as C,P as K,a as P,p as q,G as D,H as E,l as F,w as L,e as N}from"./p-2d2f231a.js";class O extends k{}s([A(0,S)],O.prototype,"pos",void 0),s([A(1,S)],O.prototype,"uv",void 0);class Z extends C{}class G extends K{}s([b(B)],G.prototype,"dvs",void 0);class H extends K{}s([b(S)],H.prototype,"perspective",void 0),s([b(S)],H.prototype,"texSize",void 0),s([b(R)],H.prototype,"wrapAroundShift",void 0),s([b(R)],H.prototype,"opacity",void 0),s([b(W)],H.prototype,"texture",void 0);class I extends P{vertex(s){const t=s.uv.divide(this.config.texSize),e=new R(1).add(q(t,this.config.perspective)),i=new D(s.pos.add(new S(this.config.wrapAroundShift,0)),1),o=this.transform.dvs.multiply(i);return{uv:t,glPosition:new E(o.xy.multiply(e),0,e)}}fragment(s){const t=F(this.config.texture,s.uv).multiply(this.config.opacity),e=new L;return e.glFragColor=t,e}}s([b(G)],I.prototype,"transform",void 0),s([b(H)],I.prototype,"config",void 0),s([t(0,_(O))],I.prototype,"vertex",null),s([t(0,_(Z))],I.prototype,"fragment",null);class J extends y{constructor(){super(...arguments),this.type=N.Overlay,this._mesh=null,this.shaders={overlay:new I}}render(s,t){const{context:o,painter:n}=s,r=this._getMesh(s,t);n.setPipelineState(j);const{isWrapAround:a,wrapAroundShift:d}=t.config,h={...t.config,wrapAroundShift:0},c={shader:this.shaders.overlay,uniforms:{transform:t.transform,config:h},defines:null,optionalAttributes:null,useComputeBuffer:!1};n.setPipelineState({...j,stencil:{write:!1,test:{compare:e.EQUAL,op:{fail:i.KEEP,zFail:i.KEEP,zPass:i.REPLACE},ref:0,mask:255}}}),n.submitDrawMeshUntyped(o,c,r),a&&(h.wrapAroundShift=d,n.submitDrawMeshUntyped(o,c,r))}shutdown(){o(this._mesh)}_getMesh(s,t){const{context:e}=s;if(this._mesh){const s=this._mesh.vertexBuffers.get("positions");if(!s)throw new Error("Buffer not found");s.setData(t.position)}else{const s=null!=t.index?t.index.length:t.position.length/2;this._mesh=new z(e,{vertex:{positions:t.position,uvs:t.tex},index:null!=t.index?{index:t.index}:void 0,groups:[{attributes:[{name:"pos",count:2,type:n.FLOAT,location:0,vertex:"positions",stride:8,offset:0},{name:"tex",count:2,type:n.UNSIGNED_SHORT,location:1,vertex:"uvs",stride:4,offset:0}],index:null!=t.index?"index":void 0,primitive:r.TRIANGLE_STRIP}],parts:[{group:0,start:0,count:s}]})}return this._mesh}}class Q extends M{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=a(),this._overlayTechnique=new J}get dvsMat3(){return this._dvsMat3}beforeRender(s){this._updateMatrices(s),this._updateOverlays(s,this.children);for(const t of this.children)t.beforeRender(s)}doRender(s){if(s.drawPhase!==d.MAP||!this.visible)return;super.doRender(s);const t=this._overlayTechnique;for(const e of this.children)e.draw(s,t)}onDetach(){this._overlayTechnique.shutdown()}_updateMatrices(s){const{state:t}=s,{id:e,size:i,pixelRatio:o,resolution:n,rotation:r,viewpoint:a,displayMat3:d}=t;if(this._viewStateId===e)return;const m=x(r),w=o*i[0],M=o*i[1];this._localOrigin=a.targetGeometry.clone();const{x:y,y:j}=this._localOrigin,z=h(y,t.spatialReference);this._localOrigin.x=z,this._localOrigin.y=j;const A=n*w,S=n*M,b=c(this._dvsMat3);u(b,b,d),p(b,b,f(w/2,M/2)),l(b,b,g(w/A,-M/S,1)),v(b,b,-m),this._viewStateId=e}_updateOverlays(s,t){const{state:e}=s,{rotation:i,spatialReference:o,worldScreenWidth:n,size:r,viewpoint:a}=e,d=this._localOrigin;let h,c=0;const u=m(o);if(u&&o.isWrappable){const s=r[0],t=r[1],d=x(i),p=Math.abs(Math.cos(d)),f=Math.abs(Math.sin(d)),l=Math.round(s*p+t*f),[v,m]=u.valid,g=w(o),{x:M,y}=a.targetGeometry,j=[M,y],z=[0,0];e.toScreen(z,j);const A=[0,0];let S;S=l>n?.5*n:.5*l;const b=Math.floor((M+.5*g)/g),B=v+b*g,R=m+b*g,W=[z[0]+S,0];e.toMap(A,W),A[0]>R&&(c=g),W[0]=z[0]-S,e.toMap(A,W),A[0]<B&&(c=-g),h={worldWidth:g,xBounds:[v,m]}}for(const s of t)s.updateDrawCoords(d,c,o,h)}}export{Q as u};
//# sourceMappingURL=p-36525d97.js.map